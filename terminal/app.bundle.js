(function(){function r(e,n,t){function o(i,f){if(!n[i]){if(!e[i]){var c="function"==typeof require&&require;if(!f&&c)return c(i,!0);if(u)return u(i,!0);var a=new Error("Cannot find module '"+i+"'");throw a.code="MODULE_NOT_FOUND",a}var p=n[i]={exports:{}};e[i][0].call(p.exports,function(r){var n=e[i][1][r];return o(n||r)},p,p.exports,r,e,n,t)}return n[i].exports}for(var u="function"==typeof require&&require,i=0;i<t.length;i++)o(t[i]);return o}return r})()({1:[function(require,module,exports){
"use strict"
window.glov_build_version="1673321608019"
var called_once=false
window.onload=function(){if(called_once)return
called_once=true
require("../glov/client/bootstrap.js")
require("./terminal_test.js").main()}

},{"../glov/client/bootstrap.js":4,"./terminal_test.js":3}],2:[function(require,module,exports){
module.exports={"font_size":16,"imageW":512,"imageH":256,"spread":4,"noFilter":1,"channels":1,"char_infos":[{"c":1,"x0":106,"y0":49,"yoffs":2,"xpad":1,"w":8,"h":10},{"c":2,"x0":123,"y0":49,"yoffs":2,"xpad":1,"w":8,"h":10},{"c":3,"x0":319,"y0":106,"yoffs":4,"xpad":2,"w":7,"h":8},{"c":4,"x0":119,"y0":126,"yoffs":4,"xpad":2,"w":7,"h":7},{"c":5,"x0":479,"y0":84,"yoffs":3,"xpad":1,"w":8,"h":9},{"c":6,"x0":496,"y0":84,"yoffs":3,"xpad":1,"w":8,"h":9},{"c":7,"x0":312,"y0":140,"yoffs":6,"xpad":3,"w":6,"h":4},{"c":8,"x0":4,"y0":4,"xpad":1,"w":8,"h":16},{"c":9,"x0":20,"y0":143,"yoffs":5,"xpad":2,"w":7,"h":6},{"c":10,"x0":21,"y0":4,"xpad":1,"w":8,"h":16},{"c":11,"x0":140,"y0":49,"yoffs":2,"xpad":2,"w":7,"h":10},{"c":12,"x0":156,"y0":49,"yoffs":2,"xpad":3,"w":6,"h":10},{"c":13,"x0":171,"y0":49,"yoffs":2,"xpad":1,"w":8,"h":10},{"c":14,"x0":188,"y0":49,"yoffs":2,"xpad":1,"w":8,"h":10},{"c":15,"x0":4,"y0":108,"yoffs":3,"xpad":1,"w":8,"h":9},{"c":16,"x0":100,"y0":29,"yoffs":1,"xpad":2,"w":7,"h":11},{"c":17,"x0":116,"y0":29,"yoffs":1,"xpad":2,"w":7,"h":11},{"c":18,"x0":21,"y0":108,"yoffs":2,"xpad":2,"w":7,"h":9},{"c":19,"x0":205,"y0":49,"yoffs":2,"xpad":2,"w":7,"h":10},{"c":20,"x0":221,"y0":49,"yoffs":2,"xpad":1,"w":8,"h":10},{"c":21,"x0":486,"y0":4,"yoffs":1,"xpad":2,"w":7,"h":12},{"c":22,"x0":327,"y0":139,"yoffs":8,"xpad":2,"w":7,"h":4},{"c":23,"x0":238,"y0":49,"yoffs":2,"xpad":2,"w":7,"h":10},{"c":24,"x0":254,"y0":49,"yoffs":2,"xpad":2,"w":7,"h":10},{"c":25,"x0":270,"y0":49,"yoffs":2,"xpad":2,"w":7,"h":10},{"c":26,"x0":117,"y0":143,"yoffs":5,"xpad":2,"w":7,"h":5},{"c":27,"x0":133,"y0":142,"yoffs":5,"xpad":2,"w":7,"h":5},{"c":28,"x0":343,"y0":139,"yoffs":6,"xpad":2,"w":7,"h":4},{"c":29,"x0":149,"y0":140,"yoffs":5,"xpad":2,"w":7,"h":5},{"c":30,"x0":135,"y0":124,"yoffs":4,"xpad":2,"w":7,"h":7},{"c":31,"x0":151,"y0":124,"yoffs":4,"xpad":2,"w":7,"h":7},{"c":32,"xpad":9},{"c":33,"x0":286,"y0":49,"yoffs":2,"xpad":3,"w":6,"h":10},{"c":34,"x0":359,"y0":139,"yoffs":1,"xpad":2,"w":7,"h":4},{"c":35,"x0":37,"y0":108,"yoffs":3,"xpad":2,"w":7,"h":9},{"c":36,"x0":374,"y0":4,"xpad":2,"w":7,"h":14},{"c":37,"x0":335,"y0":106,"yoffs":4,"xpad":2,"w":7,"h":8},{"c":38,"x0":301,"y0":49,"yoffs":2,"xpad":2,"w":7,"h":10},{"c":39,"x0":375,"y0":139,"yoffs":1,"xpad":5,"w":4,"h":4},{"c":40,"x0":317,"y0":49,"yoffs":2,"xpad":3,"w":6,"h":10},{"c":41,"x0":332,"y0":49,"yoffs":2,"xpad":3,"w":6,"h":10},{"c":42,"x0":165,"y0":140,"yoffs":5,"xpad":1,"w":8,"h":5},{"c":43,"x0":182,"y0":140,"yoffs":5,"xpad":2,"w":7,"h":5},{"c":44,"x0":388,"y0":139,"yoffs":9,"xpad":4,"w":5,"h":4},{"c":45,"x0":34,"y0":158,"yoffs":7,"xpad":2,"w":7,"h":1},{"c":46,"x0":499,"y0":135,"yoffs":10,"xpad":4,"w":5,"h":2},{"c":47,"x0":351,"y0":106,"yoffs":4,"xpad":2,"w":7,"h":8},{"c":48,"x0":347,"y0":49,"yoffs":2,"xpad":2,"w":7,"h":10},{"c":49,"x0":363,"y0":49,"yoffs":2,"xpad":2,"w":7,"h":10},{"c":50,"x0":379,"y0":49,"yoffs":2,"xpad":2,"w":7,"h":10},{"c":51,"x0":395,"y0":47,"yoffs":2,"xpad":2,"w":7,"h":10},{"c":52,"x0":411,"y0":47,"yoffs":2,"xpad":2,"w":7,"h":10},{"c":53,"x0":427,"y0":46,"yoffs":2,"xpad":2,"w":7,"h":10},{"c":54,"x0":443,"y0":46,"yoffs":2,"xpad":2,"w":7,"h":10},{"c":55,"x0":459,"y0":46,"yoffs":2,"xpad":2,"w":7,"h":10},{"c":56,"x0":475,"y0":46,"yoffs":2,"xpad":2,"w":7,"h":10},{"c":57,"x0":491,"y0":46,"yoffs":2,"xpad":2,"w":7,"h":10},{"c":58,"x0":167,"y0":124,"yoffs":4,"xpad":4,"w":5,"h":7},{"c":59,"x0":367,"y0":106,"yoffs":4,"xpad":4,"w":5,"h":8},{"c":60,"x0":53,"y0":108,"yoffs":3,"xpad":2,"w":7,"h":9},{"c":61,"x0":402,"y0":139,"yoffs":5,"xpad":2,"w":7,"h":4},{"c":62,"x0":69,"y0":108,"yoffs":3,"xpad":2,"w":7,"h":9},{"c":63,"x0":4,"y0":70,"yoffs":2,"xpad":2,"w":7,"h":10},{"c":64,"x0":85,"y0":108,"yoffs":3,"xpad":2,"w":7,"h":9},{"c":65,"x0":20,"y0":70,"yoffs":2,"xpad":2,"w":7,"h":10},{"c":66,"x0":36,"y0":70,"yoffs":2,"xpad":2,"w":7,"h":10},{"c":67,"x0":52,"y0":70,"yoffs":2,"xpad":2,"w":7,"h":10},{"c":68,"x0":68,"y0":70,"yoffs":2,"xpad":2,"w":7,"h":10},{"c":69,"x0":84,"y0":70,"yoffs":2,"xpad":2,"w":7,"h":10},{"c":70,"x0":100,"y0":70,"yoffs":2,"xpad":2,"w":7,"h":10},{"c":71,"x0":116,"y0":68,"yoffs":2,"xpad":2,"w":7,"h":10},{"c":72,"x0":132,"y0":68,"yoffs":2,"xpad":2,"w":7,"h":10},{"c":73,"x0":148,"y0":68,"yoffs":2,"xpad":3,"w":6,"h":10},{"c":74,"x0":163,"y0":68,"yoffs":2,"xpad":2,"w":7,"h":10},{"c":75,"x0":179,"y0":68,"yoffs":2,"xpad":2,"w":7,"h":10},{"c":76,"x0":195,"y0":68,"yoffs":2,"xpad":2,"w":7,"h":10},{"c":77,"x0":211,"y0":68,"yoffs":2,"xpad":2,"w":7,"h":10},{"c":78,"x0":227,"y0":68,"yoffs":2,"xpad":2,"w":7,"h":10},{"c":79,"x0":243,"y0":68,"yoffs":2,"xpad":2,"w":7,"h":10},{"c":80,"x0":259,"y0":68,"yoffs":2,"xpad":2,"w":7,"h":10},{"c":81,"x0":4,"y0":29,"yoffs":2,"xpad":2,"w":7,"h":12},{"c":82,"x0":275,"y0":68,"yoffs":2,"xpad":2,"w":7,"h":10},{"c":83,"x0":291,"y0":68,"yoffs":2,"xpad":2,"w":7,"h":10},{"c":84,"x0":307,"y0":68,"yoffs":2,"xpad":2,"w":7,"h":10},{"c":85,"x0":323,"y0":68,"yoffs":2,"xpad":2,"w":7,"h":10},{"c":86,"x0":339,"y0":68,"yoffs":2,"xpad":2,"w":7,"h":10},{"c":87,"x0":355,"y0":68,"yoffs":2,"xpad":2,"w":7,"h":10},{"c":88,"x0":371,"y0":68,"yoffs":2,"xpad":2,"w":7,"h":10},{"c":89,"x0":387,"y0":68,"yoffs":2,"xpad":2,"w":7,"h":10},{"c":90,"x0":403,"y0":66,"yoffs":2,"xpad":2,"w":7,"h":10},{"c":91,"x0":419,"y0":66,"yoffs":2,"xpad":3,"w":6,"h":10},{"c":92,"x0":101,"y0":108,"yoffs":3,"xpad":2,"w":7,"h":9},{"c":93,"x0":434,"y0":65,"yoffs":2,"xpad":3,"w":6,"h":10},{"c":94,"x0":418,"y0":139,"xpad":2,"w":7,"h":4},{"c":95,"x0":50,"y0":158,"yoffs":13,"xpad":1,"w":8,"h":1},{"c":96,"x0":466,"y0":137,"yoffs":1,"xpad":3,"w":6,"h":3},{"c":97,"x0":181,"y0":124,"yoffs":5,"xpad":2,"w":7,"h":7},{"c":98,"x0":449,"y0":65,"yoffs":2,"xpad":2,"w":7,"h":10},{"c":99,"x0":197,"y0":124,"yoffs":5,"xpad":2,"w":7,"h":7},{"c":100,"x0":465,"y0":65,"yoffs":2,"xpad":2,"w":7,"h":10},{"c":101,"x0":213,"y0":124,"yoffs":5,"xpad":2,"w":7,"h":7},{"c":102,"x0":481,"y0":65,"yoffs":2,"xpad":2,"w":7,"h":10},{"c":103,"x0":497,"y0":65,"yoffs":5,"xpad":2,"w":7,"h":10},{"c":104,"x0":4,"y0":89,"yoffs":2,"xpad":2,"w":7,"h":10},{"c":105,"x0":20,"y0":89,"yoffs":2,"xpad":3,"w":6,"h":10},{"c":106,"x0":407,"y0":4,"yoffs":2,"xpad":2,"w":7,"h":13},{"c":107,"x0":35,"y0":89,"yoffs":2,"xpad":2,"w":7,"h":10},{"c":108,"x0":51,"y0":89,"yoffs":2,"xpad":3,"w":6,"h":10},{"c":109,"x0":229,"y0":124,"yoffs":5,"xpad":2,"w":7,"h":7},{"c":110,"x0":245,"y0":124,"yoffs":5,"xpad":2,"w":7,"h":7},{"c":111,"x0":261,"y0":124,"yoffs":5,"xpad":2,"w":7,"h":7},{"c":112,"x0":66,"y0":89,"yoffs":5,"xpad":2,"w":7,"h":10},{"c":113,"x0":82,"y0":89,"yoffs":5,"xpad":2,"w":7,"h":10},{"c":114,"x0":277,"y0":124,"yoffs":5,"xpad":2,"w":7,"h":7},{"c":115,"x0":293,"y0":124,"yoffs":5,"xpad":2,"w":7,"h":7},{"c":116,"x0":98,"y0":89,"yoffs":2,"xpad":2,"w":7,"h":10},{"c":117,"x0":309,"y0":124,"yoffs":5,"xpad":2,"w":7,"h":7},{"c":118,"x0":325,"y0":123,"yoffs":5,"xpad":2,"w":7,"h":7},{"c":119,"x0":341,"y0":123,"yoffs":5,"xpad":2,"w":7,"h":7},{"c":120,"x0":357,"y0":123,"yoffs":5,"xpad":2,"w":7,"h":7},{"c":121,"x0":114,"y0":89,"yoffs":5,"xpad":2,"w":7,"h":10},{"c":122,"x0":373,"y0":123,"yoffs":5,"xpad":2,"w":7,"h":7},{"c":123,"x0":130,"y0":87,"yoffs":2,"xpad":2,"w":7,"h":10},{"c":124,"x0":146,"y0":87,"yoffs":2,"xpad":4,"w":5,"h":10},{"c":125,"x0":160,"y0":87,"yoffs":2,"xpad":2,"w":7,"h":10},{"c":126,"x0":4,"y0":159,"yoffs":1,"xpad":2,"w":7,"h":2},{"c":127,"x0":389,"y0":123,"yoffs":4,"xpad":2,"w":7,"h":7},{"c":160,"xpad":9},{"c":161,"x0":176,"y0":87,"yoffs":2,"xpad":3,"w":6,"h":10},{"c":162,"x0":132,"y0":29,"yoffs":1,"xpad":2,"w":7,"h":11},{"c":163,"x0":148,"y0":29,"yoffs":1,"xpad":2,"w":7,"h":11},{"c":165,"x0":191,"y0":87,"yoffs":2,"xpad":2,"w":7,"h":10},{"c":170,"x0":36,"y0":143,"yoffs":2,"xpad":2,"w":7,"h":6},{"c":171,"x0":198,"y0":140,"yoffs":5,"xpad":2,"w":7,"h":5},{"c":172,"x0":214,"y0":140,"yoffs":6,"xpad":2,"w":7,"h":5},{"c":176,"x0":434,"y0":139,"yoffs":1,"xpad":3,"w":6,"h":4},{"c":177,"x0":381,"y0":106,"yoffs":4,"xpad":2,"w":7,"h":8},{"c":178,"x0":52,"y0":143,"yoffs":1,"xpad":2,"w":7,"h":6},{"c":181,"x0":207,"y0":87,"yoffs":5,"xpad":2,"w":7,"h":10},{"c":183,"x0":67,"y0":158,"yoffs":7,"xpad":4,"w":5,"h":1},{"c":186,"x0":68,"y0":143,"yoffs":2,"xpad":3,"w":6,"h":6},{"c":187,"x0":230,"y0":140,"yoffs":5,"xpad":2,"w":7,"h":5},{"c":188,"x0":423,"y0":4,"yoffs":1,"xpad":1,"w":8,"h":13},{"c":189,"x0":440,"y0":4,"yoffs":1,"xpad":2,"w":7,"h":13},{"c":191,"x0":223,"y0":87,"yoffs":2,"xpad":2,"w":7,"h":10},{"c":196,"x0":164,"y0":29,"yoffs":1,"xpad":2,"w":7,"h":11},{"c":197,"x0":20,"y0":29,"xpad":2,"w":7,"h":12},{"c":198,"x0":36,"y0":29,"xpad":2,"w":7,"h":12},{"c":199,"x0":52,"y0":29,"yoffs":2,"xpad":2,"w":7,"h":12},{"c":201,"x0":68,"y0":29,"xpad":2,"w":7,"h":12},{"c":209,"x0":84,"y0":29,"xpad":2,"w":7,"h":12},{"c":214,"x0":180,"y0":29,"yoffs":1,"xpad":2,"w":7,"h":11},{"c":220,"x0":196,"y0":29,"yoffs":1,"xpad":2,"w":7,"h":11},{"c":223,"x0":239,"y0":87,"yoffs":2,"xpad":2,"w":7,"h":10},{"c":224,"x0":212,"y0":29,"yoffs":1,"xpad":2,"w":7,"h":11},{"c":225,"x0":228,"y0":29,"yoffs":1,"xpad":2,"w":7,"h":11},{"c":226,"x0":244,"y0":29,"yoffs":1,"xpad":2,"w":7,"h":11},{"c":228,"x0":255,"y0":87,"yoffs":2,"xpad":2,"w":7,"h":10},{"c":229,"x0":260,"y0":29,"yoffs":1,"xpad":2,"w":7,"h":11},{"c":230,"x0":405,"y0":123,"yoffs":5,"xpad":2,"w":7,"h":7},{"c":231,"x0":117,"y0":108,"yoffs":5,"xpad":2,"w":7,"h":9},{"c":232,"x0":276,"y0":29,"yoffs":1,"xpad":2,"w":7,"h":11},{"c":233,"x0":292,"y0":29,"yoffs":1,"xpad":2,"w":7,"h":11},{"c":234,"x0":308,"y0":29,"yoffs":1,"xpad":2,"w":7,"h":11},{"c":235,"x0":271,"y0":87,"yoffs":2,"xpad":2,"w":7,"h":10},{"c":236,"x0":324,"y0":29,"yoffs":1,"xpad":3,"w":6,"h":11},{"c":237,"x0":339,"y0":29,"yoffs":1,"xpad":3,"w":6,"h":11},{"c":238,"x0":354,"y0":29,"yoffs":1,"xpad":2,"w":7,"h":11},{"c":239,"x0":287,"y0":87,"yoffs":2,"xpad":2,"w":7,"h":10},{"c":241,"x0":303,"y0":87,"yoffs":2,"xpad":2,"w":7,"h":10},{"c":242,"x0":370,"y0":29,"yoffs":1,"xpad":2,"w":7,"h":11},{"c":243,"x0":386,"y0":27,"yoffs":1,"xpad":2,"w":7,"h":11},{"c":244,"x0":402,"y0":27,"yoffs":1,"xpad":2,"w":7,"h":11},{"c":246,"x0":319,"y0":87,"yoffs":2,"xpad":2,"w":7,"h":10},{"c":247,"x0":246,"y0":140,"yoffs":5,"xpad":2,"w":7,"h":5},{"c":249,"x0":418,"y0":26,"yoffs":1,"xpad":2,"w":7,"h":11},{"c":250,"x0":434,"y0":26,"yoffs":1,"xpad":2,"w":7,"h":11},{"c":251,"x0":450,"y0":26,"yoffs":1,"xpad":2,"w":7,"h":11},{"c":252,"x0":335,"y0":87,"yoffs":2,"xpad":2,"w":7,"h":10},{"c":255,"x0":456,"y0":4,"yoffs":2,"xpad":2,"w":7,"h":13},{"c":402,"x0":466,"y0":26,"yoffs":1,"xpad":1,"w":8,"h":11},{"c":915,"x0":351,"y0":87,"yoffs":2,"xpad":2,"w":7,"h":10},{"c":920,"x0":367,"y0":87,"yoffs":2,"xpad":2,"w":7,"h":10},{"c":931,"x0":383,"y0":87,"yoffs":2,"xpad":2,"w":7,"h":10},{"c":934,"x0":399,"y0":87,"yoffs":2,"xpad":2,"w":7,"h":10},{"c":937,"x0":415,"y0":85,"yoffs":2,"xpad":2,"w":7,"h":10},{"c":945,"x0":421,"y0":123,"yoffs":5,"xpad":2,"w":7,"h":7},{"c":948,"x0":431,"y0":85,"yoffs":2,"xpad":2,"w":7,"h":10},{"c":949,"x0":447,"y0":84,"yoffs":2,"xpad":3,"w":6,"h":10},{"c":960,"x0":437,"y0":121,"yoffs":5,"xpad":2,"w":7,"h":7},{"c":963,"x0":453,"y0":121,"yoffs":5,"xpad":2,"w":7,"h":7},{"c":964,"x0":397,"y0":106,"yoffs":4,"xpad":2,"w":7,"h":8},{"c":966,"x0":133,"y0":106,"yoffs":3,"w":9,"h":9},{"c":8319,"x0":83,"y0":143,"yoffs":1,"xpad":2,"w":7,"h":6},{"c":8359,"x0":483,"y0":26,"yoffs":1,"xpad":2,"w":7,"h":11},{"c":8729,"x0":20,"y0":158,"yoffs":7,"xpad":4,"w":5,"h":2},{"c":8730,"x0":499,"y0":25,"yoffs":1,"xpad":1,"w":8,"h":11},{"c":8734,"x0":262,"y0":140,"yoffs":5,"w":9,"h":5},{"c":8745,"x0":151,"y0":106,"yoffs":3,"xpad":2,"w":7,"h":9},{"c":8776,"x0":280,"y0":140,"yoffs":5,"xpad":2,"w":7,"h":5},{"c":8801,"x0":469,"y0":120,"yoffs":4,"xpad":2,"w":7,"h":7},{"c":8804,"x0":167,"y0":106,"yoffs":3,"xpad":2,"w":7,"h":9},{"c":8805,"x0":183,"y0":106,"yoffs":3,"xpad":2,"w":7,"h":9},{"c":8976,"x0":296,"y0":140,"yoffs":6,"xpad":2,"w":7,"h":5},{"c":8992,"x0":390,"y0":4,"yoffs":2,"xpad":1,"w":8,"h":14},{"c":8993,"x0":472,"y0":4,"xpad":4,"w":5,"h":13},{"c":9472,"x0":81,"y0":158,"yoffs":7,"w":9,"h":1},{"c":9474,"x0":38,"y0":4,"xpad":4,"w":5,"h":16},{"c":9484,"x0":199,"y0":106,"yoffs":7,"w":9,"h":9},{"c":9488,"x0":217,"y0":106,"yoffs":7,"xpad":4,"w":5,"h":9},{"c":9492,"x0":413,"y0":106,"w":9,"h":8},{"c":9496,"x0":431,"y0":104,"xpad":4,"w":5,"h":8},{"c":9500,"x0":52,"y0":4,"w":9,"h":16},{"c":9508,"x0":70,"y0":4,"xpad":4,"w":5,"h":16},{"c":9516,"x0":231,"y0":106,"yoffs":7,"w":9,"h":9},{"c":9524,"x0":445,"y0":104,"w":9,"h":8},{"c":9532,"x0":84,"y0":4,"w":9,"h":16},{"c":9552,"x0":481,"y0":136,"yoffs":5,"w":9,"h":3},{"c":9553,"x0":102,"y0":4,"xpad":2,"w":7,"h":16},{"c":9554,"x0":4,"y0":50,"yoffs":5,"w":9,"h":11},{"c":9555,"x0":249,"y0":106,"yoffs":7,"w":9,"h":9},{"c":9556,"x0":22,"y0":50,"yoffs":5,"w":9,"h":11},{"c":9557,"x0":40,"y0":50,"yoffs":5,"xpad":4,"w":5,"h":11},{"c":9558,"x0":267,"y0":106,"yoffs":7,"xpad":2,"w":7,"h":9},{"c":9559,"x0":54,"y0":50,"yoffs":5,"xpad":2,"w":7,"h":11},{"c":9560,"x0":463,"y0":103,"w":9,"h":8},{"c":9561,"x0":481,"y0":102,"w":9,"h":8},{"c":9562,"x0":4,"y0":126,"w":9,"h":8},{"c":9563,"x0":22,"y0":126,"xpad":4,"w":5,"h":8},{"c":9564,"x0":36,"y0":126,"xpad":2,"w":7,"h":8},{"c":9565,"x0":52,"y0":126,"xpad":2,"w":7,"h":8},{"c":9566,"x0":118,"y0":4,"w":9,"h":16},{"c":9567,"x0":136,"y0":4,"w":9,"h":16},{"c":9568,"x0":154,"y0":4,"w":9,"h":16},{"c":9569,"x0":172,"y0":4,"xpad":4,"w":5,"h":16},{"c":9570,"x0":186,"y0":4,"xpad":2,"w":7,"h":16},{"c":9571,"x0":202,"y0":4,"xpad":2,"w":7,"h":16},{"c":9572,"x0":70,"y0":50,"yoffs":5,"w":9,"h":11},{"c":9573,"x0":283,"y0":106,"yoffs":7,"w":9,"h":9},{"c":9574,"x0":88,"y0":50,"yoffs":5,"w":9,"h":11},{"c":9575,"x0":99,"y0":143,"yoffs":2,"w":9,"h":6},{"c":9576,"x0":68,"y0":126,"w":9,"h":8},{"c":9577,"x0":86,"y0":126,"w":9,"h":8},{"c":9578,"x0":218,"y0":4,"w":9,"h":16},{"c":9579,"x0":236,"y0":4,"w":9,"h":16},{"c":9580,"x0":254,"y0":4,"w":9,"h":16},{"c":9600,"x0":485,"y0":119,"w":9,"h":7},{"c":9604,"x0":301,"y0":106,"yoffs":7,"w":9,"h":9},{"c":9608,"x0":272,"y0":4,"w":9,"h":16},{"c":9612,"x0":290,"y0":4,"xpad":5,"w":4,"h":16},{"c":9616,"x0":303,"y0":4,"w":9,"h":16},{"c":9617,"x0":321,"y0":4,"xpad":1,"w":8,"h":16},{"c":9618,"x0":338,"y0":4,"xpad":1,"w":9,"h":16},{"c":9619,"x0":356,"y0":4,"xpad":1,"w":9,"h":16},{"c":9632,"x0":4,"y0":143,"yoffs":4,"xpad":2,"w":7,"h":7},{"c":9654,"x0":104,"y0":126,"yoffs":4,"xpad":1,"w":6,"h":8},{"c":9660,"x0":449,"y0":137,"yoffs":6,"xpad":1,"w":8,"h":4},{"c":65533,"x0":462,"y0":84,"yoffs":3,"xpad":1,"w":8,"h":10}]}
},{}],3:[function(require,module,exports){
"use strict"
exports.main=main
var local_storage=require("../glov/client/local_storage.js")
local_storage.setStoragePrefix("glovjs-playground")
var _glovClientEngineJs=require("../glov/client/engine.js")
var engine=_glovClientEngineJs
var _glovClientInputJs=require("../glov/client/input.js")
var input=_glovClientInputJs
var floor=Math.floor,random=Math.random,min=Math.min
var _glovClientNetJs=require("../glov/client/net.js")
var net=_glovClientNetJs
var _glovClientTerminalJs=require("../glov/client/terminal.js")
var ansi=_glovClientTerminalJs.ansi
var padRight=_glovClientTerminalJs.padRight
var terminalCreate=_glovClientTerminalJs.terminalCreate
var _glovClientTerminal_settingsJs=require("../glov/client/terminal_settings.js")
var terminalSettingsInit=_glovClientTerminal_settingsJs.terminalSettingsInit
var terminalSettingsShow=_glovClientTerminal_settingsJs.terminalSettingsShow
var _glovClientUiJs=require("../glov/client/ui.js")
var ui=_glovClientUiJs
window.Z=window.Z||{}
Z.BACKGROUND=1
Z.SPRITES=10
Z.PARTICLES=20
Z.UI_TEST=200
var game_width=720
var game_height=400
var ansi_files=["[?7h[40m[2J[4C[0;1;34mWelcome to[38C[33mSy[0;33mso[1mp:\r\n[50C[34mJi[0;34mm  Ess[1mer\r\n[0;34mÃŸÃŸÃŸÃŸÃŸÃŸÃŸÃŸ ÃŸÃŸ   ÃŸÃŸ ÃŸÃŸÃŸÃŸÃŸÃŸÃŸ\r\n    ÃŸÃŸ    ÃŸÃŸ   ÃŸÃŸ ÃŸÃŸ\r\n   ÃŸÃŸ    ÃŸÃŸÃŸÃŸÃŸÃŸÃŸ ÃŸÃŸÃŸÃŸÃŸ\r\n    ÃŸÃŸ    ÃŸÃŸ   ÃŸÃŸ ÃŸÃŸ\r\n   ÃŸÃŸ    ÃŸÃŸ   ÃŸÃŸ ÃŸÃŸÃŸÃŸÃŸÃŸÃŸ\r\n[1;36mÃ„Ã’Ã„ [0;36mÃ–Ã„Ã„Â¿ [1mÃ–Ã„Ã’Ã„Â¿ [0;36mÃ’Ã„Ã„Â¿ [1mÃ’    [0;36mÃ’    [1mÃ’Ã„Ã„Â¿ [0;36mÃ–Ã„Ã„Â¿ [1mÃ–Ã„Ã’Ã„Â¿ [0;36mÃ’  Ã‚ [1mÃ–Ã„Ã„Â¿ [0;36mÃ’\r\n [1mÂº  [0;36mÂº  Â³   [1mÂº   [0;36mÃ‡Ã„   [1mÂº    [0;36mÂº    [1mÃ‡Ã„   [0;36mÂº[6C[1mÂº   [0;36mÂº  Â³ [1mÃ‡Ã„Ã„Â´ [0;36mÂº\r\n [1mÂº  [0;36mÃ  Ã   [1mÃ   [0;36mÃÃ„Ã„Ã™ [1mÃÃ„Ã„Ã™ [0;36mÃÃ„Ã„Ã™ [1mÃÃ„Ã„Ã™ [0;36mÃ“Ã„Ã„Ã™   [1mÃ   [0;36mÃ“Ã„Ã„Ã™ [1mÃ  Ã [0;36mÃÃ„Ã„Ã™\r\n [1mÂº [32mÃ›Ã›[0;32mÂ»    [1mÃ›Ã›[0;32mÂ» [1mÃ›Ã›Ã›Ã›Ã›[0;32mÂ» [1mÃ›Ã›Ã›Ã›Ã›Ã›Ã›[0;32mÂ»[1mÃ›Ã›Ã›Ã›Ã›Ã›Ã›Ã›[0;32mÂ»[1mÃ›Ã›Ã›Ã›Ã›Ã›Ã›[0;32mÂ»[1mÃ›Ã›[0;32mÂ»[6C[1mÃ›Ã›Ã›Ã›Ã›[0;32mÂ» [1mÃ›Ã›Ã›[0;32mÂ»   [1mÃ›Ã›[0;32mÂ»[1mÃ›Ã›Ã›Ã›Ã›Ã›[0;32mÂ»\r\n [1;36mÂº [32mÃ›Ã›[0;32mÂº    [1mÃ›Ã›[0;32mÂº[1mÃ›Ã›[0;32mÃ‰ÃÃ[1mÃ›Ã›[0;32mÂ»[1mÃ›Ã›[0;32mÃ‰ÃÃÃÃÂ¼ÃˆÃÃ[1mÃ›Ã›[0;32mÃ‰ÃÃÂ¼[1mÃ›Ã›[0;32mÃ‰ÃÃÃÃÂ¼[1mÃ›Ã›[0;32mÂº[5C[1mÃ›Ã›[0;32mÃ‰ÃÃ[1mÃ›Ã›[0;32mÂ»[1mÃ›Ã›Ã›Ã›[0;32mÂ»  [1mÃ›Ã›[0;32mÂº[1mÃ›Ã›[0;32mÃ‰ÃÃ[1mÃ›Ã›[0;32mÂ»[13;1H[1;36mÃ„ÃÃ„[32mÃ›Ã›[0;32mÂº [1mÃ›[0;32mÂ» [1mÃ›Ã›[0;32mÂº[1mÃ›Ã›Ã›Ã›Ã›Ã›Ã›[0;32mÂº[1mÃ›Ã›Ã›Ã›Ã›Ã›Ã›[0;32mÂ»   [1mÃ›Ã›[0;32mÂº   [1mÃ›Ã›Ã›Ã›Ã›[0;32mÂ»  [1mÃ›Ã›[0;32mÂº[5C[1mÃ›Ã›Ã›Ã›Ã›Ã›Ã›[0;32mÂº[1mÃ›Ã›[0;32mÃ‰[1mÃ›Ã›[0;32mÂ» [1mÃ›Ã›[0;32mÂº[1mÃ›Ã›[0;32mÂº  [1mÃ›Ã›[0;32mÂº[14;1H   [1mÃ›Ã›[0;32mÂº[1mÃ›Ã›Ã›[0;32mÂ»[1mÃ›Ã›[0;32mÂº[1mÃ›Ã›[0;32mÃ‰ÃÃ[1mÃ›Ã›[0;32mÂºÃˆÃÃÃÃ[1mÃ›Ã›[0;32mÂº   [1mÃ›Ã›[0;32mÂº   [1mÃ›Ã›[0;32mÃ‰ÃÃÂ¼  [1mÃ›Ã›[0;32mÂº[5C[1mÃ›Ã›[0;32mÃ‰ÃÃ[1mÃ›Ã›[0;32mÂº[1mÃ›Ã›[0;32mÂºÃˆ[1mÃ›Ã›[0;32mÂ»[1mÃ›Ã›[0;32mÂº[1mÃ›Ã›[0;32mÂº  [1mÃ›Ã›[0;32mÂº[15;1H   Ãˆ[1mÃ›Ã›Ã›[0;32mÃ‰[1mÃ›Ã›Ã›[0;32mÃ‰Â¼[1mÃ›Ã›[0;32mÂº  [1mÃ›Ã›[0;32mÂº[1mÃ›Ã›Ã›Ã›Ã›Ã›Ã›[0;32mÂº   [1mÃ›Ã›[0;32mÂº   [1mÃ›Ã›Ã›Ã›Ã›Ã›Ã›[0;32mÂ»[1mÃ›Ã›Ã›Ã›Ã›Ã›Ã›[0;32mÂ»[1mÃ›Ã›[0;32mÂº  [1mÃ›Ã›[0;32mÂº[1mÃ›Ã›[0;32mÂº Ãˆ[1mÃ›Ã›Ã›Ã›[0;32mÂº[1mÃ›Ã›Ã›Ã›Ã›Ã›[0;32mÃ‰Â¼[16;1H    ÃˆÃÃÂ¼ÃˆÃÃÂ¼ ÃˆÃÂ¼  ÃˆÃÂ¼ÃˆÃÃÃÃÃÃÂ¼   ÃˆÃÂ¼   ÃˆÃÃÃÃÃÃÂ¼ÃˆÃÃÃÃÃÃÂ¼ÃˆÃÂ¼  ÃˆÃÂ¼ÃˆÃÂ¼  ÃˆÃÃÃÂ¼ÃˆÃÃÃÃÃÂ¼\r\n\r\n\r\n[6C[1;33mÃ› Ã[52CÃ Ãœ\r\n[0;33mÃ›Ã›Ã›[1;43mÃº[40mÃ›[43mÃœ[40mÃ›[43mÃœ[40mÃ›[0;33mÃ›Ã›Ã›Ã›[1;43mÃº[0;33mÃ›Ã›Ã›[1;43mÃº[0;33mÃ›Ã›Ã›Ã›[1;43mÃº[0;33mÃ›Ã›Ã›Ã›Ã›Ã›[1;43mÃº[0;33mÃ›[43m [40mÃ›[1;43mÃº[0;33mÃ›Ã›Ã›[1;43mÃº[0;33mÃ›Ã›Ã›Ã›[1;43mÃº[0;33mÃ›[1;43mÃº[0;33mÃ›Ã›Ã›Ã›[1;43mÃº[0;33mÃ›[1;43mÃº[0;33mÃ›Ã›Ã›[1;43mÃº[0;33mÃ›Ã›[1;43mÃº[0;33mÃ›[1;43mÃºÃ› Ã› ÃœÃºÃº[0;33mÃ›Ã›Ã›Ã›[1;43mÃº[0;33mÃ›Ã›[1;43mÃº[0;33mÃ›Ã›[1;43mÃº[0;33mÃ›[21;1HÃ›Ã›Ã›Ã›Ã›Ã›[1mÃ›[0;33mÃ›Ã›Ã›Ã›[1;43mÃº[0;33mÃ›Ã›[1;43mÃº[0;33mÃ›Ã›Ã›Ã›[43m  [40mÃ›Ã›Ã›Ã›[1;43mÃœ Ã›[0;33mÃ›[1;43mÃ [0;33mÃ›[1;43mÃº[0;33mÃ›[1;43mÃº[0;33mÃ›[1;43mÃº[0;33mÃ›Ã›[1;43mÃº[0;33mÃ›Ã›Ã›[1;43mÃº[0;33mÃ›Ã›[1;43mÃœ[0;33mÃ›[1;43mÃº[0;33mÃ›Ã›Ã›Ã›[1;43mÃº[0;33mÃ›Ã›Ã›Ã›Ã›Ã›[1;43mÃºÃŸÃŸÃ›ÃœÃ›[0;33mÃ›Ã›Ã›Ã›Ã›[1;43mÃº[0;33mÃ›Ã›Ã›Ã›Ã›[1;43mÃº[0;33mÃ›[1;43mÃº[22;1H[0;33mÃ›Ã›[1;43mÃº[0;33mÃ›Ã›Ã›Ã›[1;43mÃº[0;33mÃ›Ã›Ã›Ã›[1;43mÃºÃ›[0;33mÃ›Ã›[1;43mÃº[0;33mÃ›Ã›[1;43mÃž[0;33mÃ›Ã›Ã›Ã›Ã›[1;43mÃŸÃŸÃ›ÃŸÃŸ[0;33mÃ›Ã›Ã›[1;43mÃº[0;33mÃ›[1;43mÃº[0;33mÃ›Ã›Ã›Ã›[43m [1mÃ›Ãº[0;33mÃ›Ã›[1;43mÃŸÃ›ÃŸ[0;33mÃ›[1;43mÃº[0;33mÃ›Ã›[1;43mÃº[0;33mÃ›[1;43mÃœ[0;33mÃ›Ã›Ã›[1;43mÃº[0;33mÃ›[1;43mÃº  Ã› [0;33mÃ›[1;43mÃº[0;33mÃ›Ã›[1;43mÃº[0;33mÃ›[1;43mÃº[0;33mÃ›Ã›Ã›Ã›[1;43mÃº[0;33mÃ›Ã›Ã›[23;1HÃ›Ã›Ã›Ã›Ã›Ã›[1;43mÃº[0;33mÃ›Ã›[1;43mÃº[0;33mÃ›[1;43mÃžÃŸÃ›ÃœÃ[0;33mÃ›Ã›Ã›[1;43mÃº[0;33mÃ›Ã›Ã›Ã›Ã›[1;43mÃº[0;33mÃ›[1;43mÃŸ[0;33mÃ›Ã›[1;43mÃº[0;33mÃ›Ã›Ã›Ã›Ã›[1;43mÃº[0;33mÃ›Ã›[1;43mÃºÃœÃ›ÃŸ[0;33mÃ›Ã›Ã›[1;43mÃº[0;33mÃ›Ã›[1;43mÃº[0;33mÃ›Ã›Ã›[1;43mÃŸÃ›[0;33mÃ›[1;43mÃº Ã›ÃºÃœ    [0;33mÃ›[1;43mÃº[0;33mÃ›[1;43mÃº[0;33mÃ›Ã›Ã›Ã›Ã›Ã›Ã›[1;43mÃº[0;33mÃ›Ã›Ã›[24;1H[1;43mÃº[0;33mÃ›Ã›[1;43mÃº[0;33mÃ›Ã›Ã›Ã›[1;43mÃº[0;33mÃ›Ã›Ã›Ã›[1;43mÃ›[0;33mÃ›Ã›Ã›Ã›Ã›Ã›Ã›[1;43mÃº[0;33mÃ›Ã›Ã›Ã›Ã›[43m [40mÃ›Ã›Ã›Ã›[1;43mÃº[0;33mÃ›Ã›Ã›Ã›Ã›Ã›[1;43mÃº[0;33mÃ›[1;43mÃ›[0;33mÃ›[1;43mÃº[0;33mÃ›Ã›Ã›Ã›Ã›[1;43mÃº[0;33mÃ›Ã›Ã›[1;43mÃº[0;33mÃ›Ã›[43m [1mÃ›Ã›ÃœÃ›[0;33mÃ›[1;43mÃº   Ãº[0;33mÃ›Ã›[1;43mÃº[0;33mÃ›[1;43mÃº[0;33mÃ›Ã›Ã›Ã›Ã›[1;43mÃº[0;33mÃ›Ã›[0m\r\n","[40m[2J[4C[0;1;35mMerchant Cruiser[2H  [0;31mÃšÃ„Ã„Ã„Ã„Ã„Ã„Ã„Ã„Ã„Ã„Ã„Ã„Ã„Ã„Ã„Ã„Ã„Ã„Â¿[20C[s\r\n[u[1;37mShip Category [0m#[1m1[3H  [0;31mÂ³[1;30mÃº   [0mÃº   [s\r\n[u[1;44mÃž[0mÃ  [1;30mÃº  [37mÃº  [0;31mÂ³   [34mÃ„Ã„Ã„Ã„Ã„Ã„Ã„Ã„Ã„Ã„Ã„Ã„Ã„Ã„Ã„Ã„Ã„Ã„Ã„Ã„Ã„Ã„Ã„Ã„[s\r\n[uÃ„Ã„Ã„Ã„Ã„Ã„Ã„Ã„Ã„Ã„Ã„Ã„Ã„Ã„Ã„Ã„Ã„Ã„Ã„Ã„Ã„Ã„Ã„Ã„Ã„Ã„[4H  [31mÂ³[5C[1;37mÃº [34mÃž[31;44m:[40m[s\r\n[u[44m[0;31m:[34mÃ[37mÃº[5CÃº[31mÂ³[5C[1;37mThe  [35mMerchant Cruiser[s\r\n[u  [37mis the standard fare for[5H  [0;31mÂ³[37mÃº  [1;30mÃº   [s\r\n[u[34;44mÃÃ[0;34mÃžÃž   [1;30mÃº   [0;31mÂ³[5C[1;37mearning a living in t[s\r\n[uhe universe.   These craft[6H  [0;31mÂ³  [1;30mÃº   [34mÃž[44mÂ³Ã[40m[s\r\n[u[44m[0;34mÃžÂ³Ã[37mÃº   [1;30mÃº [0;31mÂ³[5C[1;37mare moderately fast, [s\r\n[uwell armored and have hard[7H  [0;31mÂ³ [1;30mÃº  Ãº [34;44mÃÂ³Ã[40m[s\r\n[u[44m[0;34mÃžÂ³Ãž[6C[31mÂ³[5C[1;37mpoints  for  many different accessori[s\r\n[ues.   Many[8H  [0;31mÂ³[1;30mÃº    [34mÃž[44mÃ„Â´Ã[0;34mÃžÃƒÃ„Ã   [1;30m.[s\r\n[u[0mÃº[31mÂ³[5C[1;37mcartels use the Merchant Cruiser as  their only[9H[s\r\n[u  [0;31mÂ³    [1;34mÃž[44mÃŸÃšÂ´Ã[0;34mÃžÃƒÂ¿ÃŸÃ   [1;30m.[0;31mÂ³[5C[1;37m[s\r\n[uship type.   The Merchant is the craft by which[10H  [0;31mÂ³ [37mÃº  [s\r\n[u[1;34mÃž[44mÃ„ÃÃÃ[0;34mÃžÃÃÃ„Ã [1;30mÃº  [0;31mÂ³[5C[1;37mcombat specs a[s\r\n[ure rated for a standard.[11H  [0;31mÂ³[1;30mÃº   [34mÃžÃŸÃŸÃŸÃŸ[0;34mÃŸÃŸÃŸÃŸÃ [s\r\n[u [1;37mÃº [0;31mÂ³   [34mÃ„Ã„Ã„Ã„Ã„Ã„Ã„Ã„Ã„Ã„Ã„Ã„Ã„Ã„Ã„Ã„Ã„Ã„Ã„Ã„Ã„Ã„Ã„Ã„Ã„Ã„Ã„Ã„Ã„Ã„Ã„Ã„Ã„Ã„Ã„Ã„Ã„Ã„Ã„Ã„Ã„Ã„Ã„Ã„Ã„Ã„Ã„[s\r\n[uÃ„Ã„Ã„[12H  [31mÃƒÃ„Ã„Ã„Ã„Ã„Ã„Ã„Ã„Ã„Ã„Ã„Ã„Ã„Ã„Ã„Ã„Ã„Ã„Â´[13H  Â³  [1;30mÃº [34mÃœÃ›[44mÃŸÃŸ[40m[s\r\n[u[44m[37mÃŸ[0mÃŸ[34mÃŸÃŸÃ›Ãœ   [1;30mÃº[0;31mÂ³[14H  Â³[1;30mÃº   [34mÃŸ[s\r\n[u[30mÃº[5CÃº [0;34mÃŸ [1;30mÃº  [0;31mÂ³[15H  Ã€Ã„Ã„Ã„Ã„Ã„Ã„Ã„Ã„Ã„Ã„Ã„Ã„Ã„Ã„Ã„Ã„Ã„Ã„Ã™[0m\r\n","[40m[2J[6C[0;34m. Ã¹[7C. [36mÃ¹[35m.  [34mÃ¸ [1;30mJohn[s\r\n[u[0;34m.[1;30mDailey Software Presents   [0;34mÃ¸ [1m.[7C[0;34m.\r\n[2;1H[9CÃ¸[8C.[8C[36mÃ¹[22C[1;30m.[0;34mÃ¹  .[10C[1;30m..[0;34mÃ¹\r\n[3;1H[27C[37mÃœÃ›Â²Ã›Ãœ    ÃœÃ›ÃŸÃ›Ãœ    Ãœ[47m [40mÃ›[47m [40mÃœ[34mÃ¹.[7C. [s\r\n[u. [36mÃ¹[5C[1;34m.[0;34m. [36mÃ¹   [34mÃ¸ [1m.[4;1H[8C[0;34m.[s\r\n[u[6CÃ¹.[6C. [36mÃ¹[37mÃžÃ›ÃÂ±Ãž[1;33;47mÂ°[0mÃ  ÃžÃ›Ã[34m.[37mÂ²[s\r\n[u[1;33;47mÂ°[0mÃ  Ãž[47m [40mÃÂ²Ãž[1;33;47mÂ°[0mÃ[34mÃ¸[13C[1;37m+ [s\r\n[u   [30m.[0;34mÃ¹  .[5;1H[6C[1;30mÃŸ [0;34mÃ¹.ÃœÃœ[32mÃœ[1mÃœ[9C[s\r\n[u[0;34mÃ¸ .[37mÃ›[1;33;47mÂ°[1C[0mÂ°[34mÃ¹[37mÃ›Ã› [36mÃ¹[37mÃ›[s\r\n[u[1;33;47mÂ°[1C[0;34mÃ¸[37mÂ±Ã›Ã›  Ã›[1;33;47mÂ°[1C[0mÂ± Ã›Ã›[18C[34m.[s\r\n[u[36mÃ¹    [1;37mÃœÃœÃœÃœ[6;1H   [0;34m. Ã¹. Ãœ[1;44mÃŸ[37mÂ°Â±[42mÂ±[40m[s\r\n[u[42mÂ°[32;43mÂ±[40mÃœ[0;35m.  [34mÃ¸[6C[37mÃ›Ã›   [1;33;47mÂ°[40m[s\r\n[u[0mÃ› [34m.[37mÃ›Ã› [34m.[37mÂ°[1;33;47mÂ°[0mÃ›  Ã›Ã› Â° [s\r\n[u[1;33;47mÂ°[0mÃ›    [34m. Ã¹.[9C.[32mÃœÃœÃœ[1;42mÃ›Ã›Â°[37mÂ±Â²[40mÃ›Ã›\r\n[7;1H[6C[0;34mÃ¸[1;44mÂ°[37;42mÂ±[34;44mÂ²[37mÂ±Â°[32mÃ›[43mÂ²[40m[s\r\n[u[42mÂ²Â±[34;44mÂ±[9C[33;47mÂ°[0mÃ› Â° ÃŸ[1;33mÃœ  [47mÂ°[0mÃ›   ÃŸ[s\r\n[u[1;33mÃœ  [47mÂ°[0mÃ› [1;30m.[0;34mÃ¹[37mÃŸ[1;33mÃœ   [0;36mÃ¹[35m.[s\r\n[u  [34mÃ¸[7C[32mÃœÃœÃ›[33;42mÂ°Â²Â±Â° Â°[1;37mÂ°Â±Â²Â²[8;1H[6C[0;34mÃž[s\r\n[u[32;44mÃŸ[1;43mÂ°[37;42mÂ°[32mÂ±[34;44mÂ±Â°[37mÂ²[42mÂ±[34;44mÂ±Â°[40m[s\r\n[u[9C[0mÃŸ[1;33mÃœ   Ã›[43mÂ²[2C[0mÃŸ[1;33mÃœ[0;34mÃ¹ [37mÂ°[1;33mÃ›[s\r\n[u[43mÂ²[2C[0mÃŸ[1;33mÃœ [0mÂ° [1;33mÃ›[43mÂ²[3C[0;34m.   .    Ãœ[s\r\n[u[1;32;42mÃ›Ã›Â²Â±[0;33;42mÂ°Â± [1;37mÂ°[32mÂ°Â±[0;33;42mÂ²Â±Â°[1;37mÂ±Â±[40m\r\n[9;1H[5C[0;34m. [1;44mÂ°[37;42mÂ±Â²[47mÂ±[32;44mÃŸ[37mÂ°Â±Â²[32mÃœ[40m[s\r\n[u[34;40mÃ›[9C[33mÃ›[43mÂ²[1C[0mÂ°[33mÃž[1;43mÂ±[40mÃ  Ã›[43mÂ²[40m[s\r\n[u[0;34m. Ã¹[1;33mÃŸ   Ã›[43mÂ²[1C[0mÂ°[33mÃž[1;43mÂ±[40mÃ[10C[0;34m[s\r\n[uÃœ[1;44mÂ°Â±Â°[32mÃŸ[0;33;42mÂ²Â±[1;37mÂ°Â±Â²Â²Â²Â±Â²[0;33;42mÂ°[1;32mÂ²[40m[s\r\n[u[42m[37mÂ°Â°[10;1H[5C[0;34mÃ¹. ÃŸ[1;44mÃ›[37;47mÂ°[44mÂ°[32mÃœ[40m[s\r\n[u[43mÂ²[42mÂ±[0;32mÃŸ  [34mÃ¸[7C[1;33;43mÂ²Â±[0;33mÃžÃœ[1;43mÂ°[40m[s\r\n[u[40mÃŸ   [43mÂ²Â±[0;35m. [37mÂ°[34mÃ¸   [1;33;43mÂ²Â±[0;33mÃžÃœ[s\r\n[u[1;43mÂ°[40mÃŸ[9C[0;34mÃœ[1;44mÂ°Â°  Â±[37mÂ°Â±[42mÂ±Â²Â²Â±Â²Â±Â°  [32m[40m[s\r\n[u[42mÂ°Â°[37mÂ°[11;1H[10C[0;34mÃŸ[1;32mÃŸ[0;32mÃŸÃŸ   [34m.[8C[s\r\n[u[1;33;43mÂ±Â°[1C[0mÂ°[33mÃŸÃœ   [1;43mÂ±Â°[7CÂ±Â°[3C[0;33mÃœ[s\r\n[u[1;43mÂ°[7C[0;34mÃœ[44m [1;32;42mÂ°[44mÃŸ[34mÂ°[37mÂ°Â±Â²Â±Â±Â²Â±[40m[s\r\n[u[42mÂ²Â²Â²[0;33;42mÂ²Â±Â° [1;32mÂ°[0;33;42mÂ°[12;1H[8C[34;40m. Ã¹.[5C.[s\r\n[u[6CÃ¸ [1;33;43mÂ°[0;33mÃ›  [34m.[1;33;43mÂ°[0;33mÂ²[34m. [s\r\n[u[1;33;43mÂ°[0;33mÃ›  [37mÂ°   [34m.[1;33;43mÂ°[0;33mÃ› [37mÂ° [s\r\n[u[1;33;43mÂ°[0;33mÃ›[1;34m.[0;34m. [36mÃ¹  [34mÃœ[1;44mÂ° Â°[40m[s\r\n[u[44m[32mÃœ[37;42mÂ²Â±[44mÂ²Â±Â²Â±Â²[34mÂ°[32mÃž[0;33;42mÂ±Â°Â°Â±[1;32m[40m[s\r\n[u[42mÂ°   [13;1H[7C[0;34m.   Ã¸[6C. .[5C[33mÃžÂ²Ã[37mÃ¾[33mÃžÂ²Â± Ã¾Ã›Ã›[s\r\n[uÃœ [34mÃ¹    [33mÃžÃ›Ã[37mÃ¾[33mÃžÂ²Ã [1;30m.[0;34mÃ¹  .[1;44mÂ±Â° [40m[s\r\n[u[44m Â°[37;42mÂ²Â°[32mÂ±[34;44mÂ°[32mÃŸ[34mÂ°  [0;33;42mÂ²Â±Â°Â²Â°[40m[s\r\n[u[42m[1;32mÂ°Â°[34;44mÂ°[42m [14;1H[27C[0;33mÂ±Ã›ÃœÂ²Â±Â°  Ã›ÃŸ  .988 ÃœÃŸÃ›Ãœ[s\r\n[uÃ›Â± [34m.[36mÃ¹ [34m. [1;32;44mÃ[34mÂ²Â±    Â°Â° Â± Â°Â°Â°[0;33;42mÂ²[40m[s\r\n[u[42m[1;32mÂ²[0;33;42mÂ°[1;32mÂ°Â°[34;44mÂ° [32mÃž[15;1H[10C[40m[s\r\n[u[0;34m.   .[5C. Ã¹   [36mÃ¹[33mÂ°Ã¾Â°Â±Â°[36mÃ¹[35m. [33mÂ²[34m.[33mÃ¾[s\r\n[u[34mÃ¹[37mÃ¾    [34mÃ¹[33mÃ¾ Â² Â° [36mÃ¹   [34mÃ¸[1;32;42mÂ²[40m[s\r\n[u[34;44mÂ²Â±Â°Â°  Â°Â±Â²[32mÃœ[0;33;42mÂ°Â°[1;32mÂ°Â°[34;44mÂ°[32mÃŸ[40m[s\r\n[u[0;33;42mÂ²[1;32mÂ±[34;44mÂ°  Â°[16;1H[1C[0;34mÃ¹[9C.[5CÃ¸[5CÃ¸Ã¸ . [s\r\n[u  [33mÂ° [34mÃ¹  [33mÂ±   [34mÃ¸ [36mÃ¹[35m.  [34mÃ¸ [33mÂ±[8C[s\r\n[u[1;32;42mÂ±Â²[44mÃœ[34mÂ° Â°[37mÂ°Â±Â²[32mÃž[42m [0;33;42mÂ±Â²Â±Â°Â°[40m[s\r\n[u[42m[1;32mÂ° Â±Â²[34;44mÂ°Â°Â±[17;1H[11C[5;30;40mÂ³[23C[0;33mÂ°[11CÂ°[s\r\n[u  Ã¾[5C[32mÃŸ[1;42mÂ°Â²[44mÃœ[34mÂ°Â±Â°[37mÂ²Â±[34mÂ±[32;42mÂ°[40m[s\r\n[u[0;33;42mÂ°Â±Â°Â°Â°[1;37mÂ°Â±Â±Â°[32mÂ²[44mÃœ[34mÂ°[18;1H[3C[0;34m. Ã¹.   [s\r\n[u [5;37mÂ³[6C[0;36mÃ¹[5C[1;34m.[0;34m. [36mÃ¹   [34mÃ¸ [1m.[7C[s\r\n[u[0;34m.[15C[33;42mÂ°Â²[1;32mÂ²[44mÃœ[37mÂ°Â±Â²Â²Â²Â±[42mÂ°[32mÂ±[40m[s\r\n[u[0;33;42mÂ±[1;32mÂ²[37mÂ±Â²Â²Â²Â±Â°[32mÂ²[0;33;42mÂ²[19;1H[1C[40m[s\r\n[u[36;40mÃ¹Ã¹[35m. [34mÃ¸Ã¸[1m. [5;30mÃ„[0;5mÃ„[0;1mÃ…[0;5mÃ„[1;30mÃ„  [s\r\n[u[0;34mÃ¹.    Ã¹    [33mb a r r e[34m.[33mn  r e a[34m.[33ml[36mÃ¹[s\r\n[u[33mm s[34mÃ¸[5C.[33;42mÂ°Â±[1;32mÂ²Â²[34;44mÂ² Â°Â±Â²[32mÃž[40m[s\r\n[u[0;33;42mÂ°[1;32mÂ°[0;33;42mÂ°[1;37mÂ°Â±Â²Â°Â±[32mÂ±Â²[0;33;42mÂ±[40m\r\n[20;1H  [34m..[7C[5;37mÂ³  [0;1;30m. [0;34mÃ¹[7C.[36mÃ¹ [33me    l[s\r\n[u[5Ci [34m.   [33mt  [34m.  [33me[8C[42m Â±[1;32mÂ²[44mÃ[40m[s\r\n[u[44m[34mÂ²[37mÂ° Â°[34mÂ²[42m [0;33;42mÂ°[1;32mÂ°[0;33;42mÂ±[40m[s\r\n[u[42m[1;32mÂ±Â° [0;33;42mÂ±[1;32mÂ±[0;33;42mÂ±Â°[21;1H[1C[40m[s\r\n[u[34;40m.[9C[1;5;30mÂ³   [0;36mÃ¹[20C[34mÃ¸[19C.   [32mÃŸ[s\r\n[u[1;44mÃŸ[34mÂ°[37mÂ°Â±Â°[34mÂ°Â±Â²[42m [32mÂ²Â°Â°Â±[0;33;42mÂ°Â°Â±Â²[40m[s\r\n[u[1;34;44mÂ°[22;1H[6C[30;40mCopyright (c) 1999 John Dailey   Origin[s\r\n[ual game design by Mehul Patel[0m\r\n","[2J[30C[0;33mÃœÃœÃœÃ›Ã›Ã›Ã›Ã›Ã›Ãœ[16CÃœÃœ ÃœÃ›Ãœ\r\n[12CÃœÃœÃœ[6CÃœÃ›Ã›Ã›Ã›Ã›Ã›ÃŸÃŸÃŸ[6CÃŸÃ›Ã›Ã›Ã›ÃŸÃ›ÃœÃœ   ÃœÃ›Ã›Ã›Ã›ÃŸÃŸÃŸÃŸ ÃŸÃ›Ãœ\r\n[10CÃœÃ›ÃŸÃŸÃŸÃ›Ã›Ã›Ã›Ã›Ã›ÃŸ[22CÃŸÃŸÃ›Ã›Ã›ÃŸ[11CÃŸÃ›Ãœ\r\n[9CÃžÃ› ÃŸÃœ[49CÃ›Ã\r\n[9CÃ›Ã   Ã›[6C[32mÃœÃœÃ›Ã›Ã›Ã›Ã›Ãœ[6C[1;37mSOMETHING WONDEFUL HAPPENS![C[0;33mÃžÃ›[5CÃœÃŸÃŸÃœÃœ\r\n[9CÃžÃ› ÃœÃŸ    Ãœ[32mÃœÃŸÃŸÃŸ[1mÃœÃœÃœÃœ[0;32mÃŸÃ›Ã›Ãœ    [1m-=-=-=-=-=-=-=-=-=-=-=-=-=-[2C[0;33mÃ›Ã  ÃœÃŸ[5CÃŸÃœ\r\n[8CÃœÃŸÃ Ã›  ÃœÃŸÃŸ  [1;32mÃŸÃ›Ã›Ã›Ã›Ã›Ã›Ã›Ãœ[0;32mÃŸÃ›Ã›[31C[33mÃžÃ›ÃŸÃœÃŸ[9CÃ\r\n[6CÃœÃŸ ÃžÃ›  ÃŸÃŸ[7C[1;32mÃŸÃŸÃŸÃ›Ã›Ã›Ã›Ã›Ãœ[0;32mÃŸÃ[30C[33mÃ›Ã  Ã›[8CÃž\r\n   ÃœÃŸÃœÃ›   Ã›Ã[16C[1;32mÃŸÃŸÃŸÃŸÃ›[30C[0;33mÃžÃ›   ÃŸÃœ[6CÃ\r\n  Ã›    Ã›  ÃžÃ›  [1;31mL[0;31megend [1mO[0;31mf [1mT[0;31mhe [1mR[0;31med [1mD[0;31mragon[1m [32mVersion [37;44m4.00a[32;40m has been   [0;33mÃ›Ã    Ã›    [1;32mÃœ[0;32mÃž\r\n [1mÃœÃ›[0;32mÃžÃœ   [33mÃ› Ã›Ã  [1;32minstalled on this system.  Take this chance to [3C[0;33mÃžÃ›    ÃžÃ  [1;32mÃ›Ã›[0;32mÃžÃ›Ã›\r\n[A[79C[37m [1;32mÃžÃ›Ã›Ã[0;32mÃ›Ã› [33mÃ›  ÃžÃ›Ãœ [1;32mmeet [37mOlivia[32m, the severed head.                    [0;33mÃœÃ›Ã    Ã› [1;32mÃ›Ã›Ã›Ã[0;32mÃ›Ã›\r\n[A[79CÃ[1mÃ›Ã›Ã›Ã[0;32mÃ›Ã›Ã [33mÃ›[1;32mÃœÃœ[0;33mÃŸÃ›Ã[4C[1;32m       [36m   [30m    [7C[0;33mÃœÃœÃœ[4C[1;30m      [11C[0;33mÃžÃ›ÃŸ   ÃœÃŸ [1;32mÃžÃ›Ã›Ã›Ã›[0;32mÃž\r\n[1mÃžÃ›Ã›[0;32mÃžÃ›Ã› Ã›Ã›[1mÃžÃ›Ã›Ãœ   [0;32mÃœ[C[37mHonor[C[1;32m [11C[0;33mÃœÃŸÃŸ   ÃŸÃœ[3C[1;30mDeath[12C[0;33mÃ›Ã   Ã›   [1;32mÃŸÃ›Ã›Ã›[0;32mÃžÃ›\r\n[A[79CÃ [1mÃŸÃ›Ãœ[0;32mÃŸÃÃžÃ›Ã›Ã[1mÃ›Ã›Ã›Ã›ÃœÃŸ[0;32mÃ[C[1;30mMind[32m         [2C[0;33mÃœÃŸÃŸ[7CÃ›[3C[37mDespair[1;30m [8C[0;33mÃžÃ›[5CÃŸ[1;32mÃœ  ÃŸÃ›Ã[0;32mÃ›Ã›\r\n[A[79C[37m [32m    [1mÃŸ[0;32mÃŸ Ã›Ã›Ã›Ãœ[1mÃŸÃŸ[0;32mÃœÃœÃŸ[2C[37mLove[1;35m  [32m [35m [32m [2C[0;33mÃœÃœÃŸÃŸ[32mÃœÃœÃ›Ã›Ã›ÃŸ[1mÃœ [0;33mÃœÃŸ[4C[1;30mQuietus[2C[0m [6C[33mÃ›Ã    [32mÃœÃ›Ãœ[1mÃŸÃ›Ãœ Ã[0;32mÃ›\r\n[8CÃŸÃ›Ã›Ã›Ã›ÃŸ[4C[1;30mHope[32m [0;33mÃœÃœ  ÃœÃŸ  [32mÃœÃ›Ã›Ã›ÃŸ[1mÃœÃœÃ›Ã›ÃŸ[3C[0;34m   [37mThe Dragon[6C[33mÃžÃ›   [32mÃžÃ›Ã›Ã›Ã› [1mÃ›Ã [0;32mÃŸ\r\n[11C[33mÃ›Ã    ÃœÃœÃœÃœÃ›Ã›ÃŸÃŸÃ›Ã›Ãœ [32mÃœÃ›Ã›Ã›ÃŸ[1mÃœÃ›Ã›Ã›Ã›ÃŸ[7C[0m           [1;31m   [2C[0;33mÃ›Ã   [32mÃžÃ›Ã›Ã›Ã›[1mÃžÃ›Ã›\r\n[11C[0;33mÃžÃ› ÃœÃœÃ›ÃŸÃŸÃŸ[6CÃŸÃŸ[32mÃ›Ã›Ã›ÃŸ[1mÃœÃ›Ã›Ã›Ã›ÃŸ[0;33mÃ›Ã›Ã›Ã›Ã›Ãœ[5CÃœÃ›Ã›Ã›Ã›Ã›ÃœÃœ    ÃœÃ›ÃŸ[5C[32mÃŸÃ›Ã›Ã[1mÃ›Ã›Ã›Ã\r\n[12C[0;33mÃŸÃŸÃŸ[12C[32mÃžÃ›ÃŸ[1mÃœÃ›Ã›Ã›ÃŸ[0;33mÃ›ÃŸ[6CÃŸÃ›Ã›Ã›Ã›Ã›ÃŸ[6CÃŸÃ›ÃœÃœÃ›ÃŸ[8C[32mÃŸÃ›Ã›[1mÃžÃ›Ã›\r\n[28C[0;32mÃ›[1mÃžÃ›ÃŸ[26C[0;33mÃŸÃŸ[12C[32mÃŸ[1mÃ›ÃŸ\r\n[29CÃŸ\r\n[0m\r\n","[0m[1mÃšÃ„Â¿Ã„[0mÃ‚Ã„Ã¹[1;30mÃ„Ã¹ Ã¹  T h e   [0mI n t [1me l l e c t u[5;30mÃ¹[0ma l   W a s t e l [1;30ma n d   Ã¹  Ã¹Ã„[0mÃ„Ã‚[1mÃ„ÃšÃ„Â¿[0m\r\n[1mÃ€Ã„[0mÃ…Ã„Ã¹Ã„[1;30mÃ„[0mÃ„[1;30mÃ„Ã„Ã„Ã„Ã„Ã„Ã„Ã„Ã„Ã„Ã„Ã„Ã„Ã„Ã„Ã„Ã„Ã„Ã„Ã„Ã„Ã„Ã„Ã„Ã„Ã„Ã„Ã„Ã„Ã„Ã„Ã„Ã„Ã„Ã„Ã„Ã„Ã„Ã„Ã„Ã„Ã„Ã„Ã„Ã„Ã„Ã„Ã„Ã„Ã„Ã„Ã„Ã„Ã„Ã„Ã„Ã„Ã„Ã„Ã„Ã„Ã„Ã„Ã„Ã„[0mÃ„Ã„Ã…[1mÃ„Ã™[0m\r\nÃƒÃ„:[1;30mÃ„Ã™[0m[26C[34mM a [1mi n  M e [0;34mn u[37m[26C[1;30mÃš[0mÃ„Â³Ã„[1mÂ´[0m\r\n[1mÃšÃ„[0mÃ…Ã„Ã„[1;30mÃ„[0mÃ„[1;30mÃ„Ã„Ã„Ã„Ã„Ã„Ã„Ã„Ã„Ã„Ã„Ã„Ã„Ã„Ã„Ã„Ã„Ã„Ã„Ã„Ã„Ã„Ã„Ã„Ã„Ã„Ã„Ã„Ã„Ã„Ã„Ã„Ã„Ã„Ã„Ã„Ã„Ã„Ã„Ã„Ã„Ã„Ã„Ã„Ã„Ã„Ã„Ã„Ã„Ã„Ã„Ã„Ã„Ã„Ã„Ã„Ã„Ã„Ã„Ã„Ã„Ã„[0mÃ„[1;30mÃ„[0mÃ„Ã„Ã„Ã„[1mÃ…Ã„Â¿[0m\r\n[1mÃ€Ã„Ã™[0mÃ„Ã[1;30mÃ„Ã¹Ã¹[0m[21C[1;30mW [0mW i [1mV  v 4 . [0m2 4 [1;30ma[0m[16C[1;30mÃ¹ Ã¹Ã¹  Ã¹Ã„[0mÃÃ„Ã€[1mÃ„Ã™[0m\r\n[1m [47mÃ›Ã›Â²Â²Â±Â±Â±Â°Â°  [30mÂ°Â°Â±Â±Â²Â²[40mÃ›Ã›Â²Â²Â±Â±Â°Â° [37;47mÃ›Ã›Â²Â²Â±Â±Â°Â°  [30mÂ°Â°Â±Â±Â²Â²[40mÃ›Ã›Â²Â²Â±Â±Â°Â° [37;47mÃ›Ã›Â²Â²Â±Â±Â±Â°Â°  [30mÂ°Â°Â±Â±Â²Â²[40mÃ›Ã›Â²Â²Â±Â±Â°Â°[0m\r\n [1;47mÃ›    Messaging Menu[30m     [40mÂ° [37;47mÃ›Ã›Â²Â²Â±Â±Â°Â°  [30mÂ°Â°Â±Â±Â²Â²[40mÃ›Ã›Â²Â²Â±Â±Â°Â° [37;47mÃ›   Misc/System Menu [0;30;47m   [1;40mÂ°[0m\r\n[1;30m [37;47mÃ› Ã¹[0;34;47mÃ¹[1mA[0;34;47mÃ¹[1;37muto[30m-Message [0;30;47m      [1;40mÂ° [37;47mÃ›    E-Mail Options [30m   [40mÂ° [37;47mÃ› Ã¹[0;34;47mÃ¹[1mO[0;34;47mÃ¹[1;37mLog [30mOff          [0;30;47m [1;40mÂ°[0m\r\n[1;30m [37;47mÃ› Ã¹[0;34;47mÃ¹[1mS[0;34;47mÃ¹[1;37mcan[30m Message[0;30;47ms[1m      [40mÂ° [37;47mÃ› Ã¹[0;34;47mÃ¹[1mE[0;34;47mÃ¹[1;37m-m[30mail a Use[0;30;47mr     [1;40mÂ° [37;47mÃ› Ã¹[0;34;47mÃ¹[1mD[0;34;47mÃ¹[1;37mefa[30mults Sec[0;30;47mtion   [1;40mÂ°[0m\r\n[1;30m [37;47mÃ› Ã¹[0;34;47mÃ¹[1mP[0;34;47mÃ¹[1;37most [30ma Messa[0;30;47mge[1m     [40mÂ° [37;47mÃ› Ã¹[0;34;47mÃ¹[1mM[0;34;47mÃ¹[1;37mai[30mlbox Sca[0;30;47mn      [1;40mÂ° [37;47mÃ› Ã¹[0;34;47mÃ¹[1mL[0;34;47mÃ¹[1;37mast [30mCallers       [40mÂ°[0m\r\n[1;30m [37;47mÃ› Ã¹[0;34;47mÃ¹[1mQ[0;34;47mÃ¹[1;37muic[30mk Messag[0;30;47me Scan [1;40mÂ° [37;47mÃ› Ã¹[0;34;47mÃ¹[1mK[0;34;47mÃ¹[1;37mil[30ml E-Mail [0;30;47mSent  [1;40mÂ° [37;47mÃ› Ã¹[0;34;47mÃ¹[1mX[0;34;47mÃ¹[1;37mExp[30mert Mode       [40mÂ°[0m\r\n[1;30m [37;47mÃ› Ã¹[0;34;47mÃ¹[1mH[0;34;47mÃ¹[1;37mop [30mTo Anoth[0;30;47mer Sub[1m [40mÂ° [37;47mÃ›                     [0;30;47m [1;40mÂ° [37;47mÃ› Ã¹[0;34;47mÃ¹[1mW[0;34;47mÃ¹[1;37mWIV [30mSlash M[0;30;47menu    [1;40mÂ°[0m\r\n[1;30m [37;47mÃ› Ã¹[0;34;47mÃ¹[1mN[0;34;47mÃ¹[1;37mew [30mMessage [0;30;47mScan   [1;40mÂ° [37;47mÃ›  More Messaging Opts[0;30;47m [1;40mÂ° [37;47mÃ›                       [30;40mÂ°[0m\r\n[1;30m [37;47mÃ› Ã¹[0;34;47mÃ¹[1mR[0;34;47mÃ¹[1;37memo[30mve a Mes[0;30;47msage   [1;40mÂ° [37;47mÃ› Ã¹[0;34;47mÃ¹[1m*[0;34;47mÃ¹[1;37mLi[30mst Subs [0;30;47mAvail. [1;40mÂ° [37;47mÃ›         Games       [0;30;47m  [1;40mÂ°[0m\r\n[1;30m [37;47mÃ› Ã¹[0;34;47mÃ¹[1mZ[0;34;47mÃ¹[1;37mExp[30mress N-S[0;30;47mcan    [1;40mÂ° [37;47mÃ› Ã¹[0;34;47mÃ¹[1m+[0;30;47m/[1;34m-[0;34;47mÃ¹[1;30mMove in [0;30;47mSubs   [1;40mÂ° [37;47mÃ› Ã¹[0;34;47mÃ¹[1m.[0;34;47mÃ¹[1;37mOn-[30mLine Doo[0;30;47mrs     [1;40mÂ°[0m\r\n[1;30m [37;47mÃ› Ã¹[0;34;47mÃ¹[1mF[0;34;47mÃ¹[1;37meed[30mback to [0;30;47mSysop  [1;40mÂ° [37;47mÃ› Ã¹[0;34;47mÃ¹[1m][0;30;47m/[1;34m[[0;34;47mÃ¹[1;30mMove in [0;30;47mConfs  [1;40mÂ° [37;47mÃ› Ã¹[0;34;47mÃ¹[1mG[0;34;47mÃ¹[1;37mSco[30mres Etc        [40mÂ°[0m\r\n[1;30m [37;47mÃ›Ã›Â²Â²Â±Â±Â±Â°Â°  [30mÂ°Â°Â±Â±Â²Â²[40mÃ›Ã›Â²Â²Â±Â±Â°Â° [37;47mÃ›                      [30;40mÂ° [37;47mÃ›Ã›Â²Â²Â±Â±Â±Â°Â°  [30mÂ°Â°Â±Â±Â²Â²[40mÃ›Ã›Â²Â²Â±Â±Â°Â°[0m\r\n[1;30m [37mÃ›[47mÃ›Â²Â²Â±Â±Â±Â°Â°  [30mÂ°Â°Â±Â±Â²Â²[40mÃ›Ã›Â²Â²Â±Â±Â°Â° [37;47mÃ›Ã›Â²Â²Â±Â±Â°Â°  [30mÂ°Â°Â±Â±Â²Â²[40mÃ›Ã›Â²Â²Â±Â±Â°Â° [37;47mÃ›Ã›Â²Â²Â±Â±Â±Â°Â°  [30mÂ°Â°Â±Â±Â²Â²[40mÃ›Ã›Â²Â²Â±Â±Â°Â°[0m\r\n",'[1C[0;34mÃ„Ã„Ã„Ã„Ã„Ã„Ã„Ã„Ã„Ã„Ã„Ã„Ã„Ã„Ã„Ã„Ã„Ã„Ã„Ã„Ã„Ã„Ã„Ã„Ã„Ã„Ã„Ã„Ã„Ã„Ã„Ã„  [1;31mClass M [0;32mplanets have a thick Oxygen/Nitrogen\r\n  [34mÃ„Ã„Ã„Ã„Ã„Ã„Ã„Ã„Ã„Ã„Ã„Ã„Ã„Ã„Ã„Ã„Ã„Ã„Ã„Ã„Ã„Ã„Ã„Ã„Ã„Ã„Ã„Ã„Ã„Ã„   [32matmosphere.  Specific gravity  within 0.7 to\r\n[1;30mÃšÃ„Ã„Ã„Ã„Ã„Ã„Ã„Ã„Ã„Ã„Ã„Ã„Ã„Ã„Ã„Ã„Ã„Ã„Ã„Ã„Ã„Ã„Ã„Ã„Ã„Ã„Ã„Ã„Ã„Ã„Ã„Ã„Â¿ [0;32m1.3   Earth  normal.   Random,  but   mostly\r\n[1;30mÂ³   Ãº   [0mÃº[7C.[5C[1mÃº    [30mÃº[5CÂ³ [0;32mmanageable weather  current  patterns,  with\r\n[1;30mÂ³ [37mÃº[9C[30mÃº [0;34mÃœÃœÃœÃœÃœ[12C[1;30mÃº Â³ [0;32mtemperatures  ranging  from  0 to 40 degrees\r\n[1;30mÂ³[9CÃº [0;34mÃœ[44m [1mÃ¾ ÃŸÃœÃœÃŸ[0;34mÃœ[6C[1;30mÃº[5CÂ³ [0;32mCelsius. Fertile soil, excellent for Organic\r\n[1;30mÂ³    Ãº[5C[44m [34mÃœÃ       ÃŸ[30;40mÃº[6C[37mÃº   [30mÂ³ [0;32mproduction.  Mineral deposits, very good for\r\n[1;30mÂ³[5C[0mÃº   [34mÃž[1;44mÃŸÃ›Ãœ  ÃŸ Ã¾ÃŸÃ› [0;34mÃ[9C[1;30mÃºÂ³ [0;32mEquipment production. Chemical elements good\r\n[1;30mÂ³Ãº[7CÃº [44m  [34mÃŸÃ›ÃŸÃ¾   Ãœ[40mÃ›   [0mÃº[7C[1;30mÂ³ [0;32mfor Fuel Ore.  Class M planets are excellent\r\n[1;30mÂ³   Ãº[7C[0;34mÃŸ[44m  [1mÃœ Ã¾ [40mÃ›ÃŸ[7C[30mÃº    Â³ [0;32mfor  humanoid  colonization  and  promote an\r\n[1;30mÂ³    [0mÃº[7C[1;30m.[0;34mÃŸÃŸÃŸÃŸÃŸ    [1;30mÃº[5CÃº   Â³ [0;32mexcellent population growth curve as well as\r\n[1;30mÂ³ Ãº[6C[37mÃº[6C[30mÃº[7C[0mÃº[6C[1mÃº[30m.Â³ [0;32ma very  good  population  harmony  quotient.\r\n[1;30mÃ€Ã„Ã„Ã„Ã„Ã„Ã„Ã„Ã„Ã„Ã„Ã„Ã„Ã„Ã„Ã„Ã„Ã„Ã„Ã„Ã„Ã„Ã„Ã„Ã„Ã„Ã„Ã„Ã„Ã„Ã„Ã„Ã„Ã™ [0;32mThey  have  an above  average  "habitability\r\n  [34mÃ„Ã„Ã„Ã„Ã„Ã„Ã„Ã„Ã„Ã„Ã„Ã„Ã„Ã„Ã„Ã„Ã„Ã„Ã„Ã„Ã„Ã„Ã„Ã„Ã„Ã„Ã„Ã„Ã„Ã„   [32mband".    Drawbacks  include  overpopulation\r\n [34mÃ„Ã„Ã„Ã„Ã„Ã„Ã„Ã„Ã„Ã„Ã„Ã„Ã„Ã„Ã„Ã„Ã„Ã„Ã„Ã„Ã„Ã„Ã„Ã„Ã„Ã„Ã„Ã„Ã„Ã„Ã„Ã„  [32mproblems, political unrest and human-induced\r\n[35Cdestruction of the BioSphere.[0m\r\n',"[?7h[40m[2J[8C[0;1;30mÃœ[47mÃŸ[37mÃœÃŸÃŸ[0mÃ›Ã›Ã›Ã›[1;30;47mÃœÃœÃœ[40mÃŸ[37mÃžÃ› [0;33mÃœÃ› ÃŸÃ›Ã›Ã›Ã›Ã›Ã›Ã›ÃŸ [1;30mÃ›[47mÃœ[0mÃ›Ã›Ã›Ã›Ã›Ã›Ã›Ã›Ã›[1;30;47mÃŸÃŸÃŸ[40mÃ›Ãœ\r\n[8C[47mÃ[37mÃŸ[0mÃ›Ã›[1;30;47mÃœÃœ[40mÃŸÃŸÃŸ    [37mÃ›Ã›Ã [0;33mÃ›Ã›ÃœÃœÃœÃœÃœÃœ [37mÃœÃ›  [1;30mÃŸÃŸÃŸÃŸÃŸÃŸÃŸÃŸÃŸÃŸÃŸÃŸÃŸÃŸ\r\n[7CÃž[47mÃœÃœ[40mÃŸÃŸ[0;34mÂ°Â°Â°Â°Â±Â²Â°Â° [37mÃ›Ã›[1mÃ›Ã›[47mÃ›[40mÃ›Ã›Ã›[0mÃ›Ã›Ã›Ã›Ã›Ã›Ã› [34mÂ°Â°Â°Â°Â°Â°Â°Â°Â±Ã\r\n[10CÂ°Â°Â²Ã›Â°Â°Â±Â²Â±Â°[37mÃžÃ›Ã›[47m  [40mÃ›[47m [1mÃœ[0mÃ›ÃŸÃ›Ã›Ã›Ã›[1;47mÃžÃ[0mÃ[34mÂ°Â°Â±Â±Â±Â±Â±Â±Â²Ã\r\n[10CÂ±Â²Ã›Ã›Â±Â²Â²Â±Â° [37mÃ›Ã›Ã›[1;47mÃŸÃŸÃŸÃŸ[0mÃ›Ã›[1;30mÂ²[0mÃ›[1;47mÃŸÃŸÃŸÃŸ[0mÃ›Ã›[34mÂ°Â±Â²Â²Â²Â²Â²Ã›Ã›\r\n[10CÂ°Â±Â°Ã›Â²Â²Â±Â± [1;30mÂ²Â²Â²Â²Â²Â²Â²Â²Â²Â²Â²Â²Â²Â²Â²Â²Â²  [0;34mÂ²Â²Ã›Ã›Ã›Ã›Ã›Ã\r\n[11CÂ°Â±Â²ÃœÃœÃœÂ±Â± [1;30mÂ°Â°Â°Â°Â°Â°Â°Â°Â°Â°Â°Â°Â°Â°Â°  [0;34mÃœÃœÃœÃœ ÃŸÃ›Â±\r\n[12CÂ°Â±Ã›Ã›Ã›Ã›Â²Â²Ã›Ã›ÃœÃœ [1;30mÂ°Â°Â°Â±Â±Â±Â±Â±Â±Â± [0;34mÃ›Ã›Ã›Ã›Ã›Ã›Â²Â²Â²\r\n[13CÂ°Â²Â²Â²Ã›Ã›Ã›Ã›Â²Â²Ã›ÃŸ[37mÃœÃŸÃŸ [1;30mÂ±Â±Â±Â±Â±[47mÂ°Â°[0mÃœ[34mÃ›Ã›Ã›Â²Â²Â²Â°\r\n[14CÂ°Â°Â°Â°Ã›Ã›Ã›Â±Ã›Ã›[37mÃžÃÃ›[1;30;47mÂ°Â°Â°Â°[1CÂ°Â°Â°Â°Â°Â°[0;34mÃžÃ›Â²Â±Â°[7C[37mÃ›\r\n[16C[34mÃŸÃŸÂ°Â°Â°Â°Ã›Ã[37mÃÃ›[1;30;47mÂ±Â±Â±[1CÂ°Â±Â±Â±Â²Â²[1CÂ°[0mÃ[34mÂ²Â±Â°[8C[37mÃ›\r\n[20C[34mÃŸÂ°Â²Ã[37mÃÃ›[1;30;47mÂ±Â±[40mÃ[47mÂ±Â±[43mÂ°Â±Â°Â°[47mÂ²Â²[0mÃžÃ[34mÂ²Â°[7C[37mÂ±Â²Ã›\r\n  [1;31m\"[37mThere's[13C[0;34mÃŸ[37mÃž [1;30;47mÂ²Â²[40mÃ[47mÂ±Â±[43mÂ°Â±Â²Â°Â±Â²Â°[10C[0mÂ±Â²Ã›\r\n[5C[1mnothin' like[9C[30;47mÂ²Â²[40mÃ[47mÂ²Â²Â²[43mÂ±Â°Â±Â²Â°Â²Â±Â°Â²[6C[0mÂ±Â²Ã›Ã\r\n[7C[1mmetal on bone[8C[30mÃŸÃœ[47mÂ²Â²Â²[43mÂ°Â²Â²Â²Â±Â²Â°Â²Â²Â°Â±[0mÃœÂ±Â±Â²Â²Ã›Ã\r\n[9C[1mto fulfill the[12C[0;33mÃŸÃŸ[1;30;43mÂ²Â²Â²Â±Â²Â°[0mÃžÂ±Â±Â±Â²Ã›Ã›Ã[5C[31mÃœ ÃŸ\r\n[10C[1;37mbloodlust!![31m\"[17C[30;43mÂ²Â²Â±Â²Â±[0mÃ›Â±Â²Â²Ã›[41mÃž[3C[31;40mÃœÃ›[30;41m/[31;40mÃœ\r\n[41C[1;30;43mÂ²Â²[0mÃ›Â±Â²Â²Ã›[41mÃ[2C[31;40mÃœÃ›Ã›[1;37;41mÃŸ[31mÃ›[0;31mÃ›Ã\r\n[37CÃœÃœ .Ã¾  [37mÂ±Â²Â²[41mÃ[40mÃ [31mÃ›ÃŸ ÃŸÃ›Ã›ÃŸ\r\n    [1mCONTRATULATIONS on another[6C[0;31mÃž[1;37;41mÃŸ[0;31mÃ›Ã›Ãœ ÃŸÃœ[1;30;47mÂ²[0mÂ²Ã›[41mÃ[1C[31;40mÃžÃœÃ›Ãœ. .\r\n[14C[1;33mV I C T O R Y [31m!!![6C[0;31mÃŸÃŸ ÃŸÃ›Ãœ[37mÂ°[1;30;47mÂ²Ã[0;43mÃŸ[33;40mÃ›[31mÃœÃ›[33mÃœ [31mÃŸ .\r\n[35C[33mÃœÃœÃœÃ›Ã›Ã›Ã›Ã›Ã›[31;43mÃž[1mÃŸ[0;31;43mÃ›[1mÃŸÃŸ[0;33mÃ›Ã›Ã›Ã›Ãœ\r\n[32CÃ›Ã›Ã›Ã›Ã›Ã›Ã›[30;47m=[1;31;40mÃ [0;30;47m=[43m/[31mÃ[33;40mÃ›[31;43mÃ[1;37;42mÃŸ[0;30;43mÃž[33;40mÃ›Ã›Ã›Ã›Ã›Ã›[0m[255D","[?7h[40m[2J[0;30;44mÃ›Ã›ÃŸÃŸ                                                                        ÃŸÃŸÃ›Ã›[2;1HÃ›                                                                              Ã›[3;1HÃ                                                                              Ãž[4;1H                                                                                [5;1H                    ÃœÃ›Ã›Ã›Ã›Ã›Ã›Ã›Ã›Ã›Ã›Ã›Ã›Ã›Ã›Ã›Ã›Ãœ Ã›Ã›Ã›Ãœ           ÃœÃ›Ã›Ãœ                      [6;1H                    ÃŸÃ›Ã›Ã›ÃŸÃ›Ã›Ã›Ã›Ã›Ã›ÃŸ ÃŸÃ›Ã›Ã›ÃŸÃžÃ›Ã›Ã›Ã›           Ã›Ã›Ã›Ã›                      [7;1H                         ÃžÃ›Ã›Ã›Ã›Ã›        Ã›Ã›Ã›Ã›Ã         ÃžÃ›Ã›Ã›Ã›                      [8;1H                          Ã›Ã›Ã›Ã›Ã›Ã       ÃžÃ›Ã›Ã›Ã›   ÃœÃ›Ãœ   Ã›Ã›Ã›Ã›Ã                      [9;1H                          ÃžÃ›Ã›Ã›Ã›Ã›        Ã›Ã›Ã›Ã›  ÃžÃ›Ã›Ã›Ã  Ã›Ã›Ã›Ã›                       [10;1H                           Ã›Ã›Ã›Ã›Ã›        Ã›Ã›Ã›Ã›ÃÃœÃ›Ã›Ã›Ã›Ã›ÃœÃžÃ›Ã›Ã›Ã                       [11;1H                           ÃžÃ›Ã›Ã›Ã›        ÃžÃ›Ã›Ã›Ã›Ã›Ã›Ã›Ã›Ã›Ã›Ã›Ã›Ã›Ã›Ã›                        [12;1H                           ÃžÃ›Ã›Ã›Ã›Ã        Ã›Ã›Ã›Ã›Ã›Ã›Ã›ÃŸÃ›Ã›Ã›Ã›Ã›Ã›Ã›                        [13;1H                    ÃœÃ›Ã›Ã›ÃœÃœÃ›Ã›Ã›Ã›Ã›Ã›Ã›ÃœÃœÃ›Ã›Ãœ   Ã›Ã›Ã›Ã›Ã›ÃŸ   ÃŸÃ›Ã›Ã›Ã›Ã›                        [14;1H                    ÃŸÃ›Ã›Ã›Ã›Ã›Ã›Ã›Ã›Ã›Ã›Ã›Ã›Ã›Ã›Ã›Ã›ÃŸ   ÃŸÃ›Ã›Ã›ÃŸ      ÃŸÃ›Ã›Ã                        [15;1H            ÃšÃÃ                                                 ÃÃÂ¿             [16;1H            Â³ Ãº t h e Â‹ n t e l l e c t u a l w a s t e l a n d Ãº Â³             [17;1H            Ã€ÃÃ                                                 ÃÃÃ™             [18;1H                                                                                [19;1H                                                                                [20;1H                                                                                [21;1HÃ                                                                               [22;1HÃ›                                                                              Ãž[23;1HÃ›Ã›ÃœÃœ                                                                        ÃœÃœÃ›Ã›[0m\r\n","[40m[2J[3C[0;1;35mTholian Sentinel[2H [0;31mÃšÃ„Ã„Ã„Ã„Ã„Ã„Ã„Ã„Ã„Ã„Ã„Ã„Ã„Ã„Ã„Ã„Ã„Ã„Â¿[21C[s\r\n[u[1;37mShip Category [0m# [1m14[3H [0;31mÂ³[1;30mÃº   [0mÃº   [34mÃœ  [s\r\n[u [37mÃº    [1;30mÃº[0;31mÂ³ [34mÃ„Ã„Ã„Ã„Ã„Ã„Ã„Ã„Ã„Ã„Ã„Ã„Ã„Ã„Ã„Ã„Ã„Ã„Ã„Ã„Ã„Ã„Ã„Ã„Ã„Ã„Ã„Ã„Ã„Ã„Ã„Ã„Ã„Ã„Ã„Ã„Ã„Ã„Ã„Ã„[s\r\n[uÃ„Ã„Ã„Ã„Ã„Ã„Ã„Ã„Ã„Ã„Ã„Ã„Ã„Ã„Ã„Ã„[4H [31mÂ³ [1;37mÃº[5C[34mÃ›[37;44mÃ¾[0mÃ¾[34mÃ›    [s\r\n[u[37mÃº  [31mÂ³  [1;37mYoung corporations in need of planetary defense sh[s\r\n[uould[5H [0;31mÂ³   [1;30mÃº   [34mÃž[44m [1C[0;34mÃ[5C[37m. [31mÂ³ [s\r\n[u [1;37mconsider the [35mSentinel[37m.   With its new planetary combat\r\n[6H [0;31mÂ³[5C[37mÃº [1;34mÃž[35;44mÂ³[0;35mÂ³[34mÃ  [37mÃº    [31mÂ³  [s\r\n[u[1;37mguidance system, this ship's normal combat odds of 1:1[7H [0;31m[s\r\n[uÂ³ [1;30mÃº[5C[34mÃž[35;44mÂ³[0;35mÂ³[34mÃ[37mÃº   [1;30mÃº  [0;31mÂ³  [s\r\n[u[1;37mshoot  up  to  4:1  when defending a corporate planet.[8H [0;31m[s\r\n[uÂ³  [1;30m.[0mÃº  [1;30mÃº[34mÃ›[35;44mÂ³[0;35mÂ³[34mÃ›[7C[31mÂ³  [s\r\n[u[1;37mWhen  an  enemy  ship  enters  a  sector  containing a[9H [0;31m[s\r\n[uÂ³[5C[44m [1;34;40mÃ›Ã›[35;44mÂ³[0;35mÂ³[34mÃ›[44m [30mÂ°[37;40mÃº   Ãº[s\r\n[u[31mÂ³  [1;35mSentinel [37mset in defense  of  a  corporate  planet, th[s\r\n[ue[10H [0;31mÂ³    [1;34;44mÃ [40mÃ›Ã›[35;44mÂº[0;35mÂº[34mÃ›Ã›[s\r\n[u[30;44mÂ°[1;34mÃž[2C[30;40mÃº [0;31mÂ³  [1;37mhostile vessel must first[s\r\n[u destroy the [35mSentinel [37mand all[11H [0;31mÂ³[37mÃº [1;30mÃº [s\r\n[u[34;44mÃ[2C[40mÃŸ[37mÃŸ[0mÃŸ[34mÃŸ[1;30m. [34;44mÃž[1C[37;40mÃº  [s\r\n[u[0;31mÂ³  [1;37mof  its  fighters before  it  may land and attempt any\r\n[12H [0;31mÃƒÃ„Ã„Ã„Ã„Ã„Ã„Ã„Ã„Ã„Ã„Ã„Ã„Ã„Ã„Ã„Ã„Ã„Ã„Â´  [1;37maction toward the planet.   Rememb[s\r\n[uer: the [35mSentinel [37mwas[13H [0;31mÂ³  [1;30mÃº   [0mÃº[7C[1;30m[s\r\n[uÃº   [0;31mÂ³  [1;37mdesigned primarily for planetary defense,  if used f[s\r\n[uor[14H [0;31mÂ³[1;30mÃº.  [34;44mÃ[0;34mÃŸ[1mÃŸÃŸ[37;44mÃ¾[0mÃ¾[34mÃŸÃŸ [s\r\n[u[1;44mÃž[1C[30;40m. Ãº[0;31mÂ³  [1;37moffensive purposes its combat odd[s\r\n[us are 1:1.[15H [0;31mÃ€Ã„Ã„Ã„Ã„Ã„Ã„Ã„Ã„Ã„Ã„Ã„Ã„Ã„Ã„Ã„Ã„Ã„Ã„Ã™ [34mÃ„Ã„Ã„Ã„Ã„Ã„Ã„Ã„Ã„Ã„Ã„Ã„Ã„Ã„Ã„Ã„Ã„Ã„Ã„Ã„Ã„Ã„Ã„Ã„[s\r\n[uÃ„Ã„Ã„Ã„Ã„Ã„Ã„Ã„Ã„Ã„Ã„Ã„Ã„Ã„Ã„Ã„Ã„Ã„Ã„Ã„Ã„Ã„Ã„Ã„Ã„Ã„Ã„Ã„Ã„Ã„Ã„Ã„[0m\r\n","[?7h[40m[2J[13;41H[0;1;31mÃœ[2DÃ›[1A[0;35mÃ™[14;41H[1;31mÃ›[13;39HÃ›[1A[0;35mÃ„[14;40H[1;31mÃ›[3A[0;35mÂ³[15;41H[1;31mÃ›[13;38HÃœ[1A[0;35mÃ„[14;39H[1;31mÃ›[3A[0;35m [15;40H[1;31mÃ›[5A[0;35mÂ³[16;41H[1;31mÃ›[12;43H[0;35mÃ€[6DÃ„[14;38H[1;31mÃ›[3A[0;35mÃ™[15;39H[1;31mÃ›[5A[0;35m [16;40H[1;31mÃ›[7A[0;35mÂ³[17;41H[1;31mÃ›[11;43H[0;35mÂ³[BÃ„[B[1;31mÃœ[12;37H[0;35mÃ„[1AÃ„[15;38H[1;31mÃ›[5A[0;35mÂ³[16;39H[1;31mÃ›[7A[0;35m [17;40H[1;31mÃ›[9A[0;35mÂ³[18;41H[1;31mÃ›[1AÃ›[7A[0;35mÂ³[B [BÃ™[14;45H[1;31mÃ›[1AÃ›[12DÃœ[1A[0;35mÃ„[14;36H[1;31mÃ›[3A[0;35mÃ„[5B[1;31mÃ›[7A[0;35mÂ³[17;39H[1;31mÃ›[9A[0;35m [18;40H[1;31mÃ›[11A[0;35mÂ¿[11B[1;31mÃ›[9A[0;35mÂ³[17;43H[1;31mÃ›[7A[0;35m [BÂ³[15;45H[1;31mÃ›[1AÃ›[1AÃ›[14DÃ›[1A[0;35mÃ„[14;35H[1;31mÃ›[3A[0;35mÃ€[17;38H[1;31mÃ›[9A[0;35mÂ¿[18;39H[1;31mÃŸ[11A[0;35mÃ„[1A[31mÃ„[8;43H[35mÂ³[18;43H[1;31mÃ›[9A[0;35m [17;44H[1;31mÃ›[7A[0;35mÃš[16;45H[1;31mÃ›[1AÃ›[1AÃ›[1AÃœ[16DÃ›[1A[0;35mÃ€[14;34H[1;31mÃ›[3A[0;35m [1AÂ³[16;36H[1;31mÃœ[8;38H[0;35mÃ„[1AÃ„[1A[31mÃ€[1A [BÃ„[B[35mÃš[B [18;44H[1;31mÃ›[9A[0;35mÃ€[17;45H[1;31mÃ›[7A[0;35mÃ„[16;46H[1;31mÃ›[1AÃ›[1AÃ›[13;32HÃ›[BÃ›[3A[0;35mÂ³[1A [16;35H[1;31mÃ›[7A[0;35mÂ³[17;36H[1;31mÃ›[9A[0;35mÃ„[1AÃ„[5;40H[31mÂ¿[1AÃ€[B [BÃ„[B[35mÃ„[BÃš[18;45H[1;31mÃ›[9A[0;35mÃ„[17;46H[1;31mÃ›[7A[0;35mÃ„[16;47H[1;31mÃ›[1AÃ›[13;31HÃ›[1A[0;35mÃ™[14;32H[1;31mÃŸ[BÃœ[5A[0;35mÂ³[16;34H[1;31mÃ›[7A[0;35m [17;35H[1;31mÃ›[9A[0;35mÃš[1AÃ„[5;39H[31mÃ€[1A [1AÂ¿[BÂ´[B [BÃ™[B[35mÃ„[BÃ„[18;46H[1;31mÃ›[9A[0;35mÃ™[17;47H[1;31mÃ›[7A[0;35mÃ„[16;48H[1;31mÃ›[14;50HÃ›[1AÃœ[22DÃ›[1A[0;35mÃ„[1AÂ¿[15;32H[1;31mÃœ[BÃ›[7A[0;35mÂ³[17;34H[1;31mÃ›[9A[0;35m [18;35H[1;31mÃŸ[11A[0;35mÃ„[1A[31mÃ™[4;39HÂ¿[1AÃ€[CÂ³[B [BÂ³[7;46H[35mÃ„[BÂ¿[18;47H[1;31mÃŸ[9A[0;35m [17;48H[1;31mÃ›[7A[0;35mÃ™[5B[1;31mÃ›[3A[0;35mÃ€[14;51H[1;31mÃ›[1AÃ›[24DÃ›[1A[0;35mÃ„[14;30H[1;31mÃŸ[3A[0;35mÃ„[15;31H[1;31mÃ›[BÃ›[BÃ›[9A[0;35mÂ³[18;34H[1;31mÃ›[11A[0;35mÃ„[1A[31mÃ„[1AÂ³[1AÃ€[1A [1AÂ¿[CÂ³[B [BÂ³[7;47H[35mÃ„[B [BÂ³[7B[1;31mÃ›[5A[0;35mÂ³[15;51H[1;31mÃ›[3A[0;35mÃ„[14;52H[1;31mÃ›[1AÃ›[26DÃ›[1A[0;35mÃ„[14;29H[1;31mÃ›[3A[0;35mÃ„[15;30H[1;31mÃ›[BÃ›[BÃœ[BÃ›[11A[0;35mÃš[1A[31mÃ€[1A [1AÂ³[1AÂ¿[1AÃ€[1;42HÃš[B [BÂ³[7;48H[35mÃ„[BÂ³[9B[1;31mÃ›[7A[0;35mÂ³[16;51H[1;31mÃ›[5A[0;35m [15;52H[1;31mÃ›[3A[0;35mÃ„[14;53H[1;31mÃ›[1AÃ›[28DÃœ[1A[0;35mÃ„[14;28H[1;31mÃ›[3A[0;35mÃ„[15;29H[1;31mÃ›[5A[0;35mÃ™[16;30H[1;31mÃŸ[8;32H[0;35mÃ™[18;32H[1;31mÃ›[5;35H[0;31mÂ³[1A [1AÃƒ[1A [1AÂ¿[3CÃ„[BÂ³[7;49H[35mÂ¿[9;51HÂ³[17;51H[1;31mÃ›[7A[0;35m [16;52H[1;31mÃ›[5A[0;35mÃ€[15;53H[1;31mÃ›[3A[0;35mÃ„[14;54H[1;31mÃŸ[1AÃ›[12;27H[0;35mÃ„[14;27H[1;31mÃ›[3A[0;35mÃ€[15;28H[1;31mÃ›[5A[0;35mÃ„[16;29H[1;31mÃŸ[7A[0;35mÂ¿[17;30H[1;31mÃœ[9A[0;35mÃ„[18;31H[1;31mÃ›[11A[0;35mÂ¿[1A[31mÃ™[4;35HÂ³[1A [1A [1AÃ„[5CÂ¿[8;51H[35mÂ³[18;51H[1;31mÃŸ[9A[0;35m [17;52H[1;31mÃ›[7A[0;35mÂ³[16;53H[1;31mÃ›[5A[0;35mÃ„[BÃ„[B[1;31mÃ›[12;26H[0;35mÃ€[14;26H[1;31mÃ›[3A[0;35m [15;27H[1;31mÃ›[5A[0;35mÃš[1AÃ„[17;29H[1;31mÃ›[9A[0;35mÃ„[18;30H[1;31mÃ›[11A[0;35mÃ„[1A[31mÃ„[1AÂ³[3;35HÂ³[1A [1AÃ„[7;51H[35mÃš[B [18;52H[1;31mÃ›[9A[0;35mÂ³[17;53H[1;31mÃ›[11;55H[0;35mÃ„[BÃ™[B[1;31mÃ›[11;26H[0;35mÂ³[15;26H[1;31mÃŸ[5A[0;35m [1AÃ€[17;28H[1;31mÃ›[9A[0;35mÃ„[18;29H[1;31mÃ›[11A[0;35mÃ„[1A[31mÃ€[1A [1AÂ³[2;35HÂ³[1AÃ„[7;52H[35mÃ„[BÂ³[18;53H[1;31mÃ›[1AÃœ[11;56H[0;35mÂ¿[3B[1;31mÃŸ[1AÃ›[10;26H[0;35mÂ³[1A [17;27H[1;31mÃ›[9A[0;35mÃš[18;28H[1;31mÃ›[11A[0;35mÃ„[5;31H[31mÂ³[1A [1AÂ³[1;35HÃš[7;53H[35mÂ¿[11B[1;31mÃ›[12;58H[0;35mÃ€[14;58H[1;31mÃ›[1AÃœ[9;26H[0;35mÂ³[17;26H[1;31mÃ›[9A[0;35m [18;27H[1;31mÃŸ[11A[0;35mÃ„[4;31H[31mÂ¿[1A [1AÂ³[18;55H[1mÃ›[11;58H[0;35mÂ³[BÃ„[14;59H[1;31mÃ›[10;24H[0;35mÃ™[8;26HÂ³[1AÃ„[1A[31mÃ™[4;30HÃ„[1AÃ™[1A [1AÂ¿[18;56H[1mÃ›[1AÃœ[7A[0;35mÂ³[B [BÃ„[14;60H[1;31mÃ›[10;23H[0;35mÃ„[1AÂ³[7;26HÃš[1A[31mÃ„[1AÂ³[1AÃ„[1AÃ„[1AÂ¿[1AÃ„[18;57H[1mÃ›[9A[0;35mÂ³[17;58H[1;31mÃ›[7A[0;35m [BÃ€[BÃ„[B[1;31mÃœ[12;20H[0;35mÃ™[10;22HÃ„[1A [1AÂ³[6;26H[31mÃ€[1A [1AÃš[1AÃ„[1AÃ„[1AÃ„[8;58H[35mÂ³[18;58H[1;31mÃ›[9A[0;35m [17;59H[1;31mÃ›[7A[0;35mÃš[BÃ„[BÃ„[14;62H[1;31mÃ›[1AÃ›[12;19H[0;35mÃ„[1AÂ³[1AÃ„[1AÃ™[1A [1AÂ¿[5;26H[31mÂ³[1A [1AÃ€[1AÃ„[1AÃ„[7;58H[35mÃš[B [18;59H[1;31mÃŸ[9A[0;35mÃ€[17;60H[1;31mÃ›[7A[0;35mÃ„[BÃ„[15;62H[1;31mÃ›[3A[0;35mÃ„[14;63H[1;31mÃ›[1AÃ›[12;18H[0;35mÃ€[1A [1AÃš[1AÃ„[1AÂ¿[1AÃ„[1A[31mÃ™[4;26HÂ³[1A [1AÃš[1AÃ„[7;59H[35mÃ„[BÃš[BÃ„[BÃ™[16;62H[1;31mÃ›[5A[0;35mÃ„[15;63H[1;31mÃ›[3A[0;35mÃ™[14;64H[1;31mÃ›[1AÃœ[11;18H[0;35mÂ³[1A [1AÃ€[1AÃ„[1AÃ„[1A[31mÃ„[1AÂ¿[3;26HÂ³[1A [1AÃ„[7;60H[35mÃ„[BÃ„[BÂ¿[17;62H[1;31mÃ›[1AÃ›[5A[0;35mÂ¿[15;64H[1;31mÃ›[1AÃ›[10;18H[0;35mÂ³[1A [1AÃš[1AÃ„[1A[31mÃ„[1AÃ„[2;26HÂ³[1AÃ„[7;61H[35mÃ„[BÃ„[18;62H[1;31mÃŸ[1AÃ›[1AÃ›[1AÃ›[9;18H[0;35mÂ³[1A [1AÃ„[1A[31mÃ„[1AÃ„[1;26HÃš[7;62H[35mÃ„[BÃ„[18;63H[1;31mÃ›[1AÃ›[1AÃ›[1AÃ›[1AÃœ[8;18H[0;35mÂ³[1AÃ„[1A[31mÃ„[1AÃ„[1AÃ™[2;24HÃ™[7;63H[35mÃ„[BÃ™[18;64H[1;31mÃ›[1AÃ›[1AÃ›[1AÃ›[1AÃ›[1AÃœ[7;18H[0;35mÃš[1A[31mÃ„[1AÃ€[1AÃ„[1AÂ¿[1AÃ„[1AÂ¿[7;64H[35mÂ¿[11B[1;31mÃŸ[16;67HÃ›[1AÃ›[1AÃ›[1AÃ›[8;16H[0;31mÃ™[6;18HÃ€[1A [1AÃš[1AÃ„[1AÃ„[1AÃ„[17;67H[1mÃŸ[1AÃ›[1AÃ›[1AÃ›[1AÃ›[8;15H[0;31mÃ„[1AÂ¿[5;18HÂ³[1A [1AÃ€[1AÃ„[1AÃ„[17;68H[1mÃ›[1AÃ›[1AÃŸ[1AÃ›[1AÃœ[8;14H[0;31mÃ„[1AÃ€[4;18HÂ³[1A [1AÃš[1AÃ„[17;69H[1mÃ›[1AÃœ[14;72HÃŸ[8;13H[0;31mÃ„[1A [1AÂ³[3;18HÂ³[1A [1AÃ„[18;69H[1mÃŸ[1AÃ›[8;12H[0;31mÃ„[1A [1A [1AÂ³[2;18HÂ³[1AÃ„[18;70H[1mÃ›[1AÃ›[8;11H[0;31mÃ€[1AÃ™[1A [1A [1AÂ³[1;18HÃš[18;71H[1mÃ›[1AÃœ[7;11H[0;31mÃš[1AÂ³[1A [1A [1AÂ³[18;72H[1mÃŸ[5;12H[0;31mÂ³[1A [1A [1AÂ³[6;10HÃ™[4;12HÂ³[1A [1A [1AÂ¿[6;9HÃ„[1AÂ³[3;12HÂ³[1A [1AÃ„[8;6HÃ™[6;8HÃ„[1A [1AÂ³[2;12HÂ¿[1AÃ„[8;5HÃ„[1AÂ¿[1AÃ€[1A [1A [1AÂ³[1AÃ„[1AÃ„[8;4HÃ„[1AÃ€[5;7HÂ³[1A [1A [1AÃš[1AÃ„[8;3HÃ„[1A [1AÂ³[4;7HÂ³[1A [1A [1AÃ„[8;2HÃ„[1A [1A [1AÂ³[3;7HÂ³[1A [1AÃ„[8;1HÃ€[1AÃ™[1A [1A [1AÂ³[2;7HÂ¿[1AÃ„[7;1HÃš[1AÂ³[1A [1A [1AÂ³[1AÃ„[1AÃ„[5;2HÂ³[1A [1A [1AÃš[1AÃ„[4;2HÂ³[1A [1A [1AÃ„[3;2HÂ³[1A [1AÃ„[2;2HÂ³[1AÃ„[2DÃš[2D[30m [2;1H [3;1H [4;1H [5;1H [6;1H [7;1H [8;1H [9;1H [10;1H [11;1H [12;1H [13;1H [14;1H [15;1H [16;1H [17;1H [18;1H [19;1H [20;1H [21;1H [22;1H [23;1H [24;1H [25;1H [24A [2;2H [3;2H [4;2H [5;2H [6;2H [7;2H [8;2H [9;2H [10;2H [11;2H [12;2H [13;2H [14;2H [15;2H [16;2H [17;2H [18;2H [19;2H [20;2H [21;2H [22;2H [23;2H [24;2H [25;2H [24A [2;3H [3;3H [4;3H [5;3H [6;3H [7;3H [8;3H [9;3H [10;3H [11;3H [12;3H [13;3H [14;3H [15;3H [16;3H [17;3H [18;3H [19;3H [20;3H [21;3H [22;3H [23;3H [24;3H [25;3H [24A [2;4H [3;4H [4;4H [5;4H [6;4H [7;4H [8;4H [9;4H [10;4H [11;4H [12;4H [13;4H [14;4H [15;4H [16;4H [17;4H [18;4H [19;4H [20;4H [21;4H [22;4H [23;4H [24;4H [25;4H [24A [2;5H [3;5H [4;5H [5;5H [6;5H [7;5H [8;5H [9;5H [10;5H [11;5H [12;5H [13;5H [14;5H [15;5H [16;5H [17;5H [18;5H [19;5H [20;5H [21;5H [22;5H [23;5H [24;5H [25;5H [24A [2;6H [3;6H [4;6H [5;6H [6;6H [7;6H [8;6H [9;6H [10;6H [11;6H [12;6H [13;6H [14;6H [15;6H [16;6H [17;6H [18;6H [19;6H [20;6H [21;6H [22;6H [23;6H [24;6H [25;6H [24A [2;7H [3;7H [4;7H [5;7H [6;7H [7;7H [8;7H [9;7H [10;7H [11;7H [12;7H [13;7H [14;7H [15;7H [16;7H [17;7H [18;7H [19;7H [20;7H [21;7H [22;7H [23;7H [24;7H [25;7H [24A [2;8H [3;8H [4;8H [5;8H [6;8H [7;8H [8;8H [9;8H [10;8H [11;8H [12;8H [13;8H [14;8H [15;8H [16;8H [17;8H [18;8H [19;8H [20;8H [21;8H [22;8H [23;8H [24;8H [25;8H [24A [2;9H [3;9H [4;9H [5;9H [6;9H [7;9H [8;9H [9;9H [10;9H [11;9H [12;9H [13;9H [14;9H [15;9H [16;9H [17;9H [18;9H [19;9H [20;9H [21;9H [22;9H [23;9H [24;9H [25;9H [24A [2;10H [3;10H [4;10H [5;10H [6;10H [7;10H [8;10H [9;10H [10;10H [11;10H [12;10H [13;10H [14;10H [15;10H [16;10H [17;10H [18;10H [19;10H [20;10H [21;10H [22;10H [23;10H [24;10H [25;10H [24A [2;11H [3;11H [4;11H [5;11H [6;11H [7;11H [8;11H [9;11H [10;11H [11;11H [12;11H [13;11H [14;11H [15;11H [16;11H [17;11H [18;11H [19;11H [20;11H [21;11H [22;11H [23;11H [24;11H [25;11H [24A [2;12H [3;12H [4;12H [5;12H [6;12H [7;12H [8;12H [9;12H [10;12H [11;12H [12;12H [13;12H [14;12H [15;12H [16;12H [17;12H [18;12H [19;12H [20;12H [21;12H [22;12H [23;12H [24;12H [25;12H [24A [2;13H [3;13H [4;13H [5;13H [6;13H [7;13H [8;13H [9;13H [10;13H [11;13H [12;13H [13;13H [14;13H [15;13H [16;13H [17;13H [18;13H [19;13H [20;13H [21;13H [22;13H [23;13H [24;13H [25;13H [24A [2;14H [3;14H [4;14H [5;14H [6;14H [7;14H [8;14H [9;14H [10;14H [11;14H [12;14H [13;14H [14;14H [15;14H [16;14H [17;14H [18;14H [19;14H [20;14H [21;14H [22;14H [23;14H [24;14H [25;14H [24A [2;15H [3;15H [4;15H [5;15H [6;15H [7;15H [8;15H [9;15H [10;15H [11;15H [12;15H [13;15H [14;15H [15;15H [16;15H [17;15H [18;15H [19;15H [20;15H [21;15H [22;15H [23;15H [24;15H [25;15H [24A [2;16H [3;16H [4;16H [5;16H [6;16H [7;16H [8;16H [9;16H [10;16H [11;16H [12;16H [13;16H [14;16H [15;16H [16;16H [17;16H [18;16H [19;16H [20;16H [21;16H [22;16H [23;16H [24;16H [25;16H [24A [2;17H [3;17H [4;17H [5;17H [6;17H [7;17H [8;17H [9;17H [10;17H [11;17H [12;17H [13;17H [14;17H [15;17H [16;17H [17;17H [18;17H [19;17H [20;17H [21;17H [22;17H [23;17H [24;17H [25;17H [24A [2;18H [3;18H [4;18H [5;18H [6;18H [7;18H [8;18H [9;18H [10;18H [11;18H [12;18H [13;18H [14;18H [15;18H [16;18H [17;18H [18;18H [19;18H [20;18H [21;18H [22;18H [23;18H [24;18H [25;18H [24A [2;19H [3;19H [4;19H [5;19H [6;19H [7;19H [8;19H [9;19H [10;19H [11;19H [12;19H [13;19H [14;19H [15;19H [16;19H [17;19H [18;19H [19;19H [20;19H [21;19H [22;19H [23;19H [24;19H [25;19H [24A [2;20H [3;20H [4;20H [5;20H [6;20H [7;20H [8;20H [9;20H [10;20H [11;20H [12;20H [13;20H [14;20H [15;20H [16;20H [17;20H [18;20H [19;20H [20;20H [21;20H [22;20H [23;20H [24;20H [25;20H [24A [2;21H [3;21H [4;21H [5;21H [6;21H [7;21H [8;21H [9;21H [10;21H [11;21H [12;21H [13;21H [14;21H [15;21H [16;21H [17;21H [18;21H [19;21H [20;21H [21;21H [22;21H [23;21H [24;21H [25;21H [24A [2;22H [3;22H [4;22H [5;22H [6;22H [7;22H [8;22H [9;22H [10;22H [11;22H [12;22H [13;22H [14;22H [15;22H [16;22H [17;22H [18;22H [19;22H [20;22H [21;22H [22;22H [23;22H [24;22H [25;22H [24A [2;23H [3;23H [4;23H [5;23H [6;23H [7;23H [8;23H [9;23H [10;23H [11;23H [12;23H [13;23H [14;23H [15;23H [16;23H [17;23H [18;23H [19;23H [20;23H [21;23H [22;23H [23;23H [24;23H [25;23H [24A [2;24H [3;24H [4;24H [5;24H [6;24H [7;24H [8;24H [9;24H [10;24H [11;24H [12;24H [13;24H [14;24H [15;24H [16;24H [17;24H [18;24H [19;24H [20;24H [21;24H [22;24H [23;24H [24;24H [25;24H [24A [2;25H [3;25H [4;25H [5;25H [6;25H [7;25H [8;25H [9;25H [10;25H [11;25H [12;25H [13;25H [14;25H [15;25H [16;25H [17;25H [18;25H [19;25H [20;25H [21;25H [22;25H [23;25H [24;25H [25;25H [24A [2;26H [3;26H [4;26H [5;26H [6;26H [7;26H [8;26H [9;26H [10;26H [11;26H [12;26H [13;26H [14;26H [15;26H [16;26H [17;26H [18;26H [19;26H [20;26H [21;26H [22;26H [23;26H [24;26H [25;26H [24A [2;27H [3;27H [4;27H [5;27H [6;27H [7;27H [8;27H [9;27H [10;27H [11;27H [12;27H [13;27H [14;27H [15;27H [16;27H [17;27H [18;27H [19;27H [20;27H [21;27H [22;27H [23;27H [24;27H [25;27H [24A [2;28H [3;28H [4;28H [5;28H [6;28H [7;28H [8;28H [9;28H [10;28H [11;28H [12;28H [13;28H [14;28H [15;28H [16;28H [17;28H [18;28H [19;28H [20;28H [21;28H [22;28H [23;28H [24;28H [25;28H [24A [2;29H [3;29H [4;29H [5;29H [6;29H [7;29H [8;29H [9;29H [10;29H [11;29H [12;29H [13;29H [14;29H [15;29H [16;29H [17;29H [18;29H [19;29H [20;29H [21;29H [22;29H [23;29H [24;29H [25;29H [24A [2;30H [3;30H [4;30H [5;30H [6;30H [7;30H [8;30H [9;30H [10;30H [11;30H [12;30H [13;30H [14;30H [15;30H [16;30H [17;30H [18;30H [19;30H [20;30H [21;30H [22;30H [23;30H [24;30H [25;30H [24A [2;31H [3;31H [4;31H [5;31H [6;31H [7;31H [8;31H [9;31H [10;31H [11;31H [12;31H [13;31H [14;31H [15;31H [16;31H [17;31H [18;31H [19;31H [20;31H [21;31H [22;31H [23;31H [24;31H [25;31H [24A [2;32H [3;32H [4;32H [5;32H [6;32H [7;32H [8;32H [9;32H [10;32H [11;32H [12;32H [13;32H [14;32H [15;32H [16;32H [17;32H [18;32H [19;32H [20;32H [21;32H [22;32H [23;32H [24;32H [25;32H [24A [2;33H [3;33H [4;33H [5;33H [6;33H [7;33H [8;33H [9;33H [10;33H [11;33H [12;33H [13;33H [14;33H [15;33H [16;33H [17;33H [18;33H [19;33H [20;33H [21;33H [22;33H [23;33H [24;33H [25;33H [24A [2;34H [3;34H [4;34H [5;34H [6;34H [7;34H [8;34H [9;34H [10;34H [11;34H [12;34H [13;34H [14;34H [15;34H [16;34H [17;34H [18;34H [19;34H [20;34H [21;34H [22;34H [23;34H [24;34H [25;34H [24A [2;35H [3;35H [4;35H [5;35H [6;35H [7;35H [8;35H [9;35H [10;35H [11;35H [12;35H [13;35H [14;35H [15;35H [16;35H [17;35H [18;35H [19;35H [20;35H [21;35H [22;35H [23;35H [24;35H [25;35H [24A [2;36H [3;36H [4;36H [5;36H [6;36H [7;36H [8;36H [9;36H [10;36H [11;36H [12;36H [13;36H [14;36H [15;36H [16;36H [17;36H [18;36H [19;36H [20;36H [21;36H [22;36H [23;36H [24;36H [25;36H [24A [2;37H [3;37H [4;37H [5;37H [6;37H [7;37H [8;37H [9;37H [10;37H [11;37H [12;37H [13;37H [14;37H [15;37H [16;37H [17;37H [18;37H [19;37H [20;37H [21;37H [22;37H [23;37H [24;37H [25;37H [24A [2;38H [3;38H [4;38H [5;38H [6;38H [7;38H [8;38H [9;38H [10;38H [11;38H [12;38H [13;38H [14;38H [15;38H [16;38H [17;38H [18;38H [19;38H [20;38H [21;38H [22;38H [23;38H [24;38H [25;38H [24A [2;39H [3;39H [4;39H [5;39H [6;39H [7;39H [8;39H [9;39H [10;39H [11;39H [12;39H [13;39H [14;39H [15;39H [16;39H [17;39H [18;39H [19;39H [20;39H [21;39H [22;39H [23;39H [24;39H [25;39H [24A [2;40H [3;40H [4;40H [5;40H [6;40H [7;40H [8;40H [9;40H [10;40H [11;40H [12;40H [13;40H [14;40H [15;40H [16;40H [17;40H [18;40H [19;40H [20;40H [21;40H [22;40H [23;40H [24;40H [25;40H [24A [2;41H [3;41H [4;41H [5;41H [6;41H [7;41H [8;41H [9;41H [10;41H [11;41H [12;41H [13;41H [14;41H [15;41H [16;41H [17;41H [18;41H [19;41H [20;41H [21;41H [22;41H [23;41H [24;41H [25;41H [24A [2;42H [3;42H [4;42H [5;42H [6;42H [7;42H [8;42H [9;42H [10;42H [11;42H [12;42H [13;42H [14;42H [15;42H [16;42H [17;42H [18;42H [19;42H [20;42H [21;42H [22;42H [23;42H [24;42H [25;42H [24A [2;43H [3;43H [4;43H [5;43H [6;43H [7;43H [8;43H [9;43H [10;43H [11;43H [12;43H [13;43H [14;43H [15;43H [16;43H [17;43H [18;43H [19;43H [20;43H [21;43H [22;43H [23;43H [24;43H [25;43H [24A [2;44H [3;44H [4;44H [5;44H [6;44H [7;44H [8;44H [9;44H [10;44H [11;44H [12;44H [13;44H [14;44H [15;44H [16;44H [17;44H [18;44H [19;44H [20;44H [21;44H [22;44H [23;44H [24;44H [25;44H [24A [2;45H [3;45H [4;45H [5;45H [6;45H [7;45H [8;45H [9;45H [10;45H [11;45H [12;45H [13;45H [14;45H [15;45H [16;45H [17;45H [18;45H [19;45H [20;45H [21;45H [22;45H [23;45H [24;45H [25;45H [24A [2;46H [3;46H [4;46H [5;46H [6;46H [7;46H [8;46H [9;46H [10;46H [11;46H [12;46H [13;46H [14;46H [15;46H [16;46H [17;46H [18;46H [19;46H [20;46H [21;46H [22;46H [23;46H [24;46H [25;46H [24A [2;47H [3;47H [4;47H [5;47H [6;47H [7;47H [8;47H [9;47H [10;47H [11;47H [12;47H [13;47H [14;47H [15;47H [16;47H [17;47H [18;47H [19;47H [20;47H [21;47H [22;47H [23;47H [24;47H [25;47H [24A [2;48H [3;48H [4;48H [5;48H [6;48H [7;48H [8;48H [9;48H [10;48H [11;48H [12;48H [13;48H [14;48H [15;48H [16;48H [17;48H [18;48H [19;48H [20;48H [21;48H [22;48H [23;48H [24;48H [25;48H [24A [2;49H [3;49H [4;49H [5;49H [6;49H [7;49H [8;49H [9;49H [10;49H [11;49H [12;49H [13;49H [14;49H [15;49H [16;49H [17;49H [18;49H [19;49H [20;49H [21;49H [22;49H [23;49H [24;49H [25;49H [24A [2;50H [3;50H [4;50H [5;50H [6;50H [7;50H [8;50H [9;50H [10;50H [11;50H [12;50H [13;50H [14;50H [15;50H [16;50H [17;50H [18;50H [19;50H [20;50H [21;50H [22;50H [23;50H [24;50H [25;50H [24A [2;51H [3;51H [4;51H [5;51H [6;51H [7;51H [8;51H [9;51H [10;51H [11;51H [12;51H [13;51H [14;51H [15;51H [16;51H [17;51H [18;51H [19;51H [20;51H [21;51H [22;51H [23;51H [24;51H [25;51H [24A [2;52H [3;52H [4;52H [5;52H [6;52H [7;52H [8;52H [9;52H [10;52H [11;52H [12;52H [13;52H [14;52H [15;52H [16;52H [17;52H [18;52H [19;52H [20;52H [21;52H [22;52H [23;52H [24;52H [25;52H [24A [2;53H [3;53H [4;53H [5;53H [6;53H [7;53H [8;53H [9;53H [10;53H [11;53H [12;53H [13;53H [14;53H [15;53H [16;53H [17;53H [18;53H [19;53H [20;53H [21;53H [22;53H [23;53H [24;53H [25;53H [24A [2;54H [3;54H [4;54H [5;54H [6;54H [7;54H [8;54H [9;54H [10;54H [11;54H [12;54H [13;54H [14;54H [15;54H [16;54H [17;54H [18;54H [19;54H [20;54H [21;54H [22;54H [23;54H [24;54H [25;54H [24A [2;55H [3;55H [4;55H [5;55H [6;55H [7;55H [8;55H [9;55H [10;55H [11;55H [12;55H [13;55H [14;55H [15;55H [16;55H [17;55H [18;55H [19;55H [20;55H [21;55H [22;55H [23;55H [24;55H [25;55H [24A [2;56H [3;56H [4;56H [5;56H [6;56H [7;56H [8;56H [9;56H [10;56H [11;56H [12;56H [13;56H [14;56H [15;56H [16;56H [17;56H [18;56H [19;56H [20;56H [21;56H [22;56H [23;56H [24;56H [25;56H [24A [2;57H [3;57H [4;57H [5;57H [6;57H [7;57H [8;57H [9;57H [10;57H [11;57H [12;57H [13;57H [14;57H [15;57H [16;57H [17;57H [18;57H [19;57H [20;57H [21;57H [22;57H [23;57H [24;57H [25;57H [24A [2;58H [3;58H [4;58H [5;58H [6;58H [7;58H [8;58H [9;58H [10;58H [11;58H [12;58H [13;58H [14;58H [15;58H [16;58H [17;58H [18;58H [19;58H [20;58H [21;58H [22;58H [23;58H [24;58H [25;58H [24A [2;59H [3;59H [4;59H [5;59H [6;59H [7;59H [8;59H [9;59H [10;59H [11;59H [12;59H [13;59H [14;59H [15;59H [16;59H [17;59H [18;59H [19;59H [20;59H [21;59H [22;59H [23;59H [24;59H [25;59H [24A [2;60H [3;60H [4;60H [5;60H [6;60H [7;60H [8;60H [9;60H [10;60H [11;60H [12;60H [13;60H [14;60H [15;60H [16;60H [17;60H [18;60H [19;60H [20;60H [21;60H [22;60H [23;60H [24;60H [25;60H [24A [2;61H [3;61H [4;61H [5;61H [6;61H [7;61H [8;61H [9;61H [10;61H [11;61H [12;61H [13;61H [14;61H [15;61H [16;61H [17;61H [18;61H [19;61H [20;61H [21;61H [22;61H [23;61H [24;61H [25;61H [24A [2;62H [3;62H [4;62H [5;62H [6;62H [7;62H [8;62H [9;62H [10;62H [11;62H [12;62H [13;62H [14;62H [15;62H [16;62H [17;62H [18;62H [19;62H [20;62H [21;62H [22;62H [23;62H [24;62H [25;62H [24A [2;63H [3;63H [4;63H [5;63H [6;63H [7;63H [8;63H [9;63H [10;63H [11;63H [12;63H [13;63H [14;63H [15;63H [16;63H [17;63H [18;63H [19;63H [20;63H [21;63H [22;63H [23;63H [24;63H [25;63H [24A [2;64H [3;64H [4;64H [5;64H [6;64H [7;64H [8;64H [9;64H [10;64H [11;64H [12;64H [13;64H [14;64H [15;64H [16;64H [17;64H [18;64H [19;64H [20;64H [21;64H [22;64H [23;64H [24;64H [25;64H [24A [2;65H [3;65H [4;65H [5;65H [6;65H [7;65H [8;65H [9;65H [10;65H [11;65H [12;65H [13;65H [14;65H [15;65H [16;65H [17;65H [18;65H [19;65H [20;65H [21;65H [22;65H [23;65H [24;65H [25;65H [24A [2;66H [3;66H [4;66H [5;66H [6;66H [7;66H [8;66H [9;66H [10;66H [11;66H [12;66H [13;66H [14;66H [15;66H [16;66H [17;66H [18;66H [19;66H [20;66H [21;66H [22;66H [23;66H [24;66H [25;66H [24A [2;67H [3;67H [4;67H [5;67H [6;67H [7;67H [8;67H [9;67H [10;67H [11;67H [12;67H [13;67H [14;67H [15;67H [16;67H [17;67H [18;67H [19;67H [20;67H [21;67H [22;67H [23;67H [24;67H [25;67H [24A [2;68H [3;68H [4;68H [5;68H [6;68H [7;68H [8;68H [9;68H [10;68H [11;68H [12;68H [13;68H [14;68H [15;68H [16;68H [17;68H [18;68H [19;68H [20;68H [21;68H [22;68H [23;68H [24;68H [25;68H [24A [2;69H [3;69H [4;69H [5;69H [6;69H [7;69H [8;69H [9;69H [10;69H [11;69H [12;69H [13;69H [14;69H [15;69H [16;69H [17;69H [18;69H [19;69H [20;69H [21;69H [22;69H [23;69H [24;69H [25;69H [24A [2;70H [3;70H [4;70H [5;70H [6;70H [7;70H [8;70H [9;70H [10;70H [11;70H [12;70H [13;70H [14;70H [15;70H [16;70H [17;70H [18;70H [19;70H [20;70H [21;70H [22;70H [23;70H [24;70H [25;70H [24A [2;71H [3;71H [4;71H [5;71H [6;71H [7;71H [8;71H [9;71H [10;71H [11;71H [12;71H [13;71H [14;71H [15;71H [16;71H [17;71H [18;71H [19;71H [20;71H [21;71H [22;71H [23;71H [24;71H [25;71H [24A [2;72H [3;72H [4;72H [5;72H [6;72H [7;72H [8;72H [9;72H [10;72H [11;72H [12;72H [13;72H [14;72H [15;72H [16;72H [17;72H [18;72H [19;72H [20;72H [21;72H [22;72H [23;72H [24;72H [25;72H [24A [2;73H [3;73H [4;73H [5;73H [6;73H [7;73H [8;73H [9;73H [10;73H [11;73H [12;73H [13;73H [14;73H [15;73H [16;73H [17;73H [18;73H [19;73H [20;73H [21;73H [22;73H [23;73H [24;73H [25;73H [24A [2;74H [3;74H [4;74H [5;74H [6;74H [7;74H [8;74H [9;74H [10;74H [11;74H [12;74H [13;74H [14;74H [15;74H [16;74H [17;74H [18;74H [19;74H [20;74H [21;74H [22;74H [23;74H [24;74H [25;74H [24A [2;75H [3;75H [4;75H [5;75H [6;75H [7;75H [8;75H [9;75H [10;75H [11;75H [12;75H [13;75H [14;75H [15;75H [16;75H [17;75H [18;75H [19;75H [20;75H [21;75H [22;75H [23;75H [24;75H [25;75H [24A [2;76H [3;76H [4;76H [5;76H [6;76H [7;76H [8;76H [9;76H [10;76H [11;76H [12;76H [13;76H [14;76H [15;76H [16;76H [17;76H [18;76H [19;76H [20;76H [21;76H [22;76H [23;76H [24;76H [25;76H [24A [2;77H [3;77H [4;77H [5;77H [6;77H [7;77H [8;77H [9;77H [10;77H [11;77H [12;77H [13;77H [14;77H [15;77H [16;77H [17;77H [18;77H [19;77H [20;77H [21;77H [22;77H [23;77H [24;77H [25;77H [24A [2;78H [3;78H [4;78H [5;78H [6;78H [7;78H [8;78H [9;78H [10;78H [11;78H [12;78H [13;78H [14;78H [15;78H [16;78H [17;78H [18;78H [19;78H [20;78H [21;78H [22;78H [23;78H [24;78H [25;78H [24A [2;79H [3;79H [4;79H [5;79H [6;79H [7;79H [8;79H [9;79H [10;79H [11;79H [12;79H [13;79H [14;79H [15;79H [16;79H [17;79H [18;79H [19;79H [20;79H [21;79H [22;79H [23;79H [24;79H [25;79H [24A [79C [79C [79C [79C [79C [79C [79C [79C [79C [79C [79C [79C [79C [79C [79C [79C [79C [79C [79C [79C [79C [79C [79C [79C[K[11;21H[1;34m- Welcome to the Intellectual Wasteland -[0m"]
function main(){if(engine.DEBUG)net.init({engine:engine})
if(!engine.startup({game_width:game_width,game_height:game_height,pixely:"strict",viewport_postprocess:true,font:{info:require("./img/font/vga_16x1.json"),texture:"font/vga_16x1"},pixel_aspect:640/480/1.8,show_fps:false}))return
var terminal=terminalCreate({z:Z.BACKGROUND+1})
ui.scaleSizes(13/32)
ui.setFontHeight(16)
var KEYS=input.KEYS
var auto_advance=true
var term_idx=0
var terminal_countdown=0
function ansiArt(dt){if(input.keyDownEdge(KEYS.ESCAPE))engine.setState(menuInit)
if(input.keyDownEdge(KEYS.LEFT)){auto_advance=false
terminal_countdown=0
term_idx--}if(input.keyDownEdge(KEYS.RIGHT)){auto_advance=false
terminal_countdown=0
term_idx++}var baud_save=terminal.baud
terminal.baud=input.keyDown(KEYS.SPACE)||input.keyDown(KEYS.ESCAPE)?Infinity:baud_save
if(!terminal_countdown||dt>=terminal_countdown){if(void 0===term_idx)term_idx=0
if(auto_advance)term_idx=min(term_idx||0,ansi_files.length)+1
if(term_idx>ansi_files.length||term_idx<=0){if(!ansiArt.terminal_inited){var getch=function getch(ii,jj){return 176+floor(48*random())}
ansiArt.terminal_inited=true
terminal.autoScroll(false)
terminal.moveto(0,0)
for(var ii=0;ii<25;++ii){var str=[0===ii?"â•“":24===ii?"â•š":"â•‘"]
for(var jj=1;jj<79;++jj)if(0===ii)str.push("â”€")
else if(24===ii)str.push("â•")
else str.push(getch(ii,jj))
str.push(0===ii?"â•–":24===ii?"â•":"â•‘")
terminal.print({x:0,y:ii,text:str,fg:8,bg:0})}terminal.moveto(0,0)}terminal.color(floor(16*random()),floor(8*random()))
var x=1+floor(78*random())
var y=1+floor(23*random())
terminal.fill({x:x,y:y,w:min(79-x,1+floor(10*random())),h:min(24-y,1+floor(8*random())),ch:32+floor(223*random())})
terminal_countdown=100}else{terminal.color(7,0)
terminal.clear()
var data=ansi_files[term_idx-1]
terminal.print({x:0,y:0,text:data})
terminal_countdown=auto_advance?1500:1e9}}else terminal_countdown-=dt
terminal.render()
terminal.baud=baud_save}var rpgdata
var RPG_BODY_W=58
var RPG_STATUS_W=18
var RPG_STATUS_H=3
var RPG_STATUS_X=RPG_BODY_W+2
var rpgsubview
function rpgText(text){terminal.subViewPush(rpgsubview)
terminal.print({text:text})
terminal.subViewPop()}var RPG_STATES={town:{enter:function enter(){rpgText("You stand in the town square, ready for adventure!  Or,\r\nperhaps, a break.\r\n")},menu:{"[1] Visit the Inn":"inn","[2] Fight a Monster":"fight"}},inn:{enter:function enter(){rpgText("You rest, and are healed.\r\n\r\n")
rpgdata.hp=rpgdata.maxhp
rpgState("town")}},fight:{enter:function enter(){rpgText("You head into the forest to fight...\r\n")
var damage=floor(random()*random()*50)
if(damage){rpgText("You take "+ansi.red(damage)+" damage.\r\n")
rpgdata.hp-=damage}else rpgText("You escape unscathed.\r\n")
var gp=floor(20*random())
rpgText("You find "+ansi.yellow.bright(gp)+" GP.\r\n")
rpgdata.gp+=gp
rpgText("\r\n")
rpgState("town")}}}
function rpgState(state){var st=RPG_STATES[state]
rpgdata.state=state
st.enter()
if(rpgdata.state!==state)return
terminal.subViewPush(rpgsubview)
if(st.menu){for(var key in st.menu)terminal.print({text:"\n"})
terminal.print({text:"> "})}terminal.subViewPop()
rpgdata.menu_cursor_x=rpgsubview.cursor_x
rpgdata.menu_cursor_y=rpgsubview.cursor_y
rpgdata.menu_x=rpgsubview.x
rpgdata.menu_y=rpgsubview.cursor_y-Object.keys(st.menu).length}function rpgInit(){rpgdata={hp:100,maxhp:100,gp:0}
rpgsubview={x:1,y:1,w:RPG_BODY_W,h:23,cursor_x:1,cursor_y:1}
terminal.color(7,0)
terminal.clear()
terminal.color(4,0)
terminal.cells({x:0,y:0,ws:[RPG_BODY_W],hs:[23],charset:1,header:" THE RPG "})
terminal.color(2,0)
terminal.cells({x:RPG_STATUS_X,y:0,ws:[RPG_STATUS_W],hs:[RPG_STATUS_H],charset:0,header:" Status "})
terminal.color(7,0)
rpgState("town")}function rpg(dt){function drawStatus(){var health_color=rpgdata.hp/rpgdata.maxhp<.5?"red":"green"
terminal.print({x:RPG_STATUS_X+2,y:1,fg:2,text:padRight("HP: "+ansi[health_color].bright(rpgdata.hp+" / "+rpgdata.maxhp)+"  ",RPG_STATUS_W-2)})
terminal.print({x:RPG_STATUS_X+2,y:2,fg:2,text:padRight("GP: "+ansi.yellow.bright(rpgdata.gp)+"  ",RPG_STATUS_W-2)})}drawStatus()
var st=RPG_STATES[rpgdata.state]
if(st&&st.menu){if(!st.menu_keys)st.menu_keys=Object.keys(st.menu)
var ret=terminal.menu({pre_sel:" â–  ",pre_unsel:"   ",x:rpgdata.menu_x,y:rpgdata.menu_y,items:st.menu_keys})
terminal.moveto(rpgdata.menu_cursor_x,rpgdata.menu_cursor_y)
if(-1!==ret){rpgText(st.menu_keys[ret]+"\r\n")
rpgState(st.menu[st.menu_keys[ret]])}}terminal.render()}var MENU_W=20
var MENU_X=(80-MENU_W)/2
var MENU_Y=5
function menu(dt){switch(terminal.menu({x:MENU_X,y:5,items:["ANSI Art ","An RPG ",ansi.yellow.bright("[O]")+"ptions "]})){case 0:engine.setState(ansiArt)
break
case 1:rpgInit()
engine.setState(rpg)
break
case 2:terminalSettingsShow()}terminal.render()}function menuInit(dt){terminal.baud=9600
terminal.color(7,0)
terminal.clear()
terminalSettingsInit(terminal)
terminal.cells({x:MENU_X-2,y:MENU_Y-1,ws:[MENU_W],hs:[3],charset:2,header:" MENU "})
engine.setState(menu)
menu(dt)}engine.setState(menuInit)}

},{"../glov/client/engine.js":13,"../glov/client/input.js":28,"../glov/client/local_storage.js":31,"../glov/client/net.js":35,"../glov/client/terminal.js":53,"../glov/client/terminal_settings.js":54,"../glov/client/ui.js":57,"./img/font/vga_16x1.json":2}],4:[function(require,module,exports){
"use strict"
require("./polyfill.js")
var debug=document.getElementById("debug")
window.onerror=function(e,file,line,col,errorobj){var msg=String(e)
if("[object Object]"===msg){try{msg=JSON.stringify(e)}catch(ignored){}msg=msg.slice(0,600)}if(file||line>0||col>0)msg+="\n  at "+file+"("+line+":"+col+")"
if(errorobj&&errorobj.stack){msg=""+errorobj.stack
if(errorobj.message)if(-1===msg.indexOf(errorobj.message))msg=errorobj.message+"\n"+msg
var origin=document.location.origin||""
if(origin){if("/"!==origin.slice(-1))origin+="/"
msg=msg.split(origin).join("")}msg=msg.replace(/\[\d+\]<\/?/g,"").replace(/\/</g,"").replace(/<?\/<?/g,"/").replace(/\n\//g,"\n").replace(/\n([^ ])/g,"\n  $1")}if(-1===msg.indexOf("Error:"))msg="Error: "+msg
if(errorobj&&errorobj.type)if("unhandledrejection"===errorobj.type)msg="Uncaught (in promise) "+msg
var show=true
if(window.glov_error_report)show=window.glov_error_report(msg,file,line,col)
if(show)debug.innerText=msg+"\n\nPlease report this error to the developer, and then reload this page or restart the app."}
window.addEventListener("unhandledrejection",function(event){var errorobj=event.reason
if(!errorobj)return
if(!errorobj||"object"!==typeof errorobj)errorobj={stack:errorobj}
errorobj.type=event.type
window.onerror(event.reason,void 0,0,0,errorobj)})
window.debugmsg=function(msg,clear){if(clear)debug.innerText=msg
else debug.innerText+=msg+"\n"}
window.profilerStart=window.profilerStop=window.profilerStopStart=function nop(){}

},{"./polyfill.js":40}],5:[function(require,module,exports){
"use strict"
exports.is_windows_phone=exports.is_webkit=exports.is_mac_osx=exports.is_ios_safari=exports.is_ios=exports.is_firefox=exports.is_discrete_gpu=exports.is_android=void 0
var ua=window.navigator.userAgent
var is_mac_osx=ua.match(/Mac OS X/)
exports.is_mac_osx=is_mac_osx
var is_ios=!window.MSStream&&ua.match(/iPad|iPhone|iPod/)
exports.is_ios=is_ios
var is_windows_phone=ua.match(/windows phone/i)
var is_android=!(exports.is_windows_phone=is_windows_phone)&&ua.match(/android/i)
exports.is_android=is_android
var is_webkit=ua.match(/WebKit/i)
exports.is_webkit=is_webkit
var is_ios_safari=is_ios&&is_webkit&&!ua.match(/CriOS/i)
exports.is_ios_safari=is_ios_safari
var is_firefox=ua.match(/Firefox/i)
exports.is_firefox=is_firefox
var is_discrete_gpu=false
exports.is_discrete_gpu=is_discrete_gpu
function init(){try{var canvas=document.createElement("canvas")
canvas.width=4
canvas.height=4
var gltest=canvas.getContext("webgl")
if(gltest){var debug_info=gltest.getExtension("WEBGL_debug_renderer_info")
if(debug_info){var renderer_unmasked=gltest.getParameter(debug_info.UNMASKED_RENDERER_WEBGL)
exports.is_discrete_gpu=is_discrete_gpu=Boolean(renderer_unmasked&&renderer_unmasked.match(/nvidia|radeon/i))}}}catch(e){}}init()

},{}],6:[function(require,module,exports){
"use strict"
exports.buildUIStartup=buildUIStartup
var camera2d=require("./camera2d.js")
var engine=require("./engine.js")
var glov_font=require("./font.js")
var min=Math.min
var _require=require("./scroll_area.js"),scrollAreaCreate=_require.scrollAreaCreate
var ui=require("./ui.js")
var net=require("./net.js")
var _require2=require("../common/util.js"),plural=_require2.plural
var _require3=require("../common/vmath.js"),vec4=_require3.vec4
var gbstate
var server_error
Z.BUILD_ERRORS=Z.BUILD_ERRORS||9900
function onGBState(state){gbstate=state}function onServerError(err){server_error=err}var PAD=4
var color_panel=vec4(0,0,0,1)
var style_title=glov_font.styleColored(null,4280295679)
var style=glov_font.styleColored(null,3722305023)
var style_task=glov_font.styleColored(null,14540287)
var style_job=glov_font.styleColored(null,539033599)
var color_line=vec4(1,1,1,1)
var strip_ansi=/\u001b\[(?:[0-9;]*)[0-9A-ORZcf-nqry=><]/g
var scroll_area
function buildUITick(){if(!gbstate&&!server_error)return
var x0=camera2d.x0()+PAD
var y0=camera2d.y0()+PAD
var z=Z.BUILD_ERRORS
var w=.75*camera2d.w()
var font=ui.font,title_font=ui.title_font,font_height=ui.font_height
var x=x0
var y=y0
var error_count=((null==gbstate?void 0:gbstate.error_count)||0)+(server_error?1:0)
var warning_count=(null==gbstate?void 0:gbstate.warning_count)||0
title_font.drawSizedAligned(style_title,x,y,z,font_height,font.ALIGN.HCENTERFIT,w,0,error_count+" "+plural(error_count,"error")+", "+warning_count+" "+plural(warning_count,"warning"))
y+=font_height+1
ui.drawLine(x0+.3*w,y,x0+.7*w,y,z,.5,true,color_line)
y+=PAD
if(!scroll_area)scroll_area=scrollAreaCreate({z:z,background_color:null,auto_hide:true})
var max_h=camera2d.y1()-PAD-y
var scroll_y_start=y
scroll_area.begin({x:x,y:y,w:w,h:max_h})
var sub_w=w-PAD-scroll_area.barWidth()
y=0
z=Z.UI
function printLine(type,str){str=str.replace(strip_ansi,"")
y+=font.drawSizedWrapped(style,x,y,z,sub_w,0,font_height,type+": "+str)}if(gbstate)for(var task_name in gbstate.tasks){var task=gbstate.tasks[task_name]
x=0
font.drawSizedAligned(style_task,x,y,z,font_height,font.ALIGN.HLEFT,sub_w,0,task_name+":")
y+=font_height
x+=font_height
var printed_any=false
for(var job_name in task.jobs){var job=task.jobs[job_name]
var warnings=job.warnings,errors=job.errors
if("all"!==job_name){if(job_name.startsWith("source:"))job_name=job_name.slice(7)
y+=font.drawSizedWrapped(style_job,x,y,z,sub_w,0,font_height,job_name)}if(warnings)for(var ii=0;ii<warnings.length;++ii){printLine("Warning",warnings[ii])
printed_any=true}if(errors)for(var _ii=0;_ii<errors.length;++_ii){printLine("Error",errors[_ii])
printed_any=true}}if(!printed_any&&task.err)printLine("Error",task.err)
y+=PAD}if(server_error){x=0
font.drawSizedAligned(style_task,x,y,z,font_height,font.ALIGN.HLEFT,sub_w,0,"Server Error:")
y+=font_height
x+=font_height
printLine("Server error",server_error)}scroll_area.end(y)
y=scroll_y_start+min(max_h,y)
if(ui.buttonText({x:x0+w-ui.button_height,y:y0,z:Z.BUILD_ERRORS+1,w:ui.button_height,text:"X"}))server_error=gbstate=null
ui.panel({x:x0-PAD,y:y0-PAD,z:Z.BUILD_ERRORS-1,w:w+2*PAD,h:y-y0+2*PAD,color:color_panel})}function buildUIStartup(){if(net.client&&engine.DEBUG){net.client.onMsg("gbstate",onGBState)
net.client.onMsg("server_error",onServerError)
net.subs.on("connect",function(){var pak=net.client.pak("gbstate_enable")
pak.writeBool(true)
pak.send()})
engine.addTickFunc(buildUITick)}}

},{"../common/util.js":74,"../common/vmath.js":76,"./camera2d.js":7,"./engine.js":13,"./font.js":19,"./net.js":35,"./scroll_area.js":43,"./ui.js":57}],7:[function(require,module,exports){
"use strict"
exports.calcMap=calcMap
exports.canvasToVirtual=canvasToVirtual
exports.clipTestRect=clipTestRect
exports.data=void 0
exports.domDeltaToVirtual=domDeltaToVirtual
exports.domToCanvasRatio=domToCanvasRatio
exports.domToVirtual=domToVirtual
exports.h=h
exports.hReal=hReal
exports.htmlPos=htmlPos
exports.htmlSize=htmlSize
exports.pop=pop
exports.push=push
exports.render_viewport_w=exports.render_viewport_h=exports.render_offset_y_bottom=exports.render_offset_x=void 0
exports.safeAreaPadding=safeAreaPadding
exports.screenAspect=screenAspect
exports.set=set
exports.setAspectFixed=setAspectFixed
exports.setAspectFixed2=setAspectFixed2
exports.setDOMMapped=setDOMMapped
exports.setInputClipping=setInputClipping
exports.setNormalized=setNormalized
exports.setSafeAreaPadding=setSafeAreaPadding
exports.setScreen=setScreen
exports.shift=shift
exports.startup=startup
exports.tickCamera2D=tickCamera2D
exports.transformX=transformX
exports.transformY=transformY
exports.virtualToCanvas=virtualToCanvas
exports.virtualToDom=virtualToDom
exports.virtualToDomPosParam=virtualToDomPosParam
exports.virtualToFontSize=virtualToFontSize
exports.w=w
exports.wReal=wReal
exports.x0=x0
exports.x0Real=x0Real
exports.x1=x1
exports.x1Real=x1Real
exports.xScale=xScale
exports.y0=y0
exports.y0Real=y0Real
exports.y1=y1
exports.y1Real=y1Real
exports.yScale=yScale
exports.zoom=zoom
var assert=require("assert")
var engine=require("./engine.js")
var max=Math.max,round=Math.round
var safearea_pad=new Float32Array(4)
var data=new Float32Array(13)
exports.data=data
var screen_width
var screen_height
var render_width
var render_height
var render_viewport_w
exports.render_viewport_w=render_viewport_w
var render_viewport_h
exports.render_viewport_h=render_viewport_h
var render_offset_x
exports.render_offset_x=render_offset_x
var render_offset_y_top
var render_offset_y_bottom
exports.render_offset_y_bottom=render_offset_y_bottom
function reapply(){if(render_width){data[4]=render_width/(data[2]-data[0])
data[5]=render_height/(data[3]-data[1])
data[7]=(data[2]-data[0])/render_viewport_w
data[8]=(data[3]-data[1])/render_viewport_h}else{data[4]=screen_width/(data[2]-data[0])
data[5]=screen_height/(data[3]-data[1])}}function virtualToCanvas(dst,src){dst[0]=(src[0]-data[0])*data[4]
dst[1]=(src[1]-data[1])*data[5]}function transformX(x){return(x-data[0])*data[4]}function transformY(y){return(y-data[1])*data[5]}function canvasToVirtual(dst,src){dst[0]=src[0]/data[4]+data[0]
dst[1]=src[1]/data[5]+data[1]}function safeScreenWidth(){return max(1,screen_width-safearea_pad[0]-safearea_pad[1])}function safeScreenHeight(){return max(1,screen_height-safearea_pad[2]-safearea_pad[3])}function set(x0,y0,x1,y1,ignore_safe_area){assert(isFinite(x0))
assert(isFinite(y0))
assert(isFinite(x1))
assert(isFinite(y1))
if(ignore_safe_area||render_width){data[9]=data[0]=x0
data[10]=data[1]=y0
data[11]=data[2]=x1
data[12]=data[3]=y1}else{data[9]=x0
data[10]=y0
data[11]=x1
data[12]=y1
var wscale=(x1-x0)/safeScreenWidth()
var hscale=(y1-y0)/safeScreenHeight()
data[0]=x0-safearea_pad[0]*wscale
data[1]=y0-safearea_pad[2]*hscale
data[2]=x1+safearea_pad[1]*wscale
data[3]=y1+safearea_pad[3]*hscale}reapply()}function setSafeAreaPadding(left,right,top,bottom){safearea_pad[0]=round(left)
safearea_pad[1]=round(right)
safearea_pad[2]=round(top)
safearea_pad[3]=round(bottom)}function safeAreaPadding(){return safearea_pad}var stack=[]
function push(){stack.push(data.slice(0))}function pop(){var old=stack.pop()
for(var ii=0;ii<old.length;++ii)data[ii]=old[ii]
reapply()}function domToCanvasRatio(){return data[6]}function screenAspect(){return safeScreenWidth()/safeScreenHeight()}function setAspectFixed(w,h){var pa=render_width?1:engine.pixel_aspect
var inv_aspect=h/pa/w
var inv_desired_aspect
var screen_w
var screen_h
if(render_width){screen_w=render_width
screen_h=render_height}else{screen_w=safeScreenWidth()
screen_h=safeScreenHeight()}if(inv_aspect>(inv_desired_aspect=screen_h/screen_w)){var virtual_w=h/pa/inv_desired_aspect
var virtual_to_screen=screen_w/virtual_w
var margin=virtual_w-w
var left_margin=round(margin*virtual_to_screen/2)/virtual_to_screen
set(-left_margin,0,w+(margin-left_margin),h,false)}else{var virtual_h=w*pa*inv_desired_aspect
var _virtual_to_screen=screen_h/virtual_h
var _margin=virtual_h-h
var top_margin=round(_margin*_virtual_to_screen/2)/_virtual_to_screen
set(0,-top_margin,w,h+(_margin-top_margin),false)}}function setAspectFixed2(w,h){var pa=render_width?1:engine.pixel_aspect
var inv_aspect=h/pa/w
var inv_desired_aspect
if(render_width)inv_desired_aspect=render_height/render_width
else inv_desired_aspect=1/screenAspect()
if(inv_aspect>inv_desired_aspect)set(0,0,w+(h/pa/inv_desired_aspect-w),h,false)
else set(0,0,w,h+(w*pa*inv_desired_aspect-h),false)}function zoom(x,y,factor){var inv_factor=1/factor
set(x-(x-data[0])*inv_factor,y-(y-data[1])*inv_factor,x+(data[2]-x)*inv_factor,y+(data[3]-y)*inv_factor,true)}function shift(dx,dy){set(data[0]+dx,data[1]+dy,data[2]+dx,data[3]+dy,true)}function calcMap(out,src_rect,dest_rect){var cur_w=data[11]-data[9]
var cur_h=data[12]-data[10]
var vx0=(src_rect[0]-data[9])/cur_w
var vy0=(src_rect[1]-data[10])/cur_h
var vx1=(src_rect[2]-data[9])/cur_w
var vy1=(src_rect[3]-data[10])/cur_h
var vw=vx1-vx0
var vh=vy1-vy0
var dest_vw=dest_rect[2]-dest_rect[0]
var dest_vh=dest_rect[3]-dest_rect[1]
out[0]=dest_rect[0]-dest_vw/vw*vx0
out[1]=dest_rect[1]-dest_vh/vh*vy0
out[2]=dest_rect[2]+dest_vw/vw*(1-vx1)
out[3]=dest_rect[3]+dest_vh/vh*(1-vy1)
return out}function setNormalized(){set(0,0,1,1,true)}function setScreen(no_dpi_aware){if(render_width)set(0,0,render_width,render_height)
else if(no_dpi_aware)set(0,0,safeScreenWidth(),safeScreenHeight())
else set(0,0,safeScreenWidth()/engine.dom_to_canvas_ratio,safeScreenHeight()/engine.dom_to_canvas_ratio)}function setDOMMapped(){if(render_width)set(render_offset_x,render_offset_y_top,screen_width-render_offset_x,screen_height-render_offset_y_top,true)
else set(0,0,screen_width/engine.dom_to_canvas_ratio,screen_height/engine.dom_to_canvas_ratio,true)}function x0Real(){return data[0]}function y0Real(){return data[1]}function x1Real(){return data[2]}function y1Real(){return data[3]}function wReal(){return data[2]-data[0]}function hReal(){return data[3]-data[1]}function x0(){return data[9]}function y0(){return data[10]}function x1(){return data[11]}function y1(){return data[12]}function w(){return data[11]-data[9]}function h(){return data[12]-data[10]}function xScale(){return data[4]}function yScale(){return data[5]}function htmlPos(x,y){if(render_width)return[((x-data[0])/data[7]+render_offset_x)/screen_width*100,((y-data[1])/data[8]+render_offset_y_top)/screen_height*100]
else return[100*(x-data[0])/(data[2]-data[0]),100*(y-data[1])/(data[3]-data[1])]}function htmlSize(w,h){if(render_width)return[100*w/data[7]/screen_width,100*h/data[8]/screen_height]
else return[100*w/(data[2]-data[0]),100*h/(data[3]-data[1])]}var input_clipping
function setInputClipping(xywh){input_clipping=xywh}function domToVirtual(dst,src){var ret=true
if(input_clipping)if(src[0]<input_clipping[0]||src[0]>input_clipping[0]+input_clipping[2]||src[1]<input_clipping[1]||src[1]>input_clipping[1]+input_clipping[3])ret=false
if(render_width){dst[0]=(src[0]*data[6]-render_offset_x)*data[7]+data[0]
dst[1]=(src[1]*data[6]-render_offset_y_top)*data[8]+data[1]}else{dst[0]=src[0]*data[6]/data[4]+data[0]
dst[1]=src[1]*data[6]/data[5]+data[1]}return ret}function domDeltaToVirtual(dst,src){if(render_width){dst[0]=src[0]*data[6]*data[7]
dst[1]=src[1]*data[6]*data[8]}else{dst[0]=src[0]*data[6]/data[4]
dst[1]=src[1]*data[6]/data[5]}}var input_clipping_virtual=new Float32Array(4)
function updateVirtualInputClipping(){domToVirtual(input_clipping_virtual,input_clipping)
if(render_width){input_clipping_virtual[2]=input_clipping[2]*data[6]*data[7]
input_clipping_virtual[3]=input_clipping[3]*data[6]*data[8]}else{input_clipping_virtual[2]=input_clipping[2]*data[6]/data[4]
input_clipping_virtual[3]=input_clipping[3]*data[6]/data[5]}}function virtualToDom(dst,src){if(render_width){dst[0]=(render_offset_x+(src[0]-data[0])/data[7])/data[6]
dst[1]=(render_offset_y_top+(src[1]-data[1])/data[8])/data[6]}else{dst[0]=(src[0]-data[0])*data[4]/data[6]
dst[1]=(src[1]-data[1])*data[5]/data[6]}}function virtualToFontSize(height){if(render_width)return height/(data[6]*data[8])*.84
else return height*data[5]/data[6]*.84}function virtualToDomPosParam(dst,src){if(render_width){dst.x=(render_offset_x+(src.x-data[0])/data[7])/data[6]
dst.w=src.w/data[7]/data[6]
dst.y=(render_offset_y_top+(src.y-data[1])/data[8])/data[6]
dst.h=src.h/data[8]/data[6]}else{dst.x=(src.x-data[0])*data[4]/data[6]
dst.w=src.w*data[4]/data[6]
dst.y=(src.y-data[1])*data[5]/data[6]
dst.h=src.h*data[5]/data[6]}if(input_clipping){if(dst.x<input_clipping[0]){dst.w=max(0,dst.w-(input_clipping[0]-dst.x))
dst.x=input_clipping[0]}if(dst.y<input_clipping[1]){dst.h=max(0,dst.h-(input_clipping[1]-dst.y))
dst.y=input_clipping[1]}if(dst.x>input_clipping[0]+input_clipping[2])dst.w=0
if(dst.y>input_clipping[1]+input_clipping[3])dst.h=0}}function clipTestRect(rect){if(!input_clipping)return true
updateVirtualInputClipping()
var icv=input_clipping_virtual
if(rect.x>icv[0]+icv[2]||rect.x+rect.w<icv[0]||rect.y>icv[1]+icv[3]||rect.y+rect.h<icv[1])return false
if(rect.x<icv[0]){rect.w-=icv[0]-rect.x
rect.x=icv[0]}if(rect.y<icv[1]){rect.h-=icv[1]-rect.y
rect.y=icv[1]}if(rect.x+rect.w>icv[0]+icv[2])rect.w=icv[0]+icv[2]-rect.x
if(rect.y+rect.h>icv[1]+icv[3])rect.h=icv[1]+icv[3]-rect.y
return true}function tickCamera2D(){data[6]=engine.dom_to_canvas_ratio
screen_width=engine.width
screen_height=engine.height
var viewport=[0,0,screen_width,screen_height]
if(engine.render_width){render_width=engine.render_width
render_height=engine.render_height
var pa=engine.pixel_aspect
var inv_aspect=render_height/pa/render_width
var eff_screen_width=safeScreenWidth()
var eff_screen_height=safeScreenHeight()
var inv_desired_aspect=eff_screen_height/eff_screen_width
if(inv_aspect>inv_desired_aspect){var margin=(render_height/inv_desired_aspect-render_width*pa)/2*eff_screen_height/render_height
exports.render_offset_x=render_offset_x=safearea_pad[0]+round(margin)
render_offset_y_top=safearea_pad[2]
exports.render_offset_y_bottom=render_offset_y_bottom=safearea_pad[3]
exports.render_viewport_w=render_viewport_w=round(eff_screen_width-2*margin)
exports.render_viewport_h=render_viewport_h=eff_screen_height}else{var _margin3=(render_width*inv_desired_aspect-render_height/pa)/2*eff_screen_width/render_width
exports.render_offset_x=render_offset_x=safearea_pad[0]
render_offset_y_top=safearea_pad[2]+round(_margin3)
exports.render_offset_y_bottom=render_offset_y_bottom=safearea_pad[3]+round(_margin3)
exports.render_viewport_w=render_viewport_w=eff_screen_width
exports.render_viewport_h=render_viewport_h=round(eff_screen_height-2*_margin3)}viewport[2]=render_width
viewport[3]=render_height}else{render_width=render_height=0
exports.render_offset_x=render_offset_x=0
render_offset_y_top=0
exports.render_offset_y_bottom=render_offset_y_bottom=0}reapply()
engine.setViewport(viewport)}function startup(){screen_width=engine.width
screen_height=engine.height
set(0,0,engine.width,engine.height)
tickCamera2D()}

},{"./engine.js":13,"assert":undefined}],8:[function(require,module,exports){
"use strict"
exports.PLATFORM_WEB=exports.PLATFORM_MOBILE=exports.PLATFORM_IOS=exports.PLATFORM_FBINSTANT=exports.PLATFORM_ANDROID=exports.PLATFORM=exports.MODE_PRODUCTION=exports.MODE_DEVELOPMENT=void 0
exports.getAbilityReload=getAbilityReload
exports.setAbilityReload=setAbilityReload
var assert=require("assert")
var _glovCommonEnums=require("../common/enums")
var Platform=_glovCommonEnums.Platform
var isValidPlatform=_glovCommonEnums.isValidPlatform
assert(isValidPlatform(window.conf_platform))
var PLATFORM=window.conf_platform
var PLATFORM_WEB=(exports.PLATFORM=PLATFORM)===Platform.Web
exports.PLATFORM_WEB=PLATFORM_WEB
var PLATFORM_FBINSTANT=PLATFORM===Platform.FBInstant
exports.PLATFORM_FBINSTANT=PLATFORM_FBINSTANT
var PLATFORM_ANDROID=PLATFORM===Platform.Android
exports.PLATFORM_ANDROID=PLATFORM_ANDROID
var PLATFORM_IOS=PLATFORM===Platform.IOS
exports.PLATFORM_IOS=PLATFORM_IOS
var PLATFORM_MOBILE=PLATFORM_ANDROID||PLATFORM_IOS
exports.PLATFORM_MOBILE=PLATFORM_MOBILE
assert(PLATFORM_WEB||PLATFORM_FBINSTANT||PLATFORM_ANDROID||PLATFORM_IOS)
var MODE_DEVELOPMENT=(PLATFORM_WEB||PLATFORM_FBINSTANT)&&Boolean(String(document.location).match(/^https?:\/\/localhost/))
var MODE_PRODUCTION=!(exports.MODE_DEVELOPMENT=MODE_DEVELOPMENT)
exports.MODE_PRODUCTION=MODE_PRODUCTION
if(MODE_DEVELOPMENT){var _window$webkit,_window$webkit$messag
assert(PLATFORM_WEB||!window.FB)
assert(PLATFORM_FBINSTANT||!window.FBInstant)
assert(PLATFORM_ANDROID===Boolean(window.androidwrapper))
assert(PLATFORM_IOS===Boolean(null==(_window$webkit=window.webkit)?void 0:null==(_window$webkit$messag=_window$webkit.messageHandlers)?void 0:_window$webkit$messag.iosWrapper))}var ability_reload=PLATFORM_WEB
function getAbilityReload(){return ability_reload}function setAbilityReload(value){ability_reload=PLATFORM_WEB&&value}

},{"../common/enums":68,"assert":undefined}],9:[function(require,module,exports){
"use strict"
exports.cmd_parse=void 0
exports.resetSettings=resetSettings
exports.safearea=void 0
var cmd_parse_mod=require("../common/cmd_parse.js")
var local_storage=require("./local_storage.js")
var cmd_parse=cmd_parse_mod.create({storage:local_storage})
exports.cmd_parse=cmd_parse
var engine=require("./engine.js")
var _require=require("./error_report.js"),errorReportDetailsString=_require.errorReportDetailsString
var net=require("./net.js")
var netClient=net.netClient,netDisconnected=net.netDisconnected
var shaders=require("./shaders.js")
var textures=require("./textures.js")
var _require2=require("../common/wscommon.js"),netDelayGet=_require2.netDelayGet,netDelaySet=_require2.netDelaySet
window.cmd=function(str){cmd_parse.handle(null,str,cmd_parse_mod.defaultHandler)}
function byteFormat(bytes){if(bytes>85e4)return(bytes/1048576).toFixed(2)+"MB"
if(bytes>850)return(bytes/1024).toFixed(2)+"KB"
return bytes+"B"}cmd_parse.register({cmd:"texmem",help:"Displays texture memory usage",func:function func(str,resp_func){var keys=Object.keys(textures.textures);(keys=keys.filter(function(a){return textures.textures[a].gpu_mem>1024})).sort(function(a,b){return textures.textures[a].gpu_mem-textures.textures[b].gpu_mem})
resp_func(null,keys.map(function(a){return byteFormat(textures.textures[a].gpu_mem)+" "+a}).join("\n"))}})
cmd_parse.register({cmd:"gpumem",help:"Displays GPU memory usage summary",func:function func(str,resp_func){var gpu_mem=engine.perf_state.gpu_mem
resp_func(null,byteFormat(gpu_mem.geom)+" Geo\n"+byteFormat(gpu_mem.tex)+" Tex\n"+byteFormat(gpu_mem.geom+gpu_mem.tex)+" Total")}})
function validDefine(str){if(shaders.semantic[str])return false
return str.match(/^[A-Z][A-Z0-9_]*$/)}cmd_parse.register({cmd:"d",help:"Toggles a debug define",func:function func(str,resp_func){if(!(str=str.toUpperCase().trim()))if(engine.definesClearAll())return void resp_func(null,"All debug defines cleared")
else return void resp_func(null,"No debug defines active")
if(!validDefine(str))return void resp_func("Invalid define specified")
engine.defines[str]=!engine.defines[str]
resp_func(null,"D="+str+" now "+(engine.defines[str]?"SET":"unset"))
engine.definesChanged()}})
cmd_parse.register({cmd:"renderer",help:"Displays current renderer",func:function func(str,resp_func){resp_func(null,"Renderer=WebGL"+(engine.webgl2?2:1))}})
cmd_parse.register({cmd:"csr",access_run:["sysadmin"],help:"(Admin) Run a command as another user",usage:"$HELP\n  /csr UserID command\nExample: /csr jimbly gems -100",func:function func(str,resp_func){var idx=str.indexOf(" ")
if(-1===idx)return void resp_func("Invalid number of arguments")
var user_id=str.slice(0,idx)
var cmd=str.slice(idx+1)
var pak=net.subs.getChannelImmediate("user."+user_id).pak("csr_admin_to_user")
pak.writeJSON(cmd_parse.last_access)
pak.writeString(cmd)
pak.send(resp_func)}})
function cmdDesc(cmd_data){return"/"+cmd_data.cmd+" - "+cmd_data.help}cmd_parse.register({cmd:"help",help:"Searches commands",func:function func(str,resp_func){var list=cmd_parse.autoComplete("",this&&this.access)
if(str){var str_cname=cmd_parse.canonical(str)
var str_lc=str.toLowerCase()
list=list.filter(function(cmd_data){return-1!==cmd_data.cname.indexOf(str_cname)||-1!==cmd_data.help.toLowerCase().indexOf(str_lc)})}if(!list.length)return void resp_func(null,'No commands found matching "'+str+'"')
resp_func(null,list.map(cmdDesc).join("\n"))}})
var safearea=[-1,-1,-1,-1]
exports.safearea=safearea
cmd_parse.registerValue("safe_area",{label:"Safe Area",type:cmd_parse.TYPE_STRING,usage:"Safe Area value: Use -1 for auto based on browser environment,\nor 0-25 for percentage of screen size\n  Usage: /safe_area [value]\n  Usage: /safe_area horizontal,vertical\n  Usage: /safe_area left,right,top,bottom",default_value:"-1",get:function get(){return-1===safearea[0]?"-1 (auto)":safearea.join(",")},set:function set(v){var keys=(v=String(v)).split(",")
if(v&&1===keys.length)safearea[0]=safearea[1]=safearea[2]=safearea[3]=Number(v)
else if(2===keys.length){safearea[0]=safearea[1]=Number(keys[0])
safearea[2]=safearea[3]=Number(keys[1])}else if(4===keys.length)for(var ii=0;ii<4;++ii)safearea[ii]=Number(keys[ii])
for(var _ii=0;_ii<4;++_ii)if(!isFinite(safearea[_ii]))safearea[_ii]=-1},store:true})
cmd_parse.register({cmd:"webgl2_auto",help:"Resets WebGL2 auto-detection",func:function func(str,resp_func){if(!local_storage.getJSON("webgl2_disable"))return resp_func(null,"WebGL2 is already being auto-detected")
local_storage.setJSON("webgl2_disable",void 0)
return resp_func(null,"WebGL2 was disabled, will attempt to use it again on the next load")}})
cmd_parse.registerValue("postprocessing",{label:"Postprocessing",type:cmd_parse.TYPE_INT,help:"Enables/disables postprocessing",get:function get(){return engine.postprocessing?1:0},set:function set(v){return engine.postprocessingAllow(v)}})
cmd_parse.register({cmd:"net_delay",help:"Sets/shows network delay values",usage:"$HELP\n/net_delay time_base time_rand",func:function func(str,resp_func){if(str){var params=str.split(" ")
netDelaySet(Number(params[0]),Number(params[1])||0)}var cur=netDelayGet()
resp_func(null,"Client NetDelay: "+cur[0]+"+"+cur[1])}})
cmd_parse.register({cmd:"error_report_details",help:"Shows details submitted with any error report",access_show:["hidden"],func:function func(str,resp_func){resp_func(null,errorReportDetailsString())}})
cmd_parse.register({cmd:"disconnect",help:"Forcibly disconnect WebSocket connection (Note: will auto-reconnect)",func:function func(str,resp_func){var _netClient
var socket=null==(_netClient=netClient())?void 0:_netClient.socket
if(!socket)return void resp_func("No socket")
if(netDisconnected())return void resp_func("Not connected")
socket.close()
resp_func()}})
function resetSettings(){var results=cmd_parse.resetSettings()
if(engine.definesClearAll())results.push("Debug defines cleared")
if(!results.length)return null
results.push("Please restart the app or reload to page for the new settings to take effect.")
return results.join("\n")}cmd_parse.register({cmd:"reset_settings",help:"Resets all settings and options to their defaults (Note: requires an app restart)",func:function func(str,resp_func){resp_func(null,resetSettings()||"No stored settings to reset")}})

},{"../common/cmd_parse.js":65,"../common/wscommon.js":77,"./engine.js":13,"./error_report.js":15,"./local_storage.js":31,"./net.js":35,"./shaders.js":46,"./textures.js":55}],10:[function(require,module,exports){
"use strict"
exports.FACE_XYZ=exports.FACE_XY=exports.FACE_NONE=exports.FACE_FRUSTUM=exports.FACE_DEFAULT=exports.FACE_CAMERA=exports.BUCKET_OPAQUE=exports.BUCKET_DECAL=exports.BUCKET_ALPHA=void 0
exports.dynGeomAlloc=dynGeomAlloc
exports.dynGeomDrawAlpha=dynGeomDrawAlpha
exports.dynGeomDrawOpaque=dynGeomDrawOpaque
exports.dynGeomLookAt=dynGeomLookAt
exports.dynGeomQueueSprite=dynGeomQueueSprite
exports.dynGeomSpriteSetup=dynGeomSpriteSetup
exports.sprite3d_vshader=void 0
var BUCKET_OPAQUE=1
exports.BUCKET_OPAQUE=BUCKET_OPAQUE
var BUCKET_DECAL=2
exports.BUCKET_DECAL=BUCKET_DECAL
var BUCKET_ALPHA=3
exports.BUCKET_ALPHA=BUCKET_ALPHA
var FACE_NONE=0
exports.FACE_NONE=FACE_NONE
var FACE_XY=1
exports.FACE_XY=FACE_XY
var FACE_XYZ=2
exports.FACE_XYZ=FACE_XYZ
var FACE_FRUSTUM=4
exports.FACE_FRUSTUM=FACE_FRUSTUM
var FACE_CAMERA=8
exports.FACE_CAMERA=FACE_CAMERA
var FACE_DEFAULT=FACE_XY|FACE_FRUSTUM
exports.FACE_DEFAULT=FACE_DEFAULT
var DYN_VERT_SIZE=12
var assert=require("assert")
var mat4LookAt=require("gl-mat4/lookAt")
var _require=require("../common/util.js"),log2=_require.log2,nextHighestPowerOfTwo=_require.nextHighestPowerOfTwo
var _require2=require("../common/vmath.js"),mat4=_require2.mat4,v3addScale=_require2.v3addScale,v3copy=_require2.v3copy,v3cross=_require2.v3cross,v3iNormalize=_require2.v3iNormalize,v3scale=_require2.v3scale,v3sub=_require2.v3sub,vec3=_require2.vec3,zero_vec=_require2.zero_vec
var engine=require("./engine.js")
var engineStartupFunc=engine.engineStartupFunc,setGlobalMatrices=engine.setGlobalMatrices
var geom=require("./geom.js")
var ceil=Math.ceil,max=Math.max,min=Math.min
var shaders=require("./shaders.js")
var sprites=require("./sprites.js")
var BLEND_ALPHA=sprites.BLEND_ALPHA,blendModeReset=sprites.blendModeReset,blendModeSet=sprites.blendModeSet
var textures=require("./textures.js")
var cmpTextureArray=textures.cmpTextureArray
var mat_vp
var mat_view=mat4()
var geom_stats
var last_uid=0
var sprite_fshader
var sprite3d_vshader
exports.sprite3d_vshader=sprite3d_vshader
var sprite3d_shader_params={}
var buckets=[null,[],[],[]]
var TRI_QUAD=new Uint16Array([1,3,0,1,2,3])
var TRI_QUAD_DOUBLE=new Uint16Array([1,3,0,1,2,3,0,3,1,3,2,1])
var dyn_freelist=[]
function DynGeomData(){this.num_tris=0
this.tris=null
this.tri_pool_idx=0
this.num_verts=0
this.verts=null
this.vert_pool_idx=0
this.texs=null
this.shader=null
this.vshader=null
this.shader_params=null
this.blend=0
this.sort_z=0
this.uid=0}function dynGeomAlloc(){var ret
if(dyn_freelist.length)ret=dyn_freelist.pop()
else ret=new DynGeomData
return ret}DynGeomData.prototype.queue=function(bucket,sort_z){assert(isFinite(sort_z))
assert(this.texs)
assert(this.shader)
assert(this.vshader)
this.sort_z=sort_z
this.uid=++last_uid;++geom_stats.dyn
buckets[bucket].push(this)}
var vert_pool=new Array(15).join(",").split(",").map(function(){return[]})
vert_pool[0]=null
var tri_pool=new Array(15).join(",").split(",").map(function(){return[]})
tri_pool[0]=null
var POOL_UPPER_LIMIT=4096
var VERT_POOL_MAX_SIZE=vert_pool.map(function(a,idx){return min(POOL_UPPER_LIMIT,1<<14-idx)})
var TRI_POOL_MAX_SIZE=vert_pool.map(function(a,idx){return min(POOL_UPPER_LIMIT,1<<17-idx)})
DynGeomData.prototype.allocVerts=function(num_verts){this.num_verts=num_verts
var vert_pool_idx=log2(this.num_verts)
assert(vert_pool_idx>0)
this.vert_pool_idx=vert_pool_idx
var pool=vert_pool[this.vert_pool_idx]
if(pool&&pool.length)this.verts=pool.pop()
else{var alloc_num_verts=pool?nextHighestPowerOfTwo(num_verts):num_verts
this.verts=new Float32Array(DYN_VERT_SIZE*alloc_num_verts)}}
DynGeomData.prototype.allocTris=function(num_tris){this.num_tris=num_tris
var tri_pool_idx=log2(this.num_tris)
assert(tri_pool_idx>0)
this.tri_pool_idx=tri_pool_idx
var pool=tri_pool[this.tri_pool_idx]
if(pool&&pool.length)this.tris=pool.pop()
else{var alloc_num_tris=pool?nextHighestPowerOfTwo(num_tris):num_tris
this.tris=new Uint16Array(3*alloc_num_tris)}}
DynGeomData.prototype.alloc=function(num_verts,num_tris){this.allocVerts(num_verts)
this.allocTris(num_tris)}
DynGeomData.prototype.allocQuad=function(doublesided){this.allocVerts(4)
this.tris=doublesided?TRI_QUAD_DOUBLE:TRI_QUAD
this.num_tris=this.tris.length/3
this.tri_pool_idx=0}
DynGeomData.prototype.dispose=function(){var pool=vert_pool[this.vert_pool_idx]
if(pool&&pool.length<VERT_POOL_MAX_SIZE[this.vert_pool_idx])pool.push(this.verts)
this.verts=null
if((pool=tri_pool[this.tri_pool_idx])&&pool.length<TRI_POOL_MAX_SIZE[this.tri_pool_idx])pool.push(this.tris)
this.tris=null
dyn_freelist.push(this)}
var down=vec3()
var up=vec3()
var cam_down=vec3()
var cam_pos=vec3()
var right=vec3()
var forward=vec3()
function dynGeomLookAt(cam_pos_in,target_pos,up_in){v3copy(cam_pos,cam_pos_in)
v3copy(up,up_in)
v3scale(down,up,-1)
v3sub(forward,target_pos,cam_pos)
v3iNormalize(forward)
v3cross(right,forward,up)
v3iNormalize(right)
v3cross(cam_down,forward,right)
v3iNormalize(cam_down)
mat4LookAt(mat_view,cam_pos,target_pos,up)
setGlobalMatrices(mat_view)}var temp=vec3()
var xaxis=vec3(1,0,0)
var target_right=vec3()
function dynGeomSpriteSetup(params){var pos=params.pos,shader=params.shader,shader_params=params.shader_params,bucket=params.bucket,facing=params.facing,vshader=params.vshader
bucket=bucket||BUCKET_ALPHA
shader=shader||sprite_fshader
vshader=vshader||sprite3d_vshader
shader_params=shader_params||null
var my_right
var my_down
if((facing=void 0===facing?FACE_DEFAULT:facing)&FACE_XY){my_right=right
my_down=down}else if(facing&FACE_XYZ){my_right=right
my_down=cam_down}else{my_right=xaxis
my_down=down}if(my_right===right&&facing&FACE_CAMERA){v3sub(temp,pos,cam_pos)
v3cross(target_right,temp,up)
my_right=v3iNormalize(target_right)}return{bucket:bucket,my_right:my_right,my_down:my_down,sort_z:mat_vp[2]*pos[0]+mat_vp[6]*pos[1]+mat_vp[10]*pos[2]+mat_vp[14],shader:shader,vshader:vshader,shader_params:shader_params}}var pos0=vec3()
function dynGeomQueueSprite(sprite,params){var _dynGeomSpriteSetup=dynGeomSpriteSetup(params),bucket=_dynGeomSpriteSetup.bucket,my_right=_dynGeomSpriteSetup.my_right,my_down=_dynGeomSpriteSetup.my_down,sort_z=_dynGeomSpriteSetup.sort_z,shader=_dynGeomSpriteSetup.shader,vshader=_dynGeomSpriteSetup.vshader,shader_params=_dynGeomSpriteSetup.shader_params
var pos=params.pos,offs=params.offs,size=params.size,uvs=params.uvs,blend=params.blend,color=params.color,doublesided=params.doublesided
var elem=dynGeomAlloc()
color=color||sprite.color
offs=offs||zero_vec
elem.shader=shader
elem.vshader=vshader
elem.shader_params=shader_params
elem.texs=sprite.texs
elem.blend=blend||BLEND_ALPHA
doublesided=doublesided||false
var origin=sprite.origin
var w=size[0],h=size[1]
v3addScale(pos0,pos,my_right,-origin[0]*w+offs[0])
v3addScale(pos0,pos0,my_down,-origin[1]*h+offs[1])
elem.allocQuad(doublesided)
var verts=elem.verts
verts[0]=pos0[0]
verts[1]=pos0[1]
verts[2]=pos0[2]
verts[4]=color[0]
verts[5]=color[1]
verts[6]=color[2]
verts[7]=color[3]
verts[8]=uvs[0]
verts[9]=uvs[1]
verts[12]=pos0[0]+my_down[0]*h
verts[13]=pos0[1]+my_down[1]*h
verts[14]=pos0[2]+my_down[2]*h
verts[16]=color[0]
verts[17]=color[1]
verts[18]=color[2]
verts[19]=color[3]
verts[20]=uvs[0]
verts[21]=uvs[3]
verts[24]=pos0[0]+my_right[0]*w+my_down[0]*h
verts[25]=pos0[1]+my_right[1]*w+my_down[1]*h
verts[26]=pos0[2]+my_right[2]*w+my_down[2]*h
verts[28]=color[0]
verts[29]=color[1]
verts[30]=color[2]
verts[31]=color[3]
verts[32]=uvs[2]
verts[33]=uvs[3]
verts[36]=pos0[0]+my_right[0]*w
verts[37]=pos0[1]+my_right[1]*w
verts[38]=pos0[2]+my_right[2]*w
verts[40]=color[0]
verts[41]=color[1]
verts[42]=color[2]
verts[43]=color[3]
verts[44]=uvs[2]
verts[45]=uvs[1]
elem.queue(bucket,sort_z)}var batch_state
var sprite_geom
var sprite_buffer_vert
var sprite_buffer_vert_cur=0
var sprite_buffer_idx
var sprite_buffer_idx_cur=0
var sprite_buffer_idx_batch_start=0
var do_blending
var last_bound_shader
var last_bound_vshader
var MAX_VERT_ELEM_COUNT=65532*DYN_VERT_SIZE
var batches=[]
function commit(){if(sprite_buffer_idx_cur===sprite_buffer_idx_batch_start)return
batches.push({state:batch_state,start:sprite_buffer_idx_batch_start,end:sprite_buffer_idx_cur})
sprite_buffer_idx_batch_start=sprite_buffer_idx_cur}function commitAndFlush(){commit()
if(!batches.length)return
assert(sprite_buffer_idx_cur)
sprite_geom.updateIndex(sprite_buffer_idx,sprite_buffer_idx_cur)
var num_verts=sprite_buffer_vert_cur/DYN_VERT_SIZE
sprite_geom.update(sprite_buffer_vert,num_verts)
sprite_geom.bind()
geom_stats.tris+=sprite_buffer_idx_cur/3
geom_stats.verts+=num_verts
for(var ii=0;ii<batches.length;++ii){var batch=batches[ii]
var state=batch.state,start=batch.start,end=batch.end
if(last_bound_shader!==state.shader||last_bound_vshader!==state.vshader||state.shader_params){shaders.bind(state.vshader,state.shader,state.shader_params||sprite3d_shader_params)
last_bound_shader=state.shader
last_bound_vshader=state.vshader}if(do_blending)blendModeSet(state.blend)
textures.bindArray(state.texs);++geom_stats.draw_calls_dyn
gl.drawElements(sprite_geom.mode,end-start,gl.UNSIGNED_SHORT,2*start)}batches.length=0
sprite_buffer_idx_batch_start=sprite_buffer_idx_cur=sprite_buffer_vert_cur=0}function drawSetup(do_blend){do_blending=do_blend
last_bound_vshader=last_bound_shader=-1
if(!sprite_geom){sprite_geom=geom.create([[shaders.semantic.POSITION,gl.FLOAT,4,false],[shaders.semantic.COLOR,gl.FLOAT,4,false],[shaders.semantic.TEXCOORD,gl.FLOAT,4,false]],[],[],geom.TRIANGLES)
sprite_buffer_vert=new Float32Array(1024)
sprite_buffer_idx=new Uint16Array(1024)}}function drawElem(elem){if(!batch_state||cmpTextureArray(elem.texs,batch_state.texs)||elem.shader!==batch_state.shader||elem.vshader!==batch_state.vshader||elem.shader_params!==batch_state.shader_params||do_blending&&elem.blend!==batch_state.blend){commit()
batch_state=elem}var num_floats=elem.num_verts*DYN_VERT_SIZE
if(sprite_buffer_vert_cur+num_floats>sprite_buffer_vert.length){commitAndFlush()
if(sprite_buffer_vert.length!==MAX_VERT_ELEM_COUNT){var cur_tris=sprite_buffer_vert.length/DYN_VERT_SIZE/3
var new_length=min(3*ceil(1.25*cur_tris)*DYN_VERT_SIZE,MAX_VERT_ELEM_COUNT)
sprite_buffer_vert=new Float32Array(new_length)}}var num_idxs=3*elem.num_tris
if(sprite_buffer_idx_cur+num_idxs>sprite_buffer_idx.length){commitAndFlush()
var _cur_tris=sprite_buffer_idx.length/3
var _new_length=max(elem.tris.length,3*ceil(1.25*_cur_tris))
sprite_buffer_idx=new Uint16Array(_new_length)}var vidx0=sprite_buffer_vert_cur/DYN_VERT_SIZE
if(elem.verts.length===num_floats){sprite_buffer_vert.set(elem.verts,sprite_buffer_vert_cur)
sprite_buffer_vert_cur+=num_floats}else for(var ii=0;ii<num_floats;++ii)sprite_buffer_vert[sprite_buffer_vert_cur++]=elem.verts[ii]
for(var _ii=0;_ii<num_idxs;++_ii)sprite_buffer_idx[sprite_buffer_idx_cur++]=vidx0+elem.tris[_ii]}function finishDraw(){commitAndFlush()
blendModeReset()}function queueDraw(do_blend,queue,start_idx,end_idx){drawSetup(do_blend)
for(var ii=start_idx;ii<end_idx;++ii){var elem=queue[ii]
drawElem(elem)
elem.dispose()}finishDraw()}function cmpOpaue(a,b){var d=a.vshader.id-b.vshader.id
if(d)return d
if(d=a.shader.id-b.shader.id)return d
if(d=cmpTextureArray(a.texs,b.texs))return d
return a.uid-b.uid}function cmpAlpha(a,b){var d=b.sort_z-a.sort_z
if(d)return d
return a.uid-b.uid}function dynGeomDrawOpaque(){profilerStart("dynGeomDrawOpaque")
var queue=buckets[BUCKET_OPAQUE]
if(queue.length){queue.sort(cmpOpaue)
queueDraw(false,queue,0,queue.length)
queue.length=0}if((queue=buckets[BUCKET_DECAL]).length){queue.sort(cmpOpaue)
queueDraw(true,queue,0,queue.length)
queue.length=0}profilerStop("dynGeomDrawOpaque")}function dynGeomDrawAlpha(){profilerStart("dynGeomDrawAlpha")
assert(!buckets[BUCKET_OPAQUE].length)
assert(!buckets[BUCKET_DECAL].length)
var queue=buckets[BUCKET_ALPHA]
if(queue.length){queue.sort(cmpAlpha)
queueDraw(true,queue,0,queue.length)
queue.length=0}profilerStop("dynGeomDrawAlpha")}function dynGeomStartup(){geom_stats=geom.stats
exports.sprite3d_vshader=sprite3d_vshader=shaders.create("shaders/sprite3d.vp")
sprite_fshader=sprites.sprite_fshader
shaders.prelink(sprite3d_vshader,sprite_fshader)
mat_vp=engine.mat_vp}engineStartupFunc(dynGeomStartup)

},{"../common/util.js":74,"../common/vmath.js":76,"./engine.js":13,"./geom.js":21,"./shaders.js":46,"./sprites.js":51,"./textures.js":55,"assert":undefined,"gl-mat4/lookAt":undefined}],11:[function(require,module,exports){
"use strict"
exports.editBoxAnyActive=editBoxAnyActive
exports.editBoxCreate=editBoxCreate
exports.editBoxTick=editBoxTick
exports.create=editBoxCreate
var assert=require("assert")
var verify=require("../common/verify.js")
var camera2d=require("./camera2d.js")
var engine=require("./engine.js")
var _require=require("./input.js"),KEYS=_require.KEYS,eatAllKeyboardInput=_require.eatAllKeyboardInput,mouseConsumeClicks=_require.mouseConsumeClicks,keyDownEdge=_require.keyDownEdge,keyUpEdge=_require.keyUpEdge,pointerLockEnter=_require.pointerLockEnter,pointerLockExit=_require.pointerLockExit,pointerLocked=_require.pointerLocked,inputClick=_require.inputClick
var _require2=require("./localization.js"),getStringIfLocalizable=_require2.getStringIfLocalizable
var _require3=require("./spot.js"),SPOT_NAV_DOWN=_require3.SPOT_NAV_DOWN,SPOT_NAV_LEFT=_require3.SPOT_NAV_LEFT,SPOT_NAV_RIGHT=_require3.SPOT_NAV_RIGHT,SPOT_NAV_UP=_require3.SPOT_NAV_UP,spotFocusCheck=_require3.spotFocusCheck,spotFocusSteal=_require3.spotFocusSteal,spotUnfocus=_require3.spotUnfocus,spotlog=_require3.spotlog
var glov_ui=require("./ui.js")
var _require4=require("./ui.js"),uiGetDOMElem=_require4.uiGetDOMElem
var form_hook_registered=false
var active_edit_box
var active_edit_box_frame
var this_frame_edit_boxes=[]
var last_frame_edit_boxes=[]
function editBoxTick(){var expected_last_frame=engine.frame_index-1
for(var ii=0;ii<last_frame_edit_boxes.length;++ii){var edit_box=last_frame_edit_boxes[ii]
if(edit_box.last_frame<expected_last_frame)edit_box.unrun()}last_frame_edit_boxes=this_frame_edit_boxes
this_frame_edit_boxes=[]}function setActive(edit_box){active_edit_box=edit_box
active_edit_box_frame=engine.frame_index}function editBoxAnyActive(){return active_edit_box&&active_edit_box_frame>=engine.frame_index-1}function formHook(ev){ev.preventDefault()
if(!editBoxAnyActive())return
active_edit_box.submitted=true
active_edit_box.updateText()
if(active_edit_box.pointer_lock&&!active_edit_box.text)pointerLockEnter("edit_box_submit")}var last_key_id=0
var GlovUIEditBox=function(){function GlovUIEditBox(params){var _this$custom_nav
this.key="eb"+ ++last_key_id
this.x=0
this.y=0
this.z=Z.UI
this.w=glov_ui.button_width
this.type="text"
this.font_height=glov_ui.font_height
this.text=""
this.placeholder=""
this.max_len=0
this.zindex=null
this.uppercase=false
this.initial_focus=false
this.onetime_focus=false
this.auto_unfocus=false
this.initial_select=false
this.spellcheck=true
this.esc_clears=true
this.multiline=0
this.autocomplete=false
this.custom_nav=((_this$custom_nav={})[SPOT_NAV_LEFT]=null,_this$custom_nav[SPOT_NAV_RIGHT]=null,_this$custom_nav)
this.sticky_focus=true
this.applyParams(params)
assert.equal(typeof this.text,"string")
this.last_autocomplete=null
this.is_focused=false
this.elem=null
this.input=null
this.submitted=false
this.pointer_lock=false
this.last_frame=0
this.out={}}var _proto=GlovUIEditBox.prototype
_proto.applyParams=function applyParams(params){if(!params)return
for(var f in params)this[f]=params[f]
if(void 0===this.text)this.text=""
this.h=this.font_height
if(this.multiline&&void 0===this.custom_nav[SPOT_NAV_UP])this.custom_nav[SPOT_NAV_UP]=null
if(this.multiline&&void 0===this.custom_nav[SPOT_NAV_DOWN])this.custom_nav[SPOT_NAV_DOWN]=null}
_proto.updateText=function updateText(){this.text=this.input.value
if(this.max_len>0)this.text=this.text.slice(0,this.max_len)}
_proto.getText=function getText(){return this.text}
_proto.setText=function setText(new_text){new_text=String(new_text)
if(this.input)this.input.value=new_text
this.text=new_text}
_proto.focus=function focus(){if(this.input){this.input.focus()
setActive(this)}else this.onetime_focus=true
spotFocusSteal(this)
this.is_focused=true
if(this.pointer_lock&&pointerLocked())pointerLockExit()}
_proto.unfocus=function unfocus(){spotUnfocus()}
_proto.isFocused=function isFocused(){return this.is_focused}
_proto.updateFocus=function updateFocus(is_reset){var was_glov_focused=this.is_focused
var spot_ret=spotFocusCheck(this)
var focused=spot_ret.focused
var dom_focused=this.input&&document.activeElement===this.input
if(was_glov_focused!==focused){if(focused&&!dom_focused&&this.input){spotlog("GLOV focused, DOM not, focusing",this)
this.input.focus()}if(!focused&&dom_focused){spotlog("DOM focused, GLOV not, and changed, blurring",this)
this.input.blur()}}else if(dom_focused&&!focused){spotlog("DOM focused, GLOV not, stealing",this)
spotFocusSteal(this)
focused=true}else if(!dom_focused&&focused)if(is_reset){this.onetime_focus=true
spotlog("GLOV focused, DOM not, new edit box, focusing",this)}else if(document.activeElement===engine.canvas||document.activeElement===this.postspan){spotlog("GLOV focused, DOM canvas focused, unfocusing",this)
spotUnfocus()}if(focused){setActive(this)
var key_opt=this.pointer_lock&&!this.text?{in_event_cb:pointerLockEnter}:null
if(keyUpEdge(KEYS.ESC,key_opt))if(this.text&&this.esc_clears)this.setText("")
else{spotUnfocus()
if(this.input)this.input.blur()
focused=false
this.canceled=true}}this.is_focused=focused
return spot_ret}
_proto.run=function run(params){this.applyParams(params)
var is_reset=false
if(!verify(this.last_frame!==engine.frame_index))return null
if(this.last_frame!==engine.frame_index-1){this.submitted=false
is_reset=true}this.last_frame=engine.frame_index
this.canceled=false
var _this$updateFocus=this.updateFocus(is_reset),allow_focus=_this$updateFocus.allow_focus,focused=_this$updateFocus.focused
this_frame_edit_boxes.push(this)
var elem=allow_focus&&uiGetDOMElem(this.elem,true)
if(elem!==this.elem){if(elem){if(!form_hook_registered){form_hook_registered=true
var form=document.getElementById("dynform")
if(form)form.addEventListener("submit",formHook,true)}elem.textContent=""
var input=document.createElement(this.multiline?"textarea":"input")
input.setAttribute("type",this.type)
input.setAttribute("placeholder",getStringIfLocalizable(this.placeholder))
if(this.max_len)input.setAttribute("maxLength",this.max_len)
if(this.multiline)input.setAttribute("rows",this.multiline)
input.setAttribute("tabindex",2)
elem.appendChild(input)
var span=document.createElement("span")
span.setAttribute("tabindex",3)
this.postspan=span
elem.appendChild(span)
input.value=this.text
if(this.uppercase)input.style["text-transform"]="uppercase"
this.input=input
if(this.initial_focus||this.onetime_focus){input.focus()
setActive(this)
this.onetime_focus=false}if(this.initial_select)input.select()}else this.input=null
this.submitted=false
this.elem=elem}else if(this.input)this.updateText()
if(elem){var pos=camera2d.htmlPos(this.x,this.y)
if(!this.spellcheck)elem.spellcheck=false
elem.style.left=pos[0]+"%"
elem.style.top=pos[1]+"%"
var size=camera2d.htmlSize(this.w,0)
elem.style.width=size[0]+"%"
var old_fontsize=elem.style.fontSize||"?px"
var new_fontsize=camera2d.virtualToFontSize(this.font_height).toFixed(0)+"px"
if(new_fontsize!==old_fontsize)elem.style.fontSize=new_fontsize
if(this.zindex)elem.style["z-index"]=this.zindex
if(this.last_autocomplete!==this.autocomplete){this.last_autocomplete=this.autocomplete
this.input.setAttribute("autocomplete",this.autocomplete||"auto_off_"+Math.random())}}if(focused){if(this.auto_unfocus)if(inputClick({peek:true}))spotUnfocus()
if(keyDownEdge(KEYS.ENTER))this.submitted=true
eatAllKeyboardInput()}mouseConsumeClicks({x:this.x,y:this.y,w:this.w,h:this.h})
if(this.submitted){this.submitted=false
return this.SUBMIT}if(this.canceled){this.canceled=false
return this.CANCEL}return null}
_proto.unrun=function unrun(){this.elem=null
this.input=null}
return GlovUIEditBox}()
GlovUIEditBox.prototype.SUBMIT="submit"
GlovUIEditBox.prototype.CANCEL="cancel"
function editBoxCreate(params){return new GlovUIEditBox(params)}

},{"../common/verify.js":75,"./camera2d.js":7,"./engine.js":13,"./input.js":28,"./localization.js":32,"./spot.js":50,"./ui.js":57,"assert":undefined}],12:[function(require,module,exports){
"use strict"
exports.additiveMatrix=additiveMatrix
exports.applyColorMatrix=applyColorMatrix
exports.applyCopy=applyCopy
exports.applyGaussianBlur=applyGaussianBlur
exports.applyPixelyExpand=applyPixelyExpand
exports.brightnessAddMatrix=brightnessAddMatrix
exports.brightnessScaleMatrix=brightnessScaleMatrix
exports.clearAlpha=clearAlpha
exports.contrastMatrix=contrastMatrix
exports.effectsIsFinal=effectsIsFinal
exports.effectsPassAdd=effectsPassAdd
exports.effectsPassConsume=effectsPassConsume
exports.effectsQueue=effectsQueue
exports.effectsReset=effectsReset
exports.effectsStartup=effectsStartup
exports.effectsTopOfFrame=effectsTopOfFrame
exports.grayScaleMatrix=grayScaleMatrix
exports.hueMatrix=hueMatrix
exports.negativeMatrix=negativeMatrix
exports.registerShader=registerShader
exports.saturationMatrix=saturationMatrix
exports.sepiaMatrix=sepiaMatrix
function _extends(){return(_extends=Object.assign?Object.assign.bind():function(target){for(var i=1;i<arguments.length;i++){var source=arguments[i]
for(var key in source)if(Object.prototype.hasOwnProperty.call(source,key))target[key]=source[key]}return target}).apply(this,arguments)}var assert=require("assert")
var engine=require("./engine.js")
var renderWidth=engine.renderWidth,renderHeight=engine.renderHeight
var _require=require("./framebuffer.js"),framebufferEnd=_require.framebufferEnd,framebufferStart=_require.framebufferStart,framebufferTopOfFrame=_require.framebufferTopOfFrame
var geom=require("./geom.js")
var shaders=require("./shaders.js")
var _require2=require("./sprites.js"),spriteQueueFn=_require2.spriteQueueFn
var textures=require("./textures.js")
var _require3=require("../common/vmath.js"),vec2=_require3.vec2,vec3=_require3.vec3,vec4=_require3.vec4,v4set=_require3.v4set
var shader_data={vp_copy:{vp:"shaders/effects_copy.vp"},copy:{fp:"shaders/effects_copy.fp"},pixely_expand:{fp:"shaders/pixely_expand.fp"},gaussian_blur:{fp:"shaders/effects_gaussian_blur.fp"},color_matrix:{fp:"shaders/effects_color_matrix.fp"}}
function registerShader(key,obj){shader_data[key]=obj}function getShader(key){var elem=shader_data[key]
if(!elem.shader)if(elem.fp)elem.shader=shaders.create(elem.fp)
else elem.shader=shaders.create(elem.vp)
return elem.shader}var inited=false
var clip_space=vec4(2,2,-1,-1)
var copy_uv_scale=vec2(1,1)
var shader_params_default={clip_space:clip_space,copy_uv_scale:copy_uv_scale}
var shader_params_color_matrix
var shader_params_gaussian_blur
var shader_params_pixely_expand
var quad_geom
function startup(){inited=true
quad_geom=geom.create([[shaders.semantic.POSITION,gl.FLOAT,2,false]],new Float32Array([0,0,1,0,1,1,0,1]),null,geom.QUADS)
shader_params_color_matrix={clip_space:clip_space,copy_uv_scale:copy_uv_scale,colorMatrix:new Float32Array([0,0,0,0,0,0,0,0,0,0,0,0])}
shader_params_gaussian_blur={clip_space:clip_space,copy_uv_scale:copy_uv_scale,sampleRadius:vec3(1,1,1),Gauss:new Float32Array([.93,.8,.7,.6,.5,.4,.3,.2,.1])}
shader_params_pixely_expand={clip_space:clip_space,copy_uv_scale:copy_uv_scale,orig_pixel_size:vec4()}}var num_passes=0
function effectsPassAdd(){++num_passes}function effectsPassConsume(){assert(num_passes);--num_passes}function doEffect(fn){effectsPassConsume()
fn()}function effectsQueue(z,fn){effectsPassAdd()
spriteQueueFn(z,doEffect.bind(null,fn))}function effectsTopOfFrame(){num_passes=0
framebufferTopOfFrame()}function effectsReset(){assert.equal(num_passes,0)}function effectsIsFinal(){return!num_passes}function grayScaleMatrix(dst){dst[0]=.2126
dst[1]=.2126
dst[2]=.2126
dst[3]=.7152
dst[4]=.7152
dst[5]=.7152
dst[6]=.0722
dst[7]=.0722
dst[8]=.0722
dst[9]=dst[10]=dst[11]=0}function sepiaMatrix(dst){dst[0]=.393
dst[1]=.349
dst[2]=.272
dst[3]=.769
dst[4]=.686
dst[5]=.534
dst[6]=.189
dst[7]=.168
dst[8]=.131
dst[9]=dst[10]=dst[11]=0}function negativeMatrix(dst){dst[0]=dst[4]=dst[8]=-1
dst[1]=dst[2]=dst[3]=dst[5]=dst[6]=dst[7]=0
dst[9]=dst[10]=dst[11]=1}function saturationMatrix(dst,saturationScale){var is=1-saturationScale
dst[0]=.2126*is+saturationScale
dst[1]=.2126*is
dst[2]=.2126*is
dst[3]=.7152*is
dst[4]=.7152*is+saturationScale
dst[5]=.7152*is
dst[6]=.0722*is
dst[7]=.0722*is
dst[8]=.0722*is+saturationScale
dst[9]=dst[10]=dst[11]=0}function hueMatrix(dst,angle){var c=Math.cos(angle)
var s=Math.sin(angle)
dst[0]=.7874*c+-.3712362230889293*s+.2126
dst[1]=-.2126*c+.20611404610069642*s+.2126
dst[2]=-.2126*c+-.9485864922785551*s+.2126
dst[3]=-.7152*c+-.4962902913954023*s+.7152
dst[4]=.2848*c+.08105997779422341*s+.7152
dst[5]=-.7152*c+.6584102469838492*s+.7152
dst[6]=-.0722*c+.8675265144843316*s+.0722
dst[7]=-.0722*c+-.28717402389491986*s+.0722
dst[8]=.9278*c+.290176245294706*s+.0722
dst[9]=dst[10]=dst[11]=0}function brightnessAddMatrix(dst,brightnessOffset){dst[0]=dst[4]=dst[8]=1
dst[1]=dst[2]=dst[3]=dst[5]=dst[6]=dst[7]=0
dst[9]=dst[10]=dst[11]=brightnessOffset}function brightnessScaleMatrix(dst,scale){dst[0]=dst[4]=dst[8]=scale
dst[1]=dst[2]=dst[3]=dst[5]=dst[6]=dst[7]=0
dst[9]=dst[10]=dst[11]=0}function additiveMatrix(dst,additiveRGB){dst[0]=dst[4]=dst[8]=1
dst[1]=dst[2]=dst[3]=dst[5]=dst[6]=dst[7]=0
dst[9]=additiveRGB[0]
dst[10]=additiveRGB[1]
dst[11]=additiveRGB[2]}function contrastMatrix(dst,contrastScale){dst[0]=dst[4]=dst[8]=contrastScale
dst[1]=dst[2]=dst[3]=dst[5]=dst[6]=dst[7]=0
dst[9]=dst[10]=dst[11]=.5*(1-contrastScale)}function applyEffect(effect,view_w,view_h){var final=false!==effect.final&&effectsIsFinal()||effect.final
if(effect.no_framebuffer){var viewport=engine.viewport
var target_w=viewport[2]
var target_h=viewport[3]
view_h=view_h||target_h
clip_space[0]=2*(view_w=view_w||target_w)/target_w
clip_space[1]=2*view_h/target_h}else if(effect.viewport){var _viewport=effect.viewport
var _target_w=_viewport[2]
var _target_h=_viewport[3]
view_h=view_h||_target_h
clip_space[0]=2*(view_w=view_w||_target_w)/_target_w
clip_space[1]=2*view_h/_target_h
framebufferStart({clear:effect.clear,clear_all:effect.clear_all,clear_color:effect.clear_color,viewport:_viewport,final:final})}else{clip_space[0]=2
clip_space[1]=2
view_w=view_w||renderWidth()
view_h=view_h||renderHeight()
framebufferStart({width:view_w,height:view_h,final:final})}shaders.bind(getShader("vp_copy"),getShader(effect.shader),effect.params)
textures.bindArray(effect.texs)
quad_geom.draw()}function applyCopy(params){if(!inited)startup()
var source=params.source
if(!source)source=framebufferEnd({filter_linear:params.filter_linear,need_depth:params.need_depth})
params.shader=params.shader||"copy"
params.params=params.params?_extends({},shader_params_default,params.params):shader_params_default
if(Array.isArray(source))params.texs=source
else params.texs=[source]
applyEffect(params)}function applyPixelyExpand(params){if(!inited)startup()
var source=params.source
assert(!source)
if(!source)source=framebufferEnd({filter_linear:true})
var resx=source.width
var resy=source.height
var sampleRadius=(params.hblur||.25)/resx
shader_params_gaussian_blur.sampleRadius[0]=sampleRadius
shader_params_gaussian_blur.sampleRadius[1]=0
shader_params_gaussian_blur.sampleRadius[2]=1
applyEffect({shader:"gaussian_blur",params:shader_params_gaussian_blur,texs:[source],final:false},resx,resy)
var hblur=framebufferEnd({filter_linear:true})
sampleRadius=(params.vblur||.75)/resy
shader_params_gaussian_blur.sampleRadius[0]=0
shader_params_gaussian_blur.sampleRadius[1]=sampleRadius
shader_params_gaussian_blur.sampleRadius[2]=1
applyEffect({shader:"gaussian_blur",params:shader_params_gaussian_blur,texs:[hblur],final:false},resx,resy)
var vblur=framebufferEnd({filter_linear:true})
v4set(shader_params_pixely_expand.orig_pixel_size,source.width,source.height,1/source.width,1/source.height)
applyEffect({shader:"pixely_expand",params:shader_params_pixely_expand,texs:[source,hblur,vblur],clear:params.clear,clear_all:params.clear_all,clear_color:params.clear_color,viewport:params.viewport})}function applyGaussianBlur(params){if(!inited)startup()
var source=framebufferEnd({filter_linear:true})
var max_size=params.max_size||512
var min_size=params.min_size||128
var inputTexture0=source
var viewport=engine.viewport
var res=max_size
while(res>viewport[2]||res>viewport[3])res/=2
while(res>min_size){applyEffect({shader:params.shader_copy||"copy",params:shader_params_default,texs:[inputTexture0],final:false},res,res)
inputTexture0=framebufferEnd({filter_linear:true})
res/=2}var sampleRadius=(params.blur||1)/res
shader_params_gaussian_blur.sampleRadius[0]=sampleRadius
shader_params_gaussian_blur.sampleRadius[1]=0
shader_params_gaussian_blur.sampleRadius[2]=params.glow||1
applyEffect({shader:"gaussian_blur",params:shader_params_gaussian_blur,texs:[inputTexture0],final:false},res,res)
var blur=framebufferEnd({filter_linear:true})
shader_params_gaussian_blur.sampleRadius[0]=0
shader_params_gaussian_blur.sampleRadius[1]=sampleRadius
shader_params_gaussian_blur.sampleRadius[2]=params.glow||1
applyEffect({shader:"gaussian_blur",params:shader_params_gaussian_blur,texs:[blur]})
return true}function applyColorMatrix(params){if(!inited)startup()
var source=framebufferEnd({filter_linear:true})
var matrix=params.colorMatrix
var mout=shader_params_color_matrix.colorMatrix
mout[0]=matrix[0]
mout[1]=matrix[3]
mout[2]=matrix[6]
mout[3]=matrix[9]
mout[4]=matrix[1]
mout[5]=matrix[4]
mout[6]=matrix[7]
mout[7]=matrix[10]
mout[8]=matrix[2]
mout[9]=matrix[5]
mout[10]=matrix[8]
mout[11]=matrix[11]
applyEffect({shader:"color_matrix",params:shader_params_color_matrix,texs:[source]})
return true}function clearAlpha(){var old_dt=gl.getParameter(gl.DEPTH_TEST)
if(old_dt)gl.disable(gl.DEPTH_TEST)
gl.colorMask(false,false,false,true)
applyCopy({source:textures.textures.white,no_framebuffer:true})
gl.colorMask(true,true,true,true)
if(old_dt)gl.enable(gl.DEPTH_TEST)}function effectsStartup(prelink_effects){prelink_effects.forEach(function(name){shaders.prelink(getShader("vp_copy"),getShader(name))})}

},{"../common/vmath.js":76,"./engine.js":13,"./framebuffer.js":20,"./geom.js":21,"./shaders.js":46,"./sprites.js":51,"./textures.js":55,"assert":undefined}],13:[function(require,module,exports){
"use strict"
exports.ZNEAR=exports.ZFAR=exports.PERF_HISTORY_SIZE=exports.DEBUG=void 0
exports.addTickFunc=addTickFunc
exports.addViewSpaceGlobal=addViewSpaceGlobal
exports.canvas=exports.border_color=exports.border_clear_color=exports.app_state=exports.antialias_unavailable=exports.antialias=void 0
exports.clearHad3DThisFrame=clearHad3DThisFrame
exports.defineCausesReload=defineCausesReload
exports.defines=void 0
exports.definesChanged=definesChanged
exports.definesClearAll=definesClearAll
exports.disableRender=disableRender
exports.dom_to_canvas_ratio=void 0
exports.engineStartupFunc=engineStartupFunc
exports.fixNatives=fixNatives
exports.game_width=exports.game_height=exports.frame_timestamp=exports.frame_index=exports.frame_dt=exports.fov_y=exports.fov_x=exports.font=void 0
exports.getFrameDt=getFrameDt
exports.getFrameDtActual=getFrameDtActual
exports.getFrameIndex=getFrameIndex
exports.getFrameTimestamp=getFrameTimestamp
exports.getViewportPostprocess=getViewportPostprocess
exports.glCheckError=glCheckError
exports.hrtime=exports.hrnow=exports.height=exports.had_3d_this_frame=exports.glov_particles=void 0
exports.isInBackground=isInBackground
exports.light_dir_ws=exports.light_diffuse=exports.light_ambient=exports.is_loading=void 0
exports.loadsPending=loadsPending
exports.mat_vp=exports.mat_view=exports.mat_projection=void 0
exports.onEnterBackground=onEnterBackground
exports.onExitBackground=onExitBackground
exports.pixel_aspect=exports.perf_state=void 0
exports.postRender=postRender
exports.postTick=postTick
exports.postprocessing=void 0
exports.postprocessingAllow=postprocessingAllow
exports.preSpriteRender=preSpriteRender
exports.projectionZBias=projectionZBias
exports.releaseCanvas=releaseCanvas
exports.reloadSafe=reloadSafe
exports.removeTickFunc=removeTickFunc
exports.renderHeight=renderHeight
exports.renderWidth=renderWidth
exports.render_width=exports.render_height=void 0
exports.resizing=resizing
exports.setFOV=setFOV
exports.setFonts=setFonts
exports.setGameDims=setGameDims
exports.setGlobalMatrices=setGlobalMatrices
exports.setMatVP=setMatVP
exports.setPixelyStrict=setPixelyStrict
exports.setState=setState
exports.setViewport=setViewport
exports.setViewportPostprocess=setViewportPostprocess
exports.setZRange=setZRange
exports.setupProjection=setupProjection
exports.start3DRendering=start3DRendering
exports.startSpriteRendering=startSpriteRendering
exports.startup=startup
exports.stateActive=stateActive
exports.updateMatrices=updateMatrices
exports.width=exports.webgl2=exports.viewport=void 0
require("./bootstrap.js")
var client_config=require("./client_config.js")
var DEBUG=client_config.MODE_DEVELOPMENT
exports.DEBUG=DEBUG
var startup_funcs=[]
exports.require=require
require("not_worker")
var assert=require("assert")
var _require=require("./browser.js"),is_ios_safari=_require.is_ios_safari
var _require2=require("./build_ui.js"),buildUIStartup=_require2.buildUIStartup
var camera2d=require("./camera2d.js")
var cmds=require("./cmds.js")
var effects=require("./effects.js")
var effectsReset=effects.effectsReset,effectsTopOfFrame=effects.effectsTopOfFrame,effectsIsFinal=effects.effectsIsFinal,effectsPassAdd=effects.effectsPassAdd,effectsPassConsume=effects.effectsPassConsume
var _require3=require("./error_report.js"),errorReportDisable=_require3.errorReportDisable,errorReportSetTimeAccum=_require3.errorReportSetTimeAccum,errorReportSetDetails=_require3.errorReportSetDetails,glovErrorReportDisableSubmit=_require3.glovErrorReportDisableSubmit,glovErrorReportSetCrashCB=_require3.glovErrorReportSetCrashCB
var glov_font=require("./font.js")
var fontTick=glov_font.fontTick
var _require4=require("./framebuffer.js"),framebufferStart=_require4.framebufferStart,framebufferEndOfFrame=_require4.framebufferEndOfFrame
var geom=require("./geom.js")
var input=require("./input.js")
var local_storage=require("./local_storage.js")
var mat3FromMat4=require("gl-mat3/fromMat4")
var mat4Copy=require("gl-mat4/copy")
var mat4Invert=require("gl-mat4/invert")
var mat4Mul=require("gl-mat4/multiply")
var mat4Transpose=require("gl-mat4/transpose")
var mat4Perspective=require("gl-mat4/perspective")
var asin=Math.asin,cos=Math.cos,floor=Math.floor,min=Math.min,max=Math.max,PI=Math.PI,round=Math.round,sin=Math.sin,sqrt=Math.sqrt
var models=require("./models.js")
var perf=require("./perf.js")
var _require5=require("./profiler.js"),profilerFrameStart=_require5.profilerFrameStart,profilerGarbageEstimate=_require5.profilerGarbageEstimate
var _require6=require("./profiler_ui.js"),profilerUIStartup=_require6.profilerUIStartup
var _require7=require("../common/perfcounters.js"),perfCounterTick=_require7.perfCounterTick
var settings=require("./settings.js")
var shaders=require("./shaders.js")
var _require8=require("./shader_debug_ui.js"),shaderDebugUIStartup=_require8.shaderDebugUIStartup
var _require9=require("./sound.js"),soundLoading=_require9.soundLoading,soundStartup=_require9.soundStartup,soundTick=_require9.soundTick
var _require10=require("./spot.js"),spotEndInput=_require10.spotEndInput
var _require11=require("./sprites.js"),blendModeReset=_require11.blendModeReset,spriteDraw=_require11.spriteDraw,spriteStartup=_require11.spriteStartup
var textures=require("./textures.js")
var texturesTick=textures.texturesTick
var glov_transition=require("./transition.js")
var _require12=require("./ui.js"),drawRect=_require12.drawRect,_require12$internal=_require12.internal,cleanupDOMElems=_require12$internal.cleanupDOMElems,uiEndFrame=_require12$internal.uiEndFrame,uiSetFonts=_require12$internal.uiSetFonts,uiStartup=_require12$internal.uiStartup,uiTick=_require12$internal.uiTick,uiBindSounds=_require12.uiBindSounds
var urlhash=require("./urlhash.js")
var _require13=require("../common/util.js"),callEach=_require13.callEach,clamp=_require13.clamp,nearSame=_require13.nearSame,ridx=_require13.ridx
var verify=require("../common/verify.js")
var _require14=require("../common/vmath.js"),mat3=_require14.mat3,mat4=_require14.mat4,vec3=_require14.vec3,vec4=_require14.vec4,v3mulMat4=_require14.v3mulMat4,v3iNormalize=_require14.v3iNormalize,v4copy=_require14.v4copy,v4same=_require14.v4same,v4set=_require14.v4set
var canvas
exports.canvas=canvas
var webgl2
exports.webgl2=webgl2
var glov_particles
exports.glov_particles=glov_particles
var width
exports.width=width
var height
exports.height=height
var width_3d
var height_3d
var pixel_aspect=1
exports.pixel_aspect=pixel_aspect
var dom_to_canvas_ratio=window.devicePixelRatio||1
exports.dom_to_canvas_ratio=dom_to_canvas_ratio
var antialias
exports.antialias=antialias
var antialias_unavailable
exports.antialias_unavailable=antialias_unavailable
var game_width
exports.game_width=game_width
var game_height
exports.game_height=game_height
var game_aspect
var render_width
exports.render_width=render_width
var render_height
exports.render_height=render_height
var defines=urlhash.register({key:"D",type:urlhash.TYPE_SET,change:definesChanged})
exports.defines=defines
var ZFAR
exports.ZFAR=ZFAR
var ZNEAR
exports.ZNEAR=ZNEAR
var fov_y=1
exports.fov_y=fov_y
var fov_x=1
exports.fov_x=fov_x
var mat_projection=mat4()
exports.mat_projection=mat_projection
var mat_view=mat4()
exports.mat_view=mat_view
var mat_m=mat4()
var mat_vp=mat4()
exports.mat_vp=mat_vp
var mat_mv=mat4()
var mat_mv_no_skew=mat4()
var mat_mvp=mat4()
var mat_mv_inv_transform=mat3()
var mat_inv_view=mat3()
var light_diffuse=vec3(.75,.75,.75)
exports.light_diffuse=light_diffuse
var light_ambient=vec3(.25,.25,.25)
exports.light_ambient=light_ambient
var light_dir_ws=vec3(-1,-2,-3)
exports.light_dir_ws=light_dir_ws
var font
exports.font=font
var app_state=null
exports.app_state=app_state
var border_color=vec4(0,0,0,1)
exports.border_color=border_color
var border_clear_color=vec4(0,0,0,1)
exports.border_clear_color=border_clear_color
var no_render=false
function disableRender(new_value){if(no_render=new_value)cleanupDOMElems()}var view_space_globals=[]
function addViewSpaceGlobal(name){var ws_name=name+"_ws"
var ws_vec=shaders.globals[ws_name]
assert(ws_vec)
assert.equal(ws_vec.length,3)
var vs_name=name+"_vs"
var vs_vec=vec3()
shaders.addGlobal(vs_name,vs_vec)
view_space_globals.push({vs:vs_vec,ws:ws_vec})}var mat_temp=mat4()
function setGlobalMatrices(_mat_view){mat4Copy(mat_view,_mat_view)
mat4Mul(mat_vp,mat_projection,mat_view)
v3iNormalize(light_dir_ws)
for(var ii=0;ii<view_space_globals.length;++ii){var vsg=view_space_globals[ii]
v3mulMat4(vsg.vs,vsg.ws,mat_view)}mat4Invert(mat_temp,mat_view)
mat3FromMat4(mat_inv_view,mat_temp)}function setMatVP(_mat_view){setupProjection(fov_y,width_3d,height_3d,ZNEAR,ZFAR)
mat4Copy(mat_view,_mat_view)
mat4Mul(mat_vp,mat_projection,mat_view)}function setFOV(fov_min){var aspect=width_3d/height_3d
if(aspect>game_aspect){exports.fov_y=fov_y=fov_min
var rise=sin(fov_y/2)/cos(fov_y/2)*aspect
exports.fov_x=fov_x=2*asin(rise/sqrt(rise*rise+1))}else{var _rise=sin(fov_min/2)/cos(fov_min/2)*game_aspect
exports.fov_x=fov_x=2*asin(_rise/sqrt(_rise*_rise+1))
var rise2=sin(fov_x/2)/cos(fov_x/2)/aspect
exports.fov_y=fov_y=2*asin(rise2/sqrt(rise2*rise2+1))}}function setGameDims(w,h){exports.game_width=game_width=w
exports.game_height=game_height=h
game_aspect=game_width/game_height}var postprocessing_reset_version="5"
var postprocessing=local_storage.get("glov_no_postprocessing")!==postprocessing_reset_version
exports.postprocessing=postprocessing
function postprocessingAllow(allow){local_storage.set("glov_no_postprocessing",allow?void 0:postprocessing_reset_version)
exports.postprocessing=postprocessing=allow}function glCheckError(){var gl_err=gl.getError()
if(gl_err){console.error(gl_err)
throw new Error(gl_err)}}function releaseCanvas(){try{if(gl){var ext=gl.getExtension("WEBGL_lose_context")
if(ext)ext.loseContext()}}catch(ignored){}}function reloadSafe(){errorReportDisable()
releaseCanvas()
if(window.FBInstant)try{window.top.location.reload()}catch(e){window.FBInstant.quit()}else document.location.reload()}window.reloadSafe=reloadSafe
var reloading_defines={}
function defineCausesReload(define){reloading_defines[define]=defines[define]}defineCausesReload("FORCEWEBGL2")
defineCausesReload("NOWEBGL2")
function definesChanged(){for(var key in reloading_defines)if(defines[key]!==reloading_defines[key]){urlhash.onURLChange(reloadSafe)
break}shaders.handleDefinesChanged()}function definesClearAll(){var any_changed=false
for(var key in defines){defines[key]=false
any_changed=true}if(any_changed)definesChanged()
return any_changed}function normalizeRow(m,idx){var len=m[idx]*m[idx]+m[idx+1]*m[idx+1]+m[idx+2]*m[idx+2]
if(len>0){len=1/sqrt(len)
m[idx]*=len
m[idx+1]*=len
m[idx+2]*=len}}function updateMatrices(mat_model){mat4Copy(mat_m,mat_model)
mat4Mul(mat_mv,mat_view,mat_model)
mat4Mul(mat_mvp,mat_projection,mat_mv)
mat4Copy(mat_temp,mat_model)
normalizeRow(mat_temp,0)
normalizeRow(mat_temp,4)
normalizeRow(mat_temp,8)
mat4Mul(mat_mv_no_skew,mat_view,mat_temp)
mat4Invert(mat_temp,mat_mv_no_skew)
mat4Transpose(mat_temp,mat_temp)
mat3FromMat4(mat_mv_inv_transform,mat_temp)}var frame_timestamp=0
exports.frame_timestamp=frame_timestamp
function getFrameTimestamp(){return frame_timestamp}var frame_index=0
exports.frame_index=frame_index
function getFrameIndex(){return frame_index}var frame_dt=0
exports.frame_dt=frame_dt
function getFrameDt(){return frame_dt}var hrtime=0
exports.hrtime=hrtime
var this_frame_time_actual=0
function getFrameDtActual(){return this_frame_time_actual}var after_loading_state=null
var is_loading=true
exports.is_loading=is_loading
function setState(new_state){if(is_loading)after_loading_state=new_state
else exports.app_state=app_state=new_state}function stateActive(test_state){if(is_loading)return after_loading_state===test_state
else return app_state===test_state}var mspf=1e3
var mspf_update_time=0
var mspf_frame_count=0
var last_tick_cpu=0
var mspf_tick=1e3
var mspf_tick_accum=0
var garbage_estimate=0
var PERF_HISTORY_SIZE=128
exports.PERF_HISTORY_SIZE=PERF_HISTORY_SIZE
var perf_state=window.glov_perf_state={fpsgraph:{index:0,history:new Float32Array(2*PERF_HISTORY_SIZE)},gpu_mem:{tex:0,geom:0}}
var fpsgraph=(exports.perf_state=perf_state).fpsgraph
perf.addMetric({name:"fps",show_stat:"show_fps",show_graph:"fps_graph",labels:{"fps: ":function fps(){return(1e3/mspf).toFixed(1)},"ms/f: ":function msF(){return mspf.toFixed(0)},"cpu: ":function cpu(){return mspf_tick.toFixed(0)},"gc/f: ":function gcF(){return garbage_estimate?garbage_estimate.toFixed(1):""}},data:fpsgraph,line_scale_top:50,colors:[vec4(1,.925,.153,1),vec4(0,.894,.212,1)]},true)
var do_borders=true
var do_viewport_postprocess=false
var need_repos=0
function resizing(){return need_repos}var app_tick_functions=[]
function addTickFunc(cb){app_tick_functions.push(cb)}function removeTickFunc(cb){var idx=app_tick_functions.indexOf(cb)
if(-1!==idx){app_tick_functions.splice(idx,1)
return true}return false}var post_tick=[]
function postTick(opts){opts.ticks=opts.ticks||1
opts.inactive=opts.inactive||false
assert.equal(typeof opts.fn,"function")
post_tick.push(opts)}var pre_sprite_render=null
function preSpriteRender(fn){if(!pre_sprite_render)pre_sprite_render=[]
pre_sprite_render.push(fn)}var post_render=null
function postRender(fn){if(!post_render)post_render=[]
post_render.push(fn)}function resetEffects(){effectsReset()
framebufferEndOfFrame()}function renderWidth(){return render_width||width}function renderHeight(){return render_height||height}var SAFARI_FULLSCREEN_ASPECT=function(){var screen=window.screen
if(!is_ios_safari||!screen)return 0
return{"896,414":896/414,"812,375":812/375,"736,414":736/414,"716,414":736/414,"667,375":667/375,"647,375":667/375,"548,320":1.775}[max(screen.availWidth,screen.availHeight)+","+min(screen.availWidth,screen.availHeight)]||0}()
function safariTopSafeArea(view_w,view_h){if(SAFARI_FULLSCREEN_ASPECT&&nearSame(view_w/view_h,SAFARI_FULLSCREEN_ASPECT,.001))return 50*(window.devicePixelRatio||1)
return 0}var last_canvas_width
var last_canvas_height
var last_body_height
var safearea_elem
var safearea_ignore_bottom=false
var safearea_values=[0,0,0,0]
var last_safearea_values=[0,0,0,0]
function checkResize(){profilerStart("checkResize")
var vv=window.visualViewport||{}
exports.dom_to_canvas_ratio=dom_to_canvas_ratio=window.devicePixelRatio||1
exports.dom_to_canvas_ratio=dom_to_canvas_ratio*=settings.render_scale_all
var view_w=vv.width||window.innerWidth
var view_h=vv.height||window.innerHeight
if(view_h!==last_body_height){last_body_height=view_h
if(document.body)document.body.style.height=view_h+"px"}var rect=canvas.getBoundingClientRect()
var new_width=round(rect.width*dom_to_canvas_ratio)||1
var new_height=round(rect.height*dom_to_canvas_ratio)||1
if(-1===cmds.safearea[0]){if(safearea_elem){var sa_width=safearea_elem.offsetWidth
var sa_height=safearea_elem.offsetHeight
if(sa_width&&sa_height)v4set(safearea_values,safearea_elem.offsetLeft*dom_to_canvas_ratio,new_width-(sa_width+safearea_elem.offsetLeft)*dom_to_canvas_ratio,max(safearea_elem.offsetTop*dom_to_canvas_ratio,safariTopSafeArea(view_w,view_h)*settings.render_scale_all),safearea_ignore_bottom?0:new_height-(sa_height+safearea_elem.offsetTop)*dom_to_canvas_ratio)}}else v4set(safearea_values,new_width*clamp(cmds.safearea[0],0,25)/100,new_width*clamp(cmds.safearea[1],0,25)/100,new_height*clamp(cmds.safearea[2],0,25)/100,new_height*clamp(cmds.safearea[3],0,25)/100)
if(!v4same(safearea_values,last_safearea_values)){v4copy(last_safearea_values,safearea_values)
camera2d.setSafeAreaPadding(safearea_values[0],safearea_values[1],safearea_values[2],safearea_values[3])
need_repos=max(need_repos,1)}if(new_width!==last_canvas_width||new_height!==last_canvas_height){window.pixel_scale=dom_to_canvas_ratio
last_canvas_width=canvas.width=new_width||1
last_canvas_height=canvas.height=new_height||1
exports.width=width=canvas.width
exports.height=height=canvas.height
need_repos=10}if(is_ios_safari&&(window.visualViewport||need_repos))window.scroll(0,0)
profilerStop("checkResize")}var viewport=vec4(0,0,1,1)
exports.viewport=viewport
function setViewport(xywh){v4copy(viewport,xywh)
gl.viewport(xywh[0],xywh[1],xywh[2],xywh[3])}var frames_requested=0
function requestFrame(user_time){var max_fps=settings.max_fps
var desired_frames=max_fps>=250?10:1
if(frames_requested>=desired_frames)return
if(defines.SLOWLOAD&&is_loading)max_fps=2
if(desired_frames>1)while(frames_requested<desired_frames){setTimeout(tick,1)
frames_requested++}else if(max_fps){var desired_delay=max(0,round(1e3/max_fps-(user_time||0)))
frames_requested++
setTimeout(tick,desired_delay)}else{frames_requested++
requestAnimationFrame(tick)}}var mat_projection_10
var had_3d_this_frame
exports.had_3d_this_frame=had_3d_this_frame
function clearHad3DThisFrame(){exports.had_3d_this_frame=had_3d_this_frame=false}function setupProjection(use_fov_y,use_width,use_height,znear,zfar){mat4Perspective(mat_projection,use_fov_y,use_width/use_height,znear,zfar)
mat_projection_10=mat_projection[10]}function setZRange(znear,zfar){exports.ZNEAR=ZNEAR=znear
exports.ZFAR=ZFAR=zfar
if(had_3d_this_frame)setupProjection(fov_y,width_3d,height_3d,ZNEAR,ZFAR)}function set3DRenderResolution(w,h){width_3d=w
height_3d=h}var want_render_scale_3d_this_frame
var had_render_scale_3d_this_frame
function start3DRendering(opts){if((opts=opts||{}).width)set3DRenderResolution(opts.width,opts.height)
setFOV(opts.fov||settings.fov*PI/180)
exports.had_3d_this_frame=had_3d_this_frame=true
if(!opts.width&&want_render_scale_3d_this_frame&&!defines.NOCOPY){had_render_scale_3d_this_frame=true
effectsPassAdd()}blendModeReset(true)
gl.enable(gl.BLEND)
gl.enable(gl.DEPTH_TEST)
gl.depthMask(true)
var backbuffer_width=width_3d
var backbuffer_height=height_3d
if(opts.viewport){backbuffer_width=render_width||width
backbuffer_height=render_height||height}framebufferStart({width:backbuffer_width,height:backbuffer_height,final:effectsIsFinal(),need_depth:opts.need_depth||true,clear:true,clear_all:void 0===opts.clear_all?settings.render_scale_clear:opts.clear_all,viewport:opts.viewport})
setupProjection(fov_y,width_3d,height_3d,ZNEAR,ZFAR)
gl.enable(gl.CULL_FACE)}function renderScaleFinish(){if(defines.NOCOPY){gl.disable(gl.SCISSOR_TEST)
v4set(viewport,0,0,width,height)
gl.viewport(viewport[0],viewport[1],viewport[2],viewport[3])}else{effectsPassConsume()
if(2===settings.render_scale_mode)effects.applyPixelyExpand({final:effectsIsFinal(),clear:false})
else effects.applyCopy({filter_linear:0===settings.render_scale_mode})}}function startSpriteRendering(){gl.disable(gl.CULL_FACE)
blendModeReset(true)
gl.enable(gl.BLEND)
gl.disable(gl.DEPTH_TEST)
gl.depthMask(false)}function projectionZBias(dist,at_z){if(!dist){mat_projection[10]=mat_projection_10
return}var e=dist/(at_z*(at_z+dist))*.2
e=max(e,2e-7)
mat_projection[10]=mat_projection_10+e}function fixNatives(is_startup){var b=[]
for(var a in b){console[is_startup?"log":"error"]('Found invasive enumerable property "'+a+'" on Array.prototype, removing...')
var old_val=b[a]
errorReportSetDetails("had_native_"+a,typeof old_val)
delete Array.prototype[a]
Object.defineProperty(Array.prototype,a,{value:old_val,enumerable:false})}for(var _a in b)assert(false,"Array.prototype has unremovable member "+_a)}function resetState(){profilerStart("resetState")
profilerStart("textures")
textures.texturesResetState()
profilerStopStart("shaders")
shaders.shadersResetState()
profilerStopStart("geom;gl")
geom.geomResetState()
blendModeReset(true)
gl.enable(gl.BLEND)
gl.enable(gl.DEPTH_TEST)
gl.depthMask(true)
gl.enable(gl.CULL_FACE)
gl.depthFunc(gl.LEQUAL)
gl.disable(gl.SCISSOR_TEST)
gl.cullFace(gl.BACK)
gl.viewport(0,0,width,height)
profilerStop()
profilerStop("resetState")}var in_background=false
var enter_background_cb=[]
var exit_background_cb=[]
function isInBackground(){return in_background}function onEnterBackground(fn){enter_background_cb.push(fn)}function onExitBackground(fn){exit_background_cb.push(fn)}var hrnow=window.performance?window.performance.now.bind(window.performance):Date.now.bind(Date)
exports.hrnow=hrnow
var last_tick=0
function tick(timestamp){profilerFrameStart()
profilerStart("tick")
profilerStart("top")
frames_requested--
exports.hrtime=hrtime=hrnow()
var now=round(hrtime)
if(!last_tick)last_tick=now
var dt=min(max(this_frame_time_actual=now-last_tick,1),250)
exports.frame_dt=frame_dt=dt
last_tick=now
exports.frame_timestamp=frame_timestamp+=dt
exports.frame_index=++frame_index
errorReportSetTimeAccum(frame_timestamp)
fixNatives(false)
fpsgraph.history[fpsgraph.index%PERF_HISTORY_SIZE*2+1]=this_frame_time_actual
fpsgraph.index++
fpsgraph.history[fpsgraph.index%PERF_HISTORY_SIZE*2+0]=0;++mspf_frame_count
mspf_tick_accum+=last_tick_cpu
if(now-mspf_update_time>1e3*settings.fps_window)if(!mspf_update_time)mspf_update_time=now
else{mspf=(now-mspf_update_time)/mspf_frame_count
mspf_tick=mspf_tick_accum/mspf_frame_count
mspf_tick_accum=0
garbage_estimate=profilerGarbageEstimate()/1024
mspf_frame_count=0
mspf_update_time=now}perfCounterTick(dt)
effectsTopOfFrame()
if(document.hidden||document.webkitHidden||no_render){resetEffects()
input.tickInputInactive()
last_tick_cpu=0
for(var ii=post_tick.length-1;ii>=0;--ii)if(post_tick[ii].inactive&&!--post_tick[ii].ticks){post_tick[ii].fn()
ridx(post_tick,ii)}requestFrame()
profilerStop()
return profilerStop("tick")}if(in_background){in_background=false
callEach(exit_background_cb)}checkResize()
exports.had_3d_this_frame=had_3d_this_frame=false
had_render_scale_3d_this_frame=want_render_scale_3d_this_frame=false
if(render_width){set3DRenderResolution(render_width,render_height)
effectsPassAdd()}else{width_3d=max(1,round(width*settings.render_scale))
height_3d=max(1,round(height*settings.render_scale))
if(width_3d!==width)want_render_scale_3d_this_frame=true}resetState()
textures.bind(0,textures.textures.error)
fontTick()
camera2d.tickCamera2D()
glov_transition.render(dt)
camera2d.setAspectFixed(game_width,game_height)
profilerStopStart("mid")
soundTick(dt)
input.tickInput()
uiTick(dt)
if(need_repos){--need_repos
var ul=[]
camera2d.virtualToDom(ul,[0,0])
var lr=[]
camera2d.virtualToDom(lr,[game_width-1,game_height-1])
var viewport2=[ul[0],ul[1],lr[0],lr[1]]
var view_height=viewport2[3]-viewport2[1]
var font_size=min(256,max(2,floor(view_height/800*16)))
var elem_fullscreen=document.getElementById("fullscreen")
if(elem_fullscreen)elem_fullscreen.style["font-size"]=font_size+"px"}if(do_borders){drawRect(camera2d.x0Real(),camera2d.y0Real(),camera2d.x1Real(),0,Z.BORDERS,border_color)
drawRect(camera2d.x0Real(),game_height,camera2d.x1Real(),camera2d.y1Real(),Z.BORDERS,border_color)
drawRect(camera2d.x0Real(),0,0,game_height,Z.BORDERS,border_color)
drawRect(game_width,0,camera2d.x1Real(),game_height,Z.BORDERS,border_color)}perf.draw()
profilerStopStart("app_state")
for(var _ii=0;_ii<app_tick_functions.length;++_ii)app_tick_functions[_ii](dt)
if(app_state)app_state(dt)
profilerStopStart("bottom")
spotEndInput()
glov_particles.tick(dt)
if(had_3d_this_frame){if(had_render_scale_3d_this_frame)renderScaleFinish()}else if(render_width)framebufferStart({width:render_width,height:render_height,clear:true,clear_all:settings.render_scale_clear,final:effectsIsFinal(),need_depth:false})
else framebufferStart({width:width,height:height,clear:true,final:effectsIsFinal(),need_depth:false})
if(pre_sprite_render)callEach(pre_sprite_render,pre_sprite_render=null)
startSpriteRendering()
spriteDraw()
uiEndFrame()
if(post_render)callEach(post_render,post_render=null)
if(render_width){effectsPassConsume()
var final_viewport=[camera2d.render_offset_x,camera2d.render_offset_y_bottom,camera2d.render_viewport_w,camera2d.render_viewport_h]
var params={clear:true,clear_all:true,clear_color:border_clear_color,viewport:final_viewport}
if(do_viewport_postprocess)effects.applyPixelyExpand(params)
else effects.applyCopy(params)}input.endFrame()
resetEffects()
texturesTick()
for(var _ii2=post_tick.length-1;_ii2>=0;--_ii2)if(!--post_tick[_ii2].ticks){post_tick[_ii2].fn()
ridx(post_tick,_ii2)}last_tick_cpu=hrnow()-now
fpsgraph.history[fpsgraph.index%PERF_HISTORY_SIZE*2+0]=last_tick_cpu
requestFrame(hrnow()-hrtime)
profilerStop("bottom")
return profilerStop("tick")}var blurred=false
function onBlur(evt){blurred=true}function onFocus(evt){blurred=false}function periodiclyRequestFrame(){requestFrame()
setTimeout(periodiclyRequestFrame,1e3)
if(!in_background&&blurred)if(round(hrnow())-last_tick>400){in_background=true
callEach(enter_background_cb)}}function setPixelyStrict(on){if(on){exports.render_width=render_width=game_width
exports.render_height=render_height=game_height}else{exports.render_width=render_width=void 0
exports.render_height=render_height=void 0}}function getViewportPostprocess(){return do_viewport_postprocess}function setViewportPostprocess(viewport_postprocess){do_viewport_postprocess=viewport_postprocess}function setFonts(new_font,title_font){exports.font=font=new_font
uiSetFonts(new_font,title_font)}function engineStartupFunc(func){startup_funcs.push(func)}function startup(params){fixNatives(true)
exports.canvas=canvas=document.getElementById("canvas")
safearea_elem=document.getElementById("safearea")
glovErrorReportSetCrashCB(function(){setTimeout(requestFrame,1)})
if(false===params.error_report)glovErrorReportDisableSubmit()
if(DEBUG&&!window.spector)Object.defineProperty(Number.prototype,"length",{get:function get(){assert(false,"Numbers do not have a length property")
return}})
safearea_ignore_bottom=params.safearea_ignore_bottom||false
window.addEventListener("resize",checkResize,false)
checkResize()
var is_pixely=params.pixely&&"off"!==params.pixely
exports.antialias=antialias=params.antialias||!is_pixely&&false!==params.antialias
var powerPreference=params.high?"high-performance":"default"
var context_names=["webgl2","webgl","experimental-webgl"]
var force_webgl1=defines.NOWEBGL2
var disable_data=local_storage.getJSON("webgl2_disable")
if(disable_data&&disable_data.ua===navigator.userAgent&&disable_data.ts>Date.now()-6048e5){console.log("Disabling WebGL2 because a previous run encountered a related error")
force_webgl1=true}if(DEBUG&&!defines.FORCEWEBGL2){var rc=local_storage.getJSON("run_count",0)+1
local_storage.setJSON("run_count",rc)
if(rc%2)force_webgl1=true}if(force_webgl1)context_names.splice(0,1)
var context_opts=[{antialias:antialias,powerPreference:powerPreference,alpha:false},{powerPreference:powerPreference,alpha:false},{antialias:antialias,alpha:false},{alpha:false},{}]
var good=false
exports.webgl2=webgl2=false
for(var i=0;!good&&i<context_names.length;i+=1)for(var jj=0;!good&&jj<context_opts.length;++jj)try{window.gl=canvas.getContext(context_names[i],context_opts[jj])
if(window.gl){if("webgl2"===context_names[i])exports.webgl2=webgl2=true
if(antialias&&!context_opts[jj].antialias){exports.antialias_unavailable=antialias_unavailable=true
exports.antialias=antialias=false}good=true
break}}catch(e){}if(!window.requestAnimationFrame)good=false
if(!good){window.alert("Sorry, but your browser does not support WebGL or does not have it enabled.")
document.getElementById("loading").style.visibility="hidden"
document.getElementById("nowebgl").style.visibility="visible"
return false}var nocanvas=document.getElementById("nocanvas")
if(verify(nocanvas))nocanvas.style.visibility="hidden"
console.log("Using WebGL"+(webgl2?2:1))
assert(gl)
canvas.focus()
setGameDims(params.game_width||1280,params.game_height||960)
exports.ZNEAR=ZNEAR=params.znear||.7
exports.ZFAR=ZFAR=params.zfar||1e4
setPixelyStrict("strict"===params.pixely)
if(params.viewport_postprocess)do_viewport_postprocess=true
exports.pixel_aspect=pixel_aspect=params.pixel_aspect||1
gl.depthFunc(gl.LEQUAL)
gl.cullFace(gl.BACK)
gl.clearColor(0,.1,.2,1)
gl.pixelStorei(gl.UNPACK_ALIGNMENT,1)
textures.startup()
geom.startup()
shaders.startup({light_diffuse:light_diffuse,light_dir_ws:light_dir_ws,ambient:light_ambient,mat_m:mat_m,mat_mv:mat_mv,mat_vp:mat_vp,mvp:mat_mvp,mv_inv_trans:mat_mv_inv_transform,mat_inv_view:mat_inv_view,view:mat_view,projection:mat_projection})
addViewSpaceGlobal("light_dir")
camera2d.startup()
spriteStartup()
input.startup(canvas,params)
models.startup()
window.addEventListener("blur",onBlur,false)
window.addEventListener("focus",onFocus,false)
exports.glov_particles=glov_particles=require("./particles.js").create()
if(is_pixely){textures.defaultFilters(gl.NEAREST,gl.NEAREST)
settings.runTimeDefault("render_scale_mode",1)}else textures.defaultFilters(gl.LINEAR_MIPMAP_LINEAR,gl.LINEAR)
assert(params.font)
params.font=exports.font=font=glov_font.create(params.font.info,params.font.texture)
if(params.title_font)params.title_font=glov_font.create(params.title_font.info,params.title_font.texture)
uiStartup(params)
soundStartup(params.sound)
uiBindSounds(params.ui_sounds)
buildUIStartup()
shaderDebugUIStartup()
profilerUIStartup()
callEach(startup_funcs,startup_funcs=null)
camera2d.setAspectFixed(game_width,game_height)
if(params.state)setState(params.state)
if(void 0!==params.do_borders)do_borders=params.do_borders
if(void 0!==params.show_fps)settings.show_fps=params.show_fps
periodiclyRequestFrame()
return true}function loadsPending(){return textures.load_count+soundLoading()+models.load_count}function loading(){var load_count=loadsPending()
var elem_loading_text=document.getElementById("loading_text")
if(elem_loading_text)elem_loading_text.innerText="Loading ("+load_count+")..."
if(!load_count){exports.is_loading=is_loading=false
exports.app_state=app_state=after_loading_state
postTick({ticks:2,fn:function fn(){var loading_elem=document.getElementById("loading")
if(loading_elem)loading_elem.style.visibility="hidden"}})}}exports.app_state=app_state=loading
window.glov_engine=exports

},{"../common/perfcounters.js":72,"../common/util.js":74,"../common/verify.js":75,"../common/vmath.js":76,"./bootstrap.js":4,"./browser.js":5,"./build_ui.js":6,"./camera2d.js":7,"./client_config.js":8,"./cmds.js":9,"./effects.js":12,"./error_report.js":15,"./font.js":19,"./framebuffer.js":20,"./geom.js":21,"./input.js":28,"./local_storage.js":31,"./models.js":34,"./particles.js":36,"./perf.js":37,"./profiler.js":41,"./profiler_ui.js":42,"./settings.js":44,"./shader_debug_ui.js":45,"./shaders.js":46,"./sound.js":49,"./spot.js":50,"./sprites.js":51,"./textures.js":55,"./transition.js":56,"./ui.js":57,"./urlhash.js":58,"assert":undefined,"gl-mat3/fromMat4":undefined,"gl-mat4/copy":undefined,"gl-mat4/invert":undefined,"gl-mat4/multiply":undefined,"gl-mat4/perspective":undefined,"gl-mat4/transpose":undefined,"not_worker":undefined}],14:[function(require,module,exports){
"use strict"
exports.environmentsInit=environmentsInit
exports.getAPIPath=getAPIPath
exports.getCurrentEnvironment=getCurrentEnvironment
exports.getExternalTextureURL=getExternalTextureURL
exports.getLinkBase=getLinkBase
exports.setCurrentEnvironment=setCurrentEnvironment
var assert=require("assert")
var _client_config=require("./client_config")
var setAbilityReload=_client_config.setAbilityReload
var _cmds=require("./cmds")
var cmd_parse=_cmds.cmd_parse
var _net=require("./net")
var netForceDisconnect=_net.netForceDisconnect
var _urlhash=require("./urlhash")
var urlhash=_urlhash
var all_environments={}
var current_environment=null
var default_environment=null
var link_base
var api_path
var texture_base
function applyEnvironment(){link_base=current_environment&&current_environment.link_base||urlhash.getURLBase()
api_path=current_environment&&current_environment.api_path||link_base+"api/"
texture_base=link_base.replace("//localhost:","//127.0.0.1:")}applyEnvironment()
function getCurrentEnvironment(){return current_environment}function setCurrentEnvironment(environment_name){var prev_environment=current_environment
if((current_environment=environment_name&&all_environments[environment_name]||default_environment)!==prev_environment){applyEnvironment()
setAbilityReload(false)
netForceDisconnect()}}function getLinkBase(){return link_base}function getAPIPath(){return api_path}function getExternalTextureURL(url){return url.match(/^.{2,7}:/)?url:""+texture_base+url}function environmentsInit(environments,default_environment_name){all_environments={}
var all_names=[]
for(var i=0,len=environments.length;i<len;i++){var env=environments[i]
var env_name=env.name
assert(env_name.length>0)
all_environments[env_name]=env
all_names.push(env_name)}current_environment=default_environment=default_environment_name&&all_environments[default_environment_name]||null
applyEnvironment()
if(!all_names.some(function(name){return"default"===name.toLowerCase()}))all_names.push("default")
cmd_parse.registerValue("environment",{type:cmd_parse.TYPE_STRING,help:"Display or set the current client environment",usage:"Display the current client environment\n  Usage: /environment\nSet the current client environment ("+all_names.join(", ")+")\n  Usage: /environment <environment_name>",label:"Environment",get:function get(){return JSON.stringify(getCurrentEnvironment()||"default",null,2)},set:setCurrentEnvironment,access_show:["sysadmin"]})
cmd_parse.register({cmd:"env",help:"Alias for /environment",access_show:["sysadmin"],func:function func(str,resp_func){cmd_parse.handle(this,"environment "+str,resp_func)}})}

},{"./client_config":8,"./cmds":9,"./net":35,"./urlhash":58,"assert":undefined}],15:[function(require,module,exports){
"use strict"
exports.errorReportClear=errorReportClear
exports.errorReportDetailsString=errorReportDetailsString
exports.errorReportDisable=errorReportDisable
exports.errorReportIgnoreUncaughtPromises=errorReportIgnoreUncaughtPromises
exports.errorReportSetDetails=errorReportSetDetails
exports.errorReportSetDynamicDetails=errorReportSetDynamicDetails
exports.errorReportSetTimeAccum=errorReportSetTimeAccum
exports.glovErrorReport=glovErrorReport
exports.glovErrorReportDisableSubmit=glovErrorReportDisableSubmit
exports.glovErrorReportSetCrashCB=glovErrorReportSetCrashCB
exports.hasCrashed=hasCrashed
exports.session_uid=void 0
var session_uid=""+String(Date.now()).slice(-8)+String(Math.random()).slice(2,8)
exports.session_uid=session_uid
var _glovClientEnvironments=require("./environments")
var getAPIPath=_glovClientEnvironments.getAPIPath
var _require=require("./fetch.js"),fetch=_require.fetch
var _require2=require("./client_config.js"),PLATFORM=_require2.PLATFORM
var error_report_disabled=false
function errorReportDisable(){error_report_disabled=true}var ignore_promises=false
function errorReportIgnoreUncaughtPromises(){ignore_promises=true}var error_report_details={}
var error_report_dynamic_details={}
function errorReportSetDetails(key,value){if(value)error_report_details[key]=escape(String(value))
else delete error_report_details[key]}function errorReportSetDynamicDetails(key,fn){error_report_dynamic_details[key]=fn}errorReportSetDetails("build","1673321608019")
errorReportSetDetails("sesuid",session_uid)
errorReportSetDetails("platform",PLATFORM)
var time_start=Date.now()
errorReportSetDetails("time_start",time_start)
errorReportSetDynamicDetails("url",function(){return escape(location.href)})
errorReportSetDynamicDetails("time_up",function(){return Date.now()-time_start})
var time_accum=0
function errorReportSetTimeAccum(new_value){time_accum=new_value}errorReportSetDynamicDetails("time_accum",function(){return time_accum})
function getDynamicDetail(key){var value=error_report_dynamic_details[key]()
if(!value&&0!==value)return""
return"&"+key+"="+value}function errorReportDetailsString(){return"&"+Object.keys(error_report_details).map(function(k){return k+"="+error_report_details[k]}).join("&")+Object.keys(error_report_dynamic_details).map(getDynamicDetail).join("")}var last_error_time=0
var crash_idx=0
function hasCrashed(){return crash_idx>0}function errorReportClear(){last_error_time=0
window.debugmsg("",true)}var submit_errors=true
function glovErrorReportDisableSubmit(){submit_errors=false}var on_crash_cb=null
function glovErrorReportSetCrashCB(cb){on_crash_cb=cb}var filtered_errors=/avast_submit|vc_request_action|^Error: Script error\.$|^Error: Script error\.\n  at \(0:0\)$|^Error: null$|^Error: null\n  at null\(null:null\)$|getElementsByTagName\('video'\)|document\.getElementById\("search"\)|change_ua|chrome-extension|setConnectedRobot|Failed to (?:start|stop) the audio device|zaloJSV2|getCookie is not defined|originalPrompt|_AutofillCallbackHandler|sytaxError|bannerNight|privateSpecialRepair|__gCrWeb|\$wrap is not/
function glovErrorReport(is_fatal,msg,file,line,col){console.error(msg)
if(on_crash_cb)on_crash_cb()
if(is_fatal){++crash_idx
var now=Date.now()
var dt=now-last_error_time
last_error_time=now
if(error_report_disabled)return false
if(dt<3e4)return false
if(msg.match(filtered_errors))return false}var url=getAPIPath()
url+=(is_fatal?"errorReport":"errorLog")+"?cidx="+crash_idx+"&file="+escape(file)+"&line="+(line||0)+"&col="+(col||0)+"&msg="+escape(msg)+errorReportDetailsString()
if(submit_errors)fetch({method:"POST",url:url},function(){})
if(ignore_promises&&msg.match(/Uncaught \(in promise\)/))return false
return true}window.glov_error_report=glovErrorReport.bind(null,true)

},{"./client_config.js":8,"./environments":14,"./fetch.js":17}],16:[function(require,module,exports){
"use strict"
exports.canFollowOfficialPage=canFollowOfficialPage
exports.canJoinOfficialGroup=canJoinOfficialGroup
exports.canShowLiveStreamOverlay=canShowLiveStreamOverlay
exports.fbGetAppScopedUserId=fbGetAppScopedUserId
exports.fbGetLoginInfo=fbGetLoginInfo
exports.fbInstantInit=fbInstantInit
exports.fbInstantIsReady=fbInstantIsReady
exports.fbInstantOnPause=fbInstantOnPause
exports.onready=onready
var _require=require("./social.js"),registerExternalUserInfoProvider=_require.registerExternalUserInfoProvider
var urlhash=require("./urlhash.js")
var local_storage=require("./local_storage.js")
var _require2=require("../common/enums.js"),ID_PROVIDER_FB_INSTANT=_require2.ID_PROVIDER_FB_INSTANT
var _require3=require("./error_report.js"),errorReportSetDynamicDetails=_require3.errorReportSetDynamicDetails
var _require4=require("../common/util.js"),callEach=_require4.callEach,eatPossiblePromise=_require4.eatPossiblePromise
var onreadycallbacks=[]
function onready(callback){if(!onreadycallbacks)return void callback()
onreadycallbacks.push(callback)}function fbInstantIsReady(){return null===onreadycallbacks}var fb_log=[]
function fbInstantLogEvent(event){FBInstant.logEvent(event)
fb_log.push(event)
if(fb_log.length>10)fb_log.splice(0,1)}var hasSubscribedAlready=false
function initSubscribe(callback,skipShortcut){skipShortcut=skipShortcut||false
function handleSubscribeToBotComplete(){if(callback)setTimeout(callback,1)}function handleSubscribeToBotFailure(e){if(e&&"USER_INPUT"!==e.code)console.error("handleSubscribeToBotFailure",e)
fbInstantLogEvent("bot_subscribe_failure")
handleSubscribeToBotComplete()}function subscribeToBot(){console.warn("Window social trying to bot subscribe")
if(-1!==FBInstant.getSupportedAPIs().indexOf("player.canSubscribeBotAsync"))FBInstant.player.canSubscribeBotAsync().then(function(canSubscribe){if(canSubscribe){fbInstantLogEvent("bot_subscribe_show")
FBInstant.player.subscribeBotAsync().then(function(){fbInstantLogEvent("bot_subscribe_success")
handleSubscribeToBotComplete()},handleSubscribeToBotFailure).catch(handleSubscribeToBotFailure)}else handleSubscribeToBotComplete()}).catch(handleSubscribeToBotFailure)
else handleSubscribeToBotComplete()}function handleHomescreenComplete(){subscribeToBot()}function handleCreateShortcutFailure(e){console.error("handleCreateShortcutFailure",e)
fbInstantLogEvent("homescreen_install_failure")
handleHomescreenComplete()}var hasAddedToHomescreen=local_storage.get("instant.hasInstalledShortcut.v2")
function createShortcut(){console.warn("Window social trying to create shortcut")
if(-1!==FBInstant.getSupportedAPIs().indexOf("canCreateShortcutAsync")&&!hasAddedToHomescreen&&!hasSubscribedAlready){hasSubscribedAlready=true
FBInstant.canCreateShortcutAsync().then(function(canCreateShortcut){if(canCreateShortcut){fbInstantLogEvent("homescreen_install_show")
FBInstant.createShortcutAsync().then(function(){local_storage.set("instant.hasInstalledShortcut.v2",true)
fbInstantLogEvent("homescreen_install_success")
handleHomescreenComplete()},function(){fbInstantLogEvent("homescreen_install_useraborted")
handleHomescreenComplete()}).catch(handleCreateShortcutFailure)}else handleHomescreenComplete()}).catch(handleCreateShortcutFailure)}else handleHomescreenComplete()}if(skipShortcut)subscribeToBot()
else createShortcut()}var on_pause=[]
function fbInstantOnPause(cb){on_pause.push(cb)}var can_follow_official_page=false
var can_join_official_group=false
var can_get_live_streams_overlay=false
function fbGetLoginInfo(cb){onready(function(){window.FBInstant.player.getSignedPlayerInfoAsync().then(function(result){if(cb){cb(null,{signature:result.getSignature(),display_name:window.FBInstant.player.getName()})
cb=null}}).catch(function(err){if(cb){cb(err)
cb=null}})})}function mapPlayerToExternalUserInfo(player){return{external_id:player.getID(),name:player.getName(),profile_picture_url:player.getPhoto()}}function fbInstantGetPlayer(cb){onready(function(){var player=window.FBInstant.player
cb(null,player?mapPlayerToExternalUserInfo(player):void 0)})}function fbInstantGetFriends(cb){onready(function(){window.FBInstant.player.getConnectedPlayersAsync().then(function(players){if(cb)cb(cb=null,null==players?void 0:players.map(mapPlayerToExternalUserInfo))}).catch(function(err){if(cb){var local_cb=cb
cb=null
local_cb(err)}})})}function fbGetAppScopedUserId(cb){onready(function(){window.FBInstant.player.getASIDAsync().then(function(asid){if(cb){cb(null,asid)
cb=null}}).catch(function(err){if(cb){cb(err)
cb=null}})})}function canFollowOfficialPage(){return window.FBInstant&&can_follow_official_page}function canJoinOfficialGroup(){return window.FBInstant&&can_join_official_group}function canShowLiveStreamOverlay(){return window.FBInstant&&can_get_live_streams_overlay}function fbInstantInit(){if(!window.FBInstant)return
errorReportSetDynamicDetails("fblog",function(){return fb_log.join(",")})
registerExternalUserInfoProvider(ID_PROVIDER_FB_INSTANT,fbInstantGetPlayer,fbInstantGetFriends)
var left=1
var fake_load_interval=setInterval(function(){left*=.9
eatPossiblePromise(FBInstant.setLoadingProgress(100-100*left>>0))},100)
FBInstant.initializeAsync().then(function(){var querystring=(FBInstant.getEntryPointData()||{}).querystring||{}
for(var x in querystring)urlhash.set(x,querystring[x])
clearInterval(fake_load_interval)
FBInstant.startGameAsync().then(function(){callEach(onreadycallbacks,onreadycallbacks=null)
console.log("Initializing FBInstant")
initSubscribe(function(){console.log("All done initing FBInstant")
window.FBInstant.community.canFollowOfficialPageAsync().then(function(state){can_follow_official_page=state}).catch(function(err){console.error(err)})
window.FBInstant.community.canJoinOfficialGroupAsync().then(function(state){can_join_official_group=state}).catch(function(err){console.error(err)})
window.FBInstant.community.canGetLiveStreamsAsync().then(function(state){can_get_live_streams_overlay=state}).catch(function(err){console.error(err)})})})}).catch(function(e){console.warn("FBInstant initializeAsync failed",e)})
FBInstant.onPause(function(){callEach(on_pause)})}

},{"../common/enums.js":68,"../common/util.js":74,"./error_report.js":15,"./local_storage.js":31,"./social.js":48,"./urlhash.js":58}],17:[function(require,module,exports){
"use strict"
exports.ERR_CONNECTION=void 0
exports.fetch=fetch
var assert=require("assert")
var _require=require("../common/util.js"),once=_require.once
var ERR_CONNECTION="ERR_CONNECTION"
exports.ERR_CONNECTION=ERR_CONNECTION
var regex_with_host=/\/\/[^/]+\/([^?#]+)/
var regex_no_host=/([^?#]+)/
function labelFromURL(url){var m=url.match(regex_with_host)
if(m)return m[1]
return(m=url.match(regex_no_host))?m[1]:url}function fetch(params,cb){cb=once(cb)
var method=params.method,url=params.url,response_type=params.response_type,label=params.label
method=method||"GET"
assert(url)
label=label||labelFromURL(url)
var xhr=new XMLHttpRequest
xhr.open(method,url,true)
if(response_type&&"json"!==response_type)xhr.responseType=response_type
xhr.onload=function(){profilerStart("fetch_onload:"+label)
if(200!==xhr.status&&0!==xhr.status){var text
try{text=xhr.responseText}catch(e){}cb(String(xhr.status),text||"")}else if("json"===response_type){var _text
var obj
try{_text=xhr.responseText
obj=JSON.parse(_text)}catch(e){console.error("Received invalid JSON response from "+url+": "+(_text||"<empty response>"))
cb(e)
profilerStop()
return}cb(null,obj)}else if("arraybuffer"===response_type)if(xhr.response)cb(null,xhr.response)
else cb("empty response")
else cb(null,xhr.responseText)
profilerStop()}
xhr.onerror=function(){profilerStart("fetch_onerror:"+label)
cb(ERR_CONNECTION)
profilerStop()}
xhr.send(null)}

},{"../common/util.js":74,"assert":undefined}],18:[function(require,module,exports){
"use strict"
exports.filewatchMessageHandler=filewatchMessageHandler
exports.filewatchOn=filewatchOn
exports.filewatchStartup=filewatchStartup
exports.filewatchTriggerChange=filewatchTriggerChange
var assert=require("assert")
var by_ext={}
var by_match=[]
function filewatchOn(ext_or_search,cb){if("."===ext_or_search[0]){assert(!by_ext[ext_or_search])
by_ext[ext_or_search]=cb}else by_match.push([ext_or_search,cb])}var message_cb
function filewatchMessageHandler(cb){message_cb=cb}function onFileChange(filename){console.log("FileWatch change: "+filename)
var ext_idx=filename.lastIndexOf(".")
var did_reload=false
if(-1!==ext_idx){var ext=filename.slice(ext_idx)
if(by_ext[ext])if(false!==by_ext[ext](filename))did_reload=true}for(var ii=0;ii<by_match.length;++ii)if(filename.match(by_match[ii][0]))if(false!==by_match[ii][1](filename))did_reload=true
if(message_cb&&did_reload)message_cb("Reloading: "+filename)}function filewatchTriggerChange(filename){onFileChange(filename)}function filewatchStartup(client){client.onMsg("filewatch",onFileChange)}

},{"assert":undefined}],19:[function(require,module,exports){
"use strict"
exports.ALIGN=void 0
exports.fontCreate=fontCreate
exports.fontSetDefaultSize=fontSetDefaultSize
exports.fontStyle=fontStyle
exports.fontStyleAlpha=fontStyleAlpha
exports.fontStyleColored=fontStyleColored
exports.fontTick=fontTick
exports.glov_font_default_style=exports.font_shaders=void 0
exports.intColorFromVec4Color=intColorFromVec4Color
exports.vec4ColorFromIntColor=vec4ColorFromIntColor
exports.style=fontStyle
exports.styleColored=fontStyleColored
exports.styleAlpha=fontStyleAlpha
exports.create=fontCreate
var assert=require("assert")
var camera2d=require("./camera2d.js")
var _require=require("./camera2d.js"),transformX=_require.transformX,transformY=_require.transformY
var engine=require("./engine.js")
var geom=require("./geom.js")
var _require2=require("./localization.js"),getStringFromLocalizable=_require2.getStringFromLocalizable
var max=Math.max,min=Math.min,round=Math.round
var shaders=require("./shaders.js")
var sprites=require("./sprites.js")
var BLEND_ALPHA=sprites.BLEND_ALPHA,BLEND_PREMULALPHA=sprites.BLEND_PREMULALPHA,spriteChainedStart=sprites.spriteChainedStart,spriteChainedStop=sprites.spriteChainedStop,spriteDataAlloc=sprites.spriteDataAlloc
var textures=require("./textures.js")
var _require3=require("../common/util.js"),clamp=_require3.clamp
var _require4=require("../common/vmath.js"),v3scale=_require4.v3scale,v3set=_require4.v3set,vec4=_require4.vec4,v4copy=_require4.v4copy,v4scale=_require4.v4scale
var ALIGN={HLEFT:0,HCENTER:1,HRIGHT:2,HMASK:3,VTOP:0,VCENTER:4,VBOTTOM:8,VMASK:12,HFIT:16,HWRAP:32,HCENTERFIT:17,HRIGHTFIT:18,HVCENTER:5,HVCENTERFIT:21}
var ALIGN_NEEDS_WIDTH=(exports.ALIGN=ALIGN).HMASK|ALIGN.HFIT
function GlovFontStyle(){this.color_vec4=new Float32Array([1,1,1,1])}GlovFontStyle.prototype.outline_width=0
GlovFontStyle.prototype.outline_color=0
GlovFontStyle.prototype.glow_xoffs=0
GlovFontStyle.prototype.glow_yoffs=0
GlovFontStyle.prototype.glow_inner=0
GlovFontStyle.prototype.glow_outer=0
GlovFontStyle.prototype.glow_color=0
GlovFontStyle.prototype.color=4294967295
var font_shaders={}
exports.font_shaders=font_shaders
function intColorFromVec4Color(v){return(255*v[0]|0)<<24|(255*v[1]|0)<<16|(255*v[2]|0)<<8|255*v[3]|0}function vec4ColorFromIntColor(v,c){v[0]=(c>>24&255)/255
v[1]=(c>>16&255)/255
v[2]=(c>>8&255)/255
v[3]=(255&c)/255}function vec4ColorFromIntColorPreMultiplied(v,c){var a=v[3]=(255&c)/255
v[0]=(c>>24&255)*(a*=1/255)
v[1]=(c>>16&255)*a
v[2]=(c>>8&255)*a}var glov_font_default_style=new GlovFontStyle
exports.glov_font_default_style=glov_font_default_style
function fontStyle(font_style,fields){var ret=new GlovFontStyle
var color_vec4=ret.color_vec4
if(font_style)for(var f in font_style)ret[f]=font_style[f]
for(var _f in fields)ret[_f]=fields[_f]
ret.color_vec4=color_vec4
vec4ColorFromIntColor(ret.color_vec4,ret.color)
return ret}function fontStyleColored(font_style,color){return fontStyle(font_style,{color:color})}function colorAlpha(color,alpha){return 4294967040&color|(alpha=clamp(round((255&color)*alpha),0,255))}function fontStyleAlpha(font_style,alpha){return fontStyle(font_style,{color:colorAlpha((font_style||glov_font_default_style).color,alpha),outline_color:colorAlpha((font_style||glov_font_default_style).outline_color,alpha),glow_color:colorAlpha((font_style||glov_font_default_style).glow_color,alpha)})}var tech_params=null
var tech_params_dirty=false
var tech_params_cache=[]
var tech_params_cache_idx=0
var tech_params_pool=[]
var tech_params_pool_idx=0
var temp_color=vec4()
var geom_stats
var dsp={}
function techParamsAlloc(){if(tech_params_pool_idx===tech_params_pool.length)tech_params_pool.push({param0:vec4(),outline_color:vec4(),glow_color:vec4(),glow_params:vec4()})
tech_params=tech_params_pool[tech_params_pool_idx++]}function fontStartup(){if(tech_params)return
geom_stats=geom.stats
techParamsAlloc()}function techParamsSet(param,value){var tpv=tech_params[param]
if(!tech_params_dirty)if(tpv[0]!==value[0]||tpv[1]!==value[1]||tpv[2]!==value[2]||tpv[3]!==value[3]){var old_tech_params=tech_params
techParamsAlloc()
v4copy(tech_params.param0,old_tech_params.param0)
v4copy(tech_params.outline_color,old_tech_params.outline_color)
v4copy(tech_params.glow_color,old_tech_params.glow_color)
v4copy(tech_params.glow_params,old_tech_params.glow_params)
geom_stats.font_params++
tech_params_dirty=true
tpv=tech_params[param]}else return
if(tech_params_dirty){tpv[0]=value[0]
tpv[1]=value[1]
tpv[2]=value[2]
tpv[3]=value[3]}}var SHADER_KEYS=["param0","outline_color","glow_color","glow_params"]
function sameTP(as){for(var jj=0;jj<4;++jj){var key=SHADER_KEYS[jj]
var v1=tech_params[key]
var v2=as[key]
for(var ii=0;ii<4;++ii)if(v1[ii]!==v2[ii])return false}return true}function techParamsGet(){if(!tech_params_dirty)return tech_params
tech_params_dirty=false
for(var ii=0;ii<tech_params_cache.length;++ii)if(sameTP(tech_params_cache[ii])){if(tech_params===tech_params_pool[tech_params_pool_idx-1])tech_params_pool_idx--
tech_params=tech_params_cache[ii]
if(tech_params_cache_idx===ii)tech_params_cache_idx=(tech_params_cache_idx+1)%4;--geom_stats.font_params
return tech_params}tech_params_cache[tech_params_cache_idx]=tech_params
tech_params_cache_idx=(tech_params_cache_idx+1)%4
return tech_params}function GlovFont(font_info,texture_name){assert(0!==font_info.font_size)
this.texture=textures.load({url:"img/"+texture_name+".png",filter_min:font_info.noFilter?gl.NEAREST:gl.LINEAR,filter_mag:font_info.noFilter?gl.NEAREST:gl.LINEAR,wrap_s:gl.CLAMP_TO_EDGE,wrap_t:gl.CLAMP_TO_EDGE})
this.textures=[this.texture]
this.integral=Boolean(font_info.noFilter)
this.font_info=font_info
this.font_size=font_info.font_size
this.inv_font_size=1/font_info.font_size
this.shader=font_shaders.font_aa
this.tex_w=font_info.imageW
this.tex_h=font_info.imageH
for(var ii=0;ii<font_info.char_infos.length;++ii){var char_info=font_info.char_infos[ii]
char_info.scale=1/(char_info.sc||1)
char_info.w=char_info.w||0}this.char_infos=[]
for(var _ii=0;_ii<font_info.char_infos.length;++_ii){var _char_info=font_info.char_infos[_ii];(this.char_infos[font_info.char_infos[_ii].c]=_char_info).xpad=_char_info.xpad||0
_char_info.yoffs=_char_info.yoffs||0
_char_info.w_pad_scale=(_char_info.w+_char_info.xpad)*_char_info.scale}this.replacement_character=this.infoFromChar(65533)
if(!this.replacement_character)this.replacement_character=this.infoFromChar(63)
this.whitespace_character=this.infoFromChar(13)
this.default_style=new GlovFontStyle
this.applied_style=new GlovFontStyle
fontStartup()}GlovFont.prototype.drawSizedColor=function(style,x,y,z,size,color,text){return this.drawSized(fontStyleColored(style,color),x,y,z,size,text)}
GlovFont.prototype.drawSized=function(style,x,y,z,size,text){dsp.style=style
dsp.x=x
dsp.y=y
dsp.z=z
dsp.xsc=size*this.inv_font_size
dsp.ysc=size*this.inv_font_size
dsp.text=text
return this.drawScaled()}
GlovFont.prototype.drawSizedAligned=function(style,x,y,z,size,align,w,h,text){profilerStart("drawSizedAligned")
text=getStringFromLocalizable(text)
if(align&ALIGN.HWRAP){var drawn_height=this.drawSizedAlignedWrapped(style,x,y,z,0,size,align&~ALIGN.HWRAP,w,h,text)
profilerStop("drawSizedAligned")
return drawn_height}var x_size=size
var y_size=size
if(align&ALIGN_NEEDS_WIDTH){var width=this.getStringWidth(style,x_size,text)
if(align&ALIGN.HFIT&&width>w){var scale=w/width
x_size*=scale
width=w
if(scale<.5){if((align&ALIGN.VMASK)!==ALIGN.VCENTER&&(align&ALIGN.VMASK)!==ALIGN.VBOTTOM)y+=.5*(y_size-y_size*scale*2)
y_size*=2*scale}}switch(align&ALIGN.HMASK){case ALIGN.HCENTER:x+=.5*(w-width)
if(this.integral)x=round(x)
break
case ALIGN.HRIGHT:x+=w-width}}switch(align&ALIGN.VMASK){case ALIGN.VCENTER:y+=.5*(h-y_size)
if(this.integral)y=round(y)
break
case ALIGN.VBOTTOM:y+=h-y_size}var xsc=x_size*this.inv_font_size
var ysc=y_size*this.inv_font_size
dsp.style=style
dsp.x=x
dsp.y=y
dsp.z=z
dsp.xsc=xsc
dsp.ysc=ysc
dsp.text=text
var drawn_width=this.drawScaled()
profilerStop("drawSizedAligned")
return drawn_width}
GlovFont.prototype.drawSizedAlignedWrapped=function(style,x,y,z,indent,size,align,w,h,text){text=getStringFromLocalizable(text)
assert(w>0)
assert("string"!==typeof h)
var lines=[]
var line_xoffs=[]
lines.length=this.wrapLines(style,w,indent,size,text,align,function(xoffs,linenum,line){line_xoffs[linenum]=xoffs
lines[linenum]=line})
var yoffs=0
var height=size*lines.length
switch(align&ALIGN.VMASK){case ALIGN.VCENTER:yoffs=(h-height)/2
if(this.integral)yoffs|=0
break
case ALIGN.VBOTTOM:yoffs=h-height}align&=~ALIGN.VMASK
for(var ii=0;ii<lines.length;++ii){var line=lines[ii]
if(line&&line.trim())this.drawSizedAligned(style,x+line_xoffs[ii],y+yoffs,z,size,align,w-line_xoffs[ii],0,line)
yoffs+=size}return yoffs}
GlovFont.prototype.drawSizedColorWrapped=function(style,x,y,z,w,indent,size,color,text){return this.drawScaledWrapped(fontStyleColored(style,color),x,y,z,w,indent,size*this.inv_font_size,size*this.inv_font_size,text)}
GlovFont.prototype.drawSizedWrapped=function(style,x,y,z,w,indent,size,text){return this.drawScaledWrapped(style,x,y,z,w,indent,size*this.inv_font_size,size*this.inv_font_size,text)}
var default_size=24
function fontSetDefaultSize(h){default_size=h}GlovFont.prototype.draw=function(param){var style=param.style,color=param.color,alpha=param.alpha,x=param.x,y=param.y,z=param.z,size=param.size,w=param.w,h=param.h,align=param.align,text=param.text,indent=param.indent
if(color)style=fontStyleColored(style,color)
if(void 0!==alpha)style=fontStyleAlpha(style,alpha)
indent=indent||0
size=size||default_size
z=z||Z.UI
if(align){if(align&ALIGN.HWRAP)return this.drawSizedAlignedWrapped(style,x,y,z,indent,size,align&~ALIGN.HWRAP,w,h,text)
return this.drawSizedAligned(style,x,y,z,size,align,w||0,h||0,text)}else return this.drawSized(style,x,y,z,size,text)}
GlovFont.prototype.wrapLines=function(style,w,indent,size,text,align,line_cb){assert("number"!==typeof style)
this.applyStyle(style)
return this.wrapLinesScaled(w,indent,size*this.inv_font_size,text,align,line_cb)}
GlovFont.prototype.numLines=function(style,w,indent,size,text){return this.wrapLines(style,w,indent,size,text,0)}
GlovFont.prototype.dims=function(style,w,indent,size,text){var max_x1=0
function lineCallback(ignored1,ignored2,line,x1){max_x1=max(max_x1,x1)}var numlines=this.wrapLines(style,w,indent,size,text,0,lineCallback)
return{w:max_x1,h:numlines*size}}
GlovFont.prototype.infoFromChar=function(c){var ret=this.char_infos[c]
if(ret)return ret
if(c>=9&&c<=13)return this.whitespace_character
return this.replacement_character}
GlovFont.prototype.getCharacterWidth=function(style,x_size,c){assert.equal(typeof c,"number")
this.applyStyle(style)
var char_info=this.infoFromChar(c)
var xsc=x_size*this.inv_font_size
var x_advance=this.calcXAdvance(xsc)
if(char_info)return char_info.w_pad_scale*xsc+x_advance
return 0}
GlovFont.prototype.getStringWidth=function(style,x_size,text){text=getStringFromLocalizable(text)
this.applyStyle(style)
var ret=0
var xsc=x_size*this.inv_font_size
var x_advance=this.calcXAdvance(xsc)
for(var ii=0;ii<text.length;++ii){var c=text.charCodeAt(ii)
var char_info=this.infoFromChar(c)
if(char_info)ret+=char_info.w_pad_scale*xsc+x_advance}return ret}
GlovFont.prototype.getSpaceSize=function(xsc){var space_info=this.infoFromChar(32)
return(space_info?(space_info.w+space_info.xpad)*space_info.scale:this.font_size)*xsc}
function endsWord(char_code){return 32===char_code||0===char_code||10===char_code||9===char_code}GlovFont.prototype.wrapLinesScaled=function(w,indent,xsc,text,align,line_cb){text=getStringFromLocalizable(text)
assert("function"!==typeof align)
var len=text.length
var max_word_w=w-indent
var hard_wrap_mode_fit=align&ALIGN.HFIT
var x_advance=this.calcXAdvance(xsc)
var space_size=this.getSpaceSize(xsc)+x_advance
var idx=0
var line_start=0
var line_x0=0
var line_x1=0
var line_end=-1
var word_start=0
var word_x0=0
var word_w=0
var word_slice=-1
var word_slice_w=0
var linenum=0
function flushLine(){if(-1!==line_end&&line_cb)line_cb(line_x0,linenum,text.slice(line_start,line_end),line_x1)
linenum++
line_start=word_start
line_end=line_x1=-1
word_x0=line_x0=indent}do{var c=idx<len?text.charCodeAt(idx)||65533:0
if(endsWord(c))if(word_start!==idx){var need_line_flush=false
if(word_x0+word_w<=w);else if(word_w>max_word_w&&!hard_wrap_mode_fit){need_line_flush=true
if(-1===word_slice){if(-1!==line_end)flushLine()
idx=line_start+1
word_w=max_word_w}else{idx=word_slice
word_w=word_slice_w}}else if(-1!==line_end)flushLine()
word_x0=line_x1=word_x0+word_w
word_w=0
word_start=line_end=idx
word_slice=-1
if(need_line_flush)flushLine()
continue}else{word_start=idx+1
word_x0+=space_size
if(10===c)flushLine()}else{var char_info=this.infoFromChar(c)
if(char_info){var char_w=char_info.w_pad_scale*xsc+x_advance
if(word_x0+(word_w+=char_w)<=w){word_slice=idx+1
word_slice_w=word_w}}}++idx}while(idx<=len)
if(-1!==line_end)flushLine()
return linenum}
GlovFont.prototype.drawScaledWrapped=function(style,x,y,z,w,indent,xsc,ysc,text){var _this=this
if(null===text||void 0===text)text="(null)"
assert(w>0)
this.applyStyle(style)
this.last_width=0
dsp.style=style
dsp.z=z
dsp.xsc=xsc
dsp.ysc=ysc
return this.wrapLinesScaled(w,indent,xsc,text,0,function(xoffs,linenum,line,x1){dsp.x=x+xoffs
dsp.y=y+_this.font_size*ysc*linenum
dsp.text=line
_this.drawScaled()
_this.last_width=max(_this.last_width,x1)})*this.font_size*ysc}
GlovFont.prototype.calcXAdvance=function(xsc){var font_texel_scale=this.font_size/32
var x_advance=round(xsc*font_texel_scale*max(this.applied_style.outline_width-2,0))
return x_advance=max(x_advance,xsc*font_texel_scale*max(this.applied_style.glow_outer-this.applied_style.glow_xoffs-3,0))}
var temp_vec4_param0=vec4()
var temp_vec4_glow_params=vec4()
var padding4=vec4()
var padding_in_font_space=vec4()
GlovFont.prototype.drawScaled=function(){var style=dsp.style,_x=dsp.x,y=dsp.y,z=dsp.z,xsc=dsp.xsc,ysc=dsp.ysc,text=dsp.text
profilerStart("drawScaled")
text=getStringFromLocalizable(text)
var x=_x
assert(isFinite(x))
assert(isFinite(y))
assert(isFinite(z))
var font_info=this.font_info
y+=(font_info.y_offset||0)*ysc
var texs=this.textures
if(null===text||void 0===text)text="(null)"
var len=text.length
if(0===xsc||0===ysc){profilerStop("drawScaled")
return 0}geom_stats.font_calls++
this.applyStyle(style)
var blend_mode=engine.defines.NOPREMUL?BLEND_ALPHA:BLEND_PREMULALPHA
var avg_scale_font=.5*(xsc+ysc)
var avg_scale_combined=.5*(xsc*camera2d.data[4]+ysc*camera2d.data[5])
var x_advance=this.calcXAdvance(xsc)
var font_texel_scale=this.font_size/32
var tile_state=0
var applied_style=this.applied_style
var delta_per_source_pixel=.5/font_info.spread
var delta_per_dest_pixel=delta_per_source_pixel/avg_scale_combined
var value=v3set(temp_vec4_param0,1/delta_per_dest_pixel,-.5/delta_per_dest_pixel+.5,min(0,-.5/delta_per_dest_pixel+.5+applied_style.outline_width*font_texel_scale*avg_scale_combined))
var padding1=max(0,applied_style.outline_width*font_texel_scale*avg_scale_font)
var outer_scaled=applied_style.glow_outer*font_texel_scale
padding4[0]=max(outer_scaled*xsc-applied_style.glow_xoffs*font_texel_scale*xsc,padding1)
padding4[2]=max(outer_scaled*xsc+applied_style.glow_xoffs*font_texel_scale*xsc,padding1)
padding4[1]=max(outer_scaled*ysc-applied_style.glow_yoffs*font_texel_scale*ysc,padding1)
padding4[3]=max(outer_scaled*ysc+applied_style.glow_yoffs*font_texel_scale*ysc,padding1)
techParamsSet("param0",value)
var value2=temp_vec4_glow_params
if(applied_style.glow_outer){value2[2]=1/((applied_style.glow_outer-applied_style.glow_inner)*delta_per_source_pixel*font_texel_scale)
value2[3]=min(0,-(.5-applied_style.glow_outer*delta_per_source_pixel*font_texel_scale)/((applied_style.glow_outer-applied_style.glow_inner)*delta_per_source_pixel*font_texel_scale))}else value2[2]=value[3]=0
v4scale(padding_in_font_space,padding4,1/avg_scale_font)
for(var ii=0;ii<4;++ii)if(padding_in_font_space[ii]>font_info.spread){var sc=font_info.spread/padding_in_font_space[ii]
padding4[ii]*=sc
padding_in_font_space[ii]*=sc}var z_advance=applied_style.glow_xoffs<0?-1e-4:0
if(!z_advance)spriteChainedStart()
var has_glow_offs=applied_style.glow_xoffs||applied_style.glow_yoffs
if(!has_glow_offs){value2[0]=value2[1]=0
techParamsSet("glow_params",value2)
techParamsGet()}var rel_x_scale=xsc/avg_scale_font
var rel_y_scale=ysc/avg_scale_font
var sort_y=transformY(y)
var color=applied_style.color_vec4
var shader=this.shader
for(var i=0;i<len;i++){var c=text.charCodeAt(i)
if(9===c){var tabsize=xsc*this.font_size*4
x=(1+((x-_x)/tabsize|0))*tabsize+_x}else{var char_info=this.infoFromChar(c)
if(char_info){var char_scale=char_info.scale
var xsc2=xsc*char_scale
if(char_info.w){var ysc2=ysc*char_scale
var pad_scale=1/char_scale
var tile_width=this.tex_w
var tile_height=this.tex_h
if(has_glow_offs&&char_scale!==tile_state){value2[0]=-applied_style.glow_xoffs*font_texel_scale*pad_scale/tile_width
value2[1]=-applied_style.glow_yoffs*font_texel_scale*pad_scale/tile_height
techParamsSet("glow_params",value2)
if(!z_advance){spriteChainedStop()
spriteChainedStart()}techParamsGet()
tile_state=char_scale}var u0=(char_info.x0-padding_in_font_space[0]*pad_scale)/tile_width
var u1=(char_info.x0+char_info.w+padding_in_font_space[2]*pad_scale)/tile_width
var v0=(char_info.y0-padding_in_font_space[1]*pad_scale)/tile_height
var v1=(char_info.y0+char_info.h+padding_in_font_space[3]*pad_scale)/tile_height
var w=char_info.w*xsc2+(padding4[0]+padding4[2])*rel_x_scale
var h=char_info.h*ysc2+(padding4[1]+padding4[3])*rel_y_scale
var xx=x-rel_x_scale*padding4[0]
var yy=y-rel_y_scale*padding4[2]+char_info.yoffs*ysc2
var y1=yy+h
var x1=xx+w
var zz=z+z_advance*i
var tx0=transformX(xx)
var ty0=transformY(yy)
var tx1=transformX(x1)
var ty1=transformY(y1)
var elem=spriteDataAlloc(texs,shader,tech_params,blend_mode)
var data=elem.data
data[0]=tx0
data[1]=ty0
data[2]=color[0]
data[3]=color[1]
data[4]=color[2]
data[5]=color[3]
data[6]=u0
data[7]=v0
data[8]=tx0
data[9]=ty1
data[10]=color[0]
data[11]=color[1]
data[12]=color[2]
data[13]=color[3]
data[14]=u0
data[15]=v1
data[16]=tx1
data[17]=ty1
data[18]=color[0]
data[19]=color[1]
data[20]=color[2]
data[21]=color[3]
data[22]=u1
data[23]=v1
data[24]=tx1
data[25]=ty0
data[26]=color[0]
data[27]=color[1]
data[28]=color[2]
data[29]=color[3]
data[30]=u1
data[31]=v0
elem.x=tx0
elem.y=sort_y
elem.queue(zz)}x+=(char_info.w+char_info.xpad)*xsc2+x_advance}}}if(!z_advance)spriteChainedStop()
profilerStop("drawScaled")
return x-_x}
GlovFont.prototype.determineShader=function(){var outline=this.applied_style.outline_width&&255&this.applied_style.outline_color
var glow=this.applied_style.glow_outer>0&&255&this.applied_style.glow_color
if(outline)if(glow)this.shader=font_shaders.font_aa_outline_glow
else this.shader=font_shaders.font_aa_outline
else if(glow)this.shader=font_shaders.font_aa_glow
else this.shader=font_shaders.font_aa}
GlovFont.prototype.applyStyle=function(style){if(!style)style=this.default_style
if(engine.defines.NOPREMUL){vec4ColorFromIntColor(temp_color,style.outline_color)
techParamsSet("outline_color",temp_color)
vec4ColorFromIntColor(temp_color,style.glow_color)
techParamsSet("glow_color",temp_color)}else{vec4ColorFromIntColorPreMultiplied(temp_color,style.outline_color)
techParamsSet("outline_color",temp_color)
vec4ColorFromIntColorPreMultiplied(temp_color,style.glow_color)
techParamsSet("glow_color",temp_color)}this.applied_style.outline_width=style.outline_width
this.applied_style.outline_color=style.outline_color
this.applied_style.glow_xoffs=style.glow_xoffs
this.applied_style.glow_yoffs=style.glow_yoffs
this.applied_style.glow_inner=style.glow_inner
this.applied_style.glow_outer=style.glow_outer
this.applied_style.glow_color=style.glow_color
this.applied_style.color=style.color
if(engine.defines.NOPREMUL)v4copy(this.applied_style.color_vec4,style.color_vec4)
else{var alpha=this.applied_style.color_vec4[3]=style.color_vec4[3]
v3scale(this.applied_style.color_vec4,style.color_vec4,alpha)}this.determineShader()}
GlovFont.prototype.ALIGN=ALIGN
GlovFont.prototype.style=fontStyle
GlovFont.prototype.styleAlpha=fontStyleAlpha
GlovFont.prototype.styleColored=fontStyleColored
function fontShadersInit(){if(font_shaders.font_aa)return
font_shaders.font_aa=shaders.create("shaders/font_aa.fp")
font_shaders.font_aa_glow=shaders.create("shaders/font_aa_glow.fp")
font_shaders.font_aa_outline=shaders.create("shaders/font_aa_outline.fp")
font_shaders.font_aa_outline_glow=shaders.create("shaders/font_aa_outline_glow.fp")
shaders.prelink(sprites.sprite_vshader,font_shaders.font_aa)
shaders.prelink(sprites.sprite_vshader,font_shaders.font_aa_glow)
shaders.prelink(sprites.sprite_vshader,font_shaders.font_aa_outline)
shaders.prelink(sprites.sprite_vshader,font_shaders.font_aa_outline_glow)}function fontCreate(font_info,texture_name){fontShadersInit()
return new GlovFont(font_info,texture_name)}function fontTick(){tech_params_cache_idx=0
tech_params_cache.length=0
tech_params_pool_idx=0
techParamsAlloc()}

},{"../common/util.js":74,"../common/vmath.js":76,"./camera2d.js":7,"./engine.js":13,"./geom.js":21,"./localization.js":32,"./shaders.js":46,"./sprites.js":51,"./textures.js":55,"assert":undefined}],20:[function(require,module,exports){
"use strict"
exports.framebufferCapture=framebufferCapture
exports.framebufferEnd=framebufferEnd
exports.framebufferEndOfFrame=framebufferEndOfFrame
exports.framebufferSkipRelease=framebufferSkipRelease
exports.framebufferStart=framebufferStart
exports.framebufferTopOfFrame=framebufferTopOfFrame
exports.framebufferUpdateCanvasForCapture=framebufferUpdateCanvasForCapture
exports.temporaryTextureClaim=temporaryTextureClaim
var assert=require("assert")
var _require=require("./browser.js"),is_ios=_require.is_ios
var _require2=require("./cmds.js"),cmd_parse=_require2.cmd_parse
var _require3=require("./effects.js"),applyCopy=_require3.applyCopy
var engine=require("./engine.js")
var renderWidth=engine.renderWidth,renderHeight=engine.renderHeight
var perf=require("./perf.js")
var settings=require("./settings.js")
var textures=require("./textures.js")
var last_num_passes=0
var num_passes=0
var temporary_textures={}
var temporary_depthbuffers={}
var temporary_depthtextures={}
var reset_fbos=false
function resetFBOs(){reset_fbos=true}var skip_release=false
function framebufferSkipRelease(){skip_release=true}var last_temp_idx=0
function getTemporaryTexture(w,h,possibly_fbo){var key=w+"_"+h
var is_fbo=possibly_fbo&&settings.use_fbos
if(is_fbo)key+="_fbo"
var temp=temporary_textures[key]
if(!temp)temp=temporary_textures[key]={list:[],idx:0}
if(temp.idx>=temp.list.length){var _tex=textures.createForCapture("temp_"+key+"_"+ ++last_temp_idx)
if(is_fbo)_tex.allocFBO(w,h)
temp.list.push(_tex)}return temp.list[temp.idx++]}function bindTemporaryDepthbuffer(w,h){var key=w+"_"+h
var temp=temporary_depthbuffers[key]
if(!temp)temp=temporary_depthbuffers[key]={list:[],idx:0}
if(temp.idx>=temp.list.length){var _depth_buffer=gl.createRenderbuffer()
gl.bindRenderbuffer(gl.RENDERBUFFER,_depth_buffer)
var _attachment
if(settings.fbo_depth16){gl.renderbufferStorage(gl.RENDERBUFFER,gl.DEPTH_COMPONENT16,w,h)
_attachment=gl.DEPTH_ATTACHMENT}else{gl.renderbufferStorage(gl.RENDERBUFFER,gl.DEPTH_STENCIL,w,h)
_attachment=gl.DEPTH_STENCIL_ATTACHMENT}gl.bindRenderbuffer(gl.RENDERBUFFER,null)
temp.list.push({depth_buffer:_depth_buffer,attachment:_attachment})}var _temp$list$temp$idx=temp.list[temp.idx++],depth_buffer=_temp$list$temp$idx.depth_buffer,attachment=_temp$list$temp$idx.attachment
gl.framebufferRenderbuffer(gl.FRAMEBUFFER,attachment,gl.RENDERBUFFER,depth_buffer)}function bindTemporaryDepthbufferTexture(w,h){var key=w+"_"+h
var temp=temporary_depthtextures[key]
if(!temp)temp=temporary_depthtextures[key]={list:[],idx:0}
if(temp.idx>=temp.list.length){var _tex2=textures.createForDepthCapture("temp_"+key+"_"+ ++last_temp_idx,settings.fbo_depth16?textures.format.DEPTH16:textures.format.DEPTH24)
_tex2.allocDepth(w,h)
var _attachment2=settings.fbo_depth16?gl.DEPTH_ATTACHMENT:gl.DEPTH_STENCIL_ATTACHMENT
temp.list.push({tex:_tex2,attachment:_attachment2})}var _temp$list$temp$idx2=temp.list[temp.idx++],tex=_temp$list$temp$idx2.tex,attachment=_temp$list$temp$idx2.attachment
gl.framebufferTexture2D(gl.FRAMEBUFFER,attachment,gl.TEXTURE_2D,tex.handle,0)
return tex}function temporaryTextureClaim(tex){for(var key in temporary_textures){var temp=temporary_textures[key]
var idx=temp.list.indexOf(tex)
if(-1!==idx){temp.list.splice(idx,1)
if(temp.idx>idx)--temp.idx
return}}assert(false)}function framebufferCaptureStart(tex,w,h,possibly_fbo){assert.equal(engine.viewport[0],0)
assert.equal(engine.viewport[1],0)
if(!w){w=renderWidth()
h=renderHeight()}if(!tex)tex=getTemporaryTexture(w,h,possibly_fbo)
tex.captureStart(w,h)
return tex}function framebufferCapture(tex,w,h,filter_linear,wrap){(tex=framebufferCaptureStart(tex,w,h,false)).captureEnd(filter_linear,wrap)
return tex}var cur_tex
var cur_depth
function framebufferStart(opts){assert(!cur_tex)
assert(!cur_depth)
var width=opts.width,height=opts.height,viewport=opts.viewport,final=opts.final,clear=opts.clear,need_depth=opts.need_depth,clear_all=opts.clear_all,clear_color=opts.clear_color,force_tex=opts.force_tex;++num_passes
cur_depth=null
if(force_tex){assert(viewport);(cur_tex=force_tex).captureStart()}else if(!final){cur_tex=framebufferCaptureStart(null,width,height,true)
if(settings.use_fbos)if(need_depth)if("texture"===need_depth)cur_depth=bindTemporaryDepthbufferTexture(width,height)
else bindTemporaryDepthbuffer(width,height)}if(clear_color)gl.clearColor(clear_color[0],clear_color[1],clear_color[2],clear_color[3])
if(clear&&clear_all){gl.disable(gl.SCISSOR_TEST)
gl.clear(gl.COLOR_BUFFER_BIT|(need_depth?gl.DEPTH_BUFFER_BIT:0))}var need_scissor
if(viewport){engine.setViewport(viewport)
need_scissor=viewport[0]||viewport[1]||viewport[2]!==engine.width||viewport[3]!==engine.height
if(clear_all)need_scissor=false}else{engine.setViewport([0,0,width,height])
need_scissor=width!==engine.width}if(need_scissor){gl.enable(gl.SCISSOR_TEST)
if(viewport)gl.scissor(viewport[0],viewport[1],viewport[2],viewport[3])
else gl.scissor(0,0,width,height)}else gl.disable(gl.SCISSOR_TEST)
if(clear&&!clear_all)gl.clear(gl.COLOR_BUFFER_BIT|(need_depth?gl.DEPTH_BUFFER_BIT:0))}function framebufferEnd(opts){assert(cur_tex)
var _opts=opts=opts||{},filter_linear=_opts.filter_linear,wrap=_opts.wrap,need_depth=_opts.need_depth
assert.equal(Boolean(cur_depth),"texture"===need_depth)
cur_tex.captureEnd(filter_linear,wrap)
var ret
if(cur_depth)ret=[cur_tex,cur_depth]
else ret=cur_tex
cur_depth=cur_tex=null
return ret}function framebufferTopOfFrame(){cur_depth=cur_tex=null}function framebufferEndOfFrame(){assert(!cur_tex)
last_num_passes=num_passes
num_passes=0
skip_release=skip_release&&!reset_fbos
for(var key in temporary_textures){var temp=temporary_textures[key]
if(reset_fbos)temp.idx=0
if(!skip_release)while(temp.list.length>temp.idx)temp.list.pop().destroy()
if(!temp.list.length)delete temporary_textures[key]
else temp.idx=0}for(var _key in temporary_depthbuffers){var _temp=temporary_depthbuffers[_key]
if(reset_fbos)_temp.idx=0
if(!skip_release)while(_temp.list.length>_temp.idx){var depth_buffer=_temp.list.pop().depth_buffer
gl.deleteRenderbuffer(depth_buffer)}if(!_temp.list.length)delete temporary_depthbuffers[_key]
else _temp.idx=0}for(var _key2 in temporary_depthtextures){var _temp2=temporary_depthtextures[_key2]
if(reset_fbos)_temp2.idx=0
if(!skip_release)while(_temp2.list.length>_temp2.idx)_temp2.list.pop().tex.destroy()
if(!_temp2.list.length)delete temporary_depthtextures[_key2]
else _temp2.idx=0}skip_release=reset_fbos=false}function framebufferUpdateCanvasForCapture(){if(cur_tex&&settings.use_fbos){var saved_tex=cur_tex
var saved_viewport=engine.viewport.slice(0)
framebufferEnd()
applyCopy({source:saved_tex,final:true,viewport:saved_viewport})
framebufferStart({force_tex:saved_tex,viewport:saved_viewport})
return saved_tex}else return{width:engine.viewport[2],height:engine.viewport[3]}}settings.register({show_passes:{label:"Show Postprocessing Passes",default_value:0,type:cmd_parse.TYPE_INT,range:[0,1]},use_fbos:{label:"Use Framebuffer Objects for postprocessing",default_value:is_ios?1:0,type:cmd_parse.TYPE_INT,range:[0,1],ver:1},fbo_depth16:{label:"Use 16-bit depth buffers for offscreen rendering",default_value:0,type:cmd_parse.TYPE_INT,range:[0,1],on_change:resetFBOs},fbo_rgba:{label:"Use RGBA color buffers for offscreen rendering",default_value:0,type:cmd_parse.TYPE_INT,range:[0,1],on_change:resetFBOs}})
reset_fbos=false
perf.addMetric({name:"passes",show_stat:"show_passes",labels:{"passes: ":function passes(){return last_num_passes.toString()}}})

},{"./browser.js":5,"./cmds.js":9,"./effects.js":12,"./engine.js":13,"./perf.js":37,"./settings.js":44,"./textures.js":55,"assert":undefined}],21:[function(require,module,exports){
"use strict"
exports.TRIANGLE_FAN=exports.TRIANGLES=exports.QUADS=void 0
exports.create=create
exports.createIndices=createIndices
exports.createQuads=createQuads
exports.geomResetState=geomResetState
exports.startup=startup
exports.stats=void 0
var assert=require("assert")
var _require=require("./cmds.js"),cmd_parse=_require.cmd_parse
var engine=require("./engine.js")
var perf=require("./perf.js")
var settings=require("./settings.js")
var _require2=require("./shaders.js"),MAX_SEMANTIC=_require2.MAX_SEMANTIC
var ceil=Math.ceil,max=Math.max,min=Math.min
var TRIANGLES=4
exports.TRIANGLES=TRIANGLES
var TRIANGLE_FAN=6
exports.TRIANGLE_FAN=TRIANGLE_FAN
var QUADS=7
exports.QUADS=QUADS
var MAX_VERT_COUNT=65532
settings.register({show_render_stats:{default_value:0,type:cmd_parse.TYPE_INT,range:[0,1]}})
var stats={draw_calls:0,draw_calls_geom:0,draw_calls_sprite:0,draw_calls_dyn:0,tris:0,verts:0,sprites:0,dyn:0,sprite_sort_elems:0,sprite_sort_cmps:0,font_calls:0,font_params:0}
exports.stats=stats
var last_stats={}
var perf_labels={}
var _loop=function _loop(key){perf_labels[key+": "]=function(){return String(last_stats[key])}}
for(var key in stats)_loop(key)
perf.addMetric({name:"render_stats",show_stat:"show_render_stats",show_all:true,labels:perf_labels})
var gl_byte_size={5120:1,5121:1,5122:2,5123:2,5126:4}
var bound_geom
var bound_array_buf=null
var bound_index_buf=null
var quad_index_buf
var quad_index_buf_len=0
function deleteBuffer(handle){if(!handle)return
if(bound_array_buf===handle){gl.bindBuffer(gl.ARRAY_BUFFER,null)
bound_array_buf=null}if(bound_index_buf===handle){gl.bindBuffer(gl.ELEMENT_ARRAY_BUFFER,null)
bound_index_buf=null}gl.deleteBuffer(handle)}var attrib_enabled=0
function enableVertexAttribArray(bits){if(bits===attrib_enabled)return
var disable_mask=attrib_enabled&~bits
var enable_mask=~attrib_enabled&bits
attrib_enabled=bits
if(disable_mask){var n=0
do{if(1&disable_mask)gl.disableVertexAttribArray(n)
n++
disable_mask>>=1}while(disable_mask)}if(enable_mask){var _n=0
do{if(1&enable_mask)gl.enableVertexAttribArray(_n)
_n++
enable_mask>>=1}while(enable_mask)}}function getQuadIndexBuf(quad_count){assert(quad_count<=MAX_VERT_COUNT/4)
if(6*quad_count>quad_index_buf_len){if(!quad_index_buf)quad_index_buf=gl.createBuffer()
else engine.perf_state.gpu_mem.geom-=2*quad_index_buf_len
quad_index_buf_len=min(max(ceil(1.5*quad_index_buf_len),6*quad_count),6*MAX_VERT_COUNT/4)
if(bound_index_buf!==quad_index_buf){gl.bindBuffer(gl.ELEMENT_ARRAY_BUFFER,quad_index_buf)
bound_index_buf=quad_index_buf}var arr=new Uint16Array(quad_index_buf_len)
var vidx=0
for(var ii=0;ii<quad_index_buf_len;){arr[ii++]=vidx+1
arr[ii++]=vidx+3
arr[ii++]=vidx++
arr[ii++]=vidx++
arr[ii++]=vidx++
arr[ii++]=vidx++}gl.bufferData(gl.ELEMENT_ARRAY_BUFFER,arr,gl.STATIC_DRAW)
engine.perf_state.gpu_mem.geom+=2*quad_index_buf_len}return quad_index_buf}function createIndices(idxs){var ret={ibo:gl.createBuffer(),ibo_size:idxs.length}
gl.bindBuffer(gl.ELEMENT_ARRAY_BUFFER,ret.ibo)
bound_index_buf=ret.ibo
gl.bufferData(gl.ELEMENT_ARRAY_BUFFER,idxs,gl.STATIC_DRAW)
engine.perf_state.gpu_mem.geom+=2*idxs.length
return ret}function formatInfo(format){if(!format.info){var stride=0
var elem_count=0
var used_attribs=0
var common_byte_size=0
for(var ii=0;ii<format.length;++ii){var fmt=format[ii]
var sem=fmt[0]
var gltype=fmt[1]
var count=fmt[2]
used_attribs|=1<<sem
var byte_size=gl_byte_size[gltype]
assert(byte_size)
assert(!common_byte_size||byte_size===common_byte_size)
common_byte_size=byte_size
fmt[3]=fmt[3]||false
stride+=count*(fmt[4]=byte_size)
elem_count+=count}format.info={stride:stride,elem_count:elem_count,used_attribs:used_attribs,common_byte_size:common_byte_size}}return format.info}function Geom(format,verts,idxs,mode){this.mode=mode||TRIANGLES
this.format=format
var info=this.format_info=formatInfo(format)
this.stride=info.stride
this.used_attribs=info.used_attribs
this.vert_count=verts.length/this.format_info.elem_count
this.vert_gpu_mem=verts.length*this.format_info.common_byte_size
if(verts.length){this.vbo=gl.createBuffer()
gl.bindBuffer(gl.ARRAY_BUFFER,this.vbo)
bound_array_buf=this.vbo
gl.bufferData(gl.ARRAY_BUFFER,verts,gl.STATIC_DRAW)
engine.perf_state.gpu_mem.geom+=this.vert_gpu_mem}this.orig_mode=mode
if(idxs)if(idxs.ibo){this.ibo=idxs.ibo
this.ibo_owned=false
this.ibo_size=idxs.ibo_size}else if(idxs.length){this.ibo=gl.createBuffer()
this.ibo_owned=true
this.ibo_size=idxs.length
gl.bindBuffer(gl.ELEMENT_ARRAY_BUFFER,this.ibo)
bound_index_buf=this.ibo
gl.bufferData(gl.ELEMENT_ARRAY_BUFFER,idxs,gl.STATIC_DRAW)
engine.perf_state.gpu_mem.geom+=2*idxs.length}else{this.ibo=null
this.ibo_owned=true
this.ibo_size=0}else if(mode===QUADS){assert.equal(this.vert_count%4,0)
var quad_count=this.vert_count/4
this.ibo=getQuadIndexBuf(quad_count)
this.ibo_owned=false
this.ibo_size=6*quad_count
this.mode=TRIANGLES}else if(mode===TRIANGLE_FAN)this.mode=TRIANGLE_FAN
else{this.ibo=null
this.ibo_owned=false}this.updateTriCount()}function trianglesFromMode(mode,eff_vert_count){if(mode===TRIANGLES)return eff_vert_count/3
else if(mode===TRIANGLE_FAN)return eff_vert_count-2
else{assert(!eff_vert_count)
return 0}}Geom.prototype.updateTriCount=function(){var eff_vert_count=this.ibo?this.ibo_size:this.vert_count
this.tri_count=trianglesFromMode(this.mode,eff_vert_count)}
Geom.prototype.updateIndex=function(idxs,num_idxs){assert.equal(this.ibo_owned,true)
if(num_idxs>this.ibo_size){if(bound_geom===this)bound_geom=null
engine.perf_state.gpu_mem.geom-=2*this.ibo_size
deleteBuffer(this.ibo)
this.ibo_size=idxs.length
this.ibo=gl.createBuffer()
gl.bindBuffer(gl.ELEMENT_ARRAY_BUFFER,this.ibo)
bound_index_buf=this.ibo
gl.bufferData(gl.ELEMENT_ARRAY_BUFFER,idxs,gl.DYNAMIC_DRAW)
engine.perf_state.gpu_mem.geom+=2*idxs.length}else{if(bound_index_buf!==this.ibo){gl.bindBuffer(gl.ELEMENT_ARRAY_BUFFER,this.ibo)
bound_index_buf=this.ibo}gl.bufferSubData(gl.ELEMENT_ARRAY_BUFFER,0,idxs.subarray(0,num_idxs))}this.updateTriCount()}
Geom.prototype.updateSub=function(offset,verts){if(bound_array_buf!==this.vbo){gl.bindBuffer(gl.ARRAY_BUFFER,this.vbo)
bound_array_buf=this.vbo}gl.bufferSubData(gl.ARRAY_BUFFER,offset,verts)}
Geom.prototype.update=function(verts,num_verts){if(num_verts>this.vert_count){if(bound_geom===this)bound_geom=null
engine.perf_state.gpu_mem.geom-=this.vert_gpu_mem
deleteBuffer(this.vbo)
this.vert_count=verts.length/this.format_info.elem_count
this.vert_gpu_mem=verts.length*this.format_info.common_byte_size
this.vbo=gl.createBuffer()
gl.bindBuffer(gl.ARRAY_BUFFER,this.vbo)
bound_array_buf=this.vbo
gl.bufferData(gl.ARRAY_BUFFER,verts,gl.DYNAMIC_DRAW)
engine.perf_state.gpu_mem.geom+=this.vert_gpu_mem}else{if(bound_array_buf!==this.vbo){gl.bindBuffer(gl.ARRAY_BUFFER,this.vbo)
bound_array_buf=this.vbo}gl.bufferSubData(gl.ARRAY_BUFFER,0,verts.subarray(0,num_verts*this.format_info.elem_count))}if(this.orig_mode===QUADS){assert.equal(this.ibo_owned,false)
var quad_count=num_verts/4
this.ibo=getQuadIndexBuf(quad_count)
this.ibo_size=6*quad_count}this.updateTriCount()}
Geom.prototype.dispose=function(){if(this.ibo_owned)deleteBuffer(this.ibo)
this.ibo=null
deleteBuffer(this.vbo)
this.vbo=null
engine.perf_state.gpu_mem.geom-=this.vert_gpu_mem
this.vert_gpu_mem=0}
var bound_attribs=function(){var r=[]
for(var ii=0;ii<16;++ii)r.push({vbo:null,offset:0})
return r}()
function geomResetState(){bound_index_buf=bound_geom=null
gl.bindBuffer(gl.ELEMENT_ARRAY_BUFFER,null)
bound_array_buf=null
gl.bindBuffer(gl.ARRAY_BUFFER,null)
for(var ii=0;ii<MAX_SEMANTIC;++ii)gl.disableVertexAttribArray(ii)
for(var _ii=attrib_enabled=0;_ii<bound_attribs.length;++_ii)bound_attribs[_ii].vbo=null
stats.draw_calls=stats.draw_calls_geom+stats.draw_calls_sprite
for(var _key in stats){last_stats[_key]=stats[_key]
stats[_key]=0}}Geom.prototype.bind=function(){if(bound_geom!==this){var vbo=(bound_geom=this).vbo
var offset=0
for(var ii=0;ii<this.format.length;++ii){var fmt=this.format[ii]
var count=fmt[2]
var byte_size=fmt[4]
var sem=fmt[0]
if(bound_attribs[sem].vbo===vbo);else{if(bound_array_buf!==vbo){gl.bindBuffer(gl.ARRAY_BUFFER,vbo)
bound_array_buf=vbo}var gltype=fmt[1]
var normalized=fmt[3]
gl.vertexAttribPointer(sem,count,gltype,normalized,this.stride,offset)
bound_attribs[sem].vbo=bound_array_buf}offset+=count*byte_size}enableVertexAttribArray(this.used_attribs)}if(this.ibo&&bound_index_buf!==this.ibo){gl.bindBuffer(gl.ELEMENT_ARRAY_BUFFER,this.ibo)
bound_index_buf=this.ibo}}
Geom.prototype.draw=function(){this.bind();++stats.draw_calls_geom
stats.tris+=this.tri_count
stats.verts+=this.vert_count
if(this.ibo)gl.drawElements(this.mode,this.ibo_size,gl.UNSIGNED_SHORT,0)
else gl.drawArrays(this.mode,0,this.vert_count)}
Geom.prototype.drawSub=function(start,tri_count){assert.equal(this.mode,TRIANGLES)
this.bind();++stats.draw_calls_geom
if(this.ibo){stats.tris+=tri_count
stats.verts+=2*tri_count
gl.drawElements(this.mode,3*tri_count,gl.UNSIGNED_SHORT,2*start)}else gl.drawArrays(this.mode,start,3*tri_count)}
function GeomMultiQuads(format,verts){var ec=formatInfo(format).elem_count
var vert_count=verts.length/ec
this.geoms=[]
for(var idx=0;idx<vert_count;idx+=MAX_VERT_COUNT){var num_sub_verts=min(vert_count-idx,MAX_VERT_COUNT)
var sub_data=new Uint8Array(verts.buffer,idx*ec,num_sub_verts*ec)
this.geoms.push(new Geom(format,sub_data,null,QUADS))}}GeomMultiQuads.prototype.draw=function(){for(var ii=0;ii<this.geoms.length;++ii)this.geoms[ii].draw()}
GeomMultiQuads.prototype.dispose=function(){for(var ii=0;ii<this.geoms.length;++ii)this.geoms[ii].dispose()
this.geoms=null}
function create(format,verts,idxs,mode){return new Geom(format,verts,idxs,mode)}function createQuads(format,verts,fixed_size){var format_info=formatInfo(format)
assert(fixed_size||verts instanceof Uint8Array)
if(verts.length/format_info.elem_count>MAX_VERT_COUNT)return new GeomMultiQuads(format,verts)
return new Geom(format,verts,null,QUADS)}function startup(){}

},{"./cmds.js":9,"./engine.js":13,"./perf.js":37,"./settings.js":44,"./shaders.js":46,"assert":undefined}],22:[function(require,module,exports){
"use strict"
exports.decode=decode
var charCache=new Array(128)
var charFromCodePt=String.fromCodePoint||String.fromCharCode
var result=[]
function decode(array){var codePt
var byte1
var buffLen=array.length
for(var i=result.length=0;i<buffLen;){if((byte1=array[i++])<=127)codePt=byte1
else if(byte1<=223)codePt=(31&byte1)<<6|63&array[i++]
else if(byte1<=239)codePt=(15&byte1)<<12|(63&array[i++])<<6|63&array[i++]
else if(String.fromCodePoint)codePt=(7&byte1)<<18|(63&array[i++])<<12|(63&array[i++])<<6|63&array[i++]
else{codePt=63
i+=3}result.push(charCache[codePt]||(charCache[codePt]=charFromCodePt(codePt)))}return result.join("")}

},{}],23:[function(require,module,exports){
"use strict"
exports.ATTRIBUTE_TYPE_TO_COMPONENTS=exports.ATTRIBUTE_COMPONENT_TYPE_TO_BYTE_SIZE=exports.ATTRIBUTE_COMPONENT_TYPE_TO_ARRAY=void 0
exports.getAccessorTypeFromSize=getAccessorTypeFromSize
var TYPES=["SCALAR","VEC2","VEC3","VEC4"]
function getAccessorTypeFromSize(size){return TYPES[size-1]||TYPES[0]}var ATTRIBUTE_TYPE_TO_COMPONENTS={SCALAR:1,VEC2:2,VEC3:3,VEC4:4,MAT2:4,MAT3:9,MAT4:16}
exports.ATTRIBUTE_TYPE_TO_COMPONENTS=ATTRIBUTE_TYPE_TO_COMPONENTS
var ATTRIBUTE_COMPONENT_TYPE_TO_BYTE_SIZE={5120:1,5121:1,5122:2,5123:2,5125:4,5126:4}
exports.ATTRIBUTE_COMPONENT_TYPE_TO_BYTE_SIZE=ATTRIBUTE_COMPONENT_TYPE_TO_BYTE_SIZE
var ATTRIBUTE_COMPONENT_TYPE_TO_ARRAY={5120:Int8Array,5121:Uint8Array,5122:Int16Array,5123:Uint16Array,5125:Uint32Array,5126:Float32Array}
exports.ATTRIBUTE_COMPONENT_TYPE_TO_ARRAY=ATTRIBUTE_COMPONENT_TYPE_TO_ARRAY

},{}],24:[function(require,module,exports){
"use strict"
var assert=require("assert")
var _require=require("./unpack-glb-buffers.js"),unpackGLBBuffers=_require.unpackGLBBuffers
var _require2=require("./unpack-binary-json.js"),unpackBinaryJson=_require2.unpackBinaryJson
function padTo4Bytes(byteLength){return byteLength+3&-4}var decode_utf8=require("./decode-utf8.js")
var _require3=require("./gltf-type-utils.js"),ATTRIBUTE_TYPE_TO_COMPONENTS=_require3.ATTRIBUTE_TYPE_TO_COMPONENTS,ATTRIBUTE_COMPONENT_TYPE_TO_BYTE_SIZE=_require3.ATTRIBUTE_COMPONENT_TYPE_TO_BYTE_SIZE,ATTRIBUTE_COMPONENT_TYPE_TO_ARRAY=_require3.ATTRIBUTE_COMPONENT_TYPE_TO_ARRAY
var MAGIC_glTF=1735152710
var GLB_FILE_HEADER_SIZE=12
var GLB_CHUNK_HEADER_SIZE=8
var GLB_CHUNK_TYPE_JSON=1313821514
var GLB_CHUNK_TYPE_BIN=5130562
var LE=true
var BE=false
function GLBParser(){this.binaryByteOffset=null
this.packedJson=null
this.json=null}function parseBinary(self){var dataView=new DataView(self.glbArrayBuffer)
var magic1=dataView.getUint32(0,BE)
var version=dataView.getUint32(4,LE)
var fileLength=dataView.getUint32(8,LE)
var valid=magic1===MAGIC_glTF
if(!valid)console.warn("Invalid GLB magic string")
assert(2===version,"Invalid GLB version "+version+". Only .glb v2 supported")
assert(fileLength>20)
var jsonChunkLength=dataView.getUint32(12,LE)
var jsonChunkFormat=dataView.getUint32(16,LE)
assert(valid=jsonChunkFormat===GLB_CHUNK_TYPE_JSON||0===jsonChunkFormat,"JSON chunk format "+jsonChunkFormat)
var jsonChunkOffset=GLB_FILE_HEADER_SIZE+GLB_CHUNK_HEADER_SIZE
var jsonChunk=new Uint8Array(self.glbArrayBuffer,jsonChunkOffset,jsonChunkLength)
var jsonText=decode_utf8.decode(jsonChunk)
self.json=JSON.parse(jsonText)
var binaryChunkStart=jsonChunkOffset+padTo4Bytes(jsonChunkLength)
self.binaryByteOffset=binaryChunkStart+GLB_CHUNK_HEADER_SIZE
var binChunkFormat=dataView.getUint32(binaryChunkStart+4,LE)
assert(valid=binChunkFormat===GLB_CHUNK_TYPE_BIN||1===binChunkFormat,"BIN chunk format "+binChunkFormat)
return{arrayBuffer:self.glbArrayBuffer,binaryByteOffset:self.binaryByteOffset,json:self.json}}function parseInternal(self){var result=parseBinary(self)
self.packedJson=result.json
self.unpackedBuffers=unpackGLBBuffers(self.glbArrayBuffer,self.json,self.binaryByteOffset)
self.json=unpackBinaryJson(self.json,self.unpackedBuffers)}GLBParser.prototype.parseSync=function(arrayBuffer){this.glbArrayBuffer=arrayBuffer
if(null===this.json&&null===this.binaryByteOffset)parseInternal(this)
return this}
GLBParser.prototype.parse=function(arrayBuffer){return this.parseSync(arrayBuffer)}
GLBParser.prototype.getApplicationData=function(key){return this.json[key]}
GLBParser.prototype.getJSON=function(){return this.json}
GLBParser.prototype.getArrayBuffer=function(){return this.glbArrayBuffer}
GLBParser.prototype.getBinaryByteOffset=function(){return this.binaryByteOffset}
GLBParser.prototype.getBufferView=function(glTFBufferView){var byteOffset=(glTFBufferView.byteOffset||0)+this.binaryByteOffset
return new Uint8Array(this.glbArrayBuffer,byteOffset,glTFBufferView.byteLength)}
GLBParser.prototype.getBuffer=function(glTFAccessor){var ArrayType=ATTRIBUTE_COMPONENT_TYPE_TO_ARRAY[glTFAccessor.componentType]
var components=ATTRIBUTE_TYPE_TO_COMPONENTS[glTFAccessor.type]
var bytesPerComponent=ATTRIBUTE_COMPONENT_TYPE_TO_BYTE_SIZE[glTFAccessor.componentType]
var length=glTFAccessor.count*components
var byteLength=glTFAccessor.count*components*bytesPerComponent
var glTFBufferView=this.json.bufferViews[glTFAccessor.bufferView]
assert(byteLength>=0&&glTFAccessor.byteOffset+byteLength<=glTFBufferView.byteLength)
var byteOffset=glTFBufferView.byteOffset+this.binaryByteOffset+glTFAccessor.byteOffset
return new ArrayType(this.glbArrayBuffer,byteOffset,length)}
GLBParser.prototype.getImageData=function(glTFImage){return{typedArray:this.getBufferView(glTFImage.bufferView),mimeType:glTFImage.mimeType||"image/jpeg"}}
GLBParser.prototype.getImage=function(glTFImage){var arrayBufferView=this.getBufferView(glTFImage.bufferView)
var mimeType=glTFImage.mimeType||"image/jpeg"
var blob=new Blob([arrayBufferView],{type:mimeType})
var imageUrl=(window.URL||window.webkitURL).createObjectURL(blob)
var img=new Image
img.src=imageUrl
return img};(module.exports=GLBParser).parse=function(data){return(new GLBParser).parse(data)}

},{"./decode-utf8.js":22,"./gltf-type-utils.js":23,"./unpack-binary-json.js":25,"./unpack-glb-buffers.js":26,"assert":undefined}],25:[function(require,module,exports){
"use strict"
exports.unpackBinaryJson=unpackBinaryJson
function parseJSONPointer(value){if("string"===typeof value){if(0===value.indexOf("##/"))return value.slice(1)
var matches=value.match(/#\/([a-z]+)\/([0-9]+)/)
if(matches){var index=parseInt(matches[2],10)
return[matches[1],index]}if(matches=value.match(/\$\$\$([0-9]+)/))return["accessors",parseInt(matches[1],10)]}return null}function decodeJSONPointer(object,buffers){var pointer=parseJSONPointer(object)
if(pointer){var field=pointer[0]
var index=pointer[1]
var buffer=buffers[field]&&buffers[field][index]
if(buffer)return buffer
console.error("Invalid JSON pointer "+object+": #/"+field+"/"+index)}return null}function unpackJsonArraysRecursive(json,topJson,buffers,options){if(void 0===options)options={}
var object=json
var buffer=decodeJSONPointer(object,buffers)
if(buffer)return buffer
if(Array.isArray(object))return object.map(function(element){return unpackJsonArraysRecursive(element,topJson,buffers,options)})
if(null!==object&&"object"===typeof object){var newObject={}
for(var key in object)newObject[key]=unpackJsonArraysRecursive(object[key],topJson,buffers,options)
return newObject}return object}function unpackBinaryJson(json,buffers,options){if(void 0===options)options={}
return unpackJsonArraysRecursive(json,json,buffers,options)}

},{}],26:[function(require,module,exports){
"use strict"
exports.unpackGLBBuffers=unpackGLBBuffers
var assert=require("assert")
var _require=require("./gltf-type-utils.js"),ATTRIBUTE_TYPE_TO_COMPONENTS=_require.ATTRIBUTE_TYPE_TO_COMPONENTS,ATTRIBUTE_COMPONENT_TYPE_TO_BYTE_SIZE=_require.ATTRIBUTE_COMPONENT_TYPE_TO_BYTE_SIZE,ATTRIBUTE_COMPONENT_TYPE_TO_ARRAY=_require.ATTRIBUTE_COMPONENT_TYPE_TO_ARRAY
function getArrayBufferAtOffset(arrayBuffer,byteOffset){var length=arrayBuffer.byteLength-byteOffset
var binaryBuffer=new ArrayBuffer(length)
var sourceArray=new Uint8Array(arrayBuffer)
var binaryArray=new Uint8Array(binaryBuffer)
for(var i=0;i<length;i++)binaryArray[i]=sourceArray[byteOffset+i]
return binaryBuffer}function getArrayTypeAndLength(accessor,bufferView){var ArrayType=ATTRIBUTE_COMPONENT_TYPE_TO_ARRAY[accessor.componentType]
var components=ATTRIBUTE_TYPE_TO_COMPONENTS[accessor.type]
var bytesPerComponent=ATTRIBUTE_COMPONENT_TYPE_TO_BYTE_SIZE[accessor.componentType]
var length=accessor.count*components
var byteLength=accessor.count*components*bytesPerComponent
assert(byteLength>=0&&byteLength<=bufferView.byteLength)
return{ArrayType:ArrayType,length:length,byteLength:byteLength}}function unpackAccessors(arrayBuffer,bufferViews,json){var accessors=json.accessors||[]
var accessorBuffers=[]
for(var i=0;i<accessors.length;++i){var accessor=accessors[i]
assert(accessor)
var bufferView=bufferViews[accessor.bufferView]
if(bufferView){var _getArrayTypeAndLengt=getArrayTypeAndLength(accessor,bufferView),ArrayType=_getArrayTypeAndLengt.ArrayType,length=_getArrayTypeAndLengt.length
var array=new ArrayType(arrayBuffer,bufferView.byteOffset,length)
array.accessor=accessor
accessorBuffers.push(array)}}return accessorBuffers}function unpackImages(arrayBuffer,bufferViews,json){var images=json.images||[]
var imageBuffers=[]
for(var i=0;i<images.length;++i){var image=images[i]
assert(image)
if(void 0===image.bufferView){imageBuffers.push(null)
continue}var bufferView=bufferViews[image.bufferView]
assert(bufferView)
var array=new Uint8Array(arrayBuffer,bufferView.byteOffset,bufferView.byteLength)
array.imate=image
imageBuffers.push(array)}return imageBuffers}function unpackGLBBuffers(arrayBuffer,json,binaryByteOffset){if(binaryByteOffset)arrayBuffer=getArrayBufferAtOffset(arrayBuffer,binaryByteOffset)
var bufferViews=json.bufferViews||[]
for(var i=0;i<bufferViews.length;++i){var bufferView=bufferViews[i]
assert(bufferView.byteLength>=0)}return{accessors:unpackAccessors(arrayBuffer,bufferViews,json),images:unpackImages(arrayBuffer,bufferViews,json)}}

},{"./gltf-type-utils.js":23,"assert":undefined}],27:[function(require,module,exports){
"use strict"
exports.handle=handle
exports.on=on
exports.topOfFrame=topOfFrame
var assert=require("assert")
var cbs={}
function topOfFrame(){cbs={}}function on(type,code_or_pos,cb){var list=cbs[type]=cbs[type]||[]
if("number"===typeof code_or_pos)list[code_or_pos]=cb
else list.push([code_or_pos,cb])}function handle(type,event){var list=cbs[type]
if(!list)return
switch(type){case"keydown":case"keyup":if(list[event.keyCode])list[event.keyCode](type,event)
break
case"mouseup":case"mousedown":var x=event.pageX
var y=event.pageY
var button=event.button
for(var ii=0;ii<list.length;++ii){var elem=list[ii]
var pos=elem[0]
if(x>=pos.x&&x<pos.x+pos.w&&y>=pos.y&&y<pos.y+pos.h&&(pos.button<0||pos.button===button)){elem[1](type,event)
break}}break
default:assert(false)}}

},{"assert":undefined}],28:[function(require,module,exports){
"use strict"
exports.click=exports.PAD=exports.KEYS=void 0
exports.debugGetMouseMoveX=debugGetMouseMoveX
exports.drag=drag
exports.dragDrop=dragDrop
exports.dragOver=dragOver
exports.eatAllInput=eatAllInput
exports.eatAllKeyboardInput=eatAllKeyboardInput
exports.endFrame=endFrame
exports.fakeTouchEvent=fakeTouchEvent
exports.handleTouches=handleTouches
exports.inputClick=void 0
exports.inputEatenMouse=inputEatenMouse
exports.inputLastTime=inputLastTime
exports.inputTouchMode=inputTouchMode
exports.keyDown=keyDown
exports.keyDownEdge=keyDownEdge
exports.keyUpEdge=keyUpEdge
exports.longPress=longPress
exports.mouseButtonHadEdge=mouseButtonHadEdge
exports.mouseButtonHadUpEdge=mouseButtonHadUpEdge
exports.mouseConsumeClicks=mouseConsumeClicks
exports.mouseDomPos=mouseDomPos
exports.mouseDownAnywhere=mouseDownAnywhere
exports.mouseDownEdge=mouseDownEdge
exports.mouseDownMidClick=mouseDownMidClick
exports.mouseDownOverBounds=mouseDownOverBounds
exports.mouseMoved=mouseMoved
exports.mouseOver=mouseOver
exports.mouseOverCaptured=mouseOverCaptured
exports.mousePos=mousePos
exports.mousePosIsTouch=mousePosIsTouch
exports.mouseUpEdge=mouseUpEdge
exports.mouseWheel=mouseWheel
exports.numTouches=numTouches
exports.padButtonDown=padButtonDown
exports.padButtonDownEdge=padButtonDownEdge
exports.padButtonUpEdge=padButtonUpEdge
exports.padGetAxes=padGetAxes
exports.pad_mode=void 0
exports.pointerLockEnter=pointerLockEnter
exports.pointerLockExit=pointerLockExit
exports.pointerLockJustEntered=pointerLockJustEntered
exports.pointerLocked=pointerLocked
exports.startup=startup
exports.tickInput=tickInput
exports.tickInputInactive=tickInputInactive
exports.touch_mode=void 0
var _input_constants2=require("./input_constants")
var assert=require("assert")
var UP_EDGE=0
var UP=0
var DOWN=1
var DOWN_EDGE=2
var TOUCH_AS_MOUSE=true
var map_analog_to_dpad=true
var mouse_log=false
var click=mouseUpEdge
exports.click=click
var inputClick=mouseUpEdge
exports.inputClick=inputClick
var _require=require("../common/util.js"),deprecate=_require.deprecate
deprecate(exports,"mouseDown","mouseDownAnywhere, mouseDownMidClick, mouseDownOverBounds")
var _input_constants=require("./input_constants")
var ANY=_input_constants.ANY
var POINTERLOCK=_input_constants.POINTERLOCK
for(var _input_constants2_key in _input_constants2)if("default"!==_input_constants2_key)exports[_input_constants2_key]=_input_constants2[_input_constants2_key]
var KEYS={BACKSPACE:8,TAB:9,ENTER:13,RETURN:13,SHIFT:16,CTRL:17,ALT:18,ESC:27,ESCAPE:27,SPACE:32,PAGEUP:33,PAGEDOWN:34,END:35,HOME:36,LEFT:37,UP:38,RIGHT:39,DOWN:40,INS:45,DEL:46,0:48,1:49,2:50,3:51,4:52,5:53,6:54,7:55,8:56,9:57,A:65,B:66,C:67,D:68,E:69,F:70,G:71,H:72,I:73,J:74,K:75,L:76,M:77,N:78,O:79,P:80,Q:81,R:82,S:83,T:84,U:85,V:86,W:87,X:88,Y:89,Z:90,NUMPAD0:96,NUMPAD1:97,NUMPAD2:98,NUMPAD3:99,NUMPAD4:100,NUMPAD5:101,NUMPAD6:102,NUMPAD7:103,NUMPAD8:104,NUMPAD9:105,NUMPAD_MULTIPLY:106,NUMPAD_ADD:107,NUMPAD_SUBTRACT:109,NUMPAD_DECIMAL_POINT:110,NUMPAD_DIVIDE:111,F1:112,F2:113,F3:114,F4:115,F5:116,F6:117,F7:118,F8:119,F9:120,F10:121,F11:122,F12:123,EQUALS:187,COMMA:188,MINUS:189,PERIOD:190,SLASH:191,TILDE:192}
exports.KEYS=KEYS
if("function"===typeof Proxy)exports.KEYS=KEYS=new Proxy(KEYS,{get:function get(target,prop){var ret=target[prop]
assert(ret)
return ret}})
var PAD={A:0,SELECT:0,B:1,CANCEL:1,X:2,Y:3,LB:4,LEFT_BUMPER:4,RB:5,RIGHT_BUMPER:5,LT:6,LEFT_TRIGGER:6,RT:7,RIGHT_TRIGGER:7,BACK:8,START:9,LEFT_STICK:10,RIGHT_STICK:11,UP:12,DOWN:13,LEFT:14,RIGHT:15,ANALOG_UP:20,ANALOG_LEFT:21,ANALOG_DOWN:22,ANALOG_RIGHT:23,LSTICK_UP:20,LSTICK_LEFT:21,LSTICK_DOWN:22,LSTICK_RIGHT:23,RSTICK_UP:24,RSTICK_LEFT:25,RSTICK_DOWN:26,RSTICK_RIGHT:27}
exports.PAD=PAD
var _require2=require("./browser.js"),is_firefox=_require2.is_firefox,is_mac_osx=_require2.is_mac_osx
var camera2d=require("./camera2d.js")
var _require3=require("./cmds.js"),cmd_parse=_require3.cmd_parse
var engine=require("./engine.js")
var in_event=require("./in_event.js")
var local_storage=require("./local_storage.js")
var abs=Math.abs,max=Math.max,min=Math.min,sqrt=Math.sqrt
var pointer_lock=require("./pointer_lock.js")
var settings=require("./settings.js")
var _require4=require("./sound.js"),soundResume=_require4.soundResume
var _require5=require("./spot.js"),spotMouseoverHook=_require5.spotMouseoverHook
var _require6=require("../common/util.js"),empty=_require6.empty
var _require7=require("../common/vmath.js"),vec2=_require7.vec2,v2add=_require7.v2add,v2copy=_require7.v2copy,v2lengthSq=_require7.v2lengthSq,v2set=_require7.v2set,v2scale=_require7.v2scale,v2sub=_require7.v2sub
var pad_to_touch
var canvas
var key_state_new={}
var pad_states=[]
var gamepad_data=[]
var mouse_pos=vec2()
var last_mouse_pos=vec2()
var mouse_pos_is_touch=false
var mouse_over_captured=false
var mouse_down=[]
var wheel_events=[]
var movement_questionable_frames=0
var MOVEMENT_QUESTIONABLE_FRAMES=2
var input_eaten_kb=false
var input_eaten_mouse=false
var touches={}
var no_active_touches=true
var touch_mode=local_storage.getJSON("touch_mode",false)
var pad_mode=!(exports.touch_mode=touch_mode)&&local_storage.getJSON("pad_mode",false)
exports.pad_mode=pad_mode
cmd_parse.registerValue("mouse_log",{type:cmd_parse.TYPE_INT,range:[0,1],get:function get(){return mouse_log},set:function set(v){return mouse_log=v}})
function inputTouchMode(){return touch_mode}function inputEatenMouse(){return input_eaten_mouse}function eventTimestamp(event){if(event&&event.timeStamp){if(event.timeStamp<1e12!==engine.hrtime<1e12)return engine.hrtime
return event.timeStamp}return engine.hrtime}function TouchData(pos,touch,button,event){this.delta=vec2()
this.total=0
this.cur_pos=pos.slice(0)
this.start_pos=pos.slice(0)
this.touch=touch
this.button=button
this.start_time=Date.now()
this.dispatched=false
this.dispatched_drag=false
this.dispatched_drag_over=false
this.was_double_click=false
this.up_edge=0
this.down_edge=0
this.state=DOWN
this.down_time=0
this.origin_time=eventTimestamp(event)}TouchData.prototype.down=function(event,is_edge){if(is_edge)this.down_edge++
this.state=DOWN
this.origin_time=eventTimestamp(event)}
var MIN_EVENT_TIME_DELTA=.01
function timeDelta(event,origin_time){var et=eventTimestamp(event)
return max(et-origin_time,MIN_EVENT_TIME_DELTA)}function KeyData(){this.down_edge=0
this.origin_time=0
this.down_time=0
this.up_edge=0
this.state=UP}KeyData.prototype.keyUp=function(event){++this.up_edge
this.down_time+=timeDelta(event,this.origin_time)
this.state=UP}
function setMouseToMid(){v2set(mouse_pos,.5*engine.width/camera2d.domToCanvasRatio(),.5*engine.height/camera2d.domToCanvasRatio())}function pointerLocked(){return pointer_lock.isLocked()}var pointerlock_touch_id="m"+POINTERLOCK
var pointerlock_frame=-1
function pointerLockEnter(when){pointer_lock.enter(when)}function onPointerLockEnter(){if(touch_mode)return
pointerlock_frame=engine.frame_index
var touch_data=touches[pointerlock_touch_id]
setMouseToMid()
if(touch_data){v2copy(touch_data.start_pos,mouse_pos)
touch_data.state=DOWN
touch_data.origin_time=engine.hrtime}else touch_data=touches[pointerlock_touch_id]=new TouchData(mouse_pos,false,POINTERLOCK,null)
movement_questionable_frames=MOVEMENT_QUESTIONABLE_FRAMES}function pointerLockJustEntered(num_frames){return engine.frame_index<=pointerlock_frame+(num_frames||1)}function pointerLockExit(){var touch_data=touches[pointerlock_touch_id]
if(touch_data){v2copy(touch_data.cur_pos,mouse_pos)
touch_data.state=UP}pointer_lock.exit()
movement_questionable_frames=MOVEMENT_QUESTIONABLE_FRAMES}var last_event
var skip={isTrusted:1,sourceCapabilities:1,path:1,currentTarget:1,view:1}
function eventlog(event){if(event===last_event)return
var pairs=[]
for(var k in last_event=event){var v=event[k]
if(!v||"function"===typeof v||k.toUpperCase()===k||skip[k])continue
pairs.push(k+":"+(v.id||v))}console.log(engine.frame_index+" "+event.type+" "+(pointerLocked()?"ptrlck":"unlckd")+" "+pairs.join(","))}function letWheelEventThrough(event){return event.target&&("INPUT"===event.target.tagName||"TEXTAREA"===event.target.tagName||"LABEL"===event.target.tagName)}function letEventThrough(event){return event.target&&("INPUT"===event.target.tagName||"TEXTAREA"===event.target.tagName||"LABEL"===event.target.tagName||String(event.target.className).includes("noglov"))}function ignored(event){if(!letEventThrough(event)){event.preventDefault()
event.stopPropagation()}}var ctrl_checked=false
var unload_protected=false
function beforeUnload(e){if(unload_protected&&ctrl_checked){pointerLockExit()
e.preventDefault()
e.returnValue="Are you sure you want to quit?"}else engine.releaseCanvas()}function protectUnload(enable){unload_protected=enable}var last_input_time=0
function inputLastTime(){return last_input_time}function onUserInput(){soundResume()
last_input_time=Date.now()}function releaseAllKeysDown(evt){for(var code in key_state_new){var ks=key_state_new[code]
if(ks.state===DOWN)ks.keyUp(evt)}}function onKeyUp(event){protectUnload(event.ctrlKey)
var code=event.keyCode
if(!letEventThrough(event)){event.stopPropagation()
event.preventDefault()}if(code===KEYS.ESC&&pointerLocked())pointerLockExit()
var ks=key_state_new[code]
if(ks&&ks.state===DOWN)if(is_mac_osx&&"Meta"===event.key)releaseAllKeysDown(event)
else ks.keyUp(event)
in_event.handle("keyup",event)}function onKeyDown(event){protectUnload(event.ctrlKey)
var code=event.keyCode
if(!(letEventThrough(event)||code>=KEYS.F5&&code<=KEYS.F12||code===KEYS.I&&(event.altKey&&event.metaKey||event.ctrlKey&&event.shiftKey)||code===KEYS.R&&event.ctrlKey)){event.stopPropagation()
event.preventDefault()}onUserInput()
var ks=key_state_new[code]
if(!ks)ks=key_state_new[code]=new KeyData
if(ks.state!==DOWN){++ks.down_edge
ks.state=DOWN
ks.origin_time=eventTimestamp(event)
in_event.handle("keydown",event)}}var mouse_move_x=0
function debugGetMouseMoveX(){var ret=mouse_move_x
mouse_move_x=0
return ret}var mouse_moved=false
var mouse_button_had_edge=false
var mouse_button_had_up_edge=false
var temp_delta=vec2()
var last_abs_move=0
var last_abs_move_time=0
var last_move_x=0
var last_move_y=0
function onMouseMove(event,no_stop){if(!letEventThrough(event)&&!no_stop&&3!==event.button){event.preventDefault()
event.stopPropagation()
if(touch_mode){local_storage.setJSON("touch_mode",false)
exports.touch_mode=touch_mode=false}if(pad_mode){local_storage.setJSON("pad_mode",false)
exports.pad_mode=pad_mode=false}}mouse_moved=true
mouse_pos[0]=event.pageX
mouse_pos[1]=event.pageY
mouse_pos_is_touch=false
var movement_x=event.movementX||event.mozMovementX||event.webkitMovementX||0
var movement_y=event.movementY||event.mozMovementY||event.webkitMovementY||0
mouse_move_x+=movement_x
var any_movement=false
if(pointerLocked()){setMouseToMid()
if(movement_x||movement_y){var ts=event.timeStamp||Date.now()
var abs_x=abs(movement_x)
var abs_y=abs(movement_y)
var abs_move=abs_x+abs_y
if(abs_move>200&&(abs_move>3*last_abs_move||ts-last_abs_move_time>1e3))console.log("Ignoring mousemove with sudden large delta: "+movement_x+","+movement_y)
else if(is_firefox&&movement_x===last_move_x&&movement_y===last_move_y&&abs_x<2&&abs_y<2);else{v2set(temp_delta,movement_x||0,movement_y||0)
any_movement=true}last_abs_move=abs_move
last_abs_move_time=ts
last_move_x=movement_x
last_move_y=movement_y}}else{v2sub(temp_delta,mouse_pos,last_mouse_pos)
if(temp_delta[0]||temp_delta[1])any_movement=true
v2copy(last_mouse_pos,mouse_pos)}if(any_movement&&movement_questionable_frames&&v2lengthSq(temp_delta)>1e4)any_movement=false
if(any_movement)for(var button=POINTERLOCK;button<mouse_down.length;++button)if(mouse_down[button]||button===POINTERLOCK&&pointerLocked()){var touch_data=touches["m"+button]
if(touch_data){v2add(touch_data.delta,touch_data.delta,temp_delta)
touch_data.total+=abs(temp_delta[0])+abs(temp_delta[1])
v2copy(touch_data.cur_pos,mouse_pos)}}}function onMouseDown(event){if(mouse_log)eventlog(event)
onMouseMove(event)
onUserInput()
var no_click=letEventThrough(event)
var button=event.button
mouse_down[button]=true
var touch_id="m"+button
if(touches[touch_id])v2copy(touches[touch_id].start_pos,mouse_pos)
else touches[touch_id]=new TouchData(mouse_pos,false,button,event)
touches[touch_id].down(event,!no_click)
if(!no_click)in_event.handle("mousedown",event)
mouse_button_had_edge=true
if(window.focus)window.focus()}var last_up_edges=[{timestamp:0,pos:vec2()},{timestamp:0,pos:vec2()}]
function registerMouseUpEdge(touch_data,timestamp){touch_data.up_edge++
var t=last_up_edges[0]
last_up_edges[0]=last_up_edges[1]
last_up_edges[1]=t
v2copy(t.pos,touch_data.cur_pos)
t.timestamp=timestamp}function onMouseUp(event){if(mouse_log)eventlog(event)
onMouseMove(event)
var no_click=letEventThrough(event)
var button=event.button
if(mouse_down[button]){var touch_data=touches["m"+button]
if(touch_data){v2copy(touch_data.cur_pos,mouse_pos)
if(!no_click)registerMouseUpEdge(touch_data,eventTimestamp(event))
touch_data.state=UP
touch_data.down_time+=timeDelta(event,touch_data.origin_time)}delete mouse_down[button]}mouse_button_had_up_edge=mouse_button_had_edge=true
if(!no_click)in_event.handle("mouseup",event)}function onWheel(event){var saved=mouse_moved
onMouseMove(event,true)
mouse_moved=saved
var delta=-event.deltaY||event.wheelDelta||-event.detail
wheel_events.push({pos:[event.pageX,event.pageY],delta:delta>0?1:-1,dispatched:false})
if(!letWheelEventThrough(event)){event.stopPropagation()
event.preventDefault()}}var touch_pos=vec2()
var released_touch_id=0
function onTouchChange(event){onUserInput()
if(!touch_mode){local_storage.set("touch_mode",true)
exports.touch_mode=touch_mode=true}if(pad_mode){local_storage.set("pad_mode",false)
exports.pad_mode=pad_mode=false}if(false!==event.cancelable)event.preventDefault()
var ct=event.touches
var seen={}
var new_count=ct.length
var old_count=0
for(var ii=0;ii<ct.length;++ii){var touch=ct[ii]
try{if(!isFinite(touch.pageX)||!isFinite(touch.pageY)){--new_count
continue}}catch(e){--new_count
continue}var last_touch=touches[touch.identifier]
v2set(touch_pos,touch.pageX,touch.pageY)
if(!last_touch){(last_touch=touches[touch.identifier]=new TouchData(touch_pos,true,0,event)).down(event,true)
mouse_button_had_edge=true
in_event.handle("mousedown",touch)}else{++old_count
v2sub(temp_delta,touch_pos,last_touch.cur_pos)
v2add(last_touch.delta,last_touch.delta,temp_delta)
last_touch.total+=abs(temp_delta[0])+abs(temp_delta[1])
v2copy(last_touch.cur_pos,touch_pos)}seen[touch.identifier]=true
if(TOUCH_AS_MOUSE&&1===new_count){v2copy(mouse_pos,touch_pos)
mouse_pos_is_touch=true}}var released_touch
var released_ids=[]
for(var id in touches)if(!seen[id]){var _touch=touches[id]
if(_touch.touch&&_touch.state===DOWN){++old_count
released_touch=_touch
released_ids.push(id)
in_event.handle("mouseup",{pageX:_touch.cur_pos[0],pageY:_touch.cur_pos[1]})
registerMouseUpEdge(_touch,eventTimestamp(event))
mouse_button_had_up_edge=mouse_button_had_edge=true
_touch.state=UP
_touch.down_time+=timeDelta(event,_touch.origin_time)
_touch.release=true}}for(var _ii=0;_ii<released_ids.length;++_ii){var _id=released_ids[_ii]
var _touch2=touches[_id]
var new_id="r"+ ++released_touch_id
delete touches[_id]
touches[new_id]=_touch2}if(TOUCH_AS_MOUSE)if(1===old_count&&0===new_count){delete mouse_down[0]
v2copy(mouse_pos,released_touch.cur_pos)
mouse_pos_is_touch=true}else if(1===new_count){var _touch3=ct[0]
if(!old_count)mouse_down[0]=true
v2set(mouse_pos,_touch3.pageX,_touch3.pageY)
mouse_pos_is_touch=true}else if(new_count>1)delete mouse_down[0]}function onBlurOrFocus(evt){protectUnload(false)
releaseAllKeysDown(evt)}var ANALOG_MAP={}
function genAnalogMap(){if(map_analog_to_dpad){ANALOG_MAP[PAD.LEFT]=[PAD.LSTICK_LEFT,PAD.RSTICK_LEFT]
ANALOG_MAP[PAD.RIGHT]=[PAD.LSTICK_RIGHT,PAD.RSTICK_RIGHT]
ANALOG_MAP[PAD.UP]=[PAD.LSTICK_UP,PAD.RSTICK_UP]
ANALOG_MAP[PAD.DOWN]=[PAD.LSTICK_DOWN,PAD.RSTICK_DOWN]}}var passive_param=false
function handleTouches(elem){elem.addEventListener("touchstart",onTouchChange,passive_param)
elem.addEventListener("touchmove",onTouchChange,passive_param)
elem.addEventListener("touchend",onTouchChange,passive_param)
elem.addEventListener("touchcancel",onTouchChange,passive_param)}function startup(_canvas,params){canvas=_canvas
pointer_lock.startup(canvas,onPointerLockEnter)
if(void 0!==params.map_analog_to_dpad)map_analog_to_dpad=params.map_analog_to_dpad
pad_to_touch=params.pad_to_touch
genAnalogMap()
try{var opts=Object.defineProperty({},"passive",{get:function get(){passive_param={passive:false}
return false}})
window.addEventListener("test",null,opts)
window.removeEventListener("test",null,opts)}catch(e){passive_param=false}window.addEventListener("keydown",onKeyDown,false)
window.addEventListener("keyup",onKeyUp,false)
window.addEventListener("click",ignored,false)
window.addEventListener("contextmenu",ignored,false)
window.addEventListener("mousemove",onMouseMove,false)
window.addEventListener("mousedown",onMouseDown,false)
window.addEventListener("mouseup",onMouseUp,false)
if(window.WheelEvent)window.addEventListener("wheel",onWheel,passive_param)
else{window.addEventListener("DOMMouseScroll",onWheel,false)
window.addEventListener("mousewheel",onWheel,false)}window.addEventListener("blur",onBlurOrFocus,false)
window.addEventListener("focus",onBlurOrFocus,false)
handleTouches(canvas)
window.addEventListener("beforeunload",beforeUnload,false)}var DEADZONE=.26
var DEADZONE_SQ=DEADZONE*DEADZONE
var NUM_STICKS=2
var PAD_THRESHOLD=.35
function getGamepadData(idx){var gpd=gamepad_data[idx]
if(!gpd){gpd=gamepad_data[idx]={id:idx,timestamp:0,sticks:new Array(NUM_STICKS)}
for(var ii=0;ii<NUM_STICKS;++ii)gpd.sticks[ii]=vec2()
pad_states[idx]={}}return gpd}function updatePadState(gpd,ps,b,padcode){if(b&&!ps[padcode]){ps[padcode]=DOWN_EDGE
onUserInput()
if(touch_mode){local_storage.set("touch_mode",false)
exports.touch_mode=touch_mode=false}if(!pad_mode){local_storage.setJSON("pad_mode",true)
exports.pad_mode=pad_mode=true}if(padcode===pad_to_touch){var touch_id="g"+gpd.id
if(touches[touch_id]){setMouseToMid()
v2copy(touches[touch_id].start_pos,mouse_pos)}else touches[touch_id]=new TouchData(mouse_pos,false,0,null)
touches[touch_id].down(null,true)}}else if(!b&&ps[padcode]){ps[padcode]=UP_EDGE
if(padcode===pad_to_touch){var _touch_id="g"+gpd.id
var touch_data=touches[_touch_id]
if(touch_data){setMouseToMid()
v2copy(touch_data.cur_pos,mouse_pos)
registerMouseUpEdge(touch_data,engine.hrtime)
touch_data.state=UP
touch_data.down_time+=max(engine.hrtime-touch_data.origin_time,MIN_EVENT_TIME_DELTA)}}}}function gamepadUpdate(){var gamepads
try{gamepads=navigator.gamepads||navigator.webkitGamepads||navigator.getGamepads&&navigator.getGamepads()||navigator.webkitGetGamepads&&navigator.webkitGetGamepads()}catch(e){}if(gamepads){var numGamePads=gamepads.length
for(var ii=0;ii<numGamePads;ii++){var gamepad=gamepads[ii]
if(!gamepad)continue
var gpd=getGamepadData(ii)
var ps=pad_states[ii]
if(gpd.timestamp<gamepad.timestamp){var buttons=gamepad.buttons
gpd.timestamp=gamepad.timestamp
var numButtons=buttons.length
for(var n=0;n<numButtons;n++){var value=buttons[n]
if("object"===typeof value)value=value.value
updatePadState(gpd,ps,value=value>.5,n)}}var axes=gamepad.axes
if(axes.length>=2*NUM_STICKS){for(var _n=0;_n<NUM_STICKS;++_n){var pair=gpd.sticks[_n]
v2set(pair,axes[2*_n],-axes[2*_n+1])
var magnitude=v2lengthSq(pair)
if(magnitude>DEADZONE_SQ){magnitude=sqrt(magnitude)
v2scale(pair,pair,1/magnitude)
magnitude=min(magnitude,1)
v2scale(pair,pair,magnitude=(magnitude-DEADZONE)/(1-DEADZONE))}else v2set(pair,0,0)
if(_n<=1&&void 0!==pad_to_touch){var touch_data=touches["g"+gpd.id]
if(touch_data){v2scale(temp_delta,pair,engine.frame_dt)
v2add(touch_data.delta,touch_data.delta,temp_delta)
touch_data.total+=abs(temp_delta[0])+abs(temp_delta[1])
setMouseToMid()
v2copy(touch_data.cur_pos,mouse_pos)}}}updatePadState(gpd,ps,gpd.sticks[0][0]<-PAD_THRESHOLD,PAD.LSTICK_LEFT)
updatePadState(gpd,ps,gpd.sticks[0][0]>PAD_THRESHOLD,PAD.LSTICK_RIGHT)
updatePadState(gpd,ps,gpd.sticks[0][1]<-PAD_THRESHOLD,PAD.LSTICK_DOWN)
updatePadState(gpd,ps,gpd.sticks[0][1]>PAD_THRESHOLD,PAD.LSTICK_UP)
updatePadState(gpd,ps,gpd.sticks[1][0]<-PAD_THRESHOLD,PAD.RSTICK_LEFT)
updatePadState(gpd,ps,gpd.sticks[1][0]>PAD_THRESHOLD,PAD.RSTICK_RIGHT)
updatePadState(gpd,ps,gpd.sticks[1][1]<-PAD_THRESHOLD,PAD.RSTICK_DOWN)
updatePadState(gpd,ps,gpd.sticks[1][1]>PAD_THRESHOLD,PAD.RSTICK_UP)}}}}function fakeTouchEvent(is_down){var touch_id="faketouch"
var touch_data=touches[touch_id]
if(touch_data&&!is_down){setMouseToMid()
v2copy(touch_data.cur_pos,mouse_pos)
registerMouseUpEdge(touch_data,engine.hrtime)
touch_data.state=UP
touch_data.down_time+=max(engine.hrtime-touch_data.origin_time,MIN_EVENT_TIME_DELTA)}else if(!touch_data&&is_down){setMouseToMid()
touches[touch_id]=new TouchData(mouse_pos,false,0,null)}}function tickInput(){if(movement_questionable_frames)--movement_questionable_frames
var hrtime=engine.hrtime
for(var code in key_state_new){var ks=key_state_new[code]
if(ks.state===DOWN){ks.down_time+=max(hrtime-ks.origin_time,MIN_EVENT_TIME_DELTA)
ks.origin_time=hrtime}}for(var touch_id in touches){var touch_data=touches[touch_id]
if(touch_data.state===DOWN){touch_data.down_time+=max(hrtime-touch_data.origin_time,MIN_EVENT_TIME_DELTA)
touch_data.origin_time=hrtime}}mouse_over_captured=false
gamepadUpdate()
in_event.topOfFrame()
ctrl_checked=false
if(touches[pointerlock_touch_id]&&!pointerLocked())pointerLockExit()
no_active_touches=empty(touches)}function endFrameTickMap(map){Object.keys(map).forEach(function(keycode){switch(map[keycode]){case DOWN_EDGE:map[keycode]=DOWN
break
case UP_EDGE:delete map[keycode]}})}function endFrame(skip_mouse){for(var code in key_state_new){var ks=key_state_new[code]
if(ks.state===UP){key_state_new[code]=null
delete key_state_new[code]}else{ks.up_edge=0
ks.down_edge=0
ks.down_time=0}}pad_states.forEach(endFrameTickMap)
if(!skip_mouse){for(var touch_id in touches){var touch_data=touches[touch_id]
if(touch_data.state===UP){touches[touch_id]=null
delete touches[touch_id]}else{touch_data.delta[0]=touch_data.delta[1]=0
touch_data.dispatched=false
touch_data.dispatched_drag=false
touch_data.dispatched_drag_over=false
if(touch_data.drag_payload_frame===engine.frame_index-2)touch_data.drag_payload=null
touch_data.up_edge=0
touch_data.down_edge=0
touch_data.down_time=0}}wheel_events.length=0
mouse_button_had_up_edge=mouse_button_had_edge=mouse_moved=input_eaten_mouse=false}input_eaten_kb=false}function tickInputInactive(){in_event.topOfFrame()
ctrl_checked=false
endFrame()}function eatAllInput(skip_mouse){endFrame(skip_mouse)
if(!skip_mouse)input_eaten_mouse=mouse_over_captured=true
input_eaten_kb=true}function eatAllKeyboardInput(){eatAllInput(true)}function mousePos(dst){dst=dst||vec2()
camera2d.domToVirtual(dst,mouse_pos)
return dst}function mouseDomPos(){return mouse_pos}function mouseMoved(){return mouse_moved}function mouseButtonHadEdge(){return mouse_button_had_edge}function mouseButtonHadUpEdge(){return mouse_button_had_up_edge}var full_screen_pos_param={}
function mousePosParamUnique(param){var pos_param=(param=param||full_screen_pos_param).mouse_pos_param
if(!pos_param)pos_param=param.mouse_pos_param={}
pos_param.x=void 0===param.x?camera2d.x0Real():param.x
pos_param.y=void 0===param.y?camera2d.y0Real():param.y
pos_param.w=void 0===param.w?camera2d.wReal():param.w
pos_param.h=void 0===param.h?camera2d.hReal():param.h
pos_param.button=void 0===param.button?ANY:param.button
return pos_param}var pos_param_temp={}
function mousePosParam(param){pos_param_temp.x=void 0===(param=param||{}).x?camera2d.x0Real():param.x
pos_param_temp.y=void 0===param.y?camera2d.y0Real():param.y
pos_param_temp.w=void 0===param.w?camera2d.wReal():param.w
pos_param_temp.h=void 0===param.h?camera2d.hReal():param.h
pos_param_temp.button=void 0===param.button?ANY:param.button
return pos_param_temp}var check_pos=vec2()
function checkPos(pos,param){if(!camera2d.domToVirtual(check_pos,pos))return false
return check_pos[0]>=param.x&&(Infinity===param.w||check_pos[0]<param.x+param.w)&&check_pos[1]>=param.y&&(Infinity===param.h||check_pos[1]<param.y+param.h)}function wasDoubleClick(pos_param){if(engine.hrtime-last_up_edges[0].timestamp>settings.double_click_time)return false
return checkPos(last_up_edges[0].pos,pos_param)}function mouseWheel(param){if(input_eaten_mouse||!wheel_events.length)return 0
var pos_param=mousePosParam(param=param||{})
var ret=0
for(var ii=0;ii<wheel_events.length;++ii){var data=wheel_events[ii]
if(data.dispatched)continue
if(checkPos(data.pos,pos_param)){ret+=data.delta
data.dispatched=true}}return ret}function mouseOverCaptured(){mouse_over_captured=true}function mouseOver(param){profilerStart("mouseOver")
var pos_param=mousePosParamUnique(param=param||{})
spotMouseoverHook(pos_param,param)
if(mouse_over_captured||pointerLocked()&&!param.allow_pointerlock){profilerStop("mouseOver")
return false}if(!param.peek&&!param.peek_touch)for(var id in touches){var touch=touches[id]
if(checkPos(touch.cur_pos,pos_param)){touch.down_edge=0
touch.up_edge=0
if(!param||!param.drag_target)touch.dispatched=true}}var ret=false
if(checkPos(mouse_pos,pos_param)){if(!param.peek&&!param.peek_over)mouse_over_captured=true
ret=true}profilerStop("mouseOver")
return ret}function mouseDownAnywhere(button){if(input_eaten_mouse)return false
if(void 0===button)button=ANY
for(var touch_id in touches){var touch_data=touches[touch_id]
if(touch_data.state!==DOWN||!(button===ANY||button===touch_data.button))continue
return true}return false}function mouseDownMidClick(param){if(input_eaten_mouse||no_active_touches)return false
var pos_param=mousePosParam(param=param||{})
var button=pos_param.button
var max_click_dist=param.max_dist||50
for(var touch_id in touches){var touch_data=touches[touch_id]
if(touch_data.state!==DOWN||!(button===ANY||button===touch_data.button)||touch_data.total>max_click_dist)continue
if(checkPos(touch_data.cur_pos,pos_param))return true}return false}function mouseDownOverBounds(param){if(input_eaten_mouse||no_active_touches)return false
var pos_param=mousePosParam(param=param||{})
var button=pos_param.button
for(var touch_id in touches){var touch_data=touches[touch_id]
if(touch_data.state!==DOWN||!(button===ANY||button===touch_data.button))continue
if(checkPos(touch_data.cur_pos,pos_param))return true}return false}function mousePosIsTouch(){return mouse_pos_is_touch}function numTouches(){return Object.keys(touches).length}function keyDown(keycode){if(keycode===KEYS.CTRL)ctrl_checked=true
if(input_eaten_kb)return 0
var ks=key_state_new[keycode]
if(!ks)return 0
if(ks.state===DOWN)assert(ks.down_time)
return ks.down_time}function keyDownEdge(keycode,opts){if(input_eaten_kb)return 0
if(opts&&opts.in_event_cb)in_event.on("keydown",keycode,opts.in_event_cb)
var ks=key_state_new[keycode]
if(!ks)return 0
var r=ks.down_edge
ks.down_edge=0
return r}function keyUpEdge(keycode,opts){if(input_eaten_kb)return 0
if(opts&&opts.in_event_cb)in_event.on("keyup",keycode,opts.in_event_cb)
var ks=key_state_new[keycode]
if(!ks)return 0
var r=ks.up_edge
ks.up_edge=0
return r}function padGetAxes(out,stickindex,padindex){assert(stickindex>=0&&stickindex<NUM_STICKS)
if(void 0===padindex){var sub=vec2()
v2set(out,0,0)
for(var ii=0;ii<gamepad_data.length;++ii){padGetAxes(sub,stickindex,ii)
v2add(out,out,sub)}return}var sticks=getGamepadData(padindex).sticks
v2copy(out,sticks[stickindex])}function padButtonDownInternal(gpd,ps,padcode){if(ps[padcode])return engine.frame_dt
return 0}function padButtonDownEdgeInternal(gpd,ps,padcode){if(ps[padcode]===DOWN_EDGE){ps[padcode]=DOWN
return 1}return 0}function padButtonUpEdgeInternal(gpd,ps,padcode){if(ps[padcode]===UP_EDGE){delete ps[padcode]
return 1}return 0}function padButtonShared(fn,padcode,padindex){assert(void 0!==padcode)
var r=0
if(void 0===padindex){for(var ii=0;ii<pad_states.length;++ii)r+=padButtonShared(fn,padcode,ii)
return r}if(input_eaten_mouse)return 0
var gpd=gamepad_data[padindex]
if(!gpd)return 0
var ps=pad_states[padindex]
var am=ANALOG_MAP[padcode]
if(am)for(var _ii2=0;_ii2<am.length;++_ii2)r+=fn(gpd,ps,am[_ii2])||0
return r+=fn(gpd,ps,padcode)}function padButtonDown(padcode,padindex){return padButtonShared(padButtonDownInternal,padcode,padindex)}function padButtonDownEdge(padcode,padindex){return padButtonShared(padButtonDownEdgeInternal,padcode,padindex)}function padButtonUpEdge(padcode,padindex){return padButtonShared(padButtonUpEdgeInternal,padcode,padindex)}var start_pos=vec2()
var cur_pos=vec2()
var delta=vec2()
function mouseUpEdge(param){param=param||{}
if(input_eaten_mouse||!param.in_event_cb&&no_active_touches)return null
var pos_param=mousePosParam(param)
var button=pos_param.button
var max_click_dist=param.max_dist||50
var dragged_too_far=false
for(var touch_id in touches){var touch_data=touches[touch_id]
if(touch_data.total>max_click_dist){dragged_too_far=true
continue}if(!touch_data.up_edge)continue
if(touch_data.long_press_dispatched)continue
if(!(button===ANY||button===touch_data.button))continue
if(checkPos(touch_data.cur_pos,pos_param)){if(!param.peek)touch_data.up_edge=0
return{button:touch_data.button,pos:check_pos.slice(0),start_time:touch_data.start_time,was_double_click:wasDoubleClick(pos_param)}}}if(param.in_event_cb&&!mouse_over_captured&&!dragged_too_far){if(!param.phys)param.phys={}
param.phys.button="number"===typeof param.in_event_button?param.in_event_button:button
camera2d.virtualToDomPosParam(param.phys,pos_param)
in_event.on("mouseup",param.phys,param.in_event_cb)}return null}function mouseDownEdge(param){param=param||{}
if(input_eaten_mouse||!param.in_event_cb&&no_active_touches)return null
var pos_param=mousePosParam(param)
var button=pos_param.button
for(var touch_id in touches){var touch_data=touches[touch_id]
if(!touch_data.down_edge||!(button===ANY||button===touch_data.button))continue
if(checkPos(touch_data.cur_pos,pos_param)){if(!param.peek)touch_data.down_edge=0
return{button:touch_data.button,pos:check_pos.slice(0),start_time:touch_data.start_time}}}if(param.in_event_cb&&!mouse_over_captured){if(!param.phys)param.phys={}
param.phys.button=button
camera2d.virtualToDomPosParam(param.phys,pos_param)
in_event.on("mousedown",param.phys,param.in_event_cb)}return null}function mouseConsumeClicks(param){if(no_active_touches)return
var pos_param=mousePosParam(param=param||{})
var button=pos_param.button
for(var touch_id in touches){var touch_data=touches[touch_id]
if(!(button===ANY||button===touch_data.button)||touch_data.dispatched_drag)continue
if(checkPos(touch_data.start_pos,pos_param)){touch_data.down_edge=0
touch_data.start_pos[0]=touch_data.start_pos[1]=Infinity
touch_data.total=Infinity}}}function drag(param){if(input_eaten_mouse||no_active_touches)return null
var pos_param=mousePosParam(param=param||{})
var button=pos_param.button
var min_dist=param.min_dist||0
for(var touch_id in touches){var touch_data=touches[touch_id]
if(!(button===ANY||button===touch_data.button)||touch_data.dispatched_drag)continue
if(checkPos(touch_data.start_pos,pos_param)){camera2d.domDeltaToVirtual(delta,[touch_data.total/2,touch_data.total/2])
var total=delta[0]+delta[1]
if(total<min_dist)continue
if(!param.peek)touch_data.dispatched_drag=true
var is_down_edge=touch_data.down_edge
if(param.eat_clicks)touch_data.down_edge=touch_data.up_edge=0
if(param.payload){touch_data.drag_payload=param.payload
touch_data.drag_payload_frame=engine.frame_index}camera2d.domToVirtual(start_pos,touch_data.start_pos)
camera2d.domToVirtual(cur_pos,touch_data.cur_pos)
camera2d.domDeltaToVirtual(delta,touch_data.delta)
return{cur_pos:cur_pos,start_pos:start_pos,delta:delta,total:total,button:touch_data.button,touch:touch_data.touch,start_time:touch_data.start_time,is_down_edge:is_down_edge,down_time:touch_data.down_time}}}return null}function longPress(param){if(input_eaten_mouse||no_active_touches)return null
var pos_param=mousePosParam(param=param||{})
var button=pos_param.button
var max_dist=param.long_press_max_dist||50
var min_time=param.min_time||500
for(var touch_id in touches){var touch_data=touches[touch_id]
if(!(button===ANY||button===touch_data.button)||touch_data.long_press_dispatched)continue
if(checkPos(touch_data.start_pos,pos_param)){camera2d.domDeltaToVirtual(delta,[touch_data.total/2,touch_data.total/2])
var total=delta[0]+delta[1]
if(total>max_dist)continue
if(Date.now()-touch_data.start_time<min_time)continue
if(!param.peek)touch_data.long_press_dispatched=true
var is_down_edge=touch_data.down_edge
if(param.eat_clicks)touch_data.down_edge=touch_data.up_edge=0
camera2d.domToVirtual(start_pos,touch_data.start_pos)
camera2d.domToVirtual(cur_pos,touch_data.cur_pos)
camera2d.domDeltaToVirtual(delta,touch_data.delta)
return{long_press:true,cur_pos:cur_pos,start_pos:start_pos,delta:delta,total:total,button:touch_data.button,touch:touch_data.touch,start_time:touch_data.start_time,is_down_edge:is_down_edge,down_time:touch_data.down_time}}}return null}function dragDrop(param){if(input_eaten_mouse||no_active_touches)return null
var pos_param=mousePosParam(param=param||{})
var button=pos_param.button
for(var touch_id in touches){var touch_data=touches[touch_id]
if(!(button===ANY||button===touch_data.button)||touch_data.dispatched||!touch_data.drag_payload)continue
if(!touch_data.up_edge)continue
if(checkPos(touch_data.cur_pos,pos_param)){if(!param.peek){touch_data.dispatched_drag_over=true
touch_data.dispatched_drag=true
touch_data.dispatched=true}return{drag_payload:touch_data.drag_payload}}}return null}function dragOver(param){if(input_eaten_mouse||no_active_touches)return null
var pos_param=mousePosParam(param=param||{})
var button=pos_param.button
for(var touch_id in touches){var touch_data=touches[touch_id]
if(!(button===ANY||button===touch_data.button)||touch_data.dispatched_drag_over||!touch_data.drag_payload)continue
if(touch_data.state!==DOWN)continue
if(checkPos(touch_data.cur_pos,pos_param)){if(!param.peek)touch_data.dispatched_drag_over=true
camera2d.domToVirtual(cur_pos,touch_data.cur_pos)
return{cur_pos:cur_pos,drag_payload:touch_data.drag_payload}}}return null}

},{"../common/util.js":74,"../common/vmath.js":76,"./browser.js":5,"./camera2d.js":7,"./cmds.js":9,"./engine.js":13,"./in_event.js":27,"./input_constants":29,"./local_storage.js":31,"./pointer_lock.js":39,"./settings.js":44,"./sound.js":49,"./spot.js":50,"assert":undefined}],29:[function(require,module,exports){
"use strict"
exports.POINTERLOCK=exports.BUTTON_RIGHT=exports.BUTTON_POINTERLOCK=exports.BUTTON_MIDDLE=exports.BUTTON_LEFT=exports.BUTTON_ANY=exports.ANY=void 0
var BUTTON_LEFT=0
exports.BUTTON_LEFT=BUTTON_LEFT
var BUTTON_MIDDLE=1
exports.BUTTON_MIDDLE=BUTTON_MIDDLE
var BUTTON_RIGHT=2
exports.BUTTON_RIGHT=BUTTON_RIGHT
var BUTTON_ANY=-2
exports.BUTTON_ANY=BUTTON_ANY
var BUTTON_POINTERLOCK=-1
exports.BUTTON_POINTERLOCK=BUTTON_POINTERLOCK
var ANY=BUTTON_ANY
exports.ANY=ANY
var POINTERLOCK=BUTTON_POINTERLOCK
exports.POINTERLOCK=POINTERLOCK

},{}],30:[function(require,module,exports){
"use strict"
exports.link=link
exports.linkGetDefaultStyle=linkGetDefaultStyle
exports.linkText=linkText
exports.linkTick=linkTick
var assert=require("assert")
var engine=require("./engine.js")
var _require=require("./font.js"),style=_require.style
var camera2d=require("./camera2d.js")
var in_event=require("./in_event.js")
var input=require("./input.js")
var abs=Math.abs
var _require2=require("./ui.js"),uiGetDOMElem=_require2.uiGetDOMElem
var ui=require("./ui.js")
var settings=require("./settings.js")
var _require3=require("./spot.js"),SPOT_DEFAULT_BUTTON=_require3.SPOT_DEFAULT_BUTTON,spot=_require3.spot,spotFocusSteal=_require3.spotFocusSteal,spotKey=_require3.spotKey
var style_link_default=style(null,{color:1346437119,outline_width:1,outline_color:32})
var style_link_hover_default=style(null,{color:65535,outline_width:1,outline_color:32})
function linkGetDefaultStyle(){return style_link_default}var state_cache={}
var good_url=/https?:\/\//
function preventFocus(evt){evt.preventDefault()
if(evt.relatedTarget)evt.relatedTarget.focus()
else evt.currentTarget.blur()}function link(param){var x=param.x,y=param.y,w=param.w,h=param.h,url=param.url,internal=param.internal,allow_modal=param.allow_modal
if(!url.match(good_url))url=document.location.protocol+"//"+url
var key=spotKey(param)
var state=state_cache[key]
if(!state)state=state_cache[key]={clicked:false}
state.frame=engine.frame_index
var rect={x:x,y:y,w:w,h:h}
if(camera2d.clipTestRect(rect)&&!(settings.shader_debug||settings.show_profiler)){var elem=uiGetDOMElem(state.elem,allow_modal)
if(elem!==state.elem)if(state.elem=elem){elem.textContent=""
var a_elem=document.createElement("a")
a_elem.setAttribute("draggable",false)
a_elem.textContent=" "
a_elem.className="glovui_link noglov"
a_elem.setAttribute("target","_blank")
a_elem.setAttribute("href",url)
a_elem.setAttribute("tabindex","-1")
a_elem.addEventListener("focus",preventFocus)
state.url=url
if(internal){var down_x
var down_y
input.handleTouches(a_elem)
a_elem.onmousedown=function(ev){down_x=ev.pageX
down_y=ev.pageY}
a_elem.onclick=function(ev){ev.preventDefault()
if(down_x)if(abs(ev.pageX-down_x)+abs(ev.pageY-down_y)>50)return
state.clicked=true
in_event.handle("mouseup",ev)}}elem.appendChild(a_elem)
state.a_elem=a_elem}if(elem){if(url!==state.url){state.a_elem.setAttribute("href",url)
state.url=url}var pos=camera2d.htmlPos(rect.x,rect.y)
elem.style.left=pos[0]+"%"
elem.style.top=pos[1]+"%"
var size=camera2d.htmlSize(rect.w,rect.h)
elem.style.width=size[0]+"%"
elem.style.height=size[1]+"%"}}var clicked=state.clicked
state.clicked=false
return clicked}function linkText(param){var style_link=param.style_link,style_link_hover=param.style_link_hover,x=param.x,y=param.y,z=param.z,font_size=param.font_size,text=param.text,url=param.url,internal=param.internal
text=text||url
z=z||Z.UI
font_size=font_size||ui.font_height
var w=ui.font.getStringWidth(style_link||style_link_default,font_size,text)
var h=font_size
param.w=w
param.h=h
param.def=SPOT_DEFAULT_BUTTON
var spot_ret=spot(param)
var style_use=spot_ret.focused?style_link_hover||style_link_hover_default:style_link||style_link_default
ui.font.drawSized(style_use,x,y,z,font_size,text)
var underline_w=1
ui.drawLine(x,y+h-underline_w,x+w,y+h-underline_w,z-.5,underline_w,1,style_use.color_vec4)
var clicked=link(param)
if(clicked)spotFocusSteal(param)
if(spot_ret.ret&&!internal){var key=spotKey(param)
var state=state_cache[key]
assert(state)
assert(state.a_elem)
state.a_elem.click()}return clicked||spot_ret.ret}function linkTick(){for(var key in state_cache)if(state_cache[key].frame!==engine.frame_index-1)delete state_cache[key]}

},{"./camera2d.js":7,"./engine.js":13,"./font.js":19,"./in_event.js":27,"./input.js":28,"./settings.js":44,"./spot.js":50,"./ui.js":57,"assert":undefined}],31:[function(require,module,exports){
"use strict"
exports.getStoragePrefix=getStoragePrefix
exports.localStorageClearAll=localStorageClearAll
exports.localStorageExportAll=localStorageExportAll
exports.localStorageGet=localStorageGet
exports.localStorageGetJSON=localStorageGetJSON
exports.localStorageImportAll=localStorageImportAll
exports.localStorageSet=localStorageSet
exports.localStorageSetJSON=localStorageSetJSON
exports.setStoragePrefix=setStoragePrefix
var assert=require("assert")
var storage_prefix="demo"
var is_set=false
function setStoragePrefix(prefix){if(is_set)return
is_set=true
storage_prefix=prefix}function getStoragePrefix(){assert(is_set)
return storage_prefix}var lsd=function(){try{localStorage.setItem("test","test")
localStorage.removeItem("test")
return localStorage}catch(e){return null}}()
var lsd_overlay={}
function localStorageGet(key){assert(is_set)
var ret=lsd_overlay[key=storage_prefix+"_"+key]||lsd&&lsd.getItem(key)
if("undefined"===ret)ret=void 0
else if(null===ret)ret=void 0
return ret}function localStorageSet(key,value){assert(is_set)
key=storage_prefix+"_"+key
if(void 0===value||null===value){if(lsd)lsd.removeItem(key)
delete lsd_overlay[key]}else{var str=String(value)
lsd_overlay[key]=str
try{if(lsd)lsd.setItem(key,str)}catch(e){}}}function localStorageSetJSON(key,value){localStorageSet(key,JSON.stringify(value))}function localStorageGetJSON(key,def){var value=localStorageGet(key)
if(void 0===value)return def
try{return JSON.parse(value)}catch(e){}return def}function localStorageClearAll(key_prefix){var prefix=new RegExp("^"+storage_prefix+"_"+(key_prefix||""),"u")
if(lsd){var keysToRemove=[]
for(var i=0;i<lsd.length;i++){var key=lsd.key(i)
assert(key)
if(key.match(prefix))keysToRemove.push(key)}for(var _i=0;_i<keysToRemove.length;_i++)lsd.removeItem(keysToRemove[_i])}for(var _key in lsd_overlay)if(_key.match(prefix))delete lsd_overlay[_key]}function localStorageExportAll(filter_prefix){var obj={}
var prefix=new RegExp("^"+storage_prefix+"_("+(filter_prefix||"")+".*)","u")
if(lsd)for(var i=0;i<lsd.length;i++){var key=lsd.key(i)
assert(key)
var m=key.match(prefix)
if(m){var v=lsd.getItem(key)
if(v&&"undefined"!==v)obj[m[1]]=v}}for(var _key2 in lsd_overlay){var _m=_key2.match(prefix)
if(_m)obj[_m[1]]=lsd_overlay[_key2]}return obj}function localStorageImportAll(serialized){localStorageClearAll()
for(var key in serialized)localStorageSet(key,serialized[key])}exports.get=localStorageGet
exports.set=localStorageSet
exports.setJSON=localStorageSetJSON
exports.getJSON=localStorageGetJSON
exports.clearAll=localStorageClearAll

},{"assert":undefined}],32:[function(require,module,exports){
"use strict"
exports.getStringFromLocalizable=getStringFromLocalizable
exports.getStringIfLocalizable=getStringIfLocalizable
function getStringFromLocalizable(s){return s&&s.toLocalString?s.toLocalString():s}function getStringIfLocalizable(s){return s&&s.toLocalString?s.toLocalString():s}

},{}],33:[function(require,module,exports){
"use strict"
exports.m43identity=m43identity
exports.m43mul=m43mul
exports.mat43=mat43
function mat43(){var r=new Float32Array(12)
r[0]=r[4]=r[8]=1
return r}function m43identity(out){out[0]=1
out[1]=0
out[2]=0
out[3]=0
out[4]=1
out[5]=0
out[6]=0
out[7]=0
out[8]=1
out[9]=0
out[10]=0
out[11]=0}function m43mul(out,a,b){var a0=a[0]
var a1=a[1]
var a2=a[2]
var a3=a[3]
var a4=a[4]
var a5=a[5]
var a6=a[6]
var a7=a[7]
var a8=a[8]
var a9=a[9]
var a10=a[10]
var a11=a[11]
var b0=b[0]
var b1=b[1]
var b2=b[2]
var b3=b[3]
var b4=b[4]
var b5=b[5]
var b6=b[6]
var b7=b[7]
var b8=b[8]
out[0]=b0*a0+b3*a1+b6*a2
out[1]=b1*a0+b4*a1+b7*a2
out[2]=b2*a0+b5*a1+b8*a2
out[3]=b0*a3+b3*a4+b6*a5
out[4]=b1*a3+b4*a4+b7*a5
out[5]=b2*a3+b5*a4+b8*a5
out[6]=b0*a6+b3*a7+b6*a8
out[7]=b1*a6+b4*a7+b7*a8
out[8]=b2*a6+b5*a7+b8*a8
out[9]=b0*a9+b3*a10+b6*a11+b[9]
out[10]=b1*a9+b4*a10+b7*a11+b[10]
out[11]=b2*a9+b5*a10+b8*a11+b[11]
return out}

},{}],34:[function(require,module,exports){
"use strict"
exports.default_vshader=exports.default_fshader=void 0
exports.load=load
exports.models=exports.load_count=void 0
exports.startup=startup
var assert=require("assert")
var geom=require("./geom.js")
var glb_parser=require("./glb/parser.js")
var _require=require("./glb/gltf-type-utils.js"),ATTRIBUTE_TYPE_TO_COMPONENTS=_require.ATTRIBUTE_TYPE_TO_COMPONENTS
var renderer=require("./engine.js")
var _require2=require("./fetch.js"),fetch=_require2.fetch
var shaders=require("./shaders.js")
var textures=require("./textures.js")
var _require3=require("../common/vmath.js"),vec4=_require3.vec4
var _require4=require("./webfs.js"),webFSGetFile=_require4.webFSGetFile
var load_count=0
exports.load_count=load_count
var models={}
exports.models=models
var default_vshader
exports.default_vshader=default_vshader
var default_fshader
exports.default_fshader=default_fshader
function initShaders(){exports.default_vshader=default_vshader=shaders.create("shaders/default.vp")
exports.default_fshader=default_fshader=shaders.create("shaders/default.fp")
shaders.prelink(default_vshader,default_fshader)}function Model(url){var idx=(this.url=url).lastIndexOf("/")
if(-1!==idx)this.base_url=url.slice(0,idx+1)
else this.base_url=""}Model.prototype.load=function(){var _this=this
exports.load_count=++load_count
fetch({url:this.url,response_type:"arraybuffer"},function(err,array_buffer){exports.load_count=--load_count
if(err)window.onerror("Model loading error","models.js",0,0,err)
else try{_this.parse(array_buffer)}catch(e){window.onerror("Model loading error","models.js",0,0,e)}})}
var skip_attr={TANGENT:true}
Model.prototype.parse=function(glb_data){var glb=glb_parser.parse(glb_data)
if(!glb)return
var glb_json=glb.getJSON()
var objs=[]
for(var ii=0;ii<glb_json.meshes.length;++ii){var mesh=glb_json.meshes[ii]
for(var jj=0;jj<mesh.primitives.length;++jj){var primitives=mesh.primitives[jj]
var material=glb_json.materials[primitives.material]
var texture=null
if(material){var bct=(material.pbrMetallicRoughness||{}).baseColorTexture||{}
var texture_def=glb_json.textures&&glb_json.textures[bct.index]||{}
var sampler_def=glb_json.samplers&&glb_json.samplers[texture_def.sampler]||{}
var image=glb_json.images&&glb_json.images[texture_def.source]||{}
if(image.uri){var params={url:""+this.base_url+image.uri,filter_mag:sampler_def.magFilter,filter_min:sampler_def.minFilter,wrap_s:sampler_def.wrapS,wrap_t:sampler_def.wrapT}
texture=textures.load(params)}}var format=[]
var buffers=[]
var bidx=[]
var total_size=0
var vert_count=0
for(var attr in primitives.attributes){if(skip_attr[attr])continue
assert(void 0!==shaders.semantic[attr])
var _accessor=glb_json.accessors[primitives.attributes[attr]]
assert.equal(_accessor.componentType,5126)
var geom_format=gl.FLOAT
var geom_count=ATTRIBUTE_TYPE_TO_COMPONENTS[_accessor.type]
assert(geom_count)
var my_vert_count=_accessor.count
if(!vert_count)vert_count=my_vert_count
else assert.equal(vert_count,my_vert_count)
format.push([shaders.semantic[attr],geom_format,geom_count])
var buffer=glb.getBuffer(_accessor)
buffers.push(buffer)
bidx.push(0)
total_size+=buffer.length}var verts=new Float32Array(total_size)
var idx=0
for(var vert=0;vert<vert_count;++vert)for(var _attr=0;_attr<format.length;++_attr)for(var kk=0;kk<format[_attr][2];++kk)verts[idx++]=buffers[_attr][bidx[_attr]++]
var accessor=glb_json.accessors[primitives.indices]
assert(accessor)
assert.equal(accessor.type,"SCALAR")
var idxs=glb.getBuffer(accessor)
if(5125===accessor.componentType){assert(vert_count<65535)
idxs=new Uint16Array(idxs)}else assert.equal(accessor.componentType,5123)
objs.push({geom:geom.create(format,verts,idxs,primitives.mode),texture:texture})}}this.data={objs:objs}}
Model.prototype.draw=function(mat){renderer.updateMatrices(mat)
shaders.bind(default_vshader,default_fshader,{color:vec4(1,1,1,1)})
var objs=this.data.objs
for(var ii=0;ii<objs.length;++ii){var obj=objs[ii]
if(obj.texture)textures.bind(0,obj.texture)
obj.geom.draw()}}
Model.prototype.drawGeom=function(){var objs=this.data.objs
for(var ii=0;ii<objs.length;++ii)objs[ii].geom.draw()}
function load(url){if(models[url])return models[url]
var model=models[url]=new Model(url)
model.data=models.box.data
model.load()
return model}function startup(){initShaders();(models.box=new Model("box")).parse(webFSGetFile("models/box_textured_embed.glb").buffer)}

},{"../common/vmath.js":76,"./engine.js":13,"./fetch.js":17,"./geom.js":21,"./glb/gltf-type-utils.js":23,"./glb/parser.js":24,"./shaders.js":46,"./textures.js":55,"./webfs.js":60,"assert":undefined}],35:[function(require,module,exports){
"use strict"
exports.buildString=buildString
exports.init=init
exports.netClient=netClient
exports.netClientId=netClientId
exports.netDisconnected=netDisconnected
exports.netDisconnectedRaw=netDisconnectedRaw
exports.netForceDisconnect=netForceDisconnect
exports.netSubs=netSubs
exports.netUserId=netUserId
exports.netBuildString=buildString
exports.netInit=init
var _require=require("./filewatch.js"),filewatchStartup=_require.filewatchStartup
var _require2=require("../common/packet.js"),packetEnableDebug=_require2.packetEnableDebug
var subscription_manager=require("./subscription_manager.js")
var wsclient=require("./wsclient.js")
var wscommon=require("../common/wscommon.js")
var WSClient=wsclient.WSClient
var client
var subs
function init(params){if((params=params||{}).ver)wsclient.CURRENT_VERSION=params.ver
if(String(document.location).match(/^https?:\/\/localhost/)){if(!params.no_packet_debug){console.log("PacketDebug: ON")
packetEnableDebug(true)}if(!params.no_net_delay)wscommon.netDelaySet()}client=new WSClient(params.path);(subs=subscription_manager.create(client,params.cmd_parse)).auto_create_user=Boolean(params.auto_create_user)
subs.no_auto_login=Boolean(params.no_auto_login)
subs.allow_anon=Boolean(params.allow_anon)
window.subs=subs
exports.subs=subs
exports.client=client
filewatchStartup(client)
if(params.engine)params.engine.addTickFunc(function(dt){client.checkDisconnect()
subs.tick(dt)})}var build_timestamp_string=new Date(Number("1673321608019")).toISOString().replace("T"," ").slice(5,-8)
function buildString(){return wsclient.CURRENT_VERSION?wsclient.CURRENT_VERSION+" ("+build_timestamp_string+")":build_timestamp_string}function netDisconnectedRaw(){return!client||!client.connected||client.disconnected||!client.socket||1!==client.socket.readyState}function netDisconnected(){return netDisconnectedRaw()||subs.logging_in}function netForceDisconnect(){var _client$socket
if(subs)subs.was_logged_in=false
null==client||(null==(_client$socket=client.socket)||(null==_client$socket.close||_client$socket.close()))}function netClient(){return client}function netClientId(){return client.id}function netUserId(){return subs.getUserId()}function netSubs(){return subs}

},{"../common/packet.js":71,"../common/wscommon.js":77,"./filewatch.js":18,"./subscription_manager.js":52,"./wsclient.js":61}],36:[function(require,module,exports){
"use strict"
exports.create=create
exports.preloadParticleData=preloadParticleData
var assert=require("assert")
var _require=require("../common/vmath.js"),vec2=_require.vec2,v2copy=_require.v2copy,v2lerp=_require.v2lerp,v2mul=_require.v2mul,vec3=_require.vec3,vec4=_require.vec4,v3add=_require.v3add,v4copy=_require.v4copy,v4lerp=_require.v4lerp,v4mul=_require.v4mul
var sprites=require("./sprites.js")
var textures=require("./textures.js")
var blend_map={alpha:sprites.BLEND_ALPHA,additive:sprites.BLEND_ADDITIVE}
function preloadParticleData(particle_data){for(var key in particle_data.defs){var def=particle_data.defs[key]
for(var part_name in def.particles){var part_def=def.particles[part_name]
textures.load({url:"img/"+part_def.texture+".png"})}}}function normalizeValue(v){if(v instanceof Float32Array&&v.length>=2)return v
else if("number"===typeof v)return vec2(v,0)
else if(Array.isArray(v)||v instanceof Float32Array)return vec2(v[0]||0,v[1]||0)
else return assert(false)}function normalizeValueVec(vec,length){assert(length)
assert(Array.isArray(vec)||vec instanceof Float32Array)
var ret=new Array(length)
for(var ii=0;ii<length;++ii)ret[ii]=normalizeValue(vec[ii])
return ret}function normalizeParticle(def,particle_manager){if(!def.normalized){var norm=def.normalized={blend:blend_map[def.blend]||sprites.BLEND_ALPHA,texture:textures.load({url:def.texture?"img/"+def.texture+".png":"img/glov/util_circle.png"}),color:normalizeValueVec(def.color||[1,1,1,1],4),color_track:null,size:normalizeValueVec(def.size||[1,1],2),size_track:null,accel:normalizeValueVec(def.accel||[0,0,0],3),rot:normalizeValue(def.rot||0),rot_vel:normalizeValue(def.rot||0),lifespan:normalizeValue(def.lifespan||1e3),kill_time_accel:normalizeValue(def.kill_time_accel||1)}
assert(norm.kill_time_accel[0]>=1)
if(def.color_track&&def.color_track.length){assert(def.color_track.length>1)
norm.color_track=[]
for(var ii=0;ii<def.color_track.length;++ii){var e=def.color_track[ii]
assert("number"===typeof e.t)
var arr=new Float32Array(5)
arr[0]=e.v[0]
arr[1]=e.v[1]
arr[2]=e.v[2]
arr[3]=e.v[3]
arr[4]=e.t
norm.color_track.push(arr)}}if(def.size_track&&def.size_track.length){assert(def.size_track.length>1)
norm.size_track=[]
for(var _ii=0;_ii<def.size_track.length;++_ii){var _e=def.size_track[_ii]
assert("number"===typeof _e.t)
var _arr=new Float32Array(3)
_arr[0]=_e.v[0]
_arr[1]=_e.v[1]
_arr[2]=_e.t
norm.size_track.push(_arr)}}}return def.normalized}function findParticle(particles,name){assert(void 0!==particles[name])
return particles[name]}function normalizeEmitter(def,part_map){if(!def.normalized){def.normalized={part_idx:findParticle(part_map,def.particle),pos:normalizeValueVec(def.pos||[0,0,0],3),vel:normalizeValueVec(def.vel||[0,0,0],3),emit_rate:normalizeValue(def.emit_rate||10),emit_time:normalizeValueVec(def.emit_time||[0,Infinity],2),emit_initial:normalizeValue(def.emit_initial||1)}
var min=def.normalized.emit_rate[0]
var max=def.normalized.emit_rate[0]+def.normalized.emit_rate[1]
def.normalized.emit_rate[0]=1e3/max
def.normalized.emit_rate[1]=1e3/min
assert(def.normalized.emit_rate[0]>1)}return def.normalized}function normalizeDef(def,particle_manager){if(!def.normalized){var norm=def.normalized={system_lifespan:normalizeValue(def.system_lifespan||Infinity),particles:[],emitters:[]}
var part_map={}
for(var key in def.particles){part_map[key]=norm.particles.length
norm.particles.push(normalizeParticle(def.particles[key],particle_manager))}for(var _key in def.emitters)norm.emitters.push(normalizeEmitter(def.emitters[_key],part_map))}return def.normalized}function instValue(v){return v[0]+Math.random()*v[1]}function instValueVec(v){var ret=new Float32Array(v.length)
for(var ii=0;ii<v.length;++ii)ret[ii]=instValue(v[ii])
return ret}var temp_color=vec4()
var temp_color2=vec4()
var temp_size=vec2()
var temp_size2=vec2()
var ParticleSystem=function(){function ParticleSystem(parent,def_in,pos){assert(3===pos.length)
this.parent=parent
this.def=normalizeDef(def_in,parent)
this.system_lifespan=instValue(this.def.system_lifespan)
assert(this.system_lifespan>0)
this.age=0
this.kill_hard=false
this.kill_soft=false
this.pos=vec3(pos[0],pos[1],pos[2])
this.part_sets=[]
for(var ii=0;ii<this.def.particles.length;++ii){var part_set={def:this.def.particles[ii],parts:[]}
this.part_sets.push(part_set)}this.emitters=[]
for(var _ii2=0;_ii2<this.def.emitters.length;++_ii2){var _def=this.def.emitters[_ii2]
var emitter={def:_def,emit_time:instValueVec(_def.emit_time),countdown:0,started:false,stopped:false}
this.emitters.push(emitter)}}var _proto=ParticleSystem.prototype
_proto.tickParticle=function tickParticle(part,dt){var def=part.def
part.age+=dt
var age_norm=part.age/part.lifespan
if(age_norm>=1)return true
var dts=dt/1e3
part.pos[0]+=part.vel[0]*dts
part.pos[1]+=part.vel[1]*dts
part.pos[2]+=part.vel[2]*dts
part.vel[0]+=part.accel[0]*dts
part.vel[1]+=part.accel[1]*dts
part.vel[2]+=part.accel[2]*dts
v4copy(temp_color,part.color,temp_color)
if(def.color_track)if(age_norm<def.color_track[0][4])v4mul(temp_color,temp_color,def.color_track[0])
else if(age_norm>=def.color_track[def.color_track.length-1][4])v4mul(temp_color,temp_color,def.color_track[def.color_track.length-1])
else for(var ii=0;ii<def.color_track.length-1;++ii)if(age_norm>=def.color_track[ii][4]&&age_norm<def.color_track[ii+1][4]){var weight=(age_norm-def.color_track[ii][4])/(def.color_track[ii+1][4]-def.color_track[ii][4])
v4lerp(temp_color2,weight,def.color_track[ii],def.color_track[ii+1])
v4mul(temp_color,temp_color,temp_color2)
break}v2copy(temp_size,part.size)
if(def.size_track)if(age_norm<def.size_track[0][2])v2mul(temp_size,temp_size,def.size_track[0])
else if(age_norm>=def.size_track[def.size_track.length-1][2])v2mul(temp_size,temp_size,def.size_track[def.size_track.length-1])
else for(var _ii3=0;_ii3<def.size_track.length-1;++_ii3)if(age_norm>=def.size_track[_ii3][2]&&age_norm<def.size_track[_ii3+1][2]){var _weight=(age_norm-def.size_track[_ii3][2])/(def.size_track[_ii3+1][2]-def.size_track[_ii3][2])
v2lerp(temp_size2,_weight,def.size_track[_ii3],def.size_track[_ii3+1])
v2mul(temp_size,temp_size,temp_size2)
break}var w=temp_size[0]
var h=temp_size[1]
var x=part.pos[0]-w/2
var y=part.pos[1]-h/2
var z=part.pos[2]
sprites.queueraw4color([def.texture],x,y,temp_color,0,0,x,y+h,temp_color,0,1,x+w,y+h,temp_color,1,1,x+w,y,temp_color,1,0,z,null,null,def.blend)
return false}
_proto.tickPartSet=function tickPartSet(dt_orig,part_set){var parts=part_set.parts
for(var ii=parts.length-1;ii>=0;--ii){var part=parts[ii]
var dt=this.kill_soft?dt_orig*part.kill_time_accel:dt_orig
if(this.tickParticle(part,dt)){parts[ii]=parts[parts.length-1]
parts.pop()}}}
_proto.emitParticle=function emitParticle(init_dt,emitter){var emitter_def=emitter.def
var part_set=this.part_sets[emitter_def.part_idx]
var def=part_set.def
var pos=instValueVec(emitter_def.pos,3)
v3add(pos,pos,this.pos)
var part={def:def,pos:pos,color:instValueVec(def.color,4),size:instValueVec(def.size,4),vel:instValueVec(emitter_def.vel,3),accel:instValueVec(def.accel,3),rot:instValue(def.rot),rot_vel:instValue(def.rot_vel),lifespan:instValue(def.lifespan),kill_time_accel:instValue(def.kill_time_accel),age:0}
if(!this.tickParticle(part,init_dt))part_set.parts.push(part)}
_proto.tickEmitter=function tickEmitter(dt,emitter){var def=emitter.def
if(!emitter.started&&this.age>=emitter.emit_time[0]){emitter.started=true
dt=this.age-emitter.emit_time[0]
var num=instValue(def.emit_initial)
for(var ii=0;ii<num;++ii)this.emitParticle(dt,emitter)
emitter.countdown=instValue(def.emit_rate)}if(emitter.started&&!emitter.stopped&&!this.kill_soft){var remaining_dt=dt
var emit_dt=dt
if(this.age>=emitter.emit_time[1]){emitter.stopped=true
emit_dt-=this.age-emitter.emit_time[1]}while(emit_dt>=emitter.countdown){emit_dt-=emitter.countdown
remaining_dt-=emitter.countdown
emitter.countdown=instValue(def.emit_rate)
this.emitParticle(remaining_dt,emitter)}emitter.countdown-=emit_dt}}
_proto.tick=function tick(dt){if(this.kill_hard)return true
for(var ii=this.part_sets.length-1;ii>=0;--ii)this.tickPartSet(dt,this.part_sets[ii])
this.age+=dt
for(var _ii4=0;_ii4<this.emitters.length;++_ii4)this.tickEmitter(dt,this.emitters[_ii4])
return this.age>=this.system_lifespan}
_proto.shift=function shift(delta){if(this.def.no_shift)return
this.pos[0]+=delta[0]
this.pos[1]+=delta[1]
this.pos[2]+=delta[2]
for(var ii=0;ii<this.part_sets.length;++ii){var parts=this.part_sets[ii].parts
for(var jj=0;jj<parts.length;++jj){var part=parts[jj]
part.pos[0]+=delta[0]
part.pos[1]+=delta[1]
part.pos[2]+=delta[2]}}}
return ParticleSystem}()
var ParticleManager=function(){function ParticleManager(){this.systems=[]}var _proto2=ParticleManager.prototype
_proto2.createSystem=function createSystem(def,pos){var system=new ParticleSystem(this,def,pos)
this.systems.push(system)
return system}
_proto2.tick=function tick(dt){for(var ii=this.systems.length-1;ii>=0;--ii)if(this.systems[ii].tick(dt)){this.systems[ii]=this.systems[this.systems.length-1]
this.systems.pop()}}
_proto2.killAll=function killAll(){this.systems=[]}
_proto2.shift=function shift(delta){for(var ii=0;ii<this.systems.length;++ii)this.systems[ii].shift(delta)}
return ParticleManager}()
function create(){return new ParticleManager}

},{"../common/vmath.js":76,"./sprites.js":51,"./textures.js":55,"assert":undefined}],37:[function(require,module,exports){
"use strict"
exports.addMetric=addMetric
exports.draw=draw
exports.friendlyBytes=friendlyBytes
exports.perfGraphOverride=perfGraphOverride
exports.perfSetAutoChannel=perfSetAutoChannel
exports.perf_mem_counters=void 0
var perf_mem_counters={}
exports.perf_mem_counters=perf_mem_counters
var engine=require("./engine.js")
var metrics=[]
function addMetric(metric,first){if(metric.show_graph){metric.num_lines=metric.colors.length
metric.history_size=metric.data.history.length/metric.num_lines}metric.num_labels=Object.keys(metric.labels).length
if(void 0===metric.interactable)metric.interactable=engine.DEBUG&&(metric.num_labels>1&&!metric.show_all||metric.show_graph)
if(first)metrics.splice(0,0,metric)
else metrics.push(metric)}var camera2d=require("./camera2d.js")
var _require=require("./cmds.js"),cmd_parse=_require.cmd_parse
var glov_font=require("./font.js")
var input=require("./input.js")
var max=Math.max
var _require2=require("./net.js"),netClient=_require2.netClient,netClientId=_require2.netClientId,netDisconnected=_require2.netDisconnected
var _require3=require("../common/perfcounters.js"),perfCounterHistory=_require3.perfCounterHistory
var _require4=require("./profiler_ui.js"),profilerUI=_require4.profilerUI
var settings=require("./settings.js")
var _require5=require("./sprites.js"),spriteChainedStart=_require5.spriteChainedStart,spriteChainedStop=_require5.spriteChainedStop
var ui=require("./ui.js")
var _require6=require("../common/vmath.js"),vec4=_require6.vec4,v3copy=_require6.v3copy
require("./perf_net.js")
var METRIC_PAD=2
var bg_default=vec4(0,0,0,.5)
var bg_mouse_over=vec4(0,0,0,.75)
var bg_fade=vec4()
settings.register({show_metrics:{default_value:1,type:cmd_parse.TYPE_INT,range:[0,1]},show_fps:{label:"Show FPS",default_value:engine.DEBUG?1:0,type:cmd_parse.TYPE_INT,range:[0,4]},fps_graph:{label:"FPS Graph",default_value:0,type:cmd_parse.TYPE_INT,range:[0,1]},fps_window:{label:"FPS Time Window (seconds)",default_value:1,type:cmd_parse.TYPE_FLOAT,range:[.001,120]},show_perf_counters:{default_value:0,type:cmd_parse.TYPE_INT,range:[0,1]},show_perf_memory:{default_value:0,type:cmd_parse.TYPE_INT,range:[0,1],access_run:["sysadmin"]},perf_provider:{default_value:"client",type:cmd_parse.TYPE_STRING,usage:"Set the perf provider for /show_perf_counters and /show_perf_memory\n  CLIENT : show client values\n  AUTO : automatically determine appropriate server\n  user.1234 : use server hosting a particular worker",access_run:["sysadmin"]}})
cmd_parse.register({cmd:"fps",help:"Toggles FPS display",func:function func(str,resp_func){if(settings.show_fps&&settings.show_metrics||"0"===str)settings.set("show_fps",0)
else{settings.set("show_fps",1)
settings.set("show_metrics",1)}resp_func()}})
var fps_style=glov_font.style({outline_width:2,outline_color:128,color:4294967295})
function friendlyUnit(table,value){var unit=0
while(unit<table.length-1&&value>=table[unit+1][0])unit++
if(0===unit)return value+" "+table[unit][1]
return(value/table[unit][0]).toFixed(2)+" "+table[unit][1]}var UNIT_BYTES=[[1,"bytes"],[1024,"KB"],[1048576,"MB"],[1073741824,"GB"]]
var UNIT_COUNT=[[1,""],[1e3,"k"],[1e6,"m"],[1e9,"g"]]
function friendlyBytes(bytes){return friendlyUnit(UNIT_BYTES,bytes)}function friendlyCount(count){return friendlyUnit(UNIT_COUNT,count)}function showMetric(y,metric){var font=engine.font
var pad=METRIC_PAD
var line_height=settings.render_scale_all<1?ui.font_height/settings.render_scale_all:ui.font_height
var METRIC_VALUE_WIDTH=line_height*(metric.width||2.5)
var x=camera2d.x1Real()-METRIC_VALUE_WIDTH-pad
var y0=y
y+=pad
var max_label_w=0
var max_labels=metric.show_all?Infinity:settings[metric.show_stat]
var drew_any=false
var alpha=1
for(var label in metric.labels){var value=metric.labels[label]()
if(value){var style=fps_style
if(value.alpha){alpha=value.alpha
value=value.value
style=glov_font.styleAlpha(fps_style,alpha)}var label_w=font.drawSizedAligned(style,x,y,Z.FPSMETER+3,line_height,glov_font.ALIGN.HRIGHT,0,0,label)
max_label_w=max(max_label_w,label_w)
font.drawSizedAligned(style,x,y,Z.FPSMETER+3,line_height,glov_font.ALIGN.HFIT,METRIC_VALUE_WIDTH,0,value)
y+=line_height
drew_any=true}if(!--max_labels)break}if(!drew_any)return y-pad
var bg=bg_default
var pos_param={x:(x-=max_label_w+METRIC_PAD)-pad,y:y0,w:METRIC_VALUE_WIDTH+max_label_w+METRIC_PAD+2*pad,h:(y+=pad)-y0}
if(metric.interactable){if(input.mouseUpEdge(pos_param))if(metric.num_labels>1&&settings[metric.show_stat]<=1)settings.set(metric.show_stat,metric.num_labels)
else if(metric.show_graph&&!settings[metric.show_graph])settings.set(metric.show_graph,1)
else{if(metric.show_graph)settings.set(metric.show_graph,0)
settings.set(metric.show_stat,1)}if(input.mouseOver(pos_param))bg=bg_mouse_over}if(1!==alpha){bg_fade[3]=bg[3]*alpha
bg=v3copy(bg_fade,bg)}ui.drawRect(pos_param.x,pos_param.y,pos_param.x+pos_param.w,y,Z.FPSMETER+2,bg)
return y}function showMetricGraph(y,metric){var small=engine.game_height<300
var LINE_WIDTH=small?1:3
var LINE_PAD=small?0:1
var LINE_HEIGHT=small?64:128
var NUM_LINES=metric.history_size-1
var w=(LINE_WIDTH+LINE_PAD)*NUM_LINES
var x=camera2d.x1Real()-w
var h=LINE_HEIGHT+2*LINE_PAD
var z=Z.FPSMETER
spriteChainedStart()
ui.drawRect(x,y-h,x+w,y,z++,bg_default)
x+=LINE_PAD
y-=LINE_PAD
var history_index=metric.data.index
var line_scale=LINE_HEIGHT/metric.line_scale_top
for(var ii=0;ii<NUM_LINES;ii++){var line_index=(ii+history_index+1)%metric.history_size*metric.num_lines
var data=metric.data.history
var bar_max=0
for(var jj=0;jj<metric.num_lines;jj++){var line_jj=data[line_index+jj]
var bar_min=void 0
if(metric.bars_stack){bar_min=bar_max
bar_max+=line_jj}else{var lesser=0
for(var kk=0;kk<metric.num_lines;kk++){if(kk===jj)continue
var line_kk=data[line_index+kk]
if((line_kk<line_jj||line_kk===line_jj&&kk<jj)&&line_kk>lesser)lesser=line_kk}bar_min=lesser
bar_max=line_jj}var color=metric.colors[jj]
ui.drawRect(x,y-bar_max*line_scale,x+LINE_WIDTH,y-bar_min*line_scale,z,color)}x+=LINE_WIDTH+LINE_PAD}z+=NUM_LINES
y-=LINE_HEIGHT+LINE_PAD
spriteChainedStop()
return y}function perfDefaultAutoChannel(){var client_id=netClientId()
if(client_id)return"client."+client_id
return null}var auto_channel_cb=perfDefaultAutoChannel
function perfSetAutoChannel(cb){auto_channel_cb=cb}var PERF_NET_CACHE_TIME=1e4
var PERF_NET_CACHE_TIME_MEM=2500
var perf_provider_data={last_update:-Infinity,data:null}
function updatePerfProvider(){var cache_time=PERF_NET_CACHE_TIME
var fields={}
if(settings.show_perf_counters)fields.counters=1
if(settings.show_perf_memory){fields.memory=1
cache_time=PERF_NET_CACHE_TIME_MEM}var provider=settings.perf_provider.toLowerCase()
if("client"===provider){var ret={source:"client"}
if(fields.counters)ret.counters=perfCounterHistory()
if(fields.memory)ret.memory=perf_mem_counters
return ret}if(perf_provider_data.in_flight||netDisconnected())return perf_provider_data.data
if(engine.frame_timestamp-perf_provider_data.last_update<cache_time)return perf_provider_data.data
var channel_id
if("auto"===provider)channel_id=auto_channel_cb()
else if(provider.match(/^[^.]+\.[^.]+$/))channel_id=provider
if(channel_id){perf_provider_data.in_flight=true
netClient().send("perf_fetch",{channel_id:channel_id,fields:fields},function(err,data){if(err)console.error("Error getting perf data: "+Object.keys(fields)+": "+err)
perf_provider_data.data=data
perf_provider_data.last_update=engine.frame_timestamp
perf_provider_data.in_flight=false})}return perf_provider_data.data}function perfMemObjToLines(out,obj,prefix){for(var key in obj){var v=obj[key]
if(v&&"object"===typeof v)perfMemObjToLines(out,v,""+prefix+key+".")
else{if("number"===typeof v)if(key.endsWith("bytes")||prefix.includes("data_size"))v=friendlyBytes(v)
else v=friendlyCount(v)
out.push(""+prefix+key+": "+v)}}}var graph_override=null
function perfGraphOverride(override){graph_override=override}function draw(){camera2d.push()
profilerUI()
camera2d.setAspectFixed(engine.game_width,engine.game_height)
if(settings.show_metrics){var y=camera2d.y0Real()
var y_graph=camera2d.y1Real()
if(graph_override){y_graph=showMetricGraph(y_graph,graph_override)
y_graph-=METRIC_PAD}for(var ii=0;ii<metrics.length;++ii){var metric=metrics[ii]
if(settings[metric.show_stat]){y=showMetric(y,metric)
y+=METRIC_PAD}if(!graph_override&&settings[metric.show_graph]){y_graph=showMetricGraph(y_graph,metric)
y_graph-=METRIC_PAD}}}if(settings.show_perf_counters||settings.show_perf_memory){var font=engine.font
var perf_data=updatePerfProvider()||{}
var _y=camera2d.y0Real()
var y0=_y
var line_height=settings.render_scale_all<1?ui.font_height/settings.render_scale_all:ui.font_height
var column_width=6*line_height
var x0=camera2d.x0Real()
var x=x0+2*column_width
var maxx=x+column_width
var z=Z.FPSMETER+1
var header_x=x0+column_width
if(perf_data.source){font.drawSized(fps_style,header_x,_y,z,line_height,"Source: "+perf_data.source)
_y+=line_height}if(perf_data.log){var w=.67*camera2d.wReal()
maxx=max(maxx,header_x+w)
_y+=font.drawSizedWrapped(fps_style,header_x,_y,z,w,20,line_height,perf_data.log)+4}if(perf_data.memory&&settings.show_perf_memory){var lines=[]
perfMemObjToLines(lines,perf_data.memory,"")
for(var _ii=0;_ii<lines.length;++_ii){font.drawSized(fps_style,x,_y,z,line_height,lines[_ii])
_y+=line_height}}if(perf_data.counters&&settings.show_perf_counters){var hist=perf_data.counters||[]
var by_key={}
for(var _ii2=0;_ii2<hist.length;++_ii2){var set=hist[_ii2]
for(var key in set){by_key[key]=by_key[key]||[]
by_key[key][_ii2]=set[key]}}var keys=Object.keys(by_key)
keys.sort()
for(var _ii3=0;_ii3<keys.length;++_ii3){var _key=keys[_ii3]
var data=by_key[_key]
font.drawSizedAligned(fps_style,x-2*column_width,_y,z,line_height,glov_font.ALIGN.HRIGHT|glov_font.ALIGN.HFIT,2*column_width,0,_key+": ")
for(var jj=0;jj<data.length;++jj)if(data[jj])font.drawSizedAligned(fps_style,x+column_width*jj,_y,z,line_height,glov_font.ALIGN.HFIT,column_width,0,data[jj]+" ")
maxx=max(maxx,x+column_width*data.length)
_y+=line_height}}ui.drawRect(x0,y0,maxx,_y,z-.1,bg_default)}camera2d.pop()
graph_override=null}

},{"../common/perfcounters.js":72,"../common/vmath.js":76,"./camera2d.js":7,"./cmds.js":9,"./engine.js":13,"./font.js":19,"./input.js":28,"./net.js":35,"./perf_net.js":38,"./profiler_ui.js":42,"./settings.js":44,"./sprites.js":51,"./ui.js":57}],38:[function(require,module,exports){
"use strict"
exports.registerPingProvider=registerPingProvider
var _glovCommonWscommon=require("../common/wscommon")
var wsstats=_glovCommonWscommon.wsstats
var wsstats_out=_glovCommonWscommon.wsstats_out
var _cmds=require("./cmds")
var cmd_parse=_cmds.cmd_parse
var _perf=require("./perf")
var perf=_perf
var _settings=require("./settings")
var settings=_settings
var min=Math.min
settings.register({show_net:{default_value:0,type:cmd_parse.TYPE_INT,range:[0,2]}})
var last_wsstats={msgs:0,bytes:0,time:Date.now(),dm:0,db:0}
var last_wsstats_out={msgs:0,bytes:0,time:Date.now(),dm:0,db:0}
function bandwidth(stats,last){var now=Date.now()
if(now-last.time>1e3){last.dm=stats.msgs-last.msgs
last.db=stats.bytes-last.bytes
last.msgs=stats.msgs
last.bytes=stats.bytes
if(now-last.time>2e3)last.time=now
else last.time+=1e3}return(last.db/1024).toFixed(2)+" kb ("+last.dm+")"}perf.addMetric({name:"net",show_stat:"show_net",width:5,labels:{"down: ":bandwidth.bind(null,wsstats,last_wsstats),"up: ":bandwidth.bind(null,wsstats_out,last_wsstats_out)}})
var ping_providers=0
function registerPingProvider(fn){var _settings$register
var suffix=1===++ping_providers?"":""+ping_providers
settings.register(((_settings$register={})["show_ping"+suffix]={default_value:0,type:cmd_parse.TYPE_INT,range:[0,1]},_settings$register))
perf.addMetric({name:"ping"+suffix,show_stat:"show_ping"+suffix,labels:{"ping: ":function ping(){var pt=fn()
if(!pt||pt.fade<.001)return""
return{value:""+pt.ping.toFixed(1),alpha:min(1,3*pt.fade)}}}})}

},{"../common/wscommon":77,"./cmds":9,"./perf":37,"./settings":44}],39:[function(require,module,exports){
"use strict"
exports.enter=enter
exports.exit=exit
exports.isLocked=isLocked
exports.startup=startup
var _require=require("../common/util.js"),eatPossiblePromise=_require.eatPossiblePromise
var user_want_locked=false
var elem
var on_ptr_lock
function isLocked(){return user_want_locked}function pointerLog(msg){console.log("PointerLock: "+msg)}function exit(){pointerLog("Lock exit requested")
user_want_locked=false
eatPossiblePromise(document.exitPointerLock())}function enter(when){user_want_locked=true
on_ptr_lock()
pointerLog("Trying pointer lock in response to "+when)
eatPossiblePromise(elem.requestPointerLock())}function onPointerLockChange(){if(document.pointerLockElement||document.mozPointerLockElement||document.webkitPointerLockElement){pointerLog("Lock successful")
if(!user_want_locked){pointerLog("User canceled lock")
eatPossiblePromise(document.exitPointerLock())}}else if(user_want_locked){pointerLog("Lock lost")
user_want_locked=false}}function onPointerLockError(e){pointerLog("Error")
user_want_locked=false}function startup(_elem,_on_ptr_lock){on_ptr_lock=_on_ptr_lock;(elem=_elem).requestPointerLock=elem.requestPointerLock||elem.mozRequestPointerLock||elem.webkitRequestPointerLock||function(){}
document.exitPointerLock=document.exitPointerLock||document.mozExitPointerLock||document.webkitExitPointerLock||function(){}
document.addEventListener("pointerlockchange",onPointerLockChange,false)
document.addEventListener("mozpointerlockchange",onPointerLockChange,false)
document.addEventListener("webkitpointerlockchange",onPointerLockChange,false)
document.addEventListener("pointerlockerror",onPointerLockError,false)
document.addEventListener("mozpointerlockerror",onPointerLockError,false)
document.addEventListener("webkitpointerlockerror",onPointerLockError,false)}

},{"../common/util.js":74}],40:[function(require,module,exports){
"use strict"
var typedarrays=[Int8Array,Uint8Array,Int16Array,Uint16Array,Int32Array,Uint32Array,Float32Array]
if(!Uint8Array.prototype.slice)typedarrays.forEach(function(ArrayType){Object.defineProperty(ArrayType.prototype,"slice",{value:function value(begin,end){if(void 0===end)end=this.length
if(end<0)end=this.length-end
if((begin=begin||0)>=this.length)begin=this.length-1
if(end>this.length)end=this.length
if(end<begin)end=begin
var len=end-begin
var ret=new ArrayType(len)
for(var ii=0;ii<len;++ii)ret[ii]=this[begin+ii]
return ret}})})
function cmpDefault(a,b){return a-b}var replacements={join:function join(delim){return Array.prototype.join.call(this,delim)},fill:function fill(value,begin,end){if(void 0===end)end=this.length
for(var ii=begin||0;ii<end;++ii)this[ii]=value
return this},sort:function sort(cmp){Array.prototype.sort.call(this,cmp||cmpDefault)}}
var _loop=function _loop(key){if(!Uint8Array.prototype[key])typedarrays.forEach(function(ArrayType){Object.defineProperty(ArrayType.prototype,key,{value:replacements[key]})})}
for(var key in replacements)_loop(key)
if(!String.prototype.endsWith){Object.defineProperty(String.prototype,"endsWith",{value:function value(test){return this.slice(-test.length)===test}})
Object.defineProperty(String.prototype,"startsWith",{value:function value(test){return this.slice(0,test.length)===test}})}if(!String.prototype.includes)Object.defineProperty(String.prototype,"includes",{value:function value(search,start){return-1!==this.indexOf(search,start)}})
if(!Array.prototype.includes)Object.defineProperty(Array.prototype,"includes",{value:function value(search,start){return-1!==this.indexOf(search,start)}})
if(!Object.values)Object.values=function values(obj){return Object.keys(obj).map(function(k){return obj[k]})}
if(!Object.entries)Object.entries=function entries(obj){var keys=Object.keys(obj)
var ret=new Array(keys.length)
for(var ii=keys.length-1;ii>=0;--ii)ret[ii]=[keys[ii],obj[keys[ii]]]
return ret}
if(!Object.assign)Object.assign=function assign(target,source1){for(var argindex=1;argindex<arguments.length;++argindex){var source=arguments[argindex]
for(var _key in source)target[_key]=source[_key]}return target}
if(!Math.sign)Math.sign=function sign(a){return a<0?-1:a>0?1:0}
if("undefined"!==typeof window){if(!window.Intl)window.Intl={}
if(!window.Intl.NumberFormat){window.Intl.NumberFormat=function(){}
window.Intl.NumberFormat.prototype.format=function(v){return String(v)}}if(!window.Intl.DateTimeFormat){window.Intl.DateTimeFormat=function(){}
window.Intl.DateTimeFormat.prototype.format=function(v){return String(v)}}}

},{}],41:[function(require,module,exports){
"use strict"
exports.MEM_DEPTH_DEFAULT=exports.HIST_TOT=exports.HIST_SIZE=exports.HIST_COMPONENTS=exports.HAS_MEMSIZE=void 0
exports.profilerAvgMem=profilerAvgMem
exports.profilerAvgTime=profilerAvgTime
exports.profilerChildCallCount=profilerChildCallCount
exports.profilerDump=profilerDump
exports.profilerExport=profilerExport
exports.profilerFrameStart=profilerFrameStart
exports.profilerGarbageEstimate=profilerGarbageEstimate
exports.profilerHistoryIndex=profilerHistoryIndex
exports.profilerImport=profilerImport
exports.profilerMaxMem=profilerMaxMem
exports.profilerMeasureBloat=profilerMeasureBloat
exports.profilerMemDepthGet=profilerMemDepthGet
exports.profilerMemDepthSet=profilerMemDepthSet
exports.profilerNodeRoot=profilerNodeRoot
exports.profilerNodeTick=profilerNodeTick
exports.profilerPause=profilerPause
exports.profilerPaused=profilerPaused
exports.profilerWalkTree=profilerWalkTree
exports.profilerWarning=profilerWarning
var HAS_MEMSIZE=Boolean(window.performance&&performance.memory&&performance.memory.usedJSHeapSize)
exports.HAS_MEMSIZE=HAS_MEMSIZE
var HIST_SIZE=128
exports.HIST_SIZE=HIST_SIZE
var HIST_COMPONENTS=3
exports.HIST_COMPONENTS=HIST_COMPONENTS
var HIST_TOT=HIST_SIZE*HIST_COMPONENTS
exports.HIST_TOT=HIST_TOT
var MEM_DEPTH_DEFAULT=2
exports.MEM_DEPTH_DEFAULT=MEM_DEPTH_DEFAULT
var assert=require("assert")
var engine=require("./engine.js")
var floor=Math.floor,max=Math.max,min=Math.min,round=Math.round
var _require=require("./local_storage.js"),localStorageGetJSON=_require.localStorageGetJSON,localStorageSetJSON=_require.localStorageSetJSON
var profiler_open_keys=localStorageGetJSON("profiler_open_keys",{})
var last_id=0
function ProfilerEntry(parent,name){this.parent=parent
this.depth=parent?parent.depth+1:0
this.next=null
this.child=null
this.name=name
this.count=0
this.time=0
this.dmem=0
this.start_time=0
this.start_mem=0
this.history=new Float32Array(HIST_TOT)
this.id=++last_id
this.show_children=!(parent&&parent.parent)||profiler_open_keys[this.getKey()]||false
this.color_override=null}ProfilerEntry.prototype.isEmpty=function(){for(var ii=0;ii<HIST_TOT;ii+=HIST_COMPONENTS)if(this.history[ii])return false
return true}
ProfilerEntry.prototype.toJSON=function(){var next=this.next,child=this.child
while(next&&next.isEmpty())next=next.next
while(child&&child.isEmpty())child=child.next
var ret={i:this.name,h:Array.prototype.slice.call(this.history)}
if(next)ret.n=next
if(child)ret.c=child
return ret}
function profilerEntryFromJSON(parent,obj){var ret=new ProfilerEntry(parent,obj.i)
assert.equal(obj.h.length,ret.history.length)
for(var ii=0;ii<obj.h.length;++ii)ret.history[ii]=obj.h[ii]
if(obj.n)ret.next=profilerEntryFromJSON(parent,obj.n)
if(obj.c)ret.child=profilerEntryFromJSON(ret,obj.c)
return ret}ProfilerEntry.prototype.getKey=function(){if(!this.parent)return""
else return this.parent.getKey()+"."+this.name}
ProfilerEntry.prototype.toggleShowChildren=function(){this.show_children=!this.show_children
if(this.show_children)profiler_open_keys[this.getKey()]=1
else delete profiler_open_keys[this.getKey()]
localStorageSetJSON("profiler_open_keys",profiler_open_keys)}
var root=new ProfilerEntry(null,"root")
var node_out_of_tick=new ProfilerEntry(root,"GPU/idle")
root.child=node_out_of_tick
var node_tick=new ProfilerEntry(root,"tick")
node_out_of_tick.next=node_tick
var current=root
var last_child=null
var history_index=0
var paused=false
var mem_depth=MEM_DEPTH_DEFAULT
function memSizeChrome(){return performance.memory.usedJSHeapSize}function memSizeNop(){return 0}var memSize=HAS_MEMSIZE?memSizeChrome:memSizeNop
var mem_is_high_res=10
function profilerChildCallCount(node,with_mem,do_average){var walk=node.child
var count=0
while(walk){if(do_average){var total=0
var sum_count=0
for(var ii=0;ii<HIST_TOT;ii+=HIST_COMPONENTS)if(!with_mem||walk.history[ii+2]){sum_count++
total+=walk.history[ii]}if(sum_count)count+=round(total/sum_count)}else if(!with_mem||walk.history[history_index+2])count+=walk.history[history_index]
count+=profilerChildCallCount(walk,with_mem,do_average)
walk=walk.next}return count}var WARN_CALLS_COUNT=1e3
function profilerWarning(){var total_calls=profilerChildCallCount(root,false,true)
if(total_calls>WARN_CALLS_COUNT)return"Warning: Too many per-frame profilerStart() calls ("+total_calls+" > "+WARN_CALLS_COUNT+")"
else if(!HAS_MEMSIZE)return"To access memory profiling, run in Chrome"
else if(mem_depth>1&&mem_is_high_res<10)return"For precise memory profiling, launch Chrome with --enable-precise-memory-info"
return""}function profilerNodeRoot(){return root}function profilerNodeTick(){return node_tick}function profilerHistoryIndex(){return history_index}var garbage_accum=[0,0]
var garbage_count=[0,0,0]
function profilerFrameStart(){root.count=1
var now=performance.now()
root.time=now-root.start_time
root.start_time=now
if(mem_depth>0){var memnow=memSize()
root.dmem=memnow-root.start_mem
root.start_mem=memnow}node_out_of_tick.count=1
node_out_of_tick.time=root.time
node_out_of_tick.dmem=root.dmem
for(var _walk=root.child;_walk;_walk=_walk.next){if(_walk===node_out_of_tick)continue
node_out_of_tick.time-=_walk.time
node_out_of_tick.dmem-=_walk.dmem
if(mem_depth>1)if(_walk.count)if(_walk.dmem)mem_is_high_res++
else mem_is_high_res-=5}var pos=0
var neg=0
for(var _walk2=root.child;_walk2;_walk2=_walk2.next)if(_walk2.dmem<0)neg-=_walk2.dmem
else pos+=_walk2.dmem
if(pos>neg){garbage_accum[0]+=pos
garbage_count[0]++}else{garbage_accum[1]+=neg
garbage_count[1]++}if(current!==root){console.error("Profiler starting new frame but some section was not stopped",current&&current.name)
current=root}if(!paused)history_index=(history_index+HIST_COMPONENTS)%HIST_TOT
var walk=root
while(walk){var recursing_down=true
if(!paused){walk.history[history_index]=walk.count
walk.history[history_index+1]=walk.time
walk.history[history_index+2]=walk.dmem}walk.count=0
walk.time=0
walk.dmem=0
do{if(recursing_down&&walk.child)walk=walk.child
else if(walk.next)walk=walk.next
else{recursing_down=false
if(walk=walk.parent)continue}break}while(true)}}function profilerStart(name){var instance
if(last_child&&last_child.name===name)instance=last_child
else if(last_child&&last_child.next&&last_child.next.name===name)instance=last_child.next
else{var last=null
for(instance=current.child;instance;instance=(last=instance).next)if(instance.name===name)break
if(!instance)if(!last){assert(!current.child)
instance=new ProfilerEntry(current,name)
current.child=instance}else if(last_child){(instance=new ProfilerEntry(current,name)).next=last_child.next
last_child.next=instance}else{instance=new ProfilerEntry(current,name)
last.next=instance}}assert(instance.parent===current);(current=instance).start_time=performance.now()
if(instance.depth<mem_depth)instance.start_mem=memSize()
last_child=null}function profilerStop(old_name){if(old_name)assert.equal(old_name,current.name)
current.time+=performance.now()-current.start_time
if(current.depth<mem_depth)current.dmem+=memSize()-current.start_mem
current.count++
current=(last_child=current).parent}function profilerStopStart(name){profilerStop(null)
profilerStart(name)}if(window.performance&&window.performance.now){window.profilerStart=profilerStart
window.profilerStop=profilerStop
window.profilerStopStart=profilerStopStart}function profilerPaused(){return paused}function profilerPause(new_value){paused=new_value}function profilerMemDepthGet(){return mem_depth}function profilerMemDepthSet(value){mem_depth=value}var bloat_inner={time:0,mem:0}
var bloat_outer={time:0,mem:0}
var bloat={inner:bloat_inner,outer:bloat_outer}
var MEASURE_KEY1="profilerMeasureBloat"
var MEASURE_KEY2="profilerMeasureBloat:child"
var MEASURE_HIST=10
function profilerMeasureBloat(){var mem_depth_saved=mem_depth
if(mem_depth>=2)mem_depth=Infinity
profilerStart(MEASURE_KEY1)
profilerStart(MEASURE_KEY2)
profilerStopStart(MEASURE_KEY2)
profilerStopStart(MEASURE_KEY2)
profilerStopStart(MEASURE_KEY2)
profilerStop(MEASURE_KEY2)
profilerStop(MEASURE_KEY1)
mem_depth=mem_depth_saved
var walk=null
for(walk=current.child;walk.name!==MEASURE_KEY1;walk=walk.next);var child=walk.child
assert.equal(child.name,MEASURE_KEY2)
bloat_inner.time=Infinity
bloat_inner.mem=0
bloat_outer.time=Infinity
var count_mem=bloat_outer.mem=0
var idx_start=(history_index-HIST_COMPONENTS*(MEASURE_HIST-1)+HIST_TOT)%HIST_TOT
for(var offs=0;offs<MEASURE_HIST;offs++){var idx=(idx_start+offs*HIST_COMPONENTS)%HIST_TOT
bloat_inner.time=min(bloat_inner.time,child.history[idx+1])
bloat_outer.time=min(bloat_outer.time,walk.history[idx+1])
if(child.history[idx+2]>0&&walk.history[idx+2]>0){bloat_inner.mem+=child.history[idx+2]
bloat_outer.mem+=walk.history[idx+2];++count_mem}}bloat_inner.time/=4
bloat_outer.time=max(0,bloat_outer.time-bloat_inner.time)/4
var avg_inner_mem=bloat_inner.mem/count_mem/4
bloat_outer.mem=count_mem?max(0,floor((bloat_outer.mem/count_mem-avg_inner_mem)/4)):0
bloat_inner.mem=count_mem?max(0,floor(avg_inner_mem)):0
return bloat}function profilerGarbageEstimate(){var ret
if(garbage_count[0]>garbage_count[1])ret=garbage_accum[0]/garbage_count[0]
else ret=garbage_accum[1]/garbage_count[1]
garbage_count[0]=garbage_count[1]=0
garbage_accum[0]=garbage_accum[1]=0
return ret}function profilerWalkTree(use_root,cb){var depth=0
var walk=use_root
while(walk){var recursing_down=true
if(walk!==use_root)if(!cb(walk,depth))recursing_down=false
do{if(recursing_down&&walk.child){depth++
walk=walk.child}else if(walk.next)walk=walk.next
else{depth--
recursing_down=false
if(walk=walk.parent)continue}break}while(true)}}function profilerAvgTime(entry){var sum=0
for(var ii=0;ii<HIST_TOT;ii+=HIST_COMPONENTS)if(entry.history[ii])sum+=entry.history[ii+1]
return sum/HIST_SIZE}function profilerMaxMem(entry){var dmem_max=0
for(var ii=0;ii<HIST_TOT;ii+=HIST_COMPONENTS)if(entry.history[ii])dmem_max=max(dmem_max,entry.history[ii+2])
return dmem_max}function profilerAvgMem(entry){var dmem_avg=0
var dmem_count=0
for(var ii=0;ii<HIST_TOT;ii+=HIST_COMPONENTS)if(entry.history[ii]){var dmem=entry.history[ii+2]
if(dmem>=0){dmem_avg+=dmem
dmem_count++}}if(dmem_count)dmem_avg/=dmem_count
return dmem_avg}function profilerExport(){var obj={history_index:history_index,root:root,mem_depth:HAS_MEMSIZE?mem_depth:0,device:{ua:window.navigator.userAgent,vendor:gl.getParameter(gl.VENDOR),renderer:gl.getParameter(gl.RENDERER),webgl:engine.webgl2?2:1,width:engine.width,height:engine.height}}
var debug_info=gl.getExtension("WEBGL_debug_renderer_info")
if(debug_info){obj.device.renderer_unmasked=gl.getParameter(debug_info.UNMASKED_RENDERER_WEBGL)
obj.device.vendor_unmasked=gl.getParameter(debug_info.UNMASKED_VENDOR_WEBGL)}var str=JSON.stringify(obj)
return str=str.replace(/\d\.\d\d\d\d+/g,function(a){a=a[5]>"4"?a.slice(0,4)+(Number(a[4])+1):a.slice(0,5)
while("0"===a.slice(-1)||"."===a.slice(-1))a=a.slice(0,-1)
return a})}function profilerImport(text){var obj
try{obj=JSON.parse(text)}catch(e){}if(!obj)return null
obj.root=profilerEntryFromJSON(null,obj.root)
return obj}function profilerDump(){assert(current===root)
var lines=["","","# PROFILER RESULTS"]
var total_frame_time=profilerAvgTime(root)
profilerWalkTree(root,function(walk,depth){var time_sum=0
var count_sum=0
var time_max=0
var sum_count=0
var dmem_max=0
for(var ii=0;ii<HIST_TOT;ii+=HIST_COMPONENTS)if(walk.history[ii]){sum_count++
count_sum+=walk.history[ii]
time_sum+=walk.history[ii+1]
time_max=max(time_max,walk.history[ii+1])
dmem_max=max(dmem_max,walk.history[ii+2])}if(!count_sum)return true
var percent=time_sum/HIST_SIZE/total_frame_time
var ms=time_sum/sum_count
var count=(count_sum/sum_count).toFixed(0)
var buf=""
for(var _ii=1;_ii<depth;++_ii)buf+="* "
buf+=(100*percent).toFixed(0)+"% "+walk.name+" "
buf+=(1e3*ms).toFixed(0)+" ("+count+") max:"+(1e3*time_max).toFixed(0)
if(HAS_MEMSIZE)buf+=" dmem:"+dmem_max
lines.push(buf)
return true})
var warning=profilerWarning()
if(warning)lines.push("",warning)
lines.push("","")
console.log(lines.join("\n"))}window.profilerDump=profilerDump

},{"./engine.js":13,"./local_storage.js":31,"assert":undefined}],42:[function(require,module,exports){
"use strict"
exports.profilerUI=profilerUI
exports.profilerUIStartup=profilerUIStartup
var camera2d=require("./camera2d.js")
var _require=require("./cmds.js"),cmd_parse=_require.cmd_parse
var engine=require("./engine.js")
var _require2=require("./font.js"),style=_require2.style
var input=require("./input.js")
var floor=Math.floor,max=Math.max,min=Math.min,round=Math.round
var _require3=require("./net.js"),netClient=_require3.netClient,netDisconnected=_require3.netDisconnected
var ui=require("./ui.js")
var _require4=require("./perf.js"),perfGraphOverride=_require4.perfGraphOverride,friendlyBytes=_require4.friendlyBytes
var _require5=require("./profiler.js"),HIST_SIZE=_require5.HIST_SIZE,HIST_COMPONENTS=_require5.HIST_COMPONENTS,HIST_TOT=_require5.HIST_TOT,HAS_MEMSIZE=_require5.HAS_MEMSIZE,MEM_DEPTH_DEFAULT=_require5.MEM_DEPTH_DEFAULT,profilerAvgTime=_require5.profilerAvgTime,profilerChildCallCount=_require5.profilerChildCallCount,profilerImport=_require5.profilerImport,profilerExport=_require5.profilerExport,profilerHistoryIndex=_require5.profilerHistoryIndex,profilerAvgMem=_require5.profilerAvgMem,profilerMaxMem=_require5.profilerMaxMem,profilerMeasureBloat=_require5.profilerMeasureBloat,profilerMemDepthGet=_require5.profilerMemDepthGet,profilerMemDepthSet=_require5.profilerMemDepthSet,profilerNodeTick=_require5.profilerNodeTick,profilerNodeRoot=_require5.profilerNodeRoot,profilerPause=_require5.profilerPause,profilerPaused=_require5.profilerPaused,profilerWalkTree=_require5.profilerWalkTree,profilerWarning=_require5.profilerWarning
var settings=require("./settings.js")
var _require6=require("./sprites.js"),spriteChainedStart=_require6.spriteChainedStart,spriteChainedStop=_require6.spriteChainedStop
var _require7=require("../common/util.js"),lerp=_require7.lerp
var _require8=require("../common/vmath.js"),vec2=_require8.vec2,vec4=_require8.vec4
Z.PROFILER=Z.PROFILER||9950
var color_gpu=vec4(.5,.5,1,1)
var loaded_profile=null
var node_out_of_tick
var root
function useNewRoot(new_root){if(node_out_of_tick=(root=new_root).child)node_out_of_tick.color_override=color_gpu}function useSavedProfile(text){var obj=profilerImport(text)
if(!obj){ui.modalDialog({title:"Error loading profile",text:text||"No data",buttons:{Ok:null}})
return}useNewRoot(obj.root)
loaded_profile=obj}function useLiveProfile(){useNewRoot(profilerNodeRoot())
loaded_profile=null}function profilerToggle(data,resp_func){useLiveProfile()
if("1"===data)settings.set("show_profiler",1)
else if("0"===data){settings.set("show_profiler",0)
profilerMemDepthSet(MEM_DEPTH_DEFAULT)}else if(settings.show_profiler)if(profilerPaused())profilerPause(false)
else{settings.set("show_profiler",0)
profilerMemDepthSet(MEM_DEPTH_DEFAULT)}else{settings.set("show_profiler",1)
profilerPause(true)}if(resp_func)resp_func()}var access_show=engine.DEBUG?void 0:["hidden"]
cmd_parse.register({cmd:"profiler_toggle",help:"Show or toggle profiler visibility",access_show:access_show,func:profilerToggle})
var PROFILER_RELATIVE_LABELS=["% of user","% of parent","% of frame","% of mem"]
settings.register({show_profiler:{default_value:0,type:cmd_parse.TYPE_INT,range:[0,1],access_show:access_show},profiler_average:{default_value:1,type:cmd_parse.TYPE_INT,range:[0,2],access_show:["hidden"]},profiler_relative:{default_value:1,type:cmd_parse.TYPE_INT,range:[0,PROFILER_RELATIVE_LABELS.length-1],access_show:["hidden"]},profiler_interactable:{default_value:1,type:cmd_parse.TYPE_INT,range:[0,1],access_show:["hidden"]},profiler_graph:{default_value:0,type:cmd_parse.TYPE_INT,range:[0,1],access_show:["hidden"]},profiler_mem_depth:{default_value:MEM_DEPTH_DEFAULT,type:cmd_parse.TYPE_INT,range:[0,100],access_show:["hidden"]},profiler_hide_bloat:{default_value:1,type:cmd_parse.TYPE_INT,range:[0,1],access_show:access_show}})
var font
var y
var style_time_spike=style(null,{color:4286545919})
var style_number=style(null,{color:4294955263})
var style_percent=style(null,{color:4294955263})
var style_ms=style(null,{color:3506438143})
var style_mem=style(null,{color:3506426111})
var style_header=style(null,{color:4294967295,outline_width:.8,outline_color:4294967295})
var style_name=style(null,{color:4294967295,outline_width:1,outline_color:128})
var FONT_SIZE=22
var LINE_HEIGHT=24
var LINE_YOFFS=(LINE_HEIGHT-FONT_SIZE)/2
var font_number_scale
var font_size_number
var number_yoffs
var bar_w
var Z_BAR=Z.PROFILER
var Z_GRAPH=Z.PROFILER+1
var Z_TREE=Z.PROFILER+2
var Z_NAMES=Z.PROFILER+3
var Z_NUMBER=Z.PROFILER+4
var Z_MS=Z.PROFILER+5
var MS_W=58
var COUNT_W=56
var MSPAIR_W=MS_W+4+COUNT_W
var MEM_W=120
var COL_HEADERS=["Profiler","Âµs (count)","max","GC / Î”mem"]
var COL_W=[400,MSPAIR_W,MS_W,MEM_W]
var COL_X=[]
var bar_x0
for(var ii=COL_X[0]=0;ii<COL_W.length;++ii)COL_X[ii+1]=COL_X[ii]+COL_W[ii]+4
var LINE_WIDTH_WITH_MEM=COL_X[COL_W.length]
var LINE_WIDTH_NO_MEM=COL_X[COL_W.length-1]
var color_hint=vec4(0,.25,0,.85)
var color_bar=vec4(0,0,0,.85)
var color_bar2=vec4(.2,.2,.2,.85)
var color_bar_header=vec4(.3,.3,.3,.85)
var color_bar_over=vec4(0,0,.5,.85)
var color_bar_over2=vec4(.2,.2,.7,.85)
var color_bar_parent=vec4(0,0,.3,.85)
var color_bar_parent2=vec4(.2,.2,.4,.85)
var color_timing=vec4(1,1,.5,1)
var color_bar_highlight=vec4(0,0,0,.5)
var GRAPH_FRAME_TIME=16
var GRAPH_MAX_MEM=4096
var total_frame_time
var total_frame_mem
var show_index_count
var show_index_time
var show_index_mem
var do_average
var history_index
var do_ui
var line_width
var show_mem
var mouseover_elem={}
var mouseover_main_elem
var mouseover_bar_idx
var dmem_max_value=0
var perf_graph={history_size:HIST_SIZE,num_lines:2,data:{history:new Float32Array(2*HIST_SIZE),index:0},line_scale_top:GRAPH_FRAME_TIME,bars_stack:true,colors:[vec4(.5,1,.5,1),color_gpu]}
var bloat
var mouseover_param={x:0,peek:true,h:LINE_HEIGHT}
function profilerShowEntryEarly(walk,depth){if(0===settings.profiler_relative&&walk===node_out_of_tick)return false
var count_sum=0
for(var _ii=0;_ii<HIST_TOT;_ii+=HIST_COMPONENTS)count_sum+=walk.history[_ii]
if(!count_sum)return true
mouseover_param.y=y
mouseover_param.w=line_width
if(input.mouseOver(mouseover_param)){mouseover_elem[(mouseover_main_elem=walk).id]=1
for(var parent=walk.parent;parent;parent=parent.parent)mouseover_elem[parent.id]=2}y+=LINE_HEIGHT
if(!walk.show_children)return false
return true}function hasActiveChildren(walk){if(!(walk=walk.child))return false
while(walk){for(var _ii2=0;_ii2<HIST_TOT;_ii2+=HIST_COMPONENTS)if(walk.history[_ii2])return true
walk=walk.next}return false}function childMemCallCount(node,idx){var walk=node.child
var count=0
while(walk){if(walk.history[idx+2])count+=walk.history[idx]
count+=childMemCallCount(walk,idx)
walk=walk.next}return count}function nodeMemValue(node,idx){var count=node.history[idx]
var dmem=node.history[idx+2]
if(show_mem&&settings.profiler_hide_bloat&&dmem>0)dmem=max(0,dmem-count*bloat.inner.mem-childMemCallCount(node,idx)*bloat.outer.mem)
return dmem}var click_param={x:0,h:LINE_HEIGHT}
function profilerShowEntry(walk,depth){if(0===settings.profiler_relative&&walk===node_out_of_tick)return false
var time_sum=0
var count_sum=0
var time_max=0
var sum_count=0
var dmem_min=Infinity
var dmem_max=-Infinity
var dmem_avg=0
var dmem_count=0
for(var _ii3=0;_ii3<HIST_TOT;_ii3+=HIST_COMPONENTS)if(walk.history[_ii3]){sum_count++
count_sum+=walk.history[_ii3]
time_sum+=walk.history[_ii3+1]
time_max=max(time_max,walk.history[_ii3+1])
var dmem=nodeMemValue(walk,_ii3)
dmem_max_value=max(dmem_max_value,dmem)
dmem_min=min(dmem_min,dmem)
dmem_max=max(dmem_max,dmem)
if(dmem>=0){dmem_avg+=dmem;++dmem_count}}if(!count_sum)return true
if(dmem_count)dmem_avg=round(dmem_avg/dmem_count)
var over=1===mouseover_elem[walk.id]
var parent_over=2===mouseover_elem[walk.id]
if(do_ui){click_param.y=y
click_param.w=line_width
var click=input.click(click_param)
if(click)if(1===click.button)walk.parent.toggleShowChildren()
else walk.toggleShowChildren()}profilerStart("bar graph")
spriteChainedStart()
var color_top=over?color_bar_over:parent_over?color_bar_parent:color_bar
var color_bot=over?color_bar_over2:parent_over?color_bar_parent2:color_bar2
if(!engine.defines.NORECTS)ui.drawRect4Color(0,y,line_width,y+LINE_HEIGHT,Z_BAR,color_top,color_top,color_bot,color_bot)
var x=bar_x0
var offs=1+settings.profiler_graph
var graph_max=settings.profiler_graph?GRAPH_MAX_MEM:GRAPH_FRAME_TIME
for(var _ii4=0;_ii4<HIST_SIZE;++_ii4){var value=walk.history[(history_index+(_ii4+1)*HIST_COMPONENTS)%HIST_TOT+offs]
if(value>0){var hv=value/graph_max
var h=min(hv*LINE_HEIGHT,LINE_HEIGHT)
if(hv<1){color_timing[0]=hv
color_timing[1]=1}else{color_timing[0]=1
color_timing[1]=max(0,2-hv)}var color=walk.color_override||color_timing
if(!engine.defines.NORECTS){var elem=ui.drawRect(x+_ii4*bar_w,y+LINE_HEIGHT-h,x+(_ii4+1)*bar_w,y+LINE_HEIGHT,Z_GRAPH,color)
elem.x=elem.y=0}}}spriteChainedStop()
profilerStop("bar graph")
y+=LINE_YOFFS
var prefix
if(hasActiveChildren(walk))if(!walk.show_children)prefix="â–¶"
else prefix="â–¼"
var percent=0
if(1===settings.profiler_relative){if(walk.parent)if(do_average)percent=time_sum/HIST_SIZE/profilerAvgTime(walk.parent)
else percent=walk.history[show_index_time]?walk.history[show_index_time]/walk.parent.history[show_index_time]:0}else if(3===settings.profiler_relative)if(2===do_average)percent=dmem_max/total_frame_mem
else if(do_average)percent=dmem_avg/total_frame_mem
else percent=walk.history[show_index_mem]/total_frame_mem
else if(do_average)percent=time_sum/HIST_SIZE/total_frame_time
else percent=walk.history[show_index_time]/total_frame_time
x=depth*FONT_SIZE
if(prefix)font.drawSized(null,x-16,y,Z_TREE,FONT_SIZE,prefix)
x+=2*FONT_SIZE
font.drawSizedAligned(style_percent,x,y+number_yoffs,Z_NUMBER,font_size_number,font.ALIGN.HRIGHT,0,0,(100*percent).toFixed(0)+"%")
font.drawSized(style_name,x+=4,y,Z_NAMES,FONT_SIZE,walk.name)
x=COL_X[1]
var ms=do_average?time_sum/sum_count:walk.history[show_index_time]
var count=do_average?(count_sum/sum_count).toFixed(0):walk.history[show_index_count]
font.drawSizedAligned(style_ms,x,y+number_yoffs,Z_MS,font_size_number,font.ALIGN.HRIGHT,MS_W,0,(1e3*ms).toFixed(0))
x+=MS_W+4
font.drawSizedAligned(style_number,x,y+number_yoffs,Z_NUMBER,font_size_number,font.ALIGN.HFIT,COUNT_W,0,"("+count+")")
x=COL_X[2]
var spike=.25*time_max>time_sum/sum_count&&time_max>500
font.drawSizedAligned(spike?style_time_spike:style_ms,x,y+number_yoffs,Z_MS,font_size_number,font.ALIGN.HRIGHT,COL_W[2],0,(1e3*time_max).toFixed(0))
if(show_mem){x=COL_X[3]
var mem_value=2===do_average?dmem_max:do_average?dmem_avg:nodeMemValue(walk,show_index_count)
if(dmem_min<0){font.drawSizedAligned(style_time_spike,x,y+number_yoffs,Z_MS,font_size_number,font.ALIGN.HLEFT|font.ALIGN.HFIT,MEM_W/2,0,""+friendlyBytes(-dmem_min))
font.drawSizedAligned(style_mem,x+MEM_W/2,y+number_yoffs,Z_MS,font_size_number,font.ALIGN.HRIGHT|font.ALIGN.HFIT,MEM_W/2,0,""+mem_value)}else font.drawSizedAligned(style_mem,x,y+number_yoffs,Z_MS,font_size_number,font.ALIGN.HRIGHT,MEM_W,0,""+mem_value)}y+=FONT_SIZE+LINE_YOFFS
if(!walk.show_children)return false
return true}function doZoomedGraph(){if(settings.profiler_graph){perf_graph.line_scale_top=GRAPH_MAX_MEM
if(!mouseover_main_elem)mouseover_main_elem=profilerNodeTick()}else if(!mouseover_main_elem||mouseover_main_elem===node_out_of_tick)perf_graph.line_scale_top=2*GRAPH_FRAME_TIME
else perf_graph.line_scale_top=GRAPH_FRAME_TIME
var offs=1+settings.profiler_graph
if(mouseover_main_elem){var elem=mouseover_main_elem
for(var _ii5=0;_ii5<HIST_SIZE;++_ii5){perf_graph.data.history[2*_ii5]=elem.history[_ii5*HIST_COMPONENTS+offs]
perf_graph.data.history[2*_ii5+1]=0}}else for(var _ii6=0;_ii6<HIST_SIZE;++_ii6){var idx=_ii6*HIST_COMPONENTS+offs
perf_graph.data.history[2*_ii6]=root.history[idx]-node_out_of_tick.history[idx]
perf_graph.data.history[2*_ii6+1]=node_out_of_tick.history[idx]}perf_graph.data.index=history_index/HIST_COMPONENTS
perfGraphOverride(perf_graph)}var BUTTON_W=140
var BUTTON_H=48
var BUTTON_FONT_HEIGHT=24
var mouse_pos=vec2()
var bloat_none={inner:{time:0,mem:0},outer:{time:0,mem:0}}
var button_overlay
var button_close
var button_paused
var button_relative
var button_average
var button_graph
var button_mem_dec
var button_mem_depth
var button_mem_inc
var button_max_fps
var button_save
var button_load
var last_line_width
function buttonInit(){var z=Z.PROFILER+10
button_overlay={x:line_width,y:y=0,z:z,w:BUTTON_W,h:BUTTON_H,font_height:BUTTON_FONT_HEIGHT}
button_close={x:line_width+BUTTON_W,y:y,z:z,w:BUTTON_H,h:BUTTON_H,font_height:BUTTON_FONT_HEIGHT,text:"X"}
button_paused={x:line_width,y:y+=BUTTON_H,z:z,w:BUTTON_W,h:BUTTON_H,font_height:BUTTON_FONT_HEIGHT}
button_relative={x:line_width,y:y+=BUTTON_H,z:z,w:BUTTON_W,h:BUTTON_H,font_height:BUTTON_FONT_HEIGHT}
button_average={x:line_width,y:y+=BUTTON_H,z:z,w:BUTTON_W,h:BUTTON_H,font_height:BUTTON_FONT_HEIGHT}
button_graph={x:line_width,y:y+=BUTTON_H,z:z,w:BUTTON_W,h:BUTTON_H,font_height:BUTTON_FONT_HEIGHT}
y+=BUTTON_H
button_mem_dec={x:line_width,y:y+=LINE_HEIGHT,z:z,w:BUTTON_W/3,h:BUTTON_H,font_height:BUTTON_FONT_HEIGHT,text:"-"}
button_mem_depth={x:line_width+BUTTON_W/3,y:y,z:z,w:BUTTON_W/3,h:BUTTON_H,font_height:BUTTON_FONT_HEIGHT}
button_mem_inc={x:line_width+2*BUTTON_W/3,y:y,z:z,w:BUTTON_W/3,h:BUTTON_H,font_height:BUTTON_FONT_HEIGHT,text:"+"}
button_max_fps={x:line_width,y:y+=BUTTON_H,z:z,w:BUTTON_W,h:BUTTON_H,font_height:BUTTON_FONT_HEIGHT}
y+=BUTTON_H
button_save={x:line_width,y:y+=LINE_HEIGHT,z:z,w:BUTTON_W/2,h:BUTTON_H,font_height:BUTTON_FONT_HEIGHT,text:"save"}
button_load={x:line_width+BUTTON_W/2,y:y,z:z,w:BUTTON_W/2,h:BUTTON_H,font_height:BUTTON_FONT_HEIGHT,text:"load"}}function profilerUIRun(){profilerStart("profilerUIRun")
profilerStart("top+buttons")
bloat=bloat_none
if(!loaded_profile&&settings.profiler_hide_bloat)bloat=profilerMeasureBloat()
if(engine.render_width){var scale=FONT_SIZE/ui.font_height
camera2d.set(0,0,scale*engine.render_width,scale*engine.render_height)
font_number_scale=1
bar_w=scale}else{camera2d.setScreen(true)
font_number_scale=.9
bar_w=2}bar_x0=COL_X[1]-HIST_SIZE*bar_w
number_yoffs=(FONT_SIZE-(font_size_number=FONT_SIZE*font_number_scale))/2
if(profilerMemDepthGet()!==settings.profiler_mem_depth)profilerMemDepthSet(settings.profiler_mem_depth)
if(loaded_profile){history_index=loaded_profile.history_index
show_mem=loaded_profile.mem_depth>0}else{history_index=profilerHistoryIndex()
show_mem=HAS_MEMSIZE}line_width=show_mem?LINE_WIDTH_WITH_MEM:LINE_WIDTH_NO_MEM
if(!button_overlay||line_width!==last_line_width){last_line_width=line_width
buttonInit()}var z=Z.PROFILER+10
y=0
var x=line_width
button_overlay.text=settings.profiler_interactable?"interactable":"overlay"
if(ui.buttonText(button_overlay))settings.set("profiler_interactable",1-settings.profiler_interactable)
if((do_ui=settings.profiler_interactable)&&ui.buttonText(button_close))settings.set("show_profiler",0)
y+=BUTTON_H
var text=loaded_profile?"loaded":profilerPaused()?"paused":"live"
if(do_ui){button_paused.text=text
if(ui.buttonText(button_paused))if(loaded_profile)useLiveProfile()
else profilerPause(!profilerPaused())}else font.drawSizedAligned(null,x,y,z,FONT_SIZE,font.ALIGN.HVCENTERFIT,BUTTON_W,BUTTON_H,text)
y+=BUTTON_H
if(do_ui){button_relative.text=PROFILER_RELATIVE_LABELS[settings.profiler_relative]
if(ui.buttonText(button_relative))settings.set("profiler_relative",(settings.profiler_relative+1)%PROFILER_RELATIVE_LABELS.length)}else font.drawSizedAligned(null,x,y,z,FONT_SIZE,font.ALIGN.HVCENTERFIT,BUTTON_W,BUTTON_H,PROFILER_RELATIVE_LABELS[settings.profiler_relative])
y+=BUTTON_H
text=2===settings.profiler_average?"max":settings.profiler_average?"average":"last frame"
if(do_ui){button_average.text=text
if(ui.buttonText(button_average)){var num_values=HAS_MEMSIZE?3:2
settings.set("profiler_average",(settings.profiler_average+1)%num_values)}}else font.drawSizedAligned(null,x,y,z,FONT_SIZE,font.ALIGN.HVCENTERFIT,BUTTON_W,BUTTON_H,text)
y+=BUTTON_H
text=settings.profiler_graph?"graph: mem":"graph: CPU"
if(do_ui){button_graph.text=text
if(ui.buttonText(button_graph))settings.set("profiler_graph",1-settings.profiler_graph)}else font.drawSizedAligned(null,x,y,z,FONT_SIZE,font.ALIGN.HVCENTERFIT,BUTTON_W,BUTTON_H,text)
y+=BUTTON_H
if(loaded_profile?true:HAS_MEMSIZE){var cur_depth=loaded_profile?loaded_profile.mem_depth:profilerMemDepthGet()
font.drawSizedAligned(null,x,y,z,FONT_SIZE,font.ALIGN.HVCENTERFIT,BUTTON_W,LINE_HEIGHT,"Mem Depth")
y+=LINE_HEIGHT
text=""+(cur_depth||"OFF")
if(do_ui){button_mem_dec.disabled=loaded_profile||0===cur_depth
if(ui.buttonText(button_mem_dec)){profilerMemDepthSet(cur_depth-1)
settings.set("profiler_mem_depth",profilerMemDepthGet())}button_mem_depth.disabled=loaded_profile
button_mem_depth.text=text
if(ui.buttonText(button_mem_depth)){if(cur_depth===MEM_DEPTH_DEFAULT)profilerMemDepthSet(99)
else profilerMemDepthSet(MEM_DEPTH_DEFAULT)
settings.set("profiler_mem_depth",profilerMemDepthGet())}button_mem_inc.disabled=loaded_profile
if(ui.buttonText(button_mem_inc)){profilerMemDepthSet(cur_depth+1)
settings.set("profiler_mem_depth",profilerMemDepthGet())}}else font.drawSizedAligned(null,x,y,z,FONT_SIZE,font.ALIGN.HVCENTERFIT,BUTTON_W,BUTTON_H,text)}else y+=LINE_HEIGHT
y+=BUTTON_H
text=1e3===settings.max_fps?"max CPU":0===settings.max_fps?"anim frame":"?"
if(do_ui){button_max_fps.text=text
if(ui.buttonText(button_max_fps))settings.set("max_fps",0===settings.max_fps?1e3:0)}else font.drawSizedAligned(null,x,y,z,FONT_SIZE,font.ALIGN.HVCENTERFIT,BUTTON_W,BUTTON_H,text)
y+=BUTTON_H
var total_calls=profilerChildCallCount(root,false,settings.profiler_average)
font.drawSizedAligned(null,x,y,z,FONT_SIZE,font.ALIGN.HVCENTERFIT,BUTTON_W,LINE_HEIGHT,total_calls+" calls")
y+=LINE_HEIGHT
if(do_ui){button_save.disabled=loaded_profile
if(ui.buttonText(button_save)){var a=document.createElement("a")
a.href="data:application/json,"+encodeURIComponent(profilerExport())
a.setAttribute("download","profile.json")
a.click()}if(ui.buttonText(button_load)){var input_elem=document.createElement("input")
input_elem.setAttribute("type","file")
var reader=new FileReader
reader.onload=function(){if(2===reader.readyState)useSavedProfile(reader.error||reader.result)}
input_elem.onchange=function(){reader.readAsText(input_elem.files[0])}
input_elem.click()}y+=BUTTON_H}ui.drawRect(x,0,x+BUTTON_W,y,z-1,color_bar)
y=0
font.drawSizedAligned(style_header,COL_X[0],y,z,FONT_SIZE,font.ALIGN.HLEFT,COL_W[0],0,COL_HEADERS[0])
for(var _ii7=1;_ii7<COL_HEADERS.length-(show_mem?0:1);++_ii7)font.drawSizedAligned(style_header,COL_X[_ii7],y,z,FONT_SIZE,font.ALIGN.HCENTER,COL_W[_ii7],0,COL_HEADERS[_ii7])
ui.drawRect(0,y,line_width,y+LINE_HEIGHT,z-1,color_bar_header)
var y0=y+=LINE_HEIGHT
mouseover_main_elem=null
mouseover_bar_idx=-1
if(do_ui){mouseover_elem={}
profilerWalkTree(root,profilerShowEntryEarly)
if(mouseover_main_elem){if(loaded_profile||profilerPaused()){var xx=input.mousePos(mouse_pos)[0]-bar_x0
if((mouseover_bar_idx=floor(xx/bar_w))<0||mouseover_bar_idx>=HIST_SIZE)mouseover_bar_idx=-1}for(var _ii8=dmem_max_value=0;_ii8<HIST_TOT;_ii8+=HIST_COMPONENTS)if(mouseover_main_elem.history[_ii8])dmem_max_value=max(dmem_max_value,mouseover_main_elem.history[_ii8+2])}}if(dmem_max_value<.25*GRAPH_MAX_MEM||dmem_max_value>GRAPH_MAX_MEM)GRAPH_MAX_MEM=lerp(.1,GRAPH_MAX_MEM,dmem_max_value)
dmem_max_value=0
do_average=settings.profiler_average
show_index_count=history_index
if(-1!==mouseover_bar_idx){do_average=false
show_index_count=(show_index_count-(HIST_SIZE-mouseover_bar_idx-1)*HIST_COMPONENTS+HIST_TOT)%HIST_TOT}show_index_time=show_index_count+1
show_index_mem=show_index_count+2
if(do_average){if(0===settings.profiler_relative){total_frame_time=0
var walk=root.child
while(walk){if(walk!==node_out_of_tick)total_frame_time+=profilerAvgTime(walk)
walk=walk.next}total_frame_time=max(total_frame_time,.001)}else if(2===settings.profiler_relative)total_frame_time=profilerAvgTime(root)
else if(3===settings.profiler_relative)if(2===do_average)total_frame_mem=profilerMaxMem(root)
else total_frame_mem=profilerAvgMem(root)}else if(0===settings.profiler_relative){total_frame_time=0
var _walk=root.child
while(_walk){if(_walk!==node_out_of_tick)total_frame_time+=_walk.history[show_index_time]
_walk=_walk.next}total_frame_time=max(total_frame_time,.001)}else if(2===settings.profiler_relative)total_frame_time=root.history[show_index_time]
else if(3===settings.profiler_relative)if((total_frame_mem=root.history[show_index_mem])<0){var _walk2=root.child
total_frame_mem=0
while(_walk2){total_frame_mem+=max(0,_walk2.history[show_index_mem])
_walk2=_walk2.next}}profilerStopStart("interface")
y=y0
profilerWalkTree(root,profilerShowEntry)
var hint=!loaded_profile&&profilerWarning()
if(hint){font.drawSizedAligned(style_name,FONT_SIZE,y,Z_NAMES,FONT_SIZE,font.ALIGN.HVCENTERFIT,line_width-2*FONT_SIZE,1.5*LINE_HEIGHT,hint)
ui.drawRect(0,y,line_width,y+1.5*LINE_HEIGHT,Z_NAMES-.5,color_hint)}if(-1!==mouseover_bar_idx)ui.drawRect(bar_x0+mouseover_bar_idx*bar_w,y0,bar_x0+(mouseover_bar_idx+1)*bar_w,y,Z_GRAPH+.5,color_bar_highlight)
if(do_ui)input.mouseOver({x:0,y:0,w:line_width,h:y})
doZoomedGraph()
profilerStop()
profilerStop("profilerUIRun")}function profilerUIStartup(){font=ui.font
useLiveProfile()}function profilerUI(){if(engine.DEBUG&&input.keyUpEdge(input.KEYS.F7))profilerToggle()
if(settings.show_profiler)profilerUIRun()
if(engine.DEBUG||settings.show_profiler);}cmd_parse.register({cmd:"profile",help:"Captures a performance profile for developer investigation",prefix_usage_with_help:true,usage:"Optionally delays for DELAY seconds before capturing the profile.\nUsage: /profile [DELAY]",func:function func(str,resp_func){function doit(){var profile=profilerExport()
if(netDisconnected()){ui.provideUserString("Profiler Snapshot",profile)
resp_func()}else netClient().send("profile",profile,function(err,data){if(null!=data&&data.id){ui.provideUserString("Profile submitted","ID="+data.id)
resp_func(null,"Profile submitted with ID="+data.id)}else resp_func(err,data)})}if(Number(str))setTimeout(doit,1e3*Number(str))
else doit()}})

},{"../common/util.js":74,"../common/vmath.js":76,"./camera2d.js":7,"./cmds.js":9,"./engine.js":13,"./font.js":19,"./input.js":28,"./net.js":35,"./perf.js":37,"./profiler.js":41,"./settings.js":44,"./sprites.js":51,"./ui.js":57}],43:[function(require,module,exports){
"use strict"
exports.scrollAreaCreate=scrollAreaCreate
exports.scrollAreaSetPixelScale=scrollAreaSetPixelScale
function _extends(){return(_extends=Object.assign?Object.assign.bind():function(target){for(var i=1;i<arguments.length;i++){var source=arguments[i]
for(var key in source)if(Object.prototype.hasOwnProperty.call(source,key))target[key]=source[key]}return target}).apply(this,arguments)}var assert=require("assert")
var _glovCommonUtilJs=require("../common/util.js")
var clamp=_glovCommonUtilJs.clamp
var merge=_glovCommonUtilJs.merge
var verify=require("../common/verify.js")
var _glovCommonVmath=require("../common/vmath")
var vec2=_glovCommonVmath.vec2
var vec4=_glovCommonVmath.vec4
var _camera2dJs=require("./camera2d.js")
var camera2d=_camera2dJs
var _engineJs=require("./engine.js")
var engine=_engineJs
var _inputJs=require("./input.js")
var input=_inputJs
var _inputJs2=require("./input.js")
var BUTTON_LEFT=_inputJs2.BUTTON_LEFT
var KEYS=_inputJs2.KEYS
var PAD=_inputJs2.PAD
var _spotJs=require("./spot.js")
var SPOT_DEFAULT_BUTTON=_spotJs.SPOT_DEFAULT_BUTTON
var SPOT_STATE_DOWN=_spotJs.SPOT_STATE_DOWN
var SPOT_STATE_FOCUSED=_spotJs.SPOT_STATE_FOCUSED
var spot=_spotJs.spot
var spotPadMode=_spotJs.spotPadMode
var spotSubBegin=_spotJs.spotSubBegin
var spotSubEnd=_spotJs.spotSubEnd
var spotUnfocus=_spotJs.spotUnfocus
var _spritesJs=require("./sprites.js")
var spriteClipPop=_spritesJs.spriteClipPop
var spriteClipPush=_spritesJs.spriteClipPush
var _uiJs=require("./ui.js")
var ui=_uiJs
var max=Math.max,min=Math.min,round=Math.round
var MAX_OVERSCROLL=50
var OVERSCROLL_DELAY_WHEEL=180
function darken(color,factor){return vec4(color[0]*factor,color[1]*factor,color[2]*factor,color[3])}var default_pixel_scale=1
function scrollAreaSetPixelScale(scale){default_pixel_scale=scale}var temp_pos=vec2()
var last_scroll_area_id=0
var ScrollAreaInternal=function(){function ScrollAreaInternal(params){this.id="sa:"+ ++last_scroll_area_id
this.x=0
this.y=0
this.z=Z.UI
this.w=10
this.h=10
this.rate_scroll_click=ui.font_height
this.pixel_scale=default_pixel_scale
this.top_pad=true
this.color=vec4(1,1,1,1)
this.background_color=vec4(.4,.4,.4,1)
this.auto_scroll=false
this.auto_hide=false
this.no_disable=false
this.focusable_elem=null
this.min_dist=void 0
this.disabled=false
this.rate_scroll_wheel=void 0
this.rollover_color=void 0
this.rollover_color_light=void 0
this.disabled_color=void 0
this.scroll_pos=0
this.overscroll=0
this.overscroll_delay=0
this.grabbed_pos=0
this.grabbed=false
this.consumed_click=false
this.drag_start=null
this.began=false
this.last_internal_h=0
this.last_frame=0
this.was_disabled=false
this.scrollbar_visible=false
this.last_max_value=0
this.applyParams(params=params||{})
this.rate_scroll_wheel=params.rate_scroll_wheel||2*this.rate_scroll_click
this.rollover_color=params.rollover_color||darken(this.color,.75)
this.rollover_color_light=params.rollover_color_light||darken(this.color,.95)
assert(this.rollover_color_light!==this.color)
this.disabled_color=params.disabled_color||this.rollover_color}var _proto=ScrollAreaInternal.prototype
_proto.applyParams=function applyParams(params){if(!params)return
merge(this,params)}
_proto.barWidth=function barWidth(){var pixel_scale=this.pixel_scale
return ui.sprites.scrollbar_top.uidata.total_w*pixel_scale}
_proto.isFocused=function isFocused(){assert(false,"deprecated?")
return false}
_proto.consumedClick=function consumedClick(){return this.consumed_click}
_proto.isVisible=function isVisible(){return this.scrollbar_visible}
_proto.begin=function begin(params){this.applyParams(params)
var x=this.x,y=this.y,w=this.w,h=this.h,z=this.z,id=this.id
verify(!this.began)
this.began=true
spotSubBegin({x:x,y:y,w:w,h:h,key:id})
spriteClipPush(z+.05,x,y,w-this.barWidth(),h)
var camera_orig_x0=camera2d.x0()
var camera_orig_x1=camera2d.x1()
var camera_orig_y0=camera2d.y0()
var camera_orig_y1=camera2d.y1()
var camera_new_x0=-(x-camera_orig_x0)
var camera_new_y0=-(y-camera_orig_y0)+this.getScrollPos()
var camera_new_x1=camera_new_x0+camera_orig_x1-camera_orig_x0
var camera_new_y1=camera_new_y0+camera_orig_y1-camera_orig_y0
camera2d.push()
camera2d.set(camera_new_x0,camera_new_y0,camera_new_x1,camera_new_y1)}
_proto.getScrollPos=function getScrollPos(){return round(this.scroll_pos+this.overscroll)}
_proto.clampScrollPos=function clampScrollPos(){var clamped_pos=clamp(this.scroll_pos,0,this.last_max_value)
if(this.scroll_pos<0)this.overscroll=max(this.scroll_pos,-MAX_OVERSCROLL)
else if(this.scroll_pos>this.last_max_value)this.overscroll=min(this.scroll_pos-this.last_max_value,MAX_OVERSCROLL)
this.scroll_pos=clamped_pos}
_proto.keyboardScroll=function keyboardScroll(){if(this.was_disabled)return
var modified=false
var pad_shift=input.padButtonDown(PAD.RIGHT_TRIGGER)||input.padButtonDown(PAD.LEFT_TRIGGER)
var value=input.keyDownEdge(KEYS.PAGEDOWN)+(pad_shift?input.padButtonDownEdge(PAD.DOWN):0)
if(value){this.scroll_pos=min(this.scroll_pos+this.h,this.scroll_pos===this.last_max_value?Infinity:this.last_max_value)
modified=true}if(value=input.keyDownEdge(KEYS.PAGEUP)+(pad_shift?input.padButtonDownEdge(PAD.UP):0)){this.scroll_pos=max(this.scroll_pos-this.h,0===this.scroll_pos?-this.h:0)
modified=true}if(modified)this.clampScrollPos()}
_proto.end=function end(h){assert(h>=0)
h=max(h,1)
assert(this.began)
this.began=false
this.consumed_click=false
var focused_sub_elem=spotSubEnd()
camera2d.pop()
spriteClipPop()
if(focused_sub_elem&&spotPadMode())this.scrollIntoFocus(focused_sub_elem.y,focused_sub_elem.y+focused_sub_elem.h+1,this.h)
var maxvalue=max(h-this.h+1,0)
if(this.scroll_pos>=maxvalue)this.scroll_pos=max(0,maxvalue)
var was_at_bottom=this.scroll_pos===this.last_max_value
if(this.auto_scroll&&(this.last_frame!==engine.getFrameIndex()-1||this.last_internal_h!==h&&was_at_bottom)){this.overscroll=max(0,this.scroll_pos+this.overscroll-maxvalue)
this.scroll_pos=maxvalue}this.last_internal_h=h
this.last_frame=engine.getFrameIndex()
if(this.overscroll){var dt=engine.getFrameDt()
if(dt>=this.overscroll_delay){this.overscroll_delay=0
this.overscroll*=max(1-.008*dt,0)}else this.overscroll_delay-=dt}var auto_hide=this.auto_hide,pixel_scale=this.pixel_scale,rollover_color=this.rollover_color,rollover_color_light=this.rollover_color_light
var _ui$sprites=ui.sprites,scrollbar_top=_ui$sprites.scrollbar_top,scrollbar_bottom=_ui$sprites.scrollbar_bottom,scrollbar_trough=_ui$sprites.scrollbar_trough,scrollbar_handle=_ui$sprites.scrollbar_handle,scrollbar_handle_grabber=_ui$sprites.scrollbar_handle_grabber
var bar_w=scrollbar_top.uidata.total_w*pixel_scale
var button_h=min(scrollbar_top.uidata.total_h*pixel_scale,this.h/3)
var button_h_nopad=this.top_pad?button_h:0
var bar_x0=this.x+this.w-bar_w
var handle_h=this.h/h
handle_h=clamp(handle_h,0,1)
var handle_pos=this.h>=h?0:this.scroll_pos/(h-this.h)
handle_pos=clamp(handle_pos,0,1)
assert(isFinite(handle_pos))
var handle_pixel_h=handle_h*(this.h-2*button_h_nopad)
var handle_pixel_min_h=scrollbar_handle.uidata.total_h*pixel_scale
var trough_height=this.h-2*button_h
handle_pixel_h=max(handle_pixel_h,min(handle_pixel_min_h,.75*trough_height))
var handle_screenpos=this.y+button_h_nopad+handle_pos*(this.h-2*button_h_nopad-handle_pixel_h)
var top_color=this.color
var bottom_color=this.color
var handle_color=this.color
var trough_color=this.color
var disabled=this.disabled
var auto_hidden=false
if(!this.h)auto_hidden=disabled=true
else if(1===handle_h){auto_hidden=true
if(this.no_disable)trough_color=top_color=bottom_color=handle_color=this.disabled_color
else disabled=true}var gained_focus=false
if(this.was_disabled=disabled){trough_color=top_color=bottom_color=handle_color=this.disabled_color
this.drag_start=null}else{var wheel_delta=input.mouseWheel({x:this.x,y:this.y,w:this.w,h:this.h})
if(wheel_delta){this.overscroll_delay=OVERSCROLL_DELAY_WHEEL
this.scroll_pos-=this.rate_scroll_wheel*wheel_delta
if(focused_sub_elem)spotUnfocus()}var handle_rect={x:bar_x0,y:handle_screenpos,w:bar_w,h:handle_pixel_h,button:0,spot_debug_ignore:true}
var down=input.mouseDownEdge(handle_rect)
if(down){this.grabbed_pos=down.pos[1]-handle_screenpos
this.grabbed=true
handle_color=rollover_color_light}if(this.grabbed)gained_focus=true
if(this.grabbed){var up=input.mouseUpEdge({button:0})
if(up){temp_pos[1]=up.pos[1]
this.consumed_click=true}else if(!input.mouseDownAnywhere(0)){this.grabbed=false
this.consumed_click=true}else input.mousePos(temp_pos)
if(this.grabbed){var delta=temp_pos[1]-(this.y+button_h_nopad)-this.grabbed_pos
var denom=this.h-2*button_h_nopad-handle_pixel_h
if(denom>0){this.scroll_pos=(h-this.h)*delta/denom
assert(isFinite(this.scroll_pos))}handle_color=rollover_color_light}}if(input.mouseOver(handle_rect))if(handle_color!==rollover_color_light)handle_color=rollover_color
var button_param_up={x:bar_x0,y:this.y,w:bar_w,h:button_h,button:BUTTON_LEFT,pad_focusable:false,disabled:this.grabbed,disabled_focusable:false,def:SPOT_DEFAULT_BUTTON}
var button_param_down=_extends({},button_param_up,{y:this.y+this.h-button_h})
var button_spot_ret=spot(button_param_up)
while(button_spot_ret.ret){--button_spot_ret.ret
gained_focus=true
this.scroll_pos-=this.rate_scroll_click
this.consumed_click=true}if(button_spot_ret.spot_state===SPOT_STATE_DOWN)top_color=rollover_color_light
else if(button_spot_ret.spot_state===SPOT_STATE_FOCUSED)top_color=rollover_color
button_spot_ret=spot(button_param_down)
while(button_spot_ret.ret){--button_spot_ret.ret
gained_focus=true
this.scroll_pos+=this.rate_scroll_click
this.consumed_click=true}if(button_spot_ret.spot_state===SPOT_STATE_DOWN)bottom_color=rollover_color_light
else if(button_spot_ret.spot_state===SPOT_STATE_FOCUSED)bottom_color=rollover_color
var bar_param={key:"bar_"+this.id,x:bar_x0,y:this.y,w:bar_w,h:this.h,button:BUTTON_LEFT,sound_rollover:null,pad_focusable:false,def:SPOT_DEFAULT_BUTTON}
var bar_spot_ret=spot(bar_param)
while(bar_spot_ret.ret){--bar_spot_ret.ret
this.consumed_click=gained_focus=true
if(bar_spot_ret.pos)if(bar_spot_ret.pos[1]>handle_screenpos+handle_pixel_h/2)this.scroll_pos+=this.h
else this.scroll_pos-=this.h}var drag=input.drag({x:this.x,y:this.y,w:this.w-bar_w,h:this.h,button:0,min_dist:this.min_dist})
if(drag){if(null===this.drag_start)this.drag_start=this.scroll_pos
this.scroll_pos=this.drag_start-drag.cur_pos[1]+drag.start_pos[1]
this.consumed_click=true}else this.drag_start=null
input.drag({x:this.x+this.w-bar_w,y:this.y,w:bar_w,h:this.h,button:0})}if(gained_focus&&this.focusable_elem)this.focusable_elem.focus()
this.last_max_value=maxvalue
this.clampScrollPos()
if(this.background_color)ui.drawRect(this.x,this.y,this.x+this.w,this.y+this.h,this.z,this.background_color)
if(disabled&&(auto_hide&&auto_hidden||!this.h)){this.scrollbar_visible=false
return}this.scrollbar_visible=true
scrollbar_top.draw({x:bar_x0,y:this.y,z:this.z+.2,w:bar_w,h:button_h,color:top_color})
scrollbar_bottom.draw({x:bar_x0,y:this.y+this.h-button_h,z:this.z+.2,w:bar_w,h:button_h,color:bottom_color})
var trough_draw_pad=button_h/2
var trough_draw_height=trough_height+2*trough_draw_pad
var trough_v0=-trough_draw_pad/pixel_scale/scrollbar_trough.uidata.total_h
var trough_v1=trough_v0+trough_draw_height/pixel_scale/scrollbar_trough.uidata.total_h
scrollbar_trough.draw({x:bar_x0,y:this.y+trough_draw_pad,z:this.z+.1,w:bar_w,h:trough_draw_height,uvs:[scrollbar_trough.uvs[0],trough_v0,scrollbar_trough.uvs[2],trough_v1],color:trough_color})
ui.drawVBox({x:bar_x0,y:handle_screenpos,z:this.z+.3,w:bar_w,h:handle_pixel_h},scrollbar_handle,handle_color)
var grabber_h=scrollbar_handle_grabber.uidata.total_h*pixel_scale
scrollbar_handle_grabber.draw({x:bar_x0,y:handle_screenpos+(handle_pixel_h-grabber_h)/2,z:this.z+.4,w:bar_w,h:grabber_h,color:handle_color})}
_proto.scrollIntoFocus=function scrollIntoFocus(miny,maxy,h){var old_scroll_pos=this.scroll_pos
var changed=false
if((miny=max(miny,0))<this.scroll_pos){this.scroll_pos=miny
changed=true}if((maxy-=h)>this.scroll_pos){this.scroll_pos=maxy
changed=true}if(changed)this.overscroll=old_scroll_pos-this.scroll_pos}
_proto.scrollToEnd=function scrollToEnd(){this.scroll_pos=this.last_max_value}
_proto.resetScroll=function resetScroll(){this.scroll_pos=0
this.overscroll=0}
return ScrollAreaInternal}()
function scrollAreaCreate(params){return new ScrollAreaInternal(params)}

},{"../common/util.js":74,"../common/verify.js":75,"../common/vmath":76,"./camera2d.js":7,"./engine.js":13,"./input.js":28,"./spot.js":50,"./sprites.js":51,"./ui.js":57,"assert":undefined}],44:[function(require,module,exports){
"use strict"
exports.get=get
exports.pop=pop
exports.push=push
exports.register=register
exports.runTimeDefault=runTimeDefault
exports.set=set
exports.setAsync=setAsync
var modified={}
exports.true=true
var assert=require("assert")
var _require=require("../common/util.js"),titleCase=_require.titleCase
var _require2=require("./cmds.js"),cmd_parse=_require2.cmd_parse
var engine=require("./engine.js")
var change_cbs={}
function get(key){return exports[key]}function set(key,value){if(exports[key]!==value)cmd_parse.handle(null,key+" "+value,null)}function setAsync(key,value){engine.postTick({fn:set.bind(null,key,value)})}function runTimeDefault(key,new_default){assert(!change_cbs[key])
if(!modified[key])exports[key]=new_default}var settings_stack=null
function push(pairs){assert(!settings_stack)
settings_stack={}
for(var key in pairs){settings_stack[key]=exports[key]
exports[key]=pairs[key]
var cb=change_cbs[key]
if(cb)cb(false)}}function pop(){assert(settings_stack)
for(var key in settings_stack){exports[key]=settings_stack[key]
var cb=change_cbs[key]
if(cb)cb(false)}settings_stack=null}function register(defs){Object.keys(defs).forEach(function(key){var def=defs[key]
exports[key]=def.default_value
if(def.on_change)change_cbs[key]=def.on_change
cmd_parse.registerValue(key,{type:def.type,label:def.label||titleCase(key.replace(/_/g," ")),range:def.range,get:function get(){return exports[key]},set:function set(v){modified[key]=true
exports[key]=v},store:false!==def.store,ver:def.ver,help:def.help,usage:def.usage,prefix_usage_with_help:def.prefix_usage_with_help,on_change:def.on_change,access_run:def.access_run,access_show:def.access_show,default_value:def.default_value})})}register({max_fps:{label:"Maximum frame rate (FPS)",prefix_usage_with_help:true,usage:"Display current maximum: /max_fps\nDisable maximum FPS limit: /max_fps 0 (highly recommended)\nSet maximum FPS limit: /max_fps 30\nDefault: /max_fps 0",default_value:0,type:cmd_parse.TYPE_FLOAT,ver:1},render_scale:{label:"Render Scale (3D)",default_value:1,type:cmd_parse.TYPE_FLOAT,range:[.1,1]},render_scale_mode:{label:"Render Scale Mode",default_value:0,type:cmd_parse.TYPE_INT,range:[0,2]},render_scale_all:{label:"Render Scale (All)",default_value:1,type:cmd_parse.TYPE_FLOAT,range:[.3333,4]},render_scale_clear:{label:"Render Scale Full Clear",default_value:1,type:cmd_parse.TYPE_INT,range:[0,1]},fov:{default_value:60,type:cmd_parse.TYPE_FLOAT,range:[1,100]},double_click_time:{default_value:500,type:cmd_parse.TYPE_INT,range:[0,2500]}})

},{"../common/util.js":74,"./cmds.js":9,"./engine.js":13,"assert":undefined}],45:[function(require,module,exports){
"use strict"
exports.shaderDebugUIStartup=shaderDebugUIStartup
var camera2d=require("./camera2d.js")
var _require=require("./cmds.js"),cmd_parse=_require.cmd_parse
var engine=require("./engine.js")
var _require2=require("./fetch.js"),fetch=_require2.fetch
var glov_font=require("./font.js")
var input=require("./input.js")
var min=Math.min
var _require3=require("./scroll_area.js"),scrollAreaCreate=_require3.scrollAreaCreate
var _require4=require("./shaders.js"),shadersGetDebug=_require4.shadersGetDebug
var settings=require("./settings.js")
var ui=require("./ui.js")
var _require5=require("../common/util.js"),errorString=_require5.errorString
var _require6=require("../common/vmath.js"),vec4=_require6.vec4
Z.SHADER_DEBUG=Z.SHADER_DEBUG||900
var SHADER_STATS_SERVER="http://localhost:3000/api/shaderstats"
var shader_stats_cache={}
function getShaderStats(text,stage,peek){if(shader_stats_cache[text])return shader_stats_cache[text].data
if(peek)return null
var cache=shader_stats_cache[text]={data:null}
fetch({url:SHADER_STATS_SERVER+"?stage="+stage+"&text="+encodeURIComponent(text),response_type:"json"},function(err,obj){if(err)cache.data={err:"Fetch error: "+errorString(err)}
else cache.data=obj})
return cache.data}var PAD=4
var style_title=glov_font.styleColored(null,2156986367)
var style=glov_font.styleColored(null,572662527)
var style_error=glov_font.styleColored(null,3710001919)
var color_line=vec4(.4,.4,.4,1)
var color_panel=vec4(1,1,1,1)
var color_invalid=vec4(.8,0,0,1)
var color_selected=vec4(.4,.6,1,1)
var scroll_area
var scroll_area_source
var selected_shader
function shaderDebugUITick(){var PANEL_PAD=ui.tooltip_pad
var x0=camera2d.x0()+PANEL_PAD
var y0=camera2d.y0()+PANEL_PAD
var z=Z.SHADER_DEBUG
var font=ui.font,title_font=ui.title_font,font_height=ui.font_height
var w=20*font_height
var x=x0
var y=y0
var shaders=shadersGetDebug()
title_font.drawSizedAligned(style_title,x,y,z,font_height,font.ALIGN.HCENTERFIT,w,0,"Shaders ("+shaders.length+")")
if(!scroll_area){scroll_area=scrollAreaCreate({z:z,background_color:null,auto_hide:true})
scroll_area_source=scrollAreaCreate({z:z,background_color:null,auto_hide:true})}var sub_w=w-PAD-scroll_area.barWidth()
var score_w=.3*sub_w
var subscore_w=score_w/2
var button_w=sub_w-score_w-PAD
font.draw({x:x+button_w+PAD,y:y+.5*ui.font_height,z:z,w:subscore_w-1,color:1077952767,size:.5*ui.font_height,text:"Ops",align:font.ALIGN.HCENTERFIT})
font.draw({x:x+button_w+PAD+subscore_w+1,y:y+.5*ui.font_height,z:z,w:subscore_w-1,color:1077952767,size:.5*ui.font_height,text:"Bytes",align:font.ALIGN.HCENTERFIT})
y+=font_height+1
ui.drawLine(x0+.3*w,y,x0+.7*w,y,z,.5,true,color_line)
y+=PAD
var max_h=camera2d.y1()-PAD-y
var scroll_y_start=y
scroll_area.begin({x:x,y:y,w:w,h:max_h})
y=x=0
z=Z.UI
for(var ii=0;ii<shaders.length;++ii){var _shader=shaders[ii]
var filename=_shader.filename.replace("shaders/","")
if(_shader.defines_arr.length)filename+="("+_shader.defines_arr.join(",")+")"
if(ui.buttonText({text:filename,x:x,y:y,z:z,w:button_w,h:font_height,color:selected_shader===_shader?color_selected:_shader.valid?void 0:color_invalid,align:glov_font.ALIGN.HFIT}))if(selected_shader===_shader)selected_shader=void 0
else selected_shader=_shader
var _stats=getShaderStats(_shader.shader_source_text,_shader.type===gl.FRAGMENT_SHADER?"frag":"vert",false)
if(!_stats||_stats.err)font.draw({x:x+button_w+PAD,y:y,z:z,w:score_w,color:null!=_stats&&_stats.err?2147483903:2155905279,text:null!=_stats&&_stats.err?"ERR":"...",align:font.ALIGN.HCENTERFIT})
else{var _stats$spirv
var color=255
font.draw({x:x+button_w+PAD,y:y,z:z,w:subscore_w-1,color:color,text:""+(null==(_stats$spirv=_stats.spirv)?void 0:_stats$spirv.count_total),align:font.ALIGN.HCENTERFIT})
font.draw({x:x+button_w+PAD+subscore_w+1,y:y,z:z,w:subscore_w-1,color:color,text:_stats.bin_size.toLocaleString(),align:font.ALIGN.HCENTERFIT})}y+=font_height}scroll_area.end(y)
y=scroll_y_start+min(max_h,y)
z=Z.SHADER_DEBUG
var close_button_size=ui.font_height
if(ui.buttonText({x:x0+w-close_button_size,y:y0,z:z+1,w:close_button_size,h:close_button_size,text:"X"}))settings.set("shader_debug",0)
ui.panel({x:x0-PANEL_PAD,y:y0-PANEL_PAD,z:z-1,w:w+2*PANEL_PAD,h:y-y0+2*PANEL_PAD,color:color_panel})
if(!selected_shader)return
var shader=selected_shader
x0+=w+2*PANEL_PAD
w=camera2d.x1()-PAD-x0
x=x0
y=y0
font.draw({x:x,y:y,z:z,w:w,style:style,text:shader.filename,align:font.ALIGN.HCENTERFIT})
y+=font_height+1
ui.drawLine(x0+.3*w,y,x0+.7*w,y,z,.5,true,color_line)
scroll_y_start=y+=PAD
scroll_area_source.begin({x:x,y:y,w:w,h:max_h})
sub_w=w-PAD-scroll_area_source.barWidth()
y=x=0
z=Z.UI
if(shader.error_text)y+=font.draw({x:x,y:y,z:z,w:sub_w,color:2147483903,style:style,text:shader.error_text,align:font.ALIGN.HWRAP})
function flatten(obj,path){for(var key in obj){if("text"===key||"spirv_raw"===key)continue
var value=obj[key]
var subpath=path?path+"."+key:key
if("object"===typeof value)flatten(value,subpath)
else{font.draw({x:x,y:y,z:z,w:sub_w,style:style,text:subpath+": "+value,align:font.ALIGN.HFIT})
y+=ui.font_height}}}var stats=getShaderStats(shader.shader_source_text,shader.type===gl.FRAGMENT_SHADER?"frag":"vert")
if(!stats)y+=font.draw({x:x,y:y,z:z,w:w,style:style,text:"Loading shader stats...",align:font.ALIGN.HWRAP})
else if(stats.err)y+=font.draw({x:x,y:y,z:z,w:sub_w,style:style_error,text:String(stats.err),align:font.ALIGN.HWRAP})
else flatten(stats)
var source_height=.5*ui.font_height
if(null!=stats&&stats.text){y+=PAD
ui.drawLine(x+.3*w,y,x+.7*w,y,z,.5,true,color_line)
y+=PAD/2
font.draw({x:x,y:y,z:z,w:w,style:style,text:"Analyzed Shader Source",align:font.ALIGN.HCENTERFIT})
y+=font_height+1
var _h=font.draw({x:x,y:y,z:z,w:w,size:source_height,style:style,text:stats.text,align:font.ALIGN.HWRAP})
if(input.click({x:x,y:y,w:w,h:_h}))ui.provideUserString("Analyzed shader source",stats.text)
y+=_h}if(null!=stats&&stats.spirv_raw){y+=PAD
ui.drawLine(x+.3*w,y,x+.7*w,y,z,.5,true,color_line)
y+=PAD/2
font.draw({x:x,y:y,z:z,w:w,style:style,text:"SPIR-V Disassembly",align:font.ALIGN.HCENTERFIT})
y+=font_height+1
var _h2=font.draw({x:x,y:y,z:z,w:w,size:source_height,style:style,text:stats.spirv_raw,align:font.ALIGN.HWRAP})
if(input.click({x:x,y:y,w:w,h:_h2}))ui.provideUserString("SPIR-V Disassembly",stats.spirv_raw)
y+=_h2}y+=PAD
ui.drawLine(x+.3*w,y,x+.7*w,y,z,.5,true,color_line)
y+=PAD/2
font.draw({x:x,y:y,z:z,w:w,style:style,text:"Actual WebGL Shader Source",align:font.ALIGN.HCENTERFIT})
y+=font_height+1
var h=font.draw({x:x,y:y,z:z,w:w,size:source_height,style:style,text:shader.shader_source_text,align:font.ALIGN.HWRAP})
if(input.click({x:x,y:y,w:w,h:h}))ui.provideUserString("Used WebGL shader source",shader.shader_source_text)
y+=h
scroll_area_source.end(y)
y=scroll_y_start+min(max_h,y)
z=Z.SHADER_DEBUG
ui.panel({x:x0-PANEL_PAD,y:y0-PANEL_PAD,z:z-1,w:w+2*PANEL_PAD,h:y-y0+2*PANEL_PAD,color:color_panel})}function shaderDebugUIStartup(){settings.register({shader_debug:{label:"Shader Debug",default_value:0,type:cmd_parse.TYPE_INT,range:[0,1],access_show:["sysadmin"],on_change:function on_change(){engine.removeTickFunc(shaderDebugUITick)
if(settings.shader_debug)engine.addTickFunc(shaderDebugUITick)}}})}

},{"../common/util.js":74,"../common/vmath.js":76,"./camera2d.js":7,"./cmds.js":9,"./engine.js":13,"./fetch.js":17,"./font.js":19,"./input.js":28,"./scroll_area.js":43,"./settings.js":44,"./shaders.js":46,"./ui.js":57}],46:[function(require,module,exports){
"use strict"
exports.MAX_SEMANTIC=void 0
exports.addGlobal=addGlobal
exports.addReservedDefine=addReservedDefine
exports.bind=bind
exports.create=create
exports.globals=void 0
exports.handleDefinesChanged=handleDefinesChanged
exports.prelink=prelink
exports.semantic=void 0
exports.setGLErrorReportDetails=setGLErrorReportDetails
exports.setInternalDefines=setInternalDefines
exports.shadersGetDebug=shadersGetDebug
exports.shadersRequirePrelink=shadersRequirePrelink
exports.shadersResetState=shadersResetState
exports.startup=startup
var MAX_SEMANTIC=5
exports.MAX_SEMANTIC=MAX_SEMANTIC
var assert=require("assert")
var engine=require("./engine.js")
var _require=require("./error_report.js"),errorReportClear=_require.errorReportClear,errorReportSetDetails=_require.errorReportSetDetails,glovErrorReport=_require.glovErrorReport
var _require2=require("./filewatch.js"),filewatchOn=_require2.filewatchOn
var _require3=require("../common/util.js"),matchAll=_require3.matchAll,nop=_require3.nop
var _require4=require("./textures.js"),texturesUnloadDynamic=_require4.texturesUnloadDynamic
var _require5=require("./webfs.js"),webFSGetFile=_require5.webFSGetFile
var last_id=0
var bound_prog=null
var semantic={ATTR0:0,POSITION:0,ATTR1:1,COLOR:1,COLOR_0:1,ATTR2:2,TEXCOORD:2,TEXCOORD_0:2,ATTR3:3,NORMAL:3,ATTR4:4,TEXCOORD_1:4}
exports.semantic=semantic
var globals
exports.globals=globals
var globals_used
var global_defines
var error_fp
var error_fp_webgl2
var error_vp
var shaders=[]
var vp_attr_regex=/attribute [^ ]+ ([^ ;]+);/g
var uniform_regex=/uniform (?:(?:low|medium|high)p )?((?:(?:vec|mat)\d(?:x\d)?|float) [^ ;]+);/g
var sampler_regex=/uniform sampler(?:2D|Cube) ([^ ;]+);/g
var include_regex=/\n#include "([^"]+)"/g
var type_size={float:1,vec2:2,vec3:3,vec4:4,mat3:9,mat4:16}
function loadInclude(filename){return'\n// from include "'+filename+'":\n'+webFSGetFile(filename,"text")+"\n"}function shadersResetState(){for(var ii=0;ii<shaders.length;++ii){var shader=shaders[ii]
if(shader.programs)for(var fpid in shader.programs){var prog=shader.programs[fpid]
for(var jj=0;jj<prog.uniforms.length;++jj){var unif=prog.uniforms[jj]
for(var kk=0;kk<unif.size;++kk)unif.value[kk]=NaN}}}bound_prog=null
gl.useProgram(null)}function setGLErrorReportDetails(){var details={max_fragment_uniform_vectors:gl.getParameter(gl.MAX_FRAGMENT_UNIFORM_VECTORS),max_varying_vectors:gl.getParameter(gl.MAX_VARYING_VECTORS),max_vertex_attribs:gl.getParameter(gl.MAX_VERTEX_ATTRIBS),max_vertex_uniform_vectors:gl.getParameter(gl.MAX_VERTEX_UNIFORM_VECTORS),vendor:gl.getParameter(gl.VENDOR),renderer:gl.getParameter(gl.RENDERER),webgl:engine.webgl2?2:1}
var debug_info=gl.getExtension("WEBGL_debug_renderer_info")
if(debug_info){details.renderer_unmasked=gl.getParameter(debug_info.UNMASKED_RENDERER_WEBGL)
details.vendor_unmasked=gl.getParameter(debug_info.UNMASKED_VENDOR_WEBGL)}for(var key in details)errorReportSetDetails(key,details[key])}var report_queued=false
var shader_errors
var shader_errors_any_fatal
var reported_shader_errors=false
function reportShaderError(non_fatal,err){function doReport(){report_queued=false
setGLErrorReportDetails()
var msg="Shader error(s):\n    "+shader_errors.join("\n    ")
reported_shader_errors=true
if(!shader_errors_any_fatal)glovErrorReport(false,msg,"shaders.js")
else assert(false,msg)
shader_errors=null}if(!report_queued){setTimeout(doReport,1e3)
report_queued=true
shader_errors=[]
shader_errors_any_fatal=false}shader_errors_any_fatal=shader_errors_any_fatal||!non_fatal
shader_errors.push(err)}function parseIncludes(parent_name,text){var supplied_uniforms={}
text.replace(uniform_regex,function(str,key){supplied_uniforms[key]=true})
return text=text.replace(include_regex,function(str,filename){var include_path=parent_name.split("/")
include_path.pop()
include_path.push(filename)
var replacement=loadInclude(include_path=include_path.join("/"))
if(!replacement){console.error("Could not evaluate "+str)
return str}return replacement=replacement.replace(uniform_regex,function(str2,key){if(supplied_uniforms[key])return"// [removed "+key+"]"
supplied_uniforms[key]=true
return str2})})}var webgl2_header=["#version 300 es","#define WEBGL2"].join("\n")
var webgl2_header_fp=[webgl2_header,"#define varying in","out lowp vec4 fragColor;","#define gl_FragColor fragColor","#define texture2D texture","#define textureCube texture",""].join("\n")
var webgl2_header_vp=[webgl2_header,"#define varying out","#define attribute in",""].join("\n")
function Shader(params){var filename=params.filename,defines=params.defines,non_fatal=params.non_fatal
assert.equal(typeof filename,"string")
var type=filename.endsWith(".fp")?gl.FRAGMENT_SHADER:filename.endsWith(".vp")?gl.VERTEX_SHADER:0
assert(type)
this.type=type
this.filename=filename
this.non_fatal=non_fatal
this.defines_arr=defines||[]
this.defines=this.defines_arr.map(function(a){return"#define "+a+"\n"}).join("")
this.shader=gl.createShader(type)
this.id=++last_id
if(type===gl.VERTEX_SHADER)this.programs={}
shaders.push(this)
this.compile()}function shadersGetDebug(){return shaders}function cleanShaderError(error_text){if(error_text)error_text=error_text.replace(/\0/g,"").trim()
return error_text}Shader.prototype.compile=function(){var type=this.type,filename=this.filename
var header=""
var text=webFSGetFile(filename,"text")
if(engine.webgl2&&text.includes("#pragma WebGL2"))header=type===gl.VERTEX_SHADER?webgl2_header_vp:webgl2_header_fp
text=(text=parseIncludes(filename,text=""+header+global_defines+this.defines+text)).replace(/#pragma WebGL2?/g,"")
if(type===gl.VERTEX_SHADER){this.attributes=matchAll(text,vp_attr_regex)
this.attributes.forEach(function(v){return assert(void 0!==semantic[v])})}else{this.samplers=matchAll(text,sampler_regex)
var found=[]
this.samplers.forEach(function(v){var num=Number(v.slice(-1))
assert(!isNaN(num))
assert(!found[num])
found[num]=true})}this.uniforms=matchAll(text,uniform_regex)
this.uniforms.forEach(function(v){var type_name=v.split(" ")[0]
assert(type_size[type_name])})
this.shader_source_text=text
gl.shaderSource(this.shader,text)
gl.compileShader(this.shader)
if(!gl.getShaderParameter(this.shader,gl.COMPILE_STATUS)){this.valid=false
var error_text=this.error_text=cleanShaderError(gl.getShaderInfoLog(this.shader))
if(this.defines_arr.length)filename+="("+this.defines_arr.join(",")+")"
console[this.non_fatal?"warn":"error"]("Error compiling "+filename+": "+error_text)
reportShaderError(this.non_fatal,filename+": "+error_text)
console.log(text.split("\n").map(function(line,idx){return idx+1+": "+line}).join("\n"))}else{this.valid=true
if(this.error_text)delete this.error_text}}
function create(filename){if("object"===typeof filename)return new Shader(filename)
return new Shader({filename:filename})}function uniformSetValue(unif){switch(unif.width){case 1:gl.uniform1fv(unif.location,unif.value)
break
case 2:gl.uniform2fv(unif.location,unif.value)
break
case 3:gl.uniform3fv(unif.location,unif.value)
break
case 4:gl.uniform4fv(unif.location,unif.value)
break
case 9:gl.uniformMatrix3fv(unif.location,false,unif.value)
break
case 16:gl.uniformMatrix4fv(unif.location,false,unif.value)}}var require_prelink=false
function shadersRequirePrelink(ensure){var old=require_prelink
require_prelink=ensure
return old}function link(vp,fp,on_error){assert(!require_prelink)
var prog=vp.programs[fp.id]={handle:gl.createProgram(),uniforms:null}
if(!prog.handle)assert(false,"gl.createProgram() returned "+prog.handle+(gl.createProgram()?", retry would succeed":""))
gl.attachShader(prog.handle,vp.shader)
gl.attachShader(prog.handle,fp.shader)
for(var ii=0;ii<vp.attributes.length;++ii)gl.bindAttribLocation(prog.handle,semantic[vp.attributes[ii]],vp.attributes[ii])
gl.linkProgram(prog.handle)
prog.valid=gl.getProgramParameter(prog.handle,gl.LINK_STATUS)
if(!prog.valid){var error_text=cleanShaderError(gl.getProgramInfoLog(prog.handle))
console.error("Shader link error: "+error_text)
if(on_error&&(!engine.DEBUG||on_error===nop))on_error(error_text)
else reportShaderError(false,"Shader link error ("+vp.filename+" & "+fp.filename+"): "+error_text)
prog.uniforms=[]
return prog}gl.useProgram(prog.handle)
bound_prog=prog
var uniforms=vp.uniforms.slice(0)
for(var _ii=0;_ii<fp.uniforms.length;++_ii){var name=fp.uniforms[_ii]
if(-1===uniforms.indexOf(name))uniforms.push(name)}prog.uniforms=uniforms.map(function(v){var type=(v=v.split(" "))[0]
var name=v[1]
var count=1
var m=name.match(/([^[]+)\[(\d+)\]/)
if(m){name=m[1]
count=Number(m[2])}var location=gl.getUniformLocation(prog.handle,name)
if(null===location)return null
var width=type_size[type]
var size=width*count
var glob=globals[name]
globals_used[name]=true
var unif={name:name,size:size,width:width,count:count,value:new Float32Array(size),location:location,glob:glob}
uniformSetValue(unif)
return unif}).filter(function(v){return v})
for(var _ii2=0;_ii2<fp.samplers.length;++_ii2){var _name=fp.samplers[_ii2]
var num=Number(_name.slice(-1))
var location=gl.getUniformLocation(prog.handle,_name)
if(null!==location)gl.uniform1i(location,num)}return prog}function autoLink(vp,fp,on_error){var prog=vp.programs[fp.id]
if(!prog)prog=link(vp,fp,on_error)
if(!prog.valid){if(!(prog=link(vp,error_fp,nop)).valid&&error_fp_webgl2)prog=link(vp,error_fp_webgl2,nop)
if(!prog.valid)prog=link(error_vp,error_fp,nop)
vp.programs[fp.id]=prog}return prog}function bind(vp,fp,params){var prog=vp.programs[fp.id]
if(!prog)prog=autoLink(vp,fp)
if(prog!==bound_prog){bound_prog=prog
gl.useProgram(prog.handle)}for(var ii=0;ii<prog.uniforms.length;++ii){var unif=prog.uniforms[ii]
var value=params[unif.name]||unif.glob
if(!value)continue
var diff=false
for(var jj=0;jj<unif.size;++jj)if(value[jj]!==unif.value[jj]){diff=true
break}if(diff){for(var _jj=0;_jj<unif.size;++_jj)unif.value[_jj]=value[_jj]
uniformSetValue(unif)}}}function prelink(vp,fp,params,on_error){if(void 0===params)params={}
var prog=autoLink(vp,fp,on_error)
if(prog.valid)bind(vp,fp,params)
return prog.valid}var reserved={WEBGL2:1}
function addReservedDefine(key){reserved[key]=1}var internal_defines={}
function applyDefines(){global_defines=Object.keys(engine.defines).filter(function(v){return!reserved[v]}).concat(Object.keys(internal_defines)).map(function(v){return"#define "+v+"\n"}).join("")}function shaderReload(){shadersRequirePrelink(false)
if(shaders.length){if(reported_shader_errors){errorReportClear()
reported_shader_errors=false}gl.useProgram(null)
for(var ii=0;ii<shaders.length;++ii){var programs=shaders[ii].programs
if(programs){for(var id in programs)gl.deleteProgram(programs[id].handle)
shaders[ii].programs={}}}for(var _ii3=0;_ii3<shaders.length;++_ii3)shaders[_ii3].compile()
texturesUnloadDynamic()}}function handleDefinesChanged(){applyDefines()
shaderReload()}function setInternalDefines(new_values){for(var key in new_values)if(new_values[key])internal_defines[key]=new_values[key]
else delete internal_defines[key]
handleDefinesChanged()}function onShaderChange(filename){shaderReload()}function startup(_globals){applyDefines()
exports.globals=globals=_globals
globals_used={}
error_fp=create("shaders/error.fp")
if(engine.webgl2)error_fp_webgl2=create("shaders/error_gl2.fp")
error_vp=create("shaders/error.vp")
filewatchOn(".fp",onShaderChange)
filewatchOn(".vp",onShaderChange)}function addGlobal(key,vec){assert(!globals[key])
assert(!globals_used[key])
globals[key]=vec
for(var ii=0;ii<vec.length;++ii)assert(isFinite(vec[ii]))}

},{"../common/util.js":74,"./engine.js":13,"./error_report.js":15,"./filewatch.js":18,"./textures.js":55,"./webfs.js":60,"assert":undefined}],47:[function(require,module,exports){
"use strict"
exports.slider=slider
exports.sliderIsDragging=sliderIsDragging
exports.sliderIsFocused=sliderIsFocused
exports.sliderSetDefaultShrink=sliderSetDefaultShrink
var _custom_nav
function _extends(){return(_extends=Object.assign?Object.assign.bind():function(target){for(var i=1;i<arguments.length;i++){var source=arguments[i]
for(var key in source)if(Object.prototype.hasOwnProperty.call(source,key))target[key]=source[key]}return target}).apply(this,arguments)}var _assert=require("assert")
var assert=_assert
var round=Math.round,max=Math.max
var _glovCommonUtilJs=require("../common/util.js")
var clamp=_glovCommonUtilJs.clamp
var _glovCommonVmathJs=require("../common/vmath.js")
var vec4=_glovCommonVmathJs.vec4
var _inputJs=require("./input.js")
var input=_inputJs
var _spotJs=require("./spot.js")
var SPOT_DEFAULT_BUTTON=_spotJs.SPOT_DEFAULT_BUTTON
var SPOT_NAV_LEFT=_spotJs.SPOT_NAV_LEFT
var SPOT_NAV_RIGHT=_spotJs.SPOT_NAV_RIGHT
var spot=_spotJs.spot
var _uiJs=require("./ui.js")
var Z_MIN_INC=_uiJs.Z_MIN_INC
var drawHBox=_uiJs.drawHBox
var playUISound=_uiJs.playUISound
var _uiJs2=require("./ui.js")
var ui=_uiJs2
var SPOT_DEFAULT_SLIDER=_extends({},SPOT_DEFAULT_BUTTON,{sound_button:null,custom_nav:((_custom_nav={})[SPOT_NAV_RIGHT]=null,_custom_nav[SPOT_NAV_LEFT]=null,_custom_nav)})
var slider_default_vshrink=1
var slider_default_handle_shrink=1
var slider_default_inset=0
function sliderSetDefaultShrink(vshrink,handle_shrink,slider_inset){slider_default_vshrink=vshrink
slider_default_handle_shrink=handle_shrink
slider_default_inset=slider_inset||0}var color_slider_handle=vec4(1,1,1,1)
var color_slider_handle_grab=vec4(.5,.5,.5,1)
var color_slider_handle_over=vec4(.75,.75,.75,1)
var slider_dragging=false
var slider_focused=false
function sliderIsDragging(){return slider_dragging}function sliderIsFocused(){return slider_focused}function slider(value,param){assert("number"===typeof param.x)
assert("number"===typeof param.y)
assert(param.min<param.max)
param.z=param.z||Z.UI
param.w=param.w||ui.button_width
param.h=param.h||ui.button_height
param.max_dist=param.max_dist||Infinity
var vshrink=param.vshrink||slider_default_vshrink
var handle_shrink=param.handle_shrink||slider_default_handle_shrink
var disabled=param.disabled||false
var handle_h=param.h*handle_shrink
var handle_w=ui.sprites.slider_handle.uidata.wh[0]*handle_h
var pad_focusable=param.pad_focusable
slider_dragging=false
var shrinkdiff=handle_shrink-vshrink+slider_default_inset
drawHBox({x:param.x+param.h*shrinkdiff/2,y:param.y+param.h*(1-vshrink)/2,z:param.z,w:param.w-param.h*shrinkdiff,h:param.h*vshrink},ui.sprites.slider,param.color)
var xoffs=round(max(ui.sprites.slider.uidata.wh[0]*param.h*vshrink,handle_w)/2)
var draggable_width=param.w-2*xoffs
var drag=!disabled&&input.drag(param)
var grabbed=Boolean(drag)
param.def=SPOT_DEFAULT_SLIDER
if(grabbed)param.focus_steal=true
param.pad_focusable=pad_focusable
var spot_ret=spot(param)
slider_focused=spot_ret.focused
if(spot_ret.ret&&spot_ret.pos){grabbed=false
value=(spot_ret.pos[0]-(param.x+xoffs))/draggable_width
value=param.min+(param.max-param.min)*clamp(value,0,1)
playUISound("button_click")}else if(grabbed){value=(drag.cur_pos[0]-(param.x+xoffs))/draggable_width
value=param.min+(param.max-param.min)*clamp(value,0,1)
input.mouseOver()
slider_focused=slider_dragging=true}if(spot_ret.nav){playUISound("button_click")
var step=param.step||(param.max-param.min)/16
if(spot_ret.nav===SPOT_NAV_RIGHT)value=clamp(value+step,param.min,param.max)
else if(spot_ret.nav===SPOT_NAV_LEFT)value=clamp(value-step,param.min,param.max)}var handle_x=param.x+xoffs+draggable_width*(value-param.min)/(param.max-param.min)-handle_w/2
var handle_y=param.y+param.h/2-handle_h/2
var handle_color=color_slider_handle
if(grabbed)handle_color=color_slider_handle_grab
else if(spot_ret.focused)handle_color=color_slider_handle_over
ui.sprites.slider_handle.draw({x:handle_x,y:handle_y,z:param.z+Z_MIN_INC,w:handle_w,h:handle_h,color:handle_color,frame:0})
return value}

},{"../common/util.js":74,"../common/vmath.js":76,"./input.js":28,"./spot.js":50,"./ui.js":57,"assert":undefined}],48:[function(require,module,exports){
"use strict"
exports.friendAdd=friendAdd
exports.friendBlock=friendBlock
exports.friendIsBlocked=friendIsBlocked
exports.friendRemove=friendRemove
exports.friendUnblock=friendUnblock
exports.friendsGet=friendsGet
exports.getExternalCurrentUserInfos=getExternalCurrentUserInfos
exports.getExternalFriendInfos=getExternalFriendInfos
exports.getExternalUserInfos=getExternalUserInfos
exports.getUserProfileImage=getUserProfileImage
exports.isFriend=isFriend
exports.registerExternalUserInfoProvider=registerExternalUserInfoProvider
exports.richPresenceSet=richPresenceSet
exports.setDefaultUserProfileImage=setDefaultUserProfileImage
exports.socialInit=socialInit
var assert=require("assert")
var _glovClientClient_config=require("./client_config")
var PLATFORM_FBINSTANT=_glovClientClient_config.PLATFORM_FBINSTANT
var _glovCommonEnums=require("../common/enums")
var ID_PROVIDER_FB_GAMING=_glovCommonEnums.ID_PROVIDER_FB_GAMING
var ID_PROVIDER_FB_INSTANT=_glovCommonEnums.ID_PROVIDER_FB_INSTANT
var PRESENCE_ACTIVE=_glovCommonEnums.PRESENCE_ACTIVE
var PRESENCE_INACTIVE=_glovCommonEnums.PRESENCE_INACTIVE
var PRESENCE_OFFLINE=_glovCommonEnums.PRESENCE_OFFLINE
var _glovCommonFriends_data=require("../common/friends_data")
var FriendStatus=_glovCommonFriends_data.FriendStatus
var _glovCommonUtil=require("../common/util")
var deepEqual=_glovCommonUtil.deepEqual
var _cmds=require("./cmds")
var cmd_parse=_cmds.cmd_parse
var _input=require("./input")
var input=_input
var _net=require("./net")
var netDisconnected=_net.netDisconnected
var netSubs=_net.netSubs
var _sprites=require("./sprites")
var spriteCreate=_sprites.spriteCreate
var _textures=require("./textures")
var textures=_textures
var IDLE_TIME=6e4
var friend_list=null
function friendsGet(){return null!=friend_list?friend_list:Object.create(null)}function isFriend(user_id){var value=null==friend_list?void 0:friend_list[user_id]
return(null==value?void 0:value.status)===FriendStatus.Added||(null==value?void 0:value.status)===FriendStatus.AddedAuto}function friendIsBlocked(user_id){var value=null==friend_list?void 0:friend_list[user_id]
return(null==value?void 0:value.status)===FriendStatus.Blocked}function makeFriendCmdRequest(cmd,user_id,cb){user_id=user_id.toLowerCase()
var requesting_user_id=netSubs().loggedIn()
if(netDisconnected())return void cb("ERR_DISCONNECTED")
if(!requesting_user_id)return void cb("ERR_NOT_LOGGED_IN")
netSubs().getMyUserChannel().cmdParse(cmd+" "+user_id,function(err,resp){if(err)return void cb(err)
else if(requesting_user_id!==netSubs().loggedIn()||!friend_list)return void cb("Invalid data")
if(resp.friend)friend_list[user_id]=resp.friend
else delete friend_list[user_id]
cb(null,resp.msg)})}function friendAdd(user_id,cb){makeFriendCmdRequest("friend_add",user_id,cb)}function friendRemove(user_id,cb){makeFriendCmdRequest("friend_remove",user_id,cb)}function friendBlock(user_id,cb){makeFriendCmdRequest("friend_block",user_id,cb)}function friendUnblock(user_id,cb){makeFriendCmdRequest("friend_unblock",user_id,cb)}cmd_parse.register({cmd:"friend_add",help:"Add a friend",func:friendAdd})
cmd_parse.register({cmd:"friend_remove",help:"Remove a friend",func:friendRemove})
cmd_parse.register({cmd:"friend_block",help:"Block someone from seeing your rich presence, also removes from your friends list",func:friendBlock})
cmd_parse.register({cmd:"friend_unblock",help:"Reset a user to allow seeing your rich presence again",func:friendUnblock})
cmd_parse.register({cmd:"friend_list",help:"List all friends",func:function func(str,resp_func){if(!friend_list)return void resp_func("Friends list not loaded")
resp_func(null,Object.keys(friend_list).filter(isFriend).join(",")||"You have no friends")}})
cmd_parse.register({cmd:"friend_block_list",help:"List all blocked users",func:function func(str,resp_func){if(!friend_list)return void resp_func("Friends list not loaded")
resp_func(null,Object.keys(friend_list).filter(friendIsBlocked).join(",")||"You have no blocked users")}})
var invisible=0
cmd_parse.registerValue("invisible",{type:cmd_parse.TYPE_INT,help:"Hide rich presence information from other users",label:"Invisible",range:[0,1],get:function get(){return invisible},set:function set(v){return invisible=v}})
var afk=0
cmd_parse.registerValue("afk",{type:cmd_parse.TYPE_INT,help:"Appear as idle to other users",label:"AFK",range:[0,1],get:function get(){return afk},set:function set(v){return afk=v}})
function onPresence(data){this.presence_data=data}var last_presence=null
var send_queued=false
function richPresenceSend(){if(!netSubs().loggedIn()||!last_presence||send_queued)return
send_queued=true
netSubs().onceConnected(function(){send_queued=false
if(!netSubs().loggedIn()||!last_presence)return
var pak=netSubs().getMyUserChannel().pak("presence_set")
pak.writeInt(last_presence.active)
pak.writeAnsiString(last_presence.state)
pak.writeJSON(last_presence.payload)
pak.send()})}function richPresenceSet(active,state,payload){active=!active||afk||Date.now()-input.inputLastTime()>IDLE_TIME?PRESENCE_INACTIVE:PRESENCE_ACTIVE
if(invisible)active=PRESENCE_OFFLINE
payload=payload||null
if(!last_presence||active!==last_presence.active||state!==last_presence.state||!deepEqual(last_presence.payload,payload)){last_presence={active:active,state:state,payload:payload}
richPresenceSend()}}var external_current_users=Object.create(null)
var external_friends=Object.create(null)
function getExternalCurrentUserInfos(){return external_current_users}function getExternalFriendInfos(user_id){return external_friends[user_id]}function getExternalUserInfos(user_id){if(user_id===netSubs().loggedIn())return getExternalCurrentUserInfos()
else return getExternalFriendInfos(user_id)}function setExternalCurrentUser(provider,user_info){if(user_info)external_current_users[provider]=user_info
else delete external_current_users[provider]}function updateExternalFriendsOnServer(provider,to_add,to_remove){if(0===to_add.length&&0===to_remove.length||netDisconnected())return
var requesting_user_id=netSubs().loggedIn()
var pak=netSubs().getMyUserChannel().pak("friend_auto_update")
pak.writeAnsiString(provider)
for(var ii=0;ii<to_add.length;++ii)pak.writeAnsiString(to_add[ii].external_id)
pak.writeAnsiString("")
for(var _ii=0;_ii<to_remove.length;++_ii)pak.writeAnsiString(to_remove[_ii])
pak.writeAnsiString("")
pak.send(function(err,resp){if(requesting_user_id!==netSubs().loggedIn()||!friend_list)return
else if(err)return
else if(!resp)return
var friends_external_to_user_ids=Object.create(null)
for(var user_id in resp){var friend=friend_list[user_id]=resp[user_id]
if(friend.ids){var external_id=friend.ids[provider]
friends_external_to_user_ids[external_id]=user_id}}to_add.forEach(function(provider_friend){var external_id=provider_friend.external_id
var user_id=friends_external_to_user_ids[external_id]
if(user_id){var external_friend_infos=external_friends[user_id]
if(!external_friend_infos)external_friend_infos=external_friends[user_id]=Object.create(null)
external_friend_infos[provider]=provider_friend}})})}function setExternalFriends(provider,provider_friends){var friends_external_to_user_ids=Object.create(null)
for(var user_id in friend_list){var _friend$ids
var external_id=null==(_friend$ids=friend_list[user_id].ids)?void 0:_friend$ids[provider]
if(external_id)friends_external_to_user_ids[external_id]=user_id}for(var _user_id in external_friends)delete external_friends[_user_id][provider]
var to_add=[]
provider_friends.forEach(function(provider_friend){var external_id=provider_friend.external_id
var user_id=friends_external_to_user_ids[external_id]
if(user_id){var external_friend_infos=external_friends[user_id]
if(!external_friend_infos)external_friend_infos=external_friends[user_id]=Object.create(null)
external_friend_infos[provider]=provider_friend
delete friends_external_to_user_ids[external_id]}else to_add.push(provider_friend)})
var to_remove=[]
for(var _external_id in friends_external_to_user_ids)to_remove.push(_external_id)
if(0!==to_add.length||0!==to_remove.length)updateExternalFriendsOnServer(provider,to_add,to_remove)}function requestExternalCurrentUser(provider,request_func){var requesting_user_id=netSubs().loggedIn()
request_func(function(err,user_info){if(requesting_user_id!==netSubs().loggedIn())return
else if(err||!user_info)return
setExternalCurrentUser(provider,user_info)})}function requestExternalFriends(provider,request_func){var requesting_user_id=netSubs().loggedIn()
request_func(function(err,friends){if(requesting_user_id!==netSubs().loggedIn()||!friend_list)return
else if(err||!friends)return
setExternalFriends(provider,friends)})}var profile_images={}
var default_profile_image
function getUserProfileImage(user_id){var image=profile_images[user_id]
if(image)return image
var url=null
if(PLATFORM_FBINSTANT){var _getExternalUserInfos,_getExternalUserInfos2
url=null==(_getExternalUserInfos=getExternalUserInfos(user_id))?void 0:null==(_getExternalUserInfos2=_getExternalUserInfos[ID_PROVIDER_FB_INSTANT])?void 0:_getExternalUserInfos2.profile_picture_url}else{var _getExternalUserInfos3,_getExternalUserInfos4
url=null==(_getExternalUserInfos3=getExternalUserInfos(user_id))?void 0:null==(_getExternalUserInfos4=_getExternalUserInfos3[ID_PROVIDER_FB_GAMING])?void 0:_getExternalUserInfos4.profile_picture_url}if(url){var tex=textures.load({url:url,filter_min:gl.LINEAR_MIPMAP_LINEAR,filter_mag:gl.LINEAR,soft_error:true,auto_unload:function auto_unload(){return delete profile_images[user_id]}})
if(tex&&tex.loaded)return image=profile_images[user_id]={img:spriteCreate({tex:tex})}}return default_profile_image}function setDefaultUserProfileImage(image){default_profile_image=image}var external_user_info_providers=Object.create(null)
function registerExternalUserInfoProvider(provider,get_current_user,get_friends){if(get_current_user||get_friends){var _netSubs
assert(!friend_list)
assert(!(null!=(_netSubs=netSubs())&&_netSubs.loggedIn()))
external_user_info_providers[provider]={get_current_user:get_current_user,get_friends:get_friends}}else delete external_user_info_providers[provider]}function socialInit(){netSubs().on("login",function(){var user_channel=netSubs().getMyUserChannel()
var user_id=netSubs().loggedIn()
richPresenceSend()
friend_list=null
if(netDisconnected())return
user_channel.pak("friend_list").send(function(err,resp){if(err||user_id!==netSubs().loggedIn())return
friend_list=resp
for(var provider in external_user_info_providers){var _external_user_info_p=external_user_info_providers[provider],get_current_user=_external_user_info_p.get_current_user,get_friends=_external_user_info_p.get_friends
if(get_current_user)requestExternalCurrentUser(provider,get_current_user)
if(get_friends)requestExternalFriends(provider,get_friends)}})})
netSubs().on("logout",function(){friend_list=null
external_current_users=Object.create(null)
external_friends=Object.create(null)})
netSubs().onChannelMsg("user","presence",onPresence)}

},{"../common/enums":68,"../common/friends_data":69,"../common/util":74,"./client_config":8,"./cmds":9,"./input":28,"./net":35,"./sprites":51,"./textures":55,"assert":undefined}],49:[function(require,module,exports){
"use strict"
exports.FADE_OUT=exports.FADE_IN=exports.FADE_DEFAULT=exports.FADE=void 0
exports.fadesCount=fadesCount
exports.isPlaceholderSound=isPlaceholderSound
exports.soundLoad=soundLoad
exports.soundLoading=soundLoading
exports.soundOnLoadFail=soundOnLoadFail
exports.soundPause=soundPause
exports.soundPlay=soundPlay
exports.soundPlayMusic=soundPlayMusic
exports.soundPlayStreaming=soundPlayStreaming
exports.soundResume=soundResume
exports.soundResumed=soundResumed
exports.soundStartup=soundStartup
exports.soundTick=soundTick
var FADE_DEFAULT=0
exports.FADE_DEFAULT=FADE_DEFAULT
var FADE_OUT=1
exports.FADE_OUT=FADE_OUT
var FADE_IN=2
exports.FADE_IN=FADE_IN
var FADE=FADE_OUT+FADE_IN
exports.FADE=FADE
var assert=require("assert")
var _glovCommonUtil=require("../common/util")
var callEach=_glovCommonUtil.callEach
var defaults=_glovCommonUtil.defaults
var ridx=_glovCommonUtil.ridx
var _browser=require("./browser")
var is_firefox=_browser.is_firefox
var _cmds=require("./cmds")
var cmd_parse=_cmds.cmd_parse
var _fbinstant=require("./fbinstant")
var fbInstantOnPause=_fbinstant.fbInstantOnPause
var _filewatch=require("./filewatch")
var filewatchOn=_filewatch.filewatchOn
var _urlhash=require("./urlhash")
var urlhash=_urlhash
var _require=require("@jimbly/howler/src/howler.core.js"),Howl=_require.Howl,Howler=_require.Howler
var settings=require("./settings")
var abs=Math.abs,floor=Math.floor,max=Math.max,min=Math.min,random=Math.random
var DEFAULT_FADE_RATE=.001
function isPlaceholderSound(sound){return sound.is_placeholder}var sounds={}
var active_sfx_as_music=[]
var num_loading=0
var default_params={ext_list:["mp3","wav"],fade_rate:DEFAULT_FADE_RATE}
var sound_params
var last_played={}
var frame_timestamp=0
var fades=[]
var music
function fadesCount(){return fades.length}var volume_override=1
var volume_override_target=1
settings.register({volume:{default_value:1,type:cmd_parse.TYPE_FLOAT,range:[0,1]}})
settings.register({volume_music:{default_value:1,type:cmd_parse.TYPE_FLOAT,range:[0,1]}})
settings.register({volume_sound:{default_value:1,type:cmd_parse.TYPE_FLOAT,range:[0,1]}})
function musicVolume(){return settings.volume*settings.volume_music}function soundVolume(){return settings.volume*settings.volume_sound}var sounds_loading={}
var on_load_fail
function soundOnLoadFail(cb){on_load_fail=cb}function soundLoad(soundid,opts,cb){if((opts=opts||{}).streaming&&is_firefox)opts.streaming=false
var _opts=opts,streaming=_opts.streaming,loop=_opts.loop
if(Array.isArray(soundid)){assert(!cb)
for(var ii=0;ii<soundid.length;++ii)soundLoad(soundid[ii],opts)
return}var key="string"===typeof soundid?soundid:soundid.file
if(sounds[key]){if(cb)cb()
return}if(sounds_loading[key]){if(cb)sounds_loading[key].push(cb)
return}var cbs=[]
if(cb)cbs.push(cb)
sounds_loading[key]=cbs
var soundname=key
var m=soundname.match(/^((?:[\0-\t\x0B\f\x0E-\u2027\u202A-\uD7FF\uE000-\uFFFF]|[\uD800-\uDBFF][\uDC00-\uDFFF]|[\uD800-\uDBFF](?![\uDC00-\uDFFF])|(?:[^\uD800-\uDBFF]|^)[\uDC00-\uDFFF])*)\.(mp3|ogg|wav|webm)$/)
var preferred_ext
if(m){soundname=m[1]
preferred_ext=m[2]}var src="sounds/"+soundname
var srcs=[]
var suffix=""
if(opts.for_reload)suffix="?rl="+Date.now()
if(preferred_ext)srcs.push(""+urlhash.getURLBase()+src+"."+preferred_ext+suffix)
for(var _ii=0;_ii<sound_params.ext_list.length;++_ii){var ext=sound_params.ext_list[_ii]
if(ext!==preferred_ext)srcs.push(""+urlhash.getURLBase()+src+"."+ext+suffix)}function tryLoad(idx){if(idx===srcs.length){console.error("Error loading sound "+soundname+": All fallbacks exhausted, giving up")
if(on_load_fail)on_load_fail(soundname)
callEach(cbs,delete sounds_loading[key],"Error loading sound")
return}if(!streaming)++num_loading
var once=false
var sound=new Howl({src:srcs.slice(idx),html5:Boolean(streaming),loop:Boolean(loop),volume:0,onload:function onload(){if(!once){if(!streaming)--num_loading
once=true
sound.glov_load_opts=opts
sounds[key]=sound
callEach(cbs,delete sounds_loading[key],null)}},onloaderror:function onloaderror(id,err,extra){if(idx===srcs.length-1)console.error("Error loading sound "+srcs[idx]+": "+err)
else console.log("Error loading sound "+srcs[idx]+": "+err+", trying fallback...")
if(!once){if(!streaming)--num_loading
once=true
tryLoad(idx+1)}}})}tryLoad(0)}function soundReload(filename){var name_match=filename.match(/^sounds\/([^.]+)\.\w+$/)
var sound_name=name_match&&name_match[1]
if(!sound_name)return
if(!sounds[sound_name]){console.log("Reload trigged for non-existent sound: "+filename)
return}var opts=sounds[sound_name].glov_load_opts
opts.for_reload=true
delete sounds[sound_name]
soundLoad(sound_name,opts)}function soundPause(){soundTick(volume_override=volume_override_target=0)}function soundResume(){volume_override_target=1
Howler.manualUnlock()}function soundStartup(params){sound_params=defaults(params||{},default_params)
music=[]
for(var ii=0;ii<2;++ii)music.push({sound:null,id:0,current_volume:0,target_volume:0,sys_volume:0,need_play:false})
filewatchOn(".mp3",soundReload)
filewatchOn(".ogg",soundReload)
filewatchOn(".wav",soundReload)
filewatchOn(".webm",soundReload)
fbInstantOnPause(soundPause)}function soundResumed(){return!Howler.noAudio&&Howler.safeToPlay}function soundTick(dt){frame_timestamp+=dt
if(volume_override!==volume_override_target){var delta=.004*dt
if(volume_override<volume_override_target)volume_override=min(volume_override+delta,volume_override_target)
else volume_override=max(volume_override-delta,volume_override_target)}if(!soundResumed())return
for(var i=0;i<active_sfx_as_music.length;++i){var _active_sfx_as_music$=active_sfx_as_music[i],_sound=_active_sfx_as_music$.sound,play_volume=_active_sfx_as_music$.play_volume,set_volume_when_played=_active_sfx_as_music$.set_volume_when_played
if(!_sound.playing())ridx(active_sfx_as_music,i)
else if(set_volume_when_played!==musicVolume()){_sound.volume(play_volume)
active_sfx_as_music[i].set_volume_when_played=musicVolume()}}var max_fade=dt*sound_params.fade_rate
for(var ii=0;ii<music.length;++ii){var mus=music[ii]
if(!mus.sound)continue
var target=settings.volume*settings.volume_music===0?0:mus.target_volume
if(mus.current_volume!==target){var _delta=target-mus.current_volume
var fade_amt=min(abs(_delta),max_fade)
if(_delta<0)mus.current_volume=max(target,mus.current_volume-fade_amt)
else mus.current_volume=min(target,mus.current_volume+fade_amt)
if(!mus.target_volume&&!mus.current_volume){if(!mus.need_play)mus.sound.stop(mus.id)
mus.sound=null}}if(mus.sound){var sys_volume=mus.current_volume*musicVolume()*volume_override
if(mus.need_play){mus.need_play=false
mus.id=mus.sound.play()
mus.sys_volume=-1}if(mus.sys_volume!==sys_volume){mus.sound.volume(sys_volume,mus.id)
mus.sys_volume=sys_volume}}}for(var _ii2=fades.length-1;_ii2>=0;--_ii2){var fade=fades[_ii2]
var _delta2=fade.target_volume-fade.volume
var _fade_amt=min(abs(_delta2),fade.time?dt/fade.time:max_fade)
if(_delta2<0)fade.volume=max(fade.target_volume,fade.volume-_fade_amt)
else fade.volume=min(fade.target_volume,fade.volume+_fade_amt)
fade.sound.volume(fade.volume)
if(fade.volume===fade.target_volume){ridx(fades,_ii2)
if(!fade.volume)fade.sound.stop(fade.id)}}}function soundPlay(soundid,volume,as_music){volume=volume||1
if(settings.volume*(as_music?settings.volume_music:settings.volume_sound)===0)return null
if(!soundResumed())return null
if(Array.isArray(soundid))soundid=soundid[floor(random()*soundid.length)]
if("object"===typeof soundid){volume*=soundid.volume||1
soundid=soundid.file}var sound=sounds[soundid]
if(!sound)return null
var last_played_time=last_played[soundid]||-9e9
if(frame_timestamp-last_played_time<45)return null
var settingsVolume=as_music?musicVolume:soundVolume
var id=sound.play(void 0,volume*settingsVolume()*volume_override)
last_played[soundid]=frame_timestamp
var played_sound={name:soundid,volume_current:volume,stop:sound.stop.bind(sound,id),playing:sound.playing.bind(sound,id),location:function location(){var v=sound.seek(id)
if("number"!==typeof v)return 0
return v},duration:sound.duration.bind(sound,id),volume:function volume(vol){played_sound.volume_current=vol
sound.volume(vol*settingsVolume()*volume_override,id)},fade:function fade(target_volume,time){var new_fade={sound:played_sound,volume:played_sound.volume_current,target_volume:target_volume,id:id,time:time,settingsVolume:settingsVolume}
for(var ii=0;ii<fades.length;++ii)if(fades[ii].id===id){fades[ii]=new_fade
return}fades.push(new_fade)}}
if(as_music)active_sfx_as_music.push({sound:played_sound,play_volume:volume,set_volume_when_played:musicVolume()})
return played_sound}function soundPlayStreaming(soundname,volume,as_music,on_played_sound){if(settings.volume*(as_music?settings.volume_music:settings.volume_sound)===0)return null
if(Array.isArray(soundname))soundname=soundname[floor(random()*soundname.length)]
var played_sound={name:soundname,is_placeholder:true}
soundLoad(soundname,{streaming:true,loop:false},function(err){if(!err){played_sound=soundPlay(soundname,volume,as_music)
if(on_played_sound)on_played_sound(played_sound)}})
return played_sound}function soundPlayMusic(soundname,volume,transition){if(settings.volume*settings.volume_music===0)return
if(void 0===volume)volume=1
transition=transition||FADE_DEFAULT
soundLoad(soundname,{streaming:true,loop:true},function(err){assert(!err)
var sound=sounds[soundname]
assert(sound)
if(music[0].sound===sound){music[0].target_volume=volume
if(!transition)if(!volume){sound.stop(music[0].id)
music[0].sound=null}else{var sys_volume=music[0].sys_volume=volume*musicVolume()*volume_override
sound.volume(sys_volume,music[0].id)
if(!sound.playing())sound.play(void 0,sys_volume)}return}if(music[0].current_volume)if(transition&FADE_OUT){var temp=music[1]
music[1]=music[0]
music[0]=temp
music[1].target_volume=0}if(music[0].sound)music[0].sound.stop(music[0].id)
music[0].sound=sound
music[0].target_volume=volume
var start_vol=transition&FADE_IN?0:volume
music[0].current_volume=start_vol
if(soundResumed()){var _sys_volume=start_vol*musicVolume()*volume_override
music[0].id=sound.play(void 0,_sys_volume)
music[0].sys_volume=_sys_volume
music[0].need_play=false}else music[0].need_play=true})}function soundLoading(){return num_loading}

},{"../common/util":74,"./browser":5,"./cmds":9,"./fbinstant":16,"./filewatch":18,"./settings":44,"./urlhash":58,"@jimbly/howler/src/howler.core.js":undefined,"assert":undefined}],50:[function(require,module,exports){
"use strict"
exports.SPOT_STATE_REGULAR=exports.SPOT_STATE_FOCUSED=exports.SPOT_STATE_DOWN=exports.SPOT_STATE_DISABLED=exports.SPOT_NAV_UP=exports.SPOT_NAV_RIGHT=exports.SPOT_NAV_PREV=exports.SPOT_NAV_NONE=exports.SPOT_NAV_NEXT=exports.SPOT_NAV_LEFT=exports.SPOT_NAV_DOWN=exports.SPOT_DEFAULT_LABEL=exports.SPOT_DEFAULT_BUTTON_DRAW_ONLY=exports.SPOT_DEFAULT_BUTTON_DISABLED=exports.SPOT_DEFAULT_BUTTON=exports.SPOT_DEFAULT=void 0
exports.spot=spot
exports.spotAsyncActivateButton=spotAsyncActivateButton
exports.spotEndInput=spotEndInput
exports.spotEndOfFrame=spotEndOfFrame
exports.spotFocusCheck=spotFocusCheck
exports.spotFocusSteal=spotFocusSteal
exports.spotGet=spotGet
exports.spotKey=spotKey
exports.spotMouseoverHook=spotMouseoverHook
exports.spotPadMode=spotPadMode
exports.spotPadSuppressed=spotPadSuppressed
exports.spotSetPadMode=spotSetPadMode
exports.spotSubBegin=spotSubBegin
exports.spotSubEnd=spotSubEnd
exports.spotSubPop=spotSubPop
exports.spotSubPush=spotSubPush
exports.spotSuppressPad=spotSuppressPad
exports.spotTopOfFrame=spotTopOfFrame
exports.spotUnfocus=spotUnfocus
exports.spotlog=spotlog
function _extends(){return(_extends=Object.assign?Object.assign.bind():function(target){for(var i=1;i<arguments.length;i++){var source=arguments[i]
for(var key in source)if(Object.prototype.hasOwnProperty.call(source,key))target[key]=source[key]}return target}).apply(this,arguments)}var _input_constants=require("./input_constants")
var BUTTON_ANY=_input_constants.BUTTON_ANY
var SPOT_NAV_NONE=0
exports.SPOT_NAV_NONE=SPOT_NAV_NONE
var SPOT_NAV_LEFT=1
exports.SPOT_NAV_LEFT=SPOT_NAV_LEFT
var SPOT_NAV_UP=2
exports.SPOT_NAV_UP=SPOT_NAV_UP
var SPOT_NAV_RIGHT=3
exports.SPOT_NAV_RIGHT=SPOT_NAV_RIGHT
var SPOT_NAV_DOWN=4
exports.SPOT_NAV_DOWN=SPOT_NAV_DOWN
var SPOT_NAV_NEXT=5
exports.SPOT_NAV_NEXT=SPOT_NAV_NEXT
var SPOT_NAV_PREV=6
exports.SPOT_NAV_PREV=SPOT_NAV_PREV
var SPOT_NAV_MAX=7
var SPOT_STATE_REGULAR=1
exports.SPOT_STATE_REGULAR=SPOT_STATE_REGULAR
var SPOT_STATE_DOWN=2
exports.SPOT_STATE_DOWN=SPOT_STATE_DOWN
var SPOT_STATE_FOCUSED=3
exports.SPOT_STATE_FOCUSED=SPOT_STATE_FOCUSED
var SPOT_STATE_DISABLED=4
exports.SPOT_STATE_DISABLED=SPOT_STATE_DISABLED
var SPOT_DEFAULT={key:void 0,disabled:false,in_event_cb:null,drag_target:false,drag_over:false,button:BUTTON_ANY,is_button:false,button_long_press:false,pad_focusable:true,spatial_focus:true,auto_focus:false,long_press_focuses:true,sound_button:"button_click",sound_rollover:"rollover",touch_focuses:false,disabled_focusable:true,hotkey:null,hotpad:null,focus_steal:false,sticky_focus:false,custom_nav:null}
var SPOT_DEFAULT_BUTTON=_extends({},exports.SPOT_DEFAULT=SPOT_DEFAULT,{is_button:true})
exports.SPOT_DEFAULT_BUTTON=SPOT_DEFAULT_BUTTON
var SPOT_DEFAULT_BUTTON_DISABLED=_extends({},SPOT_DEFAULT,{disabled:true,sound_rollover:null})
exports.SPOT_DEFAULT_BUTTON_DISABLED=SPOT_DEFAULT_BUTTON_DISABLED
var SPOT_DEFAULT_BUTTON_DRAW_ONLY=_extends({},SPOT_DEFAULT,{pad_focusable:false})
exports.SPOT_DEFAULT_BUTTON_DRAW_ONLY=SPOT_DEFAULT_BUTTON_DRAW_ONLY
var SPOT_DEFAULT_LABEL=_extends({},SPOT_DEFAULT,{sound_rollover:null,touch_focuses:true})
exports.SPOT_DEFAULT_LABEL=SPOT_DEFAULT_LABEL
var assert=require("assert")
var abs=Math.abs,max=Math.max
var verify=require("../common/verify")
var _camera2dJs=require("./camera2d.js")
var camera2d=_camera2dJs
var _engineJs=require("./engine.js")
var engine=_engineJs
var _fontJs=require("./font.js")
var fontStyle=_fontJs.fontStyle
var _inputJs=require("./input.js")
var KEYS=_inputJs.KEYS
var PAD=_inputJs.PAD
var dragDrop=_inputJs.dragDrop
var dragOver=_inputJs.dragOver
var inputClick=_inputJs.inputClick
var inputEatenMouse=_inputJs.inputEatenMouse
var inputTouchMode=_inputJs.inputTouchMode
var keyDown=_inputJs.keyDown
var keyDownEdge=_inputJs.keyDownEdge
var longPress=_inputJs.longPress
var mouseButtonHadEdge=_inputJs.mouseButtonHadEdge
var mouseDomPos=_inputJs.mouseDomPos
var mouseDownAnywhere=_inputJs.mouseDownAnywhere
var mouseDownEdge=_inputJs.mouseDownEdge
var mouseDownMidClick=_inputJs.mouseDownMidClick
var mouseMoved=_inputJs.mouseMoved
var mouseOver=_inputJs.mouseOver
var mousePosIsTouch=_inputJs.mousePosIsTouch
var padButtonDownEdge=_inputJs.padButtonDownEdge
var _settingsJs=require("./settings.js")
var settings=_settingsJs
var _uiJs=require("./ui.js")
var ui=_uiJs
var _uiJs2=require("./ui.js")
var drawLine=_uiJs2.drawLine
var drawRect=_uiJs2.drawRect
var drawTooltipBox=_uiJs2.drawTooltipBox
var playUISound=_uiJs2.playUISound
var checkHooks=ui.internal.checkHooks
var focus_sub_rect=null
var focus_sub_rect_elem=null
var sub_stack=[]
var focus_key=null
var focus_is_sticky=false
var focus_key_nonsticky=null
var focus_pos={x:0,y:0,w:0,h:0}
var last_frame_spots=[]
var frame_spots=[]
var focus_next=[]
var focus_next_via=[]
var frame_autofocus_spots={}
var last_frame_autofocus_spots={}
var pad_mode=false
var suppress_pad=false
var async_activate_key=null
function isSubRect(area){return area.is_sub_rect}function spotPadMode(){return pad_mode}function spotSetPadMode(new_mode){pad_mode=new_mode}function spotlog(){}function spotGet(key,last_frame){var frames=last_frame?last_frame_spots:frame_spots
var key_computed_spot=null
for(var ii=0;ii<frames.length;++ii){if(key===frames[ii].key)return frames[ii]
if(key===frames[ii].key_computed)key_computed_spot=frames[ii]}return key_computed_spot}function spotKey(param){if(param.key_computed)if(!engine.defines.SPOT_DEBUG)return param.key_computed
profilerStart("spotKey")
var key=param.key||(focus_sub_rect?focus_sub_rect.key_computed:"")+"_"+param.x+"_"+param.y
if(param.key_computed)assert.equal(param.key_computed,key)
else param.key_computed=key
profilerStop("spotKey")
return param.key_computed}function spotFocusSet(param,from_mouseover,force,log){if(from_mouseover&&(!mouseMoved()||mousePosIsTouch()))return false
var def=param.def||SPOT_DEFAULT
var sound_rollover=void 0===param.sound_rollover?def.sound_rollover:param.sound_rollover
var key=param.key_computed||spotKey(param)
var use_nonsticky=focus_is_sticky&&!force&&from_mouseover&&key!==focus_key
var key_prev=use_nonsticky?focus_key_nonsticky:focus_key
if((sound_rollover||!from_mouseover)&&key_prev!==key)playUISound(sound_rollover||SPOT_DEFAULT.sound_rollover)
if(key_prev!==key||pad_mode!==!from_mouseover)spotlog("spotFocusSet",key,log,from_mouseover?"":"pad_mode",use_nonsticky?"nonsticky":"")
pad_mode=!from_mouseover
if(use_nonsticky)focus_key_nonsticky=key
else{focus_key=key
var sticky_focus=void 0===param.sticky_focus?def.sticky_focus:param.sticky_focus
focus_is_sticky=sticky_focus
focus_key_nonsticky=null}assert(param.dom_pos)
return true}function spotUnfocus(){spotlog("spotUnfocus")
focus_key_nonsticky=focus_key=null
pad_mode=focus_is_sticky=false}var TARGET_QUAD=0
var TARGET_HALF=1
var TARGET_ALL=2
function findBestTargetInternal(nav,dom_pos,targets,precision,filter){var start_w2=dom_pos.w/2
var start_h2=dom_pos.h/2
var start_x=dom_pos.x+start_w2
var start_y=dom_pos.y+start_h2
var start_left=dom_pos.x
var start_right=dom_pos.x+dom_pos.w
var start_top=dom_pos.y
var start_bottom=dom_pos.y+dom_pos.h
var best=null
var bestd
for(var ii=0;ii<targets.length;++ii){var _param=targets[ii]
if(!filter(_param))continue
var target=_param.dom_pos
var d=void 0
if(precision===TARGET_QUAD){var quadrant=void 0
var target_right=target.x+target.w
var target_bottom=target.y+target.h
var left_dx=start_left-target_right
var right_dx=target.x-start_right
var top_dy=start_top-target_bottom
var bottom_dy=target.y-start_bottom
if(left_dx>=-start_w2&&target_bottom>start_top-left_dx&&target.y<start_bottom+left_dx){quadrant=SPOT_NAV_LEFT
d=left_dx+max(target.y-start_y,start_y-target_bottom,0)}else if(right_dx>=-start_w2&&target_bottom>start_top-right_dx&&target.y<start_bottom+right_dx){quadrant=SPOT_NAV_RIGHT
d=right_dx+max(target.y-start_y,start_y-target_bottom,0)}else if(top_dy>=-start_h2&&target_right>=start_left-top_dy&&target.x<=start_right+top_dy){quadrant=SPOT_NAV_UP
d=top_dy+max(target.x-start_x,start_x-target_right,0)}else if(bottom_dy>=-start_h2&&target_right>=start_left-bottom_dy&&target.x<=start_right+bottom_dy){quadrant=SPOT_NAV_DOWN
d=bottom_dy+max(target.x-start_x,start_x-target_right,0)}if(void 0===quadrant){var dx=target.x+target.w/2-start_x
var dy=target.y+target.h/2-start_y
d=abs(dx)+abs(dy)
if(abs(dx)>abs(dy))if(dx>0)quadrant=SPOT_NAV_RIGHT
else quadrant=SPOT_NAV_LEFT
else if(dy>0)quadrant=SPOT_NAV_DOWN
else quadrant=SPOT_NAV_UP}if(quadrant!==nav)continue}else{var _dx=target.x+target.w/2-start_x
var _dy=target.y+target.h/2-start_y
d=abs(_dx)+abs(_dy)
if(precision===TARGET_HALF)if(_dx<=0&&nav===SPOT_NAV_RIGHT||_dx>=0&&nav===SPOT_NAV_LEFT||_dy<=0&&nav===SPOT_NAV_DOWN||_dy>=0&&nav===SPOT_NAV_UP)continue}if(!best||d<bestd){best=_param
bestd=d}}return best}var EPSILON=1e-5
var debug_style
function spotDebugList(show_all,list){if(!debug_style)debug_style=fontStyle(null,{color:255,outline_color:4294967244,outline_width:2})
for(var ii=0;ii<list.length;++ii){var area=list[ii]
var pos=area.dom_pos
var color=void 0
if(isSubRect(area)){if(show_all)ui.font.drawSizedAligned(debug_style,pos.x,pos.y,Z.DEBUG,8,ui.font.ALIGN.HVCENTERFIT,pos.w,pos.h,area.key_computed||"unknown")
continue}if(area.spot_debug_ignore)continue
if(area.only_mouseover)color=[1,.5,0,.5]
else{var def=area.def||SPOT_DEFAULT
if(!(void 0===area.pad_focusable?def.pad_focusable:area.pad_focusable))continue
if(!(void 0===area.spatial_focus?def.spatial_focus:area.spatial_focus))continue
for(var jj=0;jj<list.length;++jj){if(ii===jj)continue
var other=list[jj]
if(isSubRect(other))continue
if(other.sub_rect!==area.sub_rect)continue
var other_def=other.def||SPOT_DEFAULT
var other_pad_focusable=void 0===other.pad_focusable?other_def.pad_focusable:other.pad_focusable
if(other.only_mouseover||!other_pad_focusable)continue
if(!(void 0===other.spatial_focus?other_def.spatial_focus:other.spatial_focus))continue
var other_pos=other.dom_pos
if(pos.x<other_pos.x+other_pos.w-EPSILON&&pos.x+pos.w>other_pos.x+EPSILON&&pos.y<other_pos.y+other_pos.h-EPSILON&&pos.y+pos.h>other_pos.y+EPSILON)color=[1,0,0,.5]}}if(!show_all&&!color)continue
drawRect(pos.x,pos.y,pos.x+pos.w,pos.y+pos.h,Z.DEBUG,color||[1,1,0,.5])
ui.font.drawSizedAligned(debug_style,pos.x,pos.y,Z.DEBUG,8,ui.font.ALIGN.HVCENTERFIT,pos.w,pos.h,area.key_computed||"unknown")}}function spotDebug(){camera2d.push()
camera2d.setDOMMapped()
var show_all=keyDown(KEYS.SHIFT)
spotDebugList(show_all,frame_spots)
if(pad_mode||show_all)for(var ii=SPOT_NAV_LEFT;ii<=SPOT_NAV_DOWN;++ii){var next_spot=focus_next[ii]
if(next_spot){var pos=focus_pos
var next=next_spot.dom_pos
var via=focus_next_via[ii]
if(via){pos=via.dom_pos
drawLine(pos.x+pos.w/2,pos.y+pos.h/2,next.x+next.w/2,next.y+next.h/2,Z.DEBUG,1,.95,[1,.5,0,1])
pos=focus_pos
next=via.dom_pos}drawLine(pos.x+pos.w/2,pos.y+pos.h/2,next.x+next.w/2,next.y+next.h/2,Z.DEBUG,1,.95,[1,1,0,1])}}camera2d.pop()}var filter_sub_rect
var filter_not
function filterMatchesSubrect(param){return param!==filter_not&&param.sub_rect===filter_sub_rect}function overlaps(r1,r2){return r1.x+r1.w>r2.x&&r1.x<r2.x+r2.w&&r1.y+r1.h>r2.y&&r1.y<r2.y+r2.h}function contains(outer,inner){return inner.x>=outer.x&&inner.x+inner.w<=outer.x+outer.w&&inner.y>=outer.y&&inner.y+inner.h<=outer.y+outer.h}function filterInSubrectView(param){if(param.sub_rect!==filter_sub_rect)return false
return overlaps(param.dom_pos,filter_sub_rect.dom_pos)}function filterMatchesSubrectOrInVisibleChild(param){if(param===filter_not)return false
if(param.sub_rect===filter_sub_rect)return true
if(param.sub_rect&&param.sub_rect.sub_rect===filter_sub_rect)return overlaps(param.dom_pos,param.sub_rect.dom_pos)
return false}var SUBRECT_FILTERS=[filterInSubrectView,filterMatchesSubrect]
function findBestWithinSubrect(nav,dom_pos,pad_focusable_list,best,precision_max){filter_sub_rect=best
for(var jj=0;jj<SUBRECT_FILTERS.length;++jj){var filter=SUBRECT_FILTERS[jj]
for(var precision=0;precision<=precision_max;++precision){var best_inside=findBestTargetInternal(nav,dom_pos,pad_focusable_list,precision,filter)
if(best_inside){assert(!isSubRect(best_inside))
return best_inside}}}return null}function findBestTargetFromSubRect(start_sub_rect,nav,dom_pos,pad_focusable_list,precision){filter_sub_rect=start_sub_rect
var best=findBestTargetInternal(nav,dom_pos,pad_focusable_list,precision,filterMatchesSubrectOrInVisibleChild)
if(best)if(isSubRect(best))if(!(best=findBestWithinSubrect(nav,dom_pos,pad_focusable_list,focus_next_via[nav]=best,precision)))focus_next_via[nav]=void 0
return best}function spotCalcNavTargets(){for(var ii=1;ii<SPOT_NAV_MAX;++ii){focus_next[ii]=void 0
focus_next_via[ii]=void 0}var start
var pad_focusable_list=[]
var prev
var first_non_sub_rect
for(var _ii=0;_ii<frame_spots.length;++_ii){var _param2=frame_spots[_ii]
if(isSubRect(_param2)){if(!_param2.is_empty_sub_rect)pad_focusable_list.push(_param2)}else if(_param2.key_computed===focus_key){if(!focus_next[SPOT_NAV_PREV]&&prev)focus_next[SPOT_NAV_PREV]=prev
start=_param2}else{var def=_param2.def||SPOT_DEFAULT
if(void 0===_param2.pad_focusable?def.pad_focusable:_param2.pad_focusable){if(!first_non_sub_rect)first_non_sub_rect=_param2
prev=_param2
if(!focus_next[SPOT_NAV_NEXT]&&start)focus_next[SPOT_NAV_NEXT]=_param2
if(void 0===_param2.spatial_focus?def.spatial_focus:_param2.spatial_focus)pad_focusable_list.push(_param2)}}}if(!focus_next[SPOT_NAV_PREV]&&prev)focus_next[SPOT_NAV_PREV]=prev
if(!focus_next[SPOT_NAV_NEXT])focus_next[SPOT_NAV_NEXT]=first_non_sub_rect
var precision_max
var start_sub_rect
if(start){start_sub_rect=start.sub_rect
focus_pos.x=start.dom_pos.x
focus_pos.y=start.dom_pos.y
focus_pos.w=start.dom_pos.w
focus_pos.h=start.dom_pos.h
precision_max=TARGET_HALF}else{start_sub_rect=null
for(var _ii2=0;_ii2<frame_spots.length;++_ii2){var _param3=frame_spots[_ii2]
if(isSubRect(_param3))if(contains(_param3.dom_pos,focus_pos))start_sub_rect=_param3}if(start_sub_rect)precision_max=TARGET_HALF
else precision_max=TARGET_ALL}for(var nav=1;nav<=SPOT_NAV_DOWN;++nav)for(var precision=0;precision<=precision_max;++precision){filter_not=null
var best=findBestTargetFromSubRect(start_sub_rect,nav,focus_pos,pad_focusable_list,precision)
if(best){focus_next[nav]=best
break}if(start_sub_rect)if(best=findBestTargetFromSubRect((filter_not=start_sub_rect).sub_rect,nav,focus_pos,pad_focusable_list,precision)){focus_next[nav]=best
break}}if(start){var _def=start.def||SPOT_DEFAULT
var custom_nav=void 0===start.custom_nav?_def.custom_nav:start.custom_nav
if(custom_nav){var by_key
for(var key_string in custom_nav){var key=Number(key_string)
var target=custom_nav[key]
if(null===target||void 0===target)focus_next[key]=target
else{if(!by_key){by_key={}
for(var _ii3=0;_ii3<frame_spots.length;++_ii3){var _param4=frame_spots[_ii3]
if(!isSubRect(_param4))by_key[_param4.key_computed]=_param4}}if(by_key[target])focus_next[key]=by_key[target]}}}}}function spotTopOfFrame(){if(mouseMoved()){var pos=mouseDomPos()
focus_pos.x=pos[0]
focus_pos.y=pos[1]
focus_pos.w=0
focus_pos.h=0}if(mouseDownEdge({peek:true}))pad_mode=false
sub_stack.length=0}function spotSuppressPad(){suppress_pad=true
if(pad_mode&&focus_key&&!focus_is_sticky){spotUnfocus()
pad_mode=true}}function spotPadSuppressed(){return suppress_pad}function spotEndOfFrame(){spotCalcNavTargets()
last_frame_autofocus_spots=frame_autofocus_spots
suppress_pad=false
last_frame_spots=frame_spots
frame_spots=[]
frame_autofocus_spots={}
async_activate_key=null}function frameSpotsPush(param){assert(param.dom_pos)
verify(isFinite(param.dom_pos.x))
verify(isFinite(param.dom_pos.y))
verify(isFinite(param.dom_pos.w))
verify(isFinite(param.dom_pos.h))
param.sub_rect=focus_sub_rect
frame_spots.push(param)
if(focus_sub_rect)focus_sub_rect.is_empty_sub_rect=false}function spotEntirelyObscured(param){var pos=param.dom_pos
for(var ii=0;ii<frame_spots.length;++ii){var other=frame_spots[ii]
if(isSubRect(other))continue
if(other.sub_rect!==focus_sub_rect)continue
var other_pos=other.dom_pos
if(other_pos.x<=pos.x&&other_pos.x+other_pos.w>=pos.x+pos.w&&other_pos.y<=pos.y&&other_pos.y+other_pos.h>=pos.y+pos.h)return true}return false}function spotSubPush(){sub_stack.push([focus_sub_rect,focus_sub_rect_elem])
focus_sub_rect=null}function spotSubPop(){var _verify=verify(sub_stack.pop())
focus_sub_rect=_verify[0]
focus_sub_rect_elem=_verify[1]}function spotSubBegin(param_in){assert(param_in.key)
assert(!focus_sub_rect)
spotKey(param_in)
var sub_rect=param_in
sub_rect.is_sub_rect=true
if(!sub_rect.dom_pos)sub_rect.dom_pos={}
camera2d.virtualToDomPosParam(sub_rect.dom_pos,sub_rect)
if(!spotEntirelyObscured(sub_rect))frameSpotsPush(sub_rect);(focus_sub_rect=sub_rect).is_empty_sub_rect=true
focus_sub_rect_elem=null}function spotSubEnd(){assert(focus_sub_rect)
focus_sub_rect=null
return focus_sub_rect_elem}function spotMouseoverHook(pos_param_in,param){if(inputEatenMouse()||param.peek)return
if(param.key_computed)return
var pos_param=pos_param_in
if(!pos_param.dom_pos)pos_param.dom_pos={}
camera2d.virtualToDomPosParam(pos_param.dom_pos,pos_param)
if(!spotEntirelyObscured(pos_param)){var area=pos_param
area.only_mouseover=true
area.pad_focusable=false
if(engine.defines.SPOT_DEBUG)area.spot_debug_ignore=param.eat_clicks||param.spot_debug_ignore
frameSpotsPush(area)}}function keyCheck(nav_dir){if(suppress_pad)return false
switch(nav_dir){case SPOT_NAV_LEFT:return keyDownEdge(KEYS.LEFT)||padButtonDownEdge(PAD.LEFT)
case SPOT_NAV_UP:return keyDownEdge(KEYS.UP)||padButtonDownEdge(PAD.UP)
case SPOT_NAV_RIGHT:return keyDownEdge(KEYS.RIGHT)||padButtonDownEdge(PAD.RIGHT)
case SPOT_NAV_DOWN:return keyDownEdge(KEYS.DOWN)||padButtonDownEdge(PAD.DOWN)
case SPOT_NAV_PREV:return keyDown(KEYS.SHIFT)&&keyDownEdge(KEYS.TAB)||padButtonDownEdge(PAD.LEFT_BUMPER)
case SPOT_NAV_NEXT:return!keyDown(KEYS.SHIFT)&&keyDownEdge(KEYS.TAB)||padButtonDownEdge(PAD.RIGHT_BUMPER)
default:assert(false)}return false}function spotFocusCheckNavButtonsFocused(param){for(var ii=1;ii<SPOT_NAV_MAX;++ii){var elem=focus_next[ii]
if(void 0!==elem&&keyCheck(ii))if(elem)spotFocusSet(elem,false,false,"nav_focused")
else param.out.nav=ii}}function spotFocusCheckNavButtonsUnfocused(param){for(var ii=1;ii<SPOT_NAV_MAX;++ii){var elem=focus_next[ii]
if(elem&&elem.key_computed===param.key_computed&&keyCheck(ii))spotFocusSet(elem,false,false,"nav_unfocused")}}function spotFocusSetSilent(param){var key=spotKey(param)
var def=param.def||SPOT_DEFAULT
focus_key=key
var sticky_focus=void 0===param.sticky_focus?def.sticky_focus:param.sticky_focus
focus_is_sticky=sticky_focus
focus_key_nonsticky=null}function spotFocusSteal(param){spotlog("spotFocusSteal",spotKey(param),false)
pad_mode=true
spotFocusSetSilent(param)}function spotParamAddOut(param){if(!param.out)param.out={}}function spotParamAddPosCache(param){assert(param.key_computed)
if(!param.dom_pos)param.dom_pos={}}function spotParamIsSpotInternal(param){}function spotFocusCheck(param){spotParamAddOut(param)
var out=param.out
out.focused=false
out.kb_focused=false
out.allow_focus=false
var key=spotKey(param)
var def=param.def||SPOT_DEFAULT
if(void 0===param.disabled?def.disabled:param.disabled)if(!(void 0===param.disabled_focusable?def.disabled_focusable:param.disabled_focusable))return out
if(void 0===param.focus_steal?def.focus_steal:param.focus_steal)spotFocusSetSilent(param)
if(focus_key===key)spotFocusCheckNavButtonsFocused(param)
else spotFocusCheckNavButtonsUnfocused(param)
var focused=focus_key===key||focus_key_nonsticky===key
if(inputEatenMouse()){if(focus_key===key){spotUnfocus()
focused=false}if(focus_key_nonsticky===key){focus_key_nonsticky=null
focused=false}}else{out.allow_focus=true
spotParamAddPosCache(param)
camera2d.virtualToDomPosParam(param.dom_pos,param)
var auto_focus=void 0===param.auto_focus?def.auto_focus:param.auto_focus
if(!spotEntirelyObscured(param)||focused&&focus_is_sticky){frameSpotsPush(param)
if(auto_focus)if(!focused&&!last_frame_autofocus_spots[key]&&pad_mode){spotlog("auto_focus",key)
spotFocusSetSilent(param)
focused=true}}if(auto_focus)frame_autofocus_spots[key]=param
if(focus_sub_rect&&focus_key===key)focus_sub_rect_elem=param}out.kb_focused=focus_key===key
out.focused=focused
return out}function spotEndInput(){if(engine.defines.SPOT_DEBUG)spotDebug()}function spotAsyncActivateButton(key){async_activate_key=key}var last_signal={key:"",timestamp:0}
function spotSignalRet(param){var out=param.out
var key=param.key_computed
assert(key)
out.double_click=key===last_signal.key&&engine.frame_timestamp-last_signal.timestamp<settings.double_click_time
last_signal.key=key
last_signal.timestamp=engine.frame_timestamp
out.ret++}function spot(param){profilerStart("spot")
var def=param.def||SPOT_DEFAULT
var disabled=void 0===param.disabled?def.disabled:param.disabled
var is_button=void 0===param.is_button?def.is_button:param.is_button
var button_long_press=void 0===param.button_long_press?def.button_long_press:param.button_long_press
var in_event_cb=void 0===param.in_event_cb?def.in_event_cb:param.in_event_cb
var drag_target=void 0===param.drag_target?def.drag_target:param.drag_target
var drag_over=void 0===param.drag_over?def.drag_over:param.drag_over
var touch_focuses=void 0===param.touch_focuses?def.touch_focuses:param.touch_focuses
var focus_steal=void 0===param.focus_steal?def.focus_steal:param.focus_steal
var custom_nav=void 0===param.custom_nav?def.custom_nav:param.custom_nav
spotParamAddOut(param)
var out=param.out
out.focused=false
out.ret=0
if(button_long_press)out.long_press=false
if(drag_target)out.drag_drop=null
if(custom_nav)out.nav=SPOT_NAV_NONE
var state=SPOT_STATE_REGULAR
var _spotFocusCheck=spotFocusCheck(param),focused=_spotFocusCheck.focused,allow_focus=_spotFocusCheck.allow_focus,kb_focused=_spotFocusCheck.kb_focused
spotParamIsSpotInternal(param)
if(disabled)state=SPOT_STATE_DISABLED
else{var button_click
var long_press_ret
if(drag_target&&(out.drag_drop=dragDrop(param))){spotFocusSet(param,true,true,"drag_drop")
spotSignalRet(param)
focused=true}else if(button_long_press&&(long_press_ret=longPress(param))||is_button&&(button_click=inputClick(param))){if(long_press_ret){out.long_press=long_press_ret.long_press
out.button=long_press_ret.button
out.pos=void 0}else{assert(button_click)
out.button=button_click.button
out.pos=button_click.pos}if(mousePosIsTouch())if(touch_focuses)if(!focused){spotFocusSet(param,false,false,"touch_focus")
focused=true}else{spotSignalRet(param)
spotUnfocus()
focused=false}else{spotSignalRet(param)
spotUnfocus()
focused=false}else{spotSignalRet(param)
spotFocusSet(param,true,true,"click")
focused=true}}else if(!is_button&&touch_focuses&&mousePosIsTouch()&&inputClick(param)){spotFocusSet(param,false,false,"touch_focus")
focused=true}else if(drag_target&&dragOver(param)){spotFocusSet(param,true,false,"drag_over")
focused=true
if(mouseDownAnywhere())state=SPOT_STATE_DOWN}else if(drag_over&&dragOver(param));}if(allow_focus&&inputTouchMode())if((void 0===param.long_press_focuses?def.long_press_focuses:param.long_press_focuses)&&longPress(param)){spotFocusSet(param,false,false,"long_press")
focused=true}var is_mouseover=mouseOver(param)
if(focused&&!focus_steal&&!is_mouseover)if(mouseButtonHadEdge()){focused=false
spotUnfocus()}else if(mouseMoved()){focused=false
if(focus_key===param.key_computed)spotUnfocus()
else if(focus_key_nonsticky===param.key_computed)focus_key_nonsticky=null}if(is_mouseover)if(allow_focus)if(spotFocusSet(param,true,false,"mouseover"))focused=true
if(is_button&&is_mouseover&&mouseDownMidClick(param))if(!disabled)state=SPOT_STATE_DOWN
var button_activate=false
if(focused){if(state===SPOT_STATE_REGULAR)state=SPOT_STATE_FOCUSED
if(is_button&&!disabled&&kb_focused&&!suppress_pad){var key_opts=in_event_cb?{in_event_cb:in_event_cb}:null
if(keyDownEdge(KEYS.SPACE,key_opts)||keyDownEdge(KEYS.RETURN,key_opts)||padButtonDownEdge(PAD.A))button_activate=true}}if(!disabled){var hotkey=void 0===param.hotkey?def.hotkey:param.hotkey
var hotpad=void 0===param.hotpad?def.hotpad:param.hotpad
if(hotkey)if(keyDownEdge(hotkey,in_event_cb?{in_event_cb:in_event_cb}:null))button_activate=true
if(hotpad)if(padButtonDownEdge(hotpad))button_activate=true
if(async_activate_key===param.key_computed)button_activate=true}if(button_activate){spotSignalRet(param)
out.button=0
out.pos=null}out.focused=focused
if(out.ret){state=SPOT_STATE_DOWN
var sound_button=void 0===param.sound_button?def.sound_button:param.sound_button
if(sound_button)playUISound(sound_button)}if(out.focused&&param.tooltip)drawTooltipBox(param)
checkHooks(param,Boolean(out.ret))
out.spot_state=state
profilerStop("spot")
return out}

},{"../common/verify":75,"./camera2d.js":7,"./engine.js":13,"./font.js":19,"./input.js":28,"./input_constants":29,"./settings.js":44,"./ui.js":57,"assert":undefined}],51:[function(require,module,exports){
"use strict"
exports.BlendMode=exports.BLEND_PREMULALPHA=exports.BLEND_ALPHA=exports.BLEND_ADDITIVE=void 0
exports.blendModeReset=blendModeReset
exports.blendModeSet=blendModeSet
exports.buildRects=buildRects
exports.queueSpriteData=queueSpriteData
exports.queueraw=queueraw
exports.queueraw4=queueraw4
exports.queueraw4color=queueraw4color
exports.queueraw4colorBuffer=queueraw4colorBuffer
exports.queuesprite=queuesprite
exports.spriteChainedStart=spriteChainedStart
exports.spriteChainedStop=spriteChainedStop
exports.spriteClip=spriteClip
exports.spriteClipPause=spriteClipPause
exports.spriteClipPop=spriteClipPop
exports.spriteClipPush=spriteClipPush
exports.spriteClipResume=spriteClipResume
exports.spriteClipped=spriteClipped
exports.spriteCreate=spriteCreate
exports.spriteDataAlloc=spriteDataAlloc
exports.spriteDraw=spriteDraw
exports.spriteDrawPartial=spriteDrawPartial
exports.spriteQueueFn=spriteQueueFn
exports.spriteQueuePop=spriteQueuePop
exports.spriteQueuePush=spriteQueuePush
exports.spriteStartup=spriteStartup
exports.sprite_vshader=exports.sprite_fshader=void 0
exports.createSprite=spriteCreate
exports.create=spriteCreate
var BlendMode={BLEND_ALPHA:0,BLEND_ADDITIVE:1,BLEND_PREMULALPHA:2}
exports.BlendMode=BlendMode
var BLEND_ALPHA=0
exports.BLEND_ALPHA=BLEND_ALPHA
var BLEND_ADDITIVE=1
exports.BLEND_ADDITIVE=BLEND_ADDITIVE
var BLEND_PREMULALPHA=2
exports.BLEND_PREMULALPHA=BLEND_PREMULALPHA
var assert=require("assert")
var camera2d=require("./camera2d.js")
var _require=require("./dyn_geom.js"),dynGeomQueueSprite=_require.dynGeomQueueSprite
var engine=require("./engine.js")
var geom=require("./geom.js")
var cos=Math.cos,max=Math.max,min=Math.min,round=Math.round,sin=Math.sin
var textures=require("./textures.js")
var cmpTextureArray=textures.cmpTextureArray
var shaders=require("./shaders.js")
var _require2=require("../common/util.js"),deprecate=_require2.deprecate,nextHighestPowerOfTwo=_require2.nextHighestPowerOfTwo
var _require3=require("../common/vmath.js"),vec2=_require3.vec2,vec4=_require3.vec4
deprecate(exports,"clip","spriteClip")
deprecate(exports,"clipped","spriteClipped")
deprecate(exports,"clipPush","spriteClipPush")
deprecate(exports,"clipPop","spriteClipPop")
deprecate(exports,"clipPause","spriteClipPause")
deprecate(exports,"clipResume","spriteClipResume")
deprecate(exports,"queuefn","spriteQueueFn")
deprecate(exports,"draw","spriteDraw")
deprecate(exports,"drawPartial","spriteDrawPartial")
var sprite_vshader
exports.sprite_vshader=sprite_vshader
var sprite_fshader
exports.sprite_fshader=sprite_fshader
var sprite_dual_fshader
var clip_space=vec4()
var sprite_shader_params={clip_space:clip_space}
var last_uid=0
var geom_stats
var sprite_queue=[]
var sprite_freelist=[]
var sprite_queue_stack=[]
function spriteQueuePush(new_list){assert(sprite_queue_stack.length<10)
sprite_queue_stack.push(sprite_queue)
sprite_queue=new_list||[]}function spriteQueuePop(for_pause){assert(sprite_queue_stack.length)
assert(for_pause||!sprite_queue.length)
sprite_queue=sprite_queue_stack.pop()}function SpriteData(){this.data=new Float32Array(32)
this.texs=null
this.shader=null
this.shader_params=null
this.x=0
this.y=0
this.z=0
this.blend=0
this.uid=0
this.chained=false
this.next=null}SpriteData.prototype.queue=function(z){++geom_stats.sprites
if(!this.chained){this.z=z
this.uid=++last_uid
sprite_queue.push(this)}}
var is_chained=false
var chained_prev=null
function spriteChainedStart(){is_chained=true
chained_prev=null}function spriteChainedStop(){is_chained=false
chained_prev=null}function spriteDataAlloc(texs,shader,shader_params,blend){var ret
if(sprite_freelist.length)ret=sprite_freelist.pop()
else ret=new SpriteData
ret.texs=texs
if(is_chained&&chained_prev){ret.chained=true
chained_prev.next=ret}else{ret.chained=false
ret.shader=shader||null
if(shader_params){shader_params.clip_space=sprite_shader_params.clip_space
ret.shader_params=shader_params}else ret.shader_params=null
ret.blend=blend||0}if(is_chained)chained_prev=ret
return ret}function cmpSprite(a,b){++geom_stats.sprite_sort_cmps
if(a.z!==b.z)return a.z-b.z
if(a.blend===BLEND_ADDITIVE&&b.blend===BLEND_ADDITIVE)return 0
if(a.y!==b.y)return a.y-b.y
if(a.x!==b.x)return a.x-b.x
return a.uid-b.uid}function spriteQueueFn(z,fn){assert(isFinite(z))
sprite_queue.push({fn:fn,x:0,y:0,z:z,uid:++last_uid})}function queueraw4color(texs,x0,y0,c0,u0,v0,x1,y1,c1,u1,v1,x2,y2,c2,u2,v2,x3,y3,c3,u3,v3,z,shader,shader_params,blend){assert(isFinite(z))
var elem=spriteDataAlloc(texs,shader,shader_params,blend)
var data=elem.data
data[0]=(x0-camera2d.data[0])*camera2d.data[4]
data[1]=(y0-camera2d.data[1])*camera2d.data[5]
data[2]=c0[0]
data[3]=c0[1]
data[4]=c0[2]
data[5]=c0[3]
data[6]=u0
data[7]=v0
data[8]=(x1-camera2d.data[0])*camera2d.data[4]
data[9]=(y1-camera2d.data[1])*camera2d.data[5]
data[10]=c1[0]
data[11]=c1[1]
data[12]=c1[2]
data[13]=c1[3]
data[14]=u1
data[15]=v1
data[16]=(x2-camera2d.data[0])*camera2d.data[4]
data[17]=(y2-camera2d.data[1])*camera2d.data[5]
data[18]=c2[0]
data[19]=c2[1]
data[20]=c2[2]
data[21]=c2[3]
data[22]=u2
data[23]=v2
data[24]=(x3-camera2d.data[0])*camera2d.data[4]
data[25]=(y3-camera2d.data[1])*camera2d.data[5]
data[26]=c3[0]
data[27]=c3[1]
data[28]=c3[2]
data[29]=c3[3]
data[30]=u3
data[31]=v3
elem.x=data[0]
elem.y=data[1]
elem.queue(z)
return elem}function queueraw4(texs,x0,y0,x1,y1,x2,y2,x3,y3,z,u0,v0,u1,v1,color,shader,shader_params,blend){return queueraw4color(texs,x0,y0,color,u0,v0,x1,y1,color,u0,v1,x2,y2,color,u1,v1,x3,y3,color,u1,v0,z,shader,shader_params,blend)}function queueSpriteData(elem,z){assert(isFinite(z))
var data=elem.data
data[0]=(data[0]-camera2d.data[0])*camera2d.data[4]
data[1]=(data[1]-camera2d.data[1])*camera2d.data[5]
data[8]=(data[8]-camera2d.data[0])*camera2d.data[4]
data[9]=(data[9]-camera2d.data[1])*camera2d.data[5]
data[16]=(data[16]-camera2d.data[0])*camera2d.data[4]
data[17]=(data[17]-camera2d.data[1])*camera2d.data[5]
data[24]=(data[24]-camera2d.data[0])*camera2d.data[4]
data[25]=(data[25]-camera2d.data[1])*camera2d.data[5]
elem.x=data[0]
elem.y=data[1]
elem.queue(z)
return elem}function queueraw4colorBuffer(texs,buf,z,shader,shader_params,blend){assert(isFinite(z))
var elem=spriteDataAlloc(texs,shader,shader_params,blend)
var data=elem.data
for(var ii=0;ii<32;++ii)data[ii]=buf[ii]
queueSpriteData(elem,z)
return elem}function queueraw(texs,x,y,z,w,h,u0,v0,u1,v1,color,shader,shader_params,blend){return queueraw4color(texs,x,y,color,u0,v0,x,y+h,color,u0,v1,x+w,y+h,color,u1,v1,x+w,y,color,u1,v0,z,shader,shader_params,blend)}var temp_uvs=vec4()
function fillUVs(tex,w,h,nozoom,uvs){var ubias=0
var vbias=0
if(!nozoom&&!tex.nozoom){var zoom_level=max((uvs[2]-uvs[0])*tex.width/w,(uvs[3]-uvs[1])*tex.height/h)
if(zoom_level<1){if(tex.filter_mag===gl.LINEAR)ubias=vbias=.5
else if(tex.filter_mag===gl.NEAREST)if(engine.antialias)ubias=vbias=zoom_level/2
else ubias=vbias=.01*zoom_level}else if(zoom_level>1)ubias=vbias=.5+zoom_level/2
if(uvs[0]>uvs[2])ubias*=-1
if(uvs[1]>uvs[3])vbias*=-1}temp_uvs[0]=uvs[0]+ubias/tex.width
temp_uvs[1]=uvs[1]+vbias/tex.height
temp_uvs[2]=uvs[2]-ubias/tex.width
temp_uvs[3]=uvs[3]-vbias/tex.height}var qsp={}
function queuesprite4colorObj(){var rot=qsp.rot,z=qsp.z,sprite=qsp.sprite,color_ul=qsp.color_ul,color_ll=qsp.color_ll,color_lr=qsp.color_lr,color_ur=qsp.color_ur
assert(isFinite(z))
var elem=spriteDataAlloc(sprite.texs,qsp.shader,qsp.shader_params,qsp.blend)
var x=(qsp.x-camera2d.data[0])*camera2d.data[4]
var y=(qsp.y-camera2d.data[1])*camera2d.data[5]
var w=qsp.w*camera2d.data[4]
var h=qsp.h*camera2d.data[5]
if(qsp.pixel_perfect){x|=0
y|=0
w|=0
h|=0}elem.x=x
elem.y=y
var data=elem.data
if(!rot){var x1=x-sprite.origin[0]*w
var y1=y-sprite.origin[1]*h
var x2=x1+w
var y2=y1+h
data[0]=x1
data[1]=y1
data[8]=x1
data[9]=y2
data[16]=x2
data[17]=y2
data[24]=x2
data[25]=y1}else{var dx=sprite.origin[0]*w
var dy=sprite.origin[1]*h
var cosr=cos(rot)
var sinr=sin(rot)
var _x=x-cosr*dx+sinr*dy
var _y=y-sinr*dx-cosr*dy
var ch=cosr*h
var cw=cosr*w
var sh=sinr*h
var sw=sinr*w
data[0]=_x
data[1]=_y
data[8]=_x-sh
data[9]=_y+ch
data[16]=_x+cw-sh
data[17]=_y+sw+ch
data[24]=_x+cw
data[25]=_y+sw}fillUVs(elem.texs[0],w,h,qsp.nozoom,qsp.uvs)
data[2]=color_ul[0]
data[3]=color_ul[1]
data[4]=color_ul[2]
data[5]=color_ul[3]
data[6]=temp_uvs[0]
data[7]=temp_uvs[1]
data[10]=color_ll[0]
data[11]=color_ll[1]
data[12]=color_ll[2]
data[13]=color_ll[3]
data[14]=temp_uvs[0]
data[15]=temp_uvs[3]
data[18]=color_lr[0]
data[19]=color_lr[1]
data[20]=color_lr[2]
data[21]=color_lr[3]
data[22]=temp_uvs[2]
data[23]=temp_uvs[3]
data[26]=color_ur[0]
data[27]=color_ur[1]
data[28]=color_ur[2]
data[29]=color_ur[3]
data[30]=temp_uvs[2]
data[31]=temp_uvs[1]
elem.queue(z)
return elem}function queuesprite(sprite,x,y,z,w,h,rot,uvs,color,shader,shader_params,nozoom,pixel_perfect,blend){color=color||sprite.color
qsp.sprite=sprite
qsp.x=x
qsp.y=y
qsp.z=z
qsp.w=w
qsp.h=h
qsp.rot=rot
qsp.uvs=uvs
qsp.color_ul=color
qsp.color_ll=color
qsp.color_lr=color
qsp.color_ur=color
qsp.shader=shader
qsp.shader_params=shader_params
qsp.nozoom=nozoom
qsp.pixel_perfect=pixel_perfect
qsp.blend=blend
return queuesprite4colorObj(qsp)}var clip_temp_xy=vec2()
var clip_temp_wh=vec2()
function clipCoordsScissor(x,y,w,h){camera2d.virtualToCanvas(clip_temp_xy,[x,y])
clip_temp_xy[0]=round(clip_temp_xy[0])
clip_temp_xy[1]=round(clip_temp_xy[1])
camera2d.virtualToCanvas(clip_temp_wh,[x+w,y+h])
clip_temp_wh[0]=round(clip_temp_wh[0])-clip_temp_xy[0]
clip_temp_wh[1]=round(clip_temp_wh[1])-clip_temp_xy[1]
var gd_h=engine.render_height||engine.height
return[clip_temp_xy[0],gd_h-(clip_temp_xy[1]+clip_temp_wh[1]),clip_temp_wh[0],clip_temp_wh[1]]}function clipCoordsDom(x,y,w,h){var xywh=vec4()
camera2d.virtualToDom(xywh,[x+w,y+h])
xywh[2]=xywh[0]
xywh[3]=xywh[1]
camera2d.virtualToDom(xywh,[x,y])
xywh[0]=round(xywh[0])
xywh[1]=round(xywh[1])
xywh[2]=round(xywh[2])-xywh[0]
xywh[3]=round(xywh[3])-xywh[1]
return xywh}function spriteClip(z_start,z_end,x,y,w,h){var scissor=clipCoordsScissor(x,y,w,h)
spriteQueueFn(z_start-.01,function(){gl.enable(gl.SCISSOR_TEST)
gl.scissor(scissor[0],scissor[1],scissor[2],scissor[3])})
spriteQueueFn(z_end-.01,function(){gl.disable(gl.SCISSOR_TEST)})}var clip_stack=[]
function spriteClipped(){return clip_stack.length>0}function spriteClipPush(z,x,y,w,h){assert(clip_stack.length<10)
var scissor=clipCoordsScissor(x,y,w,h)
var dom_clip=clipCoordsDom(x,y,w,h)
camera2d.setInputClipping(dom_clip)
spriteQueuePush()
clip_stack.push({z:z,scissor:scissor,dom_clip:dom_clip})}function spriteClipPop(){assert(spriteClipped())
spriteQueueFn(Z.TOOLTIP-.1,function(){gl.disable(gl.SCISSOR_TEST)})
var _clip_stack$pop=clip_stack.pop(),z=_clip_stack$pop.z,scissor=_clip_stack$pop.scissor
var sprites=sprite_queue
spriteQueuePop(true)
if(clip_stack.length){var dom_clip=clip_stack[clip_stack.length-1].dom_clip
camera2d.setInputClipping(dom_clip)}else camera2d.setInputClipping(null)
spriteQueueFn(z,function(){gl.enable(gl.SCISSOR_TEST)
gl.scissor(scissor[0],scissor[1],scissor[2],scissor[3])
spriteQueuePush()
sprite_queue=sprites
spriteDraw()
spriteQueuePop()})}var clip_paused
function spriteClipPause(){assert(spriteClipped())
assert(!clip_paused)
clip_paused=true
spriteQueuePush(sprite_queue_stack[0])
camera2d.setInputClipping(null)
clip_stack.push({dom_clip:null})}function spriteClipResume(){assert(spriteClipped())
assert(clip_paused)
clip_stack.pop()
clip_paused=false
assert(spriteClipped())
var dom_clip=clip_stack[clip_stack.length-1].dom_clip
spriteQueuePop(true)
camera2d.setInputClipping(dom_clip)}var batch_state
var sprite_geom
var sprite_buffer
var sprite_buffer_len=0
var sprite_buffer_batch_start=0
var sprite_buffer_idx=0
var last_blend_mode
var last_bound_shader
var MAX_VERT_COUNT=65532
var batches=[]
function commit(){if(sprite_buffer_idx===sprite_buffer_batch_start)return
batches.push({state:batch_state,start:sprite_buffer_batch_start,end:sprite_buffer_idx})
sprite_buffer_batch_start=sprite_buffer_idx}function blendModeSet(blend){if(last_blend_mode!==blend)if((last_blend_mode=blend)===BLEND_ADDITIVE)gl.blendFunc(gl.SRC_ALPHA,gl.ONE)
else if(last_blend_mode===BLEND_PREMULALPHA)gl.blendFunc(gl.ONE,gl.ONE_MINUS_SRC_ALPHA)
else gl.blendFunc(gl.SRC_ALPHA,gl.ONE_MINUS_SRC_ALPHA)}function blendModeReset(force){if(last_blend_mode!==BLEND_ALPHA||force){gl.blendFunc(gl.SRC_ALPHA,gl.ONE_MINUS_SRC_ALPHA)
last_blend_mode=BLEND_ALPHA}}function commitAndFlush(){commit()
if(!batches.length)return
assert(sprite_buffer_idx)
sprite_geom.update(sprite_buffer,sprite_buffer_idx)
sprite_geom.bind()
for(var ii=0;ii<batches.length;++ii){var batch=batches[ii]
var state=batch.state,start=batch.start,end=batch.end
if(last_bound_shader!==state.shader||state.shader_params){shaders.bind(sprite_vshader,state.shader||sprite_fshader,state.shader_params||sprite_shader_params)
last_bound_shader=state.shader}if(last_blend_mode!==state.blend)blendModeSet(state.blend)
textures.bindArray(state.texs);++geom_stats.draw_calls_sprite
gl.drawElements(sprite_geom.mode,3*(end-start)/2,gl.UNSIGNED_SHORT,3*start)}batches.length=0
sprite_buffer_batch_start=sprite_buffer_idx=0}function drawSetup(){if(engine.defines.NOSPRITES)sprite_queue.length=0
if(!sprite_queue.length)return
clip_space[0]=2/engine.viewport[2]
clip_space[1]=-2/engine.viewport[3]
last_bound_shader=last_blend_mode=-1
if(!sprite_geom){sprite_geom=geom.create([[shaders.semantic.POSITION,gl.FLOAT,2,false],[shaders.semantic.COLOR,gl.FLOAT,4,false],[shaders.semantic.TEXCOORD,gl.FLOAT,2,false]],[],null,geom.QUADS)
sprite_buffer=new Float32Array(1024)
sprite_buffer_len=sprite_buffer.length/8}profilerStart("sort")
sprite_queue.sort(cmpSprite)
geom_stats.sprite_sort_elems+=sprite_queue.length
profilerStop("sort")
batch_state=null
assert.equal(sprite_buffer_idx,0)
assert.equal(sprite_buffer_batch_start,0)
assert.equal(batches.length,0)}function growSpriteBuffer(){var new_length=min(1.25*sprite_buffer_len+3&-4,MAX_VERT_COUNT)
sprite_buffer_len=new_length
sprite_buffer=new Float32Array(8*new_length)}function drawElem(elem){var count=0
if(elem.fn){commitAndFlush()
batch_state=null
elem.fn()
last_blend_mode=last_bound_shader=-1
assert.equal(sprite_buffer_idx,0)
assert.equal(sprite_buffer_batch_start,0)
assert.equal(batches.length,0)
clip_space[0]=2/engine.viewport[2]
clip_space[1]=-2/engine.viewport[3]
count++}else{if(!batch_state||cmpTextureArray(elem.texs,batch_state.texs)||elem.shader!==batch_state.shader||elem.shader_params!==batch_state.shader_params||elem.blend!==batch_state.blend){commit()
batch_state=elem}do{if(sprite_buffer_idx+4>sprite_buffer_len){commitAndFlush()
if(sprite_buffer_len!==MAX_VERT_COUNT)growSpriteBuffer()}var index=8*sprite_buffer_idx
sprite_buffer_idx+=4
sprite_buffer.set(elem.data,index)
count++
sprite_freelist.push(elem)
var next=elem.next
elem.next=null
elem=next}while(elem)}return count}function finishDraw(){commitAndFlush()
blendModeReset()}function spriteDraw(){profilerStart("sprites:draw")
drawSetup()
profilerStart("drawElem")
for(var ii=0;ii<sprite_queue.length;++ii)drawElem(sprite_queue[ii])
profilerStop("drawElem")
sprite_queue.length=0
finishDraw()
profilerStop("sprites:draw")}function spriteDrawPartial(z){profilerStart("sprites:drawPartial")
drawSetup()
profilerStart("drawElem")
for(var ii=0;ii<sprite_queue.length;++ii){var elem=sprite_queue[ii]
if(elem.z>z){sprite_queue=sprite_queue.slice(ii)
break}drawElem(elem)}profilerStop("drawElem")
finishDraw()
profilerStop("sprites:drawPartial")}function buildRects(ws,hs,tex){var rects=[]
var total_w=0
for(var ii=0;ii<ws.length;++ii)total_w+=ws[ii]
var total_h=0
for(var _ii=0;_ii<hs.length;++_ii)total_h+=hs[_ii]
var tex_w
var tex_h
if(!tex||nextHighestPowerOfTwo(tex.src_width)===tex.width&&nextHighestPowerOfTwo(tex.src_height)===tex.height){tex_w=nextHighestPowerOfTwo(total_w)
tex_h=nextHighestPowerOfTwo(total_h)}else{tex_w=total_w
tex_h=total_h}var wh=[]
for(var _ii2=0;_ii2<ws.length;++_ii2)wh.push(ws[_ii2]/total_h)
var hw=[]
for(var _ii3=0;_ii3<hs.length;++_ii3)hw.push(hs[_ii3]/total_w)
var aspect=[]
var non_square=false
var y=0
for(var jj=0;jj<hs.length;++jj){var x=0
for(var _ii4=0;_ii4<ws.length;++_ii4){var r=vec4(x/tex_w,y/tex_h,(x+ws[_ii4])/tex_w,(y+hs[jj])/tex_h)
rects.push(r)
var asp=ws[_ii4]/hs[jj]
if(1!==asp)non_square=true
aspect.push(asp)
x+=ws[_ii4]}y+=hs[jj]}return{widths:ws,heights:hs,wh:wh,hw:hw,rects:rects,aspect:non_square?aspect:null,total_w:total_w,total_h:total_h}}function Sprite(params){var _this=this
if(params.texs)this.texs=params.texs
else{var ext=params.ext||".png"
this.texs=[]
if(params.tex)this.texs.push(params.tex)
else if(params.layers){assert(params.name)
this.texs=[]
for(var ii=0;ii<params.layers;++ii)this.texs.push(textures.load({url:"img/"+params.name+"_"+ii+ext,filter_min:params.filter_min,filter_mag:params.filter_mag,wrap_s:params.wrap_s,wrap_t:params.wrap_t}))}else if(params.name)this.texs.push(textures.load({url:"img/"+params.name+ext,filter_min:params.filter_min,filter_mag:params.filter_mag,wrap_s:params.wrap_s,wrap_t:params.wrap_t}))
else{assert(params.url)
this.texs.push(textures.load(params))}}this.origin=params.origin||vec2(0,0)
this.size=params.size||vec2(1,1)
this.color=params.color||vec4(1,1,1,1)
this.uvs=params.uvs||vec4(0,0,1,1)
if(!params.uvs)this.texs[0].onLoad(function(tex){_this.uvs[2]=tex.src_width/tex.width
_this.uvs[3]=tex.src_height/tex.height})
if(params.ws){this.uidata=buildRects(params.ws,params.hs)
this.texs[0].onLoad(function(tex){_this.uidata=buildRects(params.ws,params.hs,tex)})}this.shader=params.shader||null}Sprite.prototype.draw=function(params){if(0===params.w||0===params.h)return null
var w=(params.w||1)*this.size[0]
var h=(params.h||1)*this.size[1]
var uvs="number"===typeof params.frame?this.uidata.rects[params.frame]:params.uvs||this.uvs
var color=params.color||this.color
qsp.sprite=this
qsp.x=params.x
qsp.y=params.y
qsp.z=params.z||Z.UI
qsp.w=w
qsp.h=h
qsp.rot=params.rot
qsp.uvs=uvs
qsp.color_ul=color
qsp.color_ll=color
qsp.color_lr=color
qsp.color_ur=color
qsp.shader=params.shader||this.shader
qsp.shader_params=params.shader_params
qsp.nozoom=params.nozoom
qsp.pixel_perfect=params.pixel_perfect
qsp.blend=params.blend
return queuesprite4colorObj(qsp)}
Sprite.prototype.drawDualTint=function(params){params.shader=sprite_dual_fshader
params.shader_params={color1:params.color1}
return this.draw(params)}
Sprite.prototype.draw4Color=function(params){if(0===params.w||0===params.h)return null
var w=(params.w||1)*this.size[0]
var h=(params.h||1)*this.size[1]
var uvs="number"===typeof params.frame?this.uidata.rects[params.frame]:params.uvs||this.uvs
qsp.sprite=this
qsp.x=params.x
qsp.y=params.y
qsp.z=params.z||Z.UI
qsp.w=w
qsp.h=h
qsp.rot=params.rot
qsp.uvs=uvs
qsp.color_ul=params.color_ul
qsp.color_ll=params.color_ll
qsp.color_lr=params.color_lr
qsp.color_ur=params.color_ur
qsp.shader=params.shader||this.shader
qsp.shader_params=params.shader_params
qsp.nozoom=params.nozoom
qsp.pixel_perfect=params.pixel_perfect
qsp.blend=params.blend
return queuesprite4colorObj(qsp)}
Sprite.prototype.draw3D=function(params){if("number"===typeof params.frame)params.uvs=this.uidata.rects[params.frame]
else if(!params.uvs)params.uvs=this.uvs
dynGeomQueueSprite(this,params)}
function spriteCreate(params){return new Sprite(params)}function spriteStartup(){geom_stats=geom.stats
clip_space[2]=-1
clip_space[3]=1
exports.sprite_vshader=sprite_vshader=shaders.create("shaders/sprite.vp")
exports.sprite_fshader=sprite_fshader=shaders.create("shaders/sprite.fp")
sprite_dual_fshader=shaders.create("shaders/sprite_dual.fp")
shaders.prelink(sprite_vshader,sprite_fshader)
shaders.prelink(sprite_vshader,sprite_dual_fshader)}

},{"../common/util.js":74,"../common/vmath.js":76,"./camera2d.js":7,"./dyn_geom.js":10,"./engine.js":13,"./geom.js":21,"./shaders.js":46,"./textures.js":55,"assert":undefined}],52:[function(require,module,exports){
"use strict"
exports.create=create
var assert=require("assert")
var _glovClientClient_config=require("./client_config")
var PLATFORM_FBINSTANT=_glovClientClient_config.PLATFORM_FBINSTANT
var _glovCommonChunked_send=require("../common/chunked_send")
var chunkedReceiverFinish=_glovCommonChunked_send.chunkedReceiverFinish
var chunkedReceiverFreeFile=_glovCommonChunked_send.chunkedReceiverFreeFile
var chunkedReceiverGetFile=_glovCommonChunked_send.chunkedReceiverGetFile
var chunkedReceiverInit=_glovCommonChunked_send.chunkedReceiverInit
var chunkedReceiverOnChunk=_glovCommonChunked_send.chunkedReceiverOnChunk
var chunkedReceiverStart=_glovCommonChunked_send.chunkedReceiverStart
var _glovCommonDotProp=require("../common/dot-prop")
var dot_prop=_glovCommonDotProp
var _glovCommonMd=require("../common/md5")
var md5=_glovCommonMd
var _glovCommonPacket=require("../common/packet")
var isPacket=_glovCommonPacket.isPacket
var _glovCommonPerfcounters=require("../common/perfcounters")
var perfCounterAdd=_glovCommonPerfcounters.perfCounterAdd
var _glovCommonTinyEvents=require("../common/tiny-events")
var EventEmitter=_glovCommonTinyEvents
var _glovCommonUtil=require("../common/util")
var util=_glovCommonUtil
var _glovCommonUtil2=require("../common/util")
var errorString=_glovCommonUtil2.errorString
var _fbinstant=require("./fbinstant")
var fbGetLoginInfo=_fbinstant.fbGetLoginInfo
var _local_storage=require("./local_storage")
var local_storage=_local_storage
var _net=require("./net")
var netDisconnectedRaw=_net.netDisconnectedRaw
var _walltime=require("./walltime")
var walltime=_walltime
function ClientChannelWorker(subs,channel_id,base_handlers,base_event_listeners){EventEmitter.call(this)
this.subs=subs
this.channel_id=channel_id
this.subscriptions=0
this.subscribe_failed=false
this.got_subscribe=false
this.immediate_subscribe=0
this.channel_data_ver=0
this.handlers=Object.create(base_handlers)
this.base_event_listeners=base_event_listeners
this.data={}}util.inherits(ClientChannelWorker,EventEmitter)
ClientChannelWorker.prototype.emit=function(event){var args=arguments
EventEmitter.prototype.emit.apply(this,args)
if(this.base_event_listeners){var listeners=this.base_event_listeners[event]
if(listeners)for(var ii=0;ii<listeners.length;++ii)listeners[ii].apply(this,Array.prototype.slice.call(args,1))}}
ClientChannelWorker.prototype.onSubscribe=function(cb){assert(this.subscriptions||this.autosubscribed)
this.on("subscribe",cb)
if(this.got_subscribe)cb(this.data)}
ClientChannelWorker.prototype.onceSubscribe=function(cb){assert(this.subscriptions||this.autosubscribed)
if(this.got_subscribe)cb(this.data)
else this.once("subscribe",cb)}
ClientChannelWorker.prototype.numSubscriptions=function(){return this.subscriptions}
ClientChannelWorker.prototype.handleChannelData=function(data,resp_func){var _this=this
console.log("got channel_data("+this.channel_id+"):  "+JSON.stringify(data))
this.data=data;++this.channel_data_ver
this.emit("channel_data",this.data)
this.got_subscribe=true
this.emit("subscribe",this.data)
var channel_type=this.channel_id.split(".")[0]
var cmd_list=this.subs.cmds_fetched_by_type
if(cmd_list&&!cmd_list[channel_type]){cmd_list[channel_type]=true
this.send("cmdparse","cmd_list",function(err,resp){if(err){console.error("Error getting cmd_list for "+channel_type)
delete cmd_list[channel_type]}else _this.subs.cmd_parse.addServerCommands(resp)})}resp_func()}
ClientChannelWorker.prototype.handleApplyChannelData=function(data,resp_func){if(void 0===data.value)dot_prop.delete(this.data,data.key)
else dot_prop.set(this.data,data.key,data.value);++this.channel_data_ver
this.emit("channel_data",this.data,data.key,data.value)
resp_func()}
ClientChannelWorker.prototype.handleBatchSet=function(data,resp_func){for(var ii=0;ii<data.length;++ii){var _data$ii=data[ii],key=_data$ii[0],value=_data$ii[1]
if(void 0===value)dot_prop.delete(this.data.public,key)
else dot_prop.set(this.data.public,key,value);++this.channel_data_ver
this.emit("channel_data",this.data,"public."+key,value)}resp_func()}
ClientChannelWorker.prototype.getChannelData=function(key,default_value){return dot_prop.get(this.data,key,default_value)}
ClientChannelWorker.prototype.setChannelData=function(key,value,skip_predict,resp_func){if(!skip_predict)dot_prop.set(this.data,key,value)
var q=value&&value.q||void 0
var pak=this.subs.client.pak("set_channel_data")
pak.writeAnsiString(this.channel_id)
pak.writeBool(q)
pak.writeAnsiString(key)
pak.writeJSON(value)
pak.send(resp_func)}
ClientChannelWorker.prototype.removeMsgHandler=function(msg,cb){assert(this.handlers[msg]===cb)
delete this.handlers[msg]}
ClientChannelWorker.prototype.onMsg=function(msg,cb){assert(!this.handlers[msg]||this.handlers[msg]===cb)
this.handlers[msg]=cb}
ClientChannelWorker.prototype.pak=function(msg){var pak=this.subs.client.pak("channel_msg")
pak.writeAnsiString(this.channel_id)
pak.writeAnsiString(msg)
return pak}
ClientChannelWorker.prototype.send=function(msg,data,resp_func,old_fourth){assert(!resp_func||"function"===typeof resp_func)
assert(!old_fourth)
this.subs.client.send("channel_msg",{channel_id:this.channel_id,msg:msg,data:data},resp_func)}
ClientChannelWorker.prototype.cmdParse=function(cmd,resp_func){this.send("cmdparse",cmd,resp_func)}
ClientChannelWorker.prototype.unsubscribe=function(){this.subs.unsubscribe(this.channel_id)}
function SubscriptionManager(client,cmd_parse){EventEmitter.call(this)
this.client=client
this.channels={}
this.logged_in=false
this.login_credentials=null
this.logged_in_username=null
this.logged_in_display_name=null
this.was_logged_in=false
this.logging_in=false
this.logging_out=false
this.auto_create_user=false
this.allow_anon=false
this.no_auto_login=false
if(this.cmd_parse=cmd_parse)this.cmds_fetched_by_type={}
this.base_handlers={}
this.channel_handlers={}
this.channel_event_listeners={}
this.first_connect=true
this.server_time=0
this.server_time_interp=0
this.cack_data={}
client.onMsg("connect",this.handleConnect.bind(this))
client.onMsg("disconnect",this.handleDisconnect.bind(this))
client.onMsg("channel_msg",this.handleChannelMessage.bind(this))
client.onMsg("server_time",this.handleServerTime.bind(this))
client.onMsg("chat_broadcast",this.handleChatBroadcast.bind(this))
client.onMsg("restarting",this.handleRestarting.bind(this))
if(cmd_parse)client.onMsg("csr_to_client",this.handleCSRToClient.bind(this))
this.chunked=null
client.onMsg("upload_start",this.handleUploadStart.bind(this))
client.onMsg("upload_chunk",this.handleUploadChunk.bind(this))
client.onMsg("upload_finish",this.handleUploadFinish.bind(this))
this.onChannelMsg(null,"channel_data",ClientChannelWorker.prototype.handleChannelData)
this.onChannelMsg(null,"apply_channel_data",ClientChannelWorker.prototype.handleApplyChannelData)
this.onChannelMsg(null,"batch_set",ClientChannelWorker.prototype.handleBatchSet)}util.inherits(SubscriptionManager,EventEmitter)
SubscriptionManager.prototype.onceConnected=function(cb){if(this.client.connected&&1===this.client.socket.readyState)return void cb()
this.once("connect",cb)}
SubscriptionManager.prototype.getBaseHandlers=function(channel_type){var handlers=this.channel_handlers[channel_type]
if(!handlers)handlers=this.channel_handlers[channel_type]=Object.create(this.base_handlers)
return handlers}
SubscriptionManager.prototype.onChannelMsg=function(channel_type,msg,cb){var handlers=channel_type?this.getBaseHandlers(channel_type):this.base_handlers
assert(!handlers[msg])
handlers[msg]=cb}
SubscriptionManager.prototype.onChannelEvent=function(channel_type,event,cb){var listeners=this.channel_event_listeners[channel_type]
if(!listeners)listeners=this.channel_event_listeners[channel_type]={}
if(!listeners[event])listeners[event]=[]
listeners[event].push(cb)}
SubscriptionManager.prototype.handleChatBroadcast=function(data){console.error("["+data.src+"] "+data.msg)
this.emit("chat_broadcast",data)}
SubscriptionManager.prototype.handleRestarting=function(data){this.restarting=data
this.emit("restarting",data)}
SubscriptionManager.prototype.handleDisconnect=function(data){this.emit("disconnect",data)}
SubscriptionManager.prototype.handleConnect=function(data){var _this2=this
var reconnect=false
if(this.first_connect)this.first_connect=false
else reconnect=true
this.restarting=Boolean(data.restarting)
this.cack_data=data
walltime.sync(data.time)
if(netDisconnectedRaw())return
var subs=this
function resub(){var _loop=function _loop(channel_id){var channel=subs.channels[channel_id]
if(channel.subscriptions)subs.client.send("subscribe",channel_id,function(err){if(err){channel.subscribe_failed=true
console.error("Error subscribing to "+channel_id+": "+err)
channel.emit("subscribe_fail",err)}})}
for(var channel_id in subs.channels)_loop(channel_id)
subs.emit("connect",reconnect)}if(this.logging_in);else if(this.was_logged_in)this.loginInternal(this.login_credentials,function(err){if(err&&"ERR_FAILALL_DISCONNECT"===err);else if(err){var credentials_str=_this2.login_credentials&&_this2.login_credentials.password?"user_id, password":JSON.stringify(_this2.login_credentials)
assert(false,"Login failed for "+credentials_str+": "+errorString(err))}else resub()})
else if(!this.no_auto_login){if(PLATFORM_FBINSTANT){var login_cb=function login_cb(){}
if(PLATFORM_FBINSTANT)this.loginFacebook(login_cb)}else if(local_storage.get("name")&&local_storage.get("password"))this.login(local_storage.get("name"),local_storage.get("password"),function(){})
resub()}else resub()
this.fetchCmds()}
SubscriptionManager.prototype.fetchCmds=function(){var _this3=this
var channel_type="client"
var cmd_list=this.cmds_fetched_by_type
if(cmd_list&&!cmd_list[channel_type]){cmd_list[channel_type]=true
this.client.send("cmd_parse_list_client",null,function(err,resp){if(!err)_this3.cmd_parse.addServerCommands(resp)})}}
SubscriptionManager.prototype.handleChannelMessage=function(pak,resp_func){assert(isPacket(pak))
var channel_id=pak.readAnsiString()
var msg=pak.readAnsiString()
var is_packet=pak.readBool()
var data=is_packet?pak:pak.readJSON()
if(!data||!data.q){var debug_msg
if(!is_packet)debug_msg=JSON.stringify(data)
else if("function"===typeof data.contents)debug_msg=data.contents()
else debug_msg="(pak)"
console.log("got channel_msg("+channel_id+") "+msg+": "+debug_msg)}var channel=this.getChannel(channel_id)
var handler=channel.handlers[msg]
if(!handler){console.error("no handler for channel_msg("+channel_id+") "+msg+": "+JSON.stringify(data))
return}var msg_name=channel_id.split(".")[0]+"."+msg
perfCounterAdd("cm."+msg_name)
profilerStart(msg_name)
handler.call(channel,data,resp_func)
profilerStop(msg_name)}
SubscriptionManager.prototype.handleServerTime=function(pak){this.server_time=pak.readInt()
if(this.server_time<this.server_time_interp&&this.server_time>this.server_time_interp-250);else this.server_time_interp=this.server_time
walltime.sync(pak.readInt())}
SubscriptionManager.prototype.getServerTime=function(){return this.server_time_interp}
SubscriptionManager.prototype.tick=function(dt){this.server_time_interp+=dt
for(var channel_id in this.channels){var channel=this.channels[channel_id]
if(channel.immediate_subscribe)if(dt>=channel.immediate_subscribe){channel.immediate_subscribe=0
this.unsubscribe(channel_id)}else channel.immediate_subscribe-=dt}}
SubscriptionManager.prototype.onUploadProgress=function(mime_type,cb){var _this4=this
if(!this.upload_progress_cbs)this.upload_progress_cbs={}
assert(!this.upload_progress_cbs[mime_type])
this.upload_progress_cbs[mime_type]=cb
if(!this.chunked)this.chunked=chunkedReceiverInit("client_receive",Infinity)
if(!this.chunked.on_progress)this.chunked.on_progress=function(progress,total,type){if(_this4.upload_progress_cbs[type])_this4.upload_progress_cbs[type](progress,total)}}
SubscriptionManager.prototype.handleUploadStart=function(pak,resp_func){if(!this.chunked)this.chunked=chunkedReceiverInit("client_receive",Infinity)
chunkedReceiverStart(this.chunked,pak,resp_func)}
SubscriptionManager.prototype.handleUploadChunk=function(pak,resp_func){chunkedReceiverOnChunk(this.chunked,pak,resp_func)}
SubscriptionManager.prototype.handleUploadFinish=function(pak,resp_func){chunkedReceiverFinish(this.chunked,pak,resp_func)}
SubscriptionManager.prototype.uploadGetFile=function(file_id){return chunkedReceiverGetFile(this.chunked,file_id)}
SubscriptionManager.prototype.uploadFreeFile=function(file_data){return chunkedReceiverFreeFile(file_data)}
SubscriptionManager.prototype.subscribe=function(channel_id){this.getChannel(channel_id,true)}
SubscriptionManager.prototype.getChannel=function(channel_id,do_subscribe){var channel=this.channels[channel_id]
if(!channel){var channel_type=channel_id.split(".")[0]
var handlers=this.getBaseHandlers(channel_type)
var event_listeners=this.channel_event_listeners[channel_type]
channel=this.channels[channel_id]=new ClientChannelWorker(this,channel_id,handlers,event_listeners)}if(do_subscribe){channel.subscriptions++
if(!netDisconnectedRaw()&&1===channel.subscriptions){channel.subscribe_failed=false
this.client.send("subscribe",channel_id,function(err){if(err){channel.subscribe_failed=true
console.error("Error subscribing to "+channel_id+": "+err)
channel.emit("subscribe_fail",err)}})}}return channel}
SubscriptionManager.prototype.getUserId=function(){return this.loggedIn()}
SubscriptionManager.prototype.getDisplayName=function(){return this.logged_in_display_name}
SubscriptionManager.prototype.getMyUserChannel=function(){var user_id=this.loggedIn()
if(!user_id)return null
var channel=this.getChannel("user."+user_id)
if(!this.logging_out)channel.autosubscribed=true
return channel}
SubscriptionManager.prototype.unsubscribe=function(channel_id){var channel=this.channels[channel_id]
assert(channel)
assert(channel.subscriptions)
channel.subscriptions--
if(!channel.subscriptions)channel.got_subscribe=false
if(!netDisconnectedRaw()&&!channel.subscriptions&&!channel.subscribe_failed)this.client.send("unsubscribe",channel_id)}
SubscriptionManager.prototype.getChannelImmediate=function(channel_id,timeout){timeout=timeout||6e4
var channel=this.getChannel(channel_id)
if(!channel.immediate_subscribe)this.subscribe(channel_id)
channel.immediate_subscribe=timeout
return channel}
SubscriptionManager.prototype.onLogin=function(cb){this.on("login",cb)
if(this.logged_in)return void cb()}
SubscriptionManager.prototype.loggedIn=function(){return this.logging_out?false:this.logged_in?this.logged_in_username||"missing_name":false}
SubscriptionManager.prototype.userOnChannelData=function(expected_user_id,data,key,value){if(expected_user_id!==this.getUserId())return
if("public.display_name"===key)this.logged_in_display_name=value}
SubscriptionManager.prototype.handleLoginResponse=function(resp_func,err,resp){var _this5=this
this.logging_in=false
if(!err){this.logged_in_username=resp.user_id
this.logged_in_display_name=resp.display_name
this.logged_in=true
this.was_logged_in=true
var user_channel=this.getMyUserChannel()
user_channel.onceSubscribe(function(){if(!_this5.did_master_subscribe&&user_channel.getChannelData("public.permissions.sysadmin")){_this5.did_master_subscribe=true
_this5.subscribe("master.master")
_this5.subscribe("global.global")}})
if(!user_channel.subs_added_user_on_channel_data){user_channel.on("channel_data",this.userOnChannelData.bind(this,this.logged_in_username))
user_channel.subs_added_user_on_channel_data=true}this.emit("login")}else this.emit("login_fail",err)
resp_func(err)}
SubscriptionManager.prototype.loginInternal=function(login_credentials,resp_func){var _this6=this
if(this.logging_in)return void resp_func("Login already in progress")
this.logging_in=true
this.logged_in=false
if(login_credentials.fb)fbGetLoginInfo(function(err,result){if(err)return void _this6.handleLoginResponse(resp_func,err)
if(netDisconnectedRaw())return void _this6.handleLoginResponse(resp_func,"ERR_DISCONNECTED")
_this6.client.send("login_facebook_instant",result,_this6.handleLoginResponse.bind(_this6,resp_func))})
else this.client.send("login",{user_id:login_credentials.user_id,password:md5(this.client.secret+login_credentials.password)},this.handleLoginResponse.bind(this,resp_func))}
SubscriptionManager.prototype.userCreateInternal=function(params,resp_func){if(this.logging_in)return resp_func("Login already in progress")
this.logging_in=true
this.logged_in=false
return this.client.send("user_create",params,this.handleLoginResponse.bind(this,resp_func))}
function hashedPassword(user_id,password){if("prehashed"===password.split("$$")[0])password=password.split("$$")[1]
else password=md5(md5(user_id.toLowerCase())+password)
return password}SubscriptionManager.prototype.login=function(username,password,resp_func){var _this7=this
if(!(username=(username||"").trim()))return resp_func("Missing username")
if(!(password=(password||"").trim()))return resp_func("Missing password")
var hashed_password=hashedPassword(username,password)
if(hashed_password!==password)local_storage.set("password","prehashed$$"+hashed_password)
this.login_credentials={user_id:username,password:hashed_password}
if(!this.auto_create_user)return this.loginInternal(this.login_credentials,resp_func)
return this.loginInternal(this.login_credentials,function(err,data){if(!err||"ERR_USER_NOT_FOUND"!==err)return void resp_func(err,data)
_this7.userCreate({user_id:username,password:password,password_confirm:password,email:"autocreate@glovjs.org"},resp_func)})}
SubscriptionManager.prototype.loginFacebook=function(resp_func){this.login_credentials={fb:true}
return this.loginInternal(this.login_credentials,resp_func)}
SubscriptionManager.prototype.userCreate=function(params,resp_func){params.user_id=(params.user_id||"").trim()
if(!params.user_id)return resp_func("Missing username")
params.password=(params.password||"").trim()
if(!params.password)return resp_func("Missing password")
params.password_confirm=(params.password_confirm||"").trim()
if(!this.auto_create_user&&!params.password_confirm)return resp_func("Missing password confirmation")
params.email=(params.email||"").trim()
if(!this.auto_create_user&&!params.email)return resp_func("Missing email")
params.display_name=(params.display_name||"").trim()
var hashed_password=hashedPassword(params.user_id,params.password)
if(hashed_password!==params.password)local_storage.set("password","prehashed$$"+hashed_password)
if(hashed_password!==hashedPassword(params.user_id,params.password_confirm))return resp_func("Passwords do not match")
this.login_credentials={user_id:params.user_id,password:hashed_password}
return this.userCreateInternal({display_name:params.display_name||params.user_id,user_id:params.user_id,email:params.email,password:hashed_password},resp_func)}
SubscriptionManager.prototype.logout=function(){var _this8=this
assert(this.logged_in)
assert(!this.logging_in)
assert(!this.logging_out)
if(this.did_master_subscribe){this.did_master_subscribe=false
this.unsubscribe("master.master")
this.unsubscribe("global.global")}for(var channel_id in this.channels){var channel=this.channels[channel_id]
if(channel.immediate_subscribe){channel.immediate_subscribe=0
this.unsubscribe(channel_id)}assert(!channel.subscriptions,"Remaining active subscription for "+channel_id)
if(channel.autosubscribed)channel.autosubscribed=false}this.logging_out=true
this.client.send("logout",null,function(err){_this8.logging_out=false
if(!err){local_storage.set("password",void 0)
_this8.logged_in=false
_this8.logged_in_username=null
_this8.logged_in_display_name=null
_this8.was_logged_in=false
_this8.login_credentials=null
_this8.emit("logout")}})}
SubscriptionManager.prototype.serverLog=function(type,data){var _this9=this
this.onceConnected(function(){_this9.client.send("log",{type:type,data:data})})}
SubscriptionManager.prototype.sendCmdParse=function(command,resp_func){var _this10=this
this.onceConnected(function(){var pak=_this10.client.pak("cmd_parse_auto")
pak.writeString(command)
pak.send(resp_func)})}
SubscriptionManager.prototype.handleCSRToClient=function(pak,resp_func){var _this11=this
var cmd=pak.readString()
var access=pak.readJSON()
this.cmd_parse.handle({access:access},cmd,function(err,resp){if(err&&_this11.cmd_parse.was_not_found)return resp_func(null,{found:0,err:err})
return resp_func(err,{found:1,resp:resp})})}
function create(client,cmd_parse){return new SubscriptionManager(client,cmd_parse)}

},{"../common/chunked_send":64,"../common/dot-prop":67,"../common/md5":70,"../common/packet":71,"../common/perfcounters":72,"../common/tiny-events":73,"../common/util":74,"./client_config":8,"./fbinstant":16,"./local_storage":31,"./net":35,"./walltime":59,"assert":undefined}],53:[function(require,module,exports){
"use strict"
exports.ansi=void 0
exports.padLeft=padLeft
exports.padRight=padRight
exports.terminalCreate=terminalCreate
var _assert=require("assert")
var assert=_assert
var abs=Math.abs,floor=Math.floor,max=Math.max,min=Math.min
var _glovCommonUtilJs=require("../common/util.js")
var clamp=_glovCommonUtilJs.clamp
var _glovCommonVmathJs=require("../common/vmath.js")
var vec4=_glovCommonVmathJs.vec4
var _engineJs=require("./engine.js")
var engine=_engineJs
var _fontJs=require("./font.js")
var glov_font=_fontJs
var _inputJs=require("./input.js")
var input=_inputJs
var _uiJs=require("./ui.js")
var ui=_uiJs
Z.BACKGROUND=Z.BACKGROUND||1
var KEYS=input.KEYS
var mode_regex1=/^((?:[0-9]+;)*[0-9]+m)/
var mode_regex2=/([0-9]+)[;m]/g
var ESC=""
var ansi_to_unicode=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,199,252,233,226,228,224,229,231,234,235,232,239,238,236,196,197,201,230,198,244,246,242,251,249,255,214,220,162,163,165,8359,402,225,237,243,250,241,209,170,186,191,8976,172,189,188,161,171,187,9617,9618,9619,9474,9508,9569,9570,9558,9557,9571,9553,9559,9565,9564,9563,9488,9492,9524,9516,9500,9472,9532,9566,9567,9562,9556,9577,9574,9568,9552,9580,9575,9576,9572,9573,9561,9560,9554,9555,9579,9578,9496,9484,9608,9604,9612,9616,9600,945,223,915,960,931,963,181,964,934,920,937,948,8734,966,949,8745,8801,177,8805,8804,8992,8993,247,8776,176,8729,183,8730,8319,178,9632,160]
var MOD_CH=1
var MOD_SCROLL=2
var MOD_CLEAR=3
var MOD_CLEAREOL=4
var ansi_to_vga=[0,4,2,6,1,5,3,7]
function toch(ch){if("string"===typeof ch){var idx=ch.charCodeAt(0)
if(ansi_to_unicode[idx])return String.fromCharCode(ansi_to_unicode[idx])
else return ch}if("number"===typeof ch)return String.fromCharCode(ansi_to_unicode[ch]||ch)
else return String(ch)[0]||" "}var ATTR={BLINK:1,UNDERLINE:2,REVERSE:4,NUM_BITS:3}
var CharInfo=function CharInfo(fg,bg,attr){this.ch=" "
this.fg=fg
this.bg=bg
this.attr=attr}
var GlovTerminal=function(){function GlovTerminal(params){var _params$baud,_params$draw_cursor,_params$auto_scroll
this.baud=null!=(_params$baud=(params=params||{}).baud)?_params$baud:9600
this.frame=0
this.draw_cursor=null!=(_params$draw_cursor=params.draw_cursor)?_params$draw_cursor:[1,4]
this.render_x=params.x||0
this.render_y=params.y||0
this.render_z=params.z||Z.BACKGROUND
this.w=params.w||80
this.h=params.h||25
this.x=0
this.y=0
this.fg=7
this.bg=0
this.attr=0
this.saved_x=0
this.saved_y=0
this.playback={x:0,y:0,fg:7,bg:0,attr:0}
this.mod_head=null
this.mod_tail=null
this.mod_countdown=0
this.sub_view=null
this.x0=0
this.y0=0
this.x1=this.w
this.y1=this.h
this.palette=params.palette||[vec4(0,0,0,1),vec4(0,0,42/63,1),vec4(0,42/64,0,1),vec4(0,42/64,42/63,1),vec4(42/64,0,0,1),vec4(42/64,0,42/63,1),vec4(42/64,21/64,0,1),vec4(42/64,42/64,42/63,1),vec4(18/64,18/64,18/63,1),vec4(21/64,21/64,1,1),vec4(21/64,63/64,21/63,1),vec4(21/64,63/64,1,1),vec4(63/64,21/64,21/63,1),vec4(63/64,21/64,1,1),vec4(63/64,63/64,21/63,1),vec4(63/64,63/64,1,1)]
this.font_styles=[]
for(var ii=0;ii<this.palette.length;++ii)this.font_styles.push(glov_font.style(null,{color:glov_font.intColorFromVec4Color(this.palette[ii])}))
this.char_width=params.char_width||9
this.char_height=params.char_height||16
this.font=params.font||engine.font
this.auto_scroll=null!=(_params$auto_scroll=params.auto_scroll)?_params$auto_scroll:true
this.buffer=new Array(this.h)
this.prebuffer=new Array(this.h)
for(var _ii=0;_ii<this.h;++_ii){this.buffer[_ii]=new Array(this.w)
this.prebuffer[_ii]=new Array(this.w)
for(var jj=0;jj<this.w;++jj){this.buffer[_ii][jj]=new CharInfo(this.fg,this.bg,this.attr)
this.prebuffer[_ii][jj]=new CharInfo(this.fg,this.bg,this.attr)}}}var _proto=GlovTerminal.prototype
_proto.domod=function domod(buffer,mod){var mod_playback=buffer===this.buffer
switch(mod.type){case MOD_CH:buffer[mod.y][mod.x].ch=mod.ch
buffer[mod.y][mod.x].attr=mod.attr
buffer[mod.y][mod.x].fg=mod.fg
buffer[mod.y][mod.x].bg=mod.bg
if(mod_playback){this.playback.x=mod.x+1
this.playback.y=mod.y}break
case MOD_SCROLL:if(mod.sub_view){var x1=mod.sub_view.x+mod.sub_view.w
var y1=mod.sub_view.y+mod.sub_view.h
for(var yy=mod.sub_view.y;yy<y1-1;++yy){var rout=buffer[yy]
var rin=buffer[yy+1]
for(var xx=mod.sub_view.x;xx<x1;++xx)rout[xx]=rin[xx]}var row=buffer[y1-1]
for(var _xx=mod.sub_view.x;_xx<x1;++_xx)row[_xx]=new CharInfo(mod.fg,mod.bg,0)}else{var _row=buffer[0]
buffer.splice(0,1)
buffer.push(_row)
for(var ii=0;ii<_row.length;++ii){_row[ii].fg=mod.fg
_row[ii].bg=mod.bg
_row[ii].ch=" "
_row[ii].attr=0}}break
case MOD_CLEAR:if(mod.sub_view)for(var _ii2=mod.sub_view.y;_ii2<mod.sub_view.y+mod.sub_view.h;++_ii2){var line=buffer[_ii2]
for(var jj=mod.sub_view.x;jj<mod.sub_view.x+mod.sub_view.w;++jj){line[jj].attr=mod.attr
line[jj].fg=mod.fg
line[jj].bg=mod.bg
line[jj].ch=" "}}else for(var _ii3=0;_ii3<this.h;++_ii3){var _line=buffer[_ii3]
for(var _jj=0;_jj<this.w;++_jj){_line[_jj].attr=mod.attr
_line[_jj].fg=mod.fg
_line[_jj].bg=mod.bg
_line[_jj].ch=" "}}if(mod_playback)this.playback.x=this.playback.y=0
break
case MOD_CLEAREOL:assert(!mod.sub_view)
var _line2=buffer[mod.y]
for(var _jj2=mod.x;_jj2<this.w;++_jj2){_line2[_jj2].ch=" "
_line2[_jj2].attr=0
_line2[_jj2].fg=mod.fg
_line2[_jj2].bg=mod.bg}if(mod_playback){this.playback.x=this.w
this.playback.y=mod.y}}if(mod_playback){this.playback.timestamp=engine.getFrameTimestamp()
if(this.playback.x>=this.w){this.playback.x=0
this.playback.y++}if(this.playback.y>=this.h)this.playback.y=this.h-1}}
_proto.mod=function mod(type,ch){var mod={type:type,ch:ch,x:this.x,y:this.y,fg:this.fg,bg:this.bg,attr:this.attr,sub_view:this.sub_view}
if(type===MOD_CH){var char_info=this.prebuffer[mod.y][mod.x]
if(char_info.ch===ch&&char_info.fg===mod.fg&&char_info.bg===mod.bg&&char_info.attr===mod.attr)return}this.domod(this.prebuffer,mod)
if(!this.baud){this.domod(this.buffer,mod)
return}if(this.mod_tail){this.mod_tail.next=mod
this.mod_tail=mod}else this.mod_head=this.mod_tail=mod}
_proto.normal=function normal(){this.color(7,0)
this.attr=0}
_proto.color=function color(fg,bg){if("number"===typeof fg)this.fg=fg
if("number"===typeof bg)this.bg=bg}
_proto.moveto=function moveto(x,y){if("number"===typeof x)this.x=this.x0+x
if("number"===typeof y)this.y=this.y0+y
this.checkwrap()}
_proto.offset=function offset(x,y){if("number"===typeof x)this.x+=x
if("number"===typeof y)this.y+=y
this.checkwrap()}
_proto.autoScroll=function autoScroll(b){this.auto_scroll=b}
_proto.checkwrap=function checkwrap(){if(this.x<this.x0)this.x=this.x0
if(this.x>=this.x1){this.x=this.x0
this.y++}if(this.y>=this.y1){this.y=this.y1-1
if(this.auto_scroll)this.mod(MOD_SCROLL)}}
_proto.cr=function cr(){this.x=this.x0
this.checkwrap()}
_proto.lf=function lf(){this.y++
this.checkwrap()}
_proto.crlf=function crlf(){this.x=this.x0
this.y++
this.checkwrap()}
_proto.clear=function clear(){this.moveto(0,0)
this.mod(MOD_CLEAR)}
_proto.cleareol=function cleareol(){this.mod(MOD_CLEAREOL)
this.x=this.w
this.checkwrap()}
_proto.subViewPush=function subViewPush(sub_view){assert(!this.sub_view)
if(sub_view.cursor_x)this.moveto(sub_view.cursor_x,sub_view.cursor_y)
this.sub_view=sub_view
this.x0=sub_view.x||0
this.y0=sub_view.y||0
this.x1=sub_view.x+sub_view.w
this.y1=sub_view.y+sub_view.h}
_proto.subViewPop=function subViewPop(){assert(this.sub_view)
this.sub_view.cursor_x=this.x
this.sub_view.cursor_y=this.y
this.sub_view=null
this.x0=this.y0=0
this.x1=this.w
this.y1=this.h}
_proto.print=function print(params){this.moveto(params.x,params.y)
this.color(params.fg,params.bg)
var text=params.text||""
if(text&&!text.length)text=[text]
if("string"===typeof text)text=text.split("")
text=text.map(toch).join("")
for(var ii=0;ii<text.length;){var ch=text[ii]
var handled=false
if(ch===ESC&&"["===text[ii+1]){handled=true
var code=text.slice(ii+2,ii+12)
var m=void 0
if(code.match(/^\?7h/))ii+=5
else if(code.match(/^2J/)){this.clear()
ii+=4}else if(code.match(/^s/)){this.saved_x=this.x
this.saved_y=this.y
ii+=3}else if(code.match(/^u/)){this.moveto(this.saved_x,this.saved_y)
ii+=3}else if(code.match(/^K/)){this.cleareol()
ii+=3}else if(m=code.match(/^([0-9]*)A/)){this.offset(null,-Number(m[1]||"1"))
ii+=m[0].length+2}else if(m=code.match(/^([0-9]*)B/)){this.offset(null,Number(m[1]||"1"))
ii+=m[0].length+2}else if(m=code.match(/^([0-9]*)C/)){this.offset(Number(m[1]||"1"),null)
ii+=m[0].length+2}else if(m=code.match(/^([0-9]*)D/)){this.offset(-Number(m[1]||"1"),null)
ii+=m[0].length+2}else if(m=code.match(/^([0-9]+)(?:;([0-9]+))?(H|f)/)){this.moveto(Number(m[2]||"1")-1,Number(m[1])-1)
ii+=m[0].length+2}else if(m=code.match(mode_regex1)){var ii_save=ii
ii+=m[0].length+2
var sub_str=m[1]
m=mode_regex2.exec(sub_str)
do{var sub_code=Number(m[1])
if(sub_code>=40)this.color(null,ansi_to_vga[sub_code-40])
else if(sub_code>=30)this.color(ansi_to_vga[sub_code-30]+(this.fg>=8?8:0),null)
else if(1===sub_code){if(this.fg<8)this.fg+=8}else if(0===sub_code){this.normal()
this.color(params.fg,params.bg)}else if(4===sub_code)this.attr|=ATTR.UNDERLINE
else if(5===sub_code)this.attr|=ATTR.BLINK
else if(7===sub_code)this.attr|=ATTR.REVERSE
else{handled=false
ii=ii_save}m=mode_regex2.exec(sub_str)}while(m)}else handled=false}else if("\n"===ch){handled=true;++ii
this.lf()}else if("\r"===ch){handled=true;++ii
this.cr()}if(!handled){if(this.x>=0&&this.x<this.w&&this.y>=0&&this.y<this.h)this.mod(MOD_CH,ch);++this.x
this.checkwrap();++ii}}}
_proto.fill=function fill(params){var x=params.x||0
var y=params.y||0
var w=params.w||this.w
var h=params.h||this.h
this.color(params.fg,params.bg)
var eff_w=this.sub_view?this.sub_view.w:this.w
var eff_h=this.sub_view?this.sub_view.h:this.h
var x0=clamp(x,0,eff_w)
var x1=clamp(x+w,0,eff_w)
var y0=clamp(y,0,eff_h)
var y1=clamp(y+h,0,eff_h)
var ch=toch(params.ch||" ")
for(var ii=y0;ii<y1;++ii){this.moveto(x0,ii)
for(var jj=x0;jj<x1;++jj){this.mod(MOD_CH,ch)
this.x++}}}
_proto.ansiCharsTo=function ansiCharsTo(mod){var count=0
var m=false
if(mod.fg!==this.playback.fg){this.playback.fg=mod.fg
m=true
count+=3}if(mod.bg!==this.playback.bg){this.playback.bg=mod.bg
m=true
count+=3}if(mod.attr!==this.playback.attr){m=true
var clear=0
var add=0
for(var ii=0;ii<ATTR.NUM_BITS;++ii){var bit=1<<ii
if((this.playback.attr&bit)!==(mod.attr&bit))if(mod.attr&bit)add++
else clear=1}count+=2*(add+clear)}if(m)count+=2
switch(mod.type){case MOD_SCROLL:return count
case MOD_CLEAR:return count+4}var dx=mod.x-this.playback.x
var dy=mod.y-this.playback.y
if(dx||dy){var horiz=dx?3+(1===dx?0:(abs(dx)>=10?2:1)+(dx<0?1:0)):0
var vert=dy?3+(1===dy?0:(abs(dy)>=10?2:1)+(dy<0?1:0)):0
var setpos=4+(mod.x?mod.x>10?2:1:0)+(mod.y?mod.y>10?2:1:0)
count+=min(horiz+vert,setpos)}switch(mod.type){case MOD_CH:return count+1
case MOD_CLEAREOL:return count+3}return count}
_proto.cells=function cells(params){var x=params.x,y=params.y,ws=params.ws,hs=params.hs,header=params.header
var charset=["â”‚â”€â”Œâ”¬â”â””â”´â”˜â”œâ”¼â”¤","â•‘â•â•”â•¦â•—â•šâ•©â•â• â•¬â•£","â”‚â•â•’â•¤â••â•˜â•§â•›â•žâ•ªâ•¡","â•‘â”€â•“â•¥â•–â•™â•¨â•œâ•Ÿâ•«â•¢"][params.charset||0]
var terminal=this
function drawHorizLine(base,text_list){var line=[charset[base]]
if(!Array.isArray(text_list))text_list=[text_list]
for(var jj=0;jj<ws.length;++jj){var w=ws[jj]
var text=text_list[jj]
if(text){var extra=w-text.length
var left=floor(extra/2)
var right=extra-left
for(var kk=0;kk<left;++kk)line.push(charset[1])
if(params.header_format)line.push(params.header_format)
line.push(text)
if(params.header_format)line.push("[0m")
for(var _kk=0;_kk<right;++_kk)line.push(charset[1])}else for(var _kk2=0;_kk2<w;++_kk2)line.push(charset[1])
if(jj!==ws.length-1)line.push(charset[base+1])
else line.push(charset[base+2])}terminal.print({x:x,y:y,text:line.join("")})
y++}drawHorizLine(2,header)
for(var ii=0;ii<hs.length;++ii){var h=hs[ii]
for(var jj=0;jj<h;++jj){var xx=x+1
this.print({x:x,y:y,text:charset[0]})
for(var kk=0;kk<ws.length;++kk){xx+=ws[kk]
this.print({x:xx,y:y,text:charset[0]})
xx++}y++}if(ii!==hs.length-1)drawHorizLine(8)
else drawHorizLine(5)}}
_proto.menu=function menu(params){var x=params.x,y=params.y,items=params.items
var color_sel=params.color_sel||{fg:15,bg:8}
var color_unsel=params.color_unsel||{fg:7,bg:0}
var color_execute=params.color_execute||{fg:8,bg:0}
var pre_sel=params.pre_sel||"â–  "
var pre_unsel=params.pre_unsel||"  "
var post_sel=params.post_sel||""
var post_unsel=params.post_unsel||""
var menu_key=params.key||x+"_"+y+"_"+items.join()
if(this.last_menu_frame!==this.frame-1||this.last_menu_key!==menu_key)this.menu_idx=params.def_idx||0
this.last_menu_frame=this.frame
this.last_menu_key=menu_key
if(input.keyDownEdge(KEYS.DOWN)||input.keyDownEdge(KEYS.S))this.menu_idx++
if(input.keyDownEdge(KEYS.UP)||input.keyDownEdge(KEYS.W))this.menu_idx--
if(input.keyDownEdge(KEYS.HOME))this.menu_idx=0
if(input.keyDownEdge(KEYS.END))this.menu_idx=items.length-1
var max_w=0
for(var ii=0;ii<items.length;++ii){var item=items[ii]
if("object"===typeof item)item=item.label
max_w=max(max_w,item.length)}max_w+=pre_sel.length+post_sel.length
var ret=-1
this.menu_select_delta=1
for(var _ii4=0;_ii4<items.length;++_ii4){var _item=items[_ii4]
var effx=x
var effy=y+_ii4
var hotkey=void 0
if("object"===typeof _item){effx=_item.x
effy=_item.y
hotkey=_item.hotkey
_item=_item.label}if(!hotkey){var m=_item.match(/\[([0-9A-Z])\]/)
if(m)hotkey=m[1]}var param={x:this.render_x+effx*this.char_width,y:this.render_y+effy*this.char_height,w:max_w*this.char_width,h:this.char_height}
var click=void 0
if(click=input.click(param)){if(2===click.button)this.menu_select_delta=-1
ret=this.menu_idx=_ii4}else if(input.mouseMoved()&&input.mouseOver(param))this.menu_idx=_ii4
if(hotkey&&input.keyDownEdge(KEYS.A+hotkey.charCodeAt(0)-"A".charCodeAt(0)))ret=this.menu_idx=_ii4
if((hotkey&&"0"===hotkey||1===items.length)&&input.keyDownEdge(KEYS.ESCAPE))ret=this.menu_idx=_ii4}this.menu_idx=(this.menu_idx+items.length)%items.length
var left_select=false
if(input.keyDownEdge(KEYS.SPACE)||input.keyDownEdge(KEYS.ENTER)||-1===ret&&(input.keyDownEdge(KEYS.D)||input.keyDownEdge(KEYS.RIGHT)||(left_select=input.keyDownEdge(KEYS.A)||input.keyDownEdge(KEYS.LEFT)))){ret=this.menu_idx
if(left_select)this.menu_select_delta=-1}for(var _ii5=0;_ii5<items.length;++_ii5){var _item2=items[_ii5]
var selected=_ii5===this.menu_idx
var executing=_ii5===ret
var colors=executing?color_execute:selected?color_sel:color_unsel
var _effx=x
var _effy=y+_ii5
var eff_pre_sel=pre_sel
var eff_pre_unsel=pre_unsel
if("object"===typeof _item2){_effx=_item2.x
_effy=_item2.y
colors=executing?_item2.color_execute:selected?_item2.color_sel:_item2.color_unsel
eff_pre_sel=_item2.pre_sel
eff_pre_unsel=_item2.pre_unsel
_item2=_item2.label}var _param={x:_effx,y:_effy,fg:colors.fg,bg:colors.bg}
_param.text=""+(selected?eff_pre_sel:eff_pre_unsel)+_item2+(selected?post_sel:post_unsel)
this.print(_param)}this.color(color_unsel.fg,color_unsel.bg)
return ret}
_proto.render=function render(){var dt=engine.getFrameDt()
this.frame++
while(dt>=this.mod_countdown&&this.mod_head){dt-=this.mod_countdown
var mod=this.mod_head
this.mod_head=mod.next
if(!mod.next)this.mod_tail=null
this.domod(this.buffer,mod)
var next=mod.next
if(next){var ms_per_char=1e3/(this.baud/10)
if(!isFinite(ms_per_char))ms_per_char=0
this.mod_countdown=ms_per_char*this.ansiCharsTo(next)}else this.mod_countdown=0}this.mod_countdown=max(0,this.mod_countdown-dt)
var w=this.w,h=this.h,buffer=this.buffer,char_width=this.char_width,char_height=this.char_height,palette=this.palette,draw_cursor=this.draw_cursor
var blink=engine.getFrameTimestamp()%1e3>500
var x=this.render_x
var y=this.render_y
var z=this.render_z
for(var ii=0;ii<h;++ii){var jj=0
var line=buffer[ii]
while(jj<w){while(jj<w&&" "===line[jj].ch)++jj
if(jj===w)continue
var jj0=jj
var fg=line[jj].fg
var text=[]
while(jj<w&&(line[jj].fg===fg||" "===line[jj].ch)){var ch=line[jj].ch
if(blink&&line[jj].attr&ATTR.BLINK)ch=" "
text.push(ch);++jj}text=text.join("")
engine.font.drawSized(this.font_styles[fg],x+jj0*char_width,y+ii*char_height,z+.5,char_height,text)}}if(draw_cursor){var playback=this.playback
var cx=x+(this.mod_head?playback.x:this.x)*char_width
var cy=y+(this.mod_head?playback.y:this.y)*char_height
if((engine.getFrameTimestamp()-playback.timestamp)%1e3<500)ui.drawRect(cx,cy+char_height-draw_cursor[1]-1,cx+char_width,cy+char_height-draw_cursor[0],z+.75,palette[playback.fg])}var box_x0=0
var box_y0=0
var last_x
var last_y
var box_color=buffer[0][0].bg
function flush(){ui.drawRect(x+box_x0*char_width,y+box_y0*char_height,x+(last_x+1)*char_width,y+(last_y+1)*char_height,z,palette[box_color])
if(box_y0!==last_y&&last_y!==w-1)ui.drawRect(x+(last_x+1)*char_width,y+box_y0*char_height,x+w*char_width,y+last_y*char_height,z,palette[box_color])}for(var _ii6=0;_ii6<h;++_ii6){var _line3=buffer[_ii6]
for(var _jj3=0;_jj3<w;++_jj3){var color=_line3[_jj3].bg
if(color!==box_color||box_x0>_jj3){flush()
box_color=color
box_x0=_jj3
box_y0=_ii6}last_x=_jj3
last_y=_ii6}}flush()}
return GlovTerminal}()
function terminalCreate(params){return new GlovTerminal(params)}var ansi={bg:{}}
exports.ansi=ansi;["black","red","green","yellow","blue","magenta","cyan","white"].forEach(function(color,idx){ansi[color]=function(str){return ESC+"["+(30+idx)+"m"+str+ESC+"[0m"}
ansi[color].bright=function(str){return ESC+"["+(30+idx)+";1m"+str+ESC+"[0m"}
ansi.bg[color]=function(str){return ESC+"["+(40+idx)+"m"+str+ESC+"[0m"}})
ansi.normal=function(str){return ESC+"[0m"+str}
ansi.blink=function(str){return ESC+"[5m"+str+ESC+"[0m"}
var strip_ansi=/\u001b\[(?:[0-9;]*)[0-9A-ORZcf-nqry=><]/g
function padRight(str,width){var len=str.replace(strip_ansi,"").length
if(len<width)str+=new Array(width-len+1).join(" ")
return str}function padLeft(str,width){var len=str.replace(strip_ansi,"").length
if(len<width)str=new Array(width-len+1).join(" ")+str
return str}

},{"../common/util.js":74,"../common/vmath.js":76,"./engine.js":13,"./font.js":19,"./input.js":28,"./ui.js":57,"assert":undefined}],54:[function(require,module,exports){
"use strict"
exports.terminalSettingsInit=terminalSettingsInit
exports.terminalSettingsShow=terminalSettingsShow
var engine=require("./engine.js")
var input=require("./input.js")
var _require=require("./input.js"),KEYS=_require.KEYS
var _require2=require("./terminal.js"),ansi=_require2.ansi,padRight=_require2.padRight,terminalCreate=_require2.terminalCreate
var settings_terminal
var base_terminal
var settings_up=false
var MODEMS=[{baud:2400,label:"Hayes Smartmodem 2400bps"},{baud:9600,label:"Motorola V.3225 9600bps"},{baud:28800,label:"USR Sportster V.34 28.8kbps"},{baud:Infinity,label:"NULL"}]
function terminalSettingsShow(){settings_up=true}function settingsOverlay(dt){if(input.keyDownEdge(KEYS.O))settings_up=!settings_up
if(settings_up){settings_terminal.print({fg:14,x:10,y:0,text:"TERMINAL OPTIONS"})
var modem_idx=0
for(var ii=0;ii<MODEMS.length;++ii)if(MODEMS[ii].baud===base_terminal.baud)modem_idx=ii
var sel=settings_terminal.menu({x:0,y:1,color_sel:{fg:7,bg:0},color_unsel:{fg:15,bg:1},color_execute:{fg:1,bg:14},pre_sel:" â–  ",pre_unsel:"   ",key:"terminal_settings",items:[padRight("Modem: "+MODEMS[modem_idx].label,34),padRight("Display: "+(engine.getViewportPostprocess()?"CRT":"LCD"),34),padRight("Exit "+ansi.yellow.bright("[O]")+"ptions",34)]})
if(0===sel){modem_idx=(modem_idx+settings_terminal.menu_select_delta+MODEMS.length)%MODEMS.length
base_terminal.baud=MODEMS[modem_idx].baud}else if(1===sel)engine.setViewportPostprocess(!engine.getViewportPostprocess())
else if(2===sel||input.keyDownEdge(KEYS.ESCAPE))settings_up=false
settings_terminal.render()}}function terminalSettingsInit(terminal){(settings_terminal=terminalCreate({auto_scroll:false,baud:0,x:10*(base_terminal=terminal).char_width,y:2*terminal.char_height,z:Z.DEBUG,w:38,h:6,draw_cursor:false})).color(15,1)
settings_terminal.clear()
settings_terminal.color(null,0)
settings_terminal.fill({x:0,y:settings_terminal.h-1,w:1,h:1})
settings_terminal.fill({x:settings_terminal.w-1,y:0,w:1,h:1})
settings_terminal.color(8,0)
settings_terminal.fill({x:1,y:settings_terminal.h-1,w:settings_terminal.w-1,h:1,ch:"â–“"})
settings_terminal.fill({x:settings_terminal.w-1,y:1,w:1,h:settings_terminal.h-2,ch:"â–“"})
engine.addTickFunc(settingsOverlay)}

},{"./engine.js":13,"./input.js":28,"./terminal.js":53}],55:[function(require,module,exports){
"use strict"
exports.bind=bind
exports.bindArray=bindArray
exports.cmpTextureArray=cmpTextureArray
exports.cname=cname
exports.createForCapture=createForCapture
exports.createForDepthCapture=createForDepthCapture
exports.defaultFilters=defaultFilters
exports.findTexForReplacement=findTexForReplacement
exports.format=void 0
exports.isArrayBound=isArrayBound
exports.load=load
exports.load_count=void 0
exports.startup=startup
exports.textureSupportsDepth=textureSupportsDepth
exports.textures=void 0
exports.texturesResetState=texturesResetState
exports.texturesTick=texturesTick
exports.texturesUnloadDynamic=texturesUnloadDynamic
exports.textureLoad=load
var assert=require("assert")
var engine=require("./engine.js")
var _require=require("./filewatch.js"),filewatchOn=_require.filewatchOn
var local_storage=require("./local_storage.js")
var settings=require("./settings.js")
var _require2=require("./shaders.js"),setGLErrorReportDetails=_require2.setGLErrorReportDetails
var urlhash=require("./urlhash.js")
var _require3=require("../common/util.js"),callEach=_require3.callEach,isPowerOfTwo=_require3.isPowerOfTwo,nextHighestPowerOfTwo=_require3.nextHighestPowerOfTwo,ridx=_require3.ridx
var TEX_UNLOAD_TIME=3e5
var textures={}
exports.textures=textures
var load_count=0
exports.load_count=load_count
var aniso=4
var max_aniso=0
var aniso_enum
var default_filter_min
var default_filter_mag
var cube_faces=[{target:"TEXTURE_CUBE_MAP_NEGATIVE_X",pos:[0,1]},{target:"TEXTURE_CUBE_MAP_POSITIVE_X",pos:[0,0]},{target:"TEXTURE_CUBE_MAP_NEGATIVE_Y",pos:[1,0]},{target:"TEXTURE_CUBE_MAP_POSITIVE_Y",pos:[1,1]},{target:"TEXTURE_CUBE_MAP_NEGATIVE_Z",pos:[2,0]},{target:"TEXTURE_CUBE_MAP_POSITIVE_Z",pos:[2,1]}]
var format={R8:{count:1},RGB8:{count:3},RGBA8:{count:4},DEPTH16:{count:1},DEPTH24:{count:1}}
exports.format=format
function defaultFilters(min,mag){default_filter_min=min
default_filter_mag=mag}var bound_unit=null
var bound_tex=[]
var handle_loading
var handle_error
var frame_timestamp
function setUnit(unit){if(unit!==bound_unit){gl.activeTexture(gl.TEXTURE0+unit)
bound_unit=unit}}function bindHandle(unit,target,handle){if(bound_tex[unit]!==handle){setUnit(unit)
gl.bindTexture(target,handle)
bound_tex[unit]=handle}}function unbindAll(target){for(var unit=0;unit<bound_tex.length;++unit){setUnit(unit)
gl.bindTexture(target,target===gl.TEXTURE_2D?handle_loading:null)
bound_tex[unit]=null}}function bind(unit,tex){tex.last_use=frame_timestamp
bindHandle(unit,tex.target,tex.eff_handle)}function bindArray(texs){for(var ii=0;ii<texs.length;++ii){var tex=texs[ii]
tex.last_use=frame_timestamp
var handle=tex.eff_handle
if(bound_tex[ii]!==handle){if(ii!==bound_unit){gl.activeTexture(gl.TEXTURE0+ii)
bound_unit=ii}gl.bindTexture(tex.target,handle)
bound_tex[ii]=handle}}}function cmpTextureArray(texsa,texsb){var d=texsa.length-texsb.length
if(d)return d
for(var ii=0;ii<texsa.length;++ii)if(d=texsa[ii].id-texsb[ii].id)return d
return 0}function isArrayBound(texs){for(var ii=0;ii<texs.length;++ii){var handle=texs[ii].eff_handle
if(bound_tex[ii]!==handle)return false}return true}function texturesResetState(){bound_unit=-1
if(engine.webgl2)unbindAll(gl.TEXTURE_2D_ARRAY)
unbindAll(gl.TEXTURE_2D)
setUnit(0)}var auto_unload_textures=[]
var last_id=0
function Texture(params){this.id=++last_id
this.name=params.name
this.loaded=false
this.load_fail=false
this.target=params.target||gl.TEXTURE_2D
this.is_array=this.target===gl.TEXTURE_2D_ARRAY
this.is_cube=this.target===gl.TEXTURE_CUBE_MAP
this.handle=gl.createTexture()
this.eff_handle=handle_loading
this.setSamplerState(params)
this.src_width=this.src_height=1
this.width=this.height=1
this.nozoom=params.nozoom||false
this.on_load=[]
this.gpu_mem=0
this.soft_error=params.soft_error||false
this.last_use=frame_timestamp
this.auto_unload=params.auto_unload||false
if(this.auto_unload)auto_unload_textures.push(this)
this.format=params.format||format.RGBA8
if(params.data){var err=this.updateData(params.width,params.height,params.data)
if(err){setGLErrorReportDetails()
assert(false,"Error loading "+params.name+": "+err)}}else{unbindAll(this.target)
if(params.url){this.url=params.url
this.loadURL(params.url)}}}Texture.prototype.updateGPUMem=function(){var new_size=this.width*this.height*this.format.count
if(this.mipmaps)new_size*=1.5
var diff=new_size-this.gpu_mem
engine.perf_state.gpu_mem.tex+=diff
this.gpu_mem=diff}
function bindForced(tex){var target=tex.target
setUnit(0)
bound_tex[0]=null
bindHandle(0,target,tex.handle)}Texture.prototype.setSamplerState=function(params){var target=this.target
bindForced(this)
this.filter_min=params.filter_min||default_filter_min
this.filter_mag=params.filter_mag||default_filter_mag
gl.texParameteri(target,gl.TEXTURE_MIN_FILTER,this.filter_min)
gl.texParameteri(target,gl.TEXTURE_MAG_FILTER,this.filter_mag)
this.wrap_s=params.wrap_s||gl.REPEAT
this.wrap_t=params.wrap_t||gl.REPEAT
gl.texParameteri(target,gl.TEXTURE_WRAP_S,this.wrap_s)
gl.texParameteri(target,gl.TEXTURE_WRAP_T,this.wrap_t)
this.mipmaps=this.filter_min>=9984&&this.filter_min<=9987||params.force_mipmaps
if(max_aniso)if(this.mipmaps&&params.filter_mag!==gl.NEAREST)gl.texParameterf(gl.TEXTURE_2D,aniso_enum,aniso)
else gl.texParameterf(gl.TEXTURE_2D,aniso_enum,1)}
Texture.prototype.updateData=function updateData(w,h,data){profilerStart("Texture:updateData")
assert(!this.destroyed)
bindForced(this)
this.last_use=frame_timestamp
this.src_width=w
this.src_height=h
this.width=w
this.height=h
for(var ii=0;ii<10&&gl.getError();++ii);var np2=(!isPowerOfTwo(w)||!isPowerOfTwo(h))&&!this.is_array&&!this.is_cube&&!(!this.mipmaps&&this.wrap_s===gl.CLAMP_TO_EDGE&&this.wrap_t===gl.CLAMP_TO_EDGE)
if(np2){this.width=nextHighestPowerOfTwo(w)
this.height=nextHighestPowerOfTwo(h)
gl.texImage2D(this.target,0,this.format.internal_type,this.width,this.height,0,this.format.internal_type,this.format.gl_type,null)}if(data instanceof Uint8Array){assert(data.length>=w*h*this.format.count)
assert(!this.is_cube)
if(this.is_array){var num_images=h/w
gl.texImage3D(this.target,0,this.format.internal_type,w,w,num_images,0,this.format.internal_type,this.format.gl_type,data)}else if(np2)gl.texSubImage2D(this.target,0,0,0,w,h,this.format.internal_type,this.format.gl_type,data)
else gl.texImage2D(this.target,0,this.format.internal_type,w,h,0,this.format.internal_type,this.format.gl_type,data)}else{if(!data.width){profilerStop()
return"Missing width ("+data.width+') ("'+String(data).slice(0,100)+'")'}if(this.is_cube){assert.equal(2*w,3*h)
var tex_size=h/2
var canvas=document.createElement("canvas")
canvas.width=tex_size
canvas.height=tex_size
var ctx=canvas.getContext("2d")
for(var _ii=0;_ii<cube_faces.length;++_ii){var face=cube_faces[_ii]
ctx.drawImage(data,face.pos[0]*tex_size,face.pos[1]*tex_size,tex_size,tex_size,0,0,tex_size,tex_size)
gl.texImage2D(gl[face.target],0,this.format.internal_type,this.format.internal_type,this.format.gl_type,canvas)}}else if(this.is_array){var _num_images=h/w
gl.texImage3D(this.target,0,this.format.internal_type,w,w,_num_images,0,this.format.internal_type,this.format.gl_type,data)
if(gl.getError()){var _canvas=document.createElement("canvas")
_canvas.width=w
_canvas.height=h
_canvas.getContext("2d").drawImage(data,0,0)
gl.texImage3D(this.target,0,this.format.internal_type,w,w,_num_images,0,this.format.internal_type,this.format.gl_type,_canvas)}}else if(np2){if(w!==this.width)gl.texSubImage2D(this.target,0,1,0,this.format.internal_type,this.format.gl_type,data)
if(h!==this.height)gl.texSubImage2D(this.target,0,0,1,this.format.internal_type,this.format.gl_type,data)
gl.texSubImage2D(this.target,0,0,0,this.format.internal_type,this.format.gl_type,data)}else gl.texImage2D(this.target,0,this.format.internal_type,this.format.internal_type,this.format.gl_type,data)}var err=null
var gl_err=gl.getError()
if(gl_err)err="GLError("+gl_err+")"
if(!err&&this.mipmaps){gl.generateMipmap(this.target)
if(gl_err=gl.getError())err="GLError("+gl_err+")"}if(!err){this.updateGPUMem()
this.eff_handle=this.handle
this.loaded=true
callEach(this.on_load,this.on_load=null,this)}profilerStop()
return err}
Texture.prototype.onLoad=function(cb){if(this.loaded)cb(this)
else this.on_load.push(cb)}
var TEX_RETRY_COUNT=4
Texture.prototype.loadURL=function loadURL(url,filter){var tex=this
assert(!tex.destroyed)
if(!url.match(/^.{2,7}:/))url=""+urlhash.getURLBase()+url
var load_gen=tex.load_gen=(tex.load_gen||0)+1
function tryLoad(next){profilerStart("Texture:tryLoad")
var did_next=false
function done(img){if(!did_next){did_next=true
return void next(img)}}var img=new Image
img.onload=function(){profilerStart("Texture:onload")
done(img)
profilerStop()}
function fail(){done(null)}img.onerror=fail
img.crossOrigin="anonymous"
img.src=url
profilerStop()}exports.load_count=++load_count
var retries=0
function handleLoad(img){if(tex.load_gen!==load_gen||tex.destroyed){exports.load_count=--load_count
return}var err_details=""
if(img){tex.format=format.RGBA8
if(filter)img=filter(tex,img)
var _err=tex.updateData(img.width,img.height,img)
if(_err){err_details=": "+_err
if(tex.is_array&&("GLError(1282)"===_err||"GLError(1281)"===_err)&&engine.webgl2&&!engine.DEBUG){local_storage.setJSON("webgl2_disable",{ua:navigator.userAgent,ts:Date.now()})
console.error('Error loading array texture "'+url+'"'+err_details+", reloading without WebGL2..")
engine.reloadSafe()
return}if(!tex.for_reload)retries=TEX_RETRY_COUNT}else{exports.load_count=--load_count
return}}var err='Error loading texture "'+(url&&url.length>200?url.slice(0,200)+"...":url)+'"'+err_details
if(++retries>TEX_RETRY_COUNT){exports.load_count=--load_count
tex.eff_handle=handle_error
tex.load_fail=true
console.error(err+(err_details?"":", retries failed"))
if(tex.soft_error)tex.err="Load failed"
else{setGLErrorReportDetails()
assert(false,err)}return}console.error(err+", retrying... ")
setTimeout(tryLoad.bind(null,handleLoad),100*retries*retries)}tryLoad(handleLoad)}
Texture.prototype.allocFBO=function(w,h){var fbo_format=settings.fbo_rgba?gl.RGBA:gl.RGB
bindForced(this)
gl.texImage2D(this.target,0,fbo_format,w,h,0,fbo_format,gl.UNSIGNED_BYTE,null)
this.fbo=gl.createFramebuffer()
gl.bindFramebuffer(gl.FRAMEBUFFER,this.fbo)
gl.framebufferTexture2D(gl.FRAMEBUFFER,gl.COLOR_ATTACHMENT0,gl.TEXTURE_2D,this.handle,0)
this.last_use=frame_timestamp
this.src_width=this.width=w
this.src_height=this.height=h
this.updateGPUMem()}
Texture.prototype.allocDepth=function(w,h){bindForced(this)
gl.texImage2D(gl.TEXTURE_2D,0,this.format.internal_type,w,h,0,this.format.format,this.format.gl_type,null)
this.last_use=frame_timestamp
this.src_width=this.width=w
this.src_height=this.height=h
this.updateGPUMem()}
Texture.prototype.captureStart=function(w,h){assert(!this.capture)
this.capture={w:w,h:h}
if(this.fbo)gl.bindFramebuffer(gl.FRAMEBUFFER,this.fbo)}
Texture.prototype.captureEnd=function(filter_linear,wrap){assert(this.capture)
var capture=this.capture
this.capture=null
if(this.fbo)gl.bindFramebuffer(gl.FRAMEBUFFER,null)
else this.copyTexImage(0,0,capture.w,capture.h)
var filter=filter_linear?gl.LINEAR:gl.NEAREST
this.setSamplerState({filter_min:filter,filter_mag:filter,wrap_s:wrap?gl.REPEAT:gl.CLAMP_TO_EDGE,wrap_t:wrap?gl.REPEAT:gl.CLAMP_TO_EDGE})}
Texture.prototype.copyTexImage=function(x,y,w,h){assert(!this.destroyed)
assert(w&&h)
bindHandle(0,this.target,this.handle)
gl.copyTexImage2D(this.target,0,gl.RGB,x,y,w,h,0)
this.last_use=frame_timestamp
this.src_width=this.width=w
this.src_height=this.height=h
this.updateGPUMem()}
Texture.prototype.destroy=function(){if(this.destroyed)return
profilerStart("Texture:destroy")
assert(this.name)
var auto_unload=this.auto_unload
if(auto_unload){this.auto_unload=null
var idx=auto_unload_textures.indexOf(this)
assert(-1!==idx)
ridx(auto_unload_textures,idx)}delete textures[this.name]
unbindAll(this.target)
gl.deleteTexture(this.handle)
if(this.fbo){gl.bindFramebuffer(gl.FRAMEBUFFER,null)
gl.deleteFramebuffer(this.fbo)}this.width=this.height=0
this.updateGPUMem()
this.destroyed=true
if("function"===typeof auto_unload)auto_unload()
profilerStop("Texture:destroy")}
function create(params){assert(params.name)
var texture=new Texture(params)
return textures[params.name]=texture}var last_temporary_id=0
function createForCapture(unique_name,auto_unload){var name=unique_name||"screen_temporary_tex_"+ ++last_temporary_id
assert(!textures[name])
var texture=create({filter_min:gl.NEAREST,filter_mag:gl.NEAREST,wrap_s:gl.CLAMP_TO_EDGE,wrap_t:gl.CLAMP_TO_EDGE,format:format.RGB8,name:name,auto_unload:auto_unload})
texture.loaded=true
texture.eff_handle=texture.handle
return texture}function createForDepthCapture(unique_name,tex_format){var name=unique_name||"screen_temporary_tex_"+ ++last_temporary_id
assert(!textures[name])
var texture=create({filter_min:gl.NEAREST,filter_mag:gl.NEAREST,wrap_s:gl.CLAMP_TO_EDGE,wrap_t:gl.CLAMP_TO_EDGE,format:tex_format,name:name})
texture.loaded=true
texture.eff_handle=texture.handle
return texture}function load(params){var key=params.name=params.name||params.url
assert(key)
var tex=textures[key]
if(!tex)tex=create(params)
tex.last_use=frame_timestamp
return tex}function cname(key){var idx=key.lastIndexOf("/")
if(-1!==idx)key=key.slice(idx+1)
if(-1!==(idx=key.indexOf(".")))key=key.slice(0,idx)
return key.toLowerCase()}function findTexForReplacement(search_key){search_key=cname(search_key)
for(var key in textures)if(cname(key)===search_key)return textures[key]
return null}var tick_next_tex=0
function texturesTick(){frame_timestamp=engine.frame_timestamp
var len=auto_unload_textures.length
if(!len)return
if(tick_next_tex>=len)tick_next_tex=0
var tex=auto_unload_textures[tick_next_tex]
if(tex.last_use<frame_timestamp-TEX_UNLOAD_TIME){console.log("Unloading texture "+tex.name)
tex.destroy()}else++tick_next_tex}function texturesUnloadDynamic(){while(auto_unload_textures.length)auto_unload_textures[0].destroy()}function textureReload(filename){var tex=textures[filename]
if(tex&&tex.url){tex.for_reload=true
tex.loadURL(tex.url+"?rl="+Date.now())
return true}return false}var depth_supported
function textureSupportsDepth(){return depth_supported}function startup(){default_filter_min=gl.LINEAR_MIPMAP_LINEAR
default_filter_mag=gl.LINEAR
format.R8.internal_type=gl.LUMINANCE
format.R8.gl_type=gl.UNSIGNED_BYTE
format.RGB8.internal_type=gl.RGB
format.RGB8.gl_type=gl.UNSIGNED_BYTE
format.RGBA8.internal_type=gl.RGBA
format.RGBA8.gl_type=gl.UNSIGNED_BYTE
var UNSIGNED_INT_24_8
if(engine.webgl2){depth_supported=true
UNSIGNED_INT_24_8=gl.UNSIGNED_INT_24_8}else{var ext=gl.getExtension("WEBGL_depth_texture")
if(ext){UNSIGNED_INT_24_8=ext.UNSIGNED_INT_24_8_WEBGL
depth_supported=true}}if(depth_supported){format.DEPTH16.internal_type=engine.webgl2?gl.DEPTH_COMPONENT16:gl.DEPTH_COMPONENT
format.DEPTH16.format=gl.DEPTH_COMPONENT
format.DEPTH16.gl_type=gl.UNSIGNED_SHORT
format.DEPTH24.internal_type=engine.webgl2?gl.DEPTH24_STENCIL8:gl.DEPTH_STENCIL
format.DEPTH24.format=gl.DEPTH_STENCIL
format.DEPTH24.gl_type=UNSIGNED_INT_24_8}var ext_anisotropic=gl.getExtension("EXT_texture_filter_anisotropic")||gl.getExtension("MOZ_EXT_texture_filter_anisotropic")||gl.getExtension("WEBKIT_EXT_texture_filter_anisotropic")
if(ext_anisotropic){aniso_enum=ext_anisotropic.TEXTURE_MAX_ANISOTROPY_EXT
aniso=max_aniso=gl.getParameter(ext_anisotropic.MAX_TEXTURE_MAX_ANISOTROPY_EXT)}handle_error=load({name:"error",width:2,height:2,nozoom:true,format:format.RGBA8,filter_mag:gl.NEAREST,data:new Uint8Array([255,20,147,255,255,0,0,255,255,255,255,255,255,20,147,255])}).handle
handle_loading=load({name:"loading",width:2,height:2,nozoom:true,format:format.RGBA8,data:new Uint8Array([127,127,127,255,0,0,0,255,64,64,64,255,127,127,127,255])}).handle
load({name:"white",width:2,height:2,nozoom:true,format:format.RGBA8,data:new Uint8Array([255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255])})
load({name:"invisible",width:2,height:2,nozoom:true,format:format.RGBA8,data:new Uint8Array([0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0])})
filewatchOn(".png",textureReload)}

},{"../common/util.js":74,"./engine.js":13,"./filewatch.js":18,"./local_storage.js":31,"./settings.js":44,"./shaders.js":46,"./urlhash.js":58,"assert":undefined}],56:[function(require,module,exports){
"use strict"
exports.REMOVE=exports.IMMEDIATE=exports.CONTINUE=void 0
exports.active=active
exports.fade=fade
exports.pixelate=pixelate
exports.queue=queue
exports.randomTransition=randomTransition
exports.render=render
exports.splitScreen=splitScreen
var assert=require("assert")
var camera2d=require("./camera2d.js")
var glov_engine=require("./engine.js")
var _require=require("./effects.js"),applyCopy=_require.applyCopy,effectsQueue=_require.effectsQueue,effectsIsFinal=_require.effectsIsFinal
var _require2=require("./framebuffer.js"),framebufferCapture=_require2.framebufferCapture,framebufferStart=_require2.framebufferStart,framebufferEnd=_require2.framebufferEnd,temporaryTextureClaim=_require2.temporaryTextureClaim
var floor=Math.floor,min=Math.min,pow=Math.pow,random=Math.random
var sprites=require("./sprites.js")
var shaders=require("./shaders.js")
var textures=require("./textures.js")
var glov_ui=require("./ui.js")
var _require3=require("../common/util.js"),easeOut=_require3.easeOut
var _require4=require("../common/vmath.js"),unit_vec=_require4.unit_vec,vec4=_require4.vec4
var verify=require("../common/verify.js")
var transitions=[]
var IMMEDIATE="immediate"
exports.IMMEDIATE=IMMEDIATE
var REMOVE="remove"
exports.REMOVE=REMOVE
var CONTINUE="continue"
exports.CONTINUE=CONTINUE
var shader_data={transition_pixelate:{fp:"shaders/transition_pixelate.fp"}}
function getShader(key){var elem=shader_data[key]
if(!elem.shader)elem.shader=shaders.create(elem.fp)
return elem.shader}function GlovTransition(z,func){this.z=z
this.capture=null
this.func=func
this.accum_time=0}function transitionCapture(trans){assert(!trans.capture)
trans.capture=textures.createForCapture()
framebufferCapture(trans.capture)}function transitionCaptureFramebuffer(trans){assert(!trans.capture)
trans.capture=framebufferEnd()
temporaryTextureClaim(trans.capture)
if(trans.capture.fbo)applyCopy({source:trans.capture,final:effectsIsFinal()})
else framebufferStart({width:trans.capture.width,height:trans.capture.height,final:effectsIsFinal()})}function queue(z,fn){assert(!glov_engine.had_3d_this_frame)
var immediate=false
if(z===IMMEDIATE){immediate=true
z=Z.TRANSITION_FINAL}for(var ii=0;ii<transitions.length;++ii){var _trans=transitions[ii]
if(_trans.z===z)if(!verify(_trans.capture))return false}var trans=new GlovTransition(z,fn)
transitions.push(trans)
if(immediate)transitionCapture(trans)
else effectsQueue(z+Z.TRANSITION_RANGE,transitionCaptureFramebuffer.bind(null,trans))
return true}function destroyTexture(tex){profilerStart("transition:destroyTexture")
tex.destroy()
profilerStop()}function render(dt){dt=min(dt,100)
for(var trans_idx=0;trans_idx<transitions.length;++trans_idx){var trans=transitions[trans_idx]
trans.accum_time+=dt
assert(trans.capture)
var force_end=trans_idx<transitions.length-1
if(trans.func(trans.z,trans.capture,trans.accum_time,force_end)===REMOVE){setTimeout(destroyTexture.bind(null,trans.capture),0)
transitions.splice(trans_idx,1)
trans_idx--}}}function active(){return transitions.length}function glovTransitionFadeFunc(fade_time,z,initial,ms_since_start,force_end){var progress=min(ms_since_start/fade_time,1)
var alpha=1-easeOut(progress,2)
var color=vec4(1,1,1,alpha)
camera2d.setNormalized()
sprites.queueraw4([initial],0,0,0,1,1,1,1,0,z,0,1,1,0,color)
if(force_end||1===progress)return REMOVE
return CONTINUE}function glovTransitionSplitScreenFunc(time,border_width,slide_window,z,tex,ms_since_start,force_end){var border_color=vec4(1,1,1,1)
var progress=easeOut(min(ms_since_start/time,1),2)
camera2d.setNormalized()
var uvs=[[0,1],[1,0]]
var xoffs=progress
var v_half=uvs[0][1]+(uvs[1][1]-uvs[0][1])/2
if(slide_window){sprites.queueraw([tex],0,0,z,1-xoffs,.5,0,uvs[0][1],uvs[1][0]*(1-progress),v_half,unit_vec)
sprites.queueraw([tex],0+xoffs,.5,z,1-xoffs,.5,uvs[1][0]*progress,v_half,uvs[1][0],uvs[1][1],unit_vec)}else{sprites.queueraw([tex],0-xoffs,0,z,1,.5,uvs[0][0],uvs[0][1],uvs[1][0],v_half,unit_vec)
sprites.queueraw([tex],0+xoffs,.5,z,1,.5,uvs[0][0],v_half,uvs[1][0],uvs[1][1],unit_vec)}var border_grow_progress=min(4*progress,1)
border_color[3]=border_grow_progress
glov_ui.drawRect(0,.5-(border_width*=border_grow_progress),1-xoffs,.5,z+1,border_color)
glov_ui.drawRect(1-xoffs-border_width,0,1-xoffs,.5,z+1,border_color)
glov_ui.drawRect(xoffs,.5,1,.5+border_width,z+1,border_color)
glov_ui.drawRect(xoffs,.5,xoffs+border_width,1,z+1,border_color)
if(force_end||1===progress)return REMOVE
return CONTINUE}var render_scale=1
var transition_pixelate_textures=[null]
function transitionPixelateCapture(){var tex=framebufferEnd()
framebufferStart({width:tex.width,height:tex.height,final:effectsIsFinal()})
transition_pixelate_textures[0]=tex}function glovTransitionPixelateFunc(time,z,tex,ms_since_start,force_end){var gd_width=glov_engine.width
var progress=min(ms_since_start/time,1)
camera2d.setNormalized()
transition_pixelate_textures[0]=tex
if(progress>.5)effectsQueue(z,transitionPixelateCapture)
var pixel_scale=pow(2,floor(8.9*(2*(progress>.5?1-progress:progress))))/1024*gd_width*render_scale
var param0=vec4(tex.width/pixel_scale,tex.height/pixel_scale,pixel_scale/tex.width,pixel_scale/tex.height)
var param1=vec4(.5/tex.width,.5/tex.height,(tex.texSizeX-1)/tex.width,(tex.texSizeY-1)/tex.height)
sprites.queueraw(transition_pixelate_textures,0,0,z+1,1,1,0,1,1,0,unit_vec,getShader("transition_pixelate"),{param0:param0,param1:param1})
if(force_end||1===progress)return REMOVE
return CONTINUE}function fade(fade_time){return glovTransitionFadeFunc.bind(null,fade_time)}function splitScreen(time,border_width,slide_window){border_width/=camera2d.w()
return glovTransitionSplitScreenFunc.bind(null,time,border_width,slide_window)}function pixelate(fade_time){return glovTransitionPixelateFunc.bind(null,fade_time)}function randomTransition(fade_time_scale){fade_time_scale=fade_time_scale||1
switch(floor(3*random())){case 0:return fade(500*fade_time_scale)
case 1:return splitScreen(250*fade_time_scale,2,false)
case 2:return pixelate(750*fade_time_scale)
default:assert(0)}return null}

},{"../common/util.js":74,"../common/verify.js":75,"../common/vmath.js":76,"./camera2d.js":7,"./effects.js":12,"./engine.js":13,"./framebuffer.js":20,"./shaders.js":46,"./sprites.js":51,"./textures.js":55,"./ui.js":57,"assert":undefined}],57:[function(require,module,exports){
"use strict"
exports.Z_MIN_INC=exports.Z=exports.LINE_CAP_SQUARE=exports.LINE_CAP_ROUND=exports.LINE_ALIGN=void 0
exports.addHook=addHook
exports.button=button
exports.buttonBackgroundDraw=buttonBackgroundDraw
exports.buttonImage=buttonImage
exports.buttonShared=buttonShared
exports.buttonSpotBackgroundDraw=buttonSpotBackgroundDraw
exports.buttonText=buttonText
exports.buttonTextDraw=buttonTextDraw
exports.buttonWasFocused=buttonWasFocused
exports.button_width=exports.button_mouseover=exports.button_last_color=exports.button_img_size=exports.button_height=exports.button_focused=exports.button_click=void 0
exports.colorSetSetShades=colorSetSetShades
exports.color_panel=exports.color_button=void 0
exports.copyTextToClipboard=copyTextToClipboard
exports.createEditBox=createEditBox
exports.drawBox=drawBox
exports.drawCircle=drawCircle
exports.drawCone=drawCone
exports.drawElipse=drawElipse
exports.drawHBox=drawHBox
exports.drawHollowCircle=drawHollowCircle
exports.drawHollowRect=drawHollowRect
exports.drawHollowRect2=drawHollowRect2
exports.drawLine=drawLine
exports.drawMultiPartBox=drawMultiPartBox
exports.drawRect=drawRect
exports.drawRect2=drawRect2
exports.drawRect4Color=drawRect4Color
exports.drawTooltip=drawTooltip
exports.drawTooltipBox=drawTooltipBox
exports.drawVBox=drawVBox
exports.focusCanvas=focusCanvas
exports.font_height=exports.font=void 0
exports.getUIElemData=getUIElemData
exports.internal=void 0
exports.isMenuUp=isMenuUp
exports.label=label
exports.loadUISprite=loadUISprite
exports.loadUISprite2=loadUISprite2
exports.makeColorSet=makeColorSet
exports.menuUp=menuUp
exports.menu_up=void 0
exports.modalDialog=modalDialog
exports.modalDialogClear=modalDialogClear
exports.modalTextEntry=modalTextEntry
exports.modal_y0=exports.modal_width=exports.modal_title_scale=exports.modal_pad=exports.modal_button_width=void 0
exports.panel=panel
exports.panel_pixel_scale=void 0
exports.playUISound=playUISound
exports.print=print
exports.progressBar=progressBar
exports.provideUserString=provideUserString
exports.scaleSizes=scaleSizes
exports.setButtonsDefaultLabels=setButtonsDefaultLabels
exports.setFontHeight=setFontHeight
exports.setFontStyles=setFontStyles
exports.setModalSizes=setModalSizes
exports.setPanelPixelScale=setPanelPixelScale
exports.setProvideUserStringDefaultMessages=setProvideUserStringDefaultMessages
exports.setTooltipWidth=setTooltipWidth
exports.sprites=void 0
exports.suppressNewDOMElemWarnings=suppressNewDOMElemWarnings
exports.tooltip_width=exports.tooltip_panel_pixel_scale=exports.tooltip_pad=exports.title_font=void 0
exports.uiBindSounds=uiBindSounds
exports.uiFontStyleDisabled=uiFontStyleDisabled
exports.uiFontStyleFocused=uiFontStyleFocused
exports.uiFontStyleModal=uiFontStyleModal
exports.uiFontStyleNormal=uiFontStyleNormal
exports.uiGetDOMElem=uiGetDOMElem
exports.uiGetFontStyleFocused=uiGetFontStyleFocused
exports.uiHandlingNav=uiHandlingNav
exports.uiSetFontStyleFocused=uiSetFontStyleFocused
var _SPOT_STATE_TO_UI_BUT
function _extends(){return(_extends=Object.assign?Object.assign.bind():function(target){for(var i=1;i<arguments.length;i++){var source=arguments[i]
for(var key in source)if(Object.prototype.hasOwnProperty.call(source,key))target[key]=source[key]}return target}).apply(this,arguments)}window.Z=window.Z||{}
var Z=window.Z
exports.Z=Z
var Z_MIN_INC=1e-5
exports.Z_MIN_INC=Z_MIN_INC
Z.BORDERS=Z.BORDERS||90
Z.UI=Z.UI||100
Z.MODAL=Z.MODAL||1e3
Z.TOOLTIP=Z.TOOLTIP||2e3
Z.DEBUG=Z.DEBUG||9800
Z.TRANSITION_FINAL=Z.TRANSITION_FINAL||9900
Z.TRANSITION_RANGE=Z.TRANSITION_RANGE||10
Z.FPSMETER=Z.FPSMETER||1e4
var LINE_ALIGN=1
exports.LINE_ALIGN=LINE_ALIGN
var LINE_CAP_SQUARE=2
exports.LINE_CAP_SQUARE=LINE_CAP_SQUARE
var LINE_CAP_ROUND=4
exports.LINE_CAP_ROUND=LINE_CAP_ROUND
var internal={checkHooks:checkHooks,cleanupDOMElems:cleanupDOMElems,uiEndFrame:uiEndFrame,uiSetFonts:uiSetFonts,uiStartup:uiStartup,uiTick:uiTick}
exports.internal=internal
var assert=require("assert")
var camera2d=require("./camera2d.js")
var _require=require("./edit_box.js"),editBoxCreate=_require.editBoxCreate,editBoxTick=_require.editBoxTick
var effects=require("./effects.js")
var effectsQueue=effects.effectsQueue
var glov_engine=require("./engine.js")
var glov_font=require("./font.js")
var fontSetDefaultSize=glov_font.fontSetDefaultSize,fontStyle=glov_font.fontStyle,fontStyleColored=glov_font.fontStyleColored
var glov_input=require("./input.js")
var _require2=require("./link.js"),linkTick=_require2.linkTick
var _require3=require("./localization.js"),getStringFromLocalizable=_require3.getStringFromLocalizable
var abs=Math.abs,floor=Math.floor,max=Math.max,min=Math.min,round=Math.round,sqrt=Math.sqrt
var _require4=require("./scroll_area.js"),scrollAreaSetPixelScale=_require4.scrollAreaSetPixelScale
var _require5=require("./slider.js"),sliderSetDefaultShrink=_require5.sliderSetDefaultShrink
var _require6=require("./sound.js"),soundLoad=_require6.soundLoad,soundPlay=_require6.soundPlay
var _require7=require("./spot.js"),SPOT_DEFAULT_BUTTON=_require7.SPOT_DEFAULT_BUTTON,SPOT_DEFAULT_BUTTON_DRAW_ONLY=_require7.SPOT_DEFAULT_BUTTON_DRAW_ONLY,SPOT_DEFAULT_LABEL=_require7.SPOT_DEFAULT_LABEL,SPOT_STATE_REGULAR=_require7.SPOT_STATE_REGULAR,SPOT_STATE_DOWN=_require7.SPOT_STATE_DOWN,SPOT_STATE_FOCUSED=_require7.SPOT_STATE_FOCUSED,SPOT_STATE_DISABLED=_require7.SPOT_STATE_DISABLED,spot=_require7.spot,spotEndOfFrame=_require7.spotEndOfFrame,spotKey=_require7.spotKey,spotPadMode=_require7.spotPadMode,spotPadSuppressed=_require7.spotPadSuppressed,spotTopOfFrame=_require7.spotTopOfFrame,spotUnfocus=_require7.spotUnfocus
var glov_sprites=require("./sprites.js")
var BLEND_PREMULALPHA=glov_sprites.BLEND_PREMULALPHA,spriteClipped=glov_sprites.spriteClipped,spriteClipPause=glov_sprites.spriteClipPause,spriteClipResume=glov_sprites.spriteClipResume,spriteChainedStart=glov_sprites.spriteChainedStart,spriteChainedStop=glov_sprites.spriteChainedStop,spriteCreate=glov_sprites.spriteCreate
var textures=require("./textures.js")
var _require8=require("../common/util.js"),clamp=_require8.clamp,clone=_require8.clone,defaults=_require8.defaults,deprecate=_require8.deprecate,lerp=_require8.lerp,merge=_require8.merge
var _require9=require("./mat43.js"),mat43=_require9.mat43,m43identity=_require9.m43identity,m43mul=_require9.m43mul
var _require10=require("../common/vmath.js"),vec2=_require10.vec2,vec4=_require10.vec4,v3scale=_require10.v3scale,unit_vec=_require10.unit_vec
deprecate(exports,"slider_dragging","slider.js:sliderIsDragging()")
deprecate(exports,"slider_rollover","slider.js:sliderIsFocused()")
deprecate(exports,"setSliderDefaultShrink","slider.js:sliderSetDefaultShrink()")
deprecate(exports,"slider","slider.js:slider()")
deprecate(exports,"bindSounds","uiBindSounds")
deprecate(exports,"modal_font_style","uiFontStyleModal()")
deprecate(exports,"font_style_noraml","uiFontStyleNoraml()")
deprecate(exports,"font_style_focused","uiFontStyleFocused()")
var MODAL_DARKEN=.75
var KEYS
var PAD
var menu_fade_params_default={blur:[.125,.865],saturation:[.5,.1],brightness:[1,1-MODAL_DARKEN],fallback_darken:vec4(0,0,0,MODAL_DARKEN),z:Z.MODAL}
var color_set_shades=vec4(1,1,1,1)
var color_sets=[]
function applyColorSet(color_set){v3scale(color_set.regular,color_set.color,color_set_shades[0])
v3scale(color_set.rollover,color_set.color,color_set_shades[1])
v3scale(color_set.down,color_set.color,color_set_shades[2])
v3scale(color_set.disabled,color_set.color,color_set_shades[3])}function makeColorSet(color){var ret={color:color,regular:vec4(),rollover:vec4(),down:vec4(),disabled:vec4()}
for(var field in ret)ret[field][3]=color[3]
color_sets.push(ret)
applyColorSet(ret)
return ret}var hooks=[]
function addHook(draw,click){hooks.push({draw:draw,click:click})}var ui_elem_data={}
function getUIElemData(type,param,allocator){var key=spotKey(param)
var by_type=ui_elem_data[type]
if(!by_type)by_type=ui_elem_data[type]={}
var elem_data=by_type[key]
if(!elem_data)elem_data=by_type[key]=allocator?allocator(param):{}
elem_data.frame_index=glov_engine.frame_index
return elem_data}function doBlurEffect(factor){effects.applyGaussianBlur({blur:factor})}var desaturate_xform=mat43()
var desaturate_tmp=mat43()
function doDesaturateEffect(saturation,brightness){m43identity(desaturate_xform)
effects.saturationMatrix(desaturate_tmp,saturation)
m43mul(desaturate_xform,desaturate_xform,desaturate_tmp)
effects.brightnessScaleMatrix(desaturate_tmp,brightness)
m43mul(desaturate_xform,desaturate_xform,desaturate_tmp)
effects.applyColorMatrix({colorMatrix:desaturate_xform})}var button_height=32
exports.button_height=button_height
var font_height=24
exports.font_height=font_height
var button_width=200
exports.button_width=button_width
var modal_button_width=100
exports.modal_button_width=modal_button_width
var button_img_size=button_height
exports.button_img_size=button_img_size
var modal_width=600
exports.modal_width=modal_width
var modal_y0=200
exports.modal_y0=modal_y0
var modal_title_scale=1.2
exports.modal_title_scale=modal_title_scale
var modal_pad=16
exports.modal_pad=modal_pad
var panel_pixel_scale=32/13
var tooltip_panel_pixel_scale=exports.panel_pixel_scale=panel_pixel_scale
exports.tooltip_panel_pixel_scale=tooltip_panel_pixel_scale
var tooltip_width=400
exports.tooltip_width=tooltip_width
var tooltip_pad=8
exports.tooltip_pad=tooltip_pad
var font_style_normal
var font_style_focused
var font_style_disabled
var font_style_modal
function setFontStyles(normal,focused,modal,disabled){font_style_normal=normal||fontStyleColored(null,255)
font_style_focused=focused||fontStyle(font_style_normal,{})
font_style_modal=modal||fontStyle(font_style_normal,{})
font_style_disabled=disabled||fontStyleColored(font_style_normal,572662527)}setFontStyles()
function uiFontStyleNormal(){return font_style_normal}function uiFontStyleFocused(){return font_style_focused}function uiFontStyleDisabled(){return font_style_modal}function uiFontStyleModal(){return font_style_modal}var font
exports.font=font
var title_font
exports.title_font=title_font
var sprites={}
exports.sprites=sprites
var color_button=makeColorSet([1,1,1,1])
exports.color_button=color_button
var color_panel=vec4(1,1,.75,1)
exports.color_panel=color_panel
var sounds={}
var button_mouseover=false
exports.button_mouseover=button_mouseover
var button_focused=false
exports.button_focused=button_focused
var button_click=null
exports.button_click=button_click
function buttonWasFocused(){return button_focused}var modal_dialog=null
var menu_up=false
exports.menu_up=menu_up
var menu_fade_params=merge({},menu_fade_params_default)
var menu_up_time=0
var dom_elems=[]
var dom_elems_issued=0
var button_keys
var default_line_mode
var buttons_default_labels={ok:"OK",cancel:"Cancel",yes:"Yes",no:"No"}
var default_copy_success_msg="Text copied to clipboard!"
var default_copy_failure_msg="Copy to clipboard FAILED, please copy from below."
function colorSetSetShades(rollover,down,disabled){color_set_shades[1]=rollover
color_set_shades[2]=down
color_set_shades[3]=disabled
for(var ii=0;ii<color_sets.length;++ii)applyColorSet(color_sets[ii])}function uiGetFontStyleFocused(){return font_style_focused}function uiSetFontStyleFocused(new_style){font_style_focused=new_style}function loadUISprite(name,ws,hs){var wrap_s=gl.CLAMP_TO_EDGE
var wrap_t=gl.CLAMP_TO_EDGE
sprites[name]=spriteCreate({name:"ui/"+name,ws:ws,hs:hs,wrap_s:wrap_s,wrap_t:wrap_t})}function loadUISprite2(name,param){if(null===param)return
var wrap_s=gl.CLAMP_TO_EDGE
var wrap_t=param.wrap_t?gl.REPEAT:gl.CLAMP_TO_EDGE
var sprite_param={ws:param.ws,hs:param.hs,wrap_s:wrap_s,wrap_t:wrap_t,layers:param.layers}
if(param.url)sprite_param.url=param.url
else sprite_param.name="ui/"+(param.name||name)
sprites[name]=spriteCreate(sprite_param)}function uiSetFonts(new_font,new_title_font){exports.font=font=new_font
exports.title_font=title_font=new_title_font||font}function setButtonsDefaultLabels(buttons_labels){for(var key in buttons_labels)buttons_default_labels[key.toLowerCase()]=buttons_labels[key]}function setProvideUserStringDefaultMessages(success_msg,failure_msg){default_copy_success_msg=success_msg
default_copy_failure_msg=failure_msg}var base_ui_sprites={color_set_shades:[1,1,1],white:{url:"white"},button:{ws:[8,112,8],hs:[128]},button_rollover:{ws:[8,112,8],hs:[128]},button_down:{ws:[8,112,8],hs:[128]},button_disabled:{ws:[8,112,8],hs:[128]},panel:{ws:[32,64,32],hs:[32,64,32]},menu_entry:{ws:[8,112,8],hs:[128]},menu_selected:{ws:[8,112,8],hs:[128]},menu_down:{ws:[8,112,8],hs:[128]},menu_header:{ws:[8,112,136],hs:[128]},slider:{ws:[56,16,56],hs:[128]},slider_handle:{ws:[64],hs:[128]},scrollbar_bottom:{ws:[64],hs:[64]},scrollbar_trough:{ws:[64],hs:[8],wrap_t:true},scrollbar_top:{ws:[64],hs:[64]},scrollbar_handle_grabber:{ws:[64],hs:[64]},scrollbar_handle:{ws:[64],hs:[24,16,24]},progress_bar:{ws:[48,32,48],hs:[128]},progress_bar_trough:{ws:[48,32,48],hs:[128]}}
function uiStartup(param){exports.font=font=param.font
exports.title_font=title_font=param.title_font||font
var overrides=param.ui_sprites
KEYS=glov_input.KEYS
PAD=glov_input.PAD
var ui_sprites=_extends({},base_ui_sprites,param.ui_sprites)
for(var key in ui_sprites){var base_elem=base_ui_sprites[key]
if("object"===typeof base_elem&&!Array.isArray(base_elem)){var override=overrides&&overrides[key]
loadUISprite2(key,void 0===override?base_elem:override)}}sprites.button_regular=sprites.button
if(ui_sprites.color_set_shades)colorSetSetShades.apply(void 0,ui_sprites.color_set_shades)
if(ui_sprites.slider_params)sliderSetDefaultShrink.apply(void 0,ui_sprites.slider_params)
if(sprites.button_rollover&&1!==color_set_shades[1])colorSetSetShades(1,color_set_shades[2],color_set_shades[3])
if(sprites.button_down&&1!==color_set_shades[2])colorSetSetShades(color_set_shades[1],1,color_set_shades[3])
if(sprites.button_disabled&&1!==color_set_shades[3])colorSetSetShades(color_set_shades[1],color_set_shades[2],1);(button_keys={ok:{key:[KEYS.O],pad:[PAD.X],low_key:[KEYS.ESC]},cancel:{key:[KEYS.ESC],pad:[PAD.B,PAD.Y]}}).yes=clone(button_keys.ok)
button_keys.yes.key.push(KEYS.Y)
button_keys.no=clone(button_keys.cancel)
button_keys.no.key.push(KEYS.N)
if(void 0!==param.line_mode)default_line_mode=param.line_mode
else default_line_mode=LINE_ALIGN|LINE_CAP_ROUND
scaleSizes(1)}var dynamic_text_elem
var per_frame_dom_alloc=[0,0,0,0,0,0,0]
var per_frame_dom_suppress=0
function suppressNewDOMElemWarnings(){per_frame_dom_suppress=glov_engine.frame_index+1}function uiGetDOMElem(last_elem,allow_modal){if(modal_dialog&&!allow_modal)return null
if(dom_elems_issued>=dom_elems.length||!last_elem){var _elem=document.createElement("div")
if(glov_engine.DEBUG&&!glov_engine.resizing()&&glov_engine.frame_index>per_frame_dom_suppress){per_frame_dom_alloc[glov_engine.frame_index%per_frame_dom_alloc.length]=1
var sum=0
for(var ii=0;ii<per_frame_dom_alloc.length;++ii)sum+=per_frame_dom_alloc[ii]
assert(sum<per_frame_dom_alloc.length,"Allocated new DOM elements for too many consecutive frames")}_elem.setAttribute("class","glovui_dynamic")
if(!dynamic_text_elem)dynamic_text_elem=document.getElementById("dynamic_text")
dynamic_text_elem.appendChild(_elem)
dom_elems.push(_elem)
last_elem=_elem}if(dom_elems[dom_elems_issued]!==last_elem)for(var _ii=dom_elems_issued+1;_ii<dom_elems.length;++_ii)if(dom_elems[_ii]===last_elem){dom_elems[_ii]=dom_elems[dom_elems_issued]
dom_elems[dom_elems_issued]=last_elem}var elem=dom_elems[dom_elems_issued]
dom_elems_issued++
return elem}var base_ui_sounds={button_click:"button_click",rollover:"rollover"}
function uiBindSounds(_sounds){for(var key in sounds=defaults(_sounds||{},base_ui_sounds))soundLoad(sounds[key])}var draw_box_param={nozoom:true}
function drawHBox(coords,s,color){spriteChainedStart()
var uidata=s.uidata
var x=coords.x
var ws=[uidata.wh[0]*coords.h,0,uidata.wh[2]*coords.h]
if(coords.no_min_width&&ws[0]+ws[2]>coords.w){var scale=coords.w/(ws[0]+ws[2])
ws[0]*=scale
ws[2]*=scale}else ws[1]=max(0,coords.w-ws[0]-ws[2])
draw_box_param.y=coords.y
draw_box_param.z=coords.z
draw_box_param.h=coords.h
draw_box_param.color=color
draw_box_param.color1=coords.color1
draw_box_param.shader=null
for(var ii=0;ii<ws.length;++ii){var my_w=ws[ii]
if(my_w){draw_box_param.x=x
draw_box_param.w=my_w
draw_box_param.uvs=uidata.rects[ii]
if(coords.color1)s.drawDualTint(draw_box_param)
else s.draw(draw_box_param)}x+=my_w}spriteChainedStop()}function drawVBox(coords,s,color){spriteChainedStart()
var uidata=s.uidata
var hs=[uidata.hw[0]*coords.w,0,uidata.hw[2]*coords.w]
var y=coords.y
hs[1]=max(0,coords.h-hs[0]-hs[2])
draw_box_param.x=coords.x
draw_box_param.z=coords.z
draw_box_param.w=coords.w
draw_box_param.color=color
draw_box_param.shader=null
for(var ii=0;ii<hs.length;++ii){var my_h=hs[ii]
draw_box_param.y=y
draw_box_param.h=my_h
draw_box_param.uvs=uidata.rects[ii]
s.draw(draw_box_param)
y+=my_h}spriteChainedStop()}function drawBox(coords,s,pixel_scale,color){spriteChainedStart()
var uidata=s.uidata
var scale=pixel_scale
var ws=[uidata.widths[0]*scale,0,uidata.widths[2]*scale]
ws[1]=max(0,coords.w-ws[0]-ws[2])
var hs=[uidata.heights[0]*scale,0,uidata.heights[2]*scale]
hs[1]=max(0,coords.h-hs[0]-hs[2])
var x=coords.x
draw_box_param.z=coords.z
draw_box_param.color=color
draw_box_param.shader=null
for(var ii=0;ii<ws.length;++ii){var my_w=ws[ii]
if(my_w){draw_box_param.x=x
draw_box_param.w=my_w
var y=coords.y
for(var jj=0;jj<hs.length;++jj){var my_h=hs[jj]
if(my_h){draw_box_param.y=y
draw_box_param.h=my_h
draw_box_param.uvs=uidata.rects[3*jj+ii]
s.draw(draw_box_param)
y+=my_h}}x+=my_w}}spriteChainedStop()}function drawMultiPartBox(coords,scaleable_data,s,pixel_scale,color){spriteChainedStart()
var uidata=s.uidata
var scale=pixel_scale
var ws=[]
var fixed_w_sum=0
var scaleable_sum=0
for(var i=0;i<uidata.widths.length;i++)if(scaleable_data.widths[i]<0){ws.push(uidata.widths[i]*scale)
fixed_w_sum+=uidata.widths[i]*scale}else{ws.push(0)
scaleable_sum+=scaleable_data.widths[i]}assert(1===scaleable_sum)
for(var _i=0;_i<uidata.widths.length;_i++)if(scaleable_data.widths[_i]>=0)ws[_i]=max(0,(coords.w-fixed_w_sum)*scaleable_data.widths[_i])
var hs=[]
var fixed_h_sum=scaleable_sum=0
for(var _i2=0;_i2<uidata.heights.length;_i2++)if(scaleable_data.heights[_i2]<0){hs.push(uidata.heights[_i2]*scale)
fixed_h_sum+=uidata.heights[_i2]*scale}else{hs.push(0)
scaleable_sum+=scaleable_data.heights[_i2]}assert(1===scaleable_sum)
for(var _i3=0;_i3<uidata.heights.length;_i3++)if(scaleable_data.heights[_i3]>=0)hs[_i3]=max(0,(coords.h-fixed_h_sum)*scaleable_data.heights[_i3])
var x=coords.x
for(var ii=0;ii<ws.length;++ii){var my_w=ws[ii]
if(my_w){var y=coords.y
for(var jj=0;jj<hs.length;++jj){var my_h=hs[jj]
if(my_h){s.draw({x:x,y:y,z:coords.z,color:color,w:my_w,h:my_h,uvs:uidata.rects[jj*ws.length+ii],nozoom:true})
y+=my_h}}x+=my_w}}spriteChainedStop()}function playUISound(name,volume){profilerStart("playUISound")
if("select"===name)name="button_click"
if(sounds[name])soundPlay(sounds[name],volume)
profilerStop("playUISound")}function focusCanvas(){spotUnfocus()}function uiHandlingNav(){return menu_up||!spotPadSuppressed()}function panel(param){assert("number"===typeof param.x)
assert("number"===typeof param.y)
assert("number"===typeof param.w)
assert("number"===typeof param.h)
param.z=param.z||Z.UI-1
param.eat_clicks=void 0===param.eat_clicks?true:param.eat_clicks
var color=param.color||color_panel
drawBox(param,param.sprite||sprites.panel,param.pixel_scale||panel_pixel_scale,color)
if(param.eat_clicks)glov_input.mouseOver(param)}function drawTooltip(param){var tooltip=param.tooltip
if("function"===typeof tooltip)if(!(tooltip=tooltip(param)))return
tooltip=getStringFromLocalizable(tooltip)
assert("number"===typeof param.x)
assert("number"===typeof param.y)
assert("string"===typeof tooltip)
var clip_pause=spriteClipped()
if(clip_pause)spriteClipPause()
var tooltip_w=param.tooltip_width||tooltip_width
var z=param.z||Z.TOOLTIP
var tooltip_y0=param.y
var eff_tooltip_pad=param.tooltip_pad||tooltip_pad
var w=tooltip_w-2*eff_tooltip_pad
var dims=font.dims(font_style_modal,w,0,font_height,tooltip)
var above=param.tooltip_above
if(!above&&param.tooltip_auto_above_offset)above=tooltip_y0+dims.h+2*eff_tooltip_pad>camera2d.y1()
var x=param.x
var eff_tooltip_w=dims.w+2*eff_tooltip_pad
if(x+eff_tooltip_w>camera2d.x1())x=camera2d.x1()-eff_tooltip_w
if(above)tooltip_y0-=dims.h+2*eff_tooltip_pad+(param.tooltip_auto_above_offset||0)
var y=tooltip_y0+eff_tooltip_pad
y+=font.drawSizedWrapped(font_style_modal,x+eff_tooltip_pad,y,z+1,w,0,font_height,tooltip)
panel({x:x,y:tooltip_y0,z:z,w:eff_tooltip_w,h:(y+=eff_tooltip_pad)-tooltip_y0,pixel_scale:param.pixel_scale||tooltip_panel_pixel_scale,eat_clicks:false})
if(clip_pause)spriteClipResume()}function checkHooks(param,click){if(param.hook)for(var ii=0;ii<hooks.length;++ii){if(click)hooks[ii].click(param)
hooks[ii].draw(param)}}function drawTooltipBox(param){var tooltip=param.tooltip
if("function"===typeof tooltip)if(!(tooltip=tooltip(param)))return
drawTooltip({x:param.x,y:param.y+param.h+2,tooltip_auto_above_offset:param.h+4,tooltip_above:param.tooltip_above,tooltip:tooltip,tooltip_width:param.tooltip_width})}function progressBar(param){drawHBox(param,sprites.progress_bar_trough,param.color_trough||param.color||unit_vec)
var progress=clamp(param.progress,0,1)
drawHBox({x:param.x+(param.centered?param.w*(1-progress)*.5:0),y:param.y,z:(param.z||Z.UI)+Z_MIN_INC,w:param.w*progress,h:param.h,no_min_width:true},sprites.progress_bar,param.color||unit_vec)
if(param.tooltip)spot({x:param.x,y:param.y,w:param.w,h:param.h,tooltip:param.tooltip,def:SPOT_DEFAULT_LABEL})}var SPOT_STATE_TO_UI_BUTTON_STATE=((_SPOT_STATE_TO_UI_BUT={})[SPOT_STATE_REGULAR]="regular",_SPOT_STATE_TO_UI_BUT[SPOT_STATE_DOWN]="down",_SPOT_STATE_TO_UI_BUT[SPOT_STATE_FOCUSED]="rollover",_SPOT_STATE_TO_UI_BUT[SPOT_STATE_DISABLED]="disabled",_SPOT_STATE_TO_UI_BUT)
var UISPOT_BUTTON_DISABLED=_extends({},SPOT_DEFAULT_BUTTON,{disabled:true,disabled_focusable:false,sound_rollover:null})
function buttonShared(param){profilerStart("buttonShared")
param.z=param.z||Z.UI
if(param.rollover_quiet)param.sound_rollover=null
var spot_ret
if(param.draw_only&&!param.draw_only_mouseover)spot_ret={ret:false,state:"regular",focused:false}
else{if(param.draw_only){assert(!param.def||param.def===SPOT_DEFAULT_BUTTON_DRAW_ONLY)
param.def=SPOT_DEFAULT_BUTTON_DRAW_ONLY}else if(param.disabled&&!param.disabled_focusable)param.def=param.def||UISPOT_BUTTON_DISABLED
else param.def=param.def||SPOT_DEFAULT_BUTTON
if(param.sound)param.sound_button=param.sound;(spot_ret=spot(param)).state=SPOT_STATE_TO_UI_BUTTON_STATE[spot_ret.spot_state]
if(spot_ret.ret){exports.button_click=button_click=spot_ret
button_click.was_double_click=spot_ret.double_click}}exports.button_focused=button_focused=exports.button_mouseover=button_mouseover=spot_ret.focused
param.z+=param.z_bias&&param.z_bias[spot_ret.state]||0
profilerStop("buttonShared")
return spot_ret}var button_last_color
exports.button_last_color=button_last_color
function buttonBackgroundDraw(param,state){profilerStart("buttonBackgroundDraw")
var colors=param.colors||color_button
var color=exports.button_last_color=button_last_color=param.color||colors[state]
if(!param.no_bg){var base_name=param.base_name||"button"
var sprite=sprites[base_name+"_"+state]
if(!sprite)sprite=sprites[base_name]
drawHBox(param,sprite,color)}profilerStop("buttonBackgroundDraw")}function buttonSpotBackgroundDraw(param,spot_state){profilerStart("buttonSpotBackgroundDraw")
var state=SPOT_STATE_TO_UI_BUTTON_STATE[spot_state]
var colors=param.colors||color_button
var color=exports.button_last_color=button_last_color=param.color||colors[state]
if(!param.no_bg){var base_name=param.base_name||"button"
var sprite=sprites[base_name+"_"+state]
if(!sprite)sprite=sprites[base_name]
drawHBox(param,sprite,color)}profilerStop("buttonSpotBackgroundDraw")}function buttonTextDraw(param,state,focused){profilerStart("buttonTextDraw")
buttonBackgroundDraw(param,state)
var hpad=min(.25*param.font_height,.1*param.w)
var disabled="disabled"===state
font.drawSizedAligned(disabled?font_style_disabled:focused?font_style_focused:font_style_normal,param.x+hpad,param.y,param.z+.1,param.font_height,param.align||glov_font.ALIGN.HVCENTERFIT,param.w-2*hpad,param.h,param.text)
profilerStop("buttonTextDraw")}function buttonText(param){profilerStart("buttonText")
param.text=getStringFromLocalizable(param.text)
assert("number"===typeof param.x)
assert("number"===typeof param.y)
assert("string"===typeof param.text)
param.w=param.w||button_width
param.h=param.h||button_height
param.font_height=param.font_height||font_height
var spot_ret=buttonShared(param)
var ret=spot_ret.ret
buttonTextDraw(param,spot_ret.state,spot_ret.focused)
profilerStop("buttonText")
return ret?spot_ret:null}function buttonImageDraw(param,state,focused){profilerStart("buttonImageDraw")
var uvs=param.img_rect
var img=param.imgs&&param.imgs[state]||param.img
if("number"===typeof param.frame)uvs=img.uidata.rects[param.frame]
buttonBackgroundDraw(param,state)
var color=button_last_color
var img_origin=img.origin
var img_w=img.size[0]
var img_h=img.size[1]
var aspect=img_w/img_h
if("number"===typeof param.frame)aspect=img.uidata.aspect?img.uidata.aspect[param.frame]:1
var largest_w_horiz=param.w*param.shrink
var largest_w_vert=param.h*param.shrink*aspect
img_w=min(largest_w_horiz,largest_w_vert)
var pad_top=(param.h-(img_h=img_w/aspect))/2
var draw_param={x:param.x+(param.left_align?pad_top:(param.w-img_w)/2)+img_origin[0]*img_w,y:param.y+pad_top+img_origin[1]*img_h,z:param.z+(param.z_inc||Z_MIN_INC),color:param.img_color||param.color1&&param.color||color,color1:param.color1,w:img_w/img.size[0],h:img_h/img.size[1],uvs:uvs,rot:param.rotation}
if(param.flip){var x=draw_param.x,w=draw_param.w
draw_param.x=x+w
draw_param.w=-w}if(param.color1)img.drawDualTint(draw_param)
else img.draw(draw_param)
profilerStop("buttonImageDraw")}function buttonImage(param){profilerStart("buttonImage")
assert("number"===typeof param.x)
assert("number"===typeof param.y)
assert(param.imgs||param.img&&param.img.draw)
param.z=param.z||Z.UI
param.w=param.w||button_img_size
param.h=param.h||param.w||button_img_size
param.shrink=param.shrink||.75
var spot_ret=buttonShared(param)
var ret=spot_ret.ret
buttonImageDraw(param,spot_ret.state,spot_ret.focused)
profilerStop("buttonImage")
return ret?spot_ret:null}function button(param){if(param.img&&!param.text)return buttonImage(param)
else if(param.text&&!param.img)return buttonText(param)
profilerStart("button")
assert("number"===typeof param.x)
assert("number"===typeof param.y)
assert(param.img&&param.img.draw)
param.z=param.z||Z.UI
param.h=param.h||button_img_size
param.w=param.w||button_width
param.shrink=param.shrink||.75
param.left_align=true
param.font_height=param.font_height||font_height
var spot_ret=buttonShared(param)
var ret=spot_ret.ret,state=spot_ret.state,focused=spot_ret.focused
buttonImageDraw(param,state,focused)
var saved_no_bg=param.no_bg
var saved_w=param.w
var saved_x=param.x
param.no_bg=true
param.x+=param.h*param.shrink
param.w-=param.h*param.shrink
buttonTextDraw(param,state,focused)
param.no_bg=saved_no_bg
param.w=saved_w
param.x=saved_x
profilerStop("button")
return ret?spot_ret:null}function print(style,x,y,z,text){return font.drawSized(style,x,y,z,font_height,text)}function label(param){profilerStart("label")
var style=param.style,x=param.x,y=param.y,align=param.align,w=param.w,h=param.h,text=param.text,tooltip=param.tooltip
text=getStringFromLocalizable(text)
var use_font=param.font||font
var z=param.z||Z.UI
var size=param.size||font_height
assert(isFinite(x))
assert(isFinite(y))
assert.equal(typeof text,"string")
if(tooltip){if(!w)w=use_font.getStringWidth(style,size,text)
assert(isFinite(w))
assert(isFinite(h))
if(spot({x:x,y:y,w:w,h:h,tooltip:tooltip,def:SPOT_DEFAULT_LABEL}).focused&&spotPadMode())if(param.style_focused)style=param.style_focused
else drawElipse(x-.25*w,y-.25*h,x+1.25*w,y+1.25*h,z-.001,.5,unit_vec)}if(text)if(align)use_font.drawSizedAligned(style,x,y,z,size,align,w,h,text)
else use_font.drawSized(style,x,y,z,size,text)
profilerStop("label")}function modalDialog(param){param.title=getStringFromLocalizable(param.title)
param.text=""+(getStringFromLocalizable(param.text)||"")
assert(!param.title||"string"===typeof param.title)
assert(!param.text||"string"===typeof param.text)
assert(!param.buttons||"object"===typeof param.buttons)
if(param.buttons)for(var key in param.buttons)if("object"!==typeof param.buttons[key])param.buttons[key]={cb:param.buttons[key]}
modal_dialog=param}function modalDialogClear(){modal_dialog=null}var dom_requirement=vec2(24,24)
var virtual_size=vec2()
function modalDialogRun(){camera2d.domDeltaToVirtual(virtual_size,dom_requirement)
var fullscreen_mode=false
var eff_font_height=modal_dialog.font_height||font_height
var eff_button_height=button_height
var pad=modal_pad
var vpad=.5*modal_pad
var general_scale=1
var exit_lock=true
var num_lines
if(virtual_size[0]>.05*camera2d.h()&&camera2d.w()>2*camera2d.h()){fullscreen_mode=true
eff_button_height=eff_font_height
vpad=pad=4
var old_h=camera2d.h()
camera2d.push()
for(num_lines=1;;num_lines++){camera2d.setAspectFixed2(1,eff_font_height*(modal_title_scale+1+num_lines)+4.5*pad)
general_scale=camera2d.h()/old_h
if(!modal_dialog.text)break
var _text_w=camera2d.x1()-camera2d.x0()-2*pad
if(font.numLines(font_style_modal,_text_w,0,eff_font_height,modal_dialog.text)<=num_lines)break}}var _modal_dialog=modal_dialog,buttons=_modal_dialog.buttons,click_anywhere=_modal_dialog.click_anywhere
var keys=Object.keys(buttons||{})
var game_width=camera2d.x1()-camera2d.x0()
var eff_modal_width=fullscreen_mode?game_width:modal_dialog.width||modal_width
var eff_button_width=modal_dialog.button_width||modal_button_width
eff_button_width=min(eff_button_width,2*eff_modal_width/3/keys.length)
var text_w=eff_modal_width-2*pad
var x0=camera2d.x0()+round((game_width-eff_modal_width)/2)
var x=x0+pad
var y0=fullscreen_mode?0:modal_dialog.y0||modal_y0
var y=round(y0+pad)
if(modal_dialog.title){if(fullscreen_mode){title_font.drawSizedAligned(font_style_modal,x,y,Z.MODAL,eff_font_height*modal_title_scale,glov_font.ALIGN.HFIT,text_w,0,modal_dialog.title)
y+=eff_font_height*modal_title_scale}else y+=title_font.drawSizedWrapped(font_style_modal,x,y,Z.MODAL,text_w,0,eff_font_height*modal_title_scale,modal_dialog.title)
y=round(y+1.5*vpad)}if(modal_dialog.text||fullscreen_mode){if(fullscreen_mode){if(modal_dialog.text)font.drawSizedAligned(font_style_modal,x,y,Z.MODAL,eff_font_height,glov_font.ALIGN.HWRAP,text_w,0,modal_dialog.text)
y+=eff_font_height*num_lines}else y+=font.drawSizedWrapped(font_style_modal,x,y,Z.MODAL,text_w,0,eff_font_height,modal_dialog.text)
y=round(y+vpad)}var panel_color=modal_dialog.color||null
var tick_key
if(modal_dialog.tick){var avail_width=eff_modal_width-2*pad
if(fullscreen_mode)avail_width-=(pad+eff_button_width)*keys.length
var param={x0:x0,y0:y0,x:x,y:y,modal_width:eff_modal_width,avail_width:avail_width,font_height:eff_font_height,fullscreen_mode:fullscreen_mode}
tick_key=modal_dialog.tick(param)
y=param.y}x=x0+eff_modal_width-(pad+eff_button_width)*keys.length
var did_button=-1
for(var ii=0;ii<keys.length;++ii){var key=keys[ii]
var key_lower=key.toLowerCase()
var cur_button=buttons[key]=buttons[key]||{}
var eff_button_keys=button_keys[key_lower]
var pressed=0
if(eff_button_keys){for(var jj=0;jj<eff_button_keys.key.length;++jj){pressed+=glov_input.keyDownEdge(eff_button_keys.key[jj],cur_button.in_event_cb)
if(eff_button_keys.key[jj]===tick_key)pressed++}for(var _jj=0;_jj<eff_button_keys.pad.length;++_jj)pressed+=glov_input.padButtonDownEdge(eff_button_keys.pad[_jj])}if(click_anywhere&&0===ii&&glov_input.click())++pressed
if(pressed)did_button=ii
var but_label=cur_button.label||buttons_default_labels[key_lower]||key
if(buttonText(defaults({key:"md_"+key,x:x,y:y,z:Z.MODAL,w:eff_button_width,h:eff_button_height,text:but_label,auto_focus:0===ii},cur_button)))did_button=ii
x=round(x+pad+eff_button_width)}if(-1===did_button)for(var _ii2=0;_ii2<keys.length;++_ii2){var _key=keys[_ii2]
var _eff_button_keys=button_keys[_key.toLowerCase()]
if(_eff_button_keys&&_eff_button_keys.low_key)for(var _jj2=0;_jj2<_eff_button_keys.low_key.length;++_jj2)if(glov_input.keyDownEdge(_eff_button_keys.low_key[_jj2],buttons[_key].in_event_cb)||_eff_button_keys.low_key[_jj2]===tick_key)did_button=_ii2}if(-1!==did_button){var _key2=keys[did_button]
playUISound("button_click")
modal_dialog=null
if(buttons[_key2].cb)buttons[_key2].cb()
exit_lock=false}if(keys.length>0)y+=eff_button_height
y=round(y+vpad+pad)
panel({x:x0,y:y0,z:Z.MODAL-1,w:eff_modal_width,h:(fullscreen_mode?camera2d.y1():y)-y0,pixel_scale:panel_pixel_scale*general_scale,color:panel_color})
if(glov_input.pointerLocked()&&exit_lock)glov_input.pointerLockExit()
glov_input.eatAllInput()
if(fullscreen_mode)camera2d.pop()}function modalTextEntry(param){var eb=editBoxCreate({initial_focus:true,spellcheck:false,initial_select:true,text:param.edit_text,max_len:param.max_len,esc_clears:false})
var buttons={}
for(var key in param.buttons){var cb=param.buttons[key]
if(null!==cb&&"object"===typeof cb&&"cb"in cb)cb=param.buttons[key].cb
if("function"===typeof cb)cb=function(old_fn){return function(){old_fn(eb.getText())}}(cb)
buttons[key]=defaults({cb:cb},param.buttons[key])}param.buttons=buttons
param.text=""+(param.text||"")
var old_tick=param.tick
param.tick=function(params){var eb_ret=eb.run({x:params.x,y:params.y,w:params.avail_width||param.edit_w,font_height:params.font_height})
if(!params.fullscreen_mode)params.y+=params.font_height+modal_pad
var ret
if(eb_ret===eb.SUBMIT)ret=KEYS.O
else if(eb_ret===eb.CANCEL)ret=KEYS.ESC
if(old_tick)ret=old_tick(params)||ret
return ret}
modalDialog(param)}function createEditBox(param){return editBoxCreate(param)}var pp_bad_frames=0
function isMenuUp(){return modal_dialog||menu_up}function releaseOldUIElemData(){for(var type in ui_elem_data){var by_type=ui_elem_data[type]
var any=false
for(var key in by_type)if(by_type[key].frame_index<glov_engine.frame_index-1)delete by_type[key]
else any=true
if(!any)delete ui_elem_data[type]}}function uiTick(dt){per_frame_dom_alloc[glov_engine.frame_index%per_frame_dom_alloc.length]=0
releaseOldUIElemData()
editBoxTick()
linkTick()
dom_elems_issued=0
var pp_this_frame=false
if(modal_dialog||menu_up){var params=menu_fade_params
if(!menu_up)params=menu_fade_params_default
var factor=min((menu_up_time+=dt)/500,1)
if(glov_engine.postprocessing&&!glov_engine.defines.NOPP){var blur_factor=lerp(factor,params.blur[0],params.blur[1])
if(blur_factor)effectsQueue(params.z-2,doBlurEffect.bind(null,blur_factor))
var saturation=lerp(factor,params.saturation[0],params.saturation[1])
var brightness=lerp(factor,params.brightness[0],params.brightness[1])
if(1!==saturation||1!==brightness)effectsQueue(params.z-1,doDesaturateEffect.bind(null,saturation,brightness))
pp_this_frame=true}else sprites.white.draw({x:camera2d.x0Real(),y:camera2d.y0Real(),z:params.z-2,color:params.fallback_darken,w:camera2d.wReal(),h:camera2d.hReal()})}else menu_up_time=0
exports.menu_up=menu_up=false
if(!glov_engine.is_loading&&glov_engine.getFrameDtActual()>50&&pp_this_frame){if((pp_bad_frames=(pp_bad_frames||0)+1)>=6)glov_engine.postprocessingAllow(false)}else if(pp_bad_frames)pp_bad_frames=0
spotTopOfFrame()
if(modal_dialog)modalDialogRun()}function uiEndFrame(){spotEndOfFrame()
if(glov_input.click({x:-Infinity,y:-Infinity,w:Infinity,h:Infinity}))spotUnfocus()
while(dom_elems_issued<dom_elems.length){var elem=dom_elems.pop()
dynamic_text_elem.removeChild(elem)}}function cleanupDOMElems(){while(dom_elems.length){var elem=dom_elems.pop()
dynamic_text_elem.removeChild(elem)}}function menuUp(param){merge(menu_fade_params,menu_fade_params_default)
if(param)merge(menu_fade_params,param)
exports.menu_up=menu_up=true
glov_input.eatAllInput()}function copyTextToClipboard(text){var textArea=document.createElement("textarea")
textArea.style.position="fixed"
textArea.style.top=0
textArea.style.left=0
textArea.style.width="2em"
textArea.style.height="2em"
textArea.style.border="none"
textArea.style.outline="none"
textArea.style.boxShadow="none"
textArea.style.background="transparent"
textArea.value=text
document.body.appendChild(textArea)
textArea.focus()
textArea.select()
var ret=false
try{ret=document.execCommand("copy")}catch(err){}document.body.removeChild(textArea)
return ret}function provideUserString(title,str){var copy_success=copyTextToClipboard(str)
modalTextEntry({edit_w:400,edit_text:str.replace(/[\n\r]/g," "),title:title,text:copy_success?default_copy_success_msg:default_copy_failure_msg,buttons:{ok:null}})}var draw_rect_param={}
function drawRect(x0,y0,x1,y1,z,color){var mx=min(x0,x1)
var my=min(y0,y1)
var Mx=max(x0,x1)
var My=max(y0,y1)
draw_rect_param.x=mx
draw_rect_param.y=my
draw_rect_param.z=z
draw_rect_param.w=Mx-mx
draw_rect_param.h=My-my
draw_rect_param.color=color
return sprites.white.draw(draw_rect_param)}function drawRect2(param){return sprites.white.draw(param)}var draw_rect_4color_param={}
function drawRect4Color(x0,y0,x1,y1,z,color_ul,color_ur,color_ll,color_lr){var mx=min(x0,x1)
var my=min(y0,y1)
var Mx=max(x0,x1)
var My=max(y0,y1)
draw_rect_4color_param.x=mx
draw_rect_4color_param.y=my
draw_rect_4color_param.z=z
draw_rect_4color_param.w=Mx-mx
draw_rect_4color_param.h=My-my
draw_rect_4color_param.color_ul=color_ul
draw_rect_4color_param.color_ll=color_ll
draw_rect_4color_param.color_lr=color_lr
draw_rect_4color_param.color_ur=color_ur
return sprites.white.draw4Color(draw_rect_4color_param)}function spreadTechParams(spread){spread=min(max(spread,0),.99)
var tech_params={param0:vec4(0,0,0,0)}
tech_params.param0[0]=1/(1-spread)
tech_params.param0[1]=-.5*tech_params.param0[0]+.5
return tech_params}var temp_color=vec4()
function premulAlphaColor(color){temp_color[0]=color[0]*color[3]
temp_color[1]=color[1]*color[3]
temp_color[2]=color[2]*color[3]
temp_color[3]=color[3]
return temp_color}function drawElipseInternal(sprite,x0,y0,x1,y1,z,spread,tu0,tv0,tu1,tv1,color,blend){if(!blend&&!glov_engine.defines.NOPREMUL){blend=BLEND_PREMULALPHA
color=premulAlphaColor(color)}glov_sprites.queueraw(sprite.texs,x0,y0,z,x1-x0,y1-y0,tu0,tv0,tu1,tv1,color,glov_font.font_shaders.font_aa,spreadTechParams(spread),blend)}function drawCircleInternal(sprite,x,y,z,r,spread,tu0,tv0,tu1,tv1,color,blend){drawElipseInternal(sprite,x-2*r+4*r*tu0,y-2*r+4*r*tv0,x-2*r+4*r*tu1,y-2*r+4*r*tv1,z,spread,tu0,tv0,tu1,tv1,color,blend)}function initCircleSprite(){var CIRCLE_SIZE=32
var data=new Uint8Array(CIRCLE_SIZE*CIRCLE_SIZE)
var midp=(CIRCLE_SIZE-1)/2
for(var i=0;i<CIRCLE_SIZE;i++)for(var j=0;j<CIRCLE_SIZE;j++){var d=sqrt((i-midp)*(i-midp)+(j-midp)*(j-midp))/midp
var v=clamp(1-d,0,1)
data[i+j*CIRCLE_SIZE]=255*v}sprites.circle=spriteCreate({url:"circle",width:CIRCLE_SIZE,height:CIRCLE_SIZE,format:textures.format.R8,data:data,filter_min:gl.LINEAR,filter_mag:gl.LINEAR,wrap_s:gl.CLAMP_TO_EDGE,wrap_t:gl.CLAMP_TO_EDGE,origin:vec2(.5,.5)})}function drawElipse(x0,y0,x1,y1,z,spread,color,blend){if(!sprites.circle)initCircleSprite()
drawElipseInternal(sprites.circle,x0,y0,x1,y1,z,spread,0,0,1,1,color,blend)}function drawCircle(x,y,z,r,spread,color,blend){if(!sprites.circle)initCircleSprite()
drawCircleInternal(sprites.circle,x,y,z,r,spread,0,0,1,1,color,blend)}function drawHollowCircle(x,y,z,r,spread,color,blend){if(!sprites.hollow_circle){var CIRCLE_SIZE=128
var LINE_W=2
var data=new Uint8Array(CIRCLE_SIZE*CIRCLE_SIZE)
var midp=(CIRCLE_SIZE-1)/2
for(var i=0;i<CIRCLE_SIZE;i++)for(var j=0;j<CIRCLE_SIZE;j++){var d=sqrt((i-midp)*(i-midp)+(j-midp)*(j-midp))/midp
var v=clamp(1-d,0,1)
if(v>.5)v=1-v
v+=LINE_W/CIRCLE_SIZE
data[i+j*CIRCLE_SIZE]=255*v}sprites.hollow_circle=spriteCreate({url:"hollow_circle",width:CIRCLE_SIZE,height:CIRCLE_SIZE,format:textures.format.R8,data:data,filter_min:gl.LINEAR,filter_mag:gl.LINEAR,wrap_s:gl.CLAMP_TO_EDGE,wrap_t:gl.CLAMP_TO_EDGE,origin:vec2(.5,.5)})}drawCircleInternal(sprites.hollow_circle,x,y,z,r,spread,0,0,1,1,color,blend)}var LINE_TEX_W=16
var LINE_TEX_H=16
var LINE_MIDP=floor((LINE_TEX_H-1)/2)
var LINE_V0=.5/LINE_TEX_H
var LINE_V1=1-1.5/LINE_TEX_H
var LINE_U0=.5/LINE_TEX_W
var LINE_U1=(LINE_MIDP+.5)/LINE_TEX_W
var LINE_U2=1-LINE_U1
var LINE_U3=1-.5/LINE_TEX_W
function drawLine(x0,y0,x1,y1,z,w,precise,color,mode){if(void 0===mode)mode=default_line_mode
var blend
if(!glov_engine.defines.NOPREMUL){blend=BLEND_PREMULALPHA
color=premulAlphaColor(color)}var tex_key=mode&LINE_CAP_ROUND?"line3":"line2"
if(!sprites[tex_key]){var data=new Uint8Array(LINE_TEX_W*LINE_TEX_H)
var i1=LINE_MIDP
var i2=LINE_TEX_W-1-LINE_MIDP
if("line2"===tex_key)for(var j=0;j<LINE_TEX_H;j++){var d=abs((j-LINE_MIDP)/LINE_MIDP)
var j_value=round(255*clamp(1-d,0,1))
for(var i=0;i<LINE_TEX_W;i++){var i_value=round(255*clamp(d=i<i1?i/LINE_MIDP:i>=i2?1-(i-i2)/LINE_MIDP:1,0,1))
data[i+j*LINE_TEX_W]=min(i_value,j_value)}}else for(var _j=0;_j<LINE_TEX_H;_j++){var _d=abs((_j-LINE_MIDP)/LINE_MIDP)
for(var _i4=0;_i4<LINE_TEX_W;_i4++){var id=_i4<i1?1-_i4/LINE_MIDP:_i4>=i2?(_i4-i2)/LINE_MIDP:0
var dv=sqrt(id*id+_d*_d)
dv=clamp(1-dv,0,1)
data[_i4+_j*LINE_TEX_W]=round(255*dv)}}sprites[tex_key]=spriteCreate({url:tex_key,width:LINE_TEX_W,height:LINE_TEX_H,format:textures.format.R8,data:data,filter_min:gl.LINEAR,filter_mag:gl.LINEAR,wrap_s:gl.CLAMP_TO_EDGE,wrap_t:gl.CLAMP_TO_EDGE})}var texs=sprites[tex_key].texs
var virtual_to_pixels=.5*(camera2d.data[4]+camera2d.data[5])
var w_in_pixels=w*virtual_to_pixels
var draw_w_pixels=w_in_pixels+4
var half_draw_w_pixels=.5*draw_w_pixels
var draw_w=half_draw_w_pixels*(1/virtual_to_pixels)
var dx=x1-x0
var dy=y1-y0
var length=sqrt(dx*dx+dy*dy)
var tangx=-(dy/=length)*draw_w
var tangy=(dx/=length)*draw_w
if(mode&LINE_ALIGN){var y0_real=(y0-camera2d.data[1])*camera2d.data[5]
var yoffs=(round(y0_real-half_draw_w_pixels)+half_draw_w_pixels-y0_real)/camera2d.data[5]
y0+=yoffs
y1+=yoffs
var x0_real=(x0-camera2d.data[0])*camera2d.data[4]
var xoffs=(round(x0_real-half_draw_w_pixels)+half_draw_w_pixels-x0_real)/camera2d.data[4]
x0+=xoffs
x1+=xoffs}var step_start=1-(w_in_pixels+1)/draw_w_pixels
var step_end=step_start+2/draw_w_pixels
var A=1/((step_end=1+precise*(step_end-1))-step_start)
var shader_param={param0:[A,-step_start*A]}
glov_sprites.queueraw4(texs,x1+tangx,y1+tangy,x1-tangx,y1-tangy,x0-tangx,y0-tangy,x0+tangx,y0+tangy,z,LINE_U1,LINE_V0,LINE_U2,LINE_V1,color,glov_font.font_shaders.font_aa,shader_param,blend)
if(mode&(LINE_CAP_ROUND|LINE_CAP_SQUARE)){var nx=dx*w/2
var ny=dy*w/2
glov_sprites.queueraw4(texs,x1-tangx,y1-tangy,x1+tangx,y1+tangy,x1+tangx+nx,y1+tangy+ny,x1-tangx+nx,y1-tangy+ny,z,LINE_U2,LINE_V1,LINE_U3,LINE_V0,color,glov_font.font_shaders.font_aa,shader_param,blend)
glov_sprites.queueraw4(texs,x0-tangx,y0-tangy,x0+tangx,y0+tangy,x0+tangx-nx,y0+tangy-ny,x0-tangx-nx,y0-tangy-ny,z,LINE_U1,LINE_V1,LINE_U0,LINE_V0,color,glov_font.font_shaders.font_aa,shader_param,blend)}}function drawHollowRect(x0,y0,x1,y1,z,w,precise,color,mode){drawLine(x0,y0,x1,y0,z,w,precise,color,mode)
drawLine(x1,y0,x1,y1,z,w,precise,color,mode)
drawLine(x1,y1,x0,y1,z,w,precise,color,mode)
drawLine(x0,y1,x0,y0,z,w,precise,color,mode)}function drawHollowRect2(param){drawHollowRect(param.x,param.y,param.x+param.w,param.y+param.h,param.z||Z.UI,param.line_width||1,param.precise||1,param.color||unit_vec)}function drawCone(x0,y0,x1,y1,z,w0,w1,spread,color){var blend
if(!glov_engine.defines.NOPREMUL){blend=BLEND_PREMULALPHA
color=premulAlphaColor(color)}if(!sprites.cone){var CONE_SIZE=32
var data=new Uint8Array(CONE_SIZE*CONE_SIZE)
var midp=(CONE_SIZE-1)/2
for(var i=0;i<CONE_SIZE;i++)for(var j=0;j<CONE_SIZE;j++){var _dx=0
var _dy=0
var d=0
if(i>midp){_dx=(i-midp)/midp
_dy=abs(j-midp)/midp
d=_dx*sqrt(_dx*_dx+_dy*_dy)}var v=clamp(1-d,0,1)
data[i+j*CONE_SIZE]=255*v}sprites.cone=spriteCreate({url:"cone",width:CONE_SIZE,height:CONE_SIZE,format:textures.format.R8,data:data,filter_min:gl.LINEAR,filter_mag:gl.LINEAR,wrap_s:gl.CLAMP_TO_EDGE,wrap_t:gl.CLAMP_TO_EDGE,origin:vec2(.5,.5)})}var dx=x1-x0
var dy=y1-y0
var length=sqrt(dx*dx+dy*dy)
var tangx=-(dy/=length)
var tangy=dx/=length
glov_sprites.queueraw4(sprites.cone.texs,x0-tangx*w0,y0-tangy*w0,x0+tangx*w0,y0+tangy*w0,x1+tangx*w1,y1+tangy*w1,x1-tangx*w1,y1-tangy*w1,z,0,0,1,1,color,glov_font.font_shaders.font_aa,spreadTechParams(spread),blend)}function setFontHeight(_font_height){exports.font_height=font_height=_font_height
fontSetDefaultSize(font_height)}function scaleSizes(scale){exports.button_height=button_height=round(32*scale)
setFontHeight(round(24*scale))
exports.button_width=button_width=round(200*scale)
exports.button_img_size=button_img_size=button_height
exports.modal_button_width=modal_button_width=round(button_width/2)
exports.modal_width=modal_width=round(600*scale)
exports.modal_y0=modal_y0=round(200*scale)
exports.modal_title_scale=modal_title_scale=1.2
exports.modal_pad=modal_pad=round(16*scale)
exports.tooltip_width=tooltip_width=round(400*scale)
exports.tooltip_pad=tooltip_pad=round(8*scale)
exports.panel_pixel_scale=panel_pixel_scale=button_height/sprites.panel.uidata.total_h
exports.tooltip_panel_pixel_scale=tooltip_panel_pixel_scale=panel_pixel_scale
scrollAreaSetPixelScale(button_height/sprites.button.uidata.total_h)}function setPanelPixelScale(scale){exports.tooltip_panel_pixel_scale=tooltip_panel_pixel_scale=exports.panel_pixel_scale=panel_pixel_scale=scale}function setModalSizes(_modal_button_width,width,y0,title_scale,pad){exports.modal_button_width=modal_button_width=_modal_button_width||round(button_width/2)
exports.modal_width=modal_width=width||600
exports.modal_y0=modal_y0=y0||200
exports.modal_title_scale=modal_title_scale=title_scale||1.2
exports.modal_pad=modal_pad=pad||modal_pad}function setTooltipWidth(_tooltip_width,_tooltip_panel_pixel_scale){exports.tooltip_width=tooltip_width=_tooltip_width
exports.tooltip_panel_pixel_scale=tooltip_panel_pixel_scale=_tooltip_panel_pixel_scale
exports.tooltip_pad=tooltip_pad=modal_pad/2*_tooltip_panel_pixel_scale}

},{"../common/util.js":74,"../common/vmath.js":76,"./camera2d.js":7,"./edit_box.js":11,"./effects.js":12,"./engine.js":13,"./font.js":19,"./input.js":28,"./link.js":30,"./localization.js":32,"./mat43.js":33,"./scroll_area.js":43,"./slider.js":47,"./sound.js":49,"./spot.js":50,"./sprites.js":51,"./textures.js":55,"assert":undefined}],58:[function(require,module,exports){
"use strict"
exports.TYPE_STRING=exports.TYPE_SET=void 0
exports.get=get
exports.getURLBase=getURLBase
exports.getURLPageBase=getURLPageBase
exports.go=go
exports.onChange=onChange
exports.onURLChange=onURLChange
exports.refreshTitle=refreshTitle
exports.register=register
exports.route=route
exports.routeFixed=routeFixed
exports.set=set
exports.setMulti=setMulti
exports.startup=startup
var assert=require("assert")
var _require=require("../common/util.js"),callEach=_require.callEach
var HISTORY_UPDATE_TIME=1e3
var TYPE_SET="set"
exports.TYPE_SET=TYPE_SET
var TYPE_STRING="string"
exports.TYPE_STRING=TYPE_STRING
var params={}
var title_transformer
var page_base=(document.location.href||"").match(/^[^#?]+/)[0]
if(!page_base.endsWith("/"))page_base+="?"
var url_base=page_base.replace(/[^/]*$/,"")
var on_change=[]
function getURLBase(){return url_base}function getURLPageBase(){return page_base}function onChange(cb){on_change.push(cb)}function cmpNumKeys(a,b){var d=b.keys.length-a.keys.length
if(d)return d
for(var ii=0;ii<a.keys.length;++ii)if(a.keys[ii]<b.keys[ii])return-1
else if(a.keys[ii]>b.keys[ii])return 1
assert(false)
return 0}var route_param_regex=/:(\w+)/g
var routes=[]
function queryString(){return String(document.location).slice(page_base.length)}var regex_value=/[^\w]\w+=([^&]+)/
function getValue(query_string,opts){if(opts.routes)for(var ii=0;ii<opts.routes.length;++ii){var r=opts.routes[ii]
var _m=query_string.match(r.regex)
if(_m){if(r.value)return r.value
return _m[1+r.keys.indexOf(opts.key)]}}var m=query_string.match(opts.regex)||[]
if(opts.type===TYPE_SET){var _r={}
for(var _ii=0;_ii<m.length;++_ii){var m2=m[_ii].match(regex_value)
assert(m2)
_r[m2[1]]=1}return _r}else return m[1]||opts.def}var last_history_str=null
function goInternal(query_string){var hidden={}
for(var key in params){var opts=params[key]
if(opts.hides)if(getValue(query_string,opts))for(var otherkey in opts.hides)hidden[otherkey]=1}var dirty={}
for(var _key in params){if(hidden[_key])continue
var _opts=params[_key]
var new_value=getValue(query_string,_opts)
if(_opts.type===TYPE_SET){for(var v in new_value)if(!_opts.value[v]){_opts.value[v]=1
dirty[_key]=true}for(var _v in _opts.value)if(!new_value[_v]){delete _opts.value[_v]
dirty[_key]=true}}else if(new_value!==_opts.value){dirty[_key]=true
_opts.value=new_value}}for(var _key2 in dirty){var _opts2=params[_key2]
if(_opts2.change)_opts2.change(_opts2.value)}callEach(on_change)}var eff_title
function toString(){eff_title=""
var values=[]
var hidden={}
for(var key in params){var opts=params[key]
if(opts.hides&&opts.value)for(var otherkey in opts.hides)hidden[otherkey]=1}var root_value=""
outer:for(var ii=0;ii<routes.length;++ii){var r=routes[ii]
var route_title=""
for(var jj=0;jj<r.keys.length;++jj){var _key3=r.keys[jj]
if(hidden[_key3])continue outer
var _opts3=params[_key3]
if(_opts3.hide_values[_opts3.value])continue outer
if(!route_title&&_opts3.title)route_title=_opts3.title(_opts3.value)}for(var _jj=0;_jj<r.keys.length;++_jj){var _key4=r.keys[_jj]
if(params[_key4].route_only)hidden[_key4]=true}root_value=r.route_string.replace(route_param_regex,function(ignored,key){hidden[key]=true
return String(params[key].value)})
if(!eff_title&&route_title)eff_title=route_title
break}for(var _key5 in params){if(hidden[_key5])continue
var _opts4=params[_key5]
if(_opts4.type===TYPE_SET)for(var v in _opts4.value)values.push(_key5+"="+v)
else if(!_opts4.hide_values[_opts4.value]){values.push(_key5+"="+_opts4.value)
if(!eff_title&&_opts4.title)eff_title=_opts4.title(_opts4.value)}}if(title_transformer)eff_title=title_transformer(eff_title)
eff_title=String(eff_title)
return root_value+(values.length?"?":"")+values.join("&")}function refreshTitle(){toString()
if(eff_title&&eff_title!==document.title)document.title=eff_title}function periodicRefreshTitle(){profilerStart("periodicRefreshTitle")
refreshTitle()
setTimeout(periodicRefreshTitle,1e3)
profilerStop()}function onPopState(){var query_string=queryString()
goInternal(last_history_str=query_string)
refreshTitle()}var on_url_change
function onURLChange(cb){on_url_change=cb}var last_history_set_time=0
var scheduled=false
var need_push_state=false
function updateHistoryCommit(){profilerStart("updateHistoryCommit")
scheduled=false
last_history_set_time=Date.now()
var url=""+page_base+last_history_str
if(url.endsWith("?"))url=url.slice(0,-1)
try{if(need_push_state){need_push_state=false
window.history.pushState(void 0,eff_title,url)}else window.history.replaceState(void 0,eff_title,url)}catch(e){}if(eff_title)document.title=eff_title
if(on_url_change)on_url_change()
profilerStop()}function updateHistory(new_need_push_state){var new_str=toString()
if(last_history_str===new_str)return
need_push_state=need_push_state||new_need_push_state
last_history_str=new_str
if(scheduled)return
var delay=HISTORY_UPDATE_TIME
if(Date.now()-last_history_set_time>HISTORY_UPDATE_TIME)delay=1
scheduled=true
setTimeout(updateHistoryCommit,delay)}function startup(param){assert(!title_transformer)
if(!(title_transformer=param.title_transformer)&&(param.title_suffix||param.title_default)){var title_suffix=param.title_suffix,title_default=param.title_default
title_transformer=function title_transformer(title){if(title_suffix&&title)return title+" | "+title_suffix
return title||title_default||title_suffix}}updateHistory(false)
if(title_transformer){refreshTitle()
setTimeout(periodicRefreshTitle,1e3)}}function routeEx(new_route){var keys=new_route.keys
for(var ii=0;ii<keys.length;++ii){var opts=params[keys[ii]]
assert(opts)
opts.routes=opts.routes||[]
opts.routes.push(new_route)
opts.value=getValue(queryString(),opts)}routes.push(new_route)
routes.sort(cmpNumKeys)}function route(route_string){var keys=[]
var base=route_string.replace(route_param_regex,function(ignored,match){keys.push(match)
return"([^/&?]+)"})
routeEx({route_string:route_string,regex:new RegExp("^"+base+"(?:$|\\?)"),keys:keys})}function routeFixed(route_string,key){routeEx({route_string:route_string,regex:new RegExp("^"+route_string+"(?:$|\\?)"),value:"1",keys:[key]})}function register(opts){assert(opts.key)
assert(!params[opts.key])
opts.type=opts.type||TYPE_STRING
var regex_search="(?:[^\\w])"+opts.key+"=([^&]+)"
var regex_type=""
if(opts.type===TYPE_SET)regex_type="g"
else{opts.def=opts.def||""
opts.hide_values=opts.hide_values||{}
opts.hide_values[opts.def]=true}opts.regex=new RegExp(regex_search,regex_type);(params[opts.key]=opts).value=getValue(queryString(),opts)
var ret=opts.value
if(opts.type===TYPE_SET&&"function"===typeof Proxy)ret=new Proxy(opts.value,{set:function set(target,prop,value){if(value)target[prop]=1
else delete target[prop]
updateHistory()
return true}})
if(!window.onpopstate)window.onpopstate=onPopState
return ret}function set(key,value,value2){var opts=params[key]
assert(opts)
if(opts.type===TYPE_SET){if(Boolean(opts.value[value])!==Boolean(value2)){opts.value[value]=value2?1:0
updateHistory(opts.push)}}else if(opts.value!==value){opts.value=value
updateHistory(opts.push)}}function setMulti(values){var any=false
var push=false
for(var key in values){var value=values[key]
var opts=params[key]
assert(opts)
assert(opts.type!==TYPE_SET)
if(opts.value!==value){opts.value=value
any=true
push=push||opts.push}}if(any)updateHistory(push)}function get(key){var opts=params[key]
assert(opts)
return opts.value}function go(query_string){goInternal(query_string)
updateHistory(true)}

},{"../common/util.js":74,"assert":undefined}],59:[function(require,module,exports){
"use strict"
var floor=Math.floor,min=Math.min
var offs=0
function now(){return Date.now()+offs}module.exports=exports=now
exports.now=now
var first=true
exports.sync=function(server_time){if(first)offs=server_time-Date.now()
else offs=min(offs,server_time-Date.now())}
function toSS2020(milliseconds){return floor(milliseconds/1e3)-1577836800}exports.toSS2020=toSS2020
exports.seconds=function(){return toSS2020(now())}

},{}],60:[function(require,module,exports){
"use strict"
exports.webFSExists=webFSExists
exports.webFSGetFile=webFSGetFile
exports.webFSGetFileNames=webFSGetFileNames
exports.webFSReportUnused=webFSReportUnused
var assert=require("assert")
var _require=require("./filewatch.js"),filewatchOn=_require.filewatchOn,filewatchTriggerChange=_require.filewatchTriggerChange
var urlhash=require("./urlhash.js")
var _require2=require("../common/util.js"),clone=_require2.clone,deepEqual=_require2.deepEqual
var fs=window.glov_webfs||{}
var decoded={}
var used={}
var active_reload=false
function decode(data){var len=data[0]
var str=data[1]
var u8=new Uint8Array(len)
var idxo=0
var idxi=0
while(idxo<len){var byte=str.charCodeAt(idxi++)
if(126===byte)byte=0
else if(27===byte)byte=str.charCodeAt(idxi++)
u8[idxo++]=byte}assert.equal(idxi,str.length)
assert.equal(idxo,len)
return u8}function webFSGetFileNames(directory){var ret=[]
for(var filename in fs)if(filename.startsWith(directory))ret.push(filename)
return ret}function webFSGetFile(filename,encoding){var ret=decoded[filename]
if(ret)return ret
used[filename]=true
assert(window.glov_webfs,"Failed to load fsdata.js")
var data=fs[filename]
assert(data,"Error loading file: "+filename)
if("jsobj"===encoding){assert(!Array.isArray(data))
ret=active_reload?clone(data):data}else{assert(Array.isArray(data))
if("text"===encoding)ret=data[1]
else ret=decode(data)}return decoded[filename]=ret}function webFSExists(filename){return Boolean(fs[filename])}function webFSReportUnused(ignore_regex){ignore_regex=ignore_regex||/\.(fp|vp)$/
var tot_size=0
for(var filename in fs)if(!used[filename]&&!filename.match(ignore_regex)){console.warn("WebFS file bundled but unreferenced: "+filename)
tot_size+=fs[filename][0]}if(tot_size)console.warn("WebFS wasting "+tot_size+" bytes")}function webFSReload(){active_reload=true
window.glov_webfs=null
var scriptTag=document.createElement("script")
scriptTag.src=urlhash.getURLBase()+"fsdata.js?rl="+Date.now()
scriptTag.onload=function(){if(window.glov_webfs){var old_fs=fs
fs=window.glov_webfs
decoded={}
used={}
for(var key in fs){var old_value=old_fs[key]
var new_value=fs[key]
if(Array.isArray(old_value)){for(var ii=0;ii<new_value.length;++ii)if(!old_value||new_value[ii]!==old_value[ii]){filewatchTriggerChange(key)
break}}else if(!deepEqual(old_value,new_value))filewatchTriggerChange(key)}}}
document.getElementsByTagName("head")[0].appendChild(scriptTag)}filewatchOn("fsdata.js",webFSReload)

},{"../common/util.js":74,"./filewatch.js":18,"./urlhash.js":58,"assert":undefined}],61:[function(require,module,exports){
"use strict"
exports.ERR_RESTARTING=exports.ERR_CONNECTING=exports.ERR_CLIENT_VERSION_OLD=exports.ERR_CLIENT_VERSION_NEW=void 0
exports.WSClient=WSClient
var _glovClientEnvironments=require("./environments")
var getAPIPath=_glovClientEnvironments.getAPIPath
var setCurrentEnvironment=_glovClientEnvironments.setCurrentEnvironment
var ack=require("../common/ack.js")
var ackInitReceiver=ack.ackInitReceiver
var assert=require("assert")
var _require=require("./error_report.js"),errorReportSetDetails=_require.errorReportSetDetails,session_uid=_require.session_uid
var _require2=require("./fetch.js"),fetch=_require2.fetch,ERR_CONNECTION=_require2.ERR_CONNECTION
var min=Math.min,random=Math.random
var _require3=require("../common/perfcounters.js"),perfCounterAdd=_require3.perfCounterAdd
var urlhash=require("./urlhash.js")
var wscommon=require("../common/wscommon.js")
var wsHandleMessage=wscommon.wsHandleMessage
var _require4=require("./client_config.js"),PLATFORM=_require4.PLATFORM,getAbilityReload=_require4.getAbilityReload
var ERR_CONNECTING="ERR_CONNECTING"
exports.ERR_CONNECTING=ERR_CONNECTING
var ERR_RESTARTING="ERR_RESTARTING"
exports.ERR_RESTARTING=ERR_RESTARTING
var ERR_CLIENT_VERSION_NEW="ERR_CLIENT_VERSION_NEW"
exports.ERR_CLIENT_VERSION_NEW=ERR_CLIENT_VERSION_NEW
var ERR_CLIENT_VERSION_OLD="ERR_CLIENT_VERSION_OLD"
exports.ERR_CLIENT_VERSION_OLD=ERR_CLIENT_VERSION_OLD
exports.CURRENT_VERSION=0
function WSClient(path){this.id=null
this.my_ids={}
this.handlers={}
this.socket=null
this.net_delayer=null
this.connected=false
this.disconnected=false
this.retry_scheduled=false
this.retry_count=0
this.disconnect_time=Date.now()
this.last_receive_time=Date.now()
this.idle_counter=0
this.last_send_time=Date.now()
this.connect_error=ERR_CONNECTING
ackInitReceiver(this)
if(path)this.path=path
this.connect(false)
this.onMsg("cack",this.onConnectAck.bind(this))
this.onMsg("build",this.onBuildTimestamp.bind(this))
this.onMsg("error",this.onError.bind(this))}WSClient.prototype.logPacketDispatch=function(source,pak,buf_offs,msg){perfCounterAdd("ws."+msg)}
WSClient.prototype.timeSinceDisconnect=function(){return Date.now()-this.disconnect_time}
function getVersionUrlParams(){return"plat="+PLATFORM+"&ver="+exports.CURRENT_VERSION+"&build="+"1673321608019"}function jsonParseResponse(response){if(!response)return null
if("<"===response.trim()[0])return null
try{return JSON.parse(response)}catch(e){return null}}function whenServerReady(cb){var retry_count=0
function doit(){fetch({url:getAPIPath()+"ready?"+getVersionUrlParams()},function(err,response){if(err){var response_data=jsonParseResponse(response)
if("ERR_CLIENT_VERSION_OLD"!==(null==response_data?void 0:response_data.status)){++retry_count
setTimeout(doit,min(retry_count*retry_count*100,15e3)*(.75+.5*random()))
return}}cb()})}doit()}WSClient.prototype.onBuildTimestamp=function(build_timestamp){if(build_timestamp!=="1673321608019")if(this.on_build_timestamp_mismatch)this.on_build_timestamp_mismatch()
else if(getAbilityReload()){console.error("App build mismatch (server: "+build_timestamp+", client: "+"1673321608019"+"), reloading")
whenServerReady(function(){if(window.reloadSafe)window.reloadSafe()
else document.location.reload()})}else console.warn("App build mismatch (server: "+build_timestamp+", client: "+"1673321608019"+"), ignoring")}
WSClient.prototype.onConnectAck=function(data,resp_func){var client=this
client.connected=true
client.connect_error=null
client.disconnected=false
client.id=data.id
client.my_ids[data.id]=true
errorReportSetDetails("client_id",client.id)
client.secret=data.secret
if(data.build)client.onBuildTimestamp(data.build)
assert(client.handlers.connect)
data.client_id=client.id
client.handlers.connect(client,data)
resp_func()}
WSClient.prototype.pak=function(msg){return wscommon.wsPak(msg,null,this)}
WSClient.prototype.send=function(msg,data,resp_func){wscommon.sendMessage.call(this,msg,data,resp_func)}
WSClient.prototype.onError=function(e){console.error("WSClient Error")
console.error(e)
if(!(e instanceof Error))e=new Error(e)
throw e}
WSClient.prototype.onMsg=function(msg,cb){assert.ok(!this.handlers[msg])
this.handlers[msg]=function wrappedCallback(client,data,resp_func){return cb(data,resp_func)}}
WSClient.prototype.checkForNewAppBuild=function(){var _this=this
if(!getAbilityReload())return
if(this.new_build_check_in_progress)return
this.new_build_check_in_progress=true
fetch({url:urlhash.getURLBase()+"app.ver.json",response_type:"json"},function(err,obj){_this.new_build_check_in_progress=false
if(obj&&obj.ver)_this.onBuildTimestamp(obj.ver)
if(err&&err!==ERR_CONNECTION)if(!_this.delayed_recheck){_this.delayed_recheck=true
setTimeout(function(){_this.delayed_recheck=false
_this.checkForNewAppBuild()},1e3)}})}
WSClient.prototype.retryConnection=function(){var client=this
assert(!client.socket)
assert(!client.retry_scheduled)
client.retry_scheduled=true;++client.retry_count
this.checkForNewAppBuild()
setTimeout(function(){assert(client.retry_scheduled)
assert(!client.socket)
client.retry_scheduled=false
client.connect(true)},min(client.retry_count*client.retry_count*100,15e3)*(.75+.5*random()))}
WSClient.prototype.checkDisconnect=function(){if(this.connected&&1!==this.socket.readyState){this.on_close()
assert(!this.connected)}}
WSClient.prototype.connect=function(for_reconnect){var _this2=this
var client=this
client.socket={readyState:0}
assert(!this.ready_check_in_progress)
this.ready_check_in_progress=true
fetch({url:getAPIPath()+"ready?"+getVersionUrlParams()},function(err,response){var response_data=jsonParseResponse(response)
var status=null==response_data?void 0:response_data.status
var redirect_environment=null==response_data?void 0:response_data.redirect_environment
var update_available=null==response_data?void 0:response_data.update_available
var should_reload=update_available&&getAbilityReload()
assert(_this2.ready_check_in_progress)
_this2.ready_check_in_progress=false
_this2.connect_error=ERR_CONNECTING
if(!err&&!redirect_environment&&!should_reload){if(update_available);return void _this2.connectAfterReady(for_reconnect)}console.log("Server not ready, err="+err+", response="+response)
if("ERR_RESTARTING"===status||"ERR_STARTUP"===status)client.connect_error=ERR_RESTARTING
else if("ERR_CLIENT_VERSION_NEW"===status)client.connect_error=ERR_CLIENT_VERSION_NEW
else if("ERR_CLIENT_VERSION_OLD"===status)client.connect_error=ERR_CLIENT_VERSION_OLD
if(redirect_environment)setCurrentEnvironment(redirect_environment)
client.socket=null
client.net_delayer=null
_this2.retryConnection()})}
WSClient.prototype.connectAfterReady=function(for_reconnect){var client=this
var path=client.path||getAPIPath().replace(/^http/,"ws").replace(/api\/$/,"ws")
path=path+"?"+getVersionUrlParams()+(for_reconnect&&client.id&&client.secret?"&reconnect="+client.id+"&secret="+client.secret:"")+"&sesuid="+session_uid
var socket=new WebSocket(path)
socket.binaryType="arraybuffer"
client.socket=socket
function guard(fn){return function(){if(client.socket!==socket)return
fn.apply(void 0,arguments)}}function abort(skip_close){client.socket=null
client.net_delayer=null
if(client.connected){client.disconnect_time=Date.now()
client.disconnected=true
errorReportSetDetails("disconnected",1)}client.connected=false
client.connect_error=ERR_CONNECTING
if(!skip_close)try{socket.close()}catch(e){}client.handlers.disconnect()
ack.failAll(client)}function retry(skip_close){abort(skip_close)
client.retryConnection()}var connected=false
client.socket.addEventListener("error",guard(function(err){if(!connected){console.log("WebSocket error during initial connection, retrying...",err)
retry()}else console.error("WebSocket error",err)}))
client.socket.addEventListener("message",guard(function(message){profilerStart("WS")
assert(message.data instanceof ArrayBuffer)
wsHandleMessage(client,new Uint8Array(message.data))
profilerStop("WS")}))
client.socket.addEventListener("open",guard(function(){console.log("WebSocket open")
connected=true
client.retry_count=0}))
client.on_close=guard(function(){console.log("WebSocket close, retrying connection...")
retry(true)})
client.socket.addEventListener("close",client.on_close)
var doPing=guard(function(){if(Date.now()-client.last_send_time>=wscommon.PING_TIME&&client.connected&&1===client.socket.readyState)client.send("ping")
setTimeout(doPing,wscommon.PING_TIME/2)})
setTimeout(doPing,wscommon.PING_TIME/2)}

},{"../common/ack.js":62,"../common/perfcounters.js":72,"../common/wscommon.js":77,"./client_config.js":8,"./environments":14,"./error_report.js":15,"./fetch.js":17,"./urlhash.js":58,"assert":undefined}],62:[function(require,module,exports){
"use strict"
exports.ackHandleMessage=ackHandleMessage
exports.ackInitReceiver=ackInitReceiver
exports.ackReadHeader=ackReadHeader
exports.ackWrapPakFinish=ackWrapPakFinish
exports.ackWrapPakPayload=ackWrapPakPayload
exports.ackWrapPakStart=ackWrapPakStart
exports.failAll=failAll
var assert=require("assert")
var _require=require("./packet.js"),isPacket=_require.isPacket
var _require2=require("./perfcounters.js"),perfCounterAddValue=_require2.perfCounterAddValue
function ackInitReceiver(receiver){receiver.last_pak_id=0
receiver.resp_cbs={}
receiver.responses_waiting=0}var ERR_FAILALL_DISCONNECT="ERR_FAILALL_DISCONNECT"
var ACKFLAG_IS_RESP=8
var ACKFLAG_ERR=16
var ACKFLAG_DATA_JSON=32
function ackWrapPakStart(pak,receiver,msg){var flags=0
pak.ack_data={receiver:receiver}
if("number"===typeof msg){flags|=ACKFLAG_IS_RESP
pak.writeInt(msg)}else pak.writeAnsiString(msg)
var resp_pak_id=receiver?++receiver.last_pak_id:0
pak.ack_data.resp_pak_id=resp_pak_id
pak.ack_data.resp_pak_id_offs=pak.getOffset()
pak.writeInt(resp_pak_id)
pak.ack_data.data_offs=pak.getOffset()
pak.ack_data.flags=flags}function ackWrapPakPayload(pak,data){if(isPacket(data))pak.appendRemaining(data)
else{pak.ack_data.flags|=ACKFLAG_DATA_JSON
pak.writeJSON(data)}}function ackWrapPakFinish(pak,err,resp_func){var flags=pak.ack_data.flags
var offs=pak.getOffset()
if(err){assert.equal(pak.ack_data.data_offs,offs)
flags|=ACKFLAG_ERR
pak.writeString(String(err))
offs=pak.getOffset()}pak.makeReadable()
var resp_pak_id=0
if(resp_func&&false!==resp_func.expecting_response){resp_pak_id=pak.ack_data.resp_pak_id
assert(resp_pak_id)
assert(pak.ack_data.receiver)
pak.ack_data.receiver.resp_cbs[resp_pak_id]=resp_func}else{pak.seek(pak.ack_data.resp_pak_id_offs)
pak.zeroInt()
pak.seek(offs)}pak.updateFlags(flags)
delete pak.ack_data
return resp_pak_id}function ackReadHeader(pak){var flags=pak.getFlags()
var msg=flags&ACKFLAG_IS_RESP?pak.readInt():pak.readAnsiString()
var pak_id=pak.readInt()
var err=flags&ACKFLAG_ERR?pak.readString():void 0
var data
if(flags&ACKFLAG_DATA_JSON)data=pak.readJSON()
else data=pak
return{msg:msg,err:err,data:data,pak_id:pak_id}}function failAll(receiver,err){err=err||ERR_FAILALL_DISCONNECT
var cbs=receiver.resp_cbs
receiver.resp_cbs={}
receiver.responses_waiting=0
for(var pak_id in cbs)cbs[pak_id](err)}function ackHandleMessage(receiver,source,pak,send_func,pak_func,handle_func,filter_func){var pak_initial_offs=pak.getOffset()
var _ackReadHeader=ackReadHeader(pak),err=_ackReadHeader.err,data=_ackReadHeader.data,msg=_ackReadHeader.msg,pak_id=_ackReadHeader.pak_id
if(receiver.logPacketDispatch){perfCounterAddValue("net.recv_bytes.total",pak.totalSize())
var msg_name="number"===typeof msg?"ack":msg
perfCounterAddValue("net.recv_bytes."+msg_name,pak.totalSize())
receiver.logPacketDispatch(source,pak,pak_initial_offs,msg_name)}var now=Date.now()
var expecting_response=Boolean(pak_id)
var timeout_id
if(expecting_response)timeout_id="pending"
var sent_response=false
var start_time=now
if(filter_func&&!filter_func(receiver,msg,data))return
function preSendResp(err){assert(!sent_response,"Response function called twice")
sent_response=true
if(expecting_response){if(timeout_id){if("pending"!==timeout_id)clearTimeout(timeout_id)}else if(err===ERR_FAILALL_DISCONNECT);else(receiver.log?receiver:console).log("Response finally sent for "+msg+" after "+((Date.now()-start_time)/1e3).toFixed(1)+"s")
receiver.responses_waiting--}}function respFunc(err,resp_data,resp_func){preSendResp(err)
if(!expecting_response){if(resp_func){receiver.onError("Sending a response to a packet ("+msg+") that did not expect one, but we are expecting a response")
return}if(err)send_func("error",null,err,null)
return}send_func(pak_id,err,resp_data,resp_func)}respFunc.expecting_response=expecting_response
respFunc.pak=function(ref_pak){assert(expecting_response)
var pak=pak_func(pak_id,ref_pak)
var orig_send=pak.send
pak.send=function(err,resp_func){preSendResp(err)
orig_send.call(pak,err,resp_func)}
return pak}
if("number"===typeof msg){var cb=receiver.resp_cbs[msg]
if(!cb)return void receiver.onError("Received response to unknown packet with id "+msg+" from "+source)
delete receiver.resp_cbs[msg]
profilerStart("response")
cb(err,data,respFunc)
profilerStop("response")}else{if(!msg)return void receiver.onError("Received message with no .msg from "+source)
profilerStart(msg)
handle_func(msg,data,respFunc)
profilerStop(msg)}if(expecting_response){receiver.responses_waiting++
if(!sent_response&&!respFunc.suppress_timeout)timeout_id=setTimeout(function(){timeout_id=null
if(!respFunc.suppress_timeout)(receiver.log?receiver:console).log("Response not sent for "+msg+" from "+source+" after "+((Date.now()-start_time)/1e3).toFixed(1)+"s")},15e3)}}

},{"./packet.js":71,"./perfcounters.js":72,"assert":undefined}],63:[function(require,module,exports){
(function (Buffer){(function (){
"use strict"
var floor=Math.floor
var chr_table="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/".split("")
var PAD="="
function encode(dv,offset,length){var data=dv.u8
var result=""
var i
var effi
for(i=0;i<length-2;i+=3){result+=chr_table[data[effi=offset+i]>>2]
result+=chr_table[((3&data[effi])<<4)+(data[effi+1]>>4)]
result+=chr_table[((15&data[effi+1])<<2)+(data[effi+2]>>6)]
result+=chr_table[63&data[effi+2]]}if(length%3){result+=chr_table[data[effi=offset+(i=length-length%3)]>>2]
if(length%3===2){result+=chr_table[((3&data[effi])<<4)+(data[effi+1]>>4)]
result+=chr_table[(15&data[effi+1])<<2]
result+=PAD}else{result+=chr_table[(3&data[effi])<<4]
result+=PAD+PAD}}return result}function decodeNativeBrowser(data,allocator){var str=window.atob(data)
var len=str.length
var dv=allocator(len)
var u8=dv.u8
for(var ii=0;ii<len;++ii)u8[ii]=str.charCodeAt(ii)
dv.decode_size=len
return dv}function encodeNativeNode(dv,offset,length){return Buffer.from(dv.buffer).toString("base64",offset,offset+length)}function decodeNativeNode(data,allocator){var dv=allocator(3*(data.length>>2)+floor(data.length%4/1.5))
var buffer=Buffer.from(dv.buffer)
dv.decode_size=buffer.write(data,"base64")
return dv}var BROWSER="undefined"!==typeof window
exports.base64Decode=BROWSER?decodeNativeBrowser:decodeNativeNode
exports.base64Encode=BROWSER?encode:encodeNativeNode
exports.base64CharTable=chr_table

}).call(this)}).call(this,require("buffer").Buffer)

},{"buffer":undefined}],64:[function(require,module,exports){
"use strict"
exports.MAX_CLIENT_UPLOAD_SIZE=void 0
exports.chunkedReceiverCleanup=chunkedReceiverCleanup
exports.chunkedReceiverFinish=chunkedReceiverFinish
exports.chunkedReceiverFreeFile=chunkedReceiverFreeFile
exports.chunkedReceiverGetFile=chunkedReceiverGetFile
exports.chunkedReceiverInit=chunkedReceiverInit
exports.chunkedReceiverOnChunk=chunkedReceiverOnChunk
exports.chunkedReceiverStart=chunkedReceiverStart
exports.chunkedSend=chunkedSend
var assert=require("assert")
var _require=require("glov-async"),asyncParallelLimit=_require.asyncParallelLimit,asyncSeries=_require.asyncSeries
var crc32=require("./crc32.js")
var ceil=Math.ceil,min=Math.min
var _require2=require("./packet.js"),packetBufPoolAlloc=_require2.packetBufPoolAlloc,packetBufPoolFree=_require2.packetBufPoolFree
var MAX_CLIENT_UPLOAD_SIZE=2097152
exports.MAX_CLIENT_UPLOAD_SIZE=MAX_CLIENT_UPLOAD_SIZE
var CHUNK_SIZE=8092
function cleanupFile(state,file_id,pool){var file_data=state.files[file_id]
if(file_data.dv){packetBufPoolFree(file_data.dv)
delete file_data.dv}state.buffer_size-=file_data.length
assert(state.buffer_size>=0)
delete state.files[file_id]}function chunkedReceiverInit(name,max_buffer_size){return{name:name,max_buffer_size:max_buffer_size,last_file_id:0,buffer_size:0,files:{}}}function chunkedReceiverCleanup(state){if(!state||!state.files)return
for(var file_id in state.files)cleanupFile(state,file_id)}function chunkedReceiverFreeFile(container){var buffer=container.buffer,dv=container.dv
assert(buffer)
assert(dv)
packetBufPoolFree(dv)
delete container.buffer}function chunkedReceiverGetFile(state,file_id){if(!state)return{err:"ERR_NOT_INITIALIZED"}
function err(msg){console.error(state.name+": chunkedReceiverGetFile("+file_id+"): "+msg)
return{err:msg}}if(!state.files)return err("ERR_FILE_NOT_FOUND")
var file_data=state.files[file_id]
if(!file_data)return err("ERR_FILE_NOT_FOUND")
if(!file_data.finished){cleanupFile(state,file_id)
return err("ERR_UPLOAD_UNFINISHED")}var dv=file_data.dv,mime_type=file_data.mime_type,length=file_data.length
file_data.buffer=null
file_data.dv=null
cleanupFile(state,file_id)
return{dv:dv,mime_type:mime_type,buffer:new Uint8Array(dv.buffer,dv.byteOffset,length)}}function chunkedReceiverStart(state,pak,resp_func){assert(state)
var length=pak.readInt()
var crc=pak.readU32()
var mime_type=pak.readAnsiString()
var log=state.name+": chunkedReceiverStart length="+length+" crc="+crc+" mime="+mime_type
if(length>state.max_buffer_size){console.error(log+": ERR_TOO_LARGE")
return void resp_func("ERR_TOO_LARGE")}if(state.buffer_size+length>state.max_buffer_size){console.error(log+": ERR_OUT_OF_SPACE")
return void resp_func("ERR_OUT_OF_SPACE")}state.buffer_size+=length
var id=++state.last_file_id
console.log(log+" id="+id)
state.files[id]={length:length,crc:crc,mime_type:mime_type,total:0,dv:packetBufPoolAlloc(length)}
resp_func(null,id)}function chunkedReceiverOnChunk(state,pak,resp_func){if(!state){pak.pool()
return void resp_func("ERR_NOT_INITED")}var id=pak.readInt()
var offs=pak.readInt()
var buf=pak.readBuffer(false)
var log=state.name+": chunkedReceiverOnChunk id="+id+" offs="+offs+" length="+buf.length
var file_data=state.files&&state.files[id]
if(!file_data){console.error(log+": ERR_INVALID_FILE_ID")
return void resp_func("ERR_INVALID_FILE_ID")}if(file_data.total+buf.length>file_data.length){cleanupFile(state,id)
console.error(log+": ERR_BUFFER_OVERRUN")
return void resp_func("ERR_BUFFER_OVERRUN")}console.debug(log)
file_data.total+=buf.length
file_data.dv.u8.set(buf,offs)
if(state.on_progress)state.on_progress(file_data.total,file_data.length,file_data.mime_type,id)
resp_func()}function chunkedReceiverFinish(state,pak,resp_func){var id=pak.readInt()
if(!state)return void resp_func("ERR_NOT_INITED")
var file_data=state.files&&state.files[id]
var log=state.name+": chunkedReceiverFinish id="+id
if(!file_data){console.error(log+": ERR_INVALID_FILE_ID")
return void resp_func("ERR_INVALID_FILE_ID")}if(file_data.total!==file_data.length){cleanupFile(state,id)
console.error(log+": ERR_INCOMPLETE (total="+file_data.total+" length="+file_data.length+")")
return void resp_func("ERR_INCOMPLETE")}var crc=crc32(file_data.dv.u8,file_data.length)
if(crc!==file_data.crc){cleanupFile(state,id)
console.error(log+": ERR_CRC_MISMATCH (expected="+file_data.crc+" actual="+crc+")")
return void resp_func("ERR_CRC_MISMATCH")}file_data.finished=true
resp_func()}function chunkedSend(opts,cb){var client=opts.client,buffer=opts.buffer,mime_type=opts.mime_type,max_in_flight=opts.max_in_flight
assert(buffer instanceof Uint8Array,"Invalid data type")
assert(mime_type,"Missing mime_type")
var length=buffer.length
assert(length)
var crc=crc32(buffer)
var id
asyncSeries([function getID(next){var pak=client.pak("upload_start")
pak.writeInt(length)
pak.writeU32(crc)
pak.writeAnsiString(mime_type)
pak.send(function(err,assigned_id){id=assigned_id
next(err)})},function streamFile(next){var num_chunks=ceil(length/CHUNK_SIZE)
var any_error=false
function sendChunk(idx,next){if(any_error)return void next()
assert(idx<num_chunks)
var pak=client.pak("upload_chunk")
pak.writeInt(id)
var start=idx*CHUNK_SIZE
pak.writeInt(start)
var chunk_len=min(CHUNK_SIZE,length-start)
pak.writeBuffer(new Uint8Array(buffer.buffer,buffer.byteOffset+start,chunk_len))
pak.send(function(err){if(err)any_error=true
next(err)})}var tasks=[]
for(var ii=0;ii<num_chunks;++ii)tasks.push(sendChunk.bind(null,ii))
asyncParallelLimit(tasks,max_in_flight,next)},function finish(next){var pak=client.pak("upload_finish")
pak.writeInt(id)
pak.send(next)}],function(err){cb(err,id)})}

},{"./crc32.js":66,"./packet.js":71,"assert":undefined,"glov-async":undefined}],65:[function(require,module,exports){
"use strict"
exports.TYPE_STRING=exports.TYPE_INT=exports.TYPE_FLOAT=void 0
exports.canonical=canonical
exports.create=create
exports.defaultHandler=defaultHandler
var assert=require("assert")
var _require=require("./util.js"),isInteger=_require.isInteger
var _require2=require("./perfcounters.js"),perfCounterAdd=_require2.perfCounterAdd
function canonical(cmd){return cmd.toLowerCase().replace(/[_.]/g,"")}var TYPE_INT=0
exports.TYPE_INT=TYPE_INT
var TYPE_FLOAT=1
exports.TYPE_FLOAT=TYPE_FLOAT
var TYPE_STRING=2
exports.TYPE_STRING=TYPE_STRING
var TYPE_NAME=["INTEGER","NUMBER","STRING"]
function defaultHandler(err,resp){if(err)console.error(err,resp)
else console.info(resp)}function checkAccess(access,list){if(list)for(var ii=0;ii<list.length;++ii)if(!access||!access[list[ii]])return false
return true}function formatUsage(usage,help,prefix_help){return!usage?void 0:prefix_help?help+"\n"+usage:help?String(usage).replace(/\$HELP/,help):String(usage)}function CmdParse(params){this.cmds={}
this.cmds_for_complete=this.cmds
this.was_not_found=false
this.storage=params&&params.storage
this.default_handler=defaultHandler
this.last_access=null
this.register({cmd:"cmd_list",func:this.cmdList.bind(this),access_show:["hidden"]})}CmdParse.prototype.cmdList=function(str,resp_func){if(!this.cmd_list){var list=this.cmd_list={}
for(var cmd in this.cmds){var cmd_data=this.cmds[cmd]
var access=[]
if(cmd_data.access_show)access=access.concat(cmd_data.access_show)
if(cmd_data.access_run)access=access.concat(cmd_data.access_run)
if(-1!==access.indexOf("hidden"))continue
var data={name:cmd_data.name,help:String(cmd_data.help)}
if(cmd_data.usage)data.usage=formatUsage(cmd_data.usage,cmd_data.help,cmd_data.prefix_usage_with_help)
if(access.length)data.access_show=access
list[cmd]=data}}resp_func(null,this.cmd_list)}
CmdParse.prototype.setDefaultHandler=function(fn){assert(this.default_handler===defaultHandler)
this.default_handler=fn}
CmdParse.prototype.checkAccess=function(access_list){return checkAccess(this.last_access,access_list)}
CmdParse.prototype.handle=function(self,str,resp_func){resp_func=resp_func||this.default_handler
this.was_not_found=false
var m=str.match(/^([^\s]+)(?:\s+(.*))?$/)
if(!m){resp_func("Missing command")
return true}var cmd=canonical(m[1])
var cmd_data=this.cmds[cmd]
this.last_access=self&&self.access
if(cmd_data&&!checkAccess(this.last_access,cmd_data.access_run)){resp_func('Access denied: "'+m[1]+'"')
return false}if(!cmd_data){this.was_not_found=true
resp_func('Unknown command: "'+m[1]+'"')
return this.was_not_found=false}perfCounterAdd("cmd."+cmd)
cmd_data.fn.call(self,m[2]||"",resp_func)
return true}
CmdParse.prototype.register=function(param){assert.equal(typeof param,"object")
var cmd=param.cmd,func=param.func,help=param.help,usage=param.usage,prefix_usage_with_help=param.prefix_usage_with_help,access_show=param.access_show,access_run=param.access_run,store_data=param.store_data
assert(cmd)
assert(func,'Missing function for command "'+cmd+'"')
var help_lower=String(help||"").toLowerCase()
if(help_lower.includes("(admin)"))assert(access_run&&access_run.includes("sysadmin"))
if(help_lower.includes("(hidden)"))assert(access_show&&access_show.length)
var canon=canonical(cmd)
assert(!this.cmds[canon],'Duplicate commands registered as "'+canon+'"')
this.cmds[canon]={name:cmd,fn:func,help:help,usage:usage,prefix_usage_with_help:prefix_usage_with_help,access_show:access_show,access_run:access_run,store_data:store_data}}
function formatRangeValue(type,value){var ret=String(value)
if(type===TYPE_FLOAT&&!ret.includes("."))ret+=".00"
return ret}var CMD_STORAGE_PREFIX="cmd_parse_"
CmdParse.prototype.registerValue=function(cmd,param){var _this=this
assert(TYPE_NAME[param.type]||!param.set)
assert(param.set||param.get)
var label=param.label||cmd
var store=param.store&&this.storage||false
var store_key=""+CMD_STORAGE_PREFIX+canonical(cmd)
if(param.ver)store_key+="_"+param.ver
var store_data
if(store){assert(param.set)
store_data={store_key:store_key,param:param}
var init_value=this.storage.getJSON(store_key)
if(void 0!==init_value){if(param.range){init_value=Number(init_value)
if(!isFinite(init_value)||init_value<param.range[0]||init_value>param.range[1])init_value=void 0}if(void 0!==init_value)param.set(init_value)
if(param.on_change)param.on_change(true)}}var fn=function fn(str,resp_func){function value(){resp_func(null,label+" = "+param.get())}function usage(){resp_func("Usage: /"+cmd+" "+TYPE_NAME[param.type])}if(!str)if(param.get&&param.set){var is_bool=param.type===TYPE_INT&&param.range&&0===param.range[0]&&1===param.range[1]
var help=[label+":"]
if(param.range)help.push("Valid range: ["+formatRangeValue(param.type,param.range[0])+"..."+formatRangeValue(param.type,param.range[1])+"]")
var cur_value=param.get()
if(is_bool){help.push("To disable: /"+cmd+" 0")
help.push("To enable: /"+cmd+" 1")}else{help.push("To change: /"+cmd+" NewValue")
help.push("  example: /"+cmd+" "+(param.range?cur_value===param.range[0]?param.range[1]:param.range[0]:1))}var def_value=param.default_value
if(void 0!==def_value)help.push("Default value = "+def_value+(is_bool?" ("+(def_value?"Enabled":"Disabled")+")":""))
help.push("Current value = "+cur_value+(is_bool?" ("+(cur_value?"Enabled":"Disabled")+")":""))
return resp_func(null,help.join("\n"))}else if(param.get)return value()
else return usage()
if(!param.set)return resp_func("Usage: /"+cmd)
var n=Number(str)
if(param.range)if(n<param.range[0])n=param.range[0]
else if(n>param.range[1])n=param.range[1]
var store_value=n
if(param.type===TYPE_INT){if(!isInteger(n))return usage()
param.set(n)}else if(param.type===TYPE_FLOAT){if(!isFinite(n))return usage()
param.set(n)}else{store_value=str
param.set(str)}if(store)_this.storage.setJSON(store_key,store_value)
if(param.on_change)param.on_change(false)
if(param.get)return value()
else return resp_func(null,label+" udpated")}
this.register({cmd:cmd,func:fn,help:param.help||(param.get&&param.set?'Set or display "'+label+'" value':param.set?'Set "'+label+'" value':'Display "'+label+'" value'),usage:param.usage||(param.get?'Display "'+label+'" value\n  Usage: /'+cmd+"\n":"")+(param.set?'Set "'+label+'" value\n  Usage: /'+cmd+" NewValue":""),prefix_usage_with_help:param.prefix_usage_with_help,access_show:param.access_show,access_run:param.access_run,store_data:store_data})}
CmdParse.prototype.resetSettings=function(){var results=[]
var all_saved_data=this.storage.localStorageExportAll(CMD_STORAGE_PREFIX)
var count=0
for(var key in all_saved_data){var value=all_saved_data[key]
var cmd_name=key.slice(CMD_STORAGE_PREFIX.length)
var version=void 0
var _cmd_name$split=cmd_name.split("_")
cmd_name=_cmd_name$split[0]
version=_cmd_name$split[1]
var cmd_data=this.cmds[cmd_name]
if(!cmd_data){this.storage.set(key,void 0)
results.push('Cleared unknown setting "'+cmd_name+'" = '+value);++count}else{var _store_data$param
var name=cmd_data.name,store_data=cmd_data.store_data
var default_value=null==store_data?void 0:null==(_store_data$param=store_data.param)?void 0:_store_data$param.default_value
if(store_data&&store_data.store_key!==key){this.storage.set(key,void 0)
results.push('Cleared old setting "'+name+" (v"+(version||0)+')"');++count}else if(void 0!==default_value)if(JSON.stringify(default_value)===value)this.storage.set(key,void 0)
else{this.storage.set(key,void 0)
results.push('Cleared setting "'+name+'" = '+value+" (default = "+default_value+")");++count}else{this.storage.set(key,void 0)
results.push('Cleared setting "'+name+'" = '+value);++count}}}if(results.length)results.push("Reset "+count+" setting(s)")
return results}
function cmpCmd(a,b){if(a.cname<b.cname)return-1
return 1}CmdParse.prototype.addServerCommands=function(new_cmds){var cmds=this.cmds_for_complete
if(this.cmds_for_complete===this.cmds){cmds=this.cmds_for_complete={}
for(var cname in this.cmds)cmds[cname]=this.cmds[cname]}for(var _cname in new_cmds)if(!cmds[_cname])cmds[_cname]=new_cmds[_cname]}
CmdParse.prototype.autoComplete=function(str,access){var list=[]
var first_tok=canonical((str=str.split(" "))[0])
for(var cname in this.cmds_for_complete)if(1===str.length&&cname.slice(0,first_tok.length)===first_tok||str.length>1&&cname===first_tok){var cmd_data=this.cmds_for_complete[cname]
if(checkAccess(access,cmd_data.access_show)&&checkAccess(access,cmd_data.access_run))list.push({cname:cname,cmd:cmd_data.name,help:String(cmd_data.help),usage:formatUsage(cmd_data.usage,cmd_data.help,cmd_data.prefix_usage_with_help)})}list.sort(cmpCmd)
return list}
CmdParse.prototype.canonical=canonical
CmdParse.prototype.TYPE_INT=TYPE_INT
CmdParse.prototype.TYPE_FLOAT=TYPE_FLOAT
CmdParse.prototype.TYPE_STRING=TYPE_STRING
function create(params){return new CmdParse(params)}

},{"./perfcounters.js":72,"./util.js":74,"assert":undefined}],66:[function(require,module,exports){
"use strict"
var crc_table=new Array(256);(function(){for(var n=0;n<256;n++){var c=n
for(var k=0;k<8;k++)if(1&c)c=-306674912^c>>>1
else c>>>=1
crc_table[n]=c}})()
function update_crc(crc,buf,len){for(var n=0;n<len;n++)crc=crc_table[255&(crc^buf[n])]^crc>>>8
return crc}function crc32(buf,len){return(4294967295^update_crc(4294967295,buf,len=len||buf.length))>>>0}module.exports=crc32
module.exports.crc32=crc32

},{}],67:[function(require,module,exports){
"use strict"
var _require=require("./util.js"),arrayToSet=_require.arrayToSet
var disallowedKeys=arrayToSet(["__proto__","prototype","constructor"])
function isObject(value){var type=typeof value
return null!==value&&("object"===type||"function"===type)}function isValidPath(pathSegments){for(var ii=0;ii<pathSegments.length;++ii)if(disallowedKeys[pathSegments[ii]])return false
return true}function getPathSegments(path){var pathArray=path.split(".")
var parts=[]
for(var i=0;i<pathArray.length;i++){var p=pathArray[i]
while("\\"===p[p.length-1]&&void 0!==pathArray[i+1]){p=p.slice(0,-1)+"."
p+=pathArray[++i]}parts.push(p)}if(!isValidPath(parts))return[]
return parts}module.exports={get:function get(object,path,value){if(!isObject(object)||"string"!==typeof path)return void 0===value?object:value
var pathArray=getPathSegments(path)
if(0===pathArray.length)return value
for(var i=0;i<pathArray.length;i++)if(void 0===(object=object[pathArray[i]])||null===object){if(i!==pathArray.length-1)return value
break}return void 0===object?value:object},set:function set(object,path,value){if(!isObject(object)||"string"!==typeof path)return object
var root=object
var pathArray=getPathSegments(path)
for(var i=0;i<pathArray.length;i++){var p=pathArray[i]
if(i===pathArray.length-1)object[p]=value
else if(!isObject(object[p]))object[p]={}
object=object[p]}return root},delete:function _delete(object,path){if(!isObject(object)||"string"!==typeof path)return false
var pathArray=getPathSegments(path)
for(var i=0;i<pathArray.length;i++){var p=pathArray[i]
if(i===pathArray.length-1){delete object[p]
return true}if(!isObject(object=object[p]))return false}},has:function has(object,path){if(!isObject(object)||"string"!==typeof path)return false
var pathArray=getPathSegments(path)
if(0===pathArray.length)return false
for(var i=0;i<pathArray.length;i++)if(isObject(object)){if(!(pathArray[i]in object))return false
object=object[pathArray[i]]}else return false
return true}}

},{"./util.js":74}],68:[function(require,module,exports){
"use strict"
exports.Platform=exports.PRESENCE_OFFLINE=exports.PRESENCE_INACTIVE=exports.PRESENCE_ACTIVE=exports.ID_PROVIDER_FB_INSTANT=exports.ID_PROVIDER_FB_GAMING=exports.ID_PROVIDER_APPLE=void 0
exports.getPlatformValues=getPlatformValues
exports.getStringEnumValues=getStringEnumValues
exports.isValidNumberEnumKey=isValidNumberEnumKey
exports.isValidPlatform=isValidPlatform
exports.isValidStringEnumKey=isValidStringEnumKey
exports.isValidStringEnumValue=isValidStringEnumValue
var PRESENCE_OFFLINE=0
exports.PRESENCE_OFFLINE=PRESENCE_OFFLINE
var PRESENCE_ACTIVE=1
exports.PRESENCE_ACTIVE=PRESENCE_ACTIVE
var PRESENCE_INACTIVE=2
exports.PRESENCE_INACTIVE=PRESENCE_INACTIVE
var ID_PROVIDER_APPLE="apl"
exports.ID_PROVIDER_APPLE=ID_PROVIDER_APPLE
var ID_PROVIDER_FB_GAMING="fbg"
exports.ID_PROVIDER_FB_GAMING=ID_PROVIDER_FB_GAMING
var ID_PROVIDER_FB_INSTANT="fbi"
exports.ID_PROVIDER_FB_INSTANT=ID_PROVIDER_FB_INSTANT
function getStringEnumValues(e){return Object.values(e)}function isValidNumberEnumKey(e,k){return"number"===typeof e[k]}function isValidStringEnumKey(e,k){return k in e}function isValidStringEnumValue(e,v){for(var key in e)if(e[key]===v)return true
return false}var Platform;(function(Platform){Platform["Android"]="android"
Platform["FBInstant"]="fbinstant"
Platform["IOS"]="ios"
Platform["Web"]="web"
Platform["Yandex"]="yandex"})((exports.Platform=Platform)||(exports.Platform=Platform={}))
function getPlatformValues(){return getStringEnumValues(Platform)}function isValidPlatform(v){return isValidStringEnumValue(Platform,v)}

},{}],69:[function(require,module,exports){
"use strict"
exports.FriendStatus=void 0
var FriendStatus;(function(FriendStatus){FriendStatus[FriendStatus["Added"]=1]="Added"
FriendStatus[FriendStatus["AddedAuto"]=2]="AddedAuto"
FriendStatus[FriendStatus["Removed"]=3]="Removed"
FriendStatus[FriendStatus["Blocked"]=4]="Blocked"})((exports.FriendStatus=FriendStatus)||(exports.FriendStatus=FriendStatus={}))

},{}],70:[function(require,module,exports){
"use strict"
var assert=require("assert")
function stringUtf8Encode(str){var c
var n
var utftext=[]
str=str.replace(/\r\n/g,"\n")
for(n=0;n<str.length;++n)if((c=str.charCodeAt(n))<128)utftext.push(String.fromCharCode(c))
else if(c>127&&c<2048){utftext.push(String.fromCharCode(c>>6|192))
utftext.push(String.fromCharCode(63&c|128))}else{utftext.push(String.fromCharCode(c>>12|224))
utftext.push(String.fromCharCode(c>>6&63|128))
utftext.push(String.fromCharCode(63&c|128))}return utftext.join("")}function rotateLeft(lValue,iShiftBits){return lValue<<iShiftBits|lValue>>>32-iShiftBits}function addUnsigned(lX,lY){var lX8=2147483648&lX
var lY8=2147483648&lY
var lX4=1073741824&lX
var lY4=1073741824&lY
var lResult=(1073741823&lX)+(1073741823&lY)
if(lX4&lY4)return 2147483648^lResult^lX8^lY8
if(lX4|lY4)if(1073741824&lResult)return 3221225472^lResult^lX8^lY8
else return 1073741824^lResult^lX8^lY8
else return lResult^lX8^lY8}function F(x,y,z){return x&y|~x&z}function G(x,y,z){return x&z|y&~z}function H(x,y,z){return x^y^z}function I(x,y,z){return y^(x|~z)}function FF(a,b,c,d,x,s,ac){a=addUnsigned(a,addUnsigned(addUnsigned(F(b,c,d),x),ac))
return addUnsigned(rotateLeft(a,s),b)}function GG(a,b,c,d,x,s,ac){a=addUnsigned(a,addUnsigned(addUnsigned(G(b,c,d),x),ac))
return addUnsigned(rotateLeft(a,s),b)}function HH(a,b,c,d,x,s,ac){a=addUnsigned(a,addUnsigned(addUnsigned(H(b,c,d),x),ac))
return addUnsigned(rotateLeft(a,s),b)}function II(a,b,c,d,x,s,ac){a=addUnsigned(a,addUnsigned(addUnsigned(I(b,c,d),x),ac))
return addUnsigned(rotateLeft(a,s),b)}function convertToWordArray(string){var lMessageLength=string.length
var lNumberOfWords_temp1=lMessageLength+8
var lNumberOfWords=16*((lNumberOfWords_temp1-lNumberOfWords_temp1%64)/64+1)
var lWordArray=new Array(lNumberOfWords-1)
var lBytePosition=0
var lByteCount=0
while(lByteCount<lMessageLength){lBytePosition=lByteCount%4*8
lWordArray[(lByteCount-lByteCount%4)/4]|=string.charCodeAt(lByteCount)<<lBytePosition
lByteCount++}lWordArray[(lByteCount-lByteCount%4)/4]|=128<<(lBytePosition=lByteCount%4*8)
lWordArray[lNumberOfWords-2]=lMessageLength<<3
lWordArray[lNumberOfWords-1]=lMessageLength>>>29
return lWordArray}function wordToHex(lValue){var wordToHexValue=""
var wordToHexValue_temp=""
var lCount
for(lCount=0;lCount<=3;lCount++)wordToHexValue+=(wordToHexValue_temp="0"+(lValue>>>8*lCount&255).toString(16)).substr(wordToHexValue_temp.length-2,2)
return wordToHexValue}module.exports=function md5(string){var AA
var BB
var CC
var DD
var a
var b
var c
var d
var k
var S11=7
var S12=12
var S13=17
var S14=22
var S21=5
var S22=9
var S23=14
var S24=20
var S31=4
var S32=11
var S33=16
var S34=23
var S41=6
var S42=10
var S43=15
var S44=21
var x
if("string"===typeof string)x=convertToWordArray(string=stringUtf8Encode(string))
else assert(false)
a=1732584193
b=4023233417
c=2562383102
d=271733878
for(k=0;k<x.length;k+=16){a=FF(AA=a,BB=b,CC=c,DD=d,x[k],S11,3614090360)
d=FF(d,a,b,c,x[k+1],S12,3905402710)
c=FF(c,d,a,b,x[k+2],S13,606105819)
b=FF(b,c,d,a,x[k+3],S14,3250441966)
a=FF(a,b,c,d,x[k+4],S11,4118548399)
d=FF(d,a,b,c,x[k+5],S12,1200080426)
c=FF(c,d,a,b,x[k+6],S13,2821735955)
b=FF(b,c,d,a,x[k+7],S14,4249261313)
a=FF(a,b,c,d,x[k+8],S11,1770035416)
d=FF(d,a,b,c,x[k+9],S12,2336552879)
c=FF(c,d,a,b,x[k+10],S13,4294925233)
b=FF(b,c,d,a,x[k+11],S14,2304563134)
a=FF(a,b,c,d,x[k+12],S11,1804603682)
d=FF(d,a,b,c,x[k+13],S12,4254626195)
c=FF(c,d,a,b,x[k+14],S13,2792965006)
a=GG(a,b=FF(b,c,d,a,x[k+15],S14,1236535329),c,d,x[k+1],S21,4129170786)
d=GG(d,a,b,c,x[k+6],S22,3225465664)
c=GG(c,d,a,b,x[k+11],S23,643717713)
b=GG(b,c,d,a,x[k],S24,3921069994)
a=GG(a,b,c,d,x[k+5],S21,3593408605)
d=GG(d,a,b,c,x[k+10],S22,38016083)
c=GG(c,d,a,b,x[k+15],S23,3634488961)
b=GG(b,c,d,a,x[k+4],S24,3889429448)
a=GG(a,b,c,d,x[k+9],S21,568446438)
d=GG(d,a,b,c,x[k+14],S22,3275163606)
c=GG(c,d,a,b,x[k+3],S23,4107603335)
b=GG(b,c,d,a,x[k+8],S24,1163531501)
a=GG(a,b,c,d,x[k+13],S21,2850285829)
d=GG(d,a,b,c,x[k+2],S22,4243563512)
c=GG(c,d,a,b,x[k+7],S23,1735328473)
a=HH(a,b=GG(b,c,d,a,x[k+12],S24,2368359562),c,d,x[k+5],S31,4294588738)
d=HH(d,a,b,c,x[k+8],S32,2272392833)
c=HH(c,d,a,b,x[k+11],S33,1839030562)
b=HH(b,c,d,a,x[k+14],S34,4259657740)
a=HH(a,b,c,d,x[k+1],S31,2763975236)
d=HH(d,a,b,c,x[k+4],S32,1272893353)
c=HH(c,d,a,b,x[k+7],S33,4139469664)
b=HH(b,c,d,a,x[k+10],S34,3200236656)
a=HH(a,b,c,d,x[k+13],S31,681279174)
d=HH(d,a,b,c,x[k],S32,3936430074)
c=HH(c,d,a,b,x[k+3],S33,3572445317)
b=HH(b,c,d,a,x[k+6],S34,76029189)
a=HH(a,b,c,d,x[k+9],S31,3654602809)
d=HH(d,a,b,c,x[k+12],S32,3873151461)
c=HH(c,d,a,b,x[k+15],S33,530742520)
a=II(a,b=HH(b,c,d,a,x[k+2],S34,3299628645),c,d,x[k],S41,4096336452)
d=II(d,a,b,c,x[k+7],S42,1126891415)
c=II(c,d,a,b,x[k+14],S43,2878612391)
b=II(b,c,d,a,x[k+5],S44,4237533241)
a=II(a,b,c,d,x[k+12],S41,1700485571)
d=II(d,a,b,c,x[k+3],S42,2399980690)
c=II(c,d,a,b,x[k+10],S43,4293915773)
b=II(b,c,d,a,x[k+1],S44,2240044497)
a=II(a,b,c,d,x[k+8],S41,1873313359)
d=II(d,a,b,c,x[k+15],S42,4264355552)
c=II(c,d,a,b,x[k+6],S43,2734768916)
b=II(b,c,d,a,x[k+13],S44,1309151649)
a=II(a,b,c,d,x[k+4],S41,4149444226)
d=II(d,a,b,c,x[k+11],S42,3174756917)
c=II(c,d,a,b,x[k+2],S43,718787259)
b=II(b,c,d,a,x[k+9],S44,3951481745)
a=addUnsigned(a,AA)
b=addUnsigned(b,BB)
c=addUnsigned(c,CC)
d=addUnsigned(d,DD)}return(wordToHex(a)+wordToHex(b)+wordToHex(c)+wordToHex(d)).toLowerCase()}

},{"assert":undefined}],71:[function(require,module,exports){
(function (Buffer){(function (){
"use strict"
exports.packetBufPoolAlloc=packetBufPoolAlloc
exports.packetBufPoolFree=packetBufPoolFree
exports.packetDefaultFlags=packetDefaultFlags
exports.packetEnableDebug=packetEnableDebug
var PACKET_DEBUG=exports.PACKET_DEBUG=1
var PACKET_RESERVED1=exports.PACKET_RESERVED1=2
var PACKET_RESERVED2=exports.PACKET_RESERVED2=4
var FLAG_PACKET_INTERNAL=PACKET_DEBUG|PACKET_RESERVED1|PACKET_RESERVED2
var PACKET_UNOWNED_BUFFER=256
var assert=require("assert")
var max=Math.max
var _require=require("./util.js"),deprecate=_require.deprecate,isInteger=_require.isInteger,log2=_require.log2
var _require2=require("./base64.js"),base64Encode=_require2.base64Encode,base64Decode=_require2.base64Decode
deprecate(exports,"default_flags")
var FALSYS=[void 0,null,0,false,"",NaN]
var PAK_BUF_DEFAULT_SIZE=1024
var UNDERRUN="PKTERR_UNDERRUN"
var POOL_PACKETS=5e3
var POOL_TIMEOUT=5e3
var POOL_BUF_BY_SIZE=[0,10,10,20,20,20,20,20,20,20,5e3,20,20,20,20,20,20,10,10]
var pak_pool=[]
var pak_debug_pool=[]
var buf_pool=POOL_BUF_BY_SIZE.map(function(){return[]})
function allocDataView(size){var pool_idx=log2(size)
assert(pool_idx)
if(pool_idx>=buf_pool.length)pool_idx=0
if(pool_idx){size=1<<pool_idx
if(buf_pool[pool_idx].length)return buf_pool[pool_idx].pop()}var u8=new Uint8Array(size)
var dv=new DataView(u8.buffer)
dv.u8=u8
if(pool_idx)dv.packet_pool_idx=pool_idx
return dv}function wrapU8AsDataView(u8){var dv=new DataView(u8.buffer,u8.byteOffset,u8.byteLength)
dv.u8=u8
return dv}function utf8ByteLength(str){var len=str.length
var ret=len
for(var ii=0;ii<len;++ii){var c=str.charCodeAt(ii)
if(c>127){++ret
if(c>2047){++ret
if(c>65535){++ret
if(c>2097151){++ret
if(c>67108863)++ret}}}}}return ret}function utf8WriteChar(buf,buf_offs,c){if(c>1114111)c=65535
if(c<=127)buf.u8[buf_offs++]=c
else if(c<=2047){buf.u8[buf_offs++]=c>>6|192
buf.u8[buf_offs++]=63&c|128}else if(c<=65535){buf.u8[buf_offs++]=c>>12|224
buf.u8[buf_offs++]=c>>6&63|128
buf.u8[buf_offs++]=63&c|128}else if(c<=1114111){buf.u8[buf_offs++]=c>>18|240
buf.u8[buf_offs++]=c>>12&63|128
buf.u8[buf_offs++]=c>>6&63|128
buf.u8[buf_offs++]=63&c|128}else assert(false)
return buf_offs}function poolBuf(dv){assert(dv)
assert(dv.u8)
var pool_idx=dv.packet_pool_idx
if(pool_idx){var arr=buf_pool[pool_idx]
if(arr.length<POOL_BUF_BY_SIZE[pool_idx])arr.push(dv)}}function packetBufPoolAlloc(size){return allocDataView(size)}function packetBufPoolFree(dv){poolBuf(dv)}var default_flags=0
function packetDefaultFlags(){return default_flags}function packetEnableDebug(enable){if(enable)default_flags|=PACKET_DEBUG}function Packet(flags,init_size,pak_debug){this.reinit(flags,init_size,pak_debug)}Packet.prototype.reinit=function(flags,init_size,pak_debug){this.flags=flags||0
this.has_flags=false
this.buf=null
this.buf_len=0
this.buf_offs=0
this.bufs=null
this.bsizes=null
this.readable=false
this.ref_count=1
this.pak_debug=pak_debug
if(init_size){this.fit(init_size,true)
this.buf_len=init_size}}
Packet.prototype.getRefCount=function(){return this.ref_count}
Packet.prototype.ref=function(){assert(this.ref_count);++this.ref_count}
Packet.prototype.pool=function(){assert(this.ref_count)
if(--this.ref_count)return
if(this.flags&PACKET_UNOWNED_BUFFER);else{if(this.buf)poolBuf(this.buf)
if(this.bufs)for(var ii=0;ii<this.bufs.length;++ii)poolBuf(this.bufs[ii])}if(pak_pool.length<POOL_PACKETS)pak_pool.push(this)
if(this.pak_debug)this.pak_debug.poolDebug()}
Packet.prototype.totalSize=function(){var ret=0
if(this.readable)return this.buf_len
if(this.bsizes)for(var ii=0;ii<this.bsizes.length;++ii)ret+=this.bsizes[ii]
return ret+=this.buf_offs}
Packet.prototype.setReadable=function(){assert(this.buf)
assert(!this.bufs)
assert(!this.readable)
this.readable=true}
Packet.prototype.makeReadable=function(){assert(this.buf)
assert(!this.readable)
var total=this.totalSize()
this.readable=true
if(!this.bufs){this.buf_len=total
this.buf_offs=0
return}var buf=allocDataView(total)
var u8=buf.u8
var offs=0
for(var ii=0;ii<this.bufs.length;++ii){var bsize=this.bsizes[ii]
var dv=this.bufs[ii]
if(offs+dv.u8.length>total){assert.equal(dv.byteOffset,0)
u8.set(new Uint8Array(dv.buffer,0,bsize),offs)}else u8.set(dv.u8,offs)
offs+=bsize
poolBuf(dv)}assert.equal(this.buf.byteOffset,0)
u8.set(new Uint8Array(this.buf.buffer,this.buf.byteOffset,this.buf_offs),offs)
poolBuf(this.buf)
assert.equal(offs+this.buf_offs,total)
this.bufs=this.bsizes=null
this.buf=buf
this.buf_offs=0
this.buf_len=total}
Packet.prototype.flush=function(){var buf=this.buf,buf_offs=this.buf_offs
if(!this.bufs){this.bufs=[buf]
this.bsizes=[buf_offs]}else{this.bufs.push(buf)
this.bsizes.push(buf_offs)}this.buf=null
this.buf_len=0
this.buf_offs=0}
Packet.prototype.fit=function(extra_bytes,no_advance){var buf=this.buf,buf_len=this.buf_len,buf_offs=this.buf_offs
var new_offs=buf_offs+extra_bytes
if(new_offs<=buf_len){if(!no_advance)this.buf_offs=new_offs
return buf_offs}assert(!this.readable)
if(buf)this.flush()
this.buf_len=buf_len=max(PAK_BUF_DEFAULT_SIZE,extra_bytes)
this.buf=allocDataView(buf_len)
this.buf_offs=no_advance?0:extra_bytes
return 0}
Packet.prototype.advance=function(bytes){var offs=this.buf_offs
var new_offs=offs+bytes
if((this.buf_offs=new_offs)>this.buf_len)throw new Error(UNDERRUN)
if(new_offs===this.buf_len)this.pool()
return offs}
Packet.prototype.ended=function(){return this.buf_offs===this.buf_len}
Packet.prototype.writeU8=function(v){assert(v>=0&&v<256)
var offs=this.fit(1)
this.buf.u8[offs]=v}
Packet.prototype.readU8=function(){return this.buf.u8[this.advance(1)]}
Packet.prototype.writeInt=function(v){assert(isInteger(v))
var offs=this.fit(9,true)
var buf=this.buf
var neg=v<0?1:0
if(neg)v=-v
if(v<248){if(neg)buf.u8[offs++]=255
buf.u8[offs++]=v}else if(v<65536){buf.u8[offs++]=248+neg
buf.setUint16(offs,v,true)
offs+=2}else if(v<4294967296){buf.u8[offs++]=250+neg
buf.setUint32(offs,v,true)
offs+=4}else{buf.u8[offs++]=252+neg
var low_bits=v>>>0
buf.setUint32(offs,low_bits,true)
buf.setUint32(offs+=4,(v-low_bits)/4294967296,true)
offs+=4}this.buf_offs=offs}
Packet.prototype.zeroInt=function(){var b1=this.buf.u8[this.buf_offs]
if(b1<248){this.buf.u8[this.buf_offs++]=0
return}this.buf_offs++
var zeroes
switch(b1){case 253:case 252:zeroes=8
break
case 251:case 250:zeroes=4
break
case 249:case 248:zeroes=2
break
case 255:zeroes=1
break
default:throw new Error("PKTERR_PACKED_INT")}while(zeroes){--zeroes
this.buf.u8[this.buf_offs++]=0}}
Packet.prototype.readInt=function(){var b1=this.buf.u8[this.advance(1)]
if(b1<248)return b1
var sign=1
switch(b1){case 249:sign=-1
case 248:return sign*this.buf.getUint16(this.advance(2),true)
case 251:sign=-1
case 250:return sign*this.buf.getUint32(this.advance(4),true)
case 253:sign=-1
case 252:var low_bits=this.buf.getUint32(this.advance(4),true)
return sign*(4294967296*this.buf.getUint32(this.advance(4),true)+low_bits)
case 255:return-this.buf.u8[this.advance(1)]
default:throw new Error("PKTERR_PACKED_INT")}}
Packet.prototype.writeFloat=function(v){assert.equal(typeof v,"number")
if(!v){this.buf.u8[this.fit(1)]=0
return}var offs=this.fit(5,true)
this.buf.setFloat32(offs,v,true)
if(this.buf.u8[offs]<=1){this.buf.u8[offs++]=1
this.buf.setFloat32(offs,v,true)}this.buf_offs=offs+4}
Packet.prototype.readFloat=function(){var offs=this.advance(1)
var b1=this.buf.u8[offs]
if(!b1)return 0
if(1===b1)return this.buf.getFloat32(this.advance(4),true)
this.advance(3)
return this.buf.getFloat32(offs,true)}
Packet.prototype.writeU32=function(v){assert.equal(typeof v,"number")
this.buf.setUint32(this.fit(4),v,true)}
Packet.prototype.readU32=function(){return this.buf.getUint32(this.advance(4),true)}
Packet.prototype.writeString=function(v){assert.equal(typeof v,"string")
var byte_length=utf8ByteLength(v)
this.writeInt(byte_length)
if(!byte_length)return
var offs=this.fit(byte_length)
var buf=this.buf
for(var ii=0;ii<v.length;++ii){var c=v.charCodeAt(ii)
if(c<=127)buf.u8[offs++]=c
else offs=utf8WriteChar(buf,offs,c)}}
Packet.prototype.utf8ReadChar=function(c){var buf=this.buf
if(c>=192&&c<224)return(31&c)<<6|63&buf.u8[this.buf_offs++]
else if(c>=224&&c<240)return(15&c)<<12|(63&buf.u8[this.buf_offs++])<<6|63&buf.u8[this.buf_offs++]
else if(c>=240&&c<248)return(15&c)<<18|(63&buf.u8[this.buf_offs++])<<12|(63&buf.u8[this.buf_offs++])<<6|63&buf.u8[this.buf_offs++]
else return 65533}
var string_assembly=[]
Packet.prototype.readString=function(){var byte_length=this.readInt()
if(!byte_length)return""
if(this.buf_offs+byte_length>this.buf_len)throw new Error(UNDERRUN)
var buf=this.buf
var end_offset=this.buf_offs+byte_length
var ret
if(byte_length>8192){ret=""
while(this.buf_offs<end_offset){var c=buf.u8[this.buf_offs++]
if(c>127)c=this.utf8ReadChar(c)
ret+=String.fromCharCode(c)}}else{string_assembly.length=byte_length
var ii=0
while(this.buf_offs<end_offset){var _c=buf.u8[this.buf_offs++]
if(_c>127)_c=this.utf8ReadChar(_c)
string_assembly[ii++]=_c}if(string_assembly.length!==ii)string_assembly.length=ii
ret=String.fromCharCode.apply(void 0,string_assembly)}if(this.buf_offs===this.buf_len)this.pool()
return ret}
Packet.prototype.writeAnsiString=function(v){assert.equal(typeof v,"string")
var byte_length=v.length
this.writeInt(byte_length)
var offs=this.fit(byte_length)
var buf=this.buf
for(var ii=0;ii<byte_length;++ii)buf.u8[offs++]=v.charCodeAt(ii)}
Packet.prototype.readAnsiString=function(){var len=this.readInt()
if(!len)return""
var offs=this.advance(len)
var buf=this.buf
string_assembly.length=len
for(var ii=0;ii<len;++ii)string_assembly[ii]=buf.u8[offs++]
return String.fromCharCode.apply(void 0,string_assembly)}
Packet.prototype.writeJSON=function(v){if(!v){var idx=FALSYS.indexOf(v)
assert(-1!==idx)
this.writeU8(idx+1)
return}this.writeU8(0)
this.writeString(JSON.stringify(v))}
Packet.prototype.readJSON=function(){var byte=this.readU8()
if(byte){if(byte-1>=FALSYS.length)throw new Error("PKTERR_JSON_HEADER")
return FALSYS[byte-1]}var str=this.readString()
return JSON.parse(str)}
Packet.prototype.writeBuffer=function(v){this.writeInt(v.length)
if(v.length){var offs=this.fit(v.length)
this.buf.u8.set(v,offs)}}
var null_buf=new Uint8Array(0)
Packet.prototype.readBuffer=function(do_copy){var len=this.readInt()
if(!len)return null_buf
var offs=this.advance(len)
if(do_copy)return this.buf.u8.slice(offs,offs+len)
else{var buf=this.buf
return new Uint8Array(buf.buffer,buf.byteOffset+offs,len)}}
Packet.prototype.writeBool=function(v){this.writeU8(v?1:0)}
Packet.prototype.readBool=function(){return Boolean(this.readU8())}
Packet.prototype.append=function(pak){assert.equal(this.flags&FLAG_PACKET_INTERNAL,pak.flags&FLAG_PACKET_INTERNAL)
if(pak.bufs)for(var ii=0;ii<pak.bufs.length;++ii){var buf=pak.bufs[ii]
var bsize=pak.bsizes[ii]
var offs=this.fit(bsize)
if(bsize!==buf.byteLength)this.buf.u8.set(new Uint8Array(buf.buffer,buf.byteOffset,bsize),offs)
else this.buf.u8.set(buf.u8,offs)}if(pak.buf){var _buf=pak.buf
var _bsize=pak.readable?pak.buf_len:pak.buf_offs
var _offs=this.fit(_bsize)
if(_bsize!==_buf.byteLength)this.buf.u8.set(new Uint8Array(_buf.buffer,_buf.byteOffset,_bsize),_offs)
else this.buf.u8.set(_buf.u8,_offs)}}
Packet.prototype.appendRemaining=function(pak){assert.equal(this.flags&FLAG_PACKET_INTERNAL,pak.flags&FLAG_PACKET_INTERNAL)
assert(pak.readable)
assert(!pak.bufs)
assert(pak.buf)
assert(pak.buf_offs<=pak.buf_len)
var bsize=pak.buf_len-pak.buf_offs
if(bsize){var offs=this.fit(bsize)
this.buf.u8.set(new Uint8Array(pak.buf.buffer,pak.buf.byteOffset+pak.buf_offs,bsize),offs)}pak.pool()}
Packet.prototype.toJSON=function(){var ret={f:this.flags}
if(this.bufs){ret.b=[]
for(var ii=0;ii<this.bufs.length;++ii)ret.b.push(base64Encode(this.bufs[ii],0,this.bsizes[ii]))}if(this.buf)if(this.readable)ret.d=base64Encode(this.buf,0,this.buf_len)
else ret.d=base64Encode(this.buf,0,this.buf_offs)
return ret}
Packet.prototype.setBuffer=function(buf,buf_len){assert(!this.buf)
assert(!this.bufs)
assert(this.flags&PACKET_UNOWNED_BUFFER)
assert(buf instanceof Uint8Array)
this.buf=wrapU8AsDataView(buf)
this.buf_len=buf_len
this.readable=true}
Packet.prototype.getBuffer=function(){assert(this.buf)
assert(!this.bufs)
return this.buf.u8}
Packet.prototype.getBufferLen=function(){assert(this.buf)
assert(!this.bufs)
return this.readable?this.buf_len:this.buf_offs}
Packet.prototype.getOffset=function(){if(this.readable)return this.buf_offs
return this.totalSize()}
Packet.prototype.seek=function(pos){assert(this.readable)
assert(pos>=0&&pos<=this.buf_len)
this.buf_offs=pos}
Packet.prototype.writeFlags=function(){assert(!this.has_flags)
assert.equal(this.buf_offs,0)
this.writeU8(this.flags)
this.has_flags=true}
Packet.prototype.updateFlags=function(flags){assert(this.has_flags)
assert(!(flags&FLAG_PACKET_INTERNAL))
this.flags=this.flags&FLAG_PACKET_INTERNAL|flags;(this.bufs?this.bufs[0]:this.buf).u8[0]=this.flags}
Packet.prototype.readFlags=function(){var read=this.readU8()
assert.equal(read,255&this.flags)
this.has_flags=true
return this.flags}
Packet.prototype.getFlags=function(){return this.flags}
Packet.prototype.getInternalFlags=function(){return this.flags&FLAG_PACKET_INTERNAL}
Packet.prototype.contents=function(){return"pak("+this.totalSize()+"b)"}
function PacketDebug(flags,init_size){this.reinit(flags,init_size)}PacketDebug.prototype.reinit=function(flags,init_size){var _this=this
this.in_pool=false
if(pak_pool.length){this.pak=pak_pool.pop()
this.pak.reinit(flags,init_size,this)}else this.pak=new Packet(flags,init_size,this)
this.warned=false
this.pool_timer=setTimeout(function(){console.warn("Packet not pooled after 5s: "+_this.contents())
_this.warned=true},POOL_TIMEOUT)}
PacketDebug.prototype.poolDebug=function(){if(this.warned)console.warn("Packet pooled after timeout")
else clearTimeout(this.pool_timer)
assert(!this.in_pool)
this.in_pool=true
if(pak_debug_pool.length<POOL_PACKETS)pak_debug_pool.push(this)}
var types=[null,"U8","U32","Int","Float","String","AnsiString","JSON","Bool","Buffer"]
types.forEach(function(type,idx){if(!type)return
var write="write"+type
var read="read"+type
var write_fn=Packet.prototype[write]
var read_fn=Packet.prototype[read]
PacketDebug.prototype[write]=function(v){this.pak.writeU8(idx)
write_fn.call(this.pak,v)}
PacketDebug.prototype[read]=function(param){var found_idx=this.pak.readU8()
if(found_idx!==idx)assert(false,"PacketDebug error: Expected "+type+"("+idx+"), found "+types[found_idx]+"("+found_idx+")")
return read_fn.call(this.pak,param)}})
PacketDebug.prototype.zeroInt=function(){this.pak.writeU8(3)
this.pak.zeroInt()};["ended","getBuffer","getBufferLen","getFlags","getInternalFlags","getOffset","getRefCount","makeReadable","pool","readFlags","ref","seek","setBuffer","setReadable","toJSON","totalSize","updateFlags","writeFlags"].forEach(function(fname){var fn=Packet.prototype[fname]
PacketDebug.prototype[fname]=function(){return fn.apply(this.pak,arguments)}})
PacketDebug.prototype.append=function(pak){assert(pak instanceof PacketDebug)
this.pak.append(pak.pak)}
PacketDebug.prototype.appendRemaining=function(pak){assert(pak instanceof PacketDebug)
this.pak.appendRemaining(pak.pak)}
function format(v){switch(typeof v){case"object":if(v instanceof Uint8Array)return"u8<"+v.length+">"
return JSON.stringify(v)
default:return v}}PacketDebug.prototype.contents=function(){var pak=this.pak
var cur_offs=pak.getOffset()
var read_len=cur_offs
var ret=["buf:"+pak.buf_offs+"/"+pak.buf_len]
if(pak.bufs){pak.makeReadable()
ret.push("bufs")}else if(pak.buf){if(pak.readable)read_len=pak.buf_len
pak.buf_offs=0}else{ret.push("empty")
read_len=-1}var saved_ref_count=pak.ref_count
pak.ref_count=2
try{if(!saved_ref_count)ret.push("!ref_count=0!")
if(pak.has_flags)ret.push("flags:"+pak.readU8())
while(pak.buf_offs<read_len){var type_idx=pak.readU8()
var type=types[type_idx]
if(!type){ret.push("UnknownType:"+type_idx)
break}var val=pak["read"+type]()
ret.push(type+":"+format(val))}}catch(e){ret.push("Error dumping packet contents: "+e)}pak.ref_count=saved_ref_count
pak.buf_offs=cur_offs
return ret.join(",")}
function packetCreate(flags,init_size){if(void 0===flags)flags=default_flags
var pool=flags&PACKET_DEBUG?pak_debug_pool:pak_pool
if(pool.length){var pak=pool.pop()
pak.reinit(flags,init_size)
return pak}if(flags&PACKET_DEBUG)return new PacketDebug(flags,init_size)
return new Packet(flags,init_size)}exports.packetCreate=packetCreate
function packetFromBuffer(buf,buf_len,need_copy){var flags=buf[0]
assert.equal(typeof flags,"number")
if(need_copy){assert(buf_len)
assert(buf.buffer instanceof ArrayBuffer)
var pak=packetCreate(flags,buf_len)
if(buf.byteLength!==buf_len)buf=Buffer.from(buf.buffer,0,buf_len)
pak.getBuffer().set(buf)
pak.setReadable()
return pak}else{assert(buf instanceof Uint8Array)
var _pak=packetCreate(flags|PACKET_UNOWNED_BUFFER)
_pak.setBuffer(buf,buf_len||buf.byteLength)
return _pak}}exports.packetFromBuffer=packetFromBuffer
function packetFromJSON(js_obj){var pak=packetCreate(js_obj.f)
var payload=pak.pak||pak
function decode(str){return base64Decode(str,allocDataView)}if(js_obj.b){payload.bsizes=[]
payload.bufs=[]
for(var ii=0;ii<js_obj.b.length;++ii){var buf=decode(js_obj.b[ii])
payload.bufs.push(buf)
payload.bsizes.push(buf.decode_size)
delete buf.decode_size}}if(js_obj.d){payload.buf=decode(js_obj.d)
payload.buf_len=payload.buf.decode_size
delete payload.buf.decode_size
payload.buf_offs=0}return pak}exports.packetFromJSON=packetFromJSON
function isPacket(thing){return thing instanceof Packet||thing instanceof PacketDebug}exports.isPacket=isPacket

}).call(this)}).call(this,require("buffer").Buffer)

},{"./base64.js":63,"./util.js":74,"assert":undefined,"buffer":undefined}],72:[function(require,module,exports){
"use strict"
exports.perfCounterAdd=perfCounterAdd
exports.perfCounterAddValue=perfCounterAddValue
exports.perfCounterHistory=perfCounterHistory
exports.perfCounterTick=perfCounterTick
var BUCKET_TIME=1e4
var NUM_BUCKETS=5
var counters={time_start:Date.now()}
var hist=[counters]
var countdown=BUCKET_TIME
function perfCounterAdd(key){counters[key]=(counters[key]||0)+1}function perfCounterAddValue(key,value){counters[key]=(counters[key]||0)+value}function perfCounterTick(dt,log){if((countdown-=dt)<=0){countdown=BUCKET_TIME
if(hist.length===NUM_BUCKETS)hist.splice(0,1)
var now=Date.now()
counters.time_end=now
if(log)log(counters);(counters={}).time_start=now
hist.push(counters)}}function perfCounterHistory(){return hist}

},{}],73:[function(require,module,exports){
"use strict"
var assert=require("assert")
function EventEmitter(){this._listeners={}}module.exports=EventEmitter
Object.defineProperty(module.exports,"EventEmitter",{value:EventEmitter,enumerable:false})
function addListener(ee,type,fn,once){assert("function"===typeof fn)
var arr=ee._listeners[type]
if(!arr)arr=ee._listeners[type]=[]
arr.push({once:once,fn:fn})}EventEmitter.prototype.hasListener=function(type,fn){var arr=this._listeners[type]
if(!arr)return false
for(var ii=0;ii<arr.length;++ii)if(arr[ii].fn===fn)return true
return false}
EventEmitter.prototype.on=function(type,fn){addListener(this,type,fn,0)
return this}
EventEmitter.prototype.once=function(type,fn){addListener(this,type,fn,1)
return this}
EventEmitter.prototype.removeListener=function(type,fn){var arr=this._listeners[type]
assert(arr)
for(var ii=0;ii<arr.length;++ii)if(arr[ii].fn===fn){arr.splice(ii,1)
return this}assert(false)
return this}
function filterNotOnce(elem){return!elem.once}EventEmitter.prototype.emit=function(type){var arr=this._listeners[type]
if(!arr)return false
var any=false
var any_once=false
for(var _len=arguments.length,args=new Array(_len>1?_len-1:0),_key=1;_key<_len;_key++)args[_key-1]=arguments[_key]
for(var ii=0;ii<arr.length;++ii){var elem=arr[ii]
any=true
elem.fn.apply(elem,args)
if(elem.once)any_once=true}if(any_once)this._listeners[type]=arr.filter(filterNotOnce)
return any}

},{"assert":undefined}],74:[function(require,module,exports){
"use strict"
exports.arrayToSet=arrayToSet
exports.callEach=callEach
exports.clamp=clamp
exports.cleanStringSplit=cleanStringSplit
exports.cleanupStringArray=cleanupStringArray
exports.clone=clone
exports.cloneShallow=cloneShallow
exports.dateToSafeLocaleString=dateToSafeLocaleString
exports.deepAdd=deepAdd
exports.deepEqual=deepEqual
exports.defaults=defaults
exports.defaultsDeep=defaultsDeep
exports.deprecate=deprecate
exports.easeIn=easeIn
exports.easeInOut=easeInOut
exports.easeOut=easeOut
exports.eatPossiblePromise=eatPossiblePromise
exports.empty=empty
exports.errorString=errorString
exports.fract=fract
exports.has=has
exports.identity=identity
exports.inherits=inherits
exports.isInteger=isInteger
exports.isPowerOfTwo=isPowerOfTwo
exports.lerp=lerp
exports.lineCircleIntersect=lineCircleIntersect
exports.lineLineIntersect=lineLineIntersect
exports.log2=log2
exports.logdata=logdata
exports.map01=map01
exports.matchAll=matchAll
exports.merge=merge
exports.mix=mix
exports.mod=mod
exports.msToTimeString=msToTimeString
exports.nearSame=nearSame
exports.nextHighestPowerOfTwo=nextHighestPowerOfTwo
exports.nop=nop
exports.objectToSet=objectToSet
exports.once=once
exports.plural=plural
exports.randomNot=randomNot
exports.ridx=ridx
exports.round100=round100
exports.round1000=round1000
exports.sanitize=sanitize
exports.secondsSince2020=secondsSince2020
exports.secondsToFriendlyString=secondsToFriendlyString
exports.sign=sign
exports.titleCase=titleCase
exports.toArray=toArray
exports.toNumber=toNumber
var assert=require("assert")
var abs=Math.abs,floor=Math.floor,min=Math.min,max=Math.max,random=Math.random,round=Math.round,pow=Math.pow,sqrt=Math.sqrt
function nop(){}function identity(a){return a}function once(fn){var called=false
return function(){if(called)return
called=true
fn.apply(void 0,arguments)}}function empty(obj){for(var key in obj)return false
return true}function easeInOut(v,a){var va=pow(v,a)
return va/(va+pow(1-v,a))}function easeIn(v,a){return 2*easeInOut(.5*v,a)}function easeOut(v,a){return 2*easeInOut(.5+.5*v,a)-1}function clone(obj){if(!obj)return obj
return JSON.parse(JSON.stringify(obj))}function merge(dest,src){for(var f in src)dest[f]=src[f]
return dest}function has(obj,field){return Object.prototype.hasOwnProperty.call(obj,field)}function defaults(dest,src){for(var f in src)if(!has(dest,f))dest[f]=src[f]
return dest}function defaultsDeep(dest,src){for(var f in src)if(!has(dest,f))dest[f]=src[f]
else if("object"===typeof dest[f])defaultsDeep(dest[f],src[f])
return dest}function cloneShallow(src){return merge({},src)}function deepEqual(a,b){if(Array.isArray(a)){if(!Array.isArray(b))return false
if(a.length!==b.length)return false
for(var ii=0;ii<a.length;++ii)if(!deepEqual(a[ii],b[ii]))return false
return true}else if("object"===typeof a){if("object"!==typeof b)return false
if(!a||!b)return!a&&!b
for(var key in a)if(!deepEqual(a[key],b[key]))return false
for(var _key in b)if(void 0!==b[_key]&&void 0===a[_key])return false
return true}return a===b}function deepAdd(dest,src){assert(dest&&src)
for(var key in src){var value=src[key]
if("object"===typeof value){var dest_sub=dest[key]=dest[key]||{}
assert.equal(typeof dest_sub,"object")
deepAdd(dest_sub,value)}else dest[key]=(dest[key]||0)+value}}function clamp(v,mn,mx){return min(max(mn,v),mx)}function lerp(a,v0,v1){return(1-a)*v0+a*v1}function mix(v0,v1,a){return(1-a)*v0+a*v1}function map01(number,in_min,in_max){return(number-in_min)/(in_max-in_min)}function sign(a){return a<0?-1:a>0?1:0}function mod(a,n){return(a%n+n)%n}function log2(val){for(var ii=1,jj=0;;ii<<=1,++jj)if(ii>=val)return jj}function ridx(arr,idx){arr[idx]=arr[arr.length-1]
arr.pop()}function round100(a){return round(100*a)/100}function round1000(a){return round(1e3*a)/1e3}function fract(a){return a-floor(a)}function nearSame(a,b,tol){return abs(b-a)<=tol}function titleCase(str){return str.split(" ").map(function(word){return""+word[0].toUpperCase()+word.slice(1)}).join(" ")}var EPSILON=1e-5
function lineCircleIntersect(p1,p2,pCircle,radius){var dp=[p2[0]-p1[0],p2[1]-p1[1]]
var a=dp[0]*dp[0]+dp[1]*dp[1]
var b=2*(dp[0]*(p1[0]-pCircle[0])+dp[1]*(p1[1]-pCircle[1]))
var c=pCircle[0]*pCircle[0]+pCircle[1]*pCircle[1]
c+=p1[0]*p1[0]+p1[1]*p1[1]
c-=2*(pCircle[0]*p1[0]+pCircle[1]*p1[1])
var bb4ac=b*b-4*a*(c-=radius*radius)
if(abs(a)<EPSILON||bb4ac<0)return false
var mu1=(-b+sqrt(bb4ac))/(2*a)
var mu2=(-b-sqrt(bb4ac))/(2*a)
if(mu1>=0&&mu1<=1||mu2>=0&&mu2<=1)return true
return false}function lineLineIntersect(p1,p2,p3,p4){var denominator=(p4[1]-p3[1])*(p2[0]-p1[0])-(p4[0]-p3[0])*(p2[1]-p1[1])
var numa=(p4[0]-p3[0])*(p1[1]-p3[1])-(p4[1]-p3[1])*(p1[0]-p3[0])
var numb=(p2[0]-p1[0])*(p1[1]-p3[1])-(p2[1]-p1[1])*(p1[0]-p3[0])
if(0===denominator){if(!numa&&!numb)return true
return false}var ua=numa/denominator
var ub=numb/denominator
if(ua<0||ua>1||ub<0||ub>1)return false
return true}function inherits(ctor,superCtor){assert("function"===typeof superCtor)
var ctor_proto_orig=ctor.prototype
ctor.prototype=Object.create(superCtor.prototype,{constructor:{value:ctor,enumerable:false,writable:true,configurable:true}})
for(var key in ctor_proto_orig)ctor.prototype[key]=ctor_proto_orig[key]
for(var _key2 in superCtor)ctor[_key2]=superCtor[_key2]}function isPowerOfTwo(n){return 0===(n&n-1)}function nextHighestPowerOfTwo(x){--x
for(var i=1;i<32;i<<=1)x|=x>>i
return x+1}function logdata(data){if(void 0===data)return""
var r=JSON.stringify(data)
if(r.length<120)return r
return r.slice(0,117)+"...("+r.length+")"}function isInteger(v){return"number"===typeof v&&isFinite(v)&&floor(v)===v}function toNumber(v){return Number(v)}function randomNot(not_value,max_value){var new_value
do{new_value=floor(random()*max_value)}while(new_value===not_value)
return new_value}function toArray(array_like){return Array.prototype.slice.call(array_like)}function arrayToSet(array){var ret=Object.create(null)
for(var ii=0;ii<array.length;++ii)ret[array[ii]]=true
return ret}function objectToSet(obj){return merge(Object.create(null),obj)}function matchAll(str,re){var ret=[]
var m
do{if(m=re.exec(str))ret.push(m[1])}while(m)
return ret}function callEach(arr,pre_clear){if(arr&&arr.length){for(var _len=arguments.length,args=new Array(_len>2?_len-2:0),_key3=2;_key3<_len;_key3++)args[_key3-2]=arguments[_key3]
for(var ii=0;ii<arr.length;++ii)arr[ii].apply(arr,args)}}var sanitize_regex=/[\uD800-\uDFFF\x00-\x1F\x7F\u1D54\u1D55\u2000-\u200F\u205F-\u206F\uFE00]/g
function sanitize(str){return(str||"").replace(sanitize_regex,"")}function plural(number,label){return label+(1===number?"":"s")}function secondsToFriendlyString(seconds,force_include_seconds){var days=floor(seconds/86400)
var hours=floor((seconds-=60*days*60*24)/3600)
var minutes=floor((seconds-=60*hours*60)/60)
seconds-=60*minutes
var resp=[]
if(days){var years=floor(days/365.25)
if(years){days-=floor(365.25*years)
resp.push(years+" "+plural(years,"year"))}resp.push(days+" "+plural(days,"day"))}if(hours)resp.push(hours+" "+plural(hours,"hour"))
if(minutes||!resp.length)resp.push(minutes+" "+plural(minutes,"minute"))
if(force_include_seconds)resp.push(seconds+" "+plural(seconds,"second"))
return resp.join(", ")}function secondsSince2020(){return floor(Date.now()/1e3)-1577836800}function dateToSafeLocaleString(date,date_only){var date_text
try{date_text=date_only?date.toLocaleDateString():date.toLocaleString()}catch(e){console.error(e,"(Using toString as fallback)")
date_text=date_only?date.toDateString():date.toString()}return date_text}function msToTimeString(duration,opts){var ms=duration%1e3
var s
var m
var h
h=(m=(s=duration-ms)-(s%=6e4))-(m%=36e5)
m/=6e4
return((h/=36e5)?h+":":"")+(h&&m<10?"0":"")+m+":"+((s/=1e3)<10?"0":"")+s+((opts=opts||{}).hide_ms?"":"."+(ms<10?"00":ms<100?"0":"")+ms)}var sw={}
sw.am=sw.an=sw.and=sw.as=sw.at=sw.be=sw.by=sw.el=sw.for=sw.in=sw.is=sw.la=sw.las=sw.los=sw.of=sw.on=sw.or=sw.the=sw.that=sw.this=sw.to=sw.with=true
function cleanupStringArray(string_array){return string_array.filter(function(s){return s.length>1&&s.length<=32&&!sw[s]})}function cleanStringSplit(string,pattern){return cleanupStringArray(sanitize(string).replace(/[.,/\\@#Â£!$%^&*;:<>{}|?=\-+_`'"~[\]()]/g,"").replace(/\s{1,}/g," ").toLowerCase().split(pattern).map(function(s){return s.trim()}))}function eatPossiblePromise(p){if(p&&p.catch)p.catch(nop)}function errorString(e){var msg=String(e)
if("[object Object]"===msg)try{msg=JSON.stringify(e)}catch(ignored){}if(e&&e.stack&&e.message)msg=String(e.message)
return msg=msg.slice(0,600)}function deprecate(exports,field,replacement){Object.defineProperty(exports,field,{get:function get(){assert(false,field+" is deprecated, use "+replacement+" instead")
return}})}

},{"assert":undefined}],75:[function(require,module,exports){
"use strict"
var should_throw=true
function verify(exp,msg){if(!exp&&should_throw)throw new Error("Assertion failed"+(msg?": "+msg:""))
return exp}(function(_verify){_verify.ok=verify
function equal(a,b){if(a===b)return true
if(should_throw)throw new Error('Assertion failed: "'+a+'"==="'+b+'"')
return false}_verify.equal=equal
function dothrow(doit){should_throw=doit}_verify.dothrow=dothrow})(verify=verify||{})
module.exports=verify

},{}],76:[function(require,module,exports){
"use strict"
exports.identity_mat4=exports.identity_mat3=exports.half_vec=void 0
exports.ivec2=ivec2
exports.ivec3=ivec3
exports.m4TransformVec3=m4TransformVec3
exports.unit_vec=exports.rovec4=exports.rovec3=exports.rovec2=exports.rovec1=exports.roivec3=exports.roivec2=exports.mat4=exports.mat3=void 0
exports.v2abs=v2abs
exports.v2add=v2add
exports.v2addScale=v2addScale
exports.v2angle=v2angle
exports.v2copy=v2copy
exports.v2dist=v2dist
exports.v2distSq=v2distSq
exports.v2div=v2div
exports.v2dot=v2dot
exports.v2floor=v2floor
exports.v2iFloor=v2iFloor
exports.v2iNormalize=v2iNormalize
exports.v2iRound=v2iRound
exports.v2length=v2length
exports.v2lengthSq=v2lengthSq
exports.v2lerp=v2lerp
exports.v2mul=v2mul
exports.v2normalize=v2normalize
exports.v2round=v2round
exports.v2same=v2same
exports.v2scale=v2scale
exports.v2set=v2set
exports.v2sub=v2sub
exports.v3add=v3add
exports.v3addScale=v3addScale
exports.v3angle=v3angle
exports.v3copy=v3copy
exports.v3cross=v3cross
exports.v3determinant=v3determinant
exports.v3dist=v3dist
exports.v3distSq=v3distSq
exports.v3div=v3div
exports.v3dot=v3dot
exports.v3floor=v3floor
exports.v3iAdd=v3iAdd
exports.v3iFloor=v3iFloor
exports.v3iMax=v3iMax
exports.v3iMin=v3iMin
exports.v3iMul=v3iMul
exports.v3iNormalize=v3iNormalize
exports.v3iRound=v3iRound
exports.v3iScale=v3iScale
exports.v3iSub=v3iSub
exports.v3length=v3length
exports.v3lengthSq=v3lengthSq
exports.v3lerp=v3lerp
exports.v3mul=v3mul
exports.v3mulMat4=v3mulMat4
exports.v3normalize=v3normalize
exports.v3perspectiveProject=v3perspectiveProject
exports.v3pow=v3pow
exports.v3round=v3round
exports.v3same=v3same
exports.v3scale=v3scale
exports.v3scaleFloor=v3scaleFloor
exports.v3set=v3set
exports.v3sub=v3sub
exports.v3zero=v3zero
exports.v4add=v4add
exports.v4clone=v4clone
exports.v4copy=v4copy
exports.v4dot=v4dot
exports.v4fromRGBA=v4fromRGBA
exports.v4lerp=v4lerp
exports.v4mul=v4mul
exports.v4mulAdd=v4mulAdd
exports.v4same=v4same
exports.v4scale=v4scale
exports.v4set=v4set
exports.v4zero=v4zero
exports.vec1=vec1
exports.vec2=vec2
exports.vec3=vec3
exports.vec4=vec4
exports.zero_vec=exports.zaxis=exports.yaxis=exports.xaxis=void 0
var mat3Create=require("gl-mat3/create")
var mat4Create=require("gl-mat4/create")
var abs=Math.abs,acos=Math.acos,max=Math.max,min=Math.min,floor=Math.floor,pow=Math.pow,round=Math.round,sqrt=Math.sqrt
var mat3=mat3Create
exports.mat3=mat3
var mat4=mat4Create
exports.mat4=mat4
function vec1(v){return new Float32Array([v||0])}var rovec1=vec1
exports.rovec1=rovec1
function vec2(a,b){var r=new Float32Array(2)
if(a||b){r[0]=a
r[1]=b}return r}var rovec2=vec2
exports.rovec2=rovec2
function ivec2(a,b){var r=new Int32Array(2)
if(a||b){r[0]=a
r[1]=b}return r}var roivec2=ivec2
exports.roivec2=roivec2
function vec3(a,b,c){var r=new Float32Array(3)
if(a||b||c){r[0]=a
r[1]=b
r[2]=c}return r}var rovec3=vec3
exports.rovec3=rovec3
function ivec3(a,b,c){var r=new Int32Array(3)
if(a||b||c){r[0]=a
r[1]=b
r[2]=c}return r}var roivec3=ivec3
exports.roivec3=roivec3
function vec4(a,b,c,d){var r=new Float32Array(4)
if(a||b||c||d){r[0]=a
r[1]=b
r[2]=c
r[3]=d}return r}var rovec4=vec4
exports.rovec4=rovec4
function frozenVec4(a,b,c,d){return rovec4(a,b,c,d)}var unit_vec=frozenVec4(1,1,1,1)
exports.unit_vec=unit_vec
var half_vec=frozenVec4(.5,.5,.5,.5)
exports.half_vec=half_vec
var zero_vec=frozenVec4(0,0,0,0)
exports.zero_vec=zero_vec
var identity_mat3=mat3()
exports.identity_mat3=identity_mat3
var identity_mat4=mat4()
exports.identity_mat4=identity_mat4
var xaxis=frozenVec4(1,0,0,0)
exports.xaxis=xaxis
var yaxis=frozenVec4(0,1,0,0)
exports.yaxis=yaxis
var zaxis=frozenVec4(0,0,1,0)
exports.zaxis=zaxis
function v2abs(out,a){out[0]=abs(a[0])
out[1]=abs(a[1])
return out}function v2add(out,a,b){out[0]=a[0]+b[0]
out[1]=a[1]+b[1]
return out}function v2addScale(out,a,b,s){out[0]=a[0]+b[0]*s
out[1]=a[1]+b[1]*s
return out}function v2angle(a,b){var mag=sqrt((a[0]*a[0]+a[1]*a[1])*(b[0]*b[0]+b[1]*b[1]))
return acos(min(max(mag&&(a[0]*b[0]+a[1]*b[1])/mag,-1),1))}function v2copy(out,a){out[0]=a[0]
out[1]=a[1]
return out}function v2dist(a,b){return sqrt((a[0]-b[0])*(a[0]-b[0])+(a[1]-b[1])*(a[1]-b[1]))}function v2distSq(a,b){return(a[0]-b[0])*(a[0]-b[0])+(a[1]-b[1])*(a[1]-b[1])}function v2div(out,a,b){out[0]=a[0]/b[0]
out[1]=a[1]/b[1]
return out}function v2dot(a,b){return a[0]*b[0]+a[1]*b[1]}function v2floor(out,a){out[0]=floor(a[0])
out[1]=floor(a[1])
return out}function v2iFloor(inout){inout[0]=floor(inout[0])
inout[1]=floor(inout[1])
return inout}function v2lengthSq(a){return a[0]*a[0]+a[1]*a[1]}function v2length(a){return sqrt(v2lengthSq(a))}function v2lerp(out,t,a,b){var it=1-t
out[0]=it*a[0]+t*b[0]
out[1]=it*a[1]+t*b[1]
return out}function v2mul(out,a,b){out[0]=a[0]*b[0]
out[1]=a[1]*b[1]
return out}function v2normalize(out,a){var len=a[0]*a[0]+a[1]*a[1]
if(len>0){len=1/sqrt(len)
out[0]=a[0]*len
out[1]=a[1]*len}return out}function v2iNormalize(inout){var len=inout[0]*inout[0]+inout[1]*inout[1]
if(len>0){len=1/sqrt(len)
inout[0]*=len
inout[1]*=len}return inout}function v2round(out,a){out[0]=round(a[0])
out[1]=round(a[1])
return out}function v2iRound(inout){inout[0]=round(inout[0])
inout[1]=round(inout[1])
return inout}function v2same(a,b){return a[0]===b[0]&&a[1]===b[1]}function v2scale(out,a,s){out[0]=a[0]*s
out[1]=a[1]*s
return out}function v2set(out,a,b){out[0]=a
out[1]=b
return out}function v2sub(out,a,b){out[0]=a[0]-b[0]
out[1]=a[1]-b[1]
return out}function v3add(out,a,b){out[0]=a[0]+b[0]
out[1]=a[1]+b[1]
out[2]=a[2]+b[2]
return out}function v3iAdd(inout,b){inout[0]+=b[0]
inout[1]+=b[1]
inout[2]+=b[2]
return inout}function v3addScale(out,a,b,s){out[0]=a[0]+b[0]*s
out[1]=a[1]+b[1]*s
out[2]=a[2]+b[2]*s
return out}function v3angle(a,b){var mag=sqrt((a[0]*a[0]+a[1]*a[1]+a[2]*a[2])*(b[0]*b[0]+b[1]*b[1]+b[2]*b[2]))
return acos(min(max(mag&&(a[0]*b[0]+a[1]*b[1]+a[2]*b[2])/mag,-1),1))}function v3copy(out,a){out[0]=a[0]
out[1]=a[1]
out[2]=a[2]
return out}function v3cross(out,a,b){var a0=a[0]
var a1=a[1]
var a2=a[2]
var b0=b[0]
var b1=b[1]
var b2=b[2]
out[0]=a1*b2-a2*b1
out[1]=a2*b0-a0*b2
out[2]=a0*b1-a1*b0
return out}function v3determinant(a,b,c){var a00=a[0]
var a01=b[0]
var a02=c[0]
var a10=a[1]
var a11=b[1]
var a12=c[1]
var a20=a[2]
var a21=b[2]
var a22=c[2]
return a00*(a22*a11-a12*a21)+a01*(-a22*a10+a12*a20)+a02*(a21*a10-a11*a20)}function v3distSq(a,b){return(a[0]-b[0])*(a[0]-b[0])+(a[1]-b[1])*(a[1]-b[1])+(a[2]-b[2])*(a[2]-b[2])}function v3dist(a,b){return sqrt(v3distSq(a,b))}function v3div(out,a,b){out[0]=a[0]/b[0]
out[1]=a[1]/b[1]
out[2]=a[2]/b[2]
return out}function v3dot(a,b){return a[0]*b[0]+a[1]*b[1]+a[2]*b[2]}function v3iFloor(inout){inout[0]=floor(inout[0])
inout[1]=floor(inout[1])
inout[2]=floor(inout[2])
return inout}function v3floor(out,a){out[0]=floor(a[0])
out[1]=floor(a[1])
out[2]=floor(a[2])
return out}function v3lengthSq(a){return a[0]*a[0]+a[1]*a[1]+a[2]*a[2]}function v3length(a){return sqrt(v3lengthSq(a))}function v3lerp(out,t,a,b){var it=1-t
out[0]=it*a[0]+t*b[0]
out[1]=it*a[1]+t*b[1]
out[2]=it*a[2]+t*b[2]
return out}function v3iMax(inout,b){inout[0]=max(inout[0],b[0])
inout[1]=max(inout[1],b[1])
inout[2]=max(inout[2],b[2])
return inout}function v3iMin(inout,b){inout[0]=min(inout[0],b[0])
inout[1]=min(inout[1],b[1])
inout[2]=min(inout[2],b[2])
return inout}function v3mul(out,a,b){out[0]=a[0]*b[0]
out[1]=a[1]*b[1]
out[2]=a[2]*b[2]
return out}function v3iMul(inout,b){inout[0]*=b[0]
inout[1]*=b[1]
inout[2]*=b[2]
return inout}function v3mulMat4(out,a,m){var x=a[0]
var y=a[1]
var z=a[2]
out[0]=x*m[0]+y*m[4]+z*m[8]
out[1]=x*m[1]+y*m[5]+z*m[9]
out[2]=x*m[2]+y*m[6]+z*m[10]
return out}function m4TransformVec3(out,a,m){var x=a[0]
var y=a[1]
var z=a[2]
out[0]=x*m[0]+y*m[4]+z*m[8]+m[12]
out[1]=x*m[1]+y*m[5]+z*m[9]+m[13]
out[2]=x*m[2]+y*m[6]+z*m[10]+m[14]
return out}function v3normalize(out,a){var len=a[0]*a[0]+a[1]*a[1]+a[2]*a[2]
if(len>0){len=1/sqrt(len)
out[0]=a[0]*len
out[1]=a[1]*len
out[2]=a[2]*len}return out}function v3iNormalize(inout){var len=inout[0]*inout[0]+inout[1]*inout[1]+inout[2]*inout[2]
if(len>0){len=1/sqrt(len)
inout[0]*=len
inout[1]*=len
inout[2]*=len}return inout}function v3perspectiveProject(out,a,m){var x=a[0]
var y=a[1]
var z=a[2]
var invw=.5/(m[3]*x+m[7]*y+m[11]*z+m[15]||1e-5)
out[0]=(m[0]*x+m[4]*y+m[8]*z+m[12])*invw+.5
out[1]=(m[1]*x+m[5]*y+m[9]*z+m[13])*-invw+.5
out[2]=m[2]*x+m[6]*y+m[10]*z+m[14]
return out}function v3pow(out,a,exp){out[0]=pow(a[0],exp)
out[1]=pow(a[1],exp)
out[2]=pow(a[2],exp)
return out}function v3round(out,a){out[0]=round(a[0])
out[1]=round(a[1])
out[2]=round(a[2])
return out}function v3iRound(inout){inout[0]=round(inout[0])
inout[1]=round(inout[1])
inout[2]=round(inout[2])
return inout}function v3same(a,b){return a[0]===b[0]&&a[1]===b[1]&&a[2]===b[2]}function v3scale(out,a,s){out[0]=a[0]*s
out[1]=a[1]*s
out[2]=a[2]*s
return out}function v3scaleFloor(out,a,s){out[0]=floor(a[0]*s)
out[1]=floor(a[1]*s)
out[2]=floor(a[2]*s)
return out}function v3iScale(inout,s){inout[0]*=s
inout[1]*=s
inout[2]*=s
return inout}function v3set(out,a,b,c){out[0]=a
out[1]=b
out[2]=c
return out}function v3sub(out,a,b){out[0]=a[0]-b[0]
out[1]=a[1]-b[1]
out[2]=a[2]-b[2]
return out}function v3iSub(inout,b){inout[0]-=b[0]
inout[1]-=b[1]
inout[2]-=b[2]
return inout}function v3zero(out){out[0]=out[1]=out[2]=0
return out}function v4add(out,a,b){out[0]=a[0]+b[0]
out[1]=a[1]+b[1]
out[2]=a[2]+b[2]
out[3]=a[3]+b[3]
return out}function v4clone(a){return a.slice(0)}function v4copy(out,a){out[0]=a[0]
out[1]=a[1]
out[2]=a[2]
out[3]=a[3]
return out}function v4dot(a,b){return a[0]*b[0]+a[1]*b[1]+a[2]*b[2]+a[3]*b[3]}function v4fromRGBA(rgba){return vec4((rgba>>>24)/255,((16711680&rgba)>>16)/255,((65280&rgba)>>8)/255,(255&rgba)/255)}function v4lerp(out,t,a,b){var it=1-t
out[0]=it*a[0]+t*b[0]
out[1]=it*a[1]+t*b[1]
out[2]=it*a[2]+t*b[2]
out[3]=it*a[3]+t*b[3]
return out}function v4mul(out,a,b){out[0]=a[0]*b[0]
out[1]=a[1]*b[1]
out[2]=a[2]*b[2]
out[3]=a[3]*b[3]
return out}function v4mulAdd(out,a,b,c){out[0]=a[0]*b[0]+c[0]
out[1]=a[1]*b[1]+c[1]
out[2]=a[2]*b[2]+c[2]
out[3]=a[3]*b[3]+c[3]
return out}function v4same(a,b){return a[0]===b[0]&&a[1]===b[1]&&a[2]===b[2]&&a[3]===b[3]}function v4scale(out,a,s){out[0]=a[0]*s
out[1]=a[1]*s
out[2]=a[2]*s
out[3]=a[3]*s
return out}function v4set(out,a,b,c,d){out[0]=a
out[1]=b
out[2]=c
out[3]=d
return out}function v4zero(out){out[0]=out[1]=out[2]=out[3]=0
return out}

},{"gl-mat3/create":undefined,"gl-mat4/create":undefined}],77:[function(require,module,exports){
"use strict"
exports.PING_TIME=exports.CONNECTION_TIMEOUT=void 0
exports.netDelayGet=netDelayGet
exports.netDelaySet=netDelaySet
exports.sendMessage=sendMessage
exports.wsHandleMessage=wsHandleMessage
exports.wsPak=wsPak
exports.wsPakSendDest=wsPakSendDest
exports.wsstats_out=exports.wsstats=void 0
var wsstats={msgs:0,bytes:0}
exports.wsstats=wsstats
var wsstats_out={msgs:0,bytes:0}
exports.wsstats_out=wsstats_out
var ack=require("./ack.js")
var assert=require("assert")
var ackHandleMessage=ack.ackHandleMessage,ackReadHeader=ack.ackReadHeader,ackWrapPakStart=ack.ackWrapPakStart,ackWrapPakPayload=ack.ackWrapPakPayload,ackWrapPakFinish=ack.ackWrapPakFinish
var random=Math.random,round=Math.round
var _require=require("./packet.js"),isPacket=_require.isPacket,packetCreate=_require.packetCreate,packetDefaultFlags=_require.packetDefaultFlags,packetFromBuffer=_require.packetFromBuffer
var _require2=require("./perfcounters.js"),perfCounterAddValue=_require2.perfCounterAddValue
var CONNECTION_TIMEOUT=6e4
var PING_TIME=(exports.CONNECTION_TIMEOUT=CONNECTION_TIMEOUT)/2
exports.PING_TIME=PING_TIME
var PAK_HEADER_SIZE=28
var net_delay=0
var net_delay_rand=0
function socketSendInternal(client,buf,pak){if(client.ws_server)client.socket.send(buf,pak.pool.bind(pak))
else{client.socket.send(buf)
pak.pool()}}function netDelaySet(delay,rand){if(void 0===delay){delay=100
rand=50}if(delay)console.log("NetDelay: ON ("+delay+"+"+rand+")")
else console.log("NetDelay: Off")
net_delay=delay
net_delay_rand=rand}function netDelayGet(){return[net_delay,net_delay_rand]}function NetDelayer(client,socket){this.client=client
this.head=null
this.tail=null
this.tick=this.tickFn.bind(this)}NetDelayer.prototype.send=function(buf,pak){var now=Date.now()
var delay=round(net_delay+net_delay_rand*random())
var elem={buf:buf,pak:pak,time:now+delay,next:null}
if(this.tail){this.tail.next=elem
this.tail=elem}else{this.head=this.tail=elem
setTimeout(this.tick,delay)}}
NetDelayer.prototype.tickFn=function(){var client=this.client
if(client.net_delayer!==this){while(this.head){var elem=this.head
elem.pak.pool()
this.head=elem.next}this.tail=null
return}var now=Date.now()
do{var _elem=this.head
this.head=_elem.next
if(!this.head)this.tail=null
socketSendInternal(client,_elem.buf,_elem.pak)}while(this.head&&this.head.time<=now)
if(this.head)setTimeout(this.tick,this.head.time-now)}
function wsPakSendDest(client,pak){if(!client.connected||1!==client.socket.readyState){console.warn("Attempting to send on a disconnected link (client_id:"+client.id+"), ignoring")
pak.pool()
return}var buf=pak.getBuffer()
var buf_len=pak.getBufferLen()
if(buf_len!==buf.length)buf=new Uint8Array(buf.buffer,buf.byteOffset,buf_len)
perfCounterAddValue("net.send_bytes.total",buf.length)
wsstats_out.msgs++
wsstats_out.bytes+=buf.length
if(net_delay){if(!client.net_delayer)client.net_delayer=new NetDelayer(client)
client.net_delayer.send(buf,pak)}else socketSendInternal(client,buf,pak)
client.last_send_time=Date.now()}function wsPakSendFinish(pak,err,resp_func){var _pak$ws_data=pak.ws_data,client=_pak$ws_data.client,msg=_pak$ws_data.msg
delete pak.ws_data
var ack_resp_pkt_id=ackWrapPakFinish(pak,err,resp_func)
if(!client.connected||1!==client.socket.readyState){if("channel_msg"===msg){pak.seek(0)
pak.readFlags()
var header=ackReadHeader(pak)
var channel_id
var submsg
if(isPacket(header.data)){pak.ref()
channel_id=pak.readAnsiString()
submsg=pak.readAnsiString()
if(!pak.ended())pak.pool()}else{channel_id=header.data.channel_id
submsg=header.data.msg}msg="channel_msg:"+channel_id+":"+submsg}if("number"!==typeof msg){(client.log?client:console).log("Attempting to send msg="+msg+" on a disconnected link, ignoring")
if(!client.log&&client.onError&&msg)client.onError("Attempting to send msg="+msg+" on a disconnected link")}if(ack_resp_pkt_id)delete client.resp_cbs[ack_resp_pkt_id]
pak.pool()
return}assert.equal(Boolean(resp_func&&false!==resp_func.expecting_response),Boolean(ack_resp_pkt_id))
wsPakSendDest(client,pak)}function wsPakSend(err,resp_func){if("function"===typeof err&&!resp_func){resp_func=err
err=null}wsPakSendFinish(this,err,resp_func)}function wsPak(msg,ref_pak,client){assert("string"===typeof msg||"number"===typeof msg)
var pak=packetCreate(ref_pak?ref_pak.getInternalFlags():packetDefaultFlags(),ref_pak?ref_pak.totalSize()+PAK_HEADER_SIZE:0)
pak.writeFlags()
ackWrapPakStart(pak,client,msg)
pak.ws_data={msg:msg,client:client}
pak.send=wsPakSend
return pak}function sendMessageInternal(client,msg,err,data,resp_func){var pak=wsPak(msg,isPacket(data)?data:null,client)
if(!err)ackWrapPakPayload(pak,data)
pak.send(err,resp_func)}function sendMessage(msg,data,resp_func){sendMessageInternal(this,msg,null,data,resp_func)}function wsHandleMessage(client,buf,filter){++wsstats.msgs
var now=Date.now()
var source=client.id?"client "+client.id:"server"
if(!(buf instanceof Uint8Array)){(client.log?client:console).log("Received incorrect WebSocket data type from "+source+" ("+typeof buf+")")
if("string"===typeof buf)(client.log?client:console).log("Invalid WebSocket data: "+JSON.stringify(buf.slice(0,120)))
if(client.ws_server){if(!client.has_warned_about_text){client.has_warned_about_text=true
client.send("error","Server received non-binary WebSocket data.  Likely cause is a proxy, VPN or something else intercepting and modifying network traffic.")}return}return void client.onError("Invalid data received")}wsstats.bytes+=buf.length
var pak=packetFromBuffer(buf,buf.length,false)
pak.readFlags()
client.last_receive_time=now
client.idle_counter=0
return void ackHandleMessage(client,source,pak,function sendFunc(msg,err,data,resp_func){if(resp_func&&!resp_func.expecting_response)resp_func=null
sendMessageInternal(client,msg,err,data,resp_func)},function pakFunc(msg,ref_pak){return wsPak(msg,ref_pak,client)},function handleFunc(msg,data,resp_func){var handler=client.handlers[msg]
if(!handler){var error_msg="No handler for message "+JSON.stringify(msg)+" from "+source
console.error(error_msg,isPacket(data)?data.contents():data)
if(client.onError)return client.onError(error_msg)
return resp_func(error_msg)}return handler(client,data,resp_func)},filter)}

},{"./ack.js":62,"./packet.js":71,"./perfcounters.js":72,"assert":undefined}]},{},[1])


//# sourceMappingURL=app.bundle.js.map
